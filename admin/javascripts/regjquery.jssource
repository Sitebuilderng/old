var swfu;
var swfu_vid;
var filterProductsByCategory="";
var filterSnippetsByCategory="";
var filterSubscribersByCategory="";
var filterSubscribersByCategoryMatchAll="&matchAll=false";
var filterSubscribersByStatus="";
function htmlentities( string ){
    // http://kevin.vanzonneveld.net
    // +   original by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
    // +    revised by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
    // +   improved by: nobbler
    // +    tweaked by: Jack
    // %          note: table from http://www.the-art-of-web.com/html/character-codes/
    // *     example 1: htmlentities('Kevin & van Zonneveld');
    // *     returns 1: 'Kevin &amp; van Zonneveld'

    var histogram = {}, code = 0, tmp_arr = [], i = 0;
    var stringl = 0;

    histogram['34'] = 'quot';
    histogram['38'] = 'amp';
    histogram['60'] = 'lt';
    histogram['62'] = 'gt';
    histogram['160'] = 'nbsp';
    histogram['161'] = 'iexcl';
    histogram['162'] = 'cent';
    histogram['163'] = 'pound';
    histogram['164'] = 'curren';
    histogram['165'] = 'yen';
    histogram['166'] = 'brvbar';
    histogram['167'] = 'sect';
    histogram['168'] = 'uml';
    histogram['169'] = 'copy';
    histogram['170'] = 'ordf';
    histogram['171'] = 'laquo';
    histogram['172'] = 'not';
    histogram['173'] = 'shy';
    histogram['174'] = 'reg';
    histogram['175'] = 'macr';
    histogram['176'] = 'deg';
    histogram['177'] = 'plusmn';
    histogram['178'] = 'sup2';
    histogram['179'] = 'sup3';
    histogram['180'] = 'acute';
    histogram['181'] = 'micro';
    histogram['182'] = 'para';
    histogram['183'] = 'middot';
    histogram['184'] = 'cedil';
    histogram['185'] = 'sup1';
    histogram['186'] = 'ordm';
    histogram['187'] = 'raquo';
    histogram['188'] = 'frac14';
    histogram['189'] = 'frac12';
    histogram['190'] = 'frac34';
    histogram['191'] = 'iquest';
    histogram['192'] = 'Agrave';
    histogram['193'] = 'Aacute';
    histogram['194'] = 'Acirc';
    histogram['195'] = 'Atilde';
    histogram['196'] = 'Auml';
    histogram['197'] = 'Aring';
    histogram['198'] = 'AElig';
    histogram['199'] = 'Ccedil';
    histogram['200'] = 'Egrave';
    histogram['201'] = 'Eacute';
    histogram['202'] = 'Ecirc';
    histogram['203'] = 'Euml';
    histogram['204'] = 'Igrave';
    histogram['205'] = 'Iacute';
    histogram['206'] = 'Icirc';
    histogram['207'] = 'Iuml';
    histogram['208'] = 'ETH';
    histogram['209'] = 'Ntilde';
    histogram['210'] = 'Ograve';
    histogram['211'] = 'Oacute';
    histogram['212'] = 'Ocirc';
    histogram['213'] = 'Otilde';
    histogram['214'] = 'Ouml';
    histogram['215'] = 'times';
    histogram['216'] = 'Oslash';
    histogram['217'] = 'Ugrave';
    histogram['218'] = 'Uacute';
    histogram['219'] = 'Ucirc';
    histogram['220'] = 'Uuml';
    histogram['221'] = 'Yacute';
    histogram['222'] = 'THORN';
    histogram['223'] = 'szlig';
    histogram['224'] = 'agrave';
    histogram['225'] = 'aacute';
    histogram['226'] = 'acirc';
    histogram['227'] = 'atilde';
    histogram['228'] = 'auml';
    histogram['229'] = 'aring';
    histogram['230'] = 'aelig';
    histogram['231'] = 'ccedil';
    histogram['232'] = 'egrave';
    histogram['233'] = 'eacute';
    histogram['234'] = 'ecirc';
    histogram['235'] = 'euml';
    histogram['236'] = 'igrave';
    histogram['237'] = 'iacute';
    histogram['238'] = 'icirc';
    histogram['239'] = 'iuml';
    histogram['240'] = 'eth';
    histogram['241'] = 'ntilde';
    histogram['242'] = 'ograve';
    histogram['243'] = 'oacute';
    histogram['244'] = 'ocirc';
    histogram['245'] = 'otilde';
    histogram['246'] = 'ouml';
    histogram['247'] = 'divide';
    histogram['248'] = 'oslash';
    histogram['249'] = 'ugrave';
    histogram['250'] = 'uacute';
    histogram['251'] = 'ucirc';
    histogram['252'] = 'uuml';
    histogram['253'] = 'yacute';
    histogram['254'] = 'thorn';
    histogram['255'] = 'yuml';

    stringl = string.length
    for (i = 0; i < stringl; ++i) {
        code = string.charCodeAt(i);
        if (code in histogram) {
            tmp_arr[i] = '&'+histogram[code]+';';
        } else {
            tmp_arr[i] = string.charAt(i);
        }
    }

    return tmp_arr.join('');
}
function randomString() {
	var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";
	var string_length = 5;
	var randomstring = '';
	for (var i=0; i<string_length; i++) {
		var rnum = Math.floor(Math.random() * chars.length);
		randomstring += chars.substring(rnum,rnum+1);
	}
	return randomstring;
}

function array_reverse( array, preserve_keys ) {
    // http://kevin.vanzonneveld.net
    // +   original by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
    // +   improved by: Karol Kowalski
    // *     example 1: array_reverse( [ 'php', '4.0', ['green', 'red'] ], true );
    // *     returns 1: { 2: ['green', 'red'], 1: 4, 0: 'php'}

    var arr_len=array.length, newkey=0, tmp_ar = {};

    for(var key in array){
        newkey=arr_len-key-1;
        tmp_ar[(!!preserve_keys)?newkey:key]=array[newkey];
    }

    return tmp_ar;
}
function createCookie(name,value,days) {
	if (days) {
		var date = new Date();
		date.setTime(date.getTime()+(days*24*60*60*1000));
		var expires = "; expires="+date.toGMTString();
	}
	else var expires = "";
	document.cookie = name+"="+value+expires+"; path=/";
}

function readCookie(name) {
	var nameEQ = name + "=";
	var ca = document.cookie.split(';');
	for(var i=0;i < ca.length;i++) {
		var c = ca[i];
		while (c.charAt(0)==' ') c = c.substring(1,c.length);
		if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
	}
	return null;
}


function assignSortableListItems (wrapper,highlight,listItem) {

	if ( $("."+listItem+":not(.notDraggable):first",wrapper).find(".dragListItem").length) {
		var handle = ".dragListItem";
	} else {
		var handle = false;
	}
	$("."+listItem+":not(.notDraggable)",wrapper).draggable({

		helper: function() {
			if ($("."+highlight,wrapper).length>1 && $(this).hasClass(highlight)) {
				$clones = $("<div class='draggingBox'></div>");
				var ofTop = 0;
				var ofLeft = 0;
				$("."+highlight,wrapper).each(function(){
						if (listItem=="thumbItem") {
							$clones.append($(this).clone().css("width",$(this).width()+"px").css("top",ofTop+"px").css("left",ofLeft+"px").css("position","absolute")).append("<div class='dropzone'><div></div></div>");
						ofTop+=20;
						ofLeft+=20;

						} else {
							$clones.append($(this).clone().css("width",$(this).width()+"px")).append("<div class='dropzone'><div></div></div>");

						}
				});
				return $clones.css('width', this.offsetWidth-82).css("height",this.offsetHeight-12).css("margin-left","10px")[0];
			} else {
		 		return $(this).clone().css('width', this.offsetWidth-82).css("height",this.offsetHeight-12).css("margin-left","10px")[0];
			}

		},
		handle: handle,
		appendTo:wrapper,
		start: function(){
			if (typeof myScroll[wrapper.attr("id")] !='undefined') {
				myScroll[wrapper.attr("id")].disable();
			}
			hideToolTips(false);
		},
		stop: function(){
			if (typeof myScroll[wrapper.attr("id")] !='undefined') {
				myScroll[wrapper.attr("id")].enable();
			}
			clearTimeout(lovelyScrollDrag);
		},
		drag: function(){
			//hidePaneTools();

			var topZoneTop = wrapper.offset().top;
			var topZoneBottom = topZoneTop+160;
			var topZoneLeft = wrapper.offset().left;
			var topZoneRight = topZoneLeft + wrapper.width();

			var bottomZoneTop = wrapper.offset().top+wrapper.outerHeight()-50;
			var bottomZoneBottom = wrapper.offset().top+wrapper.outerHeight();
			var bottomZoneLeft = wrapper.offset().left;
			var bottomZoneRight = topZoneLeft + wrapper.width();

			var posTop = event.pageY;
			var posLeft = event.pageX;
			clearTimeout(lovelyScrollDrag);
			if (posTop > topZoneTop && posTop < topZoneBottom && posLeft > topZoneLeft && posLeft < topZoneRight) {
				wrapper.lovelyScrollMove(7);
				lovelyScrollDrag = setInterval(function(){
					wrapper.lovelyScrollMove(7);
				},30);
			}

			if (posTop > bottomZoneTop && posTop < bottomZoneBottom && posLeft > bottomZoneLeft && posLeft < bottomZoneRight) {
				wrapper.lovelyScrollMove(-7);
				lovelyScrollDrag = setInterval(function(){
					wrapper.lovelyScrollMove(-7);
				},30);
			}


		},
		refreshPositions:true,
	    zIndex: 1000,
		opacity:0.7,
		distance: 4,
		addClasses:false
	});
	if (listItem=="responsiveListItem") {
		$("."+listItem+":not(.notDraggable)",wrapper).draggable( "option", "axis", "y" );
	}
	if (listItem=="thumbItem") {
		$("."+listItem+":not(.notDraggable)",wrapper).draggable( "option", "handle", ".bpe_tiny_image" );
	}

	$(".dropzone",wrapper).droppable({

		accept: "."+listItem,
		tolerance:"pointer",
		greedy:true,
		drop: function(e, ui) {
			if ($("#rightPaneImages:visible").length && $("#imageSearch .target").hasClass("searching")) {
				$(this).removeClass("dropping");
				error(LangVars.Cant_Sort_Images_When_Search)
				return false;
			}
			$this = $(this);
			if (ui.draggable.hasClass(highlight) && $("."+highlight).length>1) {
				$target = $this;
				jQuery.fn.reverse = [].reverse;
				$("."+highlight+":not(.draggingBox ."+highlight+")",wrapper).reverse().each(function(){
					$(this).insertAfter($target);
				});

			} else {
				ui.draggable.insertAfter($this);
			}

			setTimeout(function() {
				$this.removeClass("dropping");
				$(".dropzone",wrapper).each(function(){
					if ($(this).parents("."+listItem).length) {} else {
						$(this).remove();
					}
				});

				var dropzone = "dropzone";

				$("."+listItem+":not(.notDraggable)",wrapper).after("<div class='"+dropzone+"'><div></div></div>");
				$("."+listItem+":not(.notDraggable):first",wrapper).before("<div class='"+dropzone+"'><div></div></div>");
//				$("#dragBelowToExclude",wrapper).nextAll("."+listItem+":not(.notDraggable)").addClass("excluded");
//				$("#dragBelowToExclude",wrapper).prevAll("."+listItem+":not(.notDraggable)").removeClass("excluded");


				if ($("body").attr("pane")=="mainMenuPages") {
					if ($("#dragBelowToExclude").length) {
						if ($("#dragBelowToExclude",wrapper).prevAll("."+listItem+":not(.notDraggable)").length==0) {
							$("#dragBelowToExclude",wrapper).before("<div class='"+dropzone+"'><div></div></div>");
							$("."+listItem+":not(.notDraggable):first",wrapper).prev().remove();
						}
					}

					// main pages
						working();
						if ($("#dragBelowToExclude",wrapper).nextAll("."+listItem+".hasSubs").length) {
							error(LangVars.Cant_Exclude_Pages_With_Subs);
							if ($("#filter").length>0) {

								$("#adminPages").load("pages.php?filter="+$("#filter").val(),function(){
									logTrainingClick("typeAndEnterMainMenuPage");
									assignPages();
									assign_page_filter();

									saved("Page Added");
								});
							} else {
								$("#adminPages").load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){
									logTrainingClick("typeAndEnterMainMenuPage");

									assignPages();
									assign_page_filter();


									saved("Page Added");
								});
							}
							return false;
						}

						var order = "";
						var orderNo = parseInt($("#adminPages .topLevelSortable").attr("rel"));
						var id;

						$("#adminPages .editPageBar:not(.notDraggable)").each(function(){
							id = $(this).attr("rel");
							order=order+"!!"+id+"*"+orderNo;
							orderNo = orderNo+10;
						});
						/*
						var excludeAfter="";
						if ($("#adminPages #dragBelowToExclude").length) {
							var first = false;

							$("#adminPages .editPageBar.excluded").each(function(){

								if (first===false) {

									excludeAfter = $(this).attr("rel");
									first=true;
								}

								id = $(this).attr("rel");
								order=order+"!!"+id+"*"+orderNo;
								orderNo = orderNo+10;

							});
						}*/
						$.ajax({
						  type: "POST",
						  url: "pageActions.php",
//						  data: "pageAction=sort&data="+order+"&excludeAfter="+excludeAfter,
						  data: "pageAction=sort&data="+order,
						  success: function(msg){
			if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
							saved("Order Changed");
						  }
						});
				}

				if ($("#rightPaneGalleryImages:visible").length) {
					// gallery images

					working();
					var order = "";

					var id = $("#rightPaneGalleryImages .topBarTitle").attr("gallery-id");
					order=order+"!!"+id+"*";
					var orderNo = 10;
					$(".galleryThumb",$("#rightPaneGalleryImages")).each(function(){
						picId = $(this).attr("id").replace("galleryThumb-","");
						order=order+orderNo+"|"+picId+",";
						orderNo=orderNo+10;
					});

					$.ajax({
					  type: "POST",
					  url: "galleriesActions.php",
					  data: "galleriesAction=imageSort&data="+order,
					  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
						if (msg=="ok") {
							saved("Order Changed");
							$("#galleriesAdmin").load("galleriesActions.php?galleriesAction=show&to_prevent_cache="+(new Date).getTime(),function(){
								$("#galleriesPaneInner .insertTarget").html($("#galleriesAdmin").html());
							});
						} else {
							error(LangVars.Misc_Error);
						}

					  }
					});
				}
				
				if ($("#rightPaneImages:visible").length) {

					working();
					var order = "";

					var id = $("#rightPaneImages .topBarTitle").attr("gallery-id");
					var orderNo = 10;
					$(".contentImage",$("#rightPaneImages")).each(function(){
						picId = $(this).attr("id");
						order=order+orderNo+"|"+picId+",";
						orderNo=orderNo+10;
					});

					$.ajax({
					  type: "POST",
					  url: "pageActions.php",
					  data: "pageAction=imageSort&data="+order,
					  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
						if (msg=="ok") {
							saved("Order Changed");
							
						} else {
							error(LangVars.Misc_Error);
						}

					  }
					});
				}
				if ($("#rightPaneFormInputs:visible").length) {
					// form inputs

					working();
					var order = "";
					var orderNo = 10;
					$(".formInputItem",$("#rightPaneFormInputs")).each(function(){

						id = $(this).attr("id").replace("input-","");
						$("#renameFieldForm"+$("#editFormName").attr("form-id")+id+"form").insertAfter($(this));
						order=order+"!!"+id+"*"+orderNo;
						orderNo = orderNo+10;
					});
					$.ajax({
					  type: "POST",
					  url: "formsActions.php",
					  data: "formsAction=sortInput&data="+order,
					  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

						$("#formsWrapper").load("formsActions.php?formsAction=show&to_prevent_cache="+(new Date).getTime(),function(){

							$("#formsPaneInner .insertTarget").html($("#formsWrapper").html());

							saved("Order Changed");
						});



					  }
					});
				}
				if ($("#rightPaneEventsGroups:visible").length) {
					// form inputs

					working();
					var order = "";
					var orderNo = 10;
					$(".responsiveListItem",$("#rightPaneEventsGroups")).each(function(){

						id = $(this).attr("event-group-id");
						order=order+"!!"+id+"*"+orderNo;
						orderNo = orderNo+10;
					});
					$.ajax({
					  type: "POST",
					  url: "calendarActions.php",
					  data: "calendarAction=sortGroups&data="+order,
					  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

						$("#eventsGroupsList").show().load("calendarActions.php?calendarAction=showGroups&belongsToCal="+$("#calendarEventsDateFilter #showing_cat").val(),function(){

							displayEventGroups();
							$("#eventsGroupsPaneInner .responsiveListItem:first").addClass("listItemHighlight");
							$("#eventsGroupsPaneInner").lovelyScroll();
							assignEventGroupKeys();
							assignSortableListItems($("#eventsGroupsPaneInner"),"listItemHighlight","responsiveListItem");
							setTimeout(function() {
								selectionTools();
							}, 100);

							resetAddForms();
						});

					  }
					});
				}
				if ($("#rightPaneFormInputOptions:visible").length) {
					updateOptions(true);

				}
				if ($("#rightPaneProductOptions:visible").length) {
					updateProductOptions();

				}
				assignSortableListItems(wrapper,highlight,listItem);

			}, 100);


		},
		over: function(e,ui) {
			$(this).addClass("dropping");
			if (!ui.draggable.next().hasClass("dropping") && !ui.draggable.prev().hasClass("dropping")) {

			}
	    },
	    out: function() {
			$(this).removeClass("dropping");
	    }
	});

}

function updateOptions (hardRefresh) {
	working();
	var options = "";
	var id = $("#editInputName").attr("input-id");
	$(".optionItem",$("#rightPaneFormInputOptions")).each(function(){
		if (options=="") {
			options = $(this).attr("name");
		} else {
			options = options+"**!!**"+$(this).attr("name");
		}
	});
	$.ajax({
	  type: "POST",
	  url: "formsActions.php",
	  data: "formsAction=sortOptions&options="+encodeURIComponent(options)+"&id="+id,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

		$("#formsWrapper").load("formsActions.php?formsAction=show&showForm="+id+"&to_prevent_cache="+(new Date).getTime(),function(){
			$("#formsPaneInner .insertTarget").html($("#formsWrapper").html());
			if (hardRefresh) {
				setTimeout(function() {
					showInputOptions($("#formsPaneInner #input-"+id),true);
				}, 10);
			} else {
				selectionTools();
			}
			saved();
		});
	  }
	});
}
function dismissEditors () {
	hide_header_menus();
	if ( $("#bpe_area #bpe_text_dropship").length) {
		bpe_save();
	}
	if ( $("#bpe_area .editingImage").length) {
		saveImage();
	}
	$("#bpe_component_dropship,#bpe_video_dropship,#bpe_image_dropship","#bpe_area").remove();

}
function doNothing () {
	return false;
}
function renamePageImage (clicked) {
	editMeListItem(clicked);
}
function editGalleryImage (clicked) {
	editMeListItem(clicked);
}
function showGalleryImages ($gallery,reloading) {
	hidePanes();
	$("input").unbind();
	//$("#loadingMask").show();
	$(".assetPane").hide();
	$("#galleryImagesPaneInner .insertTarget").html($(".galleryImages",$gallery).html());
	$("#rightPaneGalleryImages .topBarTitle").html("<div><span>"+$gallery.attr("rel")+"</span></div>").attr("gallery-id",$gallery.attr("gallery-id"));
	showPane($("#rightPaneGalleryImages"),false,true,false,reloading);
	//$("#rightPaneGalleryImages").show();
	setTimeout(function() {$("#galleryImagesPaneInner").lovelyScroll();}, 400);

	hidePaneTools();
	$("#loadingMask").hide();
	assignListLasso($("#galleryImagesPaneInner"));
	assignListPane($("#galleryImagesPaneInner"),editGalleryImage);
	assignSortableListItems($("#galleryImagesPaneInner"),"listItemHighlight","responsiveListItem");
	assignGalleryImagesKeys();

	return false;
}
var doubletap=false;
function assignPane ($wrapper,item,highlight,passthroughDoubleTap) {

	$(document).unbind("click");
	$(document).click(function(e){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		if (ismac) {
			if (e.ctrlKey) {
				return false;
			}			
		}
		if ($(e.target).hasClass("paneTools") || $(e.target).parents(".paneTools").length) {
			return false;
		}
		var el = e.target.tagName.toLowerCase();
		if (el!="input") {
			hide_menus();
			hide_header_menus();
		}

		hide_header_menus(true);			



		//resetAddForms();
	});
	$(".paneToolsPrimary:not(#iconbarProductSerialNumbers,#showInvoice,#iconbarProductUploadFile,#exportFormSubmissions,#addNewsletterCustomField,#addEventCustomField,#addVolumeDiscount,#addVolumeDiscount2,#addVolumeDiscountOptions,#addVolumeDiscount2Options,#createGalleryFromSelection,.autoUpdateImage,#editGalleryImagesButton,#resetStaffPassword)",$wrapper.parents(".paneContents")).unbind("click").click(function(){
		if (!$(this).hasClass("unavailable")) {
			if ($(this).hasClass("secondaryAction")) {
				passthroughDoubleTap($(".listItemHighlight",$wrapper),true);
			} else {
				passthroughDoubleTap($(".listItemHighlight",$wrapper));
			}

		}
		return false;
	});
	$wrapper.unbind("click").click(function(e){
		if (ismac) {
			if (e.ctrlKey) {
				return false;
			}			
		}

		if (e.target.nodeName!="INPUT") {
			$("input").blur();
			//resetAddForms();
		}
		if ($(".topBarTitle.editing",$wrapper).length) {
			$(".topBarTitle.editing input",$wrapper).blur();
			return false;
		}
		if ($(".renameFieldForm:visible",$wrapper).length) {
			$(".renameFieldForm:visible .focus",$wrapper).blur();
			return false;
		}
		$t = $(e.target);
		var ok = false;
		if ($t.parent().hasClass("thumbItemEdit")) {
			return false;
		}
		if ($t.hasClass("showSubPages")||$t.parents(".showSubPages").length) {
			if ($("#rightPaneBlog:visible").length) {
				showComments($t.parents(".editBlogBar"));
			}

			if ($("#rightPaneProductCategories:visible").length) {
				if ($t.hasClass("upLevel")||$t.parents(".showSubPages").hasClass("upLevel")) {
					if ($t.hasClass("upLevel")) {
						var $p = $t;
					} else {
						var $p = $t.parents(".showSubPages");
					}
					var breadcrumb = $("#rightPaneProductCategories").attr("prod-cats-breadcrumb").split(",");
					$("#rightPaneProductCategories").attr("prod-cats-breadcrumb","");
					var breadcrumbUnqiue = new Array();
					for (var i = 0; i < breadcrumb.length; i++) {
						if (breadcrumbUnqiue.indexOf(breadcrumb[i]) === -1) {
							breadcrumbUnqiue.push(breadcrumb[i]);
						}
					};

					if ($p.attr("id")!="0") {
						for (var i = 0; i < breadcrumbUnqiue.length; i++) {

							if (i==0) {
								$("#rightPaneProductCategories").attr("prod-cats-breadcrumb",breadcrumbUnqiue[i]);

							} else {

								if (breadcrumbUnqiue[i]!=$p.attr("actual-id")) {

									$("#rightPaneProductCategories").attr("prod-cats-breadcrumb",$("#rightPaneProductCategories").attr("prod-cats-breadcrumb")+","+breadcrumbUnqiue[i]);
								} else {
									break;
								}
							}
						};
					}


					displayProdCats($p.attr("id"),false);
				} else {
					displayProdCats($t.parents(".prodCatItem").attr("product-category-id"),true);
				}
			}

			return false;
		}
		if ($t.hasClass("bpe_tiny_image") || $t.parents(".bpe_tiny_image").length) {
			$t = $t.parents("."+item);
			ok=true;
		}
		if ($t.parents("."+item).length) {
			$t = $t.parents("."+item);
			ok=true;
		}
		if ($t.hasClass(item) && item!="thumbItem") {
			ok=true;
		}

		if (ok) {


			if (e.shiftKey) {

				if ($t.prevAll("."+highlight).length) {
					$t.addClass(highlight+" stop");
					$t.prevAll("."+highlight+":first").nextAll("."+item).each(function(){
						if ($(this).hasClass("stop")) {
							return false;
						}
						$(this).addClass(highlight);
					});
					$("."+highlight+".stop").removeClass("stop");
				}
				if ($t.nextAll("."+highlight).length) {
				   $t.addClass(highlight+" stop");
					$t.nextAll("."+highlight+":last").prevAll("."+item).each(function(){
						if ($(this).hasClass("stop")) {
							return false;
						}
						$(this).addClass(highlight);
					});
					$("."+highlight+".stop").removeClass("stop");
				}
				$t.addClass(highlight);

			} else {
				if (doubletap && touchdown!=1) {
					clearTimeout(singleClick);

					touchdown=0;

					if ($("."+highlight).length==1) {
						passthroughDoubleTap($t);
					}

					return false;
				}
				if (!doubletap) {
					doubletap = true;
					setTimeout(function() {
						doubletap=false;
					}, 300);
					singleClick = setTimeout(function(){
						selectionTools();
					},300);
					if (!e.metaKey && !e.shiftKey && ismac) {
						$("."+highlight).removeClass(highlight);
					}
					if (!e.metaKey && !e.shiftKey && !e.ctrlKey && !ismac) {
						$("."+highlight).removeClass(highlight);
					}
					if ($t.hasClass(highlight)) {
						$t.removeClass(highlight);
					} else {
						if (!$t.prevAll(".editBlogBar").length && $t.hasClass("editBlogBar")) {
							logTrainingClick("highlightFirstBlog");
						}
						$t.addClass(highlight);
						if ($("#tab2Images").hasClass("selected")) {
							logTrainingClick("highlightStorageImage");
						}
						if ($("#tab2Newsletter").hasClass("selected")) {
							logTrainingClick("highlightMailingList");
						}
					}

				}
			}

		} else {

			$("."+highlight).removeClass(highlight);
			$("body").removeClass("selectingAll");

			selectionTools();

		}

		hide_iconbar_menus();
		//$("input").blur();
		return false;
	});
}
function assignThumbsPane ($wrapper,passthroughDoubleTap) {
	assignPane($wrapper,"thumbItem","imageItemHighlight",passthroughDoubleTap);
}
function assignListPane ($wrapper,passthroughDoubleTap) {
	assignPane($wrapper,"responsiveListItem","listItemHighlight",passthroughDoubleTap);
}
function assignLasso (wrapper,item,highlight) {
	return false;
	var wrapper = $("> .insertTarget",wrapper);
	//wrapper.selectable("destroy");
	wrapper.selectable({
		filter: '.'+item
		,selecting: function(event, ui) {
			$("."+highlight).removeClass(highlight);
			$(".ui-selecting").addClass(highlight);
			$(".ui-selected").addClass(highlight);
				// show/hide selection based tools

				selectionTools();

		 }
		,unselecting: function(event, ui) {
			$("."+highlight).removeClass(highlight);
			$(".ui-selecting").addClass(highlight);
			$(".ui-selected").addClass(highlight);
			selectionTools();

			// show/hide selection based tools
		 }
		,start: function(){
			$("input").blur();
		}
		,delay: 20
	});
}
function assignThumbLasso (wrapper) {
	assignLasso(wrapper,"thumbItem","imageItemHighlight");

}
function assignListLasso (wrapper) {

	assignLasso(wrapper,"responsiveListItem","listItemHighlight");

}
var flag1p=false;

function resetAddForms () {
	$("input").blur();
	$(".clearAfterSend").val("");
	$(".withFakeFormItem,.hideOnReset").hide();
	//$("#adminPages .responsiveListAddForm").insertBefore($("#adminPages .responsiveListItem").first().prev());
	cancelDialogue();
}
function assignAddForms () {
	$(".hiddenFields").hide();
	$(".addItemForm .focus").unbind("focus").focus(function(){
		$(document).unbind("keyup");
		$(document).unbind("keydown");
		$(document).unbind("keypress");
		$(document).unbind("click");
		$(document).keydown(function(e){
			if (e.keyCode==27) { // esc
				$("input").blur();
				return false;
			}
		});
		$(".hiddenFields",$(this).parents("form")).slideDown();
		if ($(this).attr("data-original")==undefined) {
			$(this).attr("data-original",$(this).val());
		}
		$(this).val("");
	});
	$(".addItemForm input:not(.focus)").unbind("focus").focus(function(){
		if ($(this).attr("data-original")==undefined) {
			$(this).attr("data-original",$(this).val());
		}
		$(this).val("");
	});
	$(".addItemForm input").unbind("blur").blur(function(){
		if ($(this).attr("data-original")!=undefined) {
			$(this).val($(this).attr("data-original"));
		}
		$(".hiddenFields",$(this).parents("form")).slideUp();
		cancelDialogue();
	});
}

var doubletabpages = false;
function assignPages () {

	bindReturnsToLP();
	bindToggleLivePreview();
	$("#deletedPages").click(function(e){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($(e.target).hasClass("overflowEllipsis")) {
			$this = $(e.target).parent();
		} else {
			$this = $(e.target);
		}
		$this.addClass("toRestore");
				prepDialogue("<h2>"+LangVars.Restore_Deleted_Page+"</h2><p>"+LangVars.Restore_Deleted_Page_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Restore,restorePage,false,true,false,"");

		return false;
	});
	$("#adminPages #redirectingPageToggle").unbind("click").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		if (!$(this).hasClass("unavailable")) {
			prepDialogue("<h2>"+LangVars.Add_Redirecting_Page+"</h2><p>"+LangVars.Add_Redirecting_Page_Info+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Save,editRedirecting,false,true,true,"pageRedirecting");
		}

	});
	$("#adminPages #exludedPageToggle").unbind("click").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		
		if ($(this).hasClass("bpe_current")) {
			var ex = '0';
		} else {
			var ex = '1';
		}
		var Ids="[";
		$("#adminPages .listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("rel")+'"';
			} else {
			Ids+=',"'+$(this).attr("rel")+'"';
			}
		});
		Ids+="]";
		working();
		$.ajax({
		  type: "POST",
		  url: "pageActions.php",
		  data: "pageAction=toggleExcluded&ids="+Ids+"&exclude="+ex,
		  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

				if (msg!="ok") {
					error(msg);
				} else {
					$("#adminPages .listItemHighlight").attr("data-excluded",ex);
					if (ex=="1") {
						$("#adminPages .listItemHighlight").addClass("excluded");
					} else {
						$("#adminPages .listItemHighlight").removeClass("excluded");
					}
					
					selectionTools();
					cancelDialogue();
					saved();
				}
		  }
		});
		
	});
	$("#adminPages #redirectFirstSubPageToggle").unbind("click").click(function(){
		if(!$(this).hasClass("unvailable")) {
			if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		
			if ($(this).hasClass("bpe_current")) {
				var red = '0';
			} else {
				var red = '1';
			}
			var Ids="[";
			$("#adminPages .listItemHighlight").each(function(){
				if (Ids=="[") {
				Ids+='"'+$(this).attr("rel")+'"';
				} else {
				Ids+=',"'+$(this).attr("rel")+'"';
				}
			});
			Ids+="]";
			working();
			$.ajax({
			  type: "POST",
			  url: "pageActions.php",
			  data: "pageAction=toggleRedirectFirst&ids="+Ids+"&redirect="+red,
			  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

					if (msg!="ok") {
						error(msg);
					} else {
						$("#adminPages .listItemHighlight").attr("data-redirect-first",red);
					
						selectionTools();
						cancelDialogue();
						saved();
					}
			  }
			});
		}	
	});
	$("#adminPages #newWindowToggle").unbind("click").click(function(){
		if(!$(this).hasClass("unvailable")) {
			if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		
			if ($(this).hasClass("bpe_current")) {
				var newwindow = '0';
			} else {
				var newwindow = '1';
			}
			var Ids="[";
			$("#adminPages .listItemHighlight").each(function(){
				if (Ids=="[") {
				Ids+='"'+$(this).attr("rel")+'"';
				} else {
				Ids+=',"'+$(this).attr("rel")+'"';
				}
			});
			Ids+="]";
			working();
			$.ajax({
			  type: "POST",
			  url: "pageActions.php",
			  data: "pageAction=toggleNewWindow&ids="+Ids+"&newwindow="+newwindow,
			  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

					if (msg!="ok") {
						error(msg);
					} else {
						$("#adminPages .listItemHighlight").attr("data-new-window",newwindow);
					
						selectionTools();
						cancelDialogue();
						saved();
					}
			  }
			});
		}	
	});
	$("#adminPages .paneToolsPrimary:not(.addSubpagePT)").unbind("click").click(function(){
		if (!$(this).hasClass("unavailable")) {
			working();
			$("#loadingMask").show();
			window.location="pagesEditPage.php?viewVersion="+$("#adminPages .listItemHighlight").attr("id");
			return false;

		}
		return false;
	});
	$("#adminPages .paneToolsPrimary.addSubpagePT").unbind("click").click(function(){
		if (!$(this).hasClass("unavailable")) {

			if ($("#adminPages .responsiveListItem.listItemHighlight").length!=1) {
				return false;
			}
			$target = $("#adminPages .responsiveListItem.listItemHighlight");
			$("#iconbarAddPage").removeClass("nonMenuPages");
			$("#iconbarAddPage").removeClass("mainMenuPages");
			$("#iconbarAddPage").addClass("subMenuPages");

			currentTooltipItem=0;
			currentTooltip=false;
			hideToolTips(false);
			working();
			bits = $target.attr("data-view-sub-data").split("|");
			var id = bits[0];
			var type = bits[1];
			$.ajax({
			  type: "POST",
			  url: "pageActions.php",
			  data: "pageAction=viewSubs&id="+id+"&type="+type,
			  success: function(msg){
				if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

				$("#adminPages").load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){

					assignPages();
					assign_page_filter();
					if ($(".responsiveListItem:not(.breadcrumbPage)","#adminPages").length===0) {
						addPage();
					}

					saved();
				});
			  }
			});

		}
		return false;
	});
	$("#adminPages #iconbarAddPage").unbind().click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		addPage();
		return false;
	});
	$("#addAccessGroup").unbind().click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.Add_Access_Groups+"</h2><p>"+LangVars.Add_Access_Groups_Info+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Add,addAccessGroup,false,true,true,"pagesSecurity");
		return false;
	});
	$("#adminPages #groupList").load("accessGroupActions.php?accessGroupActions=showAccessGroups",function(){

	});
	$("#groupList,#public").click(function(e){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($(e.target)[0].tagName.toLowerCase()=="a") {
			if (!$(e.target).hasClass("bpe_current")) {
				applyProtection($(e.target).attr("rel"),"add");
			} else {
				applyProtection($(e.target).attr("rel"),"remove");
			}
		}
		return false;
	});
	assignHeaderMenus();
	assignEditMenuPages();
	$(document).unbind("click");
	$(document).click(function(e){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		if ($(e.target).hasClass("paneTools") || $(e.target).parents(".paneTools").length) {			
			return false;
		}
		hide_menus();
		hide_header_menus(true);
	});
	/*
	$("#adminPages .paneTools").click(function(e){
		if ($(e.target).hasClass('iScrollIndicator')) {
			return false;
		}
//		hide_header_menus(true);
		return false;
	});*/
	$("#changeAddLanguage a").unbind().click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		if ($(this).hasClass("bpe_current")) {
			return false;
		}
		if ($(this).hasClass("changeLanguage")) {
			var lang = $(this).attr("fakehref");
			changeLanguage(lang);
		} else {
			pagesAddLanguage($(this));
		}
		return false;
	});
	$("#makeOnline").unbind().click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		logTrainingClick("statusToolbarLive");
		toggleLive("yes");
		return false;
	});
	$("#makeOffline").unbind().click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		toggleLive("");
		return false;
	});
	$("#adminPages .showLeftPane").click(function(){
		if (!flag1p) {
			flag1p=true;
			setTimeout(function() {
				flag1p=false;
			}, 500);
			$("body").addClass("slideoverLeftPane");
			$("#leftPaneMask").fadeIn(100);
			$("#fixedMenus").animate({left:"0px"},100,function(){


			});
		}
		return false;
	});

	assignSortableListItems($("#adminPages .pagesScroll"),"listItemHighlight","responsiveListItem");
	assignLasso($("#adminPages .pagesScroll"),"responsiveListItem","listItemHighlight");

	assignPagesKeys();
	//popdownPaginate("pages.php","ajax=true","#adminPages");
	if ($("#tab2MainMenuPages.selected").length) {
		$("#adminPages #mainMenuPagesMain").show();
		$("#adminPages #nonLinkingPagesMain").hide();
	}
	if ($("#tab2NonMenuPages.selected").length) {
		$("#adminPages #mainMenuPagesMain").hide();
		$("#adminPages #nonLinkingPagesMain").show();
	}


	/*

	$("#adminPages .filterBy").unbind().click(function(){

		filter = $(this).attr('id');
		$("#adminPages").load("pages.php?filter="+filter,function(){

			assignPages();
			assign_page_filter();
		});
		return false;
	});
	*/
	$("#adminPages #addTopLevelForm").unbind().submit(function(){
		if (!$("#adminPages #addTopLevelForm:visible").length) {
			return false
		}
		working();
		function showResponse (responseText, statusText) {
if (responseText =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			if ($("#filter").length>0) {
				$("#adminPages").load("pages.php?filter="+$("#filter").val(),function(){
					logTrainingClick("typeAndEnterMainMenuPage");
					assignPages();
					assign_page_filter();

					saved("Page Added");
				});
			} else {
				$("#adminPages").load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){
					logTrainingClick("typeAndEnterMainMenuPage");

					assignPages();
					assign_page_filter();


					saved("Page Added");
				});
			}
			if (currentTooltip) {
				interuptedChains.push({currentTooltip:currentTooltip,currentTooltipItem:currentTooltipItem});
				clearTimeout(toolTipTimeout);
			}
			currentTooltipItem=0;
			currentTooltip="addednewpage";
			toolTipTimeout = setTimeout(tooltip, 1000);


			if (responseText=="exists") {
				error(LangVars.Page_Name_Exists);
			} else if (responseText=="limit") {
				error(LangVars.Page_Limit_Reached);
			}
		}
		var options = {
	        success:       showResponse  // post-submit callback
	    };
		var name = $("input[name=title]",this).val().toLowerCase();
		if (name==""){
			saved();
			return false;
		}
		if (name==""||name=="setup"||name=="admin"||name=="date"||name=="product added"||name=="page"||name=="category"||name=="populate"||name=="rss"||name=="search"||name=="install"||name=="media"||name=="downloads")  {
			error(LangVars.Name_Reserved);
		} else {
			$('#addTopLevelForm').ajaxSubmit(options);
		}
		return false;
	});
	$("#adminPages #submitTopLevelPage").unbind().click(function(){
		$("#addTopLevelForm").submit();
		return false;
	});
	/*
	$("#adminPages #addNonLinkingForm").unbind().submit(function(){
		if (!$("#adminPages #addNonLinkingForm:visible").length) {
			return false
		}

		working();
			function showResponse (responseText, statusText) {
if (responseText =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
 				if ($("#filter").length>0) {
						$("#adminPages").load("pages.php?filter="+$("#filter").val(),function(){
							logTrainingClick("typeAndEnterNonMenuPage");
							assignPages();
							assign_page_filter();

							saved("Page Added");
						});
					} else {
						$("#adminPages").load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){
							logTrainingClick("typeAndEnterNonMenuPage");
							assignPages();
							assign_page_filter();

							saved("Page Added");
						});
					}
					if (currentTooltip) {
						interuptedChains.push({currentTooltip:currentTooltip,currentTooltipItem:currentTooltipItem});
						clearTimeout(toolTipTimeout);
					}
					currentTooltipItem=0;
					currentTooltip="addednewpage";
					toolTipTimeout = setTimeout(tooltip, 1000);

				if (responseText=="exists") {
					error(LangVars.Page_Name_Exists);
				} else if (responseText=="limit") {
					error(LangVars.Page_Limit_Reached);
				}

			}
			var options = {
		        success:       showResponse  // post-submit callback
		    };
			var name = $("input[name=title]",this).val().toLowerCase();
			if (name==""||name=="setup"||name=="admin"||name=="date"||name=="product added"||name=="page"||name=="category"||name=="populate"||name=="rss"||name=="search"||name=="install"||name=="media"||name=="downloads")  {
			cancel();
		} else {
			$('#addNonLinkingForm').ajaxSubmit(options);
		}
		return false;
	});
	$("#adminPages #addNonLinkingButton").unbind().click(function(){
		$("#addNonLinkingForm").submit();
		return false;
	});
	*/
	$("#adminPages .subPageForm").unbind().submit(function(){
		if (!$("#adminPages .subPageForm:visible").length) {
			return false
		}

		working();
			function showResponse (responseText, statusText) {
if (responseText =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if ($("#filter").length>0) {
						$("#adminPages").load("pages.php?filter="+$("#filter").val(),function(){
							logTrainingClick("typeAndEnterSubMenuPage");
							assignPages();
							assign_page_filter();
							saved("Page Added");
						});
					} else {
						$("#adminPages").load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){
							logTrainingClick("typeAndEnterSubMenuPage");
							assignPages();
							assign_page_filter();
							saved("Page Added");
						});
					}
					if (currentTooltip) {
						interuptedChains.push({currentTooltip:currentTooltip,currentTooltipItem:currentTooltipItem});
						clearTimeout(toolTipTimeout);
					}
					currentTooltipItem=0;
					currentTooltip="addednewpage";
					toolTipTimeout = setTimeout(tooltip, 1000);
				if (responseText=="exists") {
					error(LangVars.Page_Name_Exists);
				} else if (responseText=="limit") {
					error(LangVars.Page_Limit_Reached);
				}
			}
			var options = {
		        success:       showResponse  // post-submit callback
		    };
		var name = $("input[name=title]",this).val().toLowerCase();
		if (name==""||name=="setup"||name=="admin"||name=="date"||name=="product added"||name=="page"||name=="category"||name=="populate"||name=="rss"||name=="search"||name=="install"||name=="media"||name=="downloads")  {
			cancel();
		} else {
			$(this).ajaxSubmit(options);
		}
		return false;
	});
	$("#adminPages .submitSubPageForm").unbind().click(function(){
		id = $(this).attr('id');
		$("form","#"+id+"form").submit();
		return false;
	});
	$("#adminPages .toggleSubPage").unbind().click(function(){
		dismissPopupController();
		clickToAddNew($(this),$("#"+$(this).attr("id")+"form")," Type a new page name and hit enter",false);



		return false;
	});

	$("#adminPages .subSubPageForm,#adminPages .subSubSubPageForm").unbind().submit(function(){
		if (!$("#adminPages .subSubPageForm:visible,#adminPages .subSubSubPageForm:visible").length) {
			return false
		}

		working();
			function showResponse (responseText, statusText) {
if (responseText =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if ($("#filter").length>0) {
					$("#adminPages").load("pages.php?filter="+$("#filter").val(),function(){

						assignPages();
						assign_page_filter();
						saved("Page Added");
					});
				} else {
					$("#adminPages").load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){

						assignPages();
						assign_page_filter();
						saved("Page Added");
					});
				}
				if (currentTooltip) {
					interuptedChains.push({currentTooltip:currentTooltip,currentTooltipItem:currentTooltipItem});
					clearTimeout(toolTipTimeout);
				}
				currentTooltipItem=0;
				currentTooltip="addednewpage";
				toolTipTimeout = setTimeout(tooltip, 1000);
				if (responseText=="exists") {
					error(LangVars.Page_Name_Exists);
				} else if (responseText=="limit") {
					error(LangVars.Page_Limit_Reached);
				}

			}
			var options = {
		        success:       showResponse  // post-submit callback
		    };
		var name = $("input[name=title]",this).val().toLowerCase();
		if (name==""||name=="setup"||name=="admin"||name=="date"||name=="product added"||name=="page"||name=="category"||name=="populate"||name=="rss"||name=="search"||name=="install"||name=="media"||name=="downloads")  {
			cancel();
		} else {
			$(this).ajaxSubmit(options);
		}
		return false;
	});
	$("#adminPages .submitSubSubPageForm").unbind().click(function(){
		id = $(this).attr('id');
		$("form","#"+id+"form").submit();
		return false;
	});

	$("#adminPages .toggleSubSubPage").unbind().click(function(){
		dismissPopupController();
		clickToAddNew($(this),$("#"+$(this).attr("id")+"form")," Type a new page name and hit enter",false);
		return false;
	});
	$("#adminPages .toggleSubSubSubPage").unbind().click(function(){
		dismissPopupController();
		clickToAddNew($(this),$("#"+$(this).attr("id")+"form")," Type a new page name and hit enter",false);
		return false;
	});

	$("#adminPages").unbind("click").click(function(e){

		if (ismac && e.ctrlKey) {return false;}
		if (e.target.nodeName!="INPUT") {
			//$("input").blur();
		}
		if ($(e.target).hasClass("paneTools")||$(e.target).parents(".paneTools").length) {
			if (!$(e.target).parent().hasClass("bpe_selection_tool")&&!$(e.target).hasClass("bpe_selection_tool"))  {
				hide_header_menus(true);								
			}


		}
		if ($(e.target).hasClass("editPageBar") || $(e.target).parents(".editPageBar").length) {

			if ($(e.target).hasClass("editPageBar")) {

				$this=$(e.target);
			} else {
				$this=$(e.target).parents(".editPageBar");
				if ($(e.target).hasClass("backToMainPages")||$(e.target).parents().hasClass("backToMainPages")) {

					if (currentTooltip) {
						interuptedChains.push({currentTooltip:currentTooltip,currentTooltipItem:currentTooltipItem});
						clearTimeout(toolTipTimeout);
					}
					currentTooltipItem=0;
					currentTooltip="mainmenupages";

					toolTipTimeout = setTimeout(tooltip, 1000);
					dismissPopupController();
					$.ajax({
					  type: "POST",
					  url: "pageActions.php",
					  data: "pageAction=showTop",
					  success: function(msg){
						if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

						$("#adminPages").load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){

							if ($("#adminPages").attr("id")=="adminPages") {
								assignPages();
							}
							assign_page_filter($("#adminPages"));
							saved();
						});
					  }
					});

				return false;
				}
				if (($(e.target).hasClass("showSubPages")||$(e.target).parents().hasClass("showSubPages"))&&!$(e.target).hasClass("backToMainPages")) {

					if ($(e.target).hasClass("showSubPages")) {
						$target=$(e.target);
					} else {
						$target=$(e.target).parents(".showSubPages");
					}
					$("#iconbarAddPage").removeClass("nonMenuPages");
					$("#iconbarAddPage").removeClass("mainMenuPages");
					$("#iconbarAddPage").addClass("subMenuPages");

					currentTooltipItem=0;
					currentTooltip=false;
					hideToolTips(false);
					working();
					bits = $target.attr("id").split("|");
					var id = bits[0];
					var type = bits[1];
					$.ajax({
					  type: "POST",
					  url: "pageActions.php",
					  data: "pageAction=viewSubs&id="+id+"&type="+type,
					  success: function(msg){
						if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

						$("#adminPages").load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){

							assignPages();
							assign_page_filter();
							saved();
						});
					  }
					});

				}
			}
			if ($this.hasClass("notokperms")) {
				return false;
			}
			if (doubletabpages && touchdown!=1) {
				clearTimeout(singleClick);
				if (!$(e.target).hasClass("showSubPages")&&!$(e.target).hasClass("hideInLight")) {
					//$("#loadingMask").show();
					window.location="pagesEditPage.php?viewVersion="+$this.attr("id");
					return false;
				}
				return false;
			}
			if (!doubletabpages) {
				doubletabpages = true;
				setTimeout(function() {
					doubletabpages=false;
				}, 300);
				singleClick = setTimeout(function() {

					selectionTools();

				}, 300);
				if (!$(e.target).hasClass("showSubPages")&&!$(e.target).hasClass("hideInLight")) {
					//window.location="pagesEditPage.php?viewVersion="+$(this).attr("id");
					if ((e.metaKey&&ismac)||(e.ctrlKey&&!ismac)) {
						if ($this.hasClass("listItemHighlight")) {
							$this.removeClass("listItemHighlight");
						} else {
							$this.addClass("listItemHighlight");
						}
					} else {
						if (e.shiftKey) {
							if ($this.prevAll(".listItemHighlight").length) {
								$this.addClass("listItemHighlight stop");
								$this.prevAll(".listItemHighlight:first").nextAll(".editPageBar").each(function(){
									if ($(this).hasClass("stop")) {
										return false;
									}
									$(this).addClass("listItemHighlight");
								});
								$(".listItemHighlight.stop").removeClass("stop");
							}
							if ($this.nextAll(".listItemHighlight").length) {
								$this.addClass("listItemHighlight stop");
								$this.nextAll(".listItemHighlight:last").prevAll(".editPageBar").each(function(){
									if ($(this).hasClass("stop")) {
										return false;
									}
									$(this).addClass("listItemHighlight");
								});
								$(".listItemHighlight.stop").removeClass("stop");
							}
							$this.addClass("listItemHighlight");

						} else {
							$(".listItemHighlight").removeClass("listItemHighlight");
							$("body").removeClass("selectingAll");
							$this.addClass("listItemHighlight");
							if (!$this.prevAll(".editPageBar").length) {
								logTrainingClick("highlightFirstPage");
							}
						}
					}

					if (currentTooltip) {
						interuptedChains.push({currentTooltip:currentTooltip,currentTooltipItem:currentTooltipItem});
						clearTimeout(toolTipTimeout);
					}

					return false;
				}


			}
		}
	});



	$("#adminPages .faded.menu_options,.faded.show_choices").css("opacity",0.5);


	$("#adminPages #showNonLinkingPageForm").unbind().click(function(){
		dismissPopupController();
		addNewNonLinking();
		return false;
	});
	selectionTools();
}
function checkStatus () {

	$.ajax({
	  type: "POST",
	  url: "newsletterActions.php",
	  data: "newsletterAction=checkStatus",
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		if (msg != "error") {
			//if ($("#selectedMailingListPage").attr("page-id")!="") {
			$("#changeMailingListPageContent").addClass("okToSend");
			//}
		} else {
			$("#changeMailingListPageContent").removeClass("okToSend");
		}
	  }
	});
}

function assign_page_filter (obj) {



	//lightPagesHeight();
	if (typeof obj==='undefined') {
		obj = $("#adminPages");
		var skipOthers=true;
	} else {
		var skipOthers=false;
	}
	if (obj.parents("#cal").length) {
		return;
	}
	assignHeaderMenus();
	prepFancyLabelForms($(".filterBox",obj));
	if (obj.attr("id")=="lightPagesListInner") {
		$(".pagesScroll",obj).lovelyScroll(pagesScrollBottomLightPages);
	} else {
		$(".pagesScroll",obj).lovelyScroll(pagesScrollBottomPane);
	}



	//$(".pageFilterSearch",obj).unbind("focus");
	$(".pageFilterSearch",obj).click(function(){
		return false;
	})
	$(".pageFilterSearch",obj).focus(function(){
		/*miniSearchStart($(".topBar",obj));

		if ($(this).val()==LangVars.Search) {
			dismissPopupController();
			$(this).val("");
		}*/
		$(document).unbind("keyup");
		$(document).unbind("keydown");
		//return false;
	});

	$(".pageFilterSearch",obj).unbind("blur");
	$(".pageFilterSearch",obj).blur(function(){
		/*miniSearchStop($(".topBar",obj));
		if ($(this).val()=="") {
			$(this).val(LangVars.Search);
		}*/
		assignPagesKeys();
	});
	$(".showAllPages",obj).unbind();
	$(".showAllPages",obj).click(function(){
		working();
		dismissPopupController();

			$.ajax({
			  type: "POST",
			  url: "pageActions.php",
			  data: "pageAction=showTop",
			  success: function(msg){
				if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

				obj.load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){
					if (obj.attr("id")=="adminPages") {
						assignPages();
					}
					assign_page_filter(obj);
					saved();
				});
			  }
			});

		return false;
	});
	$("#pagesFilter").on('click', 'a',  function(e){
//	$("#pagesFilter",obj).unbind().click(function(e){
//		if ($(e.target)[0].nodeName.toLowerCase()=="a") {
//			$this = $(e.target);
//		}
		var filter = $(this).attr("data-item-value");
		obj.load("pages.php?to_prevent_cache="+(new Date).getTime()+"&filter="+filter,function(){
			if (obj.attr("id")=="adminPages") {
				assignPages();
			}
			assign_page_filter(obj);
			saved();
		});
		return false;
	});
	/*
	$(".filterBy",obj).unbind().click(function(){
		working();
		filter = $(this).attr('id');
		obj.load("pages.php?to_prevent_cache="+(new Date).getTime()+"&filter="+filter,function(){
			if (obj.attr("id")=="adminPages") {
				assignPages();
			}
			assign_page_filter(obj);
			saved();
		});
		return false;
	});*/
	$(".showAll",obj).unbind().click(function(){
		working();

		obj.load("pages.php?filter=&to_prevent_cache="+(new Date).getTime(),function(){
			if (obj.attr("id")=="adminPages") {
				assignPages();
			}
			assign_page_filter(obj);
			saved();
		});
		return false;
	});
	$(".filterPage",obj).unbind();
	$(".filterPage",obj).click(function(){
		working();
		var page = $(this).attr("href");
		$.ajax({
		  type: "POST",
		  url: "pageActions.php",
		  data: "pageAction=changeView&showPage="+page,
		  success: function(msg){
			if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			obj.load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){
				if (obj.attr("id")=="adminPages") {
					assignPages();
				}
				assign_page_filter(obj);
				saved();
			});
		  }
		});
		return false;
	});
	function sendSearch (val,obj) {
		working();
		var string = val;
		$.ajax({
		  type: "POST",
		  url: "pageActions.php",
		  data: "pageAction=filterSearch&string="+string,
		  success: function(msg){
			if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

			obj.load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){
				if (obj.attr("id")=="adminPages") {
					assignPages();
				}
				assign_page_filter(obj);
				saved();
			});
		  }
		});
	}
	$(".pageFilterSearch",obj).parents("form").unbind("submit");
	$(".pageFilterSearch",obj).parents("form").submit(function(){
		sendSearch($(".pageFilterSearch",$(this)).val(),obj);
		return false;
	});
	$(".pageFilterSearch",obj).unbind("keydown");
	$(".pageFilterSearch",obj).keyup(function(e){
		if (e.which==13) {
			sendSearch($(this).val(),obj);
		}
	});
	$(".clearSearch",obj).unbind();
	$(".clearSearch",obj).click(function(){
		working();
		$.ajax({
		  type: "POST",
		  url: "pageActions.php",
		  data: "pageAction=filterSearch&string=",
		  success: function(msg){
			if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

			obj.load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){
				if (obj.attr("id")=="adminPages") {
					assignPages();
				}
				assign_page_filter(obj);
				saved();
			});
		  }
		});
	});

	$(".showNonLinkingPages",obj).unbind();
	$(".showNonLinkingPages",obj).click(function(){
		working();
		dismissPopupController();
		$.ajax({
		  type: "POST",
		  url: "pageActions.php",
		  data: "pageAction=showNonLinkers",
		  success: function(msg){
			if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

			obj.load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){
				if (obj.attr("id")=="adminPages") {
					assignPages();
				}
				popdownPaginate("pages.php","ajax=true","#lightPagesListInner");
				assign_page_filter(obj);

				saved();
			});
		  }
		});
	});

	$("#tick",obj).unbind().click(function(){
		var thisLeft = $(this).offset().left;
		var thisTop = $(this).offset().top;
		thisTop = thisTop-45;
		var w = $("#popupControl").width();
		w = w/2;
		thisLeft = thisLeft-w;
		$("#popupControl").css("top",thisTop+"px");
		$("#popupControl").css("left",thisLeft+"px");
		$("#popupControl").fadeIn();
		$(".editPageBar.checked").removeClass("checked");
		$("#adminPages").addClass("ticking").removeClass("notTicking");
		$(this).fadeOut();
		return false;
	});
	$(".breadcrumbViewSub",obj).unbind();
	$(".breadcrumbViewSub",obj).click(function(){
		dismissPopupController();
		working();
		bits = $(this).attr("rel").split("|");
		var id = bits[0];
		var type = bits[1];
		$.ajax({
		  type: "POST",
		  url: "pageActions.php",
		  data: "pageAction=viewSubs&id="+id+"&type="+type,
		  success: function(msg){
			if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

			obj.load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){
				if (obj.attr("id")=="adminPages") {
					assignPages();
				}
				assign_page_filter(obj);
				saved();
			});
		  }
		});
	});

}
function eraseCookie(name) {
	createCookie(name,"",-1);
}

function cancel () {
//	$("#overlay").fadeOut(200);
//	$("#working").fadeOut(200);
	$("#loadingPNGWrap,#loadingPercent").fadeOut(200);
//	clearInterval(loadingAnimator);
}
function error (msg) {
	$("#loadingPNGWrap,#loadingPercent").fadeOut(200);
//	clearInterval(loadingAnimator);
	$("#overlay").fadeOut(200);
	$("#error").html(msg);

	$("#error").css("top","-80px").fadeIn(200).animate({top:"20px"});
}
function message (msg) {
	$("#loadingPNGWrap,#loadingPercent").fadeOut(200);
//	clearInterval(loadingAnimator);
	$("#overlay").fadeOut(200);
	$("#message").html(msg);

	$("#message").css("top","-80px").fadeIn(200).animate({top:"20px"});
}

function saved (skipLP) {
	if (skipLP!==true) {
		livepreview();
	}
//	clearInterval(loadingAnimator);
	$("#loadingPNGWrap,#loadingPercent").fadeOut(200);
}
function savedLog (msg) {

	$("#working").fadeOut(200);
	$("#savedLog").html(msg);
	$("#savedLog").fadeIn(200);
//	setTimeout(function() {$("#saved"Log).fadeOut(200);$("#overlay").fadeOut(200);}, 1000);
}
function working () {
//	clearTimeout(loadingAnimator);
//	$("#miniLoading").fadeIn(200);
//	loadingAnimator = setInterval(animateLoadingPNG, 40);
	$("#loadingPNGWrap").fadeIn(200);
}
function uploading(percent) {
	if ($("#loadingPercent:visible").length==0) {
		clearTimeout(loadingAnimator);
//		loadingAnimator = setInterval(animateLoadingPNG, 40);
		$("#loadingPNGWrap").fadeIn(200);
		$("#loadingPercent").fadeIn(200);
	}

	$("#loadingPercentBar").css("width",percent+"%");
}
function dismissPopupController () {
	if ($("#adminPages").hasClass("ticking")) {
		$("#adminPages").removeClass("ticking").addClass("notTicking");
		$("#popupControl").fadeOut();
		$("#tick").fadeIn();
		cancelPopupControl();
	}
}
function cancelPopupControl () {
	var sl1w = $("#slideMask .slide1").width();
	var sl2w = $("#slideMask .slide2").width();
	var half = sl2w-sl1w;

	$("#slideMask .slideWrapper").animate({left:'0px'});
	$("#slideMask").animate({ width:sl1w+"px" });
	half = half / 2;
	var curleft = $("#popupControl").offset().left;
	half = curleft+half;
	$("#popupControl").animate({left:half+'px'});
}

function hide_iconbar_menus () {
	$(".iconbarMenu").hide();
	hide_header_menus();
}
function pagesCutCopy (type) {
	working();
	if ($(".listItemHighlight").length) {
		$("#iconbarPastePages").removeClass("greyedOut");
	}
	var Ids="[";
	$("#adminPages .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("rel")+'"';
		} else {
		Ids+=',"'+$(this).attr("rel")+'"';
		}
	});
	Ids+="]";
	$.ajax({
	  type: "POST",
	  url: "pageActions.php",
	  data: "pageAction="+type+"&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		if (msg!="ok") {
			error(msg);
		} else {
			if (type=="cut_page") {
				$(".listItemHighlight").each(function(){
					$(this).prev().remove();
					$(this).remove();
				});

			}
			saved();
			hide_menus();
		}
	  }
	});
}
function assignAddFormForm () {
	$("#rightPaneForms #addFormForm").unbind("submit").submit(function(){
		working();
		function showResponse (responseText, statusText) {
	if (responseText =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			if (responseText=="ok") {
				$("#formsWrapper").load("formsActions.php?formsAction=show&to_prevent_cache="+(new Date).getTime(),function(){
					addFormsToSettings();
					$("#formsPaneInner .insertTarget").html($("#formsWrapper").html());
					$("#formsPaneInner .insertTarget .formItem:first").addClass("listItemHighlight");
					resetAddForms();
					assignDragAssets($("#formsPaneInner .insertTarget"));
					assignFormsKeys();
					$("#formsPaneInner").lovelyScroll();
					saved("New Form Added");
					selectionTools();
					if (currentTooltip) {
						interuptedChains.push({currentTooltip:currentTooltip,currentTooltipItem:currentTooltipItem});
						clearTimeout(toolTipTimeout);
					}
					currentTooltipItem=0;
					currentTooltip="newform";
					toolTipTimeout = setTimeout(tooltip, 450);


				});
			} else {
				error(LangVars.Misc_Error);
			}

		}
		var options = {
	        success:       showResponse  // post-submit callback
	    };

		$(this).ajaxSubmit(options);

		return false;
	});
}
function updateTotalRecips() {
	var Ids = getMailingListSendIds();
	if ($("#newsletterPaneInner .listItemHighlight").length==1) {
		var cats = getMailingListSendCats();
		var matchAll = getMailingListSendMatchAll();
	} else {
		var cats="";
		var matchAll="";
	}

	$("#listSize span").load("newsletterActions.php?newsletterAction=send&groups="+Ids+"&cats="+cats+matchAll+"&page=&subject=&showRecips=true");

}
function bindMailingListSendCategories() {
	$("#onlySendToCatsAll").prop("checked","checked");
	$("#onlySendToCatsAll").unbind().change(function(){
		if ($(this).prop('checked')) {
			$("#sendToCategories input").removeAttr("checked");
			$("#onlySendMatchAll").removeAttr("checked");
		}
		updateTotalRecips();
	});
	$("#sendToCategories input").unbind().change(function(){
		if ($("#sendToCategories input:checked").length) {
			$("#onlySendToCatsAll").removeAttr("checked");
		} else {
			$("#onlySendToCatsAll").prop("checked","checked");
			$("#onlySendMatchAll").removeAttr("checked");
		}
		updateTotalRecips();
	});
	$("#onlySendMatchAll").unbind().change(function(){
		updateTotalRecips();
	});
}
function savePaneToolEditText(text) {
	$("#paneToolEditingText").text(text);
	applyProperties($("#"+$("#paneToolEditingText").data("scope")),$("#paneToolEditingText").data("itemclass"));
	hide_header_menus(true);
	selectionTools();
	cancelDialogue();
}
function prepDialogue (text,primaryText,primaryFun,secondaryText,secondaryFun,primaryImportant,secondaryImportant,textField,editingType,linkBuilder,url,ids,selectingAll,items,updateAttr,prefill) {

	if (justScrolled) {
		return false;
	}
	if (editingType=="yourAccount") {
		text="<h2>"+LangVars.Change_Your_Account+"</h2>";
	}
	
	if (editingType=="mailingListSend") {
		$("#sendToCategories").html("");
		if ($("#newsletterPane .listItemHighlight").length===1) {
			if ($("#newsletterPane .listItemHighlight .groupcat").length) {
				$("#mailingListSentToCategories").show();
				$("#newsletterPane .listItemHighlight .groupcat").each(function(){
				$("#sendToCategories").append('<label><input type="checkbox" value="'+$(this).attr("data-id")+'"/>'+$(this).val()+'</label><br/>');
				});
				$("#sendingToMultipleListsMessage").hide();
			} else {
				$("#mailingListSentToCategories").hide();
				$("#sendingToMultipleListsMessage").hide();
			}


		} else {
			$("#mailingListSentToCategories").hide();
			$("#sendingToMultipleListsMessage").show();
		}
		bindMailingListSendCategories();
		updateTotalRecips();
	}
	$("#popupDialogue input,#popupDialogue textarea").unbind("keyup");

	$("#popupDialogueContent").html(text);
	$("#popupDialogueContent .popupExpand").hide().after("<p class='showMore'>"+LangVars.Show_More+"</p>").after("<p class='showLess'>"+LangVars.Show_Less+"</p>");
	$(".showLess").hide();
	$("#popupDialogueContent .showMore").click(function(){
		$(this).hide();
		$(".showLess").show();
		$(".popupExpand").slideDown();
	});
	$("#popupDialogueContent .showLess").click(function(){
		$(this).hide();
		$(".showMore").show();
		$(".popupExpand").slideUp();
	});
	if (linkBuilder===true) {
		$("#linkOpensInNewWindow,#insertInteralLinks").show();
	} else {
		$("#linkOpensInNewWindow,#insertInteralLinks").hide();
	}
	$("#popupDialogueContentPrimary div").html(primaryText);
	$("#popupDialogueContentSecondary div").html(secondaryText);
	unassignKeys();
	$("#popupDialogueChangeMailingListAutoresponder,#popupDialogueChangeFormAutoresponder,#popupDialogueFieldMailingListSend,#popupDialogueSecurity,#popupDialogueField,#popupDialogueFieldPassword,#popupDialogueFieldPasswordStaff,#popupDialogueFrom,#popupDialogueSMTP,#popupDialogueMailTemplate,#popupDialogueImportSubscribers,#popupDialogueProductVolumeDiscount,#popupDialogueTableData,#popupDialogueImportEvents,#popupDialogueFieldQuickAddImageCategory").hide();
	if (textField) {
		$("#popupDialogueField").show();
		$("#popupDialogueField textarea").val("");
		if (typeof prefill != 'undefined') {
			$("#popupDialogueField textarea").val(prefill);
		}
		if (editingType=="addTable" || editingType=="editTable") {
			$("#showTableExample").click(function(){
				$("#popupDialogueField textarea").val(LangVars.CSV_Example);
				return false;
			});
		}
		if (editingType=="panetoolproperty") {
			$("#popupDialogueField textarea").val($("#paneToolEditingText").text()).select();
		}
		if (editingType=="formRedirectOnSend") {
			$("#popupDialogueField textarea").val($("#iconbarFormRedirectOnSend").text()).select();
		}
		if (editingType=="changeNewsletterCustomField") {
			if ($("#subscriberCustomFields .editingField").text()!=LangVars.None && $("#subscriberCustomFields .editingField").text()!="("+LangVars.Multiple_Selected+")") {
			$("#popupDialogueField textarea").val($("#subscriberCustomFields .editingField").text());
			}
		}
		if (editingType=="editTable") {
			var	editingtarget = $(".bpe_highlight");
			$(".itemTag",editingtarget).remove();
			html2csv(editingtarget.html());
		}
		if (editingType=="quickAddImageCategory") {
			$("#popupDialogueFieldQuickAddImageCategory").show();
		}
		if (editingType=="mailingListSend") {
			$("#popupDialogueMailTemplate .imageContextEditFieldset").addClass("showingLabel");
			$("#popupDialogueMailTemplate .toggleLabelValue").val("");
			$("#popupDialogueField").hide();
			$("#popupDialogueFieldMailingListSend").show();
			if ($("#sendMailingListSubjectInput").val()!="") {
				$("#sendMailingListSubject").removeClass("showingLabel");
			}
			if ($("#order_received_email").val()!="") {
				$("#popupMailTemplateMessage").removeClass("showingLabel");
			}

			$("#popupDialogueFieldMailingListSend .toggleLabelValue").unbind().focus(function(){
				$(this).parents(".imageContextEditFieldset").addClass("focusing");
			});
			$("#popupDialogueFieldMailingListSend .toggleLabelValue").unbind().blur(function(){
				$(this).parents(".imageContextEditFieldset").removeClass("focusing");
			});
			$("#popupDialogueFieldMailingListSend .toggleLabelValue").unbind().keyup(function(e){
				if ($(this).val()!="") {
					$(this).parents(".imageContextEditFieldset").removeClass("showingLabel");
				} else {
					$(this).parents(".imageContextEditFieldset").addClass("showingLabel");
				}
			});
		}
		if (editingType=="formAutoresponder") {

			$("#popupDialogueField").hide();
			$("#popupDialogueChangeFormAutoresponder").show();

			$("#popupDialogueChangeFormAutoresponder .toggleLabelValue").unbind().focus(function(){
				$(this).parents(".imageContextEditFieldset").addClass("focusing");
			});
			$("#popupDialogueChangeFormAutoresponder .toggleLabelValue").unbind().blur(function(){
				$(this).parents(".imageContextEditFieldset").removeClass("focusing");
			});
			$("#popupDialogueChangeFormAutoresponder .toggleLabelValue").unbind().keyup(function(e){
				if ($(this).val()!="") {
					$(this).parents(".imageContextEditFieldset").removeClass("showingLabel");
				} else {
					$(this).parents(".imageContextEditFieldset").addClass("showingLabel");
				}
			});
		}
		if (editingType=="mailingListAutoresponder") {

			$("#popupDialogueField").hide();
			$("#popupDialogueChangeMailingListAutoresponder").show();
			$("#popupDialogueChangeMailingListAutoresponder .toggleLabelValue").unbind().focus(function(){
				$(this).parents(".imageContextEditFieldset").addClass("focusing");
			});
			$("#popupDialogueChangeMailingListAutoresponder .toggleLabelValue").unbind().blur(function(){
				$(this).parents(".imageContextEditFieldset").removeClass("focusing");
			});
			$("#popupDialogueChangeMailingListAutoresponder .toggleLabelValue").unbind().keyup(function(e){
				if ($(this).val()!="") {
					$(this).parents(".imageContextEditFieldset").removeClass("showingLabel");
				} else {
					$(this).parents(".imageContextEditFieldset").addClass("showingLabel");
				}
			});
		}
		if (editingType=="orderReceivedTemplate") {
			$("#popupDialogueMailTemplate .imageContextEditFieldset").addClass("showingLabel");
			$("#popupDialogueMailTemplate .toggleLabelValue").val("");
			$("#popupDialogueField").hide();
			$("#popupDialogueMailTemplate").show();
			if ($("#order_received_email_subject").val()!="") {
				$("#popupMailTemplateSubject").removeClass("showingLabel");
			}
			if ($("#order_received_email").val()!="") {
				$("#popupMailTemplateMessage").removeClass("showingLabel");
			}

			$("#popupDialogueMailTemplate .toggleLabelValue").unbind().focus(function(){
				$(this).parents(".imageContextEditFieldset").addClass("focusing");
			});
			$("#popupDialogueMailTemplate .toggleLabelValue").unbind().blur(function(){
				$(this).parents(".imageContextEditFieldset").removeClass("focusing");
			});
			$("#popupDialogueMailTemplate .toggleLabelValue").unbind().keyup(function(e){
				if ($(this).val()!="") {
					$(this).parents(".imageContextEditFieldset").removeClass("showingLabel");
				} else {
					$(this).parents(".imageContextEditFieldset").addClass("showingLabel");
				}
			});
			$("#popupDialogueMailTemplate input[name=subject]").val($("#order_received_email_subject").val());
			$("#popupDialogueMailTemplate textarea[name=message]").val($("#order_received_email").val());
		}
		if (editingType=="orderDispatchedTemplate") {
			$("#popupDialogueMailTemplate .imageContextEditFieldset").addClass("showingLabel");
			$("#popupDialogueMailTemplate .toggleLabelValue").val("");
			$("#popupDialogueField").hide();
			$("#popupDialogueMailTemplate").show();

			if ($("#order_sent_email_subject").val()!="") {
				$("#popupMailTemplateSubject").removeClass("showingLabel");
			}
			if ($("#order_sent_email").val()!="") {
				$("#popupMailTemplateMessage").removeClass("showingLabel");
			}

			$("#popupDialogueMailTemplate .toggleLabelValue").unbind().focus(function(){
				$(this).parents(".imageContextEditFieldset").addClass("focusing");
			});
			$("#popupDialogueMailTemplate .toggleLabelValue").unbind().blur(function(){
				$(this).parents(".imageContextEditFieldset").removeClass("focusing");
			});
			$("#popupDialogueMailTemplate .toggleLabelValue").unbind().keyup(function(e){
				if ($(this).val()!="") {
					$(this).parents(".imageContextEditFieldset").removeClass("showingLabel");
				} else {
					$(this).parents(".imageContextEditFieldset").addClass("showingLabel");
				}
			});
			$("#popupDialogueMailTemplate input[name=subject]").val($("#order_sent_email_subject").val());
			$("#popupDialogueMailTemplate textarea[name=message]").val($("#order_sent_email").val());
		}
		if (editingType=="yourAccount") {
			$("#popupDialogueFieldPassword .imageContextEditFieldset").addClass("showingLabel");
			$("#popupDialogueFieldPassword .toggleLabelValue").val("");
			$("#popupDialogueField").hide();
			$("#popupDialogueFieldPassword").show();
			$("#popupDialogueFieldPassword .toggleLabelValue").unbind().focus(function(){
				$(this).parents(".imageContextEditFieldset").addClass("focusing");
			});
			$("#popupDialogueFieldPassword .toggleLabelValue").unbind().blur(function(){
				$(this).parents(".imageContextEditFieldset").removeClass("focusing");
			});
			$("#popupDialogueFieldPassword .toggleLabelValue").unbind().keyup(function(e){
				if ($(this).val()!="") {
					$(this).parents(".imageContextEditFieldset").removeClass("showingLabel");
				} else {
					$(this).parents(".imageContextEditFieldset").addClass("showingLabel");
				}
			});
		}
		if (editingType=="resetStaffPass") {

			$("#popupDialogueFieldPasswordStaff .imageContextEditFieldset").addClass("showingLabel");
			$("#popupDialogueFieldPasswordStaff .toggleLabelValue").val("");
			$("#popupDialogueField").hide();
			$("#popupDialogueFieldPasswordStaff").show();
			$("#popupDialogueFieldPasswordStaff .toggleLabelValue").unbind().focus(function(){
				$(this).parents(".imageContextEditFieldset").addClass("focusing");
			});
			$("#popupDialogueFieldPasswordStaff .toggleLabelValue").unbind().blur(function(){
				$(this).parents(".imageContextEditFieldset").removeClass("focusing");
			});
			$("#popupDialogueFieldPasswordStaff .toggleLabelValue").unbind().keyup(function(e){
				if ($(this).val()!="") {
					$(this).parents(".imageContextEditFieldset").removeClass("showingLabel");
				} else {
					$(this).parents(".imageContextEditFieldset").addClass("showingLabel");
				}
			});
		}
		if (editingType=="newsletterFrom") {
			$("#popupDialogueField").hide();
			$("#popupDialogueFrom").show();
			$("#popupDialogueFrom .toggleLabelValue").val("");
			$("#popupDialogueFrom .imageContextEditFieldset").addClass("showingLabel");


			if ($("#newsletterFromSetting").attr("mailing-list-from-name")!="") {
				$("#popupFromName").removeClass("showingLabel");
			}
			if ($("#newsletterFromSetting").attr("mailing-list-from-email")!="") {
				$("#popupFromEmail").removeClass("showingLabel");
			}

			$("#popupDialogueFrom .toggleLabelValue").unbind().focus(function(){
				$(this).parents(".imageContextEditFieldset").addClass("focusing");
			});
			$("#popupDialogueFrom .toggleLabelValue").unbind().blur(function(){
				$(this).parents(".imageContextEditFieldset").removeClass("focusing");
			});
			$("#popupDialogueFrom .toggleLabelValue").unbind().keyup(function(e){
				if ($(this).val()!="") {
					$(this).parents(".imageContextEditFieldset").removeClass("showingLabel");
				} else {
					$(this).parents(".imageContextEditFieldset").addClass("showingLabel");
				}
			});
			$("#popupDialogueFrom input[name=from_name]").val($("#newsletterFromSetting").attr("mailing-list-from-name"));
			$("#popupDialogueFrom input[name=from_email]").val($("#newsletterFromSetting").attr("mailing-list-from-email"));

		}
		if (editingType=="newsletterSMTP") {
			$("#popupDialogueSMTP .imageContextEditFieldset").addClass("showingLabel");
			$("#popupDialogueSMTP .toggleLabelValue").val("");
			$("#popupDialogueField").hide();
			$("#popupDialogueSMTP").show();
			if ($("#newsletterSMTPSetting").attr("mailing-list-server")!="") {
				$("#popupSMTPServer").removeClass("showingLabel");
			}
			if ($("#newsletterSMTPSetting").attr("mailing-list-username")!="") {
				$("#popupSMTPUsername").removeClass("showingLabel");
			}
			if ($("#newsletterSMTPSetting").attr("mailing-list-password")!="") {
				$("#popupSMTPPassword").removeClass("showingLabel");
			}

			$("#popupDialogueSMTP .toggleLabelValue").unbind().focus(function(){
				$(this).parents(".imageContextEditFieldset").addClass("focusing");
			});
			$("#popupDialogueSMTP .toggleLabelValue").unbind().blur(function(){
				$(this).parents(".imageContextEditFieldset").removeClass("focusing");
			});
			$("#popupDialogueSMTP .toggleLabelValue").unbind().keyup(function(e){
				if ($(this).val()!="") {
					$(this).parents(".imageContextEditFieldset").removeClass("showingLabel");
				} else {
					$(this).parents(".imageContextEditFieldset").addClass("showingLabel");
				}
			});
			$("#popupDialogueSMTP input[name=smtp_server]").val($("#newsletterSMTPSetting").attr("mailing-list-server"));
			$("#newsletterSMTPSetting .value").attr("title",$("#newsletterSMTPSetting").attr("mailing-list-server"));
			$("#newsletterSMTPSetting .value span").text($("#newsletterSMTPSetting").attr("mailing-list-server"));
			$("#popupDialogueSMTP input[name=smtp_username]").val($("#newsletterSMTPSetting").attr("mailing-list-username"));
			$("#popupDialogueSMTP input[name=smtp_password]").val($("#newsletterSMTPSetting").attr("mailing-list-password"));
		}
		if (editingType=="pagesSecurity") {
			$("#popupDialogueSecurity .imageContextEditFieldset").addClass("showingLabel");
			$("#popupDialogueSecurity .toggleLabelValue").val("");
			$("#popupDialogueField").hide();
			$("#popupDialogueSecurity").show();

			$("#popupDialogueSecurity .toggleLabelValue").unbind().focus(function(){
				$(this).parents(".imageContextEditFieldset").addClass("focusing");
			});
			$("#popupDialogueSecurity .toggleLabelValue").unbind().blur(function(){
				$(this).parents(".imageContextEditFieldset").removeClass("focusing");
			});
			$("#popupDialogueSecurity .toggleLabelValue").unbind().keyup(function(e){
				if ($(this).val()!="") {
					$(this).parents(".imageContextEditFieldset").removeClass("showingLabel");
				} else {
					$(this).parents(".imageContextEditFieldset").addClass("showingLabel");
				}
			});
		}
		if (editingType=="checkoutFrom") {
			$("#popupDialogueFrom .imageContextEditFieldset").addClass("showingLabel");
			$("#popupDialogueFrom .toggleLabelValue").val("");
			$("#popupDialogueField").hide();
			$("#popupDialogueFrom").show();
			if ($("#checkoutFromSetting").attr("checkout-from-name")!="") {
				$("#popupFromName").removeClass("showingLabel");
			}
			if ($("#checkoutFromSetting").attr("checkout-from-email")!="") {
				$("#popupFromEmail").removeClass("showingLabel");
			}

			$("#popupDialogueFrom .toggleLabelValue").unbind().focus(function(){
				$(this).parents(".imageContextEditFieldset").addClass("focusing");
			});
			$("#popupDialogueFrom .toggleLabelValue").unbind().blur(function(){
				$(this).parents(".imageContextEditFieldset").removeClass("focusing");
			});
			$("#popupDialogueFrom .toggleLabelValue").unbind().keyup(function(e){
				if ($(this).val()!="") {
					$(this).parents(".imageContextEditFieldset").removeClass("showingLabel");
				} else {
					$(this).parents(".imageContextEditFieldset").addClass("showingLabel");
				}
			});
			$("#popupDialogueFrom input[name=from_name]").val($("#checkoutFromSetting").attr("checkout-from-name"));
			$("#popupDialogueFrom input[name=from_email]").val($("#checkoutFromSetting").attr("checkout-from-email"));
		}
		if (editingType=="checkoutSMTP") {
			$("#popupDialogueSMTP .imageContextEditFieldset").addClass("showingLabel");
			$("#popupDialogueSMTP .toggleLabelValue").val("");
			$("#popupDialogueField").hide();
			$("#popupDialogueSMTP").show();
			if ($("#checkoutSMTPSetting").attr("checkout-server")!="") {
				$("#popupSMTPServer").removeClass("showingLabel");
			}
			if ($("#checkoutSMTPSetting").attr("checkout-username")!="") {
				$("#popupSMTPUsername").removeClass("showingLabel");
			}
			if ($("#checkoutSMTPSetting").attr("checkout-password")!="") {
				$("#popupSMTPPassword").removeClass("showingLabel");
			}

			$("#popupDialogueSMTP .toggleLabelValue").unbind().focus(function(){
				$(this).parents(".imageContextEditFieldset").addClass("focusing");
			});
			$("#popupDialogueSMTP .toggleLabelValue").unbind().blur(function(){
				$(this).parents(".imageContextEditFieldset").removeClass("focusing");
			});
			$("#popupDialogueSMTP .toggleLabelValue").unbind().keyup(function(e){
				if ($(this).val()!="") {
					$(this).parents(".imageContextEditFieldset").removeClass("showingLabel");
				} else {
					$(this).parents(".imageContextEditFieldset").addClass("showingLabel");
				}
			});
			$("#popupDialogueSMTP input[name=smtp_server]").val($("#checkoutSMTPSetting").attr("checkout-server"));
			$("#popupDialogueSMTP input[name=smtp_username]").val($("#checkoutSMTPSetting").attr("checkout-username"));
			$("#popupDialogueSMTP input[name=smtp_password]").val($("#checkoutSMTPSetting").attr("checkout-password"));
		}
		if (editingType=="newsletterImport") {
			$("#popupDialogueImportSubscribers .imageContextEditFieldset").addClass("showingLabel");
			$("#popupDialogueImportSubscribers .toggleLabelValue").val("");
			$("#popupDialogueField").hide();
			$("#popupDialogueImportSubscribers").show();
			$("#popupDialogueImportSubscribers .toggleLabelValue").unbind().focus(function(){
				$(this).parents(".imageContextEditFieldset").addClass("focus");
			});
			$("#popupDialogueImportSubscribers .toggleLabelValue").unbind().blur(function(){
				$(this).parents(".imageContextEditFieldset").removeClass("focus");
			});
			$("#popupDialogueImportSubscribers .toggleLabelValue").unbind().keyup(function(e){
				if ($(this).val()!="") {
					$(this).parents(".imageContextEditFieldset").removeClass("showingLabel");
				} else {
					$(this).parents(".imageContextEditFieldset").addClass("showingLabel");
				}
			});
		}
		if (editingType=="eventsImport") {
			$("#popupDialogueImportEvents .imageContextEditFieldset").addClass("showingLabel");
			$("#popupDialogueImportEvents .toggleLabelValue").val("");
			$("#popupDialogueField").hide();
			$("#popupDialogueImportEvents").show();
			$("#popupDialogueImportEvents .toggleLabelValue").unbind().focus(function(){
				$(this).parents(".imageContextEditFieldset").addClass("focus");
			});
			$("#popupDialogueImportEvents .toggleLabelValue").unbind().blur(function(){
				$(this).parents(".imageContextEditFieldset").removeClass("focus");
			});
			$("#popupDialogueImportEvents .toggleLabelValue").unbind().keyup(function(e){
				if ($(this).val()!="") {
					$(this).parents(".imageContextEditFieldset").removeClass("showingLabel");
				} else {
					$(this).parents(".imageContextEditFieldset").addClass("showingLabel");
				}
			});
		}
		if (editingType=="tableData") {

			$("#popupDialogueTableData .imageContextEditFieldset").addClass("showingLabel");
			$("#popupDialogueTableData .toggleLabelValue").val("");
			$("#popupDialogueField").hide();
			$("#popupDialogueTableData").show();
			$("#popupDialogueTableData textarea").val($("#tablesPane .listItemHighlight").data('csv')).select();
			$("#popupDialogueTableData .toggleLabelValue").unbind().focus(function(){
				$(this).parents(".imageContextEditFieldset").addClass("focus");
			});
			$("#popupDialogueTableData .toggleLabelValue").unbind().blur(function(){
				$(this).parents(".imageContextEditFieldset").removeClass("focus");
			});
			$("#popupDialogueTableData .toggleLabelValue").unbind().keyup(function(e){
				if ($(this).val()!="") {
					$(this).parents(".imageContextEditFieldset").removeClass("showingLabel");
				} else {
					$(this).parents(".imageContextEditFieldset").addClass("showingLabel");
				}
			}).trigger("keyup");
		}

		function volumeDiscount(no) {
			$("#popupDialogueProductVolumeDiscount .imageContextEditFieldset").addClass("showingLabel");
			$("#popupDialogueProductVolumeDiscount .toggleLabelValue").val("");
			$("#popupDialogueField").hide();
			$("#popupDialogueProductVolumeDiscount").show();
			if ($("#rightPaneProductOptions:visible").length ) {
				var scope = 'rightPaneProductOptions';
			} else {
				var scope = 'rightPaneProducts';
			}

			var firstVal=$("#"+scope+" .listItemHighlight:first").attr('data-discount-'+no+'-price');

			var allTheSame=true;
			$("#"+scope+" .listItemHighlight").each(function(){
				if ($(this).attr('data-discount-'+no+'-price')!=firstVal) {
					allTheSame=false;
				}
			});
			if (allTheSame) {
				if (firstVal!='0.00') {
					$("#popupVolumeDiscountPrice input").val(firstVal);
					$("#popupVolumeDiscountPrice").removeClass("showingLabel");
				}

			} else {
				$("#popupVolumeDiscountPrice input").val("("+LangVars.Multiple_Selected+")");
			}

			var firstVal=$("#"+scope+" .listItemHighlight:first").attr('data-discount-'+no+'-threshold');
			var allTheSame=true;
			$("#"+scope+" .listItemHighlight").each(function(){
				if ($(this).attr('data-discount-'+no+'-threshold')!=firstVal) {
					allTheSame=false;
				}
			});
			if (allTheSame) {
				if (firstVal!='0') {
				$("#popupVolumeDiscountThreshold input").val(firstVal);
				$("#popupVolumeDiscountThreshold").removeClass("showingLabel");
				}
			} else {
				$("#popupVolumeDiscountThreshold input").val("("+LangVars.Multiple_Selected+")");
			}


			$("#popupDialogueProductVolumeDiscount .toggleLabelValue").unbind().focus(function(){
				$(this).parents(".imageContextEditFieldset").addClass("focusing");
			});
			setTimeout(function () {
			$("#popupDialogueProductVolumeDiscount .toggleLabelValue:first").focus();
			}, 10);

			$("#popupDialogueProductVolumeDiscount .toggleLabelValue").unbind().blur(function(){
				$(this).parents(".imageContextEditFieldset").removeClass("focusing");
			});
			$("#popupDialogueProductVolumeDiscount .toggleLabelValue").unbind().keyup(function(e){
				if ($(this).val()!="") {
					$(this).parents(".imageContextEditFieldset").removeClass("showingLabel");
				} else {
					$(this).parents(".imageContextEditFieldset").addClass("showingLabel");
				}
			});
		}
		if (editingType=="productVolume1Discount") {
			volumeDiscount('1');
		}
		if (editingType=="productVolume2Discount") {
			volumeDiscount('2');
		}


		$(document).unbind("keyup");
		$(document).unbind("keypress");
		$(document).unbind("keydown");

		if (editingType=="formDestination") {
			var firstDest=$("#rightPaneForms .listItemHighlight:first").attr("data-destination");
			var allTheSame=true;
			$("#rightPaneForms .listItemHighlight").each(function(){
				if ($(this).attr("data-destination")!=firstDest) {
					allTheSame=false;
				}
			});
			if (allTheSame) {
				$("#popupDialogueField textarea").val(firstDest);
			} else {
				$("#popupDialogueField textarea").val("("+LangVars.Multiple_Selected+")");
			}
		}
		if (editingType=="formAutoresponder") {
			var firstDest=$("#rightPaneForms .listItemHighlight:first").attr("data-autoresponder-title");
			$("#formAutoresponderSubjectInput").val("");
			$("#selectedFormAutoresponderPage").attr("page-id","0");
			$("#changeFormAutoresponderContent").addClass("empty");
			$("#selectedFormAutoresponderPage").text(LangVars.Choose_page);
			$("#formAutoresponderSubjectInput").parents(".imageContextEditFieldset").addClass("showingLabel");

			if (firstDest!=""){
				var allTheSame=true;
				$("#rightPaneForms .listItemHighlight").each(function(){
					if ($(this).attr("data-autoresponder-title")!=firstDest) {
						allTheSame=false;
					}
				});
				if (allTheSame) {
					$("#changeFormAutoresponderContent").removeClass("empty");
					$("#selectedFormAutoresponderPage").text(firstDest);
					$("#selectedFormAutoresponderPage").attr("page-id",$("#rightPaneForms .listItemHighlight:first").attr("data-autoresponder-id"));
				} else {
					$("#selectedFormAutoresponderPage").val("("+LangVars.Multiple_Selected+")");
				}
				var firstDest=$("#rightPaneForms .listItemHighlight:first").attr("data-autoresponder-subject");
				var allTheSame=true;
				$("#rightPaneForms .listItemHighlight").each(function(){
					if ($(this).attr("data-autoresponder-subject")!=firstDest) {
						allTheSame=false;
					}
				});
				$("#formAutoresponderSubjectInput").parents(".imageContextEditFieldset").removeClass("showingLabel");
				if (allTheSame) {
					$("#formAutoresponderSubjectInput").val(firstDest);
				} else {
					$("#formAutoresponderSubjectInput").val("("+LangVars.Multiple_Selected+")");
				}
			}

		}
		if (editingType=="mailingListAutoresponder") {
			var firstDest=$("#newsletterPaneInner .listItemHighlight:first").attr("data-autoresponder-title");
			$("#mailingListAutoresponderSubjectInput").val("");
			$("#selectedMailingListAutoresponderPage").attr("page-id","0");
			$("#changeMailingListAutoresponderContent").addClass("empty");
			$("#selectedMailingListAutoresponderPage").text(LangVars.Choose_page);
			$("#mailingListAutoresponderSubjectInput").parents(".imageContextEditFieldset").addClass("showingLabel");

			if (firstDest!=""){
				var allTheSame=true;
				$("#newsletterPaneInner .listItemHighlight").each(function(){
					if ($(this).attr("data-autoresponder-title")!=firstDest) {
						allTheSame=false;
					}
				});
				if (allTheSame) {
					$("#changeMailingListAutoresponderContent").removeClass("empty");
					$("#selectedMailingListAutoresponderPage").text(firstDest);
					$("#selectedMailingListAutoresponderPage").attr("page-id",$("#newsletterPaneInner .listItemHighlight:first").attr("data-autoresponder-id"));
				} else {
					$("#selectedMailingListAutoresponderPage").val("("+LangVars.Multiple_Selected+")");
				}
				var firstDest=$("#newsletterPaneInner .listItemHighlight:first").attr("data-autoresponder-subject");
				var allTheSame=true;
				$("#newsletterPaneInner .listItemHighlight").each(function(){
					if ($(this).attr("data-autoresponder-subject")!=firstDest) {
						allTheSame=false;
					}
				});
				$("#mailingListAutoresponderSubjectInput").parents(".imageContextEditFieldset").removeClass("showingLabel");
				if (allTheSame) {
					$("#mailingListAutoresponderSubjectInput").val(firstDest);
				} else {
					$("#mailingListAutoresponderSubjectInput").val("("+LangVars.Multiple_Selected+")");
				}
			}

		}
		if (editingType=="productPrice") {
			var firstDest=$("#rightPaneProducts .listItemHighlight:first").attr("product-price");
			var allTheSame=true;
			$("#rightPaneProducts .listItemHighlight").each(function(){
				if ($(this).attr("product-price")!=firstDest) {
					allTheSame=false;
				}
			});
			if (allTheSame) {
				$("#popupDialogueField textarea").val(firstDest);
			} else {
				$("#popupDialogueField textarea").val("("+LangVars.Multiple_Selected+")");
			}
		}
		if (editingType=="productOptionPrice") {
			var firstDest=$("#rightPaneProductOptions .listItemHighlight:first .productOptionPrice").text();
			var allTheSame=true;
			$("#rightPaneProductOptions .listItemHighlight .productOptionPrice").each(function(){
				if ($(this).text()!=firstDest) {
					allTheSame=false;
				}
			});
			if (allTheSame) {
				$("#popupDialogueField textarea").val(firstDest);
			} else {
				$("#popupDialogueField textarea").val("("+LangVars.Multiple_Selected+")");
			}
		}
		if (editingType=="productStock") {
			var firstDest=$("#rightPaneProducts .listItemHighlight:first").attr("product-stock");
			var allTheSame=true;
			$("#rightPaneProducts .listItemHighlight").each(function(){
				if ($(this).attr("product-stock")!=firstDest) {
					allTheSame=false;
				}
			});
			if (allTheSame) {
				$("#popupDialogueField textarea").val(firstDest);
			} else {
				$("#popupDialogueField textarea").val("("+LangVars.Multiple_Selected+")");
			}
		}
		if (editingType=="productOptionStock") {
			var firstDest=$("#rightPaneProductOptions .listItemHighlight:first").attr("product-option-stock");
			var allTheSame=true;
			$("#rightPaneProductOptions .listItemHighlight").each(function(){
				if ($(this).attr("product-option-stock")!=firstDest) {
					allTheSame=false;
				}
			});
			if (allTheSame) {
				$("#popupDialogueField textarea").val(firstDest);
			} else {
				$("#popupDialogueField textarea").val("("+LangVars.Multiple_Selected+")");
			}
		}
		if (editingType=="productWeight") {
			var firstDest=$("#rightPaneProducts .listItemHighlight:first").attr("product-weight");
			var allTheSame=true;
			$("#rightPaneProducts .listItemHighlight").each(function(){
				if ($(this).attr("product-weight")!=firstDest) {
					allTheSame=false;
				}
			});
			if (allTheSame) {
				$("#popupDialogueField textarea").val(firstDest);
			} else {
				$("#popupDialogueField textarea").val("("+LangVars.Multiple_Selected+")");
			}
		}
		if (editingType=="newsletterSubject") {

			$("#popupDialogueField textarea").val($("#changeMailingListSubject").attr("title"));

		}
		if (editingType=="commentNotification") {

			$("#popupDialogueField textarea").val($("#changeCommentNotificationEmail").attr("value"));

		}
		if (editingType=="secretPass") {

			$("#popupDialogueField textarea").val($("#changeSecretPass").attr("value"));

		}
		if (editingType=="articlesPerPage") {
			$("#popupDialogueField textarea").val($("#changeArticlePerPage .value").attr("title"));
		}
		if (editingType=="paypalEmail") {
			$("#popupDialogueField textarea").val($("#changePayPalEmail .value").attr("title"));
		}
		if (editingType=="merchantID") {
			$("#popupDialogueField textarea").val($("#changeMerchantID .value").attr("title"));
		}
		if (editingType=="livechatMessage") {
			$("#popupDialogueField textarea").val($("#livechatMessage .value .overflowEllipsis").html());
		}
		if (editingType=="livechatName") {
			$("#popupDialogueField textarea").val($("#livechatName .value .overflowEllipsis").html());
		}
		if (editingType=="themeOption") {
			$("#popupDialogueField textarea").val($("#themeOptions .themeOptionText.editing").attr("theme-var-value"));
		}

		if (editingType=="metaTitle") {
			$("#popupDialogueField textarea").val($("#editMetaTitle").attr("meta-title"));
		}
		if (editingType=="metaDescription") {
			$("#popupDialogueField textarea").val($("#editMetaDescription").attr("meta-description"));
		}
		if (editingType=="metaKeywords") {
			$("#popupDialogueField textarea").val($("#editMetaKeywords").attr("meta-keywords"));
		}
		if (editingType=="metaTitleBlog") {
			$("#popupDialogueField textarea").val($("#editMetaTitleBlog").attr("meta-title"));
		}
		if (editingType=="metaDescriptionBlog") {
			$("#popupDialogueField textarea").val($("#editMetaDescriptionBlog").attr("meta-description"));
		}
		if (editingType=="metaKeywordsBlog") {
			$("#popupDialogueField textarea").val($("#editMetaKeywordsBlog").attr("meta-keywords"));
		}
		if (editingType=="blogTags") {
			$("#popupDialogueField textarea").val($("#editBlogTags").attr("meta-tags"));
		}
		if (editingType=="blogDate") {
			$("#popupDialogueField textarea").val($("#editBlogDate").attr("meta-date"));
		}
		if (editingType=="pageRedirecting") {

			$("#popupDialogueField textarea").val($("#adminPages .editPageBar.listItemHighlight").attr("data-redirect-url"));
		}
		if (editingType=="tableData") {

			$("#popupDialogueField textarea").val($("#tablesPane .listItemHighlight").attr("data-csv"));
		}
	}
	$("#popupDialogueContentPrimary").hide();
	$("#popupDialogueContentSecondary").hide();
	if (primaryText) {
		$("#popupDialogueContentPrimary").show();
	}
	if (secondaryText) {
		$("#popupDialogueContentSecondary").show();
	}
	$("#popupDialogueContentPrimary").unbind().mousedown(function(){
		if (textField) {
			if (editingType=="youtAccount")
			{
				primaryFun($("#popupDialogueFieldPassword input[name=email]").val(),$("#popupDialogueFieldPassword input[name=old_password]").val(),$("#popupDialogueFieldPassword input[name=password]").val(),$("#popupDialogueFieldPassword input[name=password2]").val());
			}
			else if (editingType=="newsletterFrom" || editingType=="checkoutFrom" )
			{
				primaryFun($("#popupDialogueFrom input[name=from_name]").val(),$("#popupDialogueFrom input[name=from_email]").val());
			}
			else if (editingType=="newsletterSMTP" || editingType=="checkoutSMTP")
			{
				primaryFun($("#popupDialogueSMTP input[name=smtp_server]").val(),$("#popupDialogueSMTP input[name=smtp_username]").val(),$("#popupDialogueSMTP input[name=smtp_password]").val());
			}

			else if (editingType=="orderReceivedTemplate" || editingType=="orderDispatchedTemplate")
			{
				primaryFun($("#popupDialogueMailTemplate input[name=subject]").val(),$("#popupDialogueMailTemplate textarea[name=message]").val());
			}

			else {
				primaryFun($("#popupDialogueField textarea").val());
			}
		} else {
			primaryFun();
		}
		return false;
	});

	$("#popupDialogueContentSecondary").unbind().click(function(){
		if (textField) {

			if (editingType=="yourAccount") {
				secondaryFun($("#popupDialogueFieldPassword input[name=email]").val(),$("#popupDialogueFieldPassword input[name=old_password]").val(),$("#popupDialogueFieldPassword input[name=password]").val(),$("#popupDialogueFieldPassword input[name=password2]").val());
			} else if (editingType=="resetStaffPass") {
				secondaryFun($("#popupDialogueFieldPasswordStaff input[name=password]").val(),$("#popupDialogueFieldPasswordStaff input[name=password2]").val());
				
			} else if (editingType=="newsletterFrom" || editingType=="checkoutFrom") {
				secondaryFun($("#popupDialogueFrom input[name=from_name]").val(),$("#popupDialogueFrom input[name=from_email]").val());
			} else if (editingType=="newsletterSMTP" || editingType=="checkoutSMTP") {
				secondaryFun($("#popupDialogueSMTP input[name=smtp_server]").val(),$("#popupDialogueSMTP input[name=smtp_username]").val(),$("#popupDialogueSMTP input[name=smtp_password]").val());
			} else if (editingType=="orderReceivedTemplate" || editingType=="orderDispatchedTemplate")
			{
				secondaryFun($("#popupDialogueMailTemplate input[name=subject]").val(),$("#popupDialogueMailTemplate textarea[name=message]").val());
			}
			else if (editingType=="pagesSecurity")
			{
				secondaryFun($("#popupDialogueSecurity input[name=username]").val(),$("#popupDialogueSecurity input[name=password]").val(),$("#popupDialogueSecurity input[name=password2]").val());
			}
			else if (editingType=="newsletterImport")
			{
				secondaryFun($("#popupDialogueImportSubscribers textarea").val());
			}
			else if (editingType=="eventsImport")
			{
				secondaryFun($("#popupDialogueImportEvents textarea").val());
			}
			
			else {
				if (secondaryFun) {
					secondaryFun($("#popupDialogueField textarea").val());					
				} else {
					working();

					var page = url.split("?");
					var data = page[1];

					$.ajax({
					  type: "POST",
					  url: page[0],
					  data: data+"&text="+encodeURIComponent($("#popupDialogueField textarea").val())+"&ids="+ids+selectingAll,
					  success: function(msg){
				if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
						$(items+".listItemHighlight").each(function(){
							$(this).attr(updateAttr,$("#popupDialogueField textarea").val());
						});
						selectionTools();
						cancelDialogue();
						saved();
						livepreview();
					  }
					});
					
				}

			}
		} else {
			secondaryFun();
		}
		return false;
	});
	$(".popupDialogueImportant").removeClass("popupDialogueImportant");
	if (primaryImportant) {
		$("#popupDialogueContentPrimary").addClass("popupDialogueImportant");
	}
	if (secondaryImportant) {
		$("#popupDialogueContentSecondary").addClass("popupDialogueImportant");
	}
	$("#popupDialogueWrap").css("top",-300);
	if ($("body").hasClass("unlicensed")) {
	$("#popupDialogueWrap").animate({top:20},400);
	} else {
	$("#popupDialogueWrap").animate({top:0},400);
	}

	$("#popupDialogue").fadeIn(400,function(){
		if (textField) {
			$("#popupDialogueField textarea,#popupDialogueFieldMailingListSend textarea,#popupDialogueMailTemplate textarea,#popupDialogueImportSubscribers textarea,#popupDialogueTableData textarea").autosize(function(){
				$("#popupDialogueInner").lovelyScrollContents();
			});
			$("#popupDialogueField textarea,#popupDialogueFieldMailingListSend textarea,#popupDialogueMailTemplate textarea,#popupDialogueImportSubscribers textarea,#popupDialogueTableData textarea").trigger("autosize.resize");
			$("#popupDialogueField:first textarea,#popupDialogueImportSubscribers textarea,#popupDialogueTableData textarea").focus();
			$("#popupDialogueFieldPassword input:first,#popupDialogueFrom input:first,#popupDialogueSMTP input:first,#popupDialogueSecurity input:first,#popupDialogueMailTemplate input:first").focus();

		}
	});
	$("#popupDialogue").click(function(e){
		e.stopPropagation();
	});
	$(document).keydown(function (e) {
		if ((e.keyCode==13 && editingType!="tableData" && editingType!="productSerialNumber" && editingType!="changeNewsletterCustomField" && editingType!="editTable" && editingType!="addTable" && editingType!="mailingListSend" && editingType!="orderReceivedTemplate" && editingType!="orderDispatchedTemplate" && editingType!="newsletterImport" && editingType!="eventsImport" && editingType!="themeOption") || (e.keyCode==13 && e.ctrlKey)) {
			return false;
		}
	});
	$(document).keyup(function (e) {
		if (e.keyCode==27) {
			cancelDialogue();
		}
	});
	if (linkBuilder) {
		var enterBinder = $("#popupDialogue input,#popupDialogue textarea");
	} else {
		var enterBinder = $(document);
	}
	enterBinder.keyup(function (e) {
		if ((e.keyCode==13 && editingType!="tableData" && editingType!="productSerialNumber" && editingType!="changeNewsletterCustomField" && editingType!="editTable" && editingType!="addTable" && editingType!="mailingListSend" && editingType!="orderReceivedTemplate" && editingType!="orderDispatchedTemplate" && editingType!="newsletterImport" && editingType!="eventsImport" && editingType!="themeOption") || (e.keyCode==13 && e.ctrlKey)) {
//			$("#popupDialogueContentSecondary").trigger("click");
			
			if (primaryImportant) {
				$("#popupDialogueContentPrimary").trigger("click");
				/*
				if (textField) {
					if (editingType=="paneToolsPrimary") {
						primaryFun($("#popupDialogueFieldPassword input[name=email]").val(),$("#popupDialogueFieldPassword input[name=old_password]").val(),$("#popupDialogueFieldPassword input[name=password]").val(),$("#popupDialogueFieldPassword input[name=password2]").val());
					} else if (editingType=="newsletterFrom" || editingType=="checkoutFrom") {
						primaryFun($("#popupDialogueFrom input[name=from_name]").val(),$("#popupDialogueFrom input[name=from_email]").val());
					} else if (editingType=="newsletterSMTP" || editingType=="checkoutSMTP") {
						primaryFun($("#popupDialogueSMTP input[name=smtp_server]").val(),$("#popupDialogueSMTP input[name=smtp_username]").val(),$("#popupDialogueSMTP input[name=smtp_password]").val());

					} else {
						primaryFun($("#popupDialogueField textarea").val());
					}
				} else {
					primaryFun();
				}
				*/
			} else if (secondaryImportant) {
				$("#popupDialogueContentSecondary").trigger("click");
				/*
				if (textField) {
					if (editingType=="yourAccount") {
						secondaryFun($("#popupDialogueFieldPassword input[name=email]").val(),$("#popupDialogueFieldPassword input[name=old_password]").val(),$("#popupDialogueFieldPassword input[name=password]").val(),$("#popupDialogueFieldPassword input[name=password2]").val());
					} else if (editingType=="newsletterFrom" || editingType=="checkoutFrom") {
						secondaryFun($("#popupDialogueFrom input[name=from_name]").val(),$("#popupDialogueFrom input[name=from_email]").val());
					} else if (editingType=="newsletterSMTP" || editingType=="checkoutSMTP") {
						secondaryFun($("#popupDialogueSMTP input[name=smtp_server]").val(),$("#popupDialogueSMTP input[name=smtp_username]").val(),$("#popupDialogueSMTP input[name=smtp_password]").val());
					} else if (editingType=="pagesSecurity") {
						secondaryFun($("#popupDialogueSecurity input[name=username]").val(),$("#popupDialogueSecurity input[name=password]").val(),$("#popupDialogueSecurity input[name=password2]").val());
					} else {
						secondaryFun($("#popupDialogueField textarea").val());
					}
				} else {
					secondaryFun();
				}
				*/
			}
			return false
		}
	});

	$("#popupDialogueInner").lovelyScroll();
}
function cancelDialogue () {
	$("#popupDialogue").fadeOut(400);
	$("#popupDialogueWrap").animate({top:-300},400);
	$("#themeOptions .themeOptionText.editing").removeClass("editing");

	/*if ($("#settingsFlyinMask:visible").length) {

 		unassignKeys();
 		$(document).unbind("click");
		$(document).click(function(){
			if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
			hide_menus();
		});
		return false;
	}
	$(document).unbind("click");
	$(document).click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		hide_menus();
	});*/

	if ($("body").attr("pane")=="mainMenuPages"||$("body").attr("pane")=="nonMenuPages") {
		$("#deletedPagesMenu .toRestore").removeClass("toRestore");
		assignPages();
		assign_page_filter();
	}
	if ($("body").attr("pane")=="editContent") {
		if ( $("#bpe_area .textareaWrapper.bpe_highlight").length) {
			assignAddTextKeysAndClick();

		} else {

			if ($(".bpe_highlight.bpe_table").length && $(".bpe_highlight.bpe_table").html()=="") {
				$(".bpe_highlight.bpe_table").remove();
				$.fn.bpeditor.clean(true);
			}

			hide_menus();
			assignSaveListener();
		}
	}

	if ($("body").attr("pane")=="images") {
		assignImagesKeys();
	}
	if ($("body").attr("pane")=="videos") {
		assignVideosKeys();
	}
	if ($("body").attr("pane")=="galleries"&&!$("#rightPaneGalleryImages:visible").length) {
		assignGalleriesKeys();
	}
	if ($("body").attr("pane")=="galleries"&&$("#rightPaneGalleryImages:visible").length) {
		assignGalleryImagesKeys();
	}
	if ($("body").attr("pane")=="forms"&&!$("#rightPaneFormInputs:visible").length) {
		assignFormsKeys();
	}
	if ($("body").attr("pane")=="forms"&&$("#rightPaneFormInputs:visible").length) {
		assignFormInputsKeys();
	}
	if ($("body").attr("pane")=="forms"&&$("#rightPaneFormInputOptions:visible").length) {
		assignFormInputOptionsKeys();
	}
	if ($("body").attr("pane")=="products"&&!$("#rightPaneProductOptions:visible").length) {
		assignProductsKeys();
	}
	if ($("body").attr("pane")=="products"&&$("#rightPaneProductOptions:visible").length) {
		assignProductOptionsKeys();
	}
	if ($("body").attr("pane")=="bookingproducts") {
		assignBookingProductsKeys();
	}
	if ($("body").attr("pane")=="calendars"&&!$("#rightPaneCalendarEvents:visible").length) {
		assignCalendarsKeys();
	}
	if ($("body").attr("pane")=="calendars"&&$("#rightPaneCalendarEvents:visible").length) {
		assignCalendarEventsKeys();
	}
	if ($("body").attr("pane")=="calendars"&&$("#rightPaneEventsGroups:visible").length) {
		assignEventGroupKeys();
	}
	if ($("body").attr("pane")=="snippets") {
		assignSnippetsKeys();
	}
	if ($("body").attr("pane")=="tables") {
		assignTablesKeys();
	}
	if ($("body").attr("pane")=="files") {
		assignFilesKeys();
	}
	if ($("body").attr("pane")=="newsletter"&&!$("#newsletterSubscribersPaneInner:visible").length&&!$("#rightPaneSubscriberCategories:visible").length) {
		assignNewsletterKeys();
	}
	if ($("body").attr("pane")=="newsletter"&&$("#newsletterSubscribersPaneInner:visible").length&&!$("#rightPaneSubscriberCategories:visible").length) {
		assignNewsletterSubscribersKeys();
	}
	if ($("body").attr("pane")=="newsletter"&&!$("#newsletterSubscribersPaneInner:visible").length&&$("#rightPaneSubscriberCategories:visible").length) {
		assignSubscriberCategoriesKeys();
	}
	if ($("body").attr("pane")=="blog"&&!$("#blogAuthorsPaneInner:visible").length) {
		assignBlogKeys();
	}
	if ($("body").attr("pane")=="blog"&&$("#blogAuthorsPaneInner:visible").length) {
		assignBlogAuthorsKeys();
	}
	if ($("body").attr("pane")=="blog"&&$("#blogCategoriesPaneInner:visible").length) {
		assignBlogCategoriesKeys();
	}
	if ($("body").attr("pane")=="blog"&&$("#blogCommentsPaneInner:visible").length) {
		assignBlogCommentsKeys();
	}
	if ($("body").attr("pane")=="livechat") {
		assignLivechatKeys();
	}
	if ($("body").attr("pane")=="staff") {
		assignStaffKeys();
	}
	if ($("body").attr("pane")=="embedCodes") {
		assignEmbedCodesKeys();
	}
	if ($("body").attr("pane")=="mainMenuPages"||$("body").attr("pane")=="nonMenuPages") {
		assignPagesKeys();
	}
	if ($("body").attr("pane")=="checkout") {
		assignCheckoutKeys();
	}
	if ($("body").attr("pane")=="products"&&$("#rightPaneProductCategories:visible").length) {
		assignProductCategoriesKeys();
	}

}


function pastePages (action) {
	var str = $("#adminPages .copyPageDestinaiton").attr("id").split("|");
	type = str[0];
	var parentId = str[1];
	if (type=="") {
		type = "topLevel";
	}
	if (action=="duplicate_pages") {
		var Ids="[";
		$("#adminPages .listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("rel")+'"';
			} else {
			Ids+=',"'+$(this).attr("rel")+'"';
			}
		});
		Ids+="]";
	} else {
		var Ids = "";
	}
	working();
	$.ajax({
	  type: "POST",
	  url: "pageActions.php",
	  data: "pageAction="+action+"&parent="+parentId+"&type="+type+"&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

				if (msg!="" && msg!="Error1" && msg!="Error2" && msg!="Error3") {
						var toHighlight = jQuery.parseJSON(msg);

							$("#adminPages").load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){
								for (var i=0; i < toHighlight.length; i++) {
									$("#adminPages div[rel="+toHighlight[i]+"]").addClass("listItemHighlight");
								};
								$("#loadingMask").hide();
								saved();
								cancelDialogue();
								$(document).unbind("click");
								$(document).click(function(){
									if (justScrolled) {return false;}
									if (ignoreClickCatchup) {return false;}
									hide_menus();
								});
								selectionTools();
								$("#loadingMask").hide();
							});
				} else {
					if (msg=="Error1") {
						error(LangVars.Cant_Copy_With_Blog);
					} else if (msg=="Error2") {
						error(LangVars.Cant_Copy_With_Checkout);
					} else if (msg=="Error3") {
						error(LangVars.Cant_Copy_Too_Many_With_Same_Name);
					} else {
						saved();
						cancelDialogue();
						$(document).unbind("click");
						$(document).click(function(){
							if (justScrolled) {return false;}
							if (ignoreClickCatchup) {return false;}
							hide_menus();
						});

					}
				}





	  }
	});
}

function deleteGalleryImages () {

	working();
	var Ids="[";

	$("#rightPaneGalleryImages .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+=$(this).attr("gallery-image-id");
		} else {
		Ids+=","+$(this).attr("gallery-image-id");
		}

	});
	Ids+="]";

	var galid  = $("#rightPaneGalleryImages .topBarTitle").attr('gallery-id');

		$.ajax({
		  type: "POST",
		  url: "galleriesActions.php",
		  data: "galleriesAction=deleteImage&imagesids="+Ids,
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
	$("#galleriesAdmin").load("galleriesActions.php?galleriesAction=show&show="+galid+"&to_prevent_cache="+(new Date).getTime(),function(){
				$("#galleriesPaneInner .insertTarget").html($("#galleriesAdmin").html());
				$("#rightPaneGalleryImages .pagesScroll > div").css("height",$("#rightPaneGalleryImages .pagesScroll > div").height()+"px");
				showGalleryImages($("#rightPaneGalleries #gal"+galid),true);
				$("#rightPaneGalleryImages .pagesScroll > div").css("height","auto");
				hide_menus();
				cancelDialogue();
				saved("Images Removed");
			});
		  }
		});
}
function deleteImages () {
	working();

	counter=0;
	if ($("body").hasClass("selectingAll")) {
		var Ids="[";
		$("#imagesPaneInner .responsiveListItem:not(.responsiveListItem.listItemHighlight)").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("id")+'"';
			} else {
			Ids+=',"'+$(this).attr("id")+'"';
			}
		});
		Ids+="]";
		var selectingAll = "&selectingAll=true";
	} else {
		var selectingAll = "";
		var Ids="[";
		$("#imagesPaneInner .listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("id")+'"';
			} else {
			Ids+=',"'+$(this).attr("id")+'"';
			}
		});
		Ids+="]";
	}
	$.ajax({
	  type: "POST",
	  url: "pageActions.php",
	  data: "pageAction=deleteImages&ids="+Ids+selectingAll,
	  success: function(msg){
		
		$(".bpe_images,#bpe_images,#bpe_dropship_images .insertTarget,#imagesPaneInner .insertTarget").html(msg);

  		if ($("#rightPaneImages:visible").length) {

			assignListLasso($("#imagesPaneInner"));
			assignListPane($("#imagesPaneInner"),doNothing);
//			prepFancyLabelForms($("#rightPaneImages .filterBox"));
//			assignPaneSearch($("#rightPaneImages .searchList"),"pageActions.php","pageAction=showFilteredImages&search=","image");
//			assignImagesKeys();
//			$("#loadingMask").hide();
			assignDragAssets($("#imagesPaneInner .insertTarget"));
			setTimeout(function() {
				$("#imagesPaneInner").lovelyScroll(scrollImagesBottom);
			}, 400);
						$("#imagesPane .paneTools .imagePreview").remove();
		}
		
		saved("Image Removed");
		hide_menus();
		cancelDialogue();
	  }
	});

}
function deleteGalleries () {
	working();
	var Ids="[";
	$("#rightPaneGalleries .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("gallery-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("gallery-id")+'"';
		}
	});
	Ids+="]";
	$.ajax({
	  type: "POST",
	  url: "galleriesActions.php",
	  data: "galleriesAction=deleteGallery&ids="+Ids,
	  success: function(msg){

		$("#rightPaneGalleries .listItemHighlight").each(function(){
			$(this).next().remove();
			$(this).remove();
		});
		if ($("#rightPaneGalleries .galleryItem").length===0) {
			$("#galleriesPane .noPages").show();
		}
		$("#galleriesPaneInner").lovelyScroll();
		saved("Image Removed");
		hide_menus();
		cancelDialogue();
		$(document).unbind("click").click(function(){
			hide_menus();
		});
		assignGalleriesKeys();
	  }
	});
}
function deleteVideos () {
	working();
	var Ids="[";
	$("#rightPaneVideos .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("playlist-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("playlist-id")+'"';
		}
	});
	Ids+="]";

	obj = $(this);

	$.ajax({
	  type: "POST",
	  url: "mediaActions.php",
	  data: "mediaAction=removePlaylist&ids="+Ids,
	  success: function(msg){
		$(".listItemHighlight").each(function(){
			$(this).prev().remove();
			$(this).remove();
		});

	  	if ($("#rightPaneVideos .addVideoItem").length==0) {
	  		$("#rightPaneVideos .noPages").show();
	  	}

		$("#videosPaneInner").lovelyScroll();
		saved("Image Removed");
		hide_menus();
		cancelDialogue();
		$(document).unbind("click").click(function(){
			hide_menus();
		});
		assignVideosKeys();
	  }
	});

}
function deletePages () {

	if ($("body").hasClass("selectingAll")) {
		var Ids = getUnselectedPagesIds();
		var selectingAll = "&selectingAll=true";
	} else {
		var selectingAll = "";
		var Ids = getSelectedPagesIds();
	}

	working();
	$.ajax({
	  type: "POST",
	  url: "pageActions.php",
	  data: "pageAction=deleteMulti&ids="+Ids+selectingAll,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

			if (msg!="ok") {
				error(msg);
			} else {
				$("#adminPages .listItemHighlight").each(function(){
					$("#deletedPages").prepend("<li><a href='"+$(this).attr("rel")+"'><span class='overflowEllipsis'>"+$(this).attr("title")+"</span></a></li>");
					$(this).next().remove();
					$(this).remove();
				});
				hide_menus();
				cancelDialogue();
				saved();

			}
	  }
	});
}
function changeGalleryStyle (newStyle) {
		var Ids="[";
		$("#galleriesPane .listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("gallery-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("gallery-id")+'"';
			}
		});
		Ids+="]";

		working();
		$.ajax({
		  type: "POST",
		  url: "galleriesActions.php",
		  data: "galleriesAction=changeStyle&ids="+Ids+"&style="+newStyle,
		  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

				if (msg!="ok") {
					error(msg);
				} else {
					$("#galleriesPane .listItemHighlight").each(function(){
						$(this).attr("data-gallery-style",newStyle);
					});
					selectionTools();
					//galleryStyleTicks();
					saved();

				}
		  }
		});
}
function galleryStyleTicks () {
		var allTheSame=true;
		var galleryStyle = $("#galleriesPaneInner .listItemHighlight:first").attr("gallery-style");
		$("#galleriesPaneInner .listItemHighlight").each(function(){
			if ($(this).attr("gallery-style")!=galleryStyle) {
				allTheSame=false;
			}
		});
		$("#stylesMenuGalleries a.bpe_current").removeClass("bpe_current");
		if (allTheSame) {
		$("#stylesMenuGalleries a[gal-style="+galleryStyle+"]").addClass("bpe_current");
		}
}
function renameGallery(clicked) {
	editMeListItem(clicked);
}
function addGallery () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");
	hidePaneTools();
	$("#galleriesPane .noPages").hide();
	$("#rightPaneGalleries #addGalleryForm").show();
	$("#rightPaneGalleries #addGalleryForm .focus").focus();
	prepFancyLabelForms($("#rightPaneGalleries #addGalleryForm"));
	function saveOrCancel () {
		$("#rightPaneGalleries #addGalleryForm .focus").unbind("blur");
		if ($("#rightPaneGalleries #addGalleryForm .focus").val()=="" || $("#rightPaneGalleries #addGalleryForm .focus").val()==" ") {
			resetAddForms();
			if ($("#galleriesPane .galleryItem").length===0) {
				$("#galleriesPane .noPages").show();
			}
		} else {
			$("#rightPaneGalleries #addGalleryForm").submit();
		}
	}
	$("#rightPaneGalleries #addGalleryForm .focus").unbind("blur").blur(function(){
			saveOrCancel();
			return false;
	});
	$(document).keypress(function(e){
		if (e.keyCode==13) { // enter
			e.preventDefault();
			return false;
		}

	});
	$(document).keyup(function(e){

		if (e.keyCode==13) { // enter
			e.preventDefault();
			return false;
		}
		if (e.keyCode==27) { // esc

			return false;
		}
	});
	$(document).keydown(function(e){
		if (e.keyCode==13) { // enter
			e.preventDefault();

			if (!shiftDown) {
				saveOrCancel();
			}
			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});
}
function assignGalleryAdd () {
	$("#rightPaneGalleries #addGalleryForm").unbind("submit").submit(function(){
		working();
		function showResponse (responseText, statusText) {
if (responseText =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			$("#galleriesAdmin").load("galleriesActions.php?galleriesAction=show&to_prevent_cache="+(new Date).getTime(),function(){
				$("#galleriesPaneInner .insertTarget").html($("#galleriesAdmin").html());
				$("#galleriesPaneInner .insertTarget .galleryItem:first").addClass("listItemHighlight");
				assignDragAssets($("#galleriesPaneInner .insertTarget"));
				$("#galleriesPaneInner").lovelyScroll();
				resetAddForms();
				assignGalleryAdd();
				assignGalleriesKeys();
				saved();
				selectionTools();
			});

		}
		var options = {
	        success:       showResponse  // post-submit callback
	    };

		$(this).ajaxSubmit(options);

		return false;
	});

}
function addPage () {


	prepFancyLabelForms($("#adminPages .responsiveListAddForm"));
	$("#adminPages .responsiveListAddForm").show();

	$(".noPages").hide();
	$("#adminPages .responsiveListAddForm .focus").focus();
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");

	function saveOrCancel () {
		$("#adminPages .responsiveListAddForm .focus").unbind("blur");
		if ($("#adminPages .responsiveListAddForm .focus").val()=="" || $("#adminPages .responsiveListAddForm .focus").val()==" ") {
			resetAddForms();
			$(".noPages").show();
		} else {
			$("#adminPages .responsiveListAddForm").submit();
		}
	}
	$("#adminPages .responsiveListAddForm").click(function(){
		return false;
	});
	$("#adminPages .responsiveListAddForm .focus").blur(function(){
		saveOrCancel();
		return false;
	});
	$(document).keydown(function(e){

		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});


}
function getUnselectedPagesIds () {
	var Ids="[";
	$("#adminPages .responsiveListItem:not(.responsiveListItem.listItemHighlight,.breadcrumbPage)").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("rel")+'"';
		} else {
		Ids+=',"'+$(this).attr("rel")+'"';
		}
	});
	Ids+="]";
	return Ids;
}
function getSelectedPagesIds () {
	var Ids="[";
	$("#adminPages .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("rel")+'"';
		} else {
		Ids+=',"'+$(this).attr("rel")+'"';
		}
	});
	Ids+="]";
	return Ids;
}
function toggleLive (action) {
	working();

	if ($("body").hasClass("selectingAll")) {
		var Ids = getUnselectedPagesIds();
		var selectingAll = "&selectingAll=true";
	} else {
		var selectingAll = "";
		var Ids = getSelectedPagesIds();
	}

	$.ajax({
	  type: "POST",
	  url: "pageActions.php",
	  data: "pageAction=change&action=live&live="+action+"&ids="+Ids+selectingAll,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

		softToggle(action);
		saved();
		selectionTools();
	  }
	});

}
function softToggle (action) {
	$("#adminPages .listItemHighlight").each(function(){
		if (action=="yes") {
			if ($(this).hasClass("offline")) {
				$(this).removeClass("offline").addClass("live");
				$(this).attr("data-pane-status","live");
				$(".offlineLabel",$(this)).remove();
			}
		} else {
			if (!$(this).hasClass("offline")) {
				$(this).prepend("<span class='responsiveListItemInfo offlineLabel'>"+LangVars.Offline+"</span>");
				$(this).addClass("offline").removeClass("live");
				$(this).attr("data-pane-status","offline");
			}
		}
	});

}
function changeLanguage (lang) {
	if ($("body").hasClass("selectingAll")) {
		var ids = getUnselectedPagesIds();
		var selectingAll = "&selectingAll=true";
	} else {
		var selectingAll = "";
		var ids = getSelectedPagesIds();
	}


		$.ajax({
		  type: "POST",
		  url: "pageActions.php",
		  data: "pageAction=change&action=language&ids="+ids+"&language="+lang+selectingAll,
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			if (msg=="exists") {
				error(LangVars.Page_Name_Exists);
			} else {
				saved("Language changed for page");
			}
			$("#languagesWrapper").load("languagesActions.php?languagesAction=show&to_prevent_cache="+(new Date).getTime(),function(){
				$("#pagesFilterToUpdate,#languagesWrapperBlog").html($("#languagesWrapper").html());
				$("#adminPages .listItemHighlight").attr("data-lang",lang);
				assign_page_filter();
				assignPages();
				selectionTools();
				if ($("#pagesFilterToUpdate li").length>1) {
					$("#adminPagesLangFilter").show();
				}
				if ($("#pagesFilterToUpdate a.bpe_current").length || !$("#pagesFilter a.bpe_current").length) {
					$("#adminPages").load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){
						assignPages();
						assign_page_filter();
					});
				}

				updateSitewideLangs();


				//$("#pagesFilter a.bpe_current").length===0
			});
			/*
			$("#adminPages").load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){

				assignPages();
				assign_page_filter();
			});*/
		  }
		});

}
function pagesAddLanguage ($this) {
	working();
	var lang = $this.attr("fakehref");
	var abr = lang.split("|");
	abr = abr[1];
	$.ajax({
	  type: "POST",
	  url: "languagesActions.php",
	  data: "languagesAction=addLanguage&lang="+lang,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

		if ($("body").attr("pane")=="mainMenuPages") {
			changeLanguage(abr);
		}
		if ($("body").attr("pane")=="blog") {
			changeLanguageBlog(abr);
		}
	  }
	});
}
function applyProtection (accessGroupId,addremove) {
	working();
	if ($("body").hasClass("selectingAll")) {
		var ids = getUnselectedPagesIds();
		var selectingAll = "&selectingAll=true";
	} else {
		var selectingAll = "";
		var ids = getSelectedPagesIds();
	}
	var action = accessGroupId;
	$.ajax({
	  type: "POST",
	  url: "pageActions.php",
	  data: "pageAction=change&action=security&security="+action+"&addremove="+addremove+"&ids="+ids+selectingAll,
	  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

			if (addremove=="add") {
				if (accessGroupId=="") {
					$("#adminPages .listItemHighlight").attr("data-security","public");
					$(".responsiveListItemPadlock",$("#adminPages .listItemHighlight")).hide();
				} else {
					$("#adminPages .listItemHighlight").each(function(){
						if ($(this).attr("data-security")=="public") {
							$(this).attr("data-security","");
						}
						$(".responsiveListItemPadlock",$(this)).show();
						var curSec = $(this).attr("data-security");

						if ($(this).attr("data-security")!="") {
							var s = ",";
						} else {
							var s="";
						}
						var newSec = curSec+s+accessGroupId
						newSec=newSec.split(",");
						newSec.sort(function(a,b){return a-b});
						var newSecStr = "";
						for (var i=0; i < newSec.length; i++) {
							if (newSecStr!="") {
								newSecStr+=",";
							}
							newSecStr+=newSec[i];
						};
						if (newSecStr==""){
							newSecStr="public";
						}
						$(this).attr("data-security",newSecStr);
					});
				}
			} else {
				$("#adminPages .listItemHighlight").each(function(){
					var securities = $(this).attr("data-security").split(",");
					var newSecurities = new Array();
					for (var i=0; i < securities.length; i++) {
						if (securities[i]!=accessGroupId) {
							newSecurities.push(securities[i]);
						}
					};
					newSecurities.sort(function(a,b){return a-b});
					var newSecStr = "";
					for (var i=0; i < newSecurities.length; i++) {
						if (newSecStr!="") {
							newSecStr+=",";
						}
						newSecStr+=newSecurities[i];
					};
					if (newSecStr==""){
						newSecStr="public";
						$(".responsiveListItemPadlock",$(this)).hide();
					}
					$(this).attr("data-security",newSecStr);

				});
			}

			/*$("#adminPages .listItemHighlight").each(function(){
				$(".responsiveListItemPadlock",$(this)).hide();
				$(this).removeClass("hasSecurity");

				var security = $(this).attr("data-security").split(",");
				for (var i=0; i < security.length; i++) {
					if (security[i]==securityJustChanged && security[i]!="") {
						$(".responsiveListItemPadlock",$(this)).show();
						$(this).addClass("hasSecurity");
					}
				};
			});*/
			securityJustChanged = accessGroupId;
			selectionTools();
			if (msg=="removed") {
				$("#groupList").load("accessGroupActions.php?accessGroupActions=showAccessGroups",function(){
					selectionTools();
				});
			}
			saved();
		}
	});

}
function setTicksInSecurityMenu () {
	$("#groupList .bpe_current").removeClass("bpe_current");
	var group = $("#rightPanePages .listItemHighlight:first").attr("security");
	var allTheSame=true;
	$("#rightPanePages .listItemHighlight").each(function(){
		if ($(this).attr("security")!=group) {
			allTheSame=false;
		}
	});
	if (allTheSame) {
		$("#groupList a[rel="+group+"]").addClass("bpe_current");
	}
}
function addAccessGroup (username,password1,password2) {
	if (username==""||password1==""||password2=="") {
		return false;
	}
	if (password1!=password2) {
		error(LangVars.Error_Passwords_Dont_Match);
		return false;
	}
	working();
	var pwhash = hex_hmac_sha1(password1,$("#addAccessGroup").attr("href"));
	$.ajax({
	  type: "POST",
	  url: "accessGroupActions.php",
	  data: "accessGroupActions=addNew&hash="+pwhash+"&salt="+$("#addAccessGroup").attr("href")+"&username="+username,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		if (msg!="exists") {
			$(".bpe_mask").remove();
			$(".bpe_add_popup").remove();
			$("#groupList").load("accessGroupActions.php?accessGroupActions=showAccessGroups",function(){
				applyProtection(msg,"add");
				setTicksInSecurityMenu();
			});
			cancelDialogue();
			saved();

		} else if(msg=="exists") {
			error(LangVars.Error_Access_Group_Exists);
		}
	  }
	});
}
function editMe ($title) {

	if (!$title.hasClass("editing")) {
		var text = $("span",$title).html();

		var w = $("span",$title).width();
		var ot = $title.offset().top+5;
		var space = parseInt($title.css("left"));
		var ol = $title.offset().left-space+5;
		var bt = $title.width()+(space*2)-10;
		$title.html("<div style='width:"+bt+"px;position:fixed;top:4px;left:"+ol+"px;' id='editingTopTitle'><input type='text' style='padding-left:0;padding-right:0;width:100%;' /></div>");
		$("input",$title).val(text).attr("original",text).focus();
		$input = $("input",$title);
		var space = $input.parent().width();
		space=space-30;
		$(".showLeftPane:visible,.showRightPane:visible,.topBarButtonBack:visible,.topBarButtonBack:visible,.subHeaderButton:visible,.subHeaderLeftMenuItem:visible,.topBarButtonSwap:visible,.filterBox:visible,.dateFilterButton:visible,.returnToLP:visible,.toggleLivepreview:visible",$title.parent()).fadeOut().addClass("showBack");
		$title.attr("prevLeft",parseInt($title.css("left")));
		$title.attr("prevRight",parseInt($title.css("right")));
		//$title.css({left:"16px",right:"36px"});
		//$input.animate({width:"100%"},500);
		function resetTitle ($input,text) {
			var $parent = $input.parent().parent();
			var nl = $parent.attr("prevLeft");
			var nr = $parent.attr("prevRight");
			$parent.removeClass("editing");
			$parent.html("<div><span>"+text+"</span></div>");
			//$parent.css({left:nl+"px",right:nr+"px"});


		}
		$("input",$title).unbind("blur").blur(function(){
			var $this = $(this);
			var nl = parseInt($(this).parent().parent().attr("prevLeft"));
			var nr = parseInt($(this).parent().parent().attr("prevRight"));
			var $newi = "<div id='widthTest' style='position:relative;top:-100px;'><span>"+$(this).val()+"</span></div>";
			$this.parents(".topBarTitle").append($newi);
			var w  = $("#widthTest").outerWidth();
			$("#widthTest").remove();
			$(".showBack",$(this).parent().parent().parent()).fadeIn().removeClass("showBack");
			//$(this).css({width:w+"px"});
			//$(this).parent().parent().css({left:nl+"px",right:nr+"px"});

				if ($("body").attr("pane")=="galleries"&&$("#rightPaneGalleryImages:visible").length) {
					var id = $this.parent().parent().attr("gallery-id");
					var name = encodeURIComponent($this.val());
					if (name=="") {
						resetTitle($this,$this.attr("original"));
						assignGalleryImagesKeys();
						return false;
					}
					if (name==$this.attr("original")) {
						resetTitle($this,$this.attr("original"));

						assignGalleryImagesKeys();
						return false;
					}
					working();
					$.ajax({
					  type: "POST",
					  url: "galleriesActions.php",
					  data: "galleriesAction=renameGallery&id="+id+"&name="+name,
					  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
						$("#galleriesAdmin").load("galleriesActions.php?galleriesAction=show&to_prevent_cache="+(new Date).getTime(),function(){
							$("#galleriesPaneInner .insertTarget").html($("#galleriesAdmin").html());
							saved("Gallery Removed");
							resetTitle($this,msg);

						});
						$(document).unbind("click").click(function(){
								if (justScrolled) {return false;}
								if (ignoreClickCatchup) {return false;}
								hide_menus();
								hide_header_menus();
							});
					  }
					});
					assignGalleryImagesKeys();
				}
				if ($("body").attr("pane")=="forms"&&$("#rightPaneFormInputs:visible").length) {
					var id = $this.parent().parent().attr("form-id");
					var name = encodeURIComponent($this.val());
					if (name=="") {

						resetTitle($this,$this.attr("original"));

						assignFormInputsKeys();
						return false;
					}
					if (name==$this.attr("original")) {
						resetTitle($this,$this.attr("original"));

						assignFormInputsKeys();
						return false;
					}
					working();
					$.ajax({
					  type: "POST",
					  url: "formsActions.php",
					  data: "formsAction=renameForm&formId="+id+"&name="+name,
					  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
						$("#formsWrapper").load("formsActions.php?formsAction=show&v="+(new Date).getTime(),function(){
							addFormsToSettings();
							$("#formsPaneInner .insertTarget").html($("#formsWrapper").html());

								resetTitle($this,msg);

							saved("Form renamed");
						});
						$(document).unbind("click").click(function(){
								if (justScrolled) {return false;}
								if (ignoreClickCatchup) {return false;}
								hide_menus();
								hide_header_menus();
							});
					  }
					});
					assignFormInputsKeys();
				}
				if ($("#rightPaneFormInputOptions:visible").length) {
					var id = $this.parent().parent().attr("input-id");
					var name = encodeURIComponent($this.val());
					if (name=="") {
						resetTitle($this,$this.attr("original"));

						assignFormInputOptionsKeys();
						return false;
					}
					if (name==$this.attr("original")) {
						resetTitle($this,$this.attr("original"));

						assignFormInputOptionsKeys();
						return false;
					}
					working();
					var showId = id;
					$.ajax({
					  type: "POST",
					  url: "formsActions.php",
					  data: "formsAction=editInput&inputsId="+id+"&label="+name,
					  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
							saved("");
							resetTitle($this,msg);
							$("#formsWrapper").load("formsActions.php?formsAction=show&showForm="+showId+"&to_prevent_cache="+(new Date).getTime(),function(){
								$("#formsPaneInner .insertTarget").html($("#formsWrapper").html());
							});
							$(document).unbind("click").click(function(){
								if (justScrolled) {return false;}
								if (ignoreClickCatchup) {return false;}
								hide_menus();
								hide_header_menus();
							});

					  }
					});
					assignFormInputOptionsKeys();

				}
				if ($("#rightPaneProductOptions:visible").length) {
					var id = $this.parent().parent().attr("product-id");
					var name = encodeURIComponent($this.val());
					if (name=="") {
						resetTitle($this,$this.attr("original"));

						assignProductOptionsKeys();
						return false;
					}
					if (name==$this.attr("original")) {
						resetTitle($this,$this.attr("original"));

						assignProductOptionsKeys();
						return false;
					}
					working();
					var showId = id;
					$.ajax({
					  type: "POST",
					  url: "shopActions.php",
					  data: "shopAction=renameProduct&id="+id+"&name="+name,
					  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
							saved("");
							resetTitle($this,msg);

							$("#productWrapper").load("shopActions.php?shopActions=showProducts&to_prevent_cache="+(new Date).getTime(),function(){

							});
							$("#rightPaneProducts #prod"+showId).attr("name",msg);
							$("#rightPaneProducts #prod"+showId+" .productItem > .overflowEllipsis").html(msg);
							$(document).unbind("click").click(function(){
								if (justScrolled) {return false;}
								if (ignoreClickCatchup) {return false;}
								hide_menus();
								hide_header_menus();
							});
					  }
					});
					assignProductOptionsKeys();

				}
				if ($("#rightPaneCalendarEvents:visible").length) {
					var id = $this.parent().parent().attr("cal-id");
					var name = encodeURIComponent($this.val());
					if (name=="") {
						resetTitle($this,$this.attr("original"));

						assignCalendarEventsKeys();
						return false;
					}
					if (name==$this.attr("original")) {
						resetTitle($this,$this.attr("original"));

						assignCalendarEventsKeys();
						return false;
					}
					var val = $this.val();
					working();
					var showId = id;
					$.ajax({
					  type: "POST",
					  url: "calendarActions.php",
					  data: "calendarAction=renameCat&id="+id+"&name="+name,
					  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
							saved("");

							resetTitle($this,htmlentities(val));

							$("#calendarsPaneInner .insertTarget").html(msg);
							$(document).unbind("click").click(function(){
								if (justScrolled) {return false;}
								if (ignoreClickCatchup) {return false;}
								hide_menus();
								hide_header_menus();
							});

					  }
					});
					assignCalendarEventsKeys();

				}
				if ($("#rightPaneNewsletterSubscribers:visible").length) {
					var id = $this.parent().parent().attr("mailinglist-id");
					var name = encodeURIComponent($this.val());
					if (name=="") {

						resetTitle($this,$this.attr("original"));
						assignNewsletterSubscribersKeys();
						return false;
					}
					if (name==$this.attr("original")) {

						resetTitle($this,$this.attr("original"));
						assignCalendarEventsKeys();
						return false;
					}
					var val = $this.val();
					working();
					var showId = id;
					$.ajax({
					  type: "POST",
					  url: "newsletterActions.php",
					  data: "newsletterAction=renameGroup&id="+id+"&name="+name,
					  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
							saved("");

							resetTitle($this,htmlentities(val));

							$("#editNewsletterSubscribersTitle").attr("mailinglist-id",msg);

							$("#newsletterPaneInner > div").load("newsletterActions.php?newsletterAction=showGroups&showPane=",function(){

							});
							$(document).unbind("click").click(function(){
								if (justScrolled) {return false;}
								if (ignoreClickCatchup) {return false;}
								hide_menus();
								hide_header_menus();
							});



					  }
					});
					assignNewsletterSubscribersKeys();

				}
				if ($("body").attr("pane")=="editContent" && $("#rightPane .topBarTitle").hasClass("renameBlog")) {
						var name = encodeURIComponent($this.val());
						if (name=="") {

							resetTitle($this,$this.attr("original"));
							assignSaveListener();
							return false;
						}
						if (name==$this.attr("original")) {
							resetTitle($this,$this.attr("original"));
							assignSaveListener();
							return false;
						}
						working();

						var val = $this.val();
						var pageId = $("#kbid").val();
						$.ajax({
						  type: "POST",
						  url: "blogActions.php",
						  data: "blogAction=renamePage&id="+pageId+"&title="+name,
						  success: function(msg){
			if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
								saved();
								resetTitle($this,htmlentities(val));
								assignSaveListener();
								$(document).unbind("click").click(function(){

									hide_menus();
									$.fn.bpeditor.assign_toggler();
									assignSaveListener();

								});


						  }
						});
				}
				if ($("body").attr("pane")=="editContent" && $("#rightPane .topBarTitle").hasClass("renamePage")) {

					var name = encodeURIComponent($this.val());
					if (name=="") {
						resetTitle($this,$this.attr("original"));

						assignSaveListener();
						$(document).unbind("click").click(function(){

							hide_menus();
							$.fn.bpeditor.assign_toggler();
							assignSaveListener();


						});

						return false;
					}

					if (name==encodeURIComponent($this.attr("original"))) {

						resetTitle($this,$this.attr("original"));

						assignSaveListener();
						$(document).unbind("click").click(function(){

							hide_menus();
							$.fn.bpeditor.assign_toggler();
							assignSaveListener();

						});
						return false;
					}
					working();

					var val = $this.val();
					var pageId = $("#kbid").val();
					$.ajax({
					  type: "POST",
					  url: "pageActions.php",
					  data: "pageAction=renamePage&id="+pageId+"&title="+name,
					  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
							if (msg=="exists") {
								error(LangVars.Page_Name_Exists);
								resetTitle($this,$this.attr("original"));
							} else {
								resetTitle($this,htmlentities(val));
							}
							saved("");

							assignSaveListener();
							$(document).unbind("click").click(function(){

								hide_menus();
								$.fn.bpeditor.assign_toggler();
								assignSaveListener();


							});
					  }
					});
				}
				if ($("body").attr("pane")=="editContent" && $("#rightPane .topBarTitle").hasClass("renameSnippet")) {
					var name = encodeURIComponent($this.val());
					if (name=="") {
						resetTitle($this,$this.attr("original"));


						assignSaveListener();
						return false;
					}
					if (name==$this.attr("original")) {
						resetTitle($this,$this.attr("original"));

						assignSaveListener();
						return false;
					}
					working();

					var val = $this.val();
					var pageId = $("#editing").val();
					$.ajax({
					  type: "POST",
					  url: "snippetsActions.php",
					  data: "snippetsAction=rename&id="+pageId+"&name="+name,
					  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
							saved("");

							resetTitle($this,htmlentities(val));

							assignSaveListener();
							$(document).unbind("click").click(function(){

								hide_menus();
								$.fn.bpeditor.assign_toggler();
								assignSaveListener();


							});

					  }
					});
				}



		});
		$(document).unbind("click");
		$(document).unbind("keypress");
		$(document).unbind("keyup");
		$(document).unbind("keydown");
		$(document).keyup(function(e){
			if (e.keyCode==13) { // enter
				$input.blur();
				return false;
			}
			if (e.keyCode==27) { // enter
				$input.blur();
				return false;
			}
		});
		$title.addClass("editing");
	}
}

function changeFormAutoresponderContent(clicked) {
	$("#selectedFormAutoresponderPage").attr("page-id",clicked.attr("rel")).html(clicked.attr("title"));
	$("#selectedFormAutoresponderPage").attr("data-static-pages-versions-id",clicked.attr("data-static-pages-versions-id"));
	$("#changeFormAutoresponderContent").removeClass("empty");
	if ($("#lightPagesList").length) {
		$("#lightPagesOuter").animate({opacity:"0"},550,function(){
			$("#lightPagesOuter").remove();
		});
		return false;
	}
}
function duplicateForms () {
	working();
	var Ids="[";
	$("#rightPaneForms .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("form-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("form-id")+'"';
		}
	});
	Ids+="]";
	$.ajax({
	  type: "POST",
	  url: "formsActions.php",
	  data: "formsAction=dupeForm&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#formsWrapper").load("formsActions.php?formsAction=show&v="+(new Date).getTime(),function(){
			addFormsToSettings();
			$("#formsPaneInner .insertTarget").html($("#formsWrapper").html());
			assignDragAssets($("#formsPaneInner .insertTarget"));
			saved("Form Duplicated");
			selectionTools();
		});
	  }
	});
}
function deleteForms () {
	working();
	var Ids="[";
	$("#rightPaneForms .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("form-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("form-id")+'"';
		}
	});
	Ids+="]";

	$.ajax({
	  type: "POST",
	  url: "formsActions.php",
	  data: "formsAction=deleteForm&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		if (msg=="ok") {

			$("#formsWrapper").load("formsActions.php?formsAction=show&to_prevent_cache="+(new Date).getTime(),function(){
				addFormsToSettings();
				$("#formsPaneInner .insertTarget").html($("#formsWrapper").html());
					assignAddFormForm();
					hide_menus();
					cancelDialogue();
					$("#formsPaneInner").lovelyScroll();
				saved("Form Removed");
				if ($("#rightPaneForms .formItem").length===0) {
					$("#rightPaneForms .noPages").show();
				}
			});


		} else {
			error(LangVars.Misc_Error);
		}

	  }
	});
}
function exportFormData() {

	if ($("#rightPaneForms .listItemHighlight").length!==1) {
		return false;
	}

	var formid = $("#rightPaneForms .listItemHighlight").attr("form-id");

	window.location.href = "formsActions.php?formsAction=exportFormData&formid="+formid;

	saved(LangVars.Form_Export_Done);

}
function changeRecipient (value) {
	var Ids="[";
	$("#rightPaneForms .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("form-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("form-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "formsActions.php",
	  data: "formsAction=changeDestination&ids="+Ids+"&destination="+value,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

		$("#formsWrapper").load("formsActions.php?formsAction=show&to_prevent_cache="+(new Date).getTime(),function(){
			$("#formsPaneInner .insertTarget").html($("#formsWrapper").html());
			var toHighlight = jQuery.parseJSON( Ids );
			for (var i=0; i < toHighlight.length; i++) {
		 		$("#rightPaneForms #form"+toHighlight[i]).addClass("listItemHighlight");
			};
			selectionTools();
			cancelDialogue();


			saved();
		});
	  }
	});
}

function changeAutoresponder () {
	var value = $("#selectedFormAutoresponderPage").attr("page-id");
	var subject = $("#formAutoresponderSubjectInput").val();
	var Ids="[";
	$("#rightPaneForms .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("form-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("form-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "formsActions.php",
	  data: "formsAction=changeAutoresponder&ids="+Ids+"&pageid="+value+"&subject="+encodeURIComponent(subject),
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

		$("#formsWrapper").load("formsActions.php?formsAction=show&to_prevent_cache="+(new Date).getTime(),function(){
			$("#formsPaneInner .insertTarget").html($("#formsWrapper").html());
			var toHighlight = jQuery.parseJSON( Ids );
			for (var i=0; i < toHighlight.length; i++) {
		 		$("#rightPaneForms #form"+toHighlight[i]).addClass("listItemHighlight");
			};
			selectionTools();
			cancelDialogue();
			saved();
		});
	  }
	});
}

function changeRedirectOnSend (text) {
	var value = encodeURIComponent(text);

	var Ids="[";
	$("#rightPaneForms .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("form-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("form-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "formsActions.php",
	  data: "formsAction=changeRedirectOnSend&ids="+Ids+"&value="+value,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

		$("#formsWrapper").load("formsActions.php?formsAction=show&to_prevent_cache="+(new Date).getTime(),function(){
			$("#formsPaneInner .insertTarget").html($("#formsWrapper").html());
			var toHighlight = jQuery.parseJSON( Ids );
			for (var i=0; i < toHighlight.length; i++) {
		 		$("#rightPaneForms #form"+toHighlight[i]).addClass("listItemHighlight");
			};
			selectionTools();
			cancelDialogue();
			saved();
		});
	  }
	});
}
function addForm () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");
	$("#rightPaneForms .noPages").hide();

	$("#rightPaneForms #addFormForm").show();
	$("#rightPaneForms #addFormForm .focus").focus();
	prepFancyLabelForms($("#rightPaneForms #addFormForm"));
	function saveOrCancel () {
		$("#rightPaneForms #addFormForm .focus").unbind("blur");
		if ($("#rightPaneForms #addFormForm .focus").val()=="" || $("#rightPaneForm #addFormForm .focus").val()==" ") {
			resetAddForms();
			if ($("#rightPaneForms .formItem").length===0) {
				$("#rightPaneForms .noPages").show();
			}

		} else {
			$("#rightPaneForms #addFormForm").submit();
		}
		return false;
	}
	$(document).keydown(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});
	$("#rightPaneForms #addFormForm .focus").unbind("blur").blur(function(){
		saveOrCancel();
		return false;
	});/*
	$(document).click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		resetAddForms();
		return false;
	});*/
}
function editForm ($form,secondaryAction) {
	if(secondaryAction===true) {
		editMeListItem($form);
		return false;
	}
	showFormInputs($form,false)	;
}
function showFormInputs ($form,scrollToBottom) {
	hidePanes();

	$("input").unbind();
	$("#loadingMask").show();
	$(".assetPane").hide();
	$("#formInputsPaneInner .insertTarget").html($(".formInputs",$form).html());
	hidePaneTools();

	$("#rightPaneFormInputs .topBarTitle").html("<div><span>"+$form.attr("rel")+"</span></div>").attr("form-id",$form.attr("form-id"));
	//$("#rightPaneFormInputs").show();
	$("#formInputsPaneInner").css("width","auto");
	showPane($("#rightPaneFormInputs"),false,true,false,true);


	$("#loadingMask").hide();
	assignListLasso($("#formInputsPaneInner"));
	assignListPane($("#formInputsPaneInner"),editInput);

	assignSortableListItems($("#formInputsPaneInner"),"listItemHighlight","formInputItem");
	assignFormInputsKeys();
	setTimeout(function() {
		$("#formInputsPaneInner").lovelyScroll();
	}, 350);
	if (scrollToBottom) {
		setTimeout(function() {
			var d = $("#formInputsPaneInner .insertTarget").outerHeight()-$("#formInputsPaneInner").innerHeight()+95;
			d = d-d-d;
			$("#formInputsPaneInner").lovelyScrollMove(d);
			$("#formInputsPaneInner .formInputItem:last").addClass("listItemHighlight");
			selectionTools();
		}, 360);
	}

}
function reloadCalendar () {
	var date = $(".dateInput",$("#calendarEventsPaneInner .eventForm")).val();
	var splitd = date.split("/");
	var showCatId = $("#calendarEventsDateFilter #showing_cat").val();
	var showCatString = "&showCat="+showCatId;
	month = splitd[1];
	year = splitd[2];
	day = splitd[0];
	$("#calendarEventsDateFilter").load("/actions/ShowCal/?month="+month+"&year="+year+"&day="+day+showCatString,function(){
		saved("");
		$("#eventsGroupsList").load("calendarActions.php?calendarAction=showGroups&belongsToCal="+$("#calendarEventsDateFilter #showing_cat").val(),function(){
			if ($("#eventsGroupsList li").length==0) {
//				$("#filterBySubscriberCat").hide();
				$("#eventsGroupsList").next().hide();
				$("#eventsGroupsList").hide();
			} else {
//				$("#filterBySubscriberCat").show();
				$("#eventsGroupsList").next().show();
				$("#eventsGroupsList").show();
			}
	//		updateSubscriberCatFilterMenu();
		});
	});
}
function editMeListItemMultiple ($item) {
	hidePaneTools();

	$input = $item.next();
	$input.show();
	$item.hide();
	$input.unbind("click").click(function(){
		return false;
	});
	$(".imageContextEditFieldset",$input).each(function(){
		$(".imageContextEditLabel",$(this)).css("visibility","hidden");
		if ($("input",$(this)).val()==""){
			$(".imageContextEditLabel",$(this)).css("visibility","visible");
		}
	});
	$(".imageContextEditFieldset input",$input).unbind("keyup").keyup(function(){
		if ($(this).val()!="") {
			$(".imageContextEditLabel",$(this).parents(".imageContextEditFieldset")).css("visibility","hidden");
		} else {
			$(".imageContextEditLabel",$(this).parents(".imageContextEditFieldset")).css("visibility","visible");
		}
	});
	$(".linkField input",$input).focus(function(){
		if (!$("#insertLinkToDownload").length) {
			$(this).parents(".imageContextEditFieldset").after("<span id='insertInteralLinksInline' class='clearfix'><span id='insertLinkToPage'>"+LangVars.Insert_Link_To_Page+"</span><span id='insertLinkToDownload'>"+LangVars.Insert_Link_To_File+"</span></span>");
			$("#insertLinkToPage").click(function(){
				$(".linkField input",$input).blur();
				showLightPages(updateEventLinkVal,"showTop",true,LangVars.Choose_page);
			});
			$("#insertLinkToDownload").click(function(){
				$(".linkField input",$input).blur();
				showDownloadPopdown(updateEventLinkVal);
			});
		}
	});
	$(".focus",$input).focus(function(){
		$("#insertLinkToPage").parent().remove();
	});
	if ($("#rightPaneCalendarEvents:visible").length) {
		$("#rightPaneCalendarEvents .insertTarget").unbind("click").click(function(){
			hidePopdownOrPassthroughSave(saveThis);
			return false;
		});
	}
	if ($("#rightPaneNewsletterSubscribers:visible").length) {
		$("#newsletterSubscribersPaneInner .insertTarget").unbind("click").click(function(){
			saveThis();
			return false;
		});
	}
	if ($("#rightPaneBlogAuthors:visible").length) {
		$("#blogAuthorsPaneInner").unbind("click").click(function(){
			saveThis();
			return false;
		});
	}
	if ($("#rightPaneEmbedCodes:visible").length) {
		$(".editEmbedCodeCode",$input).autosize();
		$("#embedCodesPaneInner .insertTarget").unbind("click").click(function(){
			saveThis();
			return false;
		});
	}
	function saveThis () {
		$("#fixedMenus,.rightPane").unbind("click");
		if ($("#rightPaneCalendarEvents:visible").length) {
			working();
			var val = $(".focus",$input).val();
			var link = $(".eventLink",$input).val();
			var id = $(".eventId",$input).val();
			$item.attr("name",val);
			$(".overflowEllipsis",$item).html(val);

			$.ajax({
			  type: "POST",
			  url: "calendarActions.php",
			  data: "calendarAction=editEvent&id="+id+"&link="+encodeURIComponent(link)+"&title="+encodeURIComponent(val),
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					$item.show().addClass("listItemHighlight");
					$input.hide();
					assignListPane($("#rightPaneCalendarEvents .insertTarget"),editCalendarEvents);

					reloadCalendar();
					assignCalendarEventsKeys();
					selectionTools();
			  }
			});

		}
		if ($("#rightPaneNewsletterSubscribers:visible").length) {
			var id = $item.attr("subscriber-id");
			var name = encodeURIComponent($(".editSubscriberName",$input).val());
			var email = encodeURIComponent($(".editSubscriberEmail",$input).val());

			var rawname = $(".editSubscriberName",$input).val();
			var rawemail = $(".editSubscriberEmail",$input).val();


			if (name=="" || email=="") {

				$input.hide();
				assignNewsletterSubscribersKeys();
				$item.show();
				return false;
			} else {
				working();
				$.ajax({
				  type: "POST",
				  url: "newsletterActions.php",
				  data: "newsletterAction=changeEmail&id="+id+"&name="+name+"&email="+email,
				  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

					$(".subscriberName",$item).html(rawname).attr("title",rawname);
					$(".subscriberEmail",$item).html(rawemail).attr("title",rawemail);
					$item.show();
					$input.hide();
					selectionTools();
					saved();
					assignNewsletterSubscribersKeys();
					assignListPane($("#newsletterSubscribersPaneInner .insertTarget"),editSubscriber);


				   }
				});
			}


		}
		if ($("#rightPaneBlogAuthors:visible").length) {
			var id = $item.attr("blog-author-id");
			var name = encodeURIComponent($(".newBlogAuthorName",$input).val());
			var bio = encodeURIComponent($(".newBlogAuthorBio",$input).val());

			var rawname = $(".newBlogAuthorName",$input).val();
			var rawbio = $(".newBlogAuthorBio",$input).val();


			if (name=="") {
				$("input",$input).each(function(){
					$(this).val($(this).attr("original"));
				});
				$input.hide();
				$item.show();
				assignBlogAuthorsKeys();
				assignListPane($("#blogAuthorsPaneInner"),editBlogAuthor);

				saved();
				return false;
			} else {
				working();
				$.ajax({
				  type: "POST",
				  url: "blogActions.php",
				  data: "blogAction=changeAuthor&id="+id+"&name="+name+"&bio="+bio,
				  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					$(".overflowEllipsis",$item).html(rawname);
					$item.attr("blog-author-bio",rawbio);
					$item.show();
					$input.hide();

					$("#blogAuthorsList a").remove();
					$("#blogAuthorsPaneInner .responsiveListItem").each(function(){
						$("#blogAuthorsList").append("<li><a class='authorItem' blog-author-id=\""+$(this).attr("blog-author-id")+"\" data-item-value=\""+$(this).attr("blog-author-id")+"\" blog-author-bio=\""+$(this).attr("blog-author-bio")+"\" data-lang=\""+$(".overflowEllipsis",$(this)).html()+"\"><span class=\"overflowEllipsis\">"+$(".overflowEllipsis",$(this)).html()+"</span></a></li>");
					});

					selectionTools();
					saved();
					assignBlogAuthorsKeys();
					assignListPane($("#blogAuthorsPaneInner"),editBlogAuthor);


				   }
				});
			}


		}
		if ($("#rightPaneEmbedCodes:visible").length) {
			var id = $item.attr("embed-code-id");

			var name = encodeURIComponent($(".editEmbedCodeName",$input).val());
			var code = encodeURIComponent($(".editEmbedCodeCode",$input).val());

			var rawname = $(".editEmbedCodeName",$input).val();
			var rawcode = $(".editEmbedCodeCode",$input).val();


			if (name=="" || code=="") {

				$("input",$input).each(function(){
					$(this).val($(this).attr("original"));
				});
				$input.hide();
				$item.show();
				assignEmbedCodesKeys();
				assignListPane($("#embedCodesPaneInner .insertTarget"),editEmbedCode);
				assignDragAssets($("#embedCodesPaneInner .insertTarget"));

				saved();
				return false;
			} else {
				working();

				$.ajax({
				  type: "POST",
				  url: "embedCodesActions.php",
				  data: "embedCodesAction=editEmbedCode&id="+id+"&name="+name+"&code="+code,
				  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

					$(".overflowEllipsis",$item).html(htmlentities(rawname));
					$item.attr("embed-code-name",htmlentities(rawname));
					$(".editEmbedCodeName",$item.next()).val(rawname);
					$(".editEmbedCodeCode",$item.next()).val(rawcode);
					$item.show();
					$input.hide();

					selectionTools();
					saved();

					assignListPane($("#embedCodesPaneInner .insertTarget"),editEmbedCode);
					assignDragAssets($("#embedCodesPaneInner .insertTarget"));
					assignEmbedCodesKeys();

				   }
				});
				return false;
			}


		}
	}
	$(".focus",$input).focus();
	$(document).unbind("click");

	$("#fixedMenus,.rightPane").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		hidePopdownOrPassthroughSave(saveThis);
		$("#fixedMenus,.rightPane").unbind("click");
		return false;
	});
	$(document).unbind("keypress");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).keyup(function(e){
		if (e.keyCode==13) { // enter
			if ($("#rightPaneEmbedCodes:visible").length && $(".editEmbedCodeCode:focus",$input).length) {

			} else {
				hidePopdownOrPassthroughSave(saveThis);
				return false;
			}

		}
		if (e.keyCode==27) { // esc
			hidePopdownOrPassthroughSave(saveThis);
			return false;
		}
	});
}
function editMeListItem ($item) {
	hidePaneTools();
	$("input").unbind();
	if (!$item.next().hasClass("responsiveListAddForm")) {
		var itemId = '';
		var text = $item.attr("name");
		if (typeof $item.attr("gallery-id") !== 'undefined' && $item.attr("gallery-id") !== false) {
			itemId=$item.attr("gallery-id");
			text = $item.attr("data-name");
		}
		if (typeof $item.attr("product-id") !== 'undefined' && $item.attr("product-id") !== false) {
			itemId=$item.attr("product-id");
		}
		if (typeof $item.attr("form-id") !== 'undefined' && $item.attr("form-id") !== false) {
			itemId=$item.attr("form-id");
		}
		if (typeof $item.attr("gallery-image-id") !== 'undefined' && $item.attr("gallery-image-id") !== false) {
			itemId=$item.attr("gallery-image-id");
		}
		if (typeof $item.attr("booking-product-id") !== 'undefined' && $item.attr("booking-product-id") !== false) {
			itemId=$item.attr("booking-product-id");
		}
		if (typeof $item.attr("id") !== 'undefined' && $item.attr("id") !== false && $item.hasClass("contentImage")) {
			itemId=$item.attr("id");
			text = $item.attr("title");
		}
		if (typeof $item.attr("permission-group-id") !== 'undefined' && $item.attr("permission-group-id") !== false) {
			itemId=$item.attr("permission-group-id");
			text = $item.attr("title");
		}
		if (typeof $item.attr("images-category-id") !== 'undefined' && $item.attr("images-category-id") !== false) {
			itemId=$item.attr("images-category-id");
			text = $item.attr("title");
		}
		$item.after("<div class=\"responsiveListAddForm inline\" action=\"\" method=\"post\" rel=\""+itemId+"\"><input type=\"text\" name=\"\" value=\""+htmlentities(text)+"\" class=\"focus\"	/></div>");
	}
	$input = $item.next();
	$input.show();
	$item.hide();
	$input.click(function(){
		return false;
	});
	$("input",$input).focus();
	$(".focus",$input).blur(function(){
		if ($(".assetPane:visible").hasClass("autoRename")) {

			var $dataEl = $(".assetPane:visible");
			working();

			var elementId = $(this).parent().attr('rel');


			$.ajax({
			  type: "POST",
			  url: $dataEl.data("url"),
			  data: $dataEl.data("data")+"&id="+elementId+"&value="+encodeURIComponent($(this).val()),
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					if (typeof $dataEl.data("post-call")!="undefined") {
						window[$dataEl.data("post-call")]();

					}

					saved();
					selectionTools();
			  }
			});
			$item.attr($dataEl.data("attr-to-update"),$(this).val());
			$(".overflowEllipsis:not(.inputOptions .overflowEllipsis)",$item).html($(this).val());
			$item.show().addClass("listItemHighlight");
			$input.remove();
			window[$dataEl.data("assign-keys")]();
		}
		if ($("#rightPaneFormInputs:visible").length) {
			working();
			var showId = $(".formid",$(this).parent()).val();
			var inputId =$(this).parent().attr('rel');

			$.ajax({
			  type: "POST",
			  url: "formsActions.php",
			  data: "formsAction=editInput&inputsId="+$(this).parent().attr('rel')+"&label="+encodeURIComponent($(".renameFieldInput",$(this).parent()).val()),
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

					//selectionTools();

					$("#formsWrapper").load("formsActions.php?formsAction=show&showForm="+showId+"&to_prevent_cache="+(new Date).getTime(),function(){
						$("#formsPaneInner .insertTarget").html($("#formsWrapper").html());
						saved("");

					});

			  }
			});
			$item.attr("name",$(this).val());
			$(".overflowEllipsis:not(.inputOptions .overflowEllipsis)",$item).html($(this).val());
			$item.show().addClass("listItemHighlight");
			$input.remove();
			assignFormInputsKeys();
		}
		if ($("#rightPaneFormInputOptions:visible").length) {
			$item.attr("name",$(this).val());
			$(".overflowEllipsis",$item).html($(this).val());
			$item.show().addClass("listItemHighlight");
			$input.remove();
			updateOptions(false);
			selectionTools();
			assignFormInputOptionsKeys();
		}
		if ($("#rightPaneForms:visible").length) {
			working();
			var formId = $(this).parent().attr('rel');
			var val = $(this).val();
			$.ajax({
				  type: "POST",
				  url: "formsActions.php",
				  data: "formsAction=renameForm&formId="+formId+"&name="+encodeURIComponent(val),
				  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					$item.attr("name",val);
					$item.attr("rel",val);
					$(".overflowEllipsis:not(.formInputs .overflowEllipsis)",$item).html(val);
					$item.show().addClass("listItemHighlight");
					$input.remove();
					saved("");
					assignFormsKeys();
					selectionTools();
				  }
				});
		}
		if ($("#rightPaneForms:visible").length) {
			working();
			var formId = $(this).parent().attr('rel');
			var val = $(this).val();
			$.ajax({
				  type: "POST",
				  url: "formsActions.php",
				  data: "formsAction=renameForm&formId="+formId+"&name="+encodeURIComponent(val),
				  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					$item.attr("name",val);
					$item.attr("rel",val);
					$(".overflowEllipsis:not(.formInputs .overflowEllipsis)",$item).html(val);
					$item.show().addClass("listItemHighlight");
					$input.remove();
					saved("");
					assignFormsKeys();
					selectionTools();
				  }
				});
		}
		if ($("#rightPaneSubscriberCategories:visible").length) {
			working();
			var catId = $(this).parent().attr('rel');
			var val = $(this).val();
			$.ajax({
			  type: "POST",
			  url: "newsletterActions.php",
			  data: "newsletterAction=renameCategory&id="+catId+"&name="+encodeURIComponent($(this).val()),
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					$item.attr("name",val);
					$item.attr("rel",val);
					$(".overflowEllipsis",$item).html(val);
					$item.show().addClass("listItemHighlight");
					$input.remove();
					saved("");
					assignSubscriberCategoriesKeys();
					selectionTools();

			  }
			});
		}
		if ($("#rightPaneEventsGroups:visible").length) {
			working();
			var catId = $(this).parent().attr('rel');
			var val = $(this).val();
			$.ajax({
			  type: "POST",
			  url: "calendarActions.php",
			  data: "calendarAction=renameGroup&id="+catId+"&name="+encodeURIComponent($(this).val()),
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					$item.attr("name",val);
					$item.attr("rel",val);
					$(".overflowEllipsis",$item).html(val);
					$item.show().addClass("listItemHighlight");
					$input.remove();
					saved("");
					assignEventGroupKeys();
					selectionTools();
			  }
			});
		}
		if ($("#rightPaneProductCategories:visible").length) {
			working();
			var catId = $(this).parent().attr('rel');
			var val = $(this).val();
			$.ajax({
			  type: "POST",
			  url: "shopActions.php",
			  data: "shopAction=renameProductCategory&id="+catId+"&name="+encodeURIComponent($(this).val()),
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					$("#productCategoriesList").load("shopActions.php?shopAction=showProductCategories",function(){
						updateProdFilterMenu();
					});
					$item.attr("name",val);
					$item.attr("rel",val);
					$(".overflowEllipsis",$item).html(val);
					$item.show().addClass("listItemHighlight");
					$input.remove();
					saved("");

					assignProductCategoriesKeys();
					selectionTools();
			  }
			});
		}
		if ($("#rightPaneProducts:visible").length) {
			var val = $(this).val();
			$item.attr("name",val);
			$.ajax({
			  type: "POST",
			  url: "shopActions.php",
			  data: "shopAction=renameProduct&id="+itemId+"&name="+val,
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					saved("");

					$("#productWrapper").load("shopActions.php?shopActions=showProducts&to_prevent_cache="+(new Date).getTime(),function(){

					});
					assignProductOptionsKeys();

					$(".overflowEllipsis",$item).html(val);
					$item.show().addClass("listItemHighlight");
					$input.remove();
					saved("");

					selectionTools();
			  }
			});


		}
		if ($("#rightPaneProductOptions:visible").length) {
			var val = $(this).val();

			$item.attr("name",val);
			$(".overflowEllipsis",$item).html(val);
			$item.show().addClass("listItemHighlight");
			$input.remove();
			saved("");
			updateProductOptions();

			assignProductOptionsKeys();

			selectionTools();
		}
		if ($("#rightPaneBlogCategories:visible").length) {
			working();
			var prodId = $(this).parent().attr('rel');
			var val = $(this).val();
			$.ajax({
			  type: "POST",
			  url: "blogActions.php",
			  data: "blogAction=renameCategory&id="+prodId+"&name="+encodeURIComponent($(this).val()),
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					$(".overflowEllipsis",$item).html(val);
					$item.show().addClass("listItemHighlight");
					$input.hide();
					$("#blogCategoriesList a").remove();
					$("#blogCategoriesPaneInner .responsiveListItem").each(function(){
						$("#blogCategoriesList").append("<li><a blog-category-id=\""+$(this).attr("blog-category-id")+"\" data-reverse-order=\""+$(this).attr("data-reverse-order")+"\" data-lang=\""+$(".overflowEllipsis",$(this)).html()+"\" data-item-value=\""+$(this).attr("blog-category-id")+"\"><span class=\"overflowEllipsis\">"+$(".overflowEllipsis",$(this)).html()+"</span></a></li>");
					});

					saved("");
					$(".focus",$input).unbind();
					assignListLasso($("#blogCategoriesPaneInner"));
					assignListPane($("#blogCategoriesPaneInner"),editBlogCategory);
					assignBlogCategoriesKeys();
					//selectionTools();

			  }
			});
		}
		if ($("#rightPaneBookingProducts:visible").length) {
			var val = $(this).val();
			$item.attr("name",val);
			$.ajax({
			  type: "POST",
			  url: "shopActions.php",
			  data: "shopAction=updateBookingProduct&ids=["+itemId+"]&name="+val,
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					saved("");


					assignBookingProductsKeys();

					$(".overflowEllipsis",$item).html(val);
					$item.show().addClass("listItemHighlight");
					$input.remove();
					saved("");

					selectionTools();
			  }
			});


		}
		if ($("#rightPaneStaff:visible").length) {
			working();
			var id = $item.attr('staff-id');
			var val = $(this).val();
			$.ajax({
			  type: "POST",
			  url: "adminUsersActions.php",
			  data: "adminUsersAction=changeEmailStaff&id="+id+"&email="+encodeURIComponent($(this).val()),
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					$(".overflowEllipsis",$item).html(val);
					$item.attr("name",val);
					$item.show().addClass("listItemHighlight");
					$input.remove();
					saved("");
					assignStaffKeys();
					selectionTools();

			  }
			});
		}
		if ($("#rightPaneGalleryImages:visible").length) {
			var galid = $(".galid",$item).val();
			var id = $item.attr('gallery-image-id');
			var val = $(this).val();
			$.ajax({
			  type: "POST",
			  url: "galleriesActions.php",
			  data: "galleriesAction=editImage&imagesid="+id+"&caption="+encodeURIComponent($(this).val()),
			  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#galleriesAdmin").load("galleriesActions.php?galleriesAction=show&show="+galid+"&to_prevent_cache="+(new Date).getTime(),function(){
					$("#galleriesPaneInner .insertTarget").html($("#galleriesAdmin").html());
					assignGalleryImagesKeys();
					$input.remove();
					$item.attr("name",val);
					$item.removeClass('editingThumb');
					$item.show().addClass('listItemHighlight');
					$(".overflowEllipsis",$item).html(msg);
					saved("Image Renamed");
					selectionTools();
				});
			  }
			});
		}
		if ($("#rightPaneSnippetCategories:visible").length) {
			working();
			var prodId = $(this).parent().attr('rel');
			var val = $(this).val();
			$.ajax({
			  type: "POST",
			  url: "snippetsActions.php",
			  data: "snippetsAction=renameCategory&id="+prodId+"&name="+encodeURIComponent($(this).val()),
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					$(".overflowEllipsis",$item).html(val);
					$item.show().addClass("listItemHighlight");
					$input.hide();
					$("#snippetCategoriesList a").remove();
					$("#snippetCategoriesPaneInner .responsiveListItem").each(function(){
						$("#snippetCategoriesList").append("<li><a snippet-cat-id=\""+$(this).attr("snippet-category-id")+"\" data-pinned='"+$(this).attr("data-pinned")+"' data-lang=\""+$(".overflowEllipsis",$(this)).html()+"\" data-item-value=\""+$(this).attr("snippet-category-id")+"\"><span class=\"overflowEllipsis\">"+$(".overflowEllipsis",$(this)).html()+"</span></a></li>");
					});

					saved("");
					$(".focus",$input).unbind();
					assignListLasso($("#snippetCategoriesPaneInner"));
					assignListPane($("#snippetCategoriesPaneInner"),editSnippetCategory);
					assignSnippetCategoriesKeys();
					//selectionTools();

			  }
			});
		}
	});
	$(document).unbind("click");
	$(document).unbind("keypress");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).keyup(function(e){
		if (e.keyCode==13) { // enter
			$(".focus",$input).blur();
			return false;
		}
		if (e.keyCode==27) { // enter
			$(".focus",$input).blur();
			return false;
		}
	});

}
function showInputOptions ($item,scrollToBottom) {
	$("#backToInputs").attr("form-id",$("#editFormName").attr("form-id"));
	hidePanes();

	$("input").unbind();
	$("#loadingMask").show();
	$(".assetPane").hide();

	$("#formInputOptionsPaneInner .insertTarget").html($(".inputOptions",$item).html());

	hidePaneTools();
	$("#rightPaneFormInputOptions .topBarTitle").html("<div><span>"+$item.attr("rel")+"</span></div>").attr("input-id",$item.attr("input-id"));
	//$("#rightPaneFormInputOptions").show();
	$("#formInputOptionsPaneInner").css("width","auto");
	showPane($("#rightPaneFormInputOptions"),false,true);


	$("#loadingMask").hide();
	assignListLasso($("#formInputOptionsPaneInner"));
	assignListPane($("#formInputOptionsPaneInner"),editInputOption);
	assignSortableListItems($("#formInputOptionsPaneInner"),"listItemHighlight","optionItem");
	assignFormInputOptionsKeys();
	setTimeout(function() {
		$("#formInputOptionsPaneInner").lovelyScroll();
	}, 350);
	if (scrollToBottom) {
		$("#formInputOptionsPaneInner .responsiveListItem:last").addClass("listItemHighlight");
		setTimeout(function() {
			var d = $("#formInputOptionsPaneInner .insertTarget").outerHeight()-$("#formInputOptionsPaneInner").innerHeight()+95;
			d = d-d-d;
			$("#formInputOptionsPaneInner").lovelyScrollMove(d);

			setTimeout(function() {
				selectionTools();
			}, 10);

		}, 360);
	}
}
function editProductOption ($item) {
	editMeListItem($item);
}
function editInputOption ($item) {
	editMeListItem($item);
}
function editInput ($item,secondaryAction) {
	if (secondaryAction===true) {
		editMeListItem($item);
		return false;
	}
	if ($item.hasClass("withOptions")) {
		showInputOptions($item,false);
	} else {
		editMeListItem($item);
	}
}
function duplicateFormInputs() {
	working();
	var Ids="[";
	$("#rightPaneFormInputs .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("input-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("input-id")+'"';
		}
	});
	Ids+="]";
	var showId = $("#rightPaneFormInputs .topBarTitle").attr("form-id");
	$.ajax({
	  type: "POST",
	  url: "formsActions.php",
	  data: "formsAction=duplicateInputs&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		if (msg=="ok") {

			$("#formsWrapper").load("formsActions.php?formsAction=show&to_prevent_cache="+(new Date).getTime(),function(){
				$("#formsPaneInner .insertTarget").html($("#formsWrapper").html());
				showFormInputs($("#formsPaneInner #form"+showId),false);
				cancelDialogue();
				saved("Form Removed");
			});

		} else {
			error(LangVars.Misc_Error);
		}

	  }
	});
}
function deleteInput () {
	working();
	var Ids="[";
	$("#rightPaneFormInputs .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("input-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("input-id")+'"';
		}
	});
	Ids+="]";
	var showId = $("#rightPaneFormInputs .topBarTitle").attr("form-id");

	$.ajax({
	  type: "POST",
	  url: "formsActions.php",
	  data: "formsAction=deleteInput&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		if (msg=="ok") {

			$("#formsWrapper").load("formsActions.php?formsAction=show&to_prevent_cache="+(new Date).getTime(),function(){
				$("#formsPaneInner .insertTarget").html($("#formsWrapper").html());
				showFormInputs($("#formsPaneInner #form"+showId),false);
				cancelDialogue();
				saved("Form Removed");
			});

		} else if (msg=="locked") {
			cancelDialogue();
			error(LangVars.Form_Locked);
		} else {
			error(LangVars.Misc_Error);
		}

	  }
	});
}
function addInput () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	hidePaneTools();
	$("#rightPaneFormInputs .noPages").hide();

	$("#rightPaneFormInputs .addInputForm").show();
	prepFancyLabelForms($("#rightPaneFormInputs .addInputForm"));
	$("#formInputsPaneInner").lovelyScroll();
	setTimeout(function () {
		var d = $("#formInputsPaneInner .insertTarget").outerHeight()-$("#formInputsPaneInner").innerHeight()+95;
		d = d-d-d;
		$("#formInputsPaneInner").lovelyScrollMove(d);
		$("#rightPaneFormInputs .addInputForm .focus").focus();
	}, 10);


	function saveOrCancel () {
		$("#rightPaneFormInputs .addInputForm .focus").unbind("blur").unbind();
		if ($("#rightPaneFormInputs .addInputForm .focus").val()=="" || $("#rightPaneFormInputs .addInputForm .focus").val()==" ") {
			resetAddForms();
			$("#rightPaneFormInputs .noPages").show();

		} else {
			working();
			showId = $(".selectedForm",$("#rightPaneFormInputs .addInputForm")).val();
			function showResponse (responseText, statusText) {
if (responseText =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if (responseText=="ok") {
					$("#formsWrapper").load("formsActions.php?formsAction=show&v="+(new Date).getTime(),function(){
						$("#formsPaneInner .insertTarget").html($("#formsWrapper").html());
						showFormInputs($("#formsPaneInner #form"+showId),true);

						saved("Input Added");
					});
				} else {
					error(LangVars.Misc_Error);
				}

			}
			var options = {
		        success:       showResponse  // post-submit callback
		    };

			$("#rightPaneFormInputs .addInputForm").ajaxSubmit(options);

		}
	}
	$("#rightPaneFormInputs .addInputForm").submit(function(){
		saveOrCancel();
		return false;
	});
	$("#rightPaneFormInputs .addInputForm .focus").unbind("blur").blur(function(){
		saveOrCancel();
		return false;
	});
	$(document).keydown(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});
}
function changeRequired (yesno) {
	var Ids="[";
	$("#rightPaneFormInputs .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("input-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("input-id")+'"';
		}
	});
	Ids+="]";
	var showId = $("#editFormName").attr("form-id");
	working();
	$.ajax({
	  type: "POST",
	  url: "formsActions.php",
	  data: "formsAction=changeRequired&ids="+Ids+"&required="+yesno,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

		$("#formsWrapper").load("formsActions.php?formsAction=show&showForm="+showId+"&to_prevent_cache="+(new Date).getTime(),function(){
			$("#formsPaneInner .insertTarget").html($("#formsWrapper").html());

			if (yesno=="yes") {
				$("#rightPaneFormInputs .listItemHighlight").attr("data-input-required","yes");
				$("#rightPaneFormInputs .listItemHighlight .asterix").show();
			} else {
				$("#rightPaneFormInputs .listItemHighlight").attr("data-input-required","");
				$("#rightPaneFormInputs .listItemHighlight .asterix").hide();
			}
			selectionTools();


			saved();
		});
	  }
	});
}
function changeInputWidth(width) {
	var Ids="[";
	$("#rightPaneFormInputs .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("input-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("input-id")+'"';
		}
	});
	Ids+="]";
	var showId = $("#editFormName").attr("form-id");
	working();
	$.ajax({
	  type: "POST",
	  url: "formsActions.php",
	  data: "formsAction=changeWidth&ids="+Ids+"&width="+width,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

		$("#formsWrapper").load("formsActions.php?formsAction=show&showForm="+showId+"&to_prevent_cache="+(new Date).getTime(),function(){
			//hidePaneTools();
			$("#formsPaneInner .insertTarget").html($("#formsWrapper").html());
			//showFormInputs($("#formsPaneInner #form"+showId),false);
			
			$("#rightPaneFormInputs .listItemHighlight").attr("data-input-width",width);
			selectionTools();
			saved();
		});
	  }
	});
}
function changeInputType (type) {
	var Ids="[";
	$("#rightPaneFormInputs .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("input-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("input-id")+'"';
		}
	});
	Ids+="]";
	var showId = $("#editFormName").attr("form-id");
	working();
	$.ajax({
	  type: "POST",
	  url: "formsActions.php",
	  data: "formsAction=changeType&ids="+Ids+"&type="+type,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

		$("#formsWrapper").load("formsActions.php?formsAction=show&showForm="+showId+"&to_prevent_cache="+(new Date).getTime(),function(){
			//hidePaneTools();
			$("#formsPaneInner .insertTarget").html($("#formsWrapper").html());
			//showFormInputs($("#formsPaneInner #form"+showId),false);
			if (type=="radiogroup"||type=="select") {
				$("#rightPaneFormInputs .listItemHighlight").addClass("withOptions");
			} else {
				$("#rightPaneFormInputs .listItemHighlight").removeClass("withOptions");
			}
			$("#rightPaneFormInputs .listItemHighlight").attr("data-input-type",type);
			$("#rightPaneFormInputs .listItemHighlight .itemTag").html($("#listOfInputTypes li a[data-item-value="+type+"]").attr("data-lang"));
			selectionTools();
			saved();
		});
	  }
	});

}
function addInputOption () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");
	$("#rightPaneFormInputOptions .noPages").hide();

	prepFancyLabelForms($("#rightPaneFormInputOptions .addOptionForm"));
	$("#rightPaneFormInputOptions").unbind("click");
	$("#rightPaneFormInputOptions .addOptionForm").show();
	setTimeout(function () {
		var d = $("#formInputOptionsPaneInner .insertTarget").outerHeight()-$("#formInputOptionsPaneInner").innerHeight()+95;
		d = d-d-d;
		$("#formInputOptionsPaneInner").lovelyScrollMove(d);
		$("#rightPaneFormInputOptions .addOptionForm .focus").focus();

	}, 10);
	function saveOrCancel () {
		$("#rightPaneFormInputOptions .addOptionForm .focus").unbind("blur");
		if ($("#rightPaneFormInputOptions .addOptionForm .focus").val()=="") {
			resetAddForms();
			$("#rightPaneFormInputOptions .noPages").show();
			return false;
		}
		working();
		var id = $("#editInputName").attr("input-id");
		$.ajax({
		  type: "POST",
		  url: "formsActions.php",
		  data: "formsAction=editInput&inputsId="+id+"&options="+encodeURIComponent($("#rightPaneFormInputOptions .addOptionForm .focus").val()),
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			$("#formsWrapper").load("formsActions.php?formsAction=show&showForm="+id+"&to_prevent_cache="+(new Date).getTime(),function(){
				$("#formsPaneInner .insertTarget").html($("#formsWrapper").html());
				setTimeout(function() {
					showInputOptions($("#formsPaneInner #input-"+id),true);
					saved();
				}, 10);

			});

		  }
		});
	}
	$("#rightPaneFormInputOptions .addOptionForm").submit(function(){
		saveOrCancel();
		return false;
	});
	$("#rightPaneFormInputOptions .addOptionForm .focus").unbind("blur").blur(function(){
		saveOrCancel();
		return false;
	});
	$("#rightPaneFormInputOptions input").keydown(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});
}
function addProductOption () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");
	hidePaneTools();
	$("#rightPaneProductOptions .noPages").hide();
	prepFancyLabelForms($("#rightPaneProductOptions .addProductOptionForm"));
	$("#rightPaneProductOptions .addProductOptionForm").show();
	var b = $("#productOptionsPaneInner .lovelyScrollContents").height() - $("#productOptionsPaneInner").height();
	$("#productOptionsPaneInner").lovelyScrollMove(-Math.abs(b));
	$("#rightPaneProductOptions .addProductOptionForm .focus").focus();
	$("#rightPaneProductOptions .listItemHighlight").removeClass("listItemHighlight");
	function saveOrCancel () {
		$("#rightPaneProductOptions .addProductOptionForm .focus").unbind("blur");
		var name = htmlentities($("#rightPaneProductOptions .addProductOptionForm .focus").val());
		if (name=="") {
			resetAddForms();

			if ($("#rightPaneProductOptions .responsiveListItem").length===0) {
				$("#rightPaneProductOptions .noPages").show();
			}
			return false;
		}
		if ($("#rightPaneProductOptions .topBarTitle").attr("options-separate-stock")=="yes") {
			$("#rightPaneProductOptions .addProductOptionForm").before("<div class=\"responsiveListItem productOption optionsSeparateStock\" name=\""+name+"\" data-discount-1-price=\"0.00\" data-discount-1-threshold=\"0\" data-discount-2-price=\"0.00\" data-discount-2-threshold=\"0\" data-option-price='0.00' product-option-stock='0' data-option-has-stock='yes'><span class=\"responsiveListItemInfo productOptionPrice\">"+$("#curSym").val()+"0.00</span><span class=\"responsiveListItemInfo productOptionStock\">0</span><span class=\"overflowEllipsis\" title=\""+name+"\">"+name+"</span></div><div class=\"dropzone\"><div></div></div>");
		} else {
			$("#rightPaneProductOptions .addProductOptionForm").before("<div class=\"responsiveListItem productOption\" name=\""+name+"\" data-discount-1-price=\"0.00\" data-discount-1-threshold=\"0\" data-discount-2-price=\"0.00\" data-discount-2-threshold=\"0\" data-option-price='0.00' product-option-stock='0' data-option-has-stock='no'><span class=\"responsiveListItemInfo productOptionPrice\">"+$("#curSym").val()+"0.00</span><span class=\"responsiveListItemInfo productOptionStock\">0</span><span class=\"overflowEllipsis\" title=\""+name+"\">"+name+"</span></div><div class=\"dropzone\"><div></div></div>");
		}


		updateProductOptions();
		assignListLasso($("#rightPaneProductOptions"));
		assignListPane($("#rightPaneProductOptions"),editInputOption);
		$("#productOptionsPaneInner").lovelyScroll();
		assignSortableListItems($("#productOptionsPaneInner"),"listItemHighlight","productOption");
		assignProductOptionsKeys();
		resetAddForms();
		$("#productOptionsPaneInner").lovelyScrollMove("-"+$("#productOptionsPaneInner").height());
		$("#productOptionsPaneInner .responsiveListItem:last").addClass("listItemHighlight");
		selectionTools();
	}
	$("#rightPaneProductOptions .addProductOptionForm .focus").unbind("blur").blur(function(){
		saveOrCancel();
		return false;
	});
	$(document).keyup(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});
	$(document).click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		saveOrCancel();
		return false;
	});
}
function deleteInputOption () {
	$("#rightPaneFormInputOptions .listItemHighlight").each(function(){
		$(this).next().remove();
		$(this).remove();
	});
	updateOptions(true);
	cancelDialogue();
}
function assignRightPanePaginate (url,data,wrapper) {
	var justFired = false;

	$(wrapper).unbind("scroll").scroll(function(){
		showHideMenusOnScroll($(this));
		justScrolled=true;
		if (scrollTimeout) {
			clearTimeout(scrollTimeout);
		}
		scrollTimeout = setTimeout(function() {
			justScrolled=false;
		},500);
		if (justFired) {
			return false;
		}
		setTimeout(function() {
			justFired=false;
		}, 500);
		justFired=true;
		var elem = $(wrapper);
		var inner = $(wrapper+' > div');

		var cutoff = inner.height()-250;
		if ( elem.scrollTop() + elem.height() >= cutoff) {
			working();
			var el = $(wrapper+" .showMoreItems");
			var start = parseInt(el.attr("href"));
			var $insertBefore = el.prev();
			var extra="";
			if (data.match("shopAction=showProducts")) {
				extra = "&filterCat="+filterProductsByCategory;
			}
			$.ajax({
			  type: "POST",
			  url: url,
			  data: data+start+extra,
			  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

				if (msg=="") {
				} else {
					if ($("body").hasClass("selectingAll")) {
						$insertBefore.before("<div id='highlightAfter'></div>");
					}

					$insertBefore.before(msg);
					if ($("body").hasClass("selectingAll")) {
						$("#highlightAfter").nextAll(".responsiveListItem").addClass("listItemHighlight");
						$("#highlightAfter").remove();
					}

					el.attr("href",start+50);

				}
				saved(true);

			  }
			});
  		}
	});
}
function assignRightPanePaginateEvent(url,data,wrapper) {
	var elem = $(wrapper);
	var inner = $(wrapper+' > div');
	working();
	var el = $(wrapper+" .showMoreItems");
	var start = parseInt(el.attr("href"));
	var $insertBefore = el.prev();
	var extra="";
	if (data.match("shopAction=showProducts")) {
		extra = "&filterCat="+filterProductsByCategory;
	}
	$.ajax({
	  type: "POST",
	  url: url,
	  data: data+start+extra,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		setTimeout(function() {
			scrollWaiting=false;
		}, 500);
		if (msg=="") {
		} else {
			if ($("body").hasClass("selectingAll")) {
				$insertBefore.before("<div id='highlightAfter'></div>");
			}

			$insertBefore.before(msg);
			if ($("body").hasClass("selectingAll")) {
				$("#highlightAfter").nextAll(".responsiveListItem").addClass("listItemHighlight");
				$("#highlightAfter").remove();
			}

			el.attr("href",start+50);
			setTimeout(function () {
				if (typeof myScroll[elem.attr("id")] !='undefined') {
					myScroll[elem.attr("id")].refresh();
				}

			}, 10);

		}
		saved(true);

	  }
	});

}
function deleteProducts () {
	var Ids="[";
	$("#rightPaneProducts .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("product-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("product-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=removeProduct&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#rightPaneProducts .listItemHighlight").each(function(){
			$(this).next().remove();
			$(this).remove();
			$("#productsPaneInner").lovelyScroll(pagesScrollBottomProducts);
			cancelDialogue();
			selectionTools();
			if ($("#rightPaneProducts .productItem").length===0) {
				$("#rightPaneProducts .noPages").show();
			}
		});
		saved();
	  }
	});
}
function deleteBookingProducts () {
	var Ids="[";
	$("#rightPaneBookingProducts .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("booking-product-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("booking-product-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=removeBookingProduct&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#rightPaneBookingProducts .listItemHighlight").each(function(){
			$(this).next().remove();
			$(this).remove();
			$("#bookingProductsPaneInner").lovelyScroll(pagesScrollBottomBookingProducts);
			cancelDialogue();
			selectionTools();
			if ($("#rightPaneBookingProducts .bookingProductItemMain").length===0) {
				$("#rightPaneBookingProducts .noPages").show();
			}
		});
		saved();
	  }
	});
}
function duplicateProducts () {
	if ($("body").hasClass("selectingAll")) {
		var Ids="[";
		$("#rightPaneProducts .productItemMain:not(.responsiveListItem.listItemHighlight)").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("product-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("product-id")+'"';
			}
		});
		Ids+="]";
		var selectingAll = "&selectingAll=true";
	} else {
		var selectingAll = "";
		var Ids="[";
		$("#rightPaneProducts .listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("product-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("product-id")+'"';
			}
		});
		Ids+="]";
	}
	working();
	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=duplicateProduct&ids="+Ids+"&filterCat="+filterProductsByCategory+selectingAll,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#productsPaneInner .insertTarget").load("shopActions.php?shopAction=showProducts&ajax=yes&filterCat="+filterProductsByCategory+"&initPane=yes&searchBy=",function(){
		var toHighlight = jQuery.parseJSON( msg );
		for (var i=0; i < toHighlight.length; i++) {
			$("#productsPaneInner div[product-id="+toHighlight[i]+"]").addClass("listItemHighlight");
		};
		setTimeout(function() {
			$("#productsPaneInner").lovelyScroll(pagesScrollBottomProducts);
		}, 300);

		assignDragAssets($("#productsPaneInner .insertTarget"));

		selectionTools();
		saved();
		});
	  }
	});
}
function duplicateBookingProducts () {
	if ($("body").hasClass("selectingAll")) {
		var Ids="[";
		$("#rightPaneBookingProducts .bookingProductItemMain:not(.responsiveListItem.listItemHighlight)").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("booking-product-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("booking-product-id")+'"';
			}
		});
		Ids+="]";
		var selectingAll = "&selectingAll=true";
	} else {
		var selectingAll = "";
		var Ids="[";
		$("#rightPaneBookingProducts .listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("booking-product-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("booking-product-id")+'"';
			}
		});
		Ids+="]";
	}
	working();
	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=duplicateBookingProduct&ids="+Ids+"&filterCat="+filterProductsByCategory+selectingAll,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#bookingProductsPaneInner .insertTarget").load("shopActions.php?shopAction=showBookingProducts&ajax=yes&initPane=yes&searchBy=",function(){
		var toHighlight = jQuery.parseJSON( msg );
		for (var i=0; i < toHighlight.length; i++) {
			$("#bookingProductsPaneInner div[booking-product-id="+toHighlight[i]+"]").addClass("listItemHighlight");
		};
		setTimeout(function() {
			$("#bookingProductsPaneInner").lovelyScroll(pagesScrollBottomProducts);
		}, 300);

		assignDragAssets($("#bookingProductsPaneInner .insertTarget"));

		selectionTools();
		saved();
		});
	  }
	});
}
function productSortBy (sortBy) {
	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=sortBy&sortBy="+sortBy,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#productsPaneInner .insertTarget").load("shopActions.php?shopAction=showProducts&ajax=yes&initPane=yes&filterCat="+filterProductsByCategory+"&searchBy=",function(){
			saved();
			assignProductsKeys();
			resetAddForms();
			$("#productsPaneInner").lovelyScroll(pagesScrollBottomProducts);
			assignDragAssets($("#productsPaneInner .insertTarget"));
		});

	  }
	});
}
function productSortReverse (reverse) {
	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=sortByReverse&reverse="+reverse,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#productsPaneInner .insertTarget").load("shopActions.php?shopAction=showProducts&ajax=yes&initPane=yes&filterCat="+filterProductsByCategory+"&searchBy=",function(){
			saved();
			assignProductsKeys();
			resetAddForms();
			$("#productsPaneInner").lovelyScroll(pagesScrollBottomProducts);
			assignDragAssets($("#productsPaneInner .insertTarget"));
		});

	  }
	});
}
function addProduct () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");
	$("#rightPaneProducts .noPages").hide();
	$("#rightPaneProducts #addProductForm").show();
	prepFancyLabelForms($("#rightPaneProducts #addProductForm"));
	$("#rightPaneProducts #addProductForm .focus").focus();
	function saveOrCancel () {
		$("#rightPaneProducts #addProductForm .focus").unbind("blur");
		if ($("#rightPaneProducts #addProductForm .focus").val()=="" || $("#rightPaneProducts #addProductForm .focus").val()==" ") {
			resetAddForms();
			if ($("#rightPaneProducts .productItem").length===0) {
				$("#rightPaneProducts .noPages").show();
			}


		} else {
			working();
			$.ajax({
			  type: "POST",
			  url: "shopActions.php",
			  data: "shopAction=addProduct&product_name="+encodeURIComponent($("#rightPaneProducts #addProductForm .focus").val())+"&filterCat="+filterProductsByCategory,
			  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#productsPaneInner .insertTarget").load("shopActions.php?shopAction=showProducts&ajax=yes&initPane=yes&filterCat="+filterProductsByCategory+"&searchBy=",function(){
				saved();
				assignProductsKeys();
				resetAddForms();
				$("#productsPaneInner").lovelyScroll(pagesScrollBottomProducts);
				$("#productsPaneInner .responsiveListItem:first").addClass("listItemHighlight");
				setTimeout(function() {
					selectionTools();
				}, 10);

				assignDragAssets($("#productsPaneInner .insertTarget"));

				});

			  }
			});
		}
	}
	$("#rightPaneProducts #addProductForm .focus").unbind("blur").blur(function(){
		saveOrCancel();
		return false;
	});
	$(document).keyup(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
	});
	$(document).keydown(function(e){
		if (e.keyCode==13) { // enter

			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});
}
function addBookingProduct() {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");
	$("#rightPaneBookingProducts .noPages").hide();
	$("#rightPaneBookingProducts #addBookingProductForm").show();
	prepFancyLabelForms($("#rightPaneBookingProducts #addBookingProductForm"));
	$("#rightPaneBookingProducts #addBookingProductForm .focus").focus();
	function saveOrCancel () {
		$("#rightPaneBookingProducts #addBookingProductForm .focus").unbind("blur");
		if ($("#rightPaneBookingProducts #addBookingProductForm .focus").val()=="" || $("#rightPaneBookingProducts #addBookingProductForm .focus").val()==" ") {
			resetAddForms();


		} else {
			working();
			$.ajax({
			  type: "POST",
			  url: "shopActions.php",
			  data: "shopAction=addBookingProduct&product_name="+encodeURIComponent($("#rightPaneBookingProducts #addBookingProductForm .focus").val()),
			  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#bookingProductsPaneInner .insertTarget").load("shopActions.php?shopAction=showBookingProducts&ajax=yes&initPane=yes",function(){
				saved();
				assignBookingProductsKeys();
				resetAddForms();
				$("#bookingProductsPaneInner").lovelyScroll(pagesScrollBottomProducts);
				$("#bookingProductsPaneInner .responsiveListItem:first").addClass("listItemHighlight");
				setTimeout(function() {
					selectionTools();
				}, 10);

				assignDragAssets($("#bookingProductsPaneInner .insertTarget"));

				});

			  }
			});
		}
	}
	$("#rightPaneBookingProducts #addBookingProductForm .focus").unbind("blur").blur(function(){
		saveOrCancel();
		return false;
	});
	$(document).keyup(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
	});
	$(document).keydown(function(e){
		if (e.keyCode==13) { // enter

			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});
}
function editProduct ($this,secondaryAction) {
	if(secondaryAction===true) {
		editMeListItem($this);
		return false;
	}
	if ($this.attr("data-product-type")=="simple_multi"||$this.attr("data-product-type")=="gallery_multi"||$this.attr("data-product-type")=="form_multi") {
		showProductOptions($this,false);
	} else {
		editMeListItem($this);
	}
}

function showBookingProdRates() {
	$("#bookingAvailability .bookingAvailabilityPriceLabel").remove();
	var id = $("#bookingAvailability").data("editing-product-id");
	var rates = $("#bookingprod"+id).data("rates");
	var c =0;
	var letters = new Array();
	letters[0] = "A";
	letters[1] = "B";
	letters[2] = "C";
	letters[3] = "D";
	letters[4] = "E";
	letters[5] = "F";
	var select = new Array();
	select.push("<option value=\"0\" data-name=\"\" data-price-normal=\"\" data-price-special=\"\" data-price-children=\"\" data-min-price=\"\">"+LangVars.Add_Rate+"</option>");
	$.each(rates,function(key,val){
		$("#bookingAvailabilityToolbarInner").prepend("<div class=\"bookingAvailabilityPriceLabel price"+letters[c]+"\" data-value=\"price-"+letters[c].toLowerCase()+"\" data-ratesid=\""+val['booking_products_ratesId']+"\" id=\"rate"+val['booking_products_ratesId']+"\">"+val['name']+"</div>");
		c++;
		select.push("<option value=\""+val['booking_products_ratesId']+"\" data-name=\""+val['name']+"\" data-price-normal=\""+val['price_normal']+"\" data-price-special=\""+val['price_special']+"\" data-price-children=\""+val['price_children']+"\" data-min-price=\""+val['minimum_price_per_place']+"\">"+val['name']+"</option>");
	});

	$("#chooseRates #chooseRatesSelect").html("<select>"+select.join("")+"</select>");

}
function editBookingProduct ($this,secondaryAction) {
	$("#manageBookingAvailabilityRates,#editRate,#addRate,#chooseRates").hide();
	if(secondaryAction===true) {
		editMeListItem($this);
		return false;
	} else {
		var rates= $this.data("rates");
		assignBookingCaledarKeys();
		$("#bookingAvailabilityInner").load("shopActions.php?shopAction=showBookingAvailability&booking_productsId="+$this.data("id"),function(){
			$("#bookingAvailability").data("editing-product-id",$this.data("id"));
			$("#bookingAvailability").data("editing-product-type",$this.data("item-type"));
			$("#bookingAvailability").data("editing-product-children-separate",$this.data("children-separate"));
			$("#bookingAvailability").data("editing-product-special-separate",$this.data("special-separate"));
			$("#bookingAvailability").data("editing-product-min-charge-per-space",$this.data("min-charge-per-space"));
			if (rates.length===0) {
				$("#manageBookingAvailabilityRates,#addRate").show();
				$("#availabilityRateNormalConcessions,#availabilityRateNormalChildren,#availabilityRateNormalMinPerSpace").parent().hide();
				$("#bookingProdTypeSeatOrSpace,#bookingProdTypeObject").hide();
				if ($this.data("item-type")=="1"||$this.data("item-type")=="2") {
					$("#bookingProdTypeSeatOrSpace").show();
					if ($this.data("children-separate")=="1") {
						$("#availabilityRateNormalChildren").parent().show();
					}
					if ($this.data("special-separate")=="1") {
						$("#availabilityRateNormalConcessions").parent().show();
					}
				} else {
					$("#bookingProdTypeObject").show();
				}
				if ($this.data("item-type")=="2") {
					if ($this.data("min-charge-per-space")=="1") {
						$("#availabilityRateNormalMinPerSpace").parent().show();
					}
				}

				$("#addEditRate .replace-with-space-name").each(function(){
					if ($this.data("item-type")=="2") {
						$(this).html($(this).data("original-string").replace("{*}",LangVars['Booking_Prod_Name_'+$("#pane-tools-booking-products div[data-test-data=place-name] li a.bpe_current").data("lang")].toLowerCase()));
					}
				});
			} else {
				showBookingProdRates();
				$(".availabilityMonth td").each(function(){
					if ($(this).data("rate")!=0) {
						$(this).addClass($("#rate"+$(this).data("rate")).data("value"));
					}
				});
			}
			$("#bookingAvailabilityOuter").show();
			setTimeout(function () {
			$("#bookingAvailability").addClass("visible");

			}, 5);
		});

	}
}
function showBookingDay () {
	var bookings = $("#bookings .current").data("bookings");
	var bookingsListA = new Array();

	if ($("#bookingsInner .current").length && $("#bookingsInner .current").attr("data-bookings")!="[]") {
		var product_name = "";
		var showtitle = false;
		for (var i = bookings.length - 1; i >= 0; i--) {
			var days = new Array();
			for (var x = bookings[i]['days'].length - 1; x >= 0; x--) {
				if (bookings[i]['days'][x]==$("#bookings .current").data("date")) {
					var c = 'class="currentDayInDays"';
				} else {
					var c = "";
				}
				days.push("<span "+c+">"+bookings[i]['days'][x]+"</span>");
			}
			var daysS = "";
			if (days.length) {
				daysS = '<div class="daysInBooking">'+days.join('')+'</div>';
			}
			var html = "";
			showtitle = false;
			if (bookings[i]['product_name']!=product_name) {
				product_name=bookings[i]['product_name'];
				showtitle = true;
			}
			if ($("#bookingsRight").hasClass="showingall"&&showtitle) {
				html += '<li class="clearfix bookingname">'+bookings[i]['product_name']+'</li>';				
			}
			var dayshtml = JSON.stringify(bookings[i]['days']);
			dayshtml = htmlentities(dayshtml);
			html += '<li data-buyer-id="'+bookings[i]['buyer_id']+'" class="clearfix" data-first-name="'+bookings[i]['first_name']+'" data-last-name="'+bookings[i]['last_name']+'" data-street="'+bookings[i]['last_name']+'" data-city="'+bookings[i]['city']+'" data-state="'+bookings[i]['state']+'" data-country="'+bookings[i]['country']+'" data-zip="'+bookings[i]['zip']+'" data-email="'+bookings[i]['payer_email']+'" data-phone="'+bookings[i]['phone']+'" data-paid="'+bookings[i]['paid']+'" data-qty="'+bookings[i]['normal']+'" data-qty-children="'+bookings[i]['children']+'" data-qty-special="'+bookings[i]['special']+'" data-days="'+dayshtml+'" data-order-id="'+bookings[i]['order_id']+'">';
			html += '<strong>'+bookings[i]['first_name']+' '+bookings[i]['last_name']+'</strong> <a href="mailto:'+bookings[i]['payer_email']+'">'+bookings[i]['payer_email']+'</a> '+bookings[i]['phone']+'<br/>';
			html += LangVars['Adults']+": "+bookings[i]['normal']+', '+LangVars['Children']+": "+bookings[i]['children']+', '+LangVars['Concessions']+": "+bookings[i]['special'];
			html += daysS;
//			html += '<div class="details" style="clear:both;display:none;">';
//			html += LangVars['Shipping_Address']+"<br/>";
//			html += bookings[i]['payer_email']+"<br/>";
//			html += bookings[i]['phone']+"<br/>";
//			html += '</div>';
			html += '</li>';
			bookingsListA.push(html);
		}

	}

	if (!$("#bookingsInner .current").length)  {
		$("#bookingsRightInner").html('<p class="noBookings">'+LangVars['No_Day_Selected']+'</p>');

	} else {
		$("#bookingsRightInner").html('<h2>'+$("#bookingsInner .current").data("local-date")+'</h2>');
		if (bookingsListA.length) {
			$("#bookingsRightInner").append('<ol>'+bookingsListA.join("")+'</ol>');
		} else {
			$("#bookingsRightInner").append('<p class="noBookings">'+LangVars['No_Bookings']+'</p>');
		}

	}



}
function deleteProductCategories ($item) {
	var Ids="[";
	$("#rightPaneProductCategories .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("product-category-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("product-category-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=deleteProductCategories&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#productCategoriesList").load("shopActions.php?shopAction=showProductCategories",function(){
			if ($("#productCategoriesList li").length==0) {
				$("#filterByProdCat").hide();
				$("#productCategoriesList").next().hide();
				$("#productCategoriesList").hide();
			}
			if ($("#rightPaneProductCategories .prodCatItem:not(.breadcrumbPage)").length===0) {
				$("#rightPaneProductCategories .noPages").show();
			}
			displayProdCats($("#rightPaneProductCategories").attr("showing-parent-id"),false);
			selectionTools();
			assignProductCategoriesKeys();
			cancelDialogue();
			saved();
			$("#productCategoriesPaneInner").lovelyScroll();
		});
	  }
	});

	cancelDialogue();
}
function displayProdCats (parentId,drillDown) {
	$("#rightPaneProductCategories").attr("showing-parent-id",parentId);
	$("#productCategoriesPaneInner .insertTarget").html("");
	var indent=0;
	if (parentId=="0") {
		$("#rightPaneProductCategories").removeAttr("prod-cats-breadcrumb");
		//$("#rightPaneProductCategories .topBarTitle .overflowEllipsis span").html($("#rightPaneProductCategories .topBarTitle").attr("original-text"));
	} else {
		//$("#rightPaneProductCategories .topBarTitle .overflowEllipsis span").html($("#productCategoriesList a[product-cat-id="+parentId+"] .overflowEllipsis").text());
		if (drillDown) {
			if ($("#rightPaneProductCategories").attr("prod-cats-breadcrumb")) {
				$("#rightPaneProductCategories").attr("prod-cats-breadcrumb",$("#rightPaneProductCategories").attr("prod-cats-breadcrumb")+","+parentId);
			} else {
				$("#rightPaneProductCategories").attr("prod-cats-breadcrumb",parentId);
			}
		}

		var parentIds = $("#rightPaneProductCategories").attr("prod-cats-breadcrumb").split(",");

		for (var i = 0; i < parentIds.length; i++) {
			$("#productCategoriesPaneInner .insertTarget").append("<div class='dropzone'><div></div></div>");
			indent=indent+50;
			$("#productCategoriesPaneInner .insertTarget").append("<div style='margin-left:"+indent+"px' class='responsiveListItem breadcrumbPage prodCatItem' product-category-id='"+parentIds[i]+"'><div class=\"showSubPages upLevel \" actual-id='"+parentIds[i]+"' id=\""+$("#productCategoriesList a[product-cat-id="+parentIds[i]+"]").attr("product-parent-id")+"\" title='"+LangVars.Back+"'>"+svgUp+"</div><span class='overflowEllipsis'>"+htmlentities($("#productCategoriesList a[product-cat-id="+parentIds[i]+"]").attr("data-lang"))+"</span></div><div class=\"responsiveListAddForm inline\" style='display:none;' action=\"\" method=\"post\" rel=\""+parentIds[i]+"\"><input type=\"text\" name=\"\" value=\""+htmlentities($("#productCategoriesList a[product-cat-id="+parentIds[i]+"]").attr("data-lang"))+"\" class=\"focus\"	/></div>");
			indent=indent+10;
		};

	}

	//$("#productCategoriesPaneInner .insertTarget").append($("#productsPaneInner #productCatsMenuList .iconbarAddProductCategory").first().clone().css("margin-left",indent+"px"));
	if (indent==0) {
		var mt = "10";
	} else {
		var mt = "22"
	}
	$("#productCategoriesPaneInner .insertTarget").append($("#productsPaneInner #productCatsMenuList .addProductCategory").first().clone().css("margin-left",indent+"px").css("margin-top",mt+"px"));
	$("#productCategoriesPaneInner .insertTarget").append("<div class='dropzone'><div></div></div>");
	hidePaneTools();

	var c = 0;
	$("#productCategoriesList a[product-parent-id="+parentId+"]").each(function(){
		var totalChildren = $("#productCategoriesList a[product-parent-id="+$(this).attr("product-cat-id")+"]").length;
		if (totalChildren!=0) {
			var cStr = '<div class="showSubPages" id="" title="'+LangVars.View_Add_Subpages+'">'+svgDown+'<span class="responsiveListItemInfo">'+totalChildren+'</span></div>';
		} else {
			var cStr = '<div class="showSubPages" id="" title="'+LangVars.View_Add_Subpages+'">'+svgDown+'</div>';
		}
		$("#productCategoriesPaneInner .insertTarget").append("<div style='margin-left:"+indent+"px' class='responsiveListItem prodCatItem' product-category-id='"+$(this).attr("product-cat-id")+"'>"+cStr+"<span class='overflowEllipsis'>"+htmlentities($(".overflowEllipsis",$(this)).html())+"</span></div><div class=\"responsiveListAddForm inline\" style='display:none;' action=\"\" method=\"post\" rel=\""+$(this).attr("product-cat-id")+"\"><input type=\"text\" name=\"\" value=\""+htmlentities($(".overflowEllipsis",$(this)).html())+"\" class=\"focus\"	/></div><div class='dropzone'><div></div></div>");
		c++;
	});
	if (c==0) {
		$("#productCategoriesPaneInner .insertTarget").append("<div class='noPages'>"+LangVars.No_Product_Categories+"</div>");

	}

	updateProdFilterMenu();


}
function updateProdFilterMenu () {
	if ($("#productCategoriesList a").length) {
		$("#rightPaneProducts .filterBar").show();
		$("#productsPaneInner").addClass("withFilterBar");
		$("#productFilterCategories").html("");
		$("#productCategoriesList a").each(function(){
			$("#productFilterCategories").append('<li><a href="#" class="filterBy filterLink" data-lang="'+htmlentities($(".overflowEllipsis",$(this)).html())+'" category-id="'+$(this).attr("product-cat-id")+'"><span>'+htmlentities($(".overflowEllipsis",$(this)).html())+'</span></a></li>');
		});
	} else {
		$("#rightPaneProducts .filterBar").hide();
		$("#productsPaneInner").removeClass("withFilterBar");
	}
}
function showProductOptions ($item,scrollToBottom) {

	hidePanes();
	$("input").unbind();
	$("#loadingMask").show();
	$(".assetPane").hide();
	hidePaneTools();
	$("#productOptionsPaneInner .insertTarget").html($(".productOptions",$item).html());
	if (scrollToBottom) {
		setTimeout(function() {
			$("#productOptionsPaneInner").scrollTop($("#productOptionsPaneInner .insertTarget").height());
		}, 10);
	}
	$("#rightPaneProductOptions .topBarTitle").html("<div><span>"+$item.attr("rel")+"</span></div>").attr("product-id",$item.attr("product-id")).attr("options-separate-stock",$item.attr("options-separate-stock"));
	//$("#rightPaneProductOptions").show();
	$("#productOptionsPaneInner").css("width","auto");
	showPane($("#rightPaneProductOptions"),false,true);

	$("#loadingMask").hide();

	assignListLasso($("#productOptionsPaneInner"));
	assignListPane($("#productOptionsPaneInner"),editProductOption);
	assignSortableListItems($("#productOptionsPaneInner"),"listItemHighlight","productOption");
	assignProductOptionsKeys();
	setTimeout(function() {$("#productOptionsPaneInner").lovelyScroll();}, 400);

}
function deleteProductOption () {
	$("#rightPaneProductOptions .listItemHighlight").each(function(){
		$(this).next().remove();
		$(this).remove();
	});
	if ($("#rightPaneProductOptions .responsiveListItem").length===0) {
		$("#rightPaneProductOptions .noPages").show();
	}
	$("#productOptionsPaneInner").lovelyScroll();
	updateProductOptions();
	hidePaneTools();
	cancelDialogue();
}
function updateProductOptions () {
	working();
	var variantsString="";
	var counter = 0;
	var title;
	var price;
	var stock;
	$("#rightPaneProductOptions .productOption").each(function(){
		title = htmlentities($(".overflowEllipsis",$(this)).text());
		price = $(".productOptionPrice",$(this)).html().replace(/[^0-9.]/,"");
		stock = $(".productOptionStock",$(this)).html().replace(/[^0-9.]/,"");
		var discounts = "";
		if ($(this).attr("data-discount-1-threshold")!='0') {
			discounts=discounts+";"+$(this).attr("data-discount-1-price")+"|"+$(this).attr("data-discount-1-threshold");
		}
		if ($(this).attr("data-discount-2-threshold")!='0') {
			discounts=discounts+";"+$(this).attr("data-discount-2-price")+"|"+$(this).attr("data-discount-2-threshold");
		}

		if (counter==0) {
			variantsString = title+"**::**"+price+discounts+"**::**"+stock;
		} else {
			variantsString = variantsString+"||**||"+title+"**::**"+price+discounts+"**::**"+stock;
		}
		counter++;
	});
	var id = $("#editProductName").attr("product-id");
	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=changeOptions&variants="+encodeURIComponent(variantsString)+"&id="+id,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

		if (msg=="ok") {
			saved();
		} else {
			error(LangVars.Misc_Error);
		}
	  }
	});
	$("#productsPaneInner .insertTarget #prod"+$("#editProductName").attr("product-id")+" .productOptions").html($("#productOptionsPaneInner .insertTarget").html());

}
function changeProductOptionStock (stock) {

	$("#rightPaneProductOptions .listItemHighlight").each(function(){
		$(".productOptionStock",$(this)).html(stock);
		$(this).attr("product-option-stock",stock);
	});
	selectionTools();
	updateProductOptions();
	cancelDialogue();
}
function changeProductOptionPrice (price) {
	var curSym = $("#curSym").val();
	price = parseFloat(price.replace(/[^\d.]/g, "")).toFixed(2);
	$("#rightPaneProductOptions .listItemHighlight").each(function(){
		$(".productOptionPrice",$(this)).html(curSym+price);
		$(this).attr("data-option-price",curSym+price);
	});
	selectionTools();
	updateProductOptions();
	cancelDialogue();
}

function changeProductPrice (price) {
	if ($("body").hasClass("selectingAll")) {
		var Ids="[";
		$("#rightPaneProducts .productItemMain:not(.responsiveListItem.listItemHighlight)").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("product-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("product-id")+'"';
			}
		});
		Ids+="]";
		var selectingAll = "&selectingAll=true";
	} else {
		var selectingAll = "";
		var Ids="[";
		$("#rightPaneProducts .listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("product-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("product-id")+'"';
			}
		});
		Ids+="]";
	}
	working();
	price = parseFloat(price.replace(/[^\d.]/g, "")).toFixed(2);
	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=renameProductPrice&ids="+Ids+"&price="+price+selectingAll+"&filterCat="+filterProductsByCategory,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#rightPaneProducts .listItemHighlight.productItemMain").each(function(){
			if ($(this).attr("data-product-type")=="donation" || $(this).attr("data-product-type")=="simple" || $(this).attr("data-product-type")=="gallery" || $(this).attr("data-product-type")=="form") {
				$(".productPrice",$(this)).html($("#curSym").val()+price);
				$(this).attr("product-price",price);
			}
		});
		selectionTools();
		cancelDialogue();

		saved();
	  }
	});
}
function changeProductSerialNumber (serialnumbers) {
	if ($("body").hasClass("selectingAll")) {
		var Ids="[";
		$("#rightPaneProducts .productItemMain:not(.responsiveListItem.listItemHighlight)").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("product-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("product-id")+'"';
			}
		});
		Ids+="]";
		var selectingAll = "&selectingAll=true";
	} else {
		var selectingAll = "";
		var Ids="[";
		$("#rightPaneProducts .listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("product-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("product-id")+'"';
			}
		});
		Ids+="]";
	}
	working();

	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=changeSerialNumbers&ids="+Ids+"&serialnumbers="+serialnumbers+selectingAll+"&filterCat="+filterProductsByCategory,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

		selectionTools();
		cancelDialogue();

		saved();
	  }
	});
}
function changeProductStock (stock) {
	if ($("body").hasClass("selectingAll")) {
		var Ids="[";
		$("#rightPaneProducts .productItemMain:not(.responsiveListItem.listItemHighlight)").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("product-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("product-id")+'"';
			}
		});
		Ids+="]";
		var selectingAll = "&selectingAll=true";
	} else {
		var selectingAll = "";
		var Ids="[";
		$("#rightPaneProducts .listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("product-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("product-id")+'"';
			}
		});
		Ids+="]";
	}
	working();
	stock = stock.replace(/[^\d.]/g, "")
	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=changeStock&ids="+Ids+"&stock="+stock+selectingAll+"&filterCat="+filterProductsByCategory,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#rightPaneProducts .listItemHighlight.productItemMain").each(function(){
			$(this).attr("product-stock",stock);
			$(".productStock",$(this)).html(stock);
			selectionTools();
		});
		cancelDialogue();
		saved();
	  }
	});
}

function changeProductWeight (weight) {
	if ($("body").hasClass("selectingAll")) {
		var Ids="[";
		$("#rightPaneProducts .productItemMain:not(.responsiveListItem.listItemHighlight)").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("product-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("product-id")+'"';
			}
		});
		Ids+="]";
		var selectingAll = "&selectingAll=true";
	} else {
		var selectingAll = "";
		var Ids="[";
		$("#rightPaneProducts .listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("product-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("product-id")+'"';
			}
		});
		Ids+="]";
	}
		working();
		weight = weight.replace(/[^\d.]/g, "")
		$.ajax({
		  type: "POST",
		  url: "shopActions.php",
		  data: "shopAction=changeWeight&ids="+Ids+"&weight="+weight+selectingAll+"&filterCat="+filterProductsByCategory,
		  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			$("#rightPaneProducts .listItemHighlight.productItemMain").each(function(){
				$(this).attr("product-weight",weight);
			});
			selectionTools();
			cancelDialogue();
			saved();
		  }
		});
}
function addProductVolumeDiscountMain(type) {
	if ($("body").hasClass("selectingAll")) {
		var Ids="[";
		$("#rightPaneProducts .productItemMain:not(.responsiveListItem.listItemHighlight)").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("product-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("product-id")+'"';
			}
		});
		Ids+="]";
		var selectingAll = "&selectingAll=true";
	} else {
		var selectingAll = "";
		var Ids="[";
		$("#rightPaneProducts .listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("product-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("product-id")+'"';
			}
		});
		Ids+="]";
	}
	var price = $("#popupVolumeDiscountPrice input").val()
	var threshold = $("#popupVolumeDiscountThreshold input").val();
	price = parseFloat(price.replace(/[^\d.]/g, "")).toFixed(2);
		working();
		$.ajax({
		  type: "POST",
		  url: "shopActions.php",
		  data: "shopAction=changeVolDiscount&discountNo="+type+"&ids="+Ids+"&price="+price+"&threshold="+threshold+selectingAll+"&filterCat="+filterProductsByCategory,
		  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			$("#rightPaneProducts .listItemHighlight.productItemMain").each(function(){
				$(this).attr("data-discount-"+type+"-price",price);
				$(this).attr("data-discount-"+type+"-threshold",threshold);
			});
			selectionTools();
			cancelDialogue();
			saved();
		  }
		});
}
function addProductVolumeDiscount() {
	addProductVolumeDiscountMain('1');
}
function addProductVolumeDiscount2() {
	addProductVolumeDiscountMain('2');
}
function addProductOptionsVolumeDiscountMain(type) {

	var price = $("#popupVolumeDiscountPrice input").val()
	var threshold = $("#popupVolumeDiscountThreshold input").val();
	price = parseFloat(price.replace(/[^\d.]/g, "")).toFixed(2);

	$("#rightPaneProductOptions .listItemHighlight").each(function(){
		$(this).attr("data-discount-"+type+"-price",price);
		$(this).attr("data-discount-"+type+"-threshold",threshold);
	});
	selectionTools();
	updateProductOptions();
	cancelDialogue();
}
function addProductOptionsVolumeDiscount() {
	addProductOptionsVolumeDiscountMain('1');
}
function addProductOptionsVolumeDiscount2() {
	addProductOptionsVolumeDiscountMain('2');
}
function changeSeparateOptionsStock () {
	if ($("#productChangeSeparateOptionsStock").hasClass("bpe_current")) {
		var separateOptionsStock="no";
	} else {
		var separateOptionsStock="yes";
	}
	if ($("body").hasClass("selectingAll")) {
		var Ids="[";
		$("#rightPaneProducts .productItemMain:not(.responsiveListItem.listItemHighlight)").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("product-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("product-id")+'"';
			}
		});
		Ids+="]";
		var selectingAll = "&selectingAll=true";
	} else {
		var selectingAll = "";
		var Ids="[";
		$("#rightPaneProducts .listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("product-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("product-id")+'"';
			}
		});
		Ids+="]";
	}
	working();
	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=separateOptionsStock&ids="+Ids+"&separateOptionsStock="+separateOptionsStock+selectingAll+"&filterCat="+filterProductsByCategory,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#rightPaneProducts .listItemHighlight").each(function(){
			$(this).attr("options-separate-stock",separateOptionsStock);
			$(".productOption",$(this)).attr("data-option-has-stock",separateOptionsStock);
			if (separateOptionsStock=="yes") {
				$(".insertProduct,.productOption",$(this)).addClass("optionsSeparateStock");
			} else {
				$(".insertProduct,.productOption",$(this)).removeClass("optionsSeparateStock");
			}
		});
		selectionTools();
		hide_iconbar_menus();
		saved();
	  }
	});
}
function changeOnlyOne () {
	if ($("#productChangeOnlyOne").hasClass("bpe_current")) {
		var onlyOne="no";
	} else {
		var onlyOne="yes";
	}
	if ($("body").hasClass("selectingAll")) {
		var Ids="[";
		$("#rightPaneProducts .productItemMain:not(.responsiveListItem.listItemHighlight)").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("product-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("product-id")+'"';
			}
		});
		Ids+="]";
		var selectingAll = "&selectingAll=true";
	} else {
		var selectingAll = "";
		var Ids="[";
		$("#rightPaneProducts .listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("product-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("product-id")+'"';
			}
		});
		Ids+="]";
	}
	working();
	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=onlyOne&ids="+Ids+"&onlyOne="+onlyOne+selectingAll+"&filterCat="+filterProductsByCategory,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#rightPaneProducts .listItemHighlight").each(function(){
			$(this).attr("only-one",onlyOne);
		});
		selectionTools();
		hide_iconbar_menus();
		saved();
	  }
	});
}
function editProductCategory ($clicked) {
	editMeListItem($clicked);
	return false;
}
function addProductCategory () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");
	$("#rightPaneProductCategories .noPages").hide();
	$("#rightPaneProductCategories .addProductCategory").show();
	prepFancyLabelForms($("#rightPaneProductCategories .addProductCategory"));
	$("#rightPaneProductCategories .addProductCategory .focus").focus();
	function saveOrCancel () {
		$("#rightPaneProductCategories .addProductCategory .focus").unbind("blur");
		if ($("#rightPaneProductCategories .addProductCategory .focus").val()=="" || $("#rightPaneProductCategories .addProductCategory .focus").val()==" ") {
			resetAddForms();
			if ($("#rightPaneProductCategories .prodCatItem:not(.breadcrumbPage)").length===0) {
				$("#rightPaneProductCategories .noPages").show();
			}
		} else {
			working();
			var parentId = $("#rightPaneProductCategories").attr("showing-parent-id");


			$.ajax({
			  type: "POST",
			  url: "shopActions.php",
			  data: "shopAction=addProductCategory&parent_id="+parentId+"&name="+encodeURIComponent($("#rightPaneProductCategories .addProductCategory .focus").val()),
			  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#filterByProdCat").show();
				$("#productCategoriesList").next().show();
				$("#productCategoriesList").show().load("shopActions.php?shopAction=showProductCategories",function(){
				saved();



				displayProdCats(parentId,false);
				$("#productCategoriesPaneInner .responsiveListItem:first").addClass("listItemHighlight");
				$("#productCategoriesPaneInner").lovelyScroll();
				assignProductCategoriesKeys();
				selectionTools();
				resetAddForms();
				});

			  }
			});
		}
	}
	$("#rightPaneProductCategories .addProductCategory .focus").unbind("blur").blur(function(){
		saveOrCancel();
		return false;
	});
	$(document).keyup(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
	});
	$(document).keydown(function(e){
		if (e.keyCode==13) { // enter

			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});

}
function setTicksInProdCatsMenu () {
	$("#productCategoriesList a").removeClass("bpe_current");
	var $el=$("#rightPaneProducts .listItemHighlight");
	if ($el.length==1) {
		$("#productCategoriesList a").each(function(){
			if ($('input#cat'+$(this).attr("product-cat-id"),$el).length) {
				$(this).addClass("bpe_current");
			}
		});
	}

}
function setTicksInTypeMenu () {
	/*
		$("#changeProductTypeSimple,#changeProductTypeGallery,#changeProductTypeForm,#changeProductTypeDonation,#productChangeOnlyOne,#changeProductTypeMulti,#productChangeSellIfInStock").removeClass("bpe_current");
		var type = $("#rightPaneProducts .listItemHighlight.productItemMain:first").attr("product-type");
		var onlyOne = $("#rightPaneProducts .listItemHighlight.productItemMain:first").attr("only-one");
		var sellOnlyIfStock = $("#rightPaneProducts .listItemHighlight.productItemMain:first").attr("product-sell-only-if-stock");
		var allTheSame=true;
		var allTheSameOnlyOne = true;
		var allTheSameSellOnlyIfStock = true;
		$("#rightPaneProducts .listItemHighlight.productItemMain").each(function(){
			if ($(this).attr("product-type")!=type) {
				allTheSame=false;
			}
			if ($(this).attr("product-sell-only-if-stock")!=sellOnlyIfStock) {
				allTheSameSellOnlyIfStock=false;
			}
			if ($(this).attr("only-one")!=onlyOne) {
				allTheSameOnlyOne=false;
			}
		});
		$("#productChooseForm").prev().hide();
		$("#productChooseGallery").prev().hide();
		$("#productChooseForm").hide();
		$("#productChooseGallery").hide();
		if (allTheSame) {
			if (type=="simple" || type=="simple_multi") {
				$("#changeProductTypeSimple").addClass("bpe_current");
			}

			if (type=="gallery" || type=="gallery_multi") {
				$("#changeProductTypeGallery").addClass("bpe_current");
				$("#productChooseGallery").show();
				$("#productChooseGallery").prev().show();
			}
			if (type=="form" || type=="form_multi") {
				$("#changeProductTypeForm").addClass("bpe_current");
				$("#productChooseForm").show();
				$("#productChooseForm").prev().show();
			}
			$("#changeProductTypeMulti").show();
			$("#changeProductTypeMulti").prev().show();
			if (type=="form") {
				//$("#changeProductTypeMulti").hide();
				//$("#changeProductTypeMulti").prev().hide();
			}
			if (type=="donation") {
				$("#changeProductTypeDonation").addClass("bpe_current");
				$("#changeProductTypeMulti").hide();
				$("#changeProductTypeMulti").prev().hide();
			}
			if (type=="gallery_multi" || type=="form_multi" || type=="simple_multi") {
				$("#changeProductTypeMulti").addClass("bpe_current");
			}
		}
		if (allTheSameOnlyOne) {
			if (onlyOne=="yes") {
				$("#productChangeOnlyOne").addClass("bpe_current");
			}
		}
		if (allTheSameSellOnlyIfStock) {
			if (sellOnlyIfStock=="1") {
				$("#productChangeSellIfInStock").addClass("bpe_current");
			}
		}
		if (!$("#chooseFormsList a").length) {
			$("#changeProductTypeForm").addClass("greyedOut");
		}
		if (!$("#chooseGalleriesList a").length) {
			$("#changeProductTypeGallery").addClass("greyedOut");
		}
		*/
}
function changeProductType (type,chosenId) {
	if ($("body").hasClass("selectingAll")) {
		var Ids="[";
		$("#rightPaneProducts .productItemMain:not(.responsiveListItem.listItemHighlight)").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("product-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("product-id")+'"';
			}
		});
		Ids+="]";
		var selectingAll = "&selectingAll=true";
	} else {
		var selectingAll = "";
		var Ids="[";
		$("#rightPaneProducts .listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("product-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("product-id")+'"';
			}
		});
		Ids+="]";
	}

	working();

	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=changeType&ids="+Ids+"&type="+type+"&chosenId="+chosenId+selectingAll+"&filterCat="+filterProductsByCategory,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#rightPaneProducts .listItemHighlight").each(function(){
			$(".productItem",$(this)).removeClass("type_donation type_simple type_simple_multi type_gallery type_gallery_multi type_form type_form_multi");
			if (type=="multiyes") {
				if ($(this).attr("data-product-type")=="simple") {
					$(this).attr("data-product-type","simple_multi");
					$(".productItem",$(this)).addClass("type_simple_multi");
				}
				if ($(this).attr("data-product-type")=="gallery") {
					$(this).attr("data-product-type","gallery_multi");
					$(".productItem",$(this)).addClass("type_gallery_multi");
				}
				if ($(this).attr("data-product-type")=="form") {
					$(this).attr("data-product-type","form_multi");
					$(".productItem",$(this)).addClass("type_form_multi");
				}
			} else if (type=="multino") {
				if ($(this).attr("data-product-type")=="simple_multi") {
					$(this).attr("data-product-type","simple");
					$(".productItem",$(this)).addClass("type_simple");
				}
				if ($(this).attr("data-product-type")=="gallery_multi") {
					$(this).attr("data-product-type","gallery");
					$(".productItem",$(this)).addClass("type_gallery");
				}
				if ($(this).attr("data-product-type")=="form_multi") {
					$(this).attr("data-product-type","form");
					$(".productItem",$(this)).addClass("type_form");
				}
			} else {
				if ($(this).attr("data-product-type")=="simple_multi" || $(this).attr("data-product-type")=="gallery_multi" || $(this).attr("data-product-type")=="form_multi") {
					if (type=="gallery") {
						$(this).attr("data-product-type","gallery_multi");
						$(".productItem",$(this)).addClass("type_gallery_multi");
					}
					if (type=="form") {
						$(this).attr("data-product-type","form_multi");
						$(".productItem",$(this)).addClass("type_form_multi");
					}
					if (type=="simple") {
						$(this).attr("data-product-type","simple_multi");
						$(".productItem",$(this)).addClass("type_simple_multi");
					}
					if (type=="donation") {
						$(this).attr("data-product-type","donation");
						$(".productItem",$(this)).addClass("type_donation");
					}
				} else {
					$(this).attr("data-product-type",type);

				}
				if (type=="gallery"||type=="gallery_multi") {
					$(this).attr("data-gal-id",chosenId);
				}
				if (type=="form"||type=="form_multi") {
					$(this).attr("data-form-id",chosenId);
				}
			}
			selectionTools();
		});
		//hide_iconbar_menus();
		saved();
	  }
	});
}
function changeTypeMultiYes () {
	changeProductType("multiyes","");
}
function changeTypeMultiNo () {
	changeProductType("multino","");
}
function changeProductHasOptions (yesno) {
	var allElligible = true;
	$("#rightPaneProducts .listItemHighlight").each(function(){
		if ($(this).attr("data-product-type")=="donation"||$(this).attr("data-product-type")=="digital")  {
			allElligible = false;
		}
	});
	if (allElligible) {
		if (yesno=="yes") {
			changeTypeMultiYes();
		} else {
			changeTypeMultiNo();
		}
	} else {
		if (yesno=="yes") {
			prepDialogue("<h2>"+LangVars.Confirm_Multi+"</h2><p>"+LangVars.Confirm_Multi_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Yes,changeTypeMultiYes,false,true,false,"");
		} else {
			changeTypeMultiNo();
		}

	}
}
function editCalendar ($item) {
	showCalendarEvents($item,false);
}
function addCalendar () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");
	$("#rightPaneCalendars .noPages").hide();
	$("#rightPaneCalendars #addCalendarForm").show();
	prepFancyLabelForms($("#rightPaneCalendars #addCalendarForm"));
	$("#rightPaneCalendars #addCalendarForm .focus").focus();
	function saveOrCancel () {
		$("#rightPaneCalendars #addCalendarForm .focus").unbind("blur");
		if ($("#rightPaneCalendars #addCalendarForm .focus").val()=="" || $("#rightPaneCalendars #addCalendarForm .focus").val()==" ") {
			resetAddForms();

			if ($("#rightPaneCalendars .calendarItem").length===0) {
				$("#rightPaneCalendars .noPages").show();
			}
		} else {
			working();
			$.ajax({
			  type: "POST",
			  url: "calendarActions.php",
			  data: "calendarAction=addCat&name="+encodeURIComponent($("#rightPaneCalendars #addCalendarForm .focus").val()),
			  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					$("#rightPaneCalendars #addCalendarForm .focus").val("");
					$("#rightPaneCalendars #addCalendarForm .focus").unbind();
					$("#rightPaneCalendars #addCalendarForm").hide();
					$("#calendarsPaneInner .insertTarget").html(msg);
					$("#calendarsPaneInner .insertTarget .calendarItem:first").addClass("listItemHighlight");
					assignDragAssets($("#calendarsPaneInner .insertTarget"));
					resetAddForms();
					$("#calendarsPaneInner").lovelyScroll();
					selectionTools();
					saved();
			  }
			});
		}
	}
	$("#rightPaneCalendars #addCalendarForm .focus").unbind("blur").blur(function(){
		saveOrCancel();
		return false;
	});
	$(document).keyup(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
	});
	$(document).keydown(function(e){
		if (e.keyCode==13) { // enter

			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});
}
function deleteCalendars () {
	var Ids="[";
	$("#rightPaneCalendars .calendarItem.listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("rel")+'"';
		} else {
		Ids+=',"'+$(this).attr("rel")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "calendarActions.php",
	  data: "calendarAction=deleteCat&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#rightPaneCalendars .listItemHighlight").each(function(){
			$(this).next().remove();
			$(this).remove();
		});
		if ($("#rightPaneCalendars .calendarItem").length===0) {
			$("#rightPaneCalendars .noPages").show();
		}
		$("#calendarsPaneInner").lovelyScroll();
		cancelDialogue();
		selectionTools();
		saved();
	  }
	});
}
function editCalendarEvents ($item) {
	editMeListItemMultiple($item);
}
function showCalendarEvents ($item,scrollToBottom) {
	hidePanes();
	$("input").unbind();
	$("#loadingMask").show();
	$(".assetPane").hide();
	working();
	$("#eventsCustomFields").load("calendarActions.php?calendarAction=showCustomFields&categoryid="+$item.attr("rel"),function(){

	});
	$("#calendarEventsDateFilter").load("/actions/ShowCal/?showCat="+$item.attr("rel"),function(){
		$("#eventsGroupsList").load("calendarActions.php?calendarAction=showGroups&belongsToCal="+$("#calendarEventsDateFilter #showing_cat").val(),function(){
			if ($("#eventsGroupsList li").length==0) {
//				$("#filterBySubscriberCat").hide();
				$("#eventsGroupsList").next().hide();
				$("#eventsGroupsList").hide();
			} else {
//				$("#filterBySubscriberCat").show();
				$("#eventsGroupsList").next().show();
				$("#eventsGroupsList").show();
			}
	//		updateSubscriberCatFilterMenu();
		});
		
		$("#calendarEventsDateFilterButton").html($("#calendarEventsDateFilter #current_day").val()+" "+$("#calendarEventsDateFilter #current_month_text").val()+" "+$("#calendarEventsDateFilter #current_year").val());
		$("#rightPaneCalendarEvents .topBarTitle").html("<div><span>"+$item.attr("title")+"</span></div>").attr("cal-id",$item.attr("rel"));
		$target = $("#rightPaneCalendarEvents .selectedDay");
		if ($(".eventList .eventItem",$target).length) {
			$("#calendarEventsPaneInner .insertTarget").html($(".eventList",$target).html());
		} else {
			$("#calendarEventsPaneInner .insertTarget").html($(".eventList",$target).html()+"<div class='noPages'>"+LangVars.There_Are_No_Events_For+" "+$target.attr("day")+" "+$("#calendarEventsDateFilter #current_month_text").val()+" "+$("#calendarEventsDateFilter #current_year").val()+"</div>");
		}
		hideCutEvents();

		//$("#rightPaneCalendarEvents").show();
		$("#calendarEventsPaneInner").css("width","auto");
		showPane($("#rightPaneCalendarEvents"),false,true);

		setTimeout(function() {$("#calendarEventsPaneInner").lovelyScroll();}, 400);
		$("#loadingMask").hide();

		saved();
	});
	if (scrollToBottom) {
		setTimeout(function() {
			$("#calendarEventsPaneInner").scrollTop($("#calendarEventsPaneInner .insertTarget").height());
		}, 10);
	}


	assignListLasso($("#rightPaneCalendarEvents"));
	assignListPane($("#rightPaneCalendarEvents .insertTarget"),editCalendarEvents);
	assignCalendarEventsKeys();
	selectionTools();
}
function hideCutEvents() {
	if (readCookie("eventsCut")) {
		var ids = JSON.parse(readCookie("eventsCut"));
		for (var i = 0; i < ids.length; i++) {
			$("#calendarEventsPaneInner .eventItem[event-id=\""+ids[i]+"\"]").hide().next().hide().next().hide();
		}

	}
};
function addEvent () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");
	hide_header_menus();
		$("#calendarEventsPaneInner .noPages").hide();
	$("#calendarEventsPaneInner .eventForm").show();
	$("#calendarEventsPaneInner .eventForm .focus").focus();

	$("#calendarEventsPaneInner .eventForm .imageContextEditLabel").css("visibility","visible");
	$(".imageContextEditFieldset",$("#calendarEventsPaneInner .eventForm")).each(function(){
		if ($("input",$(this)).val()==""){
			$(".imageContextEditLabel",$(this)).css("visibility","visible");
		}
	});
	$(".imageContextEditFieldset input",$("#calendarEventsPaneInner .eventForm")).unbind("keyup").keyup(function(){
		if ($(this).val()!="") {
			$(".imageContextEditLabel",$(this).parents(".imageContextEditFieldset")).css("visibility","hidden");
		} else {
			$(".imageContextEditLabel",$(this).parents(".imageContextEditFieldset")).css("visibility","visible");
		}
	});

	$(".linkField input",$("#calendarEventsPaneInner .eventForm")).val("").focus(function(){
		if (!$("#insertLinkToDownload").length) {
			$(this).parents(".imageContextEditFieldset").after("<span id='insertInteralLinksInline' class='clearfix'><span id='insertLinkToPage'>"+LangVars.Insert_Link_To_Page+"</span><span id='insertLinkToDownload'>"+LangVars.Insert_Link_To_File+"</span></span>");
			$("#insertLinkToPage").click(function(){
				$(".linkField input",$("#calendarEventsPaneInner .eventForm")).blur();
				showLightPages(updateEventLinkValNew,"showTop",true,LangVars.Choose_page);
			});
			$("#insertLinkToDownload").click(function(){
				$(".linkField input",$("#calendarEventsPaneInner .eventForm")).blur();
				showDownloadPopdown(updateEventLinkValNew);
			});
		}
	});
	$(".focus",$("#calendarEventsPaneInner .eventForm")).focus(function(){
		$("#insertLinkToPage").parent().remove();
	});
	$("#calendarEventsPaneInner .eventForm").click(function(){
		return false;
	});
	$("#rightPaneCalendarEvents").unbind("click").click(function(){
		saveOrCancel();
		return false;
	});

	function saveOrCancel () {
		if ($(".bpe_mask_small").length) {
			return false;
		}
		if ($("#lightPagesList").length) {
			$("#lightPagesOuter").animate({opacity:"0"},550,function(){
				$("#lightPagesOuter").remove();
			});
			return false;
		}
		if ($("#downloadsPopdown").length) {
			var minus = $("#downloadsPopdown").height();
			$("#downloadsPopdown").animate({top:"-"+minus+"px"},550,function(){
				$("#downloadsPopdownOuter").remove();
			});
			return false;
		}
		if ($("#calendarEventsPaneInner .eventForm .focus").val()=="" || $("#calendarEventsPaneInner .eventForm .focus").val()==" ") {
			resetAddForms();
			$("#calendarEventsPaneInner .noPages").show();

		} else {
			working();

			var title = $(".focus",$("#calendarEventsPaneInner .eventForm")).val();
			var link = $(".eventLink",$("#calendarEventsPaneInner .eventForm")).val();
			var date = $(".dateInput",$("#calendarEventsPaneInner .eventForm")).val();
			var splitd = date.split("/");
			var showCatId = $("#calendarEventsDateFilter #showing_cat").val();

			var showCatString = "&showCat="+showCatId;
			var addToCatString = "&addToCat="+showCatId;


			if (title=="") {
				return false;
			} else {
				$.ajax({
				  type: "POST",
				  url: "calendarActions.php",
				  data: "calendarAction=addEvent&name="+encodeURIComponent(title)+"&link="+encodeURIComponent(link)+"&date="+date+addToCatString,
				  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					month = splitd[1];
					year = splitd[2];
					day = splitd[0];
					$("#calendarEventsDateFilter").load("/actions/ShowCal/?month="+month+"&year="+year+"&day="+day+showCatString,function(){
						
						$("#calendarEventsPaneInner .eventForm .focus").val("");
						$("#calendarEventsPaneInner .eventForm .focus").unbind();
						$("#calendarEventsPaneInner .eventForm").hide();

						$target = $("#rightPaneCalendarEvents .selectedDay");
						$("#calendarEventsPaneInner .insertTarget").html($(".eventList",$target).html());
						setTimeout(function() {$("#calendarEventsPaneInner").lovelyScroll();}, 400);
						
						setTimeout(function() {
							$("#calendarEventsPaneInner .insertTarget .eventItem:first").addClass("listItemHighlight");
							$(".addEventFake").unbind().click(function(){
								addEvent();
								return false;
							});
							assignListLasso($("#rightPaneCalendarEvents"));
							assignListPane($("#rightPaneCalendarEvents .insertTarget"),editCalendarEvents);
							assignCalendarEventsKeys();
							selectionTools();
							
						}, 10);

						saved();
					});
				  }
				});
			}

		}
	}

	$(document).keyup(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
	});
	$(document).keydown(function(e){
		if (e.keyCode==13) { // enter

			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});

	$(document).click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		saveOrCancel();
		return false;
	});
}
function importEventsCSV(text) {
	working();
	var showCatId = $("#calendarEventsDateFilter #showing_cat").val();

	$.ajax({
	  type: "POST",
	  url: "calendarActions.php",
	  data: "calendarAction=importCSV&csv="+encodeURIComponent(text)+"&categoryid="+showCatId,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		var date = $(".dateInput",$("#calendarEventsPaneInner .eventForm")).val();
		var splitd = date.split("/");
		month = splitd[1];
		year = splitd[2];
		day = splitd[0];

		$("#calendarEventsDateFilter").load("/actions/ShowCal/?month="+month+"&year="+year+"&day="+day+"&showCat="+showCatId,function(){

			$("#calendarEventsPaneInner .eventForm .focus").val("");
			$("#calendarEventsPaneInner .eventForm .focus").unbind();
			$("#calendarEventsPaneInner .eventForm").hide();

			$target = $("#rightPaneCalendarEvents .selectedDay");
			$("#calendarEventsPaneInner .insertTarget").html($(".eventList",$target).html());
			
			setTimeout(function() {$("#calendarEventsPaneInner").lovelyScroll();}, 400);

			setTimeout(function() {
			//	$("#calendarEventsPaneInner .insertTarget .eventItem:first").addClass("listItemHighlight");
				$(".addEventFake").unbind().click(function(){
					addEvent();
					return false;
				});
							hideCutEvents();
				assignListLasso($("#rightPaneCalendarEvents"));
				assignListPane($("#rightPaneCalendarEvents .insertTarget"),editCalendarEvents);
				assignCalendarEventsKeys();
				selectionTools();
			}, 10);

			saved();
		});
		reloadCalendar();
		cancelDialogue();
		selectionTools();

	   }
	});
}
function addEventCustomField(text) {
	working();
	var showCatId = $("#calendarEventsDateFilter #showing_cat").val();
	
	$.ajax({
	  type: "POST",
	  url: "calendarActions.php",
	  data: "calendarAction=addCustomField&name="+encodeURIComponent(text)+"&categoryid="+showCatId,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			$("#eventsCustomFields").load("calendarActions.php?calendarAction=showCustomFields&categoryid="+showCatId,function(){
				reloadCalendar();
				cancelDialogue();
				selectionTools();
			});
	   }
	});
}
function deleteCalendarEvents () {
	var Ids="[";
	$("#calendarEventsPaneInner .eventItem.listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("event-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("event-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "calendarActions.php",
	  data: "calendarAction=deleteEvent&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#calendarEventsPaneInner .eventItem.listItemHighlight").each(function(){
			$(this).next().remove();
			$(this).next().remove();
			$(this).remove();

			var date = $(".dateInput",$("#calendarEventsPaneInner .eventForm")).val();
			var splitd = date.split("/");
			month = splitd[1];
			year = splitd[2];
			day = splitd[0];

			if ($("#calendarEventsPaneInner .eventItem").length=="0") {
				$("#calendarEventsPaneInner .insertTarget").append("<div class='noPages'>"+LangVars.There_Are_No_Events_For+" "+day+" "+month+" "+year+"</div>");

			}
			reloadCalendar();
			cancelDialogue();
			selectionTools();
		});
	  }
	});
}
function updateEventLinkValNew ($clicked) {
	var linkVal = $clicked.attr("alt");
	$("#calendarEventsPaneInner .eventForm .eventLink").val(linkVal);
	$(".imageContextEditLabel",$("#calendarEventsPaneInner .eventForm .eventLink").parents(".imageContextEditFieldset")).css("visibility","hidden");
	$("#insertLinkToPage").parent().remove();
	hidePopdownOrPassthroughSave(false);
}
function updateEventLinkVal ($clicked) {
	var linkVal = $clicked.attr("alt");
	$("#calendarEventsPaneInner .editEventForm:visible .eventLink").val(linkVal);
	$(".imageContextEditLabel",$("#calendarEventsPaneInner .editEventForm:visible .eventLink").parents(".imageContextEditFieldset")).css("visibility","hidden");
	$("#insertLinkToPage").parent().remove();
	hidePopdownOrPassthroughSave(false);
}
function addTableData() {
	var csv = $("#popupDialogueTableData textarea").val();
	working();
	$.ajax({
	  type: "POST",
	  url: "tablesActions.php",
	  data: "tablesAction=csv&id="+$("#tablesPane .listItemHighlight").attr("table-id")+"&data="+encodeURIComponent(csv),
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#tablesPane .listItemHighlight").data("csv",csv);
		cancelDialogue();
		saved();
	  }
	});
}
function editTable ($clicked) {
	if ($("#tablesPaneInner .listItemHighlight").length==1) {
		prepDialogue("<h2>"+LangVars.Add_Table_Data+"</h2><p>"+LangVars.Add_Table_Data_Text+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Import,addTableData,false,true,true,"tableData");
	}
	return false;
}
function deleteTables () {
	var Ids="[";
	$("#tablesPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("alt")+'"';
		} else {
		Ids+=',"'+$(this).attr("alt")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "tablesActions.php",
	  data: "tablesAction=delete&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#tablesPaneInner .listItemHighlight").each(function(){
			$(this).next().remove();
			$(this).remove();
		});
		if ($("#tablesPaneInner .tableItem").length===0) {
			$("#tablesPaneInner .noPages").show();
		}
		if ($("#tablesPaneInner .tableItem").length==0) {
			$("#tablesPaneInner .insertTarget").load("tablesActions.php?tablesAction=search&rightPane=&string=");
		}
		cancelDialogue();
		selectionTools();
		saved();
	  }
	});
}
function addTable () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");
	prepFancyLabelForms($("#tablesPaneInner .addTableForm"));
	$("#tablesPaneInner .noPages").hide();

	$("#tablesPaneInner .addTableForm").show();
	$("#tablesPaneInner .addTableForm .focus").focus();
	function saveOrCancel () {
		$("#tablesPaneInner .addTableForm .focus").unbind("blur");
		if ($("#error:visible").length) {
			$("#error").fadeOut();
			return false;
		}
		if ($("#tablesPaneInner .addTableForm .focus").val()=="" || $("#tablesPaneInner .addTableForm .focus").val()==" ") {
			resetAddForms();
			if ($("#tablesPaneInner .tableItem").length===0) {
				$("#tablesPaneInner .noPages").show();
			}
		} else {


			var title = encodeURIComponent($(".focus",$("#tablesPaneInner .addTableForm")).val());

			if (title=="") {

				resetAddForms();
				return false;
			} else {
							working();
				$.ajax({
				  type: "POST",
				  url: "tablesActions.php",
				  data: "tablesAction=addTable&title="+title,
				  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				
					$("#tablesPaneInner .noPages").remove();
					$("#tablesPaneInner .insertTarget").html(msg);
					$("#tablesPaneInner .insertTarget .tableItem:first").addClass("listItemHighlight");
					selectionTools();
					saved();
					assignTablesKeys();
				
					$("#tablesPaneInner").lovelyScroll();
					assignDragAssets($("#tablesPaneInner .insertTarget"));

					resetAddForms();

				   }
				});
			}

		}
	}
	$("#tablesPaneInner .addTableForm .focus").unbind("blur").blur(function(){
		saveOrCancel();
		return false;
	});
	$(document).keyup(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
	});
	$(document).keydown(function(e){
		if (e.keyCode==13) { // enter

			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});
}
function addSnippet () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");
	prepFancyLabelForms($("#snippetsPaneInner .addSnippetForm"));
	$("#snippetsPaneInner .noPages").hide();

	$("#snippetsPaneInner .addSnippetForm").show();
	$("#snippetsPaneInner .addSnippetForm .focus").focus();
	function saveOrCancel () {
		$("#snippetsPaneInner .addSnippetForm .focus").unbind("blur");
		if ($("#error:visible").length) {
			$("#error").fadeOut();
			return false;
		}
		if ($("#snippetsPaneInner .addSnippetForm .focus").val()=="" || $("#snippetsPaneInner .addSnippetForm .focus").val()==" ") {
			resetAddForms();
			if ($("#snippetsPaneInner .snippetItem").length===0) {
				$("#snippetsPaneInner .noPages").show();
			}
		} else {


			var title = encodeURIComponent($(".focus",$("#snippetsPaneInner .addSnippetForm")).val());

			if (title=="") {

				resetAddForms();
				return false;
			} else {
							working();
				$.ajax({
				  type: "POST",
				  url: "snippetsActions.php",
				  data: "snippetsAction=addSnippet&title="+title+"&filterCat="+filterSnippetsByCategory,
				  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					if (msg=="Exists") {
						$(".addSnippetForm").hide();
						$(".addSnippetForm .focus").val("");
						selectionTools();
						assignSnippetsKeys();
						error(LangVars.Snippet_Exists);
					} else {

						$("#snippetsPaneInner .noPages").remove();
						$("#snippetsPaneInner .insertTarget").html(msg);
						$("#snippetsPaneInner .insertTarget .snippetItem:first").addClass("listItemHighlight");
						selectionTools();
						saved();
						assignSnippetsKeys();
					}
					$("#snippetsPaneInner").lovelyScroll(pagesScrollBottomSnippets);
					assignDragAssets($("#snippetsPaneInner .insertTarget"));

					resetAddForms();

				   }
				});
			}

		}
	}
	$("#snippetsPaneInner .addSnippetForm .focus").unbind("blur").blur(function(){
		saveOrCancel();
		return false;
	});
	$(document).keyup(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
	});
	$(document).keydown(function(e){
		if (e.keyCode==13) { // enter

			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});
}
function deleteSnippets () {
	var Ids="[";
	$("#snippetsPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("alt")+'"';
		} else {
		Ids+=',"'+$(this).attr("alt")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "snippetsActions.php",
	  data: "snippetsAction=delete&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#snippetsPaneInner .listItemHighlight").each(function(){
			$(this).next().remove();
			$(this).remove();
		});
		if ($("#snippetsPaneInner .snippetItem").length===0) {
			$("#snippetsPaneInner .noPages").show();
		}
		if ($("#snippetsPaneInner .snippetItem").length==0) {
			$("#snippetsPaneInner .insertTarget").load("snippetsActions.php?snippetsAction=search&rightPane=&string=&filterCat="+filterSnippetsByCategory);
		}
		cancelDialogue();
		selectionTools();
		saved();
	  }
	});
}
function duplicateSnippets () {
	var Ids="[";
	$("#snippetsPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("alt")+'"';
		} else {
		Ids+=',"'+$(this).attr("alt")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "snippetsActions.php",
	  data: "snippetsAction=copy&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#snippetsPaneInner .insertTarget").load("snippetsActions.php?snippetsAction=search&rightPane=&string=&filterCat="+filterSnippetsByCategory,function(){
			$("#snippetsPaneInner").scrollTop(0);
			var toHighlight = jQuery.parseJSON( msg );
			for (var i=0; i < toHighlight.length; i++) {
				$("#snippetsPaneInner div[alt="+toHighlight[i]+"]").addClass("listItemHighlight");
			};
			selectionTools();
			saved();
			assignSnippetsKeys();
			$("#snippetsPaneInner").lovelyScroll(pagesScrollBottomSnippets);
		});
	  }
	});
}
function editSnippet ($clicked) {
	window.location="/admin/editSnippet.php?id="+$clicked.attr("id");
}
function downloadFile () {
	$("#rightPaneFiles .listItemHighlight").each(function(){
		window.location=$(this).attr("alt");
	});
}
function deleteFiles () {
	var Ids="[";
	$("#filesPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("id")+'"';
		} else {
		Ids+=',"'+$(this).attr("id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "removeFileFromList.php",
	  data: "files="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#filesPaneInner .listItemHighlight").each(function(){
			$(this).next().remove();
			$(this).remove();
		});

		$("#downloads").load("pageActions.php?pageAction=showMoreFiles&start=0&search=",function(){
			if ($("#filesPaneInner .responsiveListItem").length==0) {
				$("#filesPaneInner .insertTarget").html($("#downloads .pagesScroll").html());
				assignDragAssets($("#filesPaneInner .insertTarget"));

			}
			saved();
		});

		cancelDialogue();
		selectionTools();
	  }
	});
}
function getMailingListSendCats() {
	if ($("#onlySendToCatsAll").prop("checked")) {
		var cats="";
	} else {
		var cats="";
		$("#sendToCategories input:checked").each(function(){
			if (cats!="") {
				cats = cats+",";
			}
			cats = cats+$(this).val();
		});
	}
	return cats;
}
function getMailingListSendMatchAll() {
	if ($("#onlySendMatchAll").prop("checked")) {
		var matchAll = "&matchall=true";
	} else {
		var matchAll = "&matchall=false";
	}
	return matchAll;
}
function getMailingListSendIds() {
	var Ids="[";
	$("#newsletterPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("group-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("group-id")+'"';
		}
	});
	Ids+="]";
	return Ids;
}
function sendToMailingLists () {
	if (!$("#changeMailingListPageContent").hasClass("okToSend") || $("#selectedMailingListPage").attr("page-id")=="" || $("#sendMailingListSubjectInput").val()==""){
		error(LangVars.Cant_Send_Mailing_List);
		return false;
	}
//	working();
	var page = $("#selectedMailingListPage").attr("page-id")+"|"+$("#selectedMailingListPage").attr("data-static-pages-versions-id");
	var Ids = getMailingListSendIds();
	if ($("#newsletterPaneInner .listItemHighlight").length==1) {
		var cats = getMailingListSendCats();
		var matchAll = getMailingListSendMatchAll();
	} else {
		var cats="";
		var matchAll="";
	}
	var url = window.location.href.split("#");
	var w = screen.width;
	var h = screen.height;
	var pw = 400;
	var ph = 390;
	var l = w/2 - pw/2;
	var t = h/2 - ph/2;
	window.open("newsletterActions.php?newsletterAction=sendfirst&v=2&groups="+Ids+"&cats="+cats+matchAll+"&page="+page+"&subject="+encodeURIComponent($("#sendMailingListSubjectInput").val()),"_blank","width="+pw+", height="+ph+", top="+t+", left="+l+" menubar=none, toolbar=no, status=no");
	/*
	$.ajax({
	  type: "POST",
	  url: "newsletterActions.php?newsletterAction=send&groups="+Ids+"&cats="+cats+matchAll+"&page="+page+"&subject="+encodeURIComponent($("#sendMailingListSubjectInput").val()),
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		alert("success");
//		window.open("newsletterActions.php?newsletterAction=send&groups="+Ids+"&cats="+cats+matchAll+"&page="+page+"&subject="+encodeURIComponent($("#sendMailingListSubjectInput").val()),"_blank","width=400, height=650, menubar=yes, toolbar=yes, status=yes");

	  }
	});	*/
	cancelDialogue();
//	message(LangVars.Mailing_List_Sent);
	return false;
}

function changeMailingListAutoresponder () {
	var value = $("#selectedMailingListAutoresponderPage").attr("page-id");
	var subject = $("#mailingListAutoresponderSubjectInput").val();
	var Ids="[";
	$("#newsletterPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("group-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("group-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "newsletterActions.php",
	  data: "newsletterAction=changeAutoresponder&ids="+Ids+"&pageid="+value+"&subject="+encodeURIComponent(subject),
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

			$("#newsletterPaneInner .insertTarget").html(msg);
			var idA = jQuery.parseJSON(Ids);
			for (var i = 0; i < idA.length; i++) {
				$("#newsletterPaneInner .insertTarget .responsiveListItem[group-id=\""+idA[i]+"\"]").addClass("listItemHighlight");
			}

			$("#newsletterPaneInner").lovelyScroll();
			assignDragAssets($("#newsletterPaneInner .insertTarget"));
			setTimeout(function() {

				selectionTools();

			}, 10);
			saved();
			assignNewsletterKeys();
			cancelDialogue();
	  }
	});
}
function changeMailingListAutoresponderContent(clicked) {
	$("#selectedMailingListAutoresponderPage").attr("page-id",clicked.attr("rel")).html(clicked.attr("title"));
	$("#selectedMailingListAutoresponderPage").attr("data-static-pages-versions-id",clicked.attr("data-static-pages-versions-id"));
	$("#changeMailingListAutoresponderContent").removeClass("empty");
	if ($("#lightPagesList").length) {
		$("#lightPagesOuter").animate({opacity:"0"},550,function(){
			$("#lightPagesOuter").remove();
		});
		return false;
	}
}
function addMailingList () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");
	$("#newsletterPaneInner .noPages").hide();
	$("#newsletterPaneInner #addMailingList").show();
	$("#newsletterPaneInner #addMailingList .focus").focus();
	prepFancyLabelForms($("#newsletterPaneInner #addMailingList"));

	function saveOrCancel () {
		if ($("#error:visible").length) {

			$("#error").fadeOut();
			return false;
		}
		$("#newsletterPaneInner #addMailingList .focus").unbind("blur");


		if ($("#newsletterPaneInner #addMailingList .focus").val()=="" || $("#newsletterPaneInner #addMailingList .focus").val()==" ") {
			resetAddForms();
			if ($("#newsletterPaneInner .mailingListItem").length===0) {
				$("#newsletterPaneInner .noPages").show();
			}

		} else {

			var title = encodeURIComponent($(".focus",$("#newsletterPaneInner #addMailingList")).val());

			if (title=="") {
				resetAddForms();
				return false;
			} else {
				resetAddForms();
				working();
				$.ajax({
				  type: "POST",
				  url: "newsletterActions.php",
				  data: "newsletterAction=addGroup&name="+title,
				  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					if (msg=="Exists") {
						error(LangVars.Mailing_List_Exists);
					} else {

						$("#newsletterPaneInner .insertTarget").html(msg);
						$("#newsletterPaneInner .insertTarget .responsiveListItem:first").addClass("listItemHighlight");
						$("#newsletterPaneInner").lovelyScroll();
						assignDragAssets($("#newsletterPaneInner .insertTarget"));
						setTimeout(function() {
							selectionTools();

						}, 10);
						saved();
						assignNewsletterKeys();
					}

				   }
				});
			}

		}
	}

	$("#newsletterPaneInner #addMailingList .focus").unbind("blur").blur(function(){
		saveOrCancel();
		return false;
	});
	$(document).keyup(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
	});
	$(document).keydown(function(e){
		if (e.keyCode==13) { // enter

			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});
	/*

	$(document).click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		saveOrCancel();
		return false;
	});*/
}
function changeMailingListFrom (name,email) {
	logTrainingClick("submitMailingListFrom");
	working();
	$.ajax({
	  type: "POST",
	  url: "newsletterActions.php",
	  data: "newsletterAction=saveSettings&from_name="+encodeURIComponent(name)+"&from_email="+encodeURIComponent(email),
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		saved();
		cancelDialogue();

		$("#newsletterFromSetting").attr("mailing-list-from-name",name);
		$("#newsletterFromSetting").attr("mailing-list-from-email",email);
		$("#newsletterFromSetting .value .overflowEllipsis").text(name+" ("+email+")");
		$("#newsletterFromSetting .value").attr("title",name+" ("+email+")");
	  }
	});
}
function changeMailingListSMTP (server,username,password) {

	working();
		$.ajax({
		  type: "POST",
		  url: "newsletterActions.php",
		  data: "newsletterAction=saveSettings&smtp_server="+encodeURIComponent(server)+"&username="+encodeURIComponent(username)+"&password="+encodeURIComponent(password),
		  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

				if (msg!="ok") {
					error(msg);
				} else {
					saved();
					cancelDialogue();
					hide_menus();

					$("#newsletterSMTPSetting").attr("mailing-list-server",server);
					$("#newsletterSMTPSetting").attr("mailing-list-username",username);
					$("#newsletterSMTPSetting").attr("mailing-list-password",password);
				}


		  }
		});


}
function deleteMailingLists () {
	var Ids="[";
	$("#newsletterPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("group-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("group-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "newsletterActions.php",
	  data: "newsletterAction=removeGroups&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#newsletterPaneInner .listItemHighlight").each(function(){
			$(this).next().remove();
			$(this).next().remove();
			$(this).remove();
		});
		if ($("#newsletterPane .mailingListItem").length===0) {
			$("#newsletterPane .noPages").show();
		}
		saved();
		cancelDialogue();
		selectionTools();
	  }
	});
}
function deleteMailingListPrep () {
	var okToGo = true;
	$("#newsletterPaneInner .listItemHighlight").each(function(){
		if ($(this).attr("id")=="") {
			error(LangVars.Cant_Remove_Default_Newsletter);
			okToGo=false;
		}
	});
	if (okToGo) {
		if ($("#newsletterPaneInner .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Newsletter_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteMailingLists,false,true);
		}

	}
}
function changeMailingListSubject (subject) {
	logTrainingClick("submitMailingListSubject");
	working();
	$.ajax({
	  type: "POST",
	  url: "newsletterActions.php",
	  data: "newsletterAction=changeSubject&subject="+subject,
	  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			$("#changeMailingListSubject").attr("title",msg);
			$("#changeMailingListSubject").html(msg);
			checkStatus();
			assignNewsletterKeys();
			cancelDialogue();
			saved();


	  }
	});
}
function changeMailingListPageContent (clicked) {
	logTrainingClick("choosePageForMailingListContent");
	$("#selectedMailingListPage").attr("page-id",clicked.attr("rel")).html(clicked.attr("title"));
	$("#selectedMailingListPage").attr("data-static-pages-versions-id",clicked.attr("data-static-pages-versions-id"));
	$("#changeMailingListPageContent").removeClass("empty");
	checkStatus();
	if ($("#lightPagesList").length) {
		$("#lightPagesOuter").animate({opacity:"0"},550,function(){
			$("#lightPagesOuter").remove();
		});
		return false;
	}
}
function showNewsletterSettings () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");

	$('body').append("<div class='bpe_mask'></div><div class='bpe_add_popup'><div class='bpe_add_popup_inner'><img src='graphics/bpeditor/help.png' alt='Before you can send a newsletter you need to enter a From Name and Email address which your emails will use. To decrease the chance of your emails being flagegd as spam, you can send mail using your actual SMTP server by entering SMTP connection information.' class='bpe_help' /><h2>Edit Newsletter Email Settings</h2><div id='newsletter_email_settings' class='popup_loading'></div><div class='clear'></div><div class='bpe_savecancel'><a href='#' class='bpe_save'><span>Done</span></a><a href='#' class='bpe_cancel'><span>Cancel</span></a></div></div></div>");


	$("#newsletter_email_settings").load("newsletterActions.php?newsletterAction=showEmailSettings&to_prevent_cache="+(new Date).getTime(),function(){
		$(".popup_loading").removeClass("popup_loading");
		$("#newsletterSettingsForm").submit(function(){
			working();
			function showResponse (responseText, statusText) {
if (responseText =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			if (responseText!="ok") {
					error(responseText);
				} else {
					saved("Settings Saved");
					checkStatus();
					$(".bpe_mask").remove();
					$(".bpe_add_popup").remove();
					assignNewsletterKeys();
				}
			}
			var options = {
				success:       showResponse  // post-submit callback
			};
			$('#newsletterSettingsForm').ajaxSubmit(options);
			return false;
		});
		$(".bpe_save").click(function(){

			$('#newsletterSettingsForm').submit();



			return false;
		});

	});

	$(document).unbind("keypress");

	$(document).keypress(function (e) {
      if (e.keyCode == 27) {
			$(".bpe_mask").remove();
			$(".bpe_add_popup").remove();
			assignNewsletterKeys();
      }
    });
	$(".bpe_cancel").click(function(){
		$(".bpe_mask").remove();
		$(".bpe_add_popup").remove();
								assignSaveListener();
		return false;
	});
	//assign_help();
	$(".bpe_mask").css("height",$(document).height()+"px");
	$(".bpe_mask").fadeTo(0,0.4);
	var top = $(window).height()-$("#bpe_add_popup").height()-380;
	top = top/2;
	top = top-30;
	$(".bpe_add_popup").css("top",$(document).scrollTop()+top+"px");
	$(".bpe_mask,.bpe_add_popup").click(function(){ $(".bpe_help_popup").hide(); return false;});



	return false;
}
function loadSubscribers() {
	$("#subscriberCategoriesList").load("newsletterActions.php?newsletterAction=showCategories",function(){
		if ($("#subscriberCategoriesList li").length==0) {
			$("#filterBySubscriberCat").hide();
			$("#subscriberCategoriesList").next().hide();
			$("#subscriberCategoriesList").hide();
		} else {
			$("#filterBySubscriberCat").show();
			$("#subscriberCategoriesList").next().show();
			$("#subscriberCategoriesList").show();
		}
		updateSubscriberCatFilterMenu();
	});
	$("#subscriberCustomFields").load("newsletterActions.php?newsletterAction=showCustomFields",function(){

	});
	$("#newsletterSubscribersPaneInner .insertTarget").load("newsletterActions.php?newsletterAction=showEmails&showPane=&clearSearch=",function(){
			$("#rightPaneNewsletterSubscribers").show();
			$(window).trigger("resize");

			saved();


			$("#newsletterSubscribersPaneInner").lovelyScroll(pagesScrollMailingListSubs);
			prepFancyLabelForms($("#rightPaneNewsletterSubscribers .filterBox"));
			assignListLasso($("#newsletterSubscribersPaneInner"));
			assignListPane($("#newsletterSubscribersPaneInner .insertTarget"),editSubscriber);
			//assignRightPanePaginate("newsletterActions.php","newsletterAction=showEmails&ajax=true&start=","#newsletterSubscribersPaneInner");

			assignNewsletterSubscribersKeys();
			assignPaneSearch($("#rightPaneNewsletterSubscribers .searchList"),"newsletterActions.php","newsletterAction=filterSearch&search=","newsletterSubscribers");
			$("#loadingMask").hide();
	});
}
function showSubscribers (clicked) {
	if ($("#rightPaneNewsletter").hasClass("noEditPrivs")) {
		error(LangVars.No_Subscriber_Privs);
		return false;
	}
	hidePaneTools();
	logTrainingClick("showSubscribers");
	hidePanes();
	$("input").unbind();
	$("body").removeClass("storageDraggable");
	$("#loadingMask").show();
	$("#rightPaneNewsletter").hide();
	$("#rightPaneNewsletterSubscribers .searchList").val("");
	$("#rightPaneNewsletterSubscribers .clearSearch").hide();
	$("#rightPaneNewsletterSubscribers .searchSVG").parent().removeClass("searching");
	$("#editNewsletterSubscribersTitle").attr("mailinglist-id",clicked.attr("group-id")).html("<div><span>"+clicked.attr("title")+"</span></div>");
	working();
	$.ajax({
	  type: "POST",
	  url: "newsletterActions.php",
	  data: "newsletterAction=filterGroup&group="+clicked.attr("group-id"),
	  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		loadSubscribers();

	  }
	});
	return false;
}
function editSubscriber (clicked) {
	editMeListItemMultiple(clicked);
}
function changeNewsletterCustomField(text) {
	var fieldId = $("#subscriberCustomFields .editingField").attr("data-field-id");
	if ($("body").hasClass("selectingAll")) {
		var Ids="[";
		$("#rightPaneNewsletterSubscribers .responsiveListItem:not(.responsiveListItem.listItemHighlight)").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("subscriber-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("subscriber-id")+'"';
			}
		});
		Ids+="]";
		var selectingAll = "&selectingAll=true";
	} else {
		var selectingAll = "";
		var Ids="[";
		$("#rightPaneNewsletterSubscribers .listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("subscriber-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("subscriber-id")+'"';
			}
		});
		Ids+="]";
	}
	working();
	$.ajax({
	  type: "POST",
	  url: "newsletterActions.php",
	  data: "newsletterAction=changeCustomFieldValue&ids="+Ids+"&id="+fieldId+"&value="+text+selectingAll+"&filterCat="+filterSubscribersByCategory+filterSubscribersByCategoryMatchAll+filterSubscribersByStatus,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#newsletterSubscribersPaneInner .listItemHighlight").each(function(){
			$(this).attr("data-custom-field-"+fieldId,text);
		});
		saved();
		selectionTools();
		cancelDialogue();
	  }
	});
}
function addNewsletterCustomField(text) {
	working();
	$.ajax({
	  type: "POST",
	  url: "newsletterActions.php",
	  data: "newsletterAction=addCustomField&name="+encodeURIComponent(text),
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			$("#subscriberCustomFields").load("newsletterActions.php?newsletterAction=showCustomFields",function(){
				$("#newsletterSubscribersPaneInner .insertTarget").load("newsletterActions.php?newsletterAction=showEmails&showPane="+"&filterCat="+filterSubscribersByCategory+filterSubscribersByCategoryMatchAll+filterSubscribersByStatus,function(){
					assignListPane($("#newsletterSubscribersPaneInner .insertTarget"),editSubscriber);
					$("#newsletterSubscribersPaneInner").lovelyScroll(pagesScrollMailingListSubs);
					saved();
					cancelDialogue();
					$("#newsletterSubscribersPane .paneTools").each(function(){
						if ($(this).hasClass("scrollWrapper")) {
							myScroll[$(this).attr("id")].refresh();
						} else {
							$(this).lovelyScroll();
						}
					});
				});
			});

	   }
	});
}
function importNewsletterCSV (text) {
	working();
	$.ajax({
	  type: "POST",
	  url: "newsletterActions.php",
	  data: "newsletterAction=importCSV&csv="+encodeURIComponent(text)+"&belongs_to_list="+$("#editNewsletterSubscribersTitle").attr("mailinglist-id")+"&filterCat="+filterSubscribersByCategory+filterSubscribersByCategoryMatchAll+filterSubscribersByStatus,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

		$("#newsletterSubscribersPaneInner .insertTarget").load("newsletterActions.php?newsletterAction=showEmails&showPane="+"&filterCat="+filterSubscribersByCategory+filterSubscribersByCategoryMatchAll+filterSubscribersByStatus,function(){
			$("#newsletterSubscribersPaneInner .responsiveListItem:first").addClass("listItemHighlight");
			assignListPane($("#newsletterSubscribersPaneInner .insertTarget"),editSubscriber);
			$("#newsletterSubscribersPaneInner").lovelyScroll(pagesScrollMailingListSubs);
			saved();
			cancelDialogue();
		});

	   }
	});
}
function newSubscriber () {

	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");
	logTrainingClick("newSubscriber");
	$("#newsletterSubscribersPaneInner").unbind("click");
	$("#newsletterSubscribersPaneInner .insertTarget").click(function(){
		saveOrCancel();
		return false;
	});
	$("#newsletterSubscribersPaneInner .noPages").hide();
	$("#newsletterSubscribersPaneInner #addSubscriber").show();
	$("#newsletterSubscribersPaneInner #addSubscriber .focus").focus();
	$("#newsletterSubscribersPaneInner #addSubscriber .imageContextEditLabel").css("visibility","visible");

	$(".imageContextEditFieldset",$("#newsletterSubscribersPaneInner #addSubscriber")).each(function(){
		if ($("input",$(this)).val()==""){
			$(".imageContextEditLabel",$(this)).css("visibility","visible");
		}
	});
	$(".imageContextEditFieldset input",$("#newsletterSubscribersPaneInner #addSubscriber")).unbind("keyup").keyup(function(){
		if ($(this).val()!="") {
			$(".imageContextEditLabel",$(this).parents(".imageContextEditFieldset")).css("visibility","hidden");
		} else {
			$(".imageContextEditLabel",$(this).parents(".imageContextEditFieldset")).css("visibility","visible");
		}
	});

	function saveOrCancel () {

		if ($("#error:visible").length) {
			$("#error").fadeOut();
			return false;
		}

		var name = encodeURIComponent($(".newSubscriberName",$("#newsletterSubscribersPaneInner #addSubscriber")).val());
		var email = encodeURIComponent($(".newSubscriberEmail",$("#newsletterSubscribersPaneInner #addSubscriber")).val());

		if (name=="" || email=="") {
			resetAddForms();
			if ($("#newsletterSubscribersPaneInner .responsiveListItem").length===0) {
				$("#newsletterSubscribersPaneInner .noPages").show();
			}
			return false;
		} else {
			logTrainingClick("submitNewSubscriber");
			working();
			$.ajax({
			  type: "POST",
			  url: "newsletterActions.php",
			  data: "newsletterAction=addEmail&name="+name+"&email="+email+"&belongs_to_list="+$("#editNewsletterSubscribersTitle").attr("mailinglist-id")+"&filterCat="+filterSubscribersByCategory+filterSubscribersByCategoryMatchAll+filterSubscribersByStatus,
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

				$("#newsletterSubscribersPaneInner .insertTarget").load("newsletterActions.php?newsletterAction=showEmails&showPane="+"&filterCat="+filterSubscribersByCategory+filterSubscribersByCategoryMatchAll+filterSubscribersByStatus,function(){
					$("#newsletterSubscribersPaneInner .responsiveListItem:first").addClass("listItemHighlight");
					assignListPane($("#newsletterSubscribersPaneInner .insertTarget"),editSubscriber);
					resetAddForms();
					selectionTools();
					saved();
					assignNewsletterSubscribersKeys();
					$("#newsletterSubscribersPaneInner").lovelyScroll(pagesScrollMailingListSubs);
				});

			   }
			});
		}


	}
	$("#newsletterSubscribersPaneInner #addSubscriber").click(function(){
		return false;
	});

	$(document).keyup(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
	});
	$(document).keydown(function(e){
		if (e.keyCode==13) { // enter

			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});
	$(document).click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
			saveOrCancel();
		return false;
	});
}
function deleteSubscribersPrep () {

	if ($("#newsletterSubscribersPaneInner .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Newsletter_Sub_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteSubscribers,false,true);
	}


}

function deleteSubscribers () {
	var Ids="[";
	$("#newsletterSubscribersPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("subscriber-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("subscriber-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "newsletterActions.php",
	  data: "newsletterAction=removeEmails&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#newsletterSubscribersPaneInner .listItemHighlight").each(function(){
			$(this).next().remove();
			$(this).next().remove();
			$(this).remove();
		});
		if ($("#newsletterSubscribersPaneInner .responsiveListItem").length===0) {
			$("#newsletterSubscribersPaneInner .noPages").show();
		}
		$("#newsletterSubscribersPaneInner").lovelyScroll(pagesScrollMailingListSubs);
		saved();
		hide_iconbar_menus();
		cancelDialogue();
		selectionTools();
	  }
	});
}
function toggleSubInactive (inactive) {
	var Ids="[";
	$("#newsletterSubscribersPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("subscriber-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("subscriber-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "newsletterActions.php",
	  data: "newsletterAction=toggleInactive&ids="+Ids+"&inactive="+inactive,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#newsletterSubscribersPaneInner .listItemHighlight").each(function(){
			if (inactive=="yes") {
				$(this).addClass("offline").attr("data-subscriber-status","inactive");
				$(".subscriberInactive",$(this)).css("visibility","visible");
			} else {
				$(this).removeClass("offline").attr("data-subscriber-status","active");
				$(".subscriberInactive",$(this)).css("visibility","hidden");
			}

		});
		saved();
		selectionTools();
	  }
	});
}
// Subscriber Categories

function editSubscriberCategory ($clicked) {
	editMeListItem($clicked);
	return false;
}
function deleteSubscriberCategoriesPrep () {
	if ($("#subscriberCategoriesPaneInner .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Subscriber_Category_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteSubscriberCategories,false,true);
	}
}
function deleteSubscriberCategories () {
	var Ids="[";
	$("#subscriberCategoriesPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("subscriber-category-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("subscriber-category-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "newsletterActions.php",
	  data: "newsletterAction=deleteCategories&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

		$("#subscriberCategoriesList").load("newsletterActions.php?newsletterAction=showCategories",function(){
			if ($("#subscriberCategoriesList li").length==0) {
				$("#filterBySubscriberCat").hide();
				$("#subscriberCategoriesList").next().hide();
				$("#subscriberCategoriesList").hide();
			}
			if ($("#rightPaneSubscriberCategories .subscriberCatItem").length===0) {
				$("#rightPaneSubscriberCategories .noPages").show();
			}
			displaySubscriberCats();
			selectionTools();
			assignSubscriberCategoriesKeys();
			cancelDialogue();
			saved();
			$("#subscriberCategoriesPaneInner").lovelyScroll();
		});

	  }
	});
}
function addSubscriberCategory () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");
	$("#rightPaneSubscriberCategories .noPages").hide();
	$("#rightPaneSubscriberCategories .addSubscriberCategory").show();
	prepFancyLabelForms($("#rightPaneSubscriberCategories .addSubscriberCategory"));
	$("#rightPaneSubscriberCategories .addSubscriberCategory .focus").focus();
	function saveOrCancel () {
		$("#rightPaneSubscriberCategories .addSubscriberCategory .focus").unbind("blur");
		if ($("#rightPaneSubscriberCategories .addSubscriberCategory .focus").val()=="" || $("#rightPaneSubscriberCategories .addSubscriberCategory .focus").val()==" ") {
			resetAddForms();
			if ($("#rightPaneSubscriberCategories .subscriberCatItem").length===0) {
				$("#rightPaneSubscriberCategories .noPages").show();
			}
		} else {
			working();

			$.ajax({
			  type: "POST",
			  url: "newsletterActions.php",
			  data: "newsletterAction=addCategory&name="+encodeURIComponent($("#rightPaneSubscriberCategories .addSubscriberCategory .focus").val()),
			  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#filterBySubscriberCat").show();
				$("#subscriberCategoriesList").next().show();
				$("#subscriberCategoriesList").show().load("newsletterActions.php?newsletterAction=showCategories",function(){
					saved();
					displaySubscriberCats();
					$("#subscriberCategoriesPaneInner .responsiveListItem:first").addClass("listItemHighlight");
					$("#subscriberCategoriesPaneInner").lovelyScroll();
					assignSubscriberCategoriesKeys();
					setTimeout(function() {
						selectionTools();
					}, 100);

					resetAddForms();
				});

			  }
			});
		}
	}
	$("#rightPaneSubscriberCategories .addSubscriberCategory .focus").unbind("blur").blur(function(){
		saveOrCancel();
		return false;
	});
	$(document).keyup(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
	});
	$(document).keydown(function(e){
		if (e.keyCode==13) { // enter

			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});
}

// Event groups

function editEventGroup ($clicked) {
	editMeListItem($clicked);
	return false;
}
function deleteEventGroupPrep () {
	if ($("#eventsGroupsPaneInner .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Event_Group_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteEventGroup,false,true);
	}
}
function deleteEventGroup () {
	var Ids="[";
	$("#eventsGroupsPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("event-group-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("event-group-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "calendarActions.php",
	  data: "calendarAction=deleteGroups&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

		$("#eventsGroupsList").load("calendarActions.php?calendarAction=showGroups&belongsToCal="+$("#calendarEventsDateFilter #showing_cat").val(),function(){

			if ($("#eventsGroupsList li").length==0) {
//				$("#filterByEventGroup").hide();
				$("#eventsGroupsList").next().hide();
				$("#eventsGroupsList").hide();
			}
			if ($("#rightPaneEventsGroups .eventGroupItem").length===0) {
				$("#rightPaneEventsGroups .noPages").show();
			}
			displayEventGroups();
			selectionTools();
			assignEventGroupKeys();
			cancelDialogue();
			saved();
			$("#eventsGroupsPaneInner").lovelyScroll();
		});

	  }
	});
}
function addEventGroup () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");
	$("#rightPaneEventsGroups .noPages").hide();
	$("#rightPaneEventsGroups .addEventGroup").show();
	prepFancyLabelForms($("#rightPaneEventsGroups .addEventGroup"));
	$("#rightPaneEventsGroups .addEventGroup .focus").focus();
	function saveOrCancel () {
		$("#rightPaneEventsGroups .addEventGroup .focus").unbind("blur");
		if ($("#rightPaneEventsGroups .addEventGroup .focus").val()=="" || $("#rightPaneEventsGroups .addEventGroup .focus").val()==" ") {
			resetAddForms();
			if ($("#rightPaneEventsGroups .subscriberCatItem").length===0) {
				$("#rightPaneEventsGroups .noPages").show();
			}
		} else {
			working();
			$.ajax({
			  type: "POST",
			  url: "calendarActions.php",
			  data: "calendarAction=addGroup&name="+encodeURIComponent($("#rightPaneEventsGroups .addEventGroup .focus").val())+"&belongsToCal="+$("#calendarEventsDateFilter #showing_cat").val(),
			  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
//				$("#filterBySubscriberCat").show();
				$("#eventsGroupsList").next().show();
				$("#eventsGroupsList").show().load("calendarActions.php?calendarAction=showGroups&belongsToCal="+$("#calendarEventsDateFilter #showing_cat").val(),function(){
					saved();
					displayEventGroups();
					$("#eventsGroupsPaneInner .responsiveListItem:first").addClass("listItemHighlight");
					$("#eventsGroupsPaneInner").lovelyScroll();
					assignEventGroupKeys();
					assignSortableListItems($("#eventsGroupsPaneInner"),"listItemHighlight","responsiveListItem");
					setTimeout(function() {
						selectionTools();
					}, 100);

					resetAddForms();
				});

			  }
			});
		}
	}
	$("#rightPaneEventsGroups .addEventGroup .focus").unbind("blur").blur(function(){
		saveOrCancel();
		return false;
	});
	$(document).keyup(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
	});
	$(document).keydown(function(e){
		if (e.keyCode==13) { // enter

			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});
}

function displayEventGroups () {

	$("#eventsGroupsPaneInner .insertTarget").html("");
	$("#eventsGroupsPaneInner .insertTarget").append("<div class='dropzone'><div></div></div>");
	
	hidePaneTools();

	var c = 0;
	$("#eventsGroupsList a").each(function(){
		$("#eventsGroupsPaneInner .insertTarget").append("<div class='responsiveListItem eventGroupItem' event-group-id='"+$(this).attr("event-group-id")+"'><span class='overflowEllipsis'>"+$(".overflowEllipsis",$(this)).html()+"</span></div><div class=\"responsiveListAddForm inline\" style='display:none;' action=\"\" method=\"post\" rel=\""+$(this).attr("event-group-id")+"\"><input type=\"text\" name=\"\" value=\""+$(".overflowEllipsis",$(this)).html().replace(/"/g,"&quot;")+"\" class=\"focus\"	/></div><div class='dropzone'><div></div></div>");
		c++;
	});
	if (c==0) {
		$("#eventsGroupsPaneInner .insertTarget").append("<div class='noPages'>"+LangVars.No_Event_Groups+"</div>");
	}

//	updateSubscriberCatFilterMenu();

}
function displaySubscriberCats () {


	$("#subscriberCategoriesPaneInner .insertTarget").html("");

	$("#subscriberCategoriesPaneInner .insertTarget").append($("#newsletterSubscribersPaneInner #subscriberCatsMenuList .addSubscriberCategory").first().clone());
	$("#subscriberCategoriesPaneInner .insertTarget").append("<div class='dropzone'><div></div></div>");
	hidePaneTools();

	var c = 0;
	$("#subscriberCategoriesList a").each(function(){
		$("#subscriberCategoriesPaneInner .insertTarget").append("<div class='responsiveListItem subscriberCategoryItem' subscriber-category-id='"+$(this).attr("subscriber-cat-id")+"' data-id='"+$(this).attr("subscriber-cat-id")+"' data-show-on-signup=\""+$(this).attr("data-show-in-signup")+"\"><span class='overflowEllipsis'>"+$(".overflowEllipsis",$(this)).html()+"</span></div><div class=\"responsiveListAddForm inline\" style='display:none;' action=\"\" method=\"post\" rel=\""+$(this).attr("subscriber-cat-id")+"\"><input type=\"text\" name=\"\" value=\""+$(".overflowEllipsis",$(this)).html().replace(/"/g,"&quot;")+"\" class=\"focus\"	/></div><div class='dropzone'><div></div></div>");
		c++;
	});
	if (c==0) {
		$("#subscriberCategoriesPaneInner .insertTarget").append("<div class='noPages'>"+LangVars.No_Subscriber_Categories+"</div>");
	}

	updateSubscriberCatFilterMenu();

}
function updateSubscriberCatFilterMenu () {
	if ($("#subscriberCategoriesList a").length) {
		$("#rightPaneNewsletterSubscribers .filterBar").show();
//		$("#newsletterSubscribersPaneInner").addClass("withFilterBar");
		$("#subscriberFilterCategories").html("");
		$("#subscriberCategoriesList a").each(function(){
			$("#subscriberFilterCategories:hidden").show();
			$("#subscriberFilterCategories").append('<li><a href="#" class="filterBy filterLink" data-lang="'+htmlentities($(".overflowEllipsis",$(this)).html())+'" category-id="'+$(this).attr("subscriber-cat-id")+'"><span>'+htmlentities($(".overflowEllipsis",$(this)).html())+'</span></a></li>');
		});
	} else {
		$("#rightPaneNewsletterSubscribers .filterBar").hide();
		$("#newsletterSubscribersPaneInner").removeClass("withFilterBar");
	}
}
// Blog
function editBlog ($clicked) {
	window.location="blogActions.php?blogAction=viewVersion&id="+$clicked.attr("id");
}
function deleteBlogPrep () {
	if ($("#blogPaneInner .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Blog_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteBlog,false,true);
	}
}
function deleteBlog () {
	var Ids="[";
	$("#blogPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("blog-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("blog-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "blogActions.php",
	  data: "blogAction=deleteEntry&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#blogPaneInner .listItemHighlight").each(function(){
			$(this).next().remove();
//			$(this).next().remove();
			$(this).remove();
		});
		saved();
		cancelDialogue();
		selectionTools();
	  }
	});
}
function addBlog () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");
			$("#blogPaneInner .noPages").hide();

	$(".listItemHighlight").removeClass("listItemHighlight");
	selectionTools();
	$("#blogPaneInner #addBlogEntry").show();
	$("#blogPaneInner #addBlogEntry .focus").focus();
	prepFancyLabelForms($("#blogPaneInner #addBlogEntry"));

	function saveOrCancel () {
		$("#blogPaneInner #addBlogEntry .focus").unbind("blur");
		if ($("#error:visible").length) {
			$("#error").fadeOut();
			return false;
		}
		if ($("#blogPaneInner #addBlogEntry .focus").val()=="" || $("#blogPaneInner #addBlogEntry .focus").val()==" ") {
			resetAddForms();
			$("#blogPaneInner .noPages").show();

		} else {


			var title = encodeURIComponent($(".focus",$("#blogPaneInner #addBlogEntry")).val());

			if (title=="") {
				resetAddForms();
				return false;
			} else {
				working();
				$.ajax({
				  type: "POST",
				  url: "blogActions.php",
				  data: "blogAction=addEntry&title="+title,
				  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					if (msg=="Exists") {
						error(LangVars.Mailing_List_Exists);
					} else if (msg=="limit") {
						error(LangVars.Blog_Limit_Reached);
					} else {
						logTrainingClick("addBlogEnter");
						switchToBlog(true,true);
						selectionTools();
						saved();
						assignBlogKeys();
					}
					resetAddForms();

				   }
				});
			}

		}
	}
	$("#blogPaneInner #addBlogEntry .focus").blur(function(){
		saveOrCancel();
		return false;
	});
	$(document).keyup(function(e){
		if (e.keyCode==13) { // enter

			return false;
		}
	});
	$(document).keydown(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});
	/*
	$(document).click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		resetAddForms();
		return false;
	});*/
}
function assignBlogFilterBar () {
	assignHeaderMenus();
	prepFancyLabelForms($("#blogPane .blogSearchMenu .filterBox"));
	assignPaneSearch($("#blogPane .blogSearchMenu .filterBox .blogFilterSearch"),"blogActions.php","blogAction=filterSearch&string=","blog");

	$("#blogPane #blogFilter").unbind().click(function(e){
		if ($(e.target)[0].nodeName.toLowerCase()=="a") {
			$this = $(e.target);
		}
		var lang = $this.attr("data-item-value");
		$.ajax({
		  type: "POST",
		  url: "blogActions.php",
		  data: "blogAction=changeLangFilter&language="+lang,
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			hidePaneTools();
			hidePanes();
			hide_iconbar_menus();
			switchToBlog(true,false);
			saved();
		  }
		});
		return false;
	});
	$("#blogPane #blogFilterCat").unbind().click(function(e){
		working();
		if ($(e.target)[0].nodeName.toLowerCase()=="a") {
			$this = $(e.target);
		}
		var catid = $this.attr("blog-category-id");
		$.ajax({
		  type: "POST",
		  url: "blogActions.php",
		  data: "blogAction=changeCategoryFilter&catid="+catid,
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			hidePaneTools();
			hidePanes();
			hide_iconbar_menus();
			switchToBlog(true,false);

		  }
		});
		return false;
	});
}
function getSelectedBlogs() {
	var selectingAll="";
	if ($("body").hasClass("selectingAll")) {
		var Ids="[";
		$("#blogPaneInner .responsiveListItem:not(.responsiveListItem.listItemHighlight)").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("blog-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("blog-id")+'"';
			}
		});
		Ids+="]";
		var selectingAll = "&selectingAll=true";
	} else {
		var Ids="[";
		$("#blogPaneInner .listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("blog-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("blog-id")+'"';
			}
		});
		Ids+="]";
	}

	return new Array(selectingAll,Ids);
}
function toggleBlogLive (toggle) {
	
	var selection = getSelectedBlogs();
	var selectingAll = selection[0];
	var Ids = selection[1];
	
	
	working();
	$.ajax({
	  type: "POST",
	  url: "blogActions.php",
	  data: "blogAction=change&action=live&live="+toggle+"&ids="+Ids+selectingAll,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			saved();
			cancelDialogue();

			$("#blogPaneInner .listItemHighlight").each(function(){
				if (toggle=="yes") {
					$(this).removeClass("offline").attr("data-blog-status","live");
					$(".blogOffline",$(this)).css("visibility","hidden");
				} else {
					$(this).addClass("offline").attr("data-blog-status","offline");
					$(".blogOffline",$(this)).css("visibility","visible");
				}
			});
			selectionTools();

	  }
	});
}
function changeCommentNotificationEmail (email) {
	working();
	$.ajax({
	  type: "POST",
	  url: "blogActions.php",
	  data: "blogAction=changeConfig&action=comment_email_notification&comment_email_notification="+encodeURIComponent(email),
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			saved();
			$("#changeCommentNotificationEmail").attr("value",email);
			$("#changeCommentNotificationEmail .value").attr("title",email);
			$("#changeCommentNotificationEmail .value span").text(email);
			cancelDialogue();

	  }
	});
}
function changeSecretPass (pass) {
	working();
	$.ajax({
	  type: "POST",
	  url: "blogActions.php",
	  data: "blogAction=changeConfig&action=secret_passcode&secret_passcode="+encodeURIComponent(pass),
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			saved();
			cancelDialogue();
			$("#changeSecretPass").attr("value",pass);
			$("#changeSecretPass .value").attr("title",pass);
			$("#changeSecretPass .value span").text(pass);

	  }
	});
}
function changeArticlesOnPage (onpage) {
	working();
	$.ajax({
	  type: "POST",
	  url: "blogActions.php",
	  data: "blogAction=changeConfig&action=items_on_page&items_on_page="+encodeURIComponent(onpage),
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			saved();
			cancelDialogue();
			$("#changeArticlePerPage .value").attr("title",onpage);
			$("#changeArticlePerPage .value span").html(onpage);

	  }
	});
}
function updateSitewideLangs (argument) {

	$("#otherLangsSitewide").html("");
	$("#languagesWrapperBlog a:not(:eq(0))").each(function(){
		$("#otherLangsSitewide").append("<div class='otherLangSitewide' language='"+$(this).text()+"' language-code='"+$(this).attr("fakehref")+"'></div>");
	});
	$("#otherLangsSitewide > div").html($("#primaryLangSitewide").html());
	$("#otherLangsSitewide > div").each(function(){
		$div = $(this);
		$(".settingsItem a",$(this)).each(function(){
			$(this).append(" ("+$div.attr("language")+")").attr("href",$(this).attr("href")+"&language="+$div.attr("language-code"));
		});

	});

}
function changeLanguageBlog (lang) {
	
		var selection = getSelectedBlogs();
		var selectingAll = selection[0];
		var Ids = selection[1];	
	
		$.ajax({
		  type: "POST",
		  url: "blogActions.php",
		  data: "blogAction=change&action=language&ids="+Ids+"&language="+lang+selectingAll,
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			$("#languagesWrapperBlog").load("languagesActions.php?languagesAction=show&to_prevent_cache="+(new Date).getTime(),function(){
				$("#blogPane #blogFilterToUpdate,#languagesWrapper").html($("#languagesWrapperBlog").html());

				$("#blogPaneInner .listItemHighlight").attr("blog-language",lang).attr("data-lang",lang);
				selectionTools();
				assignBlogFilterBar();
				if ($("#blogPane #blogFilterToUpdate li").length>1) {
					$(".langFilterMenu").show();
				}
				if ($("#blogPane #blogFilterToUpdate a.bpe_current").length || !$("#blogPane #blogFilter a.bpe_current").length) {
					switchToBlog(true,false);
				} else {
					saved();
				}
				updateSitewideLangs();
			});

			//$("#languagesWrapperBlog a").removeClass("bpe_current");
			//$("#languagesWrapperBlog a[fakehref="+lang+"]").addClass("bpe_current");
			//hidePanes();
			//hide_iconbar_menus();

			//switchToBlog(true,false);
			
		  }
		});

}
function addBlogAuthor () {
	logTrainingClick("newBlogAuthor");
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");
				$("#blogAuthorsPaneInner .noPages").hide();
	$("#rightPaneBlogAuthors .addBlogAuthor input").unbind();
	$("#blogAuthorsPaneInner").unbind("click");
	$("#blogAuthorsPaneInner").click(function(){
		saveOrCancel();
		return false;
	});

	$("#rightPaneBlogAuthors .addBlogAuthor").show();
	$("#rightPaneBlogAuthors .addBlogAuthor .focus").focus();
	prepFancyLabelForms($("#rightPaneBlogAuthors .addBlogAuthor"));

	function saveOrCancel () {
		if ($("#error:visible").length) {
			$("#error").fadeOut();
			return false;
		}
		var name = encodeURIComponent($(".newBlogAuthorName",$("#blogAuthorsPaneInner .addBlogAuthor")).val());
		var bio = encodeURIComponent($(".newBlogAuthorBio",$("#blogAuthorsPaneInner .addBlogAuthor")).val());
		var nameraw = $(".newBlogAuthorName",$("#blogAuthorsPaneInner .addBlogAuthor")).val();
		var bioraw = $(".newBlogAuthorBio",$("#blogAuthorsPaneInner .addBlogAuthor")).val();


		if (name=="") {
			$("#blogAuthorsPaneInner .noPages").show();
			resetAddForms();
		} else {
			logTrainingClick("newBlogAuthorEnter");
			working();
			$.ajax({
			  type: "POST",
			  url: "blogActions.php",
			  data: "blogAction=addAuthor&name="+name+"&bio="+bio,
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if (msg=="Exists") {
					error(LangVars.Blog_Author_Exists);
				} else {

					$("#blogAuthorsList .addBlogAuthor").after("<a blog-author-id=\""+msg+"\" blog-author-bio=\""+htmlentities(bioraw)+"\"><span class=\"overflowEllipsis\" id=\""+msg+"\">"+htmlentities(nameraw)+"</span></a>");

					if (!$("#blogAuthorsList .iconbarRule").length) {
						$("#blogAuthorsList").append("<div class='iconbarRule'></div>");
					}
					$("#blogAuthorsList").show();
					$("#blogAuthorsList").next().show();



					$("#rightPaneBlogAuthors .noPages").remove();
					$("#rightPaneBlogAuthors .insertTarget").prepend("<div class='dropzone'><div></div></div><div class='responsiveListItem' blog-author-id='"+msg+"' blog-author-bio=\""+htmlentities(bioraw)+"\"><span class='overflowEllipsis'>"+htmlentities(nameraw)+"</span></div><div class='responsiveListAddForm inline' style='display:none'><div class='imageContextEditFieldset'><div class='imageContextEditLabel'>&nbsp;"+LangVars.Blog_Author_Name+"</div><div class='imageContextEditInputWrap'><input type='text' name='' class='focus newBlogAuthorName' value=\""+htmlentities(nameraw)+"\" original=\""+htmlentities(nameraw)+"\" /></div></div><div class='imageContextEditFieldset'><div class='imageContextEditLabel'>&nbsp;"+LangVars.Blog_Author_Bio+"</div><div class='imageContextEditInputWrap'><input type='text' name='' class='newBlogAuthorBio' value=\""+htmlentities(bioraw)+"\" original=\""+htmlentities(bioraw)+"\" /></div></div></div>");
					$("#blogAuthorsPaneInner").lovelyScroll();

					$("input",$("#blogAuthorsPaneInner .addBlogAuthor")).val("");
					resetAddForms();
					$("#blogAuthorsList a").remove();
					$("#rightPaneBlogAuthors .insertTarget .responsiveListItem").each(function(){
						$("#blogAuthorsList").append("<li><a class='authorItem' blog-author-id=\""+$(this).attr("blog-author-id")+"\" data-item-value=\""+$(this).attr("blog-author-id")+"\" blog-author-bio=\""+$(this).attr("blog-author-bio")+"\" data-lang=\""+$(".overflowEllipsis",$(this)).html()+"\"><span class=\"overflowEllipsis\">"+$(".overflowEllipsis",$(this)).html()+"</span></a></li>");
					});


					selectionTools();
					saved();
					assignListPane($("#blogAuthorsPaneInner .insertTarget"),editBlogAuthor);

				}

			   }
			});


		}
	}

	$(document).keyup(function(e){
		if (e.keyCode==13) { // enter
			//saveOrCancel();
			return false;
		}
	});
	$("#rightPaneBlogAuthors .addBlogAuthor input").keydown(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
	});
	$(document).keydown(function(e){
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});
	$(document).click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		saveOrCancel();
		return false;
	});
}
function editBlogAuthor ($clicked) {
	editMeListItemMultiple($clicked);
}
function deleteBlogAuthorsPrep () {
		if ($("#blogAuthorsPaneInner .listItemHighlight").length) {
	prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Blog_Author_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteBlogAuthors,false,true);
		}

}
function deleteBlogAuthors () {
	var Ids="[";
	$("#blogAuthorsPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("blog-author-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("blog-author-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "blogActions.php",
	  data: "blogAction=deleteAuthors&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#blogAuthorsPaneInner .listItemHighlight").each(function(){
			$("#blogAuthorsList a[blog-author-id="+$(this).attr("blog-author-id")+"]").remove();
			$(this).next().remove();
			$(this).next().remove();
			$(this).remove();
		});
		if ($("#blogAuthorsList a").length==0) {
			$("#blogAuthorsList").hide();
			$("#blogAuthorsList").next().hide();
		}

		if (!$("#blogAuthorsList a").length) {
			$("#blogAuthorsPaneInner .insertTarget").append("<div class='noPages'>"+LangVars.No_Blog_Authors+"</div>");
			$("#blogAuthorsList .iconbarRule").remove();
		}
		$("#blogAuthorsPaneInner").lovelyScroll();
		saved();
		hide_iconbar_menus();
		hidePaneTools();
		cancelDialogue();
		selectionTools();
	  }
	});
}
function editBlogCategory ($clicked) {
	editMeListItem($clicked);
	return false;
}

function addBlogCategory () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");
	$("#blogCategoriesPaneInner .noPages").hide();
	$("#blogCategoriesPaneInner .addBlogCategory").submit(function(){return false;});
	$("#blogCategoriesPaneInner .addBlogCategory").show();
	$("#blogCategoriesPaneInner .addBlogCategory .focus").focus();
	prepFancyLabelForms($("#blogCategoriesPaneInner .addBlogCategory"));
	function saveOrCancel () {
		$("#blogCategoriesPaneInner .addBlogCategory .focus").unbind("blur");
		if ($("#error:visible").length) {
			$("#error").fadeOut();
			return false;
		}
		if ($("#blogCategoriesPaneInner .addBlogCategory .focus").val()=="" || $("#blogCategoriesPaneInner .addBlogCategory .focus").val()==" ") {
			$("#blogCategoriesPaneInner .addBlogCategory").hide();

			assignBlogCategoriesKeys();
		} else {


			var title = encodeURIComponent($(".focus",$("#blogCategoriesPaneInner .addBlogCategory")).val());
			var nameraw = $(".focus",$("#blogCategoriesPaneInner .addBlogCategory")).val();
			if (title=="") {

				resetAddForms();
				$("#blogCategoriesPaneInner .noPages").show();

				return false;
			} else {
				working();
				$.ajax({
				  type: "POST",
				  url: "blogActions.php",
				  data: "blogAction=addCategory&name="+title,
				  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					if (msg=="Exists") {
						error(LangVars.Blog_Category_Exists);
					} else {
						$("#blogCategoriesList").append("<li><a blog-category-id=\""+msg+"\" data-item-value=\""+msg+"\" data-lang=\""+htmlentities(nameraw)+"\" data-reverse-order=\"0\">"+htmlentities(nameraw)+"</a></li>");

						if ($("#blogCategoriesList li").length===0) {
							$("#blogCategoriesList").next().hide();
						} else {
							$("#blogCategoriesList").next().show();
						}
						$("#rightPaneBlogCategories .noPages").remove();
						$("#rightPaneBlogCategories .insertTarget").append("<div class='responsiveListItem' blog-category-id='"+msg+"' data-reverse-order=\"0\"><span class='overflowEllipsis'>"+htmlentities(nameraw)+"</span></div><div class=\"responsiveListAddForm inline\" style='display:none;' action=\"\" method=\"post\" rel=\""+msg+"\"><input type=\"text\" name=\"\" value=\""+htmlentities(nameraw)+"\" class=\"focus\"	/></div><div class='dropzone'><div></div></div>");
						$("#blogCategoriesPaneInner").scrollTop(10000);
						$("#rightPaneBlogCategories .insertTarget .responsiveListItem:last").addClass("");
						resetAddForms();
						$("input",$("#blogCategoriesPaneInner .addBlogCategory")).val("");
						$("#blogCategoriesPaneInner").lovelyScroll();
						selectionTools();
						saved();
						updateBlogCatFilterMenu();

					}

				   }
				});
			}

		}
	}
	$("#blogCategoriesPaneInner .addBlogCategory .focus").unbind("blur").blur(function(){
		saveOrCancel();
		return false;
	});
	$(document).keyup(function(e){
		if (e.keyCode==13) { // enter

			return false;
		}
	});
	$(document).keydown(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});/*
	$(document).click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		saveOrCancel();
		return false;
	});*/
}
function deleteBlogCategoriesPrep () {
	if ($("#blogCategoriesPaneInner .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Blog_Category_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteBlogCategories,false,true);
	}
}
function updateBlogCatFilterMenu() {
	$("#blogFilterCategoriesToUpdate").html("");
	$("#blogCategoriesList li").each(function(){
		$("#blogFilterCategoriesToUpdate").append($(this).clone());
	});
	if ($("#blogCategoriesList li").length) {
		$("#blogCategoryFilterMenu").show();
	} else {
		$("#blogCategoryFilterMenu").hide();
	}
}
function deleteBlogCategories () {
	var Ids="[";
	$("#blogCategoriesPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("blog-Category-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("blog-Category-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "blogActions.php",
	  data: "blogAction=deleteCategories&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#blogCategoriesPaneInner .listItemHighlight").each(function(){
			$("#blogCategoriesList a[blog-category-id="+$(this).attr("blog-category-id")+"]").parent().remove();
			$(this).next().remove();
			$(this).next().remove();
			$(this).remove();
		});
		if (!$("#blogCategoriesList a").length) {
			$("#blogCategoriesPaneInner > div").append("<div class='noPages'>"+LangVars.No_Blog_Categories+"</div>");
		//	$("#blogCategoriesList .iconbarRule").remove();
		}
		if ($("#blogCategoriesList li").length===0) {
			$("#blogCategoriesList").next().hide();

		} else {
			$("#blogCategoriesList").next().show();
		}
		for (var i = 0; i < Ids.length; i++) {
			if ($("#blogFilterCategoriesToUpdate a.bpe_current[blog-category-id=\""+Ids[i]+"\"]").length) {
				switchToBlog(true,true);
			}
		}

		updateBlogCatFilterMenu();
		hidePaneTools();
		saved();
		hide_iconbar_menus();
		$("#blogCategoriesPaneInner").lovelyScroll();
		cancelDialogue();
		selectionTools();
	  }
	});
}
function toggleReverseBlogCats() {
	var Ids="[";
	$("#blogCategoriesPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("blog-Category-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("blog-Category-id")+'"';
		}
	});
	Ids+="]";
	working();
	if ($("#reverseBlogsToggle").hasClass("bpe_current")) {
		var action = "0";
	} else {
		var action = "1";
	}
	$.ajax({
	  type: "POST",
	  url: "blogActions.php",
	  data: "blogAction=reverseOrderToggle&action="+action+"&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$("#blogCategoriesPaneInner .listItemHighlight").each(function(){
			$(this).attr("data-reverse-order",action);
			$("#blogCategoriesList a[blog-category-id="+$(this).attr("blog-category-id")+"]").attr("data-reverse-order",action);
		});
		saved();
		selectionTools();
	  }
	});
}

// Snippet Categories

function editSnippetCategory ($clicked) {
	editMeListItem($clicked);
	return false;
}
function deleteSnippetCategoriesPrep () {
	if ($("#snippetCategoriesPaneInner .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Snippet_Category_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteSnippetCategories,false,true);
	}
}
function deleteSnippetCategories () {
	var Ids="[";
	$("#snippetCategoriesPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("snippet-category-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("snippet-category-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "snippetsActions.php",
	  data: "snippetsAction=deleteCategories&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

		$("#snippetCategoriesList").load("snippetsActions.php?snippetsAction=showCategories",function(){
			if ($("#snippetCategoriesList li").length==0) {
				$("#filterBySnippetCat").hide();
				$("#snippetCategoriesList").next().hide();
				$("#snippetCategoriesList").hide();
			}
			if ($("#rightPaneSnippetCategories .snippetCatItem").length===0) {
				$("#rightPaneSnippetCategories .noPages").show();
			}
			displaySnippetCats();
			selectionTools();
			assignSnippetCategoriesKeys();
			cancelDialogue();
			saved();
			$("#snippetCategoriesPaneInner").lovelyScroll();
		});

	  }
	});
}
function addSnippetCategory () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");
	$("#rightPaneSnippetCategories .noPages").hide();
	$("#rightPaneSnippetCategories .addSnippetCategory").show();
	prepFancyLabelForms($("#rightPaneSnippetCategories .addSnippetCategory"));
	$("#rightPaneSnippetCategories .addSnippetCategory .focus").focus();
	function saveOrCancel () {
		$("#rightPaneSnippetCategories .addSnippetCategory .focus").unbind("blur");
		if ($("#rightPaneSnippetCategories .addSnippetCategory .focus").val()=="" || $("#rightPaneSnippetCategories .addSnippetCategory .focus").val()==" ") {
			resetAddForms();
			if ($("#rightPaneSnippetCategories .snippetCatItem").length===0) {
				$("#rightPaneSnippetCategories .noPages").show();
			}
		} else {
			working();

			$.ajax({
			  type: "POST",
			  url: "snippetsActions.php",
			  data: "snippetsAction=addCategory&name="+encodeURIComponent($("#rightPaneSnippetCategories .addSnippetCategory .focus").val()),
			  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#filterBySnippetCat").show();
				$("#snippetCategoriesList").next().show();
				$("#snippetCategoriesList").show().load("snippetsActions.php?snippetsAction=showCategories",function(){
					saved();
					displaySnippetCats();
					$("#snippetCategoriesPaneInner .responsiveListItem:first").addClass("listItemHighlight");
					$("#snippetCategoriesPaneInner").lovelyScroll();
					assignSnippetCategoriesKeys();
					setTimeout(function() {
						selectionTools();
					}, 100);

					resetAddForms();
				});

			  }
			});
		}
	}
	$("#rightPaneSnippetCategories .addSnippetCategory .focus").unbind("blur").blur(function(){
		saveOrCancel();
		return false;
	});
	$(document).keyup(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
	});
	$(document).keydown(function(e){
		if (e.keyCode==13) { // enter

			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});
}
function displaySnippetCats () {
	$("#snippetCategoriesPaneInner .insertTarget").html("");

	$("#snippetCategoriesPaneInner .insertTarget").append($("#snippetsPaneInner #snippetCatsMenuList .addSnippetCategory").first().clone());
	$("#snippetCategoriesPaneInner .insertTarget").append("<div class='dropzone'><div></div></div>");
	hidePaneTools();

	var c = 0;
	$("#snippetCategoriesList a").each(function(){
		$("#snippetCategoriesPaneInner .insertTarget").append("<div class='responsiveListItem snippetCategoryItem' data-pinned='"+$(this).attr("data-pinned")+"' snippet-category-id='"+$(this).attr("snippet-cat-id")+"'><span class='overflowEllipsis'>"+htmlentities($(".overflowEllipsis",$(this)).html())+"</span></div><div class=\"responsiveListAddForm inline\" style='display:none;' action=\"\" method=\"post\" rel=\""+$(this).attr("snippet-cat-id")+"\"><input type=\"text\" name=\"\" value=\""+htmlentities($(".overflowEllipsis",$(this)).html())+"\" class=\"focus\"	/></div><div class='dropzone'><div></div></div>");
		c++;
	});
	if (c==0) {
		$("#snippetCategoriesPaneInner .insertTarget").append("<div class='noPages'>"+LangVars.No_Snippet_Categories+"</div>");

	}

	updateSnippetCatFilterMenu();

}
function updateSnippetCatFilterMenu () {
	if ($("#snippetCategoriesList a").length) {
		$("#rightPaneSnippets .filterBar").show();
		$("#snippetsPaneInner").addClass("withFilterBar");
		$("#snippetFilterCategories").html("");
		$("#snippetCategoriesList a").each(function(){
			$("#snippetFilterCategories").append('<li><a href="#" class="filterBy filterLink" data-lang="'+htmlentities($(".overflowEllipsis",$(this)).html())+'" category-id="'+$(this).attr("snippet-cat-id")+'"><span>'+htmlentities($(".overflowEllipsis",$(this)).html())+'</span></a></li>');
		});
	} else {
		$("#rightPaneSnippets .filterBar").hide();
		$("#snippetsPaneInner").removeClass("withFilterBar");
	}
}
function showComments ($clicked) {
	hidePanes();

	$("input").unbind();
	$("#loadingMask").show();
	$("#rightPaneBlog").hide();
	hide_iconbar_menus();
	$("#blogCommentsPaneInner .insertTarget").html($(".commentsList",$clicked).html());

	hidePaneTools();
	$("#viewingBlogComments").attr("blog-id",$clicked.attr("blog-id"));
	assignListLasso($("#blogCommentsPaneInner .insertTarget"));
	assignListPane($("#blogCommentsPaneInner .insertTarget"),editBlogComment);
	assignBlogCommentsKeys();

	$("#rightPaneBlogComments").show();
	$(window).trigger("resize");
	$("#blogCommentsPaneInner").lovelyScroll();
	$("#loadingMask").hide();
	return false;
}
function editBlogComment () {

}
function blogCommentApproval (approved) {
	var Ids="[";
	$("#blogCommentsPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("blog-comment-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("blog-comment-id")+'"';
		}
	});
	Ids+="]";

	var blogId = $("#viewingBlogComments").attr("blog-id");
	working();
		$.ajax({
		  type: "POST",
		  url: "blogActions.php",
		  data: "blogAction=approveComment&ids="+Ids+"&action="+approved,
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			if (approved=="approve"){
				$("#blogCommentsPaneInner .listItemHighlight").each(function(){
					if ($(this).hasClass("offline")) {
						$(this).removeClass("offline").attr("data-blog-comment-status","live");
						$(".numberApproved",$(".editBlogBar[blog-id="+blogId+"]")).html(parseInt($(".numberApproved",$(".editBlogBar[blog-id="+blogId+"]")).html())+1);
						$(".numberNotApproved",$(".editBlogBar[blog-id="+blogId+"]")).html(parseInt($(".numberNotApproved",$(".editBlogBar[blog-id="+blogId+"]")).html())-1);
					}
				});

				$(".numberApproved",$(".editBlogBar[blog-id="+blogId+"]")).removeClass("hidden");
				$(".numberNotApproved",$(".editBlogBar[blog-id="+blogId+"]")).removeClass("byitself");

			} else {
				$("#blogCommentsPaneInner .listItemHighlight").each(function(){
					if (!$(this).hasClass("offline")) {
						$(this).addClass("offline").attr("data-blog-comment-status","offline");
						$(".numberApproved",$(".editBlogBar[blog-id="+blogId+"]")).html(parseInt($(".numberApproved",$(".editBlogBar[blog-id="+blogId+"]")).html())-1);
						$(".numberNotApproved",$(".editBlogBar[blog-id="+blogId+"]")).html(parseInt($(".numberNotApproved",$(".editBlogBar[blog-id="+blogId+"]")).html())+1);

					}
				});
				$(".numberNotApproved",$(".editBlogBar[blog-id="+blogId+"]")).removeClass("hidden");
				$(".numberApproved",$(".editBlogBar[blog-id="+blogId+"]")).removeClass("byitself");
			}
			if ( $(".numberApproved",$(".editBlogBar[blog-id="+blogId+"]")).html() == "0" ) {
				$(".numberApproved",$(".editBlogBar[blog-id="+blogId+"]")).addClass("hidden");
				$(".numberNotApproved",$(".editBlogBar[blog-id="+blogId+"]")).addClass("byitself");
			}
			if ( $(".numberNotApproved",$(".editBlogBar[blog-id="+blogId+"]")).html() == "0" ) {
				$(".numberNotApproved",$(".editBlogBar[blog-id="+blogId+"]")).addClass("hidden");
				$(".numberApproved",$(".editBlogBar[blog-id="+blogId+"]")).addClass("byitself");
			}
			selectionTools();
			$("#blogPaneInner #commentsList"+blogId).html($("#blogCommentsPaneInner .insertTarget").html());
			saved("Comment Approved");
		  }
		});


}
function deleteBlogComments () {
		var Ids="[";
		$("#blogCommentsPaneInner .listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("blog-comment-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("blog-comment-id")+'"';
			}
		});
		Ids+="]";

		var blogId = $("#viewingBlogComments").attr("blog-id");
		working();
			$.ajax({
			  type: "POST",
			  url: "blogActions.php",
			  data: "blogAction=deleteComments&ids="+Ids,
			  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

				$("#blogCommentsPaneInner .listItemHighlight").each(function(){
					if (!$(this).hasClass("offline")) {
						$(".numberApproved",$(".editBlogBar[blog-id="+blogId+"]")).html(parseInt($(".numberApproved",$(".editBlogBar[blog-id="+blogId+"]")).html())-1);

					} else {
						$(".numberNotApproved",$(".editBlogBar[blog-id="+blogId+"]")).html(parseInt($(".numberNotApproved",$(".editBlogBar[blog-id="+blogId+"]")).html())-1);

					}
					$(this).next().remove();
					$(this).remove();
				});

				if ( $(".numberApproved",$(".editBlogBar[blog-id="+blogId+"]")).html() == "0" ) {
					$(".numberApproved",$(".editBlogBar[blog-id="+blogId+"]")).addClass("hidden");
					$(".numberNotApproved",$(".editBlogBar[blog-id="+blogId+"]")).addClass("byitself");
				}
				if ( $(".numberNotApproved",$(".editBlogBar[blog-id="+blogId+"]")).html() == "0" ) {
					$(".numberNotApproved",$(".editBlogBar[blog-id="+blogId+"]")).addClass("hidden");
					$(".numberApproved",$(".editBlogBar[blog-id="+blogId+"]")).addClass("byitself");
				}

				$("#blogPaneInner #commentsList"+blogId).html($("#blogCommentsPaneInner .insertTarget").html());
				hide_iconbar_menus();
				$("#blogCommentsPaneInner").lovelyScroll();
				cancelDialogue();
				selectionTools();
				saved("Comments removed");
				if ($("#blogCommentsPaneInner .blogComment").length==0) {
					$(".showSubPages",$(".editBlogBar[blog-id="+blogId+"]")).remove();
					$(".editBlogBar[blog-id="+blogId+"]").removeClass("withComments");
					hidePanes();
					$("input").unbind();
					$("#loadingMask").show();
					$(".rightPane,#dragInsert").hide();
					switchToBlog(false,false);
				}
			  }
			});


}
function deleteBlogCommentsPrep () {
	if ($("#blogCommentsPaneInner .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Blog_Comment_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteBlogComments,false,true);
	}
}
function addCommentReply () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");

	$("#blogCommentsPaneInner").unbind("click");
	/*$("#blogCommentsPaneInner").click(function(){
		saveOrCancel();
		return false;
	});*/
	hidePaneTools();
	$("#rightPaneBlogComments .addBlogComment").show();
	$("#rightPaneBlogComments .addBlogComment .focus").focus();
	prepFancyLabelForms($("#rightPaneBlogComments .addBlogComment"));
	$(".imageContextEditFieldset textarea",$("#rightPaneBlogComments .addBlogComment")).autosize();
	var blogId = $("#viewingBlogComments").attr("blog-id");

	function saveOrCancel () {
		if ($("#error:visible").length) {
			$("#error").fadeOut();
			return false;
		}
		var name = encodeURIComponent($(".replyName",$("#blogCommentsPaneInner .addBlogComment")).val());
		var email = encodeURIComponent($(".replyEmail",$("#blogCommentsPaneInner .addBlogComment")).val());
		var comment = encodeURIComponent($(".replyComment",$("#blogCommentsPaneInner .addBlogComment")).val());
		var nameraw = $(".replyName",$("#blogCommentsPaneInner .addBlogComment")).val();
		var emailraw = $(".replyEmail",$("#blogCommentsPaneInner .addBlogComment")).val();
		var commentraw = $(".replyComment",$("#blogCommentsPaneInner .addBlogComment")).val();


		if (comment=="") {
			resetAddForms();

		} else {

			working();
			$.ajax({
			  type: "POST",
			  url: "blogActions.php",
			  data: "blogAction=addBlogComment&blogId="+$("#viewingBlogComments").attr("blog-id")+"&name="+name+"&email="+email+"&comment="+comment,
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					var response = msg.split("**284k;s;*");
					$("#blogCommentsPaneInner .insertTarget").prepend("<div class=\"dropzone\"><div></div></div><div class=\"blogComment responsiveListItem\" blog-comment-id='"+response[0]+"' data-blog-comment-status='live'><div class=\"responsiveListItemImage\" style=\"background: url('http://www.gravatar.com/avatar/"+response[1]+"?s=50') 50% 50%;\"></div><strong><a href=\"mailto:"+htmlentities(emailraw)+"\">"+htmlentities(nameraw)+"</a>:</strong>"+response[2]+"</div>");

					$(".numberApproved",$(".editBlogBar[blog-id="+blogId+"]")).html(parseInt($(".numberApproved",$(".editBlogBar[blog-id="+blogId+"]")).html())+1).removeClass("hidden");
					$(".numberNotApproved",$(".editBlogBar[blog-id="+blogId+"]")).removeClass("byitself");


					$("#blogCommentsPaneInner .noPages").remove();
					$("#blogPaneInner #commentsList"+blogId).html($("#blogCommentsPaneInner .insertTarget").html());
					$("#rightPaneBlogComments .addBlogComment").hide();
					$("input,textarea",$("#blogCommentsPaneInner .addBlogComment")).val("");
					$("#blogCommentsPaneInner").lovelyScroll();
					resetAddForms();
					selectionTools();
					saved();
					assignListPane($("#blogCommentsPaneInner .insertTarget"),editBlogComment);


			   }
			});


		}
	}
	$("#rightPaneBlogComments .addBlogComment input").keydown(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
	});
	$(document).keydown(function(e){
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});

	$(document).click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		saveOrCancel();
		return false;
	});
}
function editCheckoutOrder ($el) {
	showOrderPopdown($(".orderDetails",$el));
}
function changePayPalEmail (newVal) {
	working();
	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=saveSettings&paypal_email="+encodeURIComponent(newVal),
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			saved();
			cancelDialogue();
			$("#changePayPalEmail .value .overflowEllipsis").html(newVal);
			$("#changePayPalEmail .value").attr("title",newVal);

	  }
	});
}
function changeMerchantID (newVal) {
	working();
	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=saveSettings&merchant_id="+encodeURIComponent(newVal),
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			saved();
			cancelDialogue();
			$("#changeMerchantID .value .overflowEllipsis").html(newVal);
			$("#changeMerchantID .value").attr("title",newVal);

	  }
	});
}
function changeCheckoutFrom (name,email) {
	working();
	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=saveSettings&from_name="+encodeURIComponent(name)+"&from_email="+encodeURIComponent(email),
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			saved();
			cancelDialogue();
			$("#checkoutFromSetting .value .overflowEllipsis").html(name+" ("+email+")");
			$("#checkoutFromSetting").attr("checkout-from-name",name).attr("checkout-from-email",email);
			$("#checkoutFromSetting .value").attr("title",name+" ("+email+")");

	  }
	});
}
function changeCheckoutSMTP (server,username,password) {
	working();
	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=saveSettings&smtp_server="+encodeURIComponent(server)+"&username="+encodeURIComponent(username)+"&password="+encodeURIComponent(password),
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			if (msg!="ok") {
				error(msg);
			} else {
				saved();
				cancelDialogue();

				$("#checkoutSMTPSetting").attr("checkout-server",server).attr("checkout-username",username).attr("checkout-password",password);
				$("#checkoutSMTPSetting .value span").html(server);
				$("#checkoutSMTPSetting .value").attr('title',server);
			}

	  }
	});
}
function changeSalesTax(text) {
	$.ajax({
		  type: "POST",
		  url: "shopActions.php",
		  data: "shopAction=saveSettings&sales_tax="+encodeURIComponent(text),
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

			saved();
			hide_menus();
			cancelDialogue();

			$("#changeSalesTax .value .overflowEllipsis").text(text);
		  }
		});
}
function changeSalesTaxName(text) {
	$.ajax({
		  type: "POST",
		  url: "shopActions.php",
		  data: "shopAction=saveSettings&sales_tax_name="+encodeURIComponent(text),
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

			saved();
			hide_menus();
			cancelDialogue();

			$("#changeSalesTaxName .value .overflowEllipsis").text(text);
		  }
		});
}
function changeOrderReceivedTemplate (subject,body) {
	$.ajax({
		  type: "POST",
		  url: "shopActions.php",
		  data: "shopAction=saveSettings&order_received_email_subject="+encodeURIComponent(subject)+"&order_received_email="+body,
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

			saved();
			hide_menus();
			cancelDialogue();

			$("#order_received_email").val(body);
			$("#order_received_email_subject").val(subject);
		  }
		});
}
function changeOrderDispatchedTemplate (subject,body) {
	$.ajax({
		  type: "POST",
		  url: "shopActions.php",
		  data: "shopAction=saveSettings&order_sent_email_subject="+encodeURIComponent(subject)+"&order_sent_email="+body,
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

			saved();
			hide_menus();
			cancelDialogue();

			$("#order_sent_email").val(body);
			$("#order_sent_email_subject").val(subject);
		  }
		});
}
function changeSuccessPage ($el) {
	working();
	var id = $el.attr("rel");
	var el = $el;
	var title = el.attr("title");
	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=saveSettings&return_success="+id,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		if (msg != "error") {
			saved("Success landing page changed to page id: ");
			$("#checkoutSuccessPage .value .overflowEllipsis").html(title);
			$("#checkoutSuccessPage .value").attr("title",title);
			if ($("#lightPagesList").length) {
				$("#lightPagesOuter").animate({opacity:"0"},550,function(){
					$("#lightPagesOuter").remove();
				});
				return false;
			}

		}
	  }
	});
}
function changeFailPage ($el) {
	working();
	var id = $el.attr("rel");
	var el = $el;
	var title = el.attr("title");
	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=saveSettings&return_fail="+id,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		if (msg != "error") {
			saved("Success landing page changed to page id: ");
			$("#checkoutFailPage .value .overflowEllipsis").html(title);
			$("#checkoutFailPage .value").attr("title",title);
			if ($("#lightPagesList").length) {
				$("#lightPagesOuter").animate({opacity:"0"},550,function(){
					$("#lightPagesOuter").remove();
				});
				return false;
			}

		}
	  }
	});
}
function dispatchOrders () {
	var Ids="[";
	$("#checkoutPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("buyer-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("buyer-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=orderDispatch&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

		saved("'Dispatched' email sent");
		$("#checkoutPaneInner .listItemHighlight").each(function(){
			$(this).next().remove();
			$(this).remove();
		});
		cancelDialogue();
		selectionTools();
		urchin();
	  }
	});

}
function deleteOrdersPrep () {
	if ($("#checkoutPaneInner .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Order_Delete_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteOrders,false,true);
	}
}
function deleteOrders () {
	var Ids="[";
	$("#checkoutPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("buyer-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("buyer-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "shopActions.php",
	  data: "shopAction=archive&ids="+Ids,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

		saved();
		$("#checkoutPaneInner .listItemHighlight").each(function(){
			$(this).next().remove();
			$(this).remove();
		});
		cancelDialogue();
		selectionTools();
		hide_menus();
		urchin();
	  }
	});
}
var chatting=false;
function closeChat () {
	chatting=false;
	$("#livechatFloater").hide();
	createCookie("chat",false,-1);
}
function openChat ($clicked) {
	var href= $clicked.attr("livechat-href");
	//window.open(href,'null','toolbar=0,scrollbars=0,location=0,statusbar=0,menubar=0,resizable=0,width=311,height=349');
	createCookie("chat",href,30);
	var chatx = readCookie("chatx");
	var chaty = readCookie("chaty");
	if (chatx) {
		if ($(window).width>580 && $(window).height()>580) {
			$("#livechatFloater").css("left",chatx+"px").css("top",chaty+"px");
		}
	}
	$("#livechatiframe").attr("src",href);
	$("#livechatFloater").show();
}
function prepDeleteLivechats () {
		if ($("#livechatPaneInner .listItemHighlight").length) {
	prepDialogue("<h2>"+LangVars.Livechat_Delete_Heading+"</h2><p>"+LangVars.Livechat_Delete_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteLivechats,false,true);
		}
}
function deleteLivechats () {
	var Ids="[";
	$("#livechatPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("chat-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("chat-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
		type: "POST",
		url: "/livechat/actions/kill.php",
		data: "&chatIds="+Ids,
		success: function(msg){
			livechat_init();
			saved();
			cancelDialogue();
			selectionTools();
			hide_menus();
			urchin();
		}
	});
}
function changeLivechatMessage (text) {
	working();
	$.ajax({
	  type: "POST",
	  url: "livechatActions.php",
	  data: "livechatAction=saveConfig&livechat_message="+encodeURIComponent(text),
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			saved();
			cancelDialogue();
			$("#livechatMessage .value .overflowEllipsis").html(text);
			$("#livechatMessage .value").attr("title",text);

	  }
	});
}
function changeLivechatName (text) {
	working();
	$.ajax({
	  type: "POST",
	  url: "livechatActions.php",
	  data: "livechatAction=saveConfig&livechat_name="+encodeURIComponent(text),
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			saved();
			cancelDialogue();
			$("#livechatName .value .overflowEllipsis").html(text);
			$("#livechatName .value").attr("title",text);

	  }
	});
}
function changeThemeOption (text) {
	$("#themeOptions .themeOptionText.editing").attr("theme-var-value",text);
	$(".value .overflowEllipsis",$("#themeOptions .themeOptionText.editing")).html(htmlentities(text)).attr("title",htmlentities(text));
	$("#themeOptions .themeOptionText.editing").removeClass("editing");
	cancelDialogue();
	buildThemeVars();
}
function changeAccountEmail (text) {

	if (text!=$("#changeAdminEmail").attr("account-email")) {
		working();
		$.ajax({
		  type: "POST",
		  url: "adminUsersActions.php",
		  data: "adminUsersAction=changeEmail&email="+encodeURIComponent(text),
		  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if (msg=="exists") {
					error(LangVars.Email_Exists);
				} else {
					saved();
					cancelDialogue();
					$("#changeAdminEmail").attr("account-email",text);
				}


		  }
		});
	}

}
function changeAccountPassword (old,pass1,pass2) {
	if (pass1!=pass2 || pass1=="") {
		return false;
	}
	working();
	var pwhash = hex_hmac_sha1(pass1,$("#adminUserSalt").val());
	var pwhashold = hex_hmac_sha1(old,$("#adminUserSalt").val());
	working();
	$.ajax({
	  type: "POST",
	  url: "adminUsersActions.php",
	  data: "adminUsersAction=changePass&hash="+encodeURIComponent(pwhash)+"&salt="+$("#adminUserSalt").val()+"&old_password="+pwhashold,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if (msg=="wrong") {
					error(LangVars.Wrong_Current_Pass);
				} else {
					saved();
					cancelDialogue();

				}

	  }
	});
}
function changeYourAccount (email,old,pass1,pass2) {

	if (old!="") {
		if (pass1!=pass2 || pass1=="") {
			error(LangVars.Error_Passwords_Dont_Match);
			return false;
		}
	}

	working();

	if (pass1!="") {
		var pwhash = encodeURIComponent(hex_hmac_sha1(pass1,$("#adminUserSalt").val()));
		var pwhashold = hex_hmac_sha1(old,$("#adminUserSalt").val());
	} else {
		var pwhash = "";
		var pwhashold ="";
	}

	working();
	$.ajax({
	  type: "POST",
	  url: "adminUsersActions.php",
	  data: "adminUsersAction=changeYourAccount&hash="+pwhash+"&salt="+$("#adminUserSalt").val()+"&old_password="+pwhashold+"&email="+email,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if (msg=="wrong") {
					error(LangVars.Wrong_Current_Pass);
				} else {
					saved();
					cancelDialogue();
					if (email!="") {
						$("#accountEmail").html(email);
					}

				}

	  }
	});
}
function resetStaffPassword (pass1,pass2) {


	if (pass1!=pass2 || pass1=="") {
		error(LangVars.Error_Passwords_Dont_Match);
		return false;
	}


	working();

	if (pass1!="") {
		var pwhash = encodeURIComponent(hex_hmac_sha1(pass1,$("#adminUserSalt").val()));
	} else {
		var pwhash = "";
		var pwhashold ="";
	}

	working();
	$.ajax({
	  type: "POST",
	  url: "adminUsersActions.php",
	  data: "adminUsersAction=resetStaffPass&hash="+pwhash+"&admin_usersid="+$("#staffPane .listItemHighlight").attr("staff-id")+"&token="+encodeURIComponent($("#session").val()),
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }


				saved();
				cancelDialogue();


	  }
	});
}
function prepFancyLabelForms($form){
	$(".imageContextEditFieldset",$form).each(function(){
		if ($("input,textarea",$(this)).val()==""){
			$(".imageContextEditLabel",$(this)).css("visibility","visible");
		}
	});
	$("input,textarea",$form).focus(function(){
		$(document).unbind("keyup");
		$(document).unbind("keydown");
		$(document).unbind("keypress");
		$(this).parents(".imageContextEditFieldset").addClass("focusing");
	});
	$("input,textarea",$form).blur(function(){
		$(this).parents(".imageContextEditFieldset").removeClass("focusing");
	});
	$(".sendMe",$form).hide();
	$(".imageContextEditFieldset input,.imageContextEditFieldset textarea",$form).unbind("keyup").keyup(function(){
		if ($(this).val()!="") {
			$(".imageContextEditLabel",$(this).parents(".imageContextEditFieldset")).css("visibility","hidden");
		} else {
			$(".imageContextEditLabel",$(this).parents(".imageContextEditFieldset")).css("visibility","visible");
		}
		if ($('.okToSendWhenFilled',$form).filter(function() { return !this.value; }).length) {
			$(".sendMe",$form).fadeOut();
		} else {
			$(".clearSearch",$form).fadeOut();
			$(".sendMe",$form).fadeIn();
		}
	});
	$(".sendMe",$form).click(function(){
		$(this).parents("form").submit();
	});

}
function addStaff () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");

	/*$("#staffPaneInner").unbind("click");
	$("#staffPaneInner").click(function(){
		resetAddForms();
		return false;
	});*/
	hidePaneTools();
	$("#staffPaneInner #addStaff").show();
	$("#staffPaneInner #addStaff .focus").focus();

	$("#staffPaneInner .noPages").hide();

	prepFancyLabelForms($("#staffPaneInner #addStaff"));
	function saveOrCancel () {
		if ($("#error:visible").length) {
			$("#error").fadeOut();
			return false;
		}


		var email = encodeURIComponent($(".newStaffEmail",$("#staffPaneInner #addStaff")).val());
		var pass1 = $(".newStaffPassword",$("#staffPaneInner #addStaff")).val();
		var pass2 = $(".newStaffPassword2",$("#staffPaneInner #addStaff")).val();

		if (email=="") {

			resetAddForms();
			if ($("#staffPaneInner .responsiveListItem").length===0) {
				$("#staffPaneInner .noPages").show();
			}
			return false;
		} else {
			if (pass1==pass2 && (pass1!="" || pass2!="")) {
				var hash = hex_hmac_sha1(pass1,$("#adminUserSalt").val());
				working();
				$.ajax({
				  type: "POST",
				  url: "adminUsersActions.php",
				  data: "adminUsersAction=addNew&username="+email+"&hash="+hash+"&salt="+$("#adminUserSalt").val(),
				  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
						if (msg=="limit") {
							error(LangVars['Staff_Account_Limit']);
						}
						$("#adminList").load("adminUsersActions.php?adminUsersAction=showAdminUsers",function(){
							saved();
							assignStaffKeys();
							assignListPane($("#staffPaneInner"),editStaff);
							$("#staffPaneInner").lovelyScroll();
							$("#staffPaneInner .responsiveListItem:last").addClass("listItemHighlight");
							$("#staffPaneInner").lovelyScrollMove("-"+$("#staffPaneInner").height());
							selectionTools();
						});
					resetAddForms();

				   }
				});
			} else {
				error(LangVars.Error_Passwords_Dont_Match);
			}

		}


	}
	$("#staffPaneInner #addStaff").click(function(){
		return false;
	});
	$("#staffPaneInner #addStaff input").keyup(function(e){
		if (e.keyCode==13) { // enter
			saveOrCancel();
			return false;
		}
	});
	$("#staffPaneInner #addStaff input").keydown(function(e){
		if (e.keyCode==13) { // enter

			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});
	$(document).click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		saveOrCancel();
		return false;
	});
}
function editStaff ($clicked) {
	editMeListItem($clicked);
	return false;
}
function prepDeleteStaff () {
		if ($("#staffPaneInner .listItemHighlight").length) {
	prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Staff_Delete_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteStaff,false,true);
		}
}
function deleteStaff () {
	var Ids="[";
	$("#staffPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("staff-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("staff-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
		type: "POST",
		url: "adminUsersActions.php",
		data: "adminUsersAction=delete&ids="+Ids,
		success: function(msg){
			$("#staffPaneInner .listItemHighlight").each(function(){
				$(this).next().remove();
				$(this).remove();
			});
			if ($("#staffPaneInner .responsiveListItem").length===0) {
				$("#staffPaneInner .noPages").show();
			}
			$("#staffPaneInner").lovelyScroll();
			saved();
			cancelDialogue();
			hide_menus();
		}
	});
}
function changePrivs () {
	var privs = "";
	$("#staffPane .privilegeItem").each(function(){
		if ($(this).hasClass("bpe_current")) {
			if (privs!="") {
				privs = privs+",";
			}
			privs = privs+$(this).attr("data-item-value");
		}
	});
	var Ids="[";
	$("#staffPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("staff-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("staff-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
		type: "POST",
		url: "adminUsersActions.php",
		data: "adminUsersAction=changePrivs&ids="+Ids+"&privs="+privs,
		success: function(msg){
			$("#staffPaneInner .listItemHighlight").each(function(){
				$(this).attr("data-privs",privs);
			});
//			selectionTools();
			saved(true);
		}
	});
}
function restorePage () {

	var toRestore = $("#deletedPages .toRestore").attr("href");
	$.ajax({
	  type: "POST",
	  url: "pageActions.php",
	  data: "pageAction=restore&id="+toRestore,
	  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		if (msg=="cant") {
			error(LangVars.Page_Name_Exists);
		} else if (msg=="limit") {
			error(LangVars.Page_Limit_Reached);
		} else if (msg=="ok") {
			$("#adminPages").load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){
				hide_menus();
				$("#adminPages div[rel="+toRestore+"]").addClass("listItemHighlight");
				saved();
				cancelDialogue();
				$("#loadingMask").hide();
			});
		} else {
			if (msg.split("***")[0]=="parent deleted") {
				error(LangVars.Restore_Parent_First+" \""+msg.split("***")[1]+"\"");
			} else {
				error(LangVars.Misc_Error);
			}

		}

	  }
	});
}
function editRedirecting (val) {
	var Ids="[";
	$("#adminPages .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("rel")+'"';
		} else {
		Ids+=',"'+$(this).attr("rel")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
	  type: "POST",
	  url: "pageActions.php",
	  data: "pageAction=set_redirect&ids="+Ids+"&url="+encodeURIComponent( val ),
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

			if (msg!="ok") {
				error(msg);
			} else {
				$("#adminPages .listItemHighlight").attr("data-redirect-url",val);
				if (val=="") {
					$("#adminPages .listItemHighlight").attr("data-page-redirect-to","");
				} else {
					$("#adminPages .listItemHighlight").attr("data-page-redirect-to","yes");
				}
				selectionTools();
				cancelDialogue();
				saved();
			}
	  }
	});
}
function editEmbedCode ($clicked) {
	editMeListItemMultiple($clicked);
	return false;
}
function deleteEmbedCodes () {
	var Ids="[";
	$("#embedCodesPaneInner .listItemHighlight").each(function(){
		if (Ids=="[") {
		Ids+='"'+$(this).attr("embed-code-id")+'"';
		} else {
		Ids+=',"'+$(this).attr("embed-code-id")+'"';
		}
	});
	Ids+="]";
	working();
	$.ajax({
		type: "POST",
		url: "embedCodesActions.php",
		data: "embedCodesAction=delete&ids="+Ids,
		success: function(msg){
			$("#embedCodesPaneInner .listItemHighlight").each(function(){
				$(this).next().remove();
				$(this).next().remove();
				$(this).remove();
			});
			if ($("#embedCodesPaneInner .embedCodeItem").length===0) {
				$("#embedCodesPaneInner .noPages").show();
			}
			$("#embedCodesPaneInner").lovelyScroll();
			saved();
			cancelDialogue();
			hide_menus();
		}
	});
}
function addEmbedCodes () {
	$(document).unbind("click");
	$(document).unbind("keyup");
	$(document).unbind("keydown");
	$(document).unbind("keypress");
	$("#embedCodesPaneInner .noPages").hide();
	$("#embedCodesPaneInner #addEmbedCode").show();
	$("#embedCodesPaneInner #addEmbedCode .focus").focus();
	prepFancyLabelForms($("#embedCodesPaneInner #addEmbedCode"));
	function saveOrCancel () {
		if ($("#error:visible").length) {
			$("#error").fadeOut();
			return false;
		}


		var name = encodeURIComponent($(".newEmbedCodeName",$("#embedCodesPaneInner #addEmbedCode")).val());
		var code = encodeURIComponent($(".newEmbedCodeCode",$("#embedCodesPaneInner #addEmbedCode")).val());

		if (name=="" || code=="") {
			resetAddForms();
			if ($("#embedCodesPaneInner .embedCodeItem").length===0) {
				$("#embedCodesPaneInner .noPages").show();
			}
			return false;
		} else {
			working();
			$.ajax({
			  type: "POST",
			  url: "embedCodesActions.php",
			  data: "embedCodesAction=addEmbedCode&name="+name+"&code="+code,
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }


					if ($("#embedCodesList .listTipUp").length) {
						$("#embedCodesList .listTipUp").before(msg);
					} else {
						$("#embedCodesList").append(msg)
					}

					saved();
					$("#embedCodesPaneInner #addEmbedCode").hide();
					$(".newEmbedCodeName",$("#embedCodesPaneInner #addEmbedCode")).val("");
					$(".newEmbedCodeCode",$("#embedCodesPaneInner #addEmbedCode")).val("")
					assignEmbedCodesKeys();
					resetAddForms();
					assignDragAssets($("#embedCodesPaneInner .insertTarget"));
					assignListPane($("#embedCodesPaneInner .insertTarget"),editEmbedCode);
					$("#embedCodesPaneInner").lovelyScroll();
					$("#embedCodesPaneInner").lovelyScrollMove("-"+$("#embedCodesPaneInner").height());
					$("#embedCodesPaneInner .insertTarget .responsiveListItem:last").addClass("listItemHighlight");
					selectionTools();

			   }
			});
		}


	}

	$("#embedCodesPaneInner #addEmbedCode").click(function(){
		return false;
	});
	$("#embedCodesPaneInner #addEmbedCode input").keyup(function(e){
		if (e.keyCode==13) { // enter
			if ($(".newEmbedCodeName",$("#embedCodesPaneInner #addEmbedCode")).val()!=""&&$(".newEmbedCodeCode",$("#embedCodesPaneInner #addEmbedCode")).val()!="") {
				saveOrCancel();
			}

			return false;
		}
	});
	$(document).click(function(){
		saveOrCancel();
		return false;
	});
	$("#embedCodesPaneInner #addEmbedCode input").keydown(function(e){
		if (e.keyCode==13) { // enter

			return false;
		}
		if (e.keyCode==27) { // esc
			saveOrCancel();
			return false;
		}
	});
}
function saveMetaTitle (text) {
	if (text!=$("#editMetaTitle").attr("meta-title")) {
		working();
		$.ajax({
		  type: "POST",
		  url: "pageActions.php",
		  data: "pageAction=saveMeta&id="+$("#kbid").val()+"&longtitle="+encodeURIComponent(text),
		  success: function(msg){
			saved("Meta information saved");

			cancelDialogue();
			hide_menus();
		  }
		});
		$("#longTitleValue").val(text);
		$("#editMetaTitle").attr("meta-title",text);
	} else {
		cancelDialogue();
	}
}
function saveMetaDescription (text) {
	if (text!=$("#editMetaDescription").attr("meta-description")) {
		working();
		$.ajax({
		  type: "POST",
		  url: "pageActions.php",
		  data: "pageAction=saveMeta&id="+$("#kbid").val()+"&summary="+encodeURIComponent(text),
		  success: function(msg){
			saved("Meta information saved");
				cancelDialogue();
			hide_menus();
		  }
		});
		$("#metaSummary").val(text);
		$("#editMetaDescription").attr("meta-description",text);
	} else {
		cancelDialogue();
	}
}
function saveMetaKeywords (text) {
	if (text!=$("#editMetaKeywords").attr("meta-keywords")) {
		working();
		$.ajax({
		  type: "POST",
		  url: "pageActions.php",
		  data: "pageAction=saveMeta&id="+$("#kbid").val()+"&keywords="+encodeURIComponent(text),
		  success: function(msg){
			saved("Meta information saved");
				cancelDialogue();
			hide_menus();
		  }
		});
		$("#metaKeywords").val(text);
		$("#editMetaKeywords").attr("meta-keywords",text);
	} else {
		cancelDialogue();
	}
}

function saveMetaTitleBlog (text) {
	if (text!=$("#editMetaTitleBlog").attr("meta-title")) {
		working();
		$.ajax({
		  type: "POST",
		  url: "blogActions.php",
		  data: "blogAction=saveMeta&kbid="+$("#kbid").val()+"&longtitle="+encodeURIComponent(text),
		  success: function(msg){
			saved("Meta information saved");

			cancelDialogue();
			hide_menus();
		  }
		});
		$("#blogMetaLongTitle").val(text);
		$("#editMetaTitleBlog").attr("meta-title",text);
	} else {
		cancelDialogue();
	}
}
function saveMetaDescriptionBlog (text) {
	if (text!=$("#editMetaDescriptionBlog").attr("meta-description")) {
		working();
		$.ajax({
		  type: "POST",
		  url: "blogActions.php",
		  data: "blogAction=saveMeta&kbid="+$("#kbid").val()+"&summary="+encodeURIComponent(text),
		  success: function(msg){
			saved("Meta information saved");
				cancelDialogue();
			hide_menus();
		  }
		});
		$("#blogMetaSummary").val(text);
		$("#editMetaDescriptionBlog").attr("meta-description",text);
	} else {
		cancelDialogue();
	}
}
function saveMetaKeywordsBlog (text) {
	if (text!=$("#editMetaKeywordsBlog").attr("meta-keywords")) {
		working();
		$.ajax({
		  type: "POST",
		  url: "blogActions.php",
		  data: "blogAction=saveMeta&kbid="+$("#kbid").val()+"&keywords="+encodeURIComponent(text),
		  success: function(msg){
			saved("Meta information saved");
				cancelDialogue();
			hide_menus();
		  }
		});
		$("#blogMetaKeywords").val(text);
		$("#editMetaKeywordsBlog").attr("meta-keywords",text);
	} else {
		cancelDialogue();
	}
}
function saveTagsBlog (text) {
	if (text!=$("#editBlogTags").attr("meta-tags")) {
		working();
		$.ajax({
		  type: "POST",
		  url: "blogActions.php",
		  data: "blogAction=saveMeta&kbid="+$("#kbid").val()+"&tags="+encodeURIComponent(text),
		  success: function(msg){
			saved("Meta information saved");
				cancelDialogue();
			hide_menus();
		  }
		});
		$("#blogMetaTags").val(text);
		$("#editBlogTags").attr("meta-tags",text);
	} else {
		cancelDialogue();
	}
}
function saveBlogDate (text) {
	if (text!=$("#editBlogDate").attr("meta-tags")) {
		working();
		$.ajax({
		  type: "POST",
		  url: "blogActions.php",
		  data: "blogAction=saveMeta&kbid="+$("#kbid").val()+"&timestamp="+encodeURIComponent(text),
		  success: function(msg){
			saved("Meta information saved");
			cancelDialogue();
			hide_menus();
		  }
		});
		$("#blogMetaTime").val(text);
		$("#editBlogDate").attr("meta-date",text);
	} else {
		cancelDialogue();
	}
}
function prepDeleteEmbedCodes () {
	if ($("#rightPaneEmbedCodes .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Embed_Codes_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteEmbedCodes,false,true);
	}
}
var LangVars;
var loadingPNG;
var editIconClick = "";
var blogOrganiseClick = "";
var blogOrganiseAuthorsClick = "";
var typeAndSubmitCounter = "";
function changeHomepage ($clicked) {
	var id=$clicked.attr("rel");
	$.ajax({
	  type: "POST",
	  url: "pageActions.php",
	  data: "pageAction=change&action=homepage&id="+id,
	  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		if ($("#lightPagesList").length) {
			$("#lightPagesOuter").animate({opacity:"0"},550,function(){
				$("#lightPagesOuter").remove();
			});
			saved("Homepage changed");
			return false;
		}

	  }
	});
}
function insertLinkToDialogueField (text) {

	if (text.attr("alt")!="") {
		$("#popupDialogueField textarea").val(text.attr("alt"));
	}
	$("#lightPagesOuter").animate({opacity:"0"},550,function(){
		$("#lightPagesOuter").remove();
	});
	hidePopdownOrPassthroughSave(false);

}
function assignFilesMenus ($parent) {

	$(".iconbarSelectAllFiles",$parent).click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$(".responsiveListItem",$parent).addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$(".iconbarDeselectAllFiles",$parent).click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$(".listItemHighlight",$parent).removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
}
function pd () {
	$("#fixedMenusInner").scrollTop(2000);
}
var pushDown;
var loadingAnimator;
var $loadingPNG;

function galImagePaneDZOptions(clickable) {
		var options  = {
			url:"/admin/galleriesActions.php"
			,clickable:clickable
			,paramName: "image"
			,params:{galleriesAction:"addImage"}
			,previewsContainer:"#null"
			,acceptedMimeTypes:"image/*"
			,maxFilesize:m
			,dictInvalidFileType:LangVars.Upload_Error_Bad_Format
			,dictResponseError:LangVars.Misc_Error
			,dictFileTooBig:LangVars.File_Too_Large
			,init: function() {
				this.on("addedfile", function() {
					uploading("1");
				}),
				this.on("uploadprogress", function(file,progress) {
					if (updatedPercent==false) {
						uploading(progress);
						updatedPercent=true;
						setTimeout(function() {
							updatedPercent=false;
						}, 1000);
					}

				}),
				this.on("sending", function(file, xhr, formData) {
				  formData.append("belongs_to_gallery", $("#rightPaneGalleryImages .topBarTitle").attr('gallery-id'));
				});
				this.on("error", function(file,message) {
					$("#galleryImagesPaneInner .insertTarget").removeClass("dz-drag-hover");
					error(message);
				}),
				this.on("success", function(file,serverData,e,t) {
					var galid = $("#rightPaneGalleryImages .topBarTitle").attr('gallery-id');
					if (serverData=="limit") {
						error(LangVars.Storage_Limit_Reached);
					} else {
		    			if (serverData == "fail" || serverData == "notjpg") {
							error(LangVars.Misc_Error);
						} else {
							$("#galleriesAdmin").load("galleriesActions.php?galleriesAction=show&show="+galid+"&to_prevent_cache="+(new Date).getTime(),function(){
								$("#galleriesPaneInner .insertTarget").html($("#galleriesAdmin").html());
								$("#rightPaneGalleryImages .insertTarget").css("height",$("#rightPaneGalleryImages .pagesScroll .insertTarget").height()+"px");
								showGalleryImages($("#rightPaneGalleries #gal"+galid),true);
								$("#rightPaneGalleryImages .pagesScroll .insertTarget").css("height","auto");
								saved();
							});
						}
					}
				});
	  		}
		}
		return options;
	}
function imagePaneDZOptions(clickable) {
	var options  = {
		url:"/admin/pageActions.php"
		,clickable:clickable
		,paramName: "image"
		,params:{pageAction:"addImage"}
		,previewsContainer:"#null"
		,acceptedMimeTypes:"image/*"
		,maxFilesize:m
		,dictInvalidFileType:LangVars.Upload_Error_Bad_Format
		,dictResponseError:LangVars.Misc_Error
		,dictFileTooBig:LangVars.File_Too_Large
		,init: function() {
			this.on("addedfile", function() {
					uploading("1");
			}),
			this.on("uploadprogress", function(file,progress) {
				if (updatedPercent==false) {
					uploading(progress);
					updatedPercent=true;
					setTimeout(function() {
						updatedPercent=false;
					}, 1000);
				}

			}),
			this.on("error", function(file,message) {
				$("#galleryImagesPaneInner .insertTarget").removeClass("dz-drag-hover");
				error(message);
			}),
			this.on("success", function(file,serverData,e,t) {
				if (serverData=="limit") {
					error(LangVars.Storage_Limit_Reached);
				} else {
	    			$(".bpe_images,#bpe_images,#bpe_dropship_images .insertTarget,#imagesPaneInner .insertTarget").html(serverData);

		    		if ($("#rightPaneImages:visible").length) {

						assignListLasso($("#imagesPaneInner"));
						assignListPane($("#imagesPaneInner"),doNothing);
						prepFancyLabelForms($("#rightPaneImages .filterBox"));
						assignPaneSearch($("#rightPaneImages .searchList"),"pageActions.php","pageAction=showFilteredImages&search=","image");
						assignImagesKeys();
						$("#loadingMask").hide();
						assignDragAssets($("#imagesPaneInner .insertTarget"));
						if (!($("body").hasClass("storageDraggable"))) {
							assignSortableListItems($("#imagesPaneInner"),"listItemHighlight","contentImage");		
						}
						setTimeout(function() {
							$("#imagesPaneInner").lovelyScroll(scrollImagesBottom);
						}, 400);
					}
//					$(".imagePalletFilter").val(LangVars.Search);
//					$(".clearImageSearch").remove();
					saved();

				}
			});
  		}
	}
	return options;
}
var selectedVidId;
function videoThumbPaneDZOptions(clickable) {
	var options  = {
		url:"/admin/mediaActions.php"
		,clickable:clickable
		,selectMultiple:false
		,paramName: "image"
		,params:{mediaAction:"addThumb"}
		,previewsContainer:"#null"
		,acceptedMimeTypes:"image/*"
		,maxFilesize:m
		,dictInvalidFileType:LangVars.Upload_Error_Bad_Format
		,dictResponseError:LangVars.Misc_Error
		,dictFileTooBig:LangVars.File_Too_Large
		,init: function() {
			this.on("addedfile", function() {
				uploading("1");
			}),
			this.on("uploadprogress", function(file,progress) {
				if (updatedPercent==false) {
					uploading(progress);
					updatedPercent=true;
					setTimeout(function() {
						updatedPercent=false;
					}, 1000);
				}

			}),
			this.on("sending", function(file, xhr, formData) {
				selectedVidId = $("#rightPaneVideos .addVideoItem.listItemHighlight").attr("media-id");
  				formData.append("mediaId", selectedVidId);
			}),
			this.on("error", function(file,message) {
				error(message);
			}),
			this.on("success", function(file,serverData,e,t) {
				if (serverData=="limit") {
					error(LangVars.Storage_Limit_Reached);
				} else {

					$("#videoList").load("mediaActions.php?mediaAction=show&to_prevent_cache="+(new Date).getTime(),function(){
						$("#videosPaneInner .insertTarget").html($("#videoList").html());

						$("#videosPaneInner").lovelyScroll();
						assignListLasso($("#videosPaneInner"));
						assignListPane($("#videosPaneInner"),doNothing);
						assignVideosKeys();
						assignDragAssets($("#videosPaneInner .insertTarget"));

					});

					saved();

				}
			});
  		}
	}
	return options;
}
var updatedPercent=false;
function videoPaneDZOptions(clickable) {
	var options  = {
		url:"/admin/mediaActions.php"
		,clickable:clickable
		,paramName: "file"
		,selectMultiple:false
		,params:{mediaAction:"addItem"}
		,previewsContainer:"#null"
		,acceptedFiles:"video/mp4,video/x-m4v,video/*"
		,maxFilesize:m
		,dictInvalidFileType:LangVars.Upload_Error_Bad_Format
		,dictResponseError:LangVars.Misc_Error
		,dictFileTooBig:LangVars.File_Too_Large
		,init: function() {
			this.on("addedfile", function() {
				uploading("1");
			}),
			this.on("uploadprogress", function(file,progress) {
				if (updatedPercent==false) {
					uploading(progress);
					updatedPercent=true;
					setTimeout(function() {
						updatedPercent=false;
					}, 1000);
				}

			}),
			this.on("error", function(file,message) {
				$("#videosPaneInner .insertTarget").removeClass("dz-drag-hover");
				error(message);
			}),

			this.on("success", function(file,serverData,e,t) {
				if (serverData=="limit") {
					error(LangVars.Storage_Limit_Reached);
				} else {

					$("#videoList").load("mediaActions.php?mediaAction=show&to_prevent_cache="+(new Date).getTime(),function(){
						$("#videosPaneInner .insertTarget").html($("#videoList").html());

						$("#videosPaneInner").lovelyScroll();
						assignListLasso($("#videosPaneInner"));
						assignListPane($("#videosPaneInner"),doNothing);
						assignVideosKeys();
						assignDragAssets($("#videosPaneInner .insertTarget"));

						$("#videosPaneInner .insertTarget .addVideoItem:last").addClass("listItemHighlight");
						$("#videosPaneInner").lovelyScrollMove("-"+$("#videosPaneInner .insertTarget").height());
						selectionTools();
						if (currentTooltip) {
							interuptedChains.push({currentTooltip:currentTooltip,currentTooltipItem:currentTooltipItem});
							clearTimeout(toolTipTimeout);
						}
						currentTooltipItem=0;
						currentTooltip="newvideo";
						setTimeout(function() {
							tooltip();
						}, 360);

					});

					saved();

				}
			});
  		}
	}
	return options;
}

var m;
var svgDown = "<svg version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" x=\"0px\" y=\"0px\" viewBox=\"0 0 800 600\" enable-background=\"new 0 0 800 600\" xml:space=\"preserve\"><circle cx=\"292.079\" cy=\"201.479\" r=\"36.612\"/><circle cx=\"292.079\" cy=\"287.479\" r=\"36.612\"/><circle cx=\"292.079\" cy=\"373.288\" r=\"36.612\"/><circle cx=\"381.079\" cy=\"373.288\" r=\"36.612\"/><polygon points=\"544.538,373.094 438.229,434.73 438.006,311.845 \"/></svg>";
var svgUp = "<svg version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" x=\"0px\" y=\"0px\" viewBox=\"0 0 800 600\" enable-background=\"new 0 0 800 600\" xml:space=\"preserve\"><circle cx=\"507.926\" cy=\"398.118\" r=\"36.612\"/><circle cx=\"507.926\" cy=\"312.118\" r=\"36.612\"/><circle cx=\"507.926\" cy=\"226.309\" r=\"36.612\"/><circle cx=\"418.926\" cy=\"226.309\" r=\"36.612\"/><polygon points=\"255.467,226.503 361.777,164.866 362,287.752 \"/></svg>";
$(window).load(function(){

	initLP();
	setTimeout(function(){
		window.scrollTo(0, 1);
		window.scrollTo(0, 0);
		$("#splash").addClass("hidden");
	}, 10);
			//Removed 9 Jan
			//$(".textEditingArea").lovelyScroll();
});
var dragInsert;
/*
function touchHandlerLovelyScroll (event,scrollFunction) {
	if (!dragging) {
		var touches = event.changedTouches,
	    first = touches[0],
	    type = "";
	    var $obj = $(event.target).parents(".scrollWrapper");
	    switch(event.type)
		{
		    case "touchstart":
				scrollStart = new Array()
				scrollDirectionTestY=first.screenY;
			break;
		    case "touchmove":
		    	$(".lovelyScrollContents",$obj).stop(false,true);
		    	$(".lovelyScrollBar",$obj).stop(false,true);
				scrollStart[0] = first.screenX;
				scrollStart[1] = first.screenY;

				if (first.screenY>scrollDirectionTestY) {
					var goingDown=true;
				} else {
					var goingUp=true;
				}

				if (goingDown) {
					var dist = first.screenY-scrollDirectionTestY;
					if (!$(".lovelyScrollBar:visible",$obj).length) {
		  				$(".lovelyScrollBar",$obj).fadeIn();
		  			}
		  			clearTimeout(fadeOnStop);

		  			curOffset = parseInt($(".lovelyScrollContents",$obj).css("top"));
		  			var newOffset = curOffset+dist;

		  			if (newOffset<=0) {

						$(".lovelyScrollContents",$obj).css("top","+="+dist+"px");

			  			moveBar($obj);
		  			} else {
		  				$(".lovelyScrollContents",$obj).css("top","+="+dist*0.3+"px");
		  				elasticBar($obj);

		  			}
		  			fadeOnStop = setTimeout(function() {
		  				 $(".lovelyScrollBar",$obj).fadeOut();
		  			}, 2000);
				} else {
					var dist = first.screenY-scrollDirectionTestY;
					if (!$(".lovelyScrollBar:visible",$obj).length) {
		  				$(".lovelyScrollBar",$obj).fadeIn();
		  			}
		  			clearTimeout(fadeOnStop);

		  			curOffset = parseInt($(".lovelyScrollContents",$obj).css("top"));
		  			var newOffset = curOffset+dist;
	  				var posOff = parseInt(newOffset.toString().replace("-",""));

		  			if (posOff<$(".lovelyScrollContents",$obj).outerHeight()-$obj.innerHeight()) {

						$(".lovelyScrollContents",$obj).css("top","+="+dist+"px");
						moveBar($obj);


		  			} else {
		  				$(".lovelyScrollContents",$obj).css("top","+="+dist*0.3+"px");
		  				elasticBar($obj);
		  				if (!scrollWaiting) {
		  					scrollWaiting=true;
		  					if (typeof scrollFunction!=='undefined') {
		  						scrollFunction();
		  					}

		  				}
		  			}
		  			fadeOnStop = setTimeout(function() {
		  				 $(".lovelyScrollBar",$obj).fadeOut();
		  			}, 2000);
				}
				scrollDirectionTestY=first.screenY;

		   	break;
		   	case "touchend":
				var curOffset = parseInt($(".lovelyScrollContents",$obj).css("top"));
				if (curOffset>0) {
					$(".lovelyScrollContents",$obj).stop(false,true).animate({top:0},400,"easeOutCirc");
					//$(".lovelyScrollBar",$obj).stop(false,true).animate({height:$(".lovelyScrollBar",$obj).attr("data-real-height")},400,"easeOutCirc");
				}

				var posOff = parseInt(curOffset.toString().replace("-",""));
				if (posOff>$(".lovelyScrollContents",$obj).outerHeight()-$obj.innerHeight()) {
					var newTop = $(".lovelyScrollContents",$obj).outerHeight()-$obj.innerHeight();
					$(".lovelyScrollContents",$obj).stop(false,true).animate({top:"-"+newTop},400,"easeOutCirc");
					//$(".lovelyScrollBar",$obj).stop(false,true).animate({height:$(".lovelyScrollBar",$obj).attr("data-real-height")},400,"easeOutCirc");
				}
		   	break;
		   	case "touchcancel":

		   	break;
		}

	}
}*/
var scrollStart = new Array();
var scrollDirectionTestY;
function moveBar ($obj) {
		var curOffset = parseInt($(".lovelyScrollContents",$obj).css("top"));
		var track = $(".lovelyScrollContents",$obj).outerHeight() - $obj.innerHeight();
	var pc = curOffset/track*100;
	pc = Math.floor(pc);
	var barTrack = $(".lovelyScrollTrack",$obj).height() - $(".lovelyScrollBar",$obj).outerHeight() - 8;
	var newTop = (pc*barTrack)/100;
	newTop=Math.floor(parseInt(newTop.toString().replace("-","")));

	$(".lovelyScrollBar",$obj).css("top",newTop+"px").attr("data-real-top",newTop);
}
function elasticBar ($obj) {
	var curOffset = parseInt($(".lovelyScrollContents",$obj).css("top"));
	if (curOffset>0) {
		var dist=curOffset;
	} else {
		var shouldBeLimit = $(".lovelyScrollContents",$obj).outerHeight() - $obj.innerHeight();
		var dist = parseInt(curOffset.toString().replace("-",""))-shouldBeLimit;
	}
	var ratio =  $obj.innerHeight()/ ($(".lovelyScrollContents",$obj).outerHeight()+dist);
		var trackH = $(".lovelyScrollTrack",$obj).height();
		var barH = trackH * ratio;
		barH=barH-8;
		var btDist = parseInt($(".lovelyScrollBar",$obj).css("height"));
		var fixTop = btDist-barH;

//	  		$(".lovelyScrollBar",$obj).css("height",barH+"px");

}
function addFormsToSettings () {
	$("#formsListSettings option").remove();
	$("#formsListSettings").append("<option value='0'>"+LangVars.None+"</option>");
	$("#formsWrapper .responsiveListItem.formItem").each(function(){
		$("#formsListSettings").append("<option value='"+$(this).attr("form-id")+"'>"+$(this).attr("name")+"</option>");
	});
	$("#formsListSettings option[value="+$("#formsListSettings").attr("data-current-form-checkout")+"]").attr("selected","selected");
}
var fadeOnStop;
var scrollWaiting=false;
var curOffset;
var lovelyScrollDrag = false;
(function($){
 $.fn.lovelyScrollMove = function (delta,scrollFunction) {
	return this.each(function() {
		var $obj=$(this);
		if (typeof myScroll[$(this).attr("id")] !='undefined') {

			if (delta>0) {
				if (myScroll[$(this).attr("id")].y < 0) {
					myScroll[$(this).attr("id")].scrollBy(0,delta);
				}
			} else {
				var limit = $(".lovelyScrollContents",$obj).outerHeight()-$obj.innerHeight();
				if (myScroll[$(this).attr("id")].y > parseInt('-'+limit)) {
					myScroll[$(this).attr("id")].scrollBy(0,delta);
				}
			}
		}

		/*
		var $obj=$(this);
		if ($obj.hasClass("lovelyScrollLocked")) {
			return false;
		}
		if (!$(".lovelyScrollBar:visible",$obj).length) {
			$(".lovelyScrollBar",$obj).fadeIn();
		}
		clearTimeout(fadeOnStop);
		curOffset = parseInt($(".lovelyScrollContents",$obj).css("top"));

		var newOffset = curOffset+delta;
		var posOff = parseInt(newOffset.toString().replace("-",""));

		if (newOffset<=0 && posOff<$(".lovelyScrollContents",$obj).outerHeight()-$obj.innerHeight()) {

			$(".lovelyScrollContents",$obj).css("top",newOffset);

		} else {

			//make sure it's at the limit

			if (delta>0) {
				$(".lovelyScrollContents",$obj).css("top",0);
			} else {
				if (!scrollWaiting) {
					scrollWaiting=true;
					if (typeof scrollFunction!=='undefined') {
						scrollFunction();
					}
				}
				var newTop = $(".lovelyScrollContents",$obj).outerHeight()-$obj.innerHeight();
				$(".lovelyScrollContents",$obj).css("top","-"+newTop+"px");
			}

		}
		moveBar($obj);
		fadeOnStop = setTimeout(function() {
			 $(".lovelyScrollBar",$obj).fadeOut();
		}, 2000);
		*/
	});
 }
 var draggingScroll=false;
 var scrolls = 1;
 $.fn.lovelyScroll = function(scrollFunction) {
	 return this.each(function() {
//		 if ($(this).hasClass("textEditingArea")) {
//			 return false;
//		 }
	 	var $obj = $(this);
	 	var $oo = $(this);

		function setHeights() {
			if (

				$obj.attr("id")!="settingsFlyinInner"
				&& !$oo.hasClass("paneTools")
				&& !$oo.parents(".paneTools").length
				&& $obj.attr("id")!="settingsTwoPaneLeft"
				&& $obj.attr("id")!="settingsTwoPaneRight"
				&& $obj.attr("id")!="launchPad"
			) {
		 		$obj.css("width","auto");
		 	}
		 	if (
		 		!$oo.hasClass("paneTools")
		 		&& !$oo.parents(".paneTools").length
	 		) {
				$obj.css("height","auto");
			}
    		$(".lovelyScrollContents",$obj).removeClass("lovelyScrollContents").addClass("tempScrollerWrap");
			$obj.css("height",$obj.height()+"px");
			if ($obj.attr("id")=="launchPad") {
				$obj.css("width",$obj.outerWidth()+"px");
			} else {
				$obj.css("width",$obj.width()+"px");
			}

    		$(".tempScrollerWrap",$obj).addClass("lovelyScrollContents").removeClass("tempScrollerWrap");

		}
		if ($obj.hasClass("scrollWrapper")) {

			setHeights();
			setTimeout(function () {
				myScroll[$obj.attr("id")].refresh();
			}, 1005);

			return false;
		} else {
			var pt = $obj.css("padding-top");
			var pl = $obj.css("padding-left");
			var pr = $obj.css("padding-right");
			var pb = $obj.css("padding-bottom");

		 	$obj.addClass("scrollWrapper");

			setHeights();

		 	$obj.wrapInner("<div class='lovelyScrollContents clearfix' style='padding-top:"+pt+";padding-left:"+pl+";padding-right:"+pr+";padding-bottom:"+pb+"'></div>");
			if (typeof $(this).attr("id") == 'undefined') {
				$(this).attr("id","scroll"+scrolls);
			}
	    	var ratio =  $obj.innerHeight()/($("> .lovelyScrollContents",$obj).outerHeight()-5);
	  		if (ratio>1) {
	  			$obj.css("height","auto");
	  			if (

					$obj.attr("id")!="settingsFlyinInner"
					&& !$oo.hasClass("paneTools")
					&& !$oo.parents(".paneTools").length
					&& $obj.attr("id")!="settingsTwoPaneLeft"
					&& $obj.attr("id")!="settingsTwoPaneRight"
					&& $obj.attr("id")!="launchPad"
				) {
	    			$obj.css("width","auto");
	    		}
		    	$("> .lovelyScrollContents > *:first",$obj).unwrap();
				$obj.removeClass("scrollWrapper");
	  			return false;
	  		}

		 	myScroll[$(this).attr("id")] = new IScroll($obj[0], {
		 		scrollbars: true,
		 		mouseWheel: true,
		 		interactiveScrollbars: true,
		 		shrinkScrollbars: 'scale',
				disableMouse:true,
				fadeScrollbars:true,
				probeType:2,
				scrollbars: 'custom'
		 	});
			var $s = $(this)
			myScroll[$(this).attr("id")].on('scroll', function(){
				// fire scrollFunction when near the bottom
				var limit = $(".lovelyScrollContents",$obj).outerHeight()-$obj.innerHeight() - 70;
				var offset = Math.abs(this.y);
				if (offset>limit) {
					if (!scrollWaiting) {
						scrollWaiting=true;
						if (typeof scrollFunction!=='undefined') {
							scrollFunction();
						}
					}
				}
			});
			myScroll[$(this).attr("id")].on('beforeScrollStart', function(){
				if ($s.parents(".paneTools").length) {
					if (typeof myScroll[$s.parents(".paneTools").attr("id")] !="undefined") {
						myScroll[$s.parents(".paneTools").attr("id")].disable();
					}
				}
			});
			myScroll[$(this).attr("id")].on('scrollEnd',function(){
				if ($s.parents(".paneTools").length) {
					if (typeof myScroll[$s.parents(".paneTools").attr("id")] !="undefined") {
						myScroll[$s.parents(".paneTools").attr("id")].enable();
					}
				}
			});
			$(".iScrollVerticalScrollbar",$obj).hover(function(){
				$(this).css("opacity","1");
			});

		}
		scrolls++;
	});
 }

})(jQuery);
var iOS = ( navigator.userAgent.match(/(iPad|iPhone|iPod)/g) ? true : false );

function uploadFilePaneDZOptions(clickable) {
	var options  = {
		url:"/admin/pageActions.php"
		,clickable:clickable
		,paramName: "file"
		,params:{pageAction:"addDownload"}
		,previewsContainer:"#null"
		,maxFilesize:m
		,dictInvalidFileType:LangVars.Upload_Error_Bad_Format
		,dictResponseError:LangVars.Misc_Error
		,dictFileTooBig:LangVars.File_Too_Large
		,init: function() {
			this.on("addedfile", function() {
				uploading("1");
			}),
			this.on("uploadprogress", function(file,progress) {
				if (updatedPercent==false) {
					uploading(progress);
					updatedPercent=true;
					setTimeout(function() {
						updatedPercent=false;
					}, 1000);
				}

			}),
			this.on("error", function(file,message) {
				$("#filesPaneInner").removeClass("dz-drag-hover");
				error(message);
			}),
			this.on("success", function(file,serverData,e,t) {
				$(".bpe_downloads,#downloads,#downloadsPopdownInner").html(serverData);
				if ($("#downloadsPopdown:visible").length) {
					assignHeaderMenus();
					rebindSearchList($("#downloadsPopdownInner"),"pageActions.php","pageAction=showMoreFiles&ajax=true","#downloadsPopdownInner");
					window.dropzoneFilePopdown.disable();
					window.dropzoneFilePopdown = new Dropzone("#downloadsPopdownInner",uploadFilePaneDZOptions($("#downloadsPopdownInner .uploadFile")[0]));
					$("#downloadsPopdownInner .pagesScroll").lovelyScroll(pagesScrollBottomDownloads);
				}

				setTimeout(function() {
				$("#filesPaneInner .insertTarget").html($("#downloads .pagesScroll").html());
				assignDragAssets($("#filesPaneInner .insertTarget"));
				}, 10);
				if ($("#rightPane:visible").length) {
					assign_click();
				}
				saved();
			});
  		}
	}
	return options;
}

$(window).focus(function(){
	modDown=false;
	metaDown=false;
});
function bindToggleLivePreview() {
	$(".toggleLivepreview").unbind().click(function(){
		if ($(this).hasClass("disabled")) {
			$("body").removeClass("livepreviewDisabled");
			$(this).removeClass("disabled");
			eraseCookie("livepreviewdisable");
			$("#livepreview").show();
/*			var cw = $("#livepreviewResize").offset().left;
			var cw2 = cw+16;
			$("#dragBoundry,#launchPad,#popupDialogue,#lightPagesOuter").attr("style","").css("width",cw2+"px");
			$("#contentWrapper,#rightPane .cleverFilterBar,#editPageTop").css("width",cw+"px");
			var di = cw-80;
			var lpw = $("#dragBoundry").width();
			var tw = $(window).width();
			tw = tw-lpw;
			var r = tw+"px";

			$("#dragInsert").css("width",di+"px");
			$("#livepreview,#livepreviewmask").css("left",$("#livepreviewResize").left+"px");
			$("#livepreviewResize").css("left",$("#livepreviewResize").left);*/

		} else {
			$("#livepreview").hide();
			$("#dragBoundry,#launchPad,#popupDialogue,#lightPagesOuter,#contentWrapper").css("width","auto").css("right","0");
			$(this).addClass("disabled");
			$("body").addClass("livepreviewDisabled");
			createCookie("livepreviewdisable","yes",365);
		}
		$(window).trigger("resize");

		refreshScrollHeights();
		$.fn.bpeditor.makeTabsOneLine();

	});
}
function dragInsertButtons() {
	$("#dragInsertIndex .lpBoxSmall").css("height","auto");
	var h = 0;
	var count = 1;
	$("#dragInsertIndex .lpBoxSmall").each(function(){
		if ($(this).height()>h) {
			h=$(this).height();
		}
		if (count%5==1) {
			$(this).addClass("fiveFirst");
		}
		if (count%5==0) {
			$(this).addClass("fiveLast");
		}
		count++;
	});
	$("#dragInsertIndex .lpBoxSmall").css("height",h+"px");
}
function selectAvailabilityDays () {
	// Forward facing collision check
	var end=false;
	var collisionFound=false;

	$("#bookingAvailabilityInner td:not(.greyDay)").each(function(){

		if (end) {
			if ($(this).hasClass("availabilityDragB")&&!$(this).hasClass("availabilityDragASealed")) {
				end=false;
				collisionFound=false;
			}
			if ($(this).hasClass("availabilityDragASealed")) {
				$(this).removeClass("availabilityDragASealed");
				collisionFound=true;
			}

			if ($(this).hasClass("availabilityDragBSealed")) {
				if (collisionFound) {
					$(this).removeClass("availabilityDragBSealed");
				}
				end=false;
			}

		} else {
			if ($(this).hasClass("availabilityDragA")) {
				end = true;
			}
			if ($(this).hasClass("availabilityDragB")) {
				end = false;
			}
		}
	});

	// Backwards facing collisions
	end=false;
	collisionFound=false;
	$("#bookingAvailabilityInner td:not(.greyDay)").each(function(){

		if (end) {
			if ($(this).hasClass("availabilityDragB")) {
				collisionFound=true;
			}
			if ($(this).hasClass("availabilityDragBSealed")) {
				if (collisionFound) {
					$(".leftCollisionStart",$("#bookingAvailabilityInner")).removeClass("availabilityDragASealed");
					$(this).removeClass("availabilityDragBSealed");
					collisionFound=false;
				}
				$(".leftCollisionStart",$("#bookingAvailabilityInner")).removeClass("leftCollisionStart");

				end=false;
			}

		} else {
			if ($(this).hasClass("availabilityDragASealed")) {
				$(this).addClass("leftCollisionStart");
				end = true;
			}
			if ($(this).hasClass("availabilityDragBSealed")) {
				$(this).removeClass("leftCollisionStart");
				end=false;
			}
		}
	});


	var end=false;
	$(".availabilityHighlight").removeClass("availabilityHighlight");

	$("#bookingAvailabilityInner td:not(.greyDay)").each(function(){

		if (end) {
			$(this).addClass("availabilityHighlight");
			if ($(this).hasClass(end)) {
				end = false;
			}
		} else {
			if ($(this).hasClass("availabilityDragASealed")) {
				end = "availabilityDragBSealed";
				$(this).addClass("availabilityHighlight");
			}
			if ($(this).hasClass("availabilityDragBSealed")) {
				end = "availabilityDragASealed";
				$(this).addClass("availabilityHighlight");
			}

			if ($(this).hasClass(end)) {

				end = false;
			}
		}
	});

	$("#bookingAvailabilityInner td:not(.greyDay)").each(function(){

		if (end) {
			$(this).addClass("availabilityHighlight");
			if ($(this).hasClass(end)) {
				end = false;
			}
		} else {
			if ($(this).hasClass("availabilityDragA")) {
				end = "availabilityDragB";
				$(this).addClass("availabilityHighlight");
			}
			if ($(this).hasClass("availabilityDragB")) {
				end = "availabilityDragA";
				$(this).addClass("availabilityHighlight");
			}

			if ($(this).hasClass(end)) {

				end = false;
			}
		}
	});
	var hasA;
	var hasB;
	var hasC;
	var hasD;
	var hasE;
	var hasF;
	var allA;
	var allB;
	var allC;
	var allD;
	var allE;
	var allF;
	var c=0;
	var block_eligible=true;
	var block_selected=false;
	var block_started=false;
	$("#bookingAvailabilityInner td.availabilityHighlight").each(function(){
		if ($(this).hasClass("availabilityDragASealed") && $(this).hasClass("availabilityDragBSealed")) {
			block_eligible=false;
		}
		if ($(this).hasClass("availabilityDragASealed") && ($(this).hasClass("block_middle")||$(this).hasClass("block_end"))) {
			block_eligible=false;
		}
		if ($(this).hasClass("availabilityDragBSealed") && ($(this).hasClass("block_middle")||$(this).hasClass("block_start"))) {
			block_eligible=false;
		}
		if ($(this).hasClass("availabilityDragASealed") && $(this).hasClass("block_start")) {
			block_started=true;
		}
		if ($(this).hasClass("availabilityDragBSealed") && !$(this).hasClass("block_end") && block_started) {
			block_eligible=false;
		}
		if ($(this).hasClass("block_end")&&!$(this).hasClass("availabilityDragBSealed")) {
			block_eligible=false;
		}
		if ($(this).hasClass("block_start")) {
			block_selected=true;
		}

		if (c===0) {
			if ($(this).hasClass("price-a")) {
				allA=true;
			}
			if ($(this).hasClass("price-b")) {
				allB=true;
			}
			if ($(this).hasClass("price-c")) {
				allC=true;
			}
			if ($(this).hasClass("price-d")) {
				allD=true;
			}
			if ($(this).hasClass("price-e")) {
				allE=true;
			}
			if ($(this).hasClass("price-f")) {
				allF=true;
			}

		}
		if (allA&&!$(this).hasClass("price-a")) {
			allA=false;
		}
		if (allB&&!$(this).hasClass("price-b")) {
			allB=false;
		}
		if (allC&&!$(this).hasClass("price-c")) {
			allC=false;
		}
		if (allD&&!$(this).hasClass("price-d")) {
			allD=false;
		}
		if (allE&&!$(this).hasClass("price-e")) {
			allE=false;
		}
		if (allF&&!$(this).hasClass("price-f")) {
			allF=false;
		}


		if ($(this).hasClass("price-a")) {
			hasA=true;
		}
		if ($(this).hasClass("price-b")) {
			hasB=true;
		}
		if ($(this).hasClass("price-c")) {
			hasC=true;
		}
		if ($(this).hasClass("price-d")) {
			hasD=true;
		}
		if ($(this).hasClass("price-e")) {
			hasE=true;
		}
		if ($(this).hasClass("price-f")) {
			hasF=true;
		}

		c++;
	});
	$(".bookingAvailabilityPriceLabel,.bookingAvailabilityTool").removeClass("selected multi");
	$(".bookingAvailabilityPriceLabel.priceCustom input").val("");
	if (allA) {
		$(".bookingAvailabilityPriceLabel.priceA").addClass("selected");
	} else {
		if (hasA) {
			$(".bookingAvailabilityPriceLabel.priceA").addClass("multi");
		}
	}
	if (allB) {
		$(".bookingAvailabilityPriceLabel.priceB").addClass("selected");
	} else {
		if (hasB) {
			$(".bookingAvailabilityPriceLabel.priceB").addClass("multi");
		}
	}
	if (allC) {
		$(".bookingAvailabilityPriceLabel.priceC").addClass("selected");
	} else {
		if (hasC) {
			$(".bookingAvailabilityPriceLabel.priceC").addClass("multi");
		}
	}
	if (allD) {
		$(".bookingAvailabilityPriceLabel.priceD").addClass("selected");
	} else {
		if (hasD) {
			$(".bookingAvailabilityPriceLabel.priceD").addClass("multi");
		}
	}
	if (allE) {
		$(".bookingAvailabilityPriceLabel.priceE").addClass("selected");
	} else {
		if (hasE) {
			$(".bookingAvailabilityPriceLabel.priceE").addClass("multi");
		}
	}
	if (allF) {
		$(".bookingAvailabilityPriceLabel.priceF").addClass("selected");
	} else {
		if (hasF) {
			$(".bookingAvailabilityPriceLabel.priceF").addClass("multi");
		}
	}
	$("#bookAsCompleteBlock").removeClass("selected");
	$("#bookingAvailabilityInner").removeClass("noblockends");
	if (block_eligible) {
		$("#bookAsCompleteBlock").removeClass("unavailable");
		if (block_selected) {
			$("#bookAsCompleteBlock").addClass("selected");
		}
	} else {
		$("#bookingAvailabilityInner").addClass("noblockends");
		$("#bookAsCompleteBlock").addClass("unavailable");
	}
	if ($("td.availabilityHighlight",$("#bookingAvailabilityInner")).length) {
		$("#bookingAvailabilityToolbar").removeClass("greyedOut");
	} else {
		$("#bookingAvailabilityToolbar").addClass("greyedOut");
	}

}
function applyProperties ($scope,itemclass) {
	var $paneTools = $(".paneTools",$scope);
	var ajaxPath = $scope.data("ajax-update-path");
	if ($("body").hasClass("selectingAll")) {
		var Ids="[";
		$("."+itemclass+":not(.responsiveListItem.listItemHighlight)",$scope).each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).data("id")+'"';
			} else {
			Ids+=',"'+$(this).data("id")+'"';
			}
		});
		Ids+="]";
		ajaxPath = ajaxPath+"&selectingAll=true";
	} else {
		var Ids="[";
		$(".listItemHighlight",$scope).each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).data("id")+'"';
			} else {
			Ids+=',"'+$(this).data("id")+'"';
			}
		});
		Ids+="]";
	}
	ajaxPath = ajaxPath+"&ids="+Ids;
	$(".item-tool-properties-menu:visible",$paneTools).each(function(){
		var variable = $(this).data("test-data");
		var value = $("a.bpe_current",$(this)).data("test-data-value")
		$(".listItemHighlight",$scope).data(variable,value);
		ajaxPath = ajaxPath+"&"+variable+"="+encodeURIComponent(value);
	});
	$(".item-tool-properties-checkbox:visible",$paneTools).each(function(){
		var variable = $(this).data("test-data");
		if ($(this).hasClass("bpe_current")) {
			var value=1;
		} else {
			var value=0;
		}
		$(".listItemHighlight",$scope).data(variable,value);
		ajaxPath = ajaxPath+"&"+variable+"="+encodeURIComponent(value);
	});
	$(".item-tool-properties-text:visible",$paneTools).each(function(){
		var variable = $(this).data("test-data");
		var value = $(this).text();
		$(".listItemHighlight",$scope).data(variable,value);
		ajaxPath = ajaxPath+"&"+variable+"="+encodeURIComponent(value);
	});
	var path = ajaxPath.split("?");
	$.ajax({
		type: "POST",
		url: path[0],
		data: path[1],
		success: function(msg){
					livepreview();
			if (msg!="ok") {
				error(LangVars.Error_Will_Reload);
				setTimeout(function () {
					window.location.reload();
				}, 6000);
			}
		}
	});
}
function cmsUpdateBookingPrices() {
	var total = 0;
	var surcharge = 0;

	$("#bookingsInner .cms-booking-product").each(function(){

		var use_min_charge = $(this).data("use-minimum-price");

		var qty_adults = parseInt($("#bookingsInner .cms-booking-product-normal-qty input").val());
		var qty_special = parseInt($("#bookingsInner .cms-booking-product-special-qty input").val());
		var qty_children = parseInt($("#bookingsInner .cms-booking-product-children-qty input").val());

		if (isNaN(qty_adults)) {
			qty_adults = 0;
		}
		if (isNaN(qty_special)) {
			qty_special = 0;
		}
		if (isNaN(qty_children)) {
			qty_children = 0;
		}
		$("#bookingsInner .cms-booking-product-toomany").removeClass("cms-booking-product-toomany");
		$("#bookingsInner td").each(function(){
			var t = qty_adults+qty_special+qty_children;
			if (t > $(this).data("available")) {
				$(this).addClass("cms-booking-product-toomany");

				var addOrRemove = true;
				if ($(this).hasClass("block-start")) {
					$(this).nextUntil($(".block-end")).each(function(){
						$(this).toggleClass("cms-booking-product-toomany",addOrRemove);
					}).next().toggleClass("cms-booking-product-toomany",addOrRemove);
				}
				if ($(this).hasClass("block-middle")) {
					$(this).nextUntil($(".block-end")).each(function(){
						$(this).toggleClass("cms-booking-product-toomany",addOrRemove);
					}).next().toggleClass("cms-booking-product-toomany",addOrRemove);
					if ($(this).next().hasClass("block-end")) {
						$(this).next().toggleClass("cms-booking-product-toomany",addOrRemove);
					}
					$(this).prevUntil($(".block-start")).each(function(){
						$(this).toggleClass("cms-booking-product-toomany",addOrRemove);
					}).prev().toggleClass("cms-booking-product-toomany",addOrRemove);
					if ($(this).prev().hasClass("block-start")) {
						$(this).prev().toggleClass("cms-booking-product-toomany",addOrRemove);
					}
				}
				if ($(this).hasClass("block-end")) {
					$(this).prevUntil($(".block-start")).each(function(){
						$(this).toggleClass("cms-booking-product-toomany",addOrRemove);
					}).prev().toggleClass("cms-booking-product-toomany",addOrRemove);
				}
			}
		});

		var days = "[";
		$("#bookingsInner .current_add:not(.cms-booking-product-toomany)").each(function(){

			var price_normal = parseInt($(this).data("price-normal"));
			var price_special = parseInt($(this).data("price-special"));
			var price_children = parseInt($(this).data("price-children"));
			var min_price = parseInt($(this).data("minimum-price-per-place"));

			var normal = price_normal * qty_adults;
			var special = price_special * qty_special;
			var children = price_children * qty_children;

			var subtotal = normal+special+children;
			var subsurcharge=0;
			if (subtotal < min_price && use_min_charge) {
				var subsurcharge = min_price-subtotal;
				surcharge = surcharge+subsurcharge;
			}
			total = total+subtotal+subsurcharge;
			if (days!="[") {
				days = days+',';
			}
			days = days+'"'+$(this).data("date")+'"';
		});
		days = days+"]";
		$("#bookingsInner .cms-booking-product-days-input").val(days);

	});
	if (surcharge>0) {
		$("#bookingsInner .cms-booking-product-total-surcharge").show();
		$("#bookingsInner .cms-booking-product-total-surcharge span").text(surcharge.toFixed(2));
	} else {
		$("#bookingsInner .cms-booking-product-total-surcharge").hide();
	}
	$("#bookingsInner .cms-booking-product-total-price span").text(total.toFixed(2));

}
function createGalleryFromImages(name) {
	var imagesJson = "[";
	$(".listItemHighlight").each(function(){
		if (imagesJson=="[") {
			imagesJson+='"'+$(this).attr("title")+'"';
		} else {
			imagesJson+=',"'+$(this).attr("title")+'"';
		}		
	});
	imagesJson += "]";

	working();
	$.ajax({
	  type: "POST",
	  url: "galleriesActions.php",
	  data: "galleriesAction=createFromImages&images="+imagesJson+"&title="+encodeURIComponent(name),
	  success: function(msg){

if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		
		$("#galleriesAdmin").load("galleriesActions.php?galleriesAction=show&to_prevent_cache="+(new Date).getTime(),function(){
			if ($("#dragInsert.showing").length) {
				switchToGallery(true);
			} else {
				switchToGallery(false);
			}
			
			$("body").attr("pane","galleries");

			$("#galleriesPaneInner .insertTarget").html($("#galleriesAdmin").html());
			$("#galleriesPaneInner .insertTarget .galleryItem:first").addClass("listItemHighlight");
			assignDragAssets($("#galleriesPaneInner .insertTarget"));
			$("#galleriesPaneInner").lovelyScroll();
			resetAddForms();
			assignGalleryAdd();
			assignGalleriesKeys();
			saved();
			selectionTools();
		});

		cancelDialogue();

		saved("Gallery added");

	  }
	});
}

function getVideoSize() {
	var maxwidth = $("#videoPlayer").width() - 90;
	var maxheight = $("#videoPlayer").height() - 70;
	var ratio = maxwidth/maxheight;
	var targetratio = 1920/1000;
	if (ratio>targetratio) {
		//wider, start with height
		var height = maxheight;
		var width = height*targetratio;
	} else {
		var width = maxwidth;
		var height = width/targetratio;
	}
	var ret = new Array();
	ret.push(width);
	ret.push(height);
	return ret;
}
var ismac=false;
$(document).ready(function(){
	if (navigator.userAgent.indexOf('Mac OS X') != -1) {
		ismac=true;
	}
	
	$(".paneToolsHelp").click(function(){
		$("body").addClass("brand-bg");				
		$("body").addClass("playingHelp");

		var video = $(this).data("play-video");
		var dim = getVideoSize();
		$("#helpVideoPlayer").data("playing",video);
		makeVideo("helpVideoPlayer",dim[0],dim[1],"/admin/graphics/play.png",video,true,false);
		return false;
	});
	$("#videoPlayer").click(function(e){
		if ($(e.target).attr("id")=="videoPlayer") {
			$("body").removeClass("playingHelp");				
			setTimeout(function () {
				$("body").removeClass("brand-bg");				
			}, 1000);
			$("#helpVideoPlayer .jplayer").jPlayer("pause");			
			return false;	
		}
	});
	$("#videoPlayer").click(function(){
		return false;
	});
	
	// Auto update toolbar items

	$(".paneTools,#rightPanePages").on("click",".autoCSVItem ul a",function(){
		var $target=$(this);
		var $data = $(this).parents(".autoCSVItem");
		var clickedIdAttr = $data.data("auto-csv-clicked-id");
		var $scope = $data.data("auto-csv-scope");
		var listItemId = $data.data("auto-csv-list-item-id");
		var ajaxpage = $data.data("auto-csv-ajax-page");
		var querystart  = $data.data("auto-csv-query-start");
		var hiddeninputcsvprefix = $data.data("auto-csv-hidden-input-prefix");
		var itemAttrToUpdate=  $data.data("auto-csv-attr-to-update");
		if (!$target.hasClass("greyedOut")) {
			if ($target.hasClass("bpe_current")) {
				var action = "remove";
			} else {
				var action = "add";
			}
			$clicked = $target;
			var catId = $target.attr(clickedIdAttr);
			var Ids="[";
			$(".listItemHighlight",$scope).each(function(){
				if (Ids=="[") {
				Ids+='"'+$(this).attr(listItemId)+'"';
				} else {
				Ids+=',"'+$(this).attr(listItemId)+'"';
				}
			});
			Ids+="]";
		
			working();
			$.ajax({
			  type: "POST",
			  url: ajaxpage,
			  data: querystart+"&ids="+Ids+"&action="+action+"&csvitemid="+catId,
			  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$(".listItemHighlight",$scope).each(function(){
					if (action=="add") {
						if (!$("#"+hiddeninputcsvprefix+catId,$(this)).length) {
							$(this).append("<input type='hidden' id='"+hiddeninputcsvprefix+catId+"' value='"+catId+"' />")
						}
					} else {
						$("#"+hiddeninputcsvprefix+catId,$(this)).remove();
					}
					var catsCSV = new Array();
					$("input[type=hidden]",$(this)).each(function(){
						catsCSV.push($(this).val());
					});
					catsCSV.sort(function(b,a){return a-b});
					var newCats="";
					for (var i = 0; i < catsCSV.length; i++) {
						if (i==0) {
							newCats=catsCSV[i];
						} else {
							newCats=newCats+","+catsCSV[i];
						}
					};
					$(this).attr(itemAttrToUpdate,newCats);
				});
				selectionTools();
				saved();
			  }
			});

		}
		
		return false;
	});
	$(".paneTools,#adminPages").on("click",".autoUpdateItem",function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		var items = $(this).data("items");
		var title = $(this).data("dialogue-title");
		var info = $(this).data("dialogue-info");
		var url = $(this).data("update-url");
		var updateAttr = $(this).data("test-value");
		if (typeof $(this).data("link-builder") != 'undefined') {
			var linkBuilder = $(this).data("link-builder");	
		} else {
			var linkBuilder = false;		
		}

		
        if ($("body").hasClass("selectingAll")) {
          var Ids="[";
          $(items+":not(.responsiveListItem.listItemHighlight)").each(function(){
            if (Ids=="[") {
            Ids+='"'+$(this).data("id")+'"';
            } else {
            Ids+=',"'+$(this).data("id")+'"';
            }
          });
          Ids+="]";
          var selectingAll = "&selectingAll=true";
        } else {
          var selectingAll = "";
          var Ids="[";
          $(items+".listItemHighlight").each(function(){
            if (Ids=="[") {
            Ids+='"'+$(this).data("id")+'"';
            } else {
            Ids+=',"'+$(this).data("id")+'"';
            }
          });
          Ids+="]";
        }
		if ($(this).text()!=$(this).attr("data-if-empty-val")) {
			var t = $(this).text();
		} else {
			var t = "";
		}
		if ($(items+".listItemHighlight").length) {
prepDialogue("<h2>"+title+"</h2><p>"+info+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Save,false,false,true,true,"auto",linkBuilder,url,Ids,selectingAll,items,updateAttr,t);
		}
		return false;
	});
		
	$(".autoPaneToolToggleItem").click(function(){

		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		var items = $(this).data("items");
		var url = $(this).data("update-url");
		var updateAttr = $(this).data("test-value");
		
        if ($("body").hasClass("selectingAll")) {
          var Ids="[";
          $(items+":not(.responsiveListItem.listItemHighlight)").each(function(){
            if (Ids=="[") {
            Ids+='"'+$(this).data("id")+'"';
            } else {
            Ids+=',"'+$(this).data("id")+'"';
            }
          });
          Ids+="]";
          var selectingAll = "&selectingAll=true";
        } else {
          var selectingAll = "";
          var Ids="[";
          $(items+".listItemHighlight").each(function(){
            if (Ids=="[") {
            Ids+='"'+$(this).data("id")+'"';
            } else {
            Ids+=',"'+$(this).data("id")+'"';
            }
          });
          Ids+="]";
        }
		
		if ($(this).hasClass("bpe_current")) {
			$(this).removeClass("bpe_current");
			var newval = "0";
		} else {
			$(this).addClass("bpe_current");
			var newval = "1";			
		}
		
		if ($(items+".listItemHighlight").length) {
			var page = url.split("?");
			var data = page[1];

			$.ajax({
			  type: "POST",
			  url: page[0],
			  data: data+"&newvalue="+newval+"&ids="+Ids+selectingAll,
			  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$(items+".listItemHighlight").each(function(){
					$(this).attr(updateAttr,newval);
				});
				selectionTools();
				cancelDialogue();
				saved();
				livepreview();
			  }
			});
		}
		return false;
	});
	function autoUpdateImageOptions(url,items) {

		var page = url.split("?");
		var data = page[1];
		
		var pairs = data.split("&");
		var params = {};
		for (var i = 0; i < pairs.length; i++) {
			var keyval = pairs[i].split("=");
			params[keyval[0]] = keyval[1];
		}
	  	var autoUpdateOptions  = {
	  		url:page[0]
	  		,clickable:true
	  		,selectMultiple:false
	  		,paramName: "file"
	  		,params:params
	  		,previewsContainer:"#null"
	  		,maxFilesize:m
			,acceptedMimeTypes:"image/*"
			
	  		,dictInvalidFileType:LangVars.Upload_Error_Bad_Format
	  		,dictResponseError:LangVars.Misc_Error
	  		,dictFileTooBig:LangVars.File_Too_Large
	  		,init: function() {
	  			this.on("addedfile", function() {
	  				uploading("1");
	  			}),
	  			this.on("uploadprogress", function(file,progress) {
	  				if (updatedPercent==false) {
	  					uploading(progress);
	  					updatedPercent=true;
	  					setTimeout(function() {
	  						updatedPercent=false;
	  					}, 1000);
	  				}

	  			}),
	  			this.on("sending", function(file, xhr, formData) {
		          if ($("body").hasClass("selectingAll")) {
		            var Ids="[";
		            $(items+":not(.responsiveListItem.listItemHighlight)").each(function(){
		              if (Ids=="[") {
		              Ids+='"'+$(this).data("id")+'"';
		              } else {
		              Ids+=',"'+$(this).data("id")+'"';
		              }
		            });
		            Ids+="]";
		            var selectingAll = true;
		          } else {
		            var selectingAll = false;
		            var Ids="[";
		            $(items+".listItemHighlight").each(function(){
		              if (Ids=="[") {
		              Ids+='"'+$(this).data("id")+'"';
		              } else {
		              Ids+=',"'+$(this).data("id")+'"';
		              }
		            });
		            Ids+="]";
		          }
	    		  formData.append("ids", Ids);
				  if (selectingAll) {
					  formData.append("selectingAll", "true");				  	
				  }


	  			}),
	  			this.on("error", function(file,message) {
	  				error(message);
	  			}),
	  			this.on("success", function(file,serverData,e,t) {
	  				if (serverData=="limit") {
	  					error(LangVars.Storage_Limit_Reached);
	  				} else {
	  					saved();

	  				}
	  			});
	    		}
	  	}
		return autoUpdateOptions;
	}

	$(".autoUpdateImage").each(function(){
		$(this).dropzone(autoUpdateImageOptions($(this).data("update-url"),$(this).data("items")));
	});
	$(".autoUpdateImage").click(function(){
		return false;
	});
	$(".backToDragInsertIndex").click(function(){
		swapDragTab("dragInsertIndex");
		$("body").removeClass("storageDraggable");
		$("#dragInsertIndex .lpBoxSmall").css("height","auto");
			var h = 0;
			var count = 1;
			$("#dragInsertIndex .lpBoxSmall").each(function(){
				if ($(this).height()>h) {
					h=$(this).height();
				}
				if (count%5==1) {
					$(this).addClass("fiveFirst");
				}
				if (count%5==0) {
					$(this).addClass("fiveLast");
				}
				count++;
			});
			$("#dragInsertIndex .lpBoxSmall").css("height",h+"px");

	});
	
	
	bindToggleLivePreview();
	if (readCookie("livepreviewdisable"))
	{
			$("body").addClass("livepreviewDisabled");
			$(".toggleLivepreview").addClass("disabled");
	}

	var grav = new Image();
	grav.src = $(".userMenu .target img").attr("src");
	grav.onerror = function() {
	   $(".userMenu .target img").attr("src","/admin/graphics/you.jpg")
	};
	var chat = readCookie("chat");
	if (chat) {
		var chatx = readCookie("chatx");
		var chaty = readCookie("chaty");
		if (chatx) {
			if ($(window).width>580 && $(window).height()>580) {

				$("#livechatFloater").css("left",chatx+"px").css("top",chaty+"px");
			}
		}
		$("#livechatiframe").attr("src",chat);
		$("#livechatFloater").show();
	}
	$("#livechatFloater").draggable({
		containment:$("body")
		,handle:$("#livechatFloaterHeader")
		,drag:function(){
			createCookie("chatx",$("#livechatFloater").offset().left,30);
			createCookie("chaty",$("#livechatFloater").offset().top,30);
		}
	});
	$("#closeLivechatFloater").click(function(){
		chatting=false;
		$("#livechatFloater").hide();
		createCookie("chat",false,-1);
		return false;
	});
	function swapDragTab (toShow) {
		hide_header_menus();
		$(".dragInsertTab.current").removeClass("current");
		$("."+toShow).addClass("current");
		$(".dragInsertTabContents").hide();
		$("#"+toShow).show();
		$(".assetPane").hide();
		$("#dragInsert").show();
		$("body").attr("pane","editContent");
		$("body").removeAttr("previous-pane");
		$(".dragInsertTabContentsMain:visible").css("width","auto").lovelyScroll();
		assignHeaderMenus();
		$(document).unbind("click");

		if (currentTooltip) {
			interuptedChains.push({currentTooltip:currentTooltip,currentTooltipItem:currentTooltipItem});
			clearTimeout(toolTipTimeout);
		}
		currentTooltipItem=0;
		currentTooltip="dragItemsToPage";
		tooltip();
	}
	$("#iconbarDeleteFiles").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		if ($("#filesPane .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Files_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteFiles,false,true);
		}
		return false;
	});
	$(".backToDragInsertIndex").click(function(){
		swapDragTab("dragInsertIndex");
		$("body").removeClass("storageDraggable");
		$("#dragInsertIndex .lpBoxSmall").css("height","auto");
			var h = 0;
			var count = 1;
			$("#dragInsertIndex .lpBoxSmall").each(function(){
				if ($(this).height()>h) {
					h=$(this).height();
				}
				if (count%5==1) {
					$(this).addClass("fiveFirst");
				}
				if (count%5==0) {
					$(this).addClass("fiveLast");
				}
				count++;
			});
			$("#dragInsertIndex .lpBoxSmall").css("height",h+"px");

	});
	$(".dragInsertTabText").click(function(){
		swapDragTab("dragInsertTabText");

		return false;
	});
	$(".dragInsertTabStorage").click(function(){
		$(".level2Switcher span span",$(this)).trigger("click");
		$(".target",$(this)).trigger("click");
		return false;
	});

	$(".dragInsertTabWidgets").click(function(){
		swapDragTab("dragInsertTabWidgets");
		return false;
	});
	$(".dragInsertTabLayout").click(function(){
		swapDragTab("dragInsertTabLayout");
		return false;
	});
	$("#sendListPopup").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+$("span:visible",$(this)).text()+"</h2><p>"+LangVars.Send_To_Mailing_List_Info+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Mailing_List_Send,sendToMailingLists,false,true,true,"mailingListSend");

		return false;
	});
	$("#linkOpensInNewWindow").click(function(){
		if ($(this).hasClass("checked")) {
			$(this).removeClass("checked");
		} else {
			$(this).addClass("checked");
		}
	});
	$("#popupInsertLinkToPage").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		showLightPages(insertLinkToDialogueField,"showTop",true,LangVars.Insert_Link_To_Page);
		return false;
	});
	$("#popupInsertLinkToFile").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		showDownloadPopdown(insertLinkToDialogueField,LangVars.Insert_Link_To_File);
		return false;
	});
			//Removed 9 Jan
			//$(".textEditingArea").lovelyScroll();

	$("#dragInsert").click(function(){
		hide_header_menus();
	});
	assignAddForms();
	$("#assetPaneMask").click(function(){
		$(".bpe_highlight,.listItemHighlight,.imageItemHighlight").removeClass("bpe_highlight").removeClass("imageItemHighlight").removeClass("listItemHighlight");
		hideAssetPanes();
		return false;
	});
	$(".closeAssetPane").click(function(){
		$(".bpe_highlight,.listItemHighlight,.imageItemHighlight").removeClass("bpe_highlight").removeClass("imageItemHighlight").removeClass("listItemHighlight");
		hideAssetPanes();
		return false;
	});
	$(".paneTools").click(function(e){
		if ($(e.target).hasClass('iScrollIndicator')) {
			return false;
		}
		hide_header_menus(true);
		//return false;
	});
	$("#pane-tools-booking-products").on("click",".subHeaderLeftMenuItem li a",function(){
		$(".bpe_current",$(this).parents("ul")).removeClass("bpe_current");
		$(this).addClass("bpe_current");
		$(".target",$(this).parents(".subHeaderLeftMenuItem")).text($(this).attr("data-lang"));
		applyProperties($("#bookingProductsPane"),"bookingProductItemMain");
		hide_header_menus(true);
		selectionTools();
		return false;
	});
	$("#pane-tools-booking-products").on("click",".item-tool-properties-checkbox",function(){
		$(this).toggleClass("bpe_current");
		applyProperties($("#bookingProductsPane"),"bookingProductItemMain");
		hide_header_menus(true);
		selectionTools();
		return false;
	});
	$("#pane-tools-booking-products").on("click",".item-tool-properties-text",function(){
		if (typeof $(this).data("text-edit-title") == 'undefined') {
			var title = $("h2",$(this).prev()).text();
		} else {
			var title = $(this).data("text-edit-title");
		}
		if (typeof $(this).data("text-edit-title") == 'undefined') {
			var info = "";
		} else {
			var info = $(this).data("text-edit-info");
		}
		$("#paneToolEditingText").removeAttr("id");
		$(this).attr("id","paneToolEditingText").data("scope","bookingProductsPane").data("itemclass","bookingProductItemMain");
		prepDialogue(
			"<h2>"+title+"</h2><p>"+info+"</p>" // text
			,LangVars.Cancel // primary text
			,cancelDialogue // primary function
			,LangVars.Save // secondary text
			,savePaneToolEditText // secondary function
			,false  // primaryImportant
			,true // secondaryImportant
			,true // textField
			,"panetoolproperty" // editingType
		);

		return false;
	});
	$("#newlivechatplayer").jPlayer({
		ready: function () {
			$(this).jPlayer("setMedia", {
				oga: "/admin/javascripts/new.oga",
				mp3: "/admin/javascripts/new.mp3"
			});
		},
		supplied: "oga, mp3",
		swfPath: "/admin/javascripts",
		solution: "html,flash"
	});
	m = parseFloat($("#maxUploadSize").val())/1024;
	m = m/1024;
	//working();
	$loadingPNG = $("#loadingPNG");
	var flag1=false;

	$("#systemMenu").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}

		if ($("ul:visible",$(this)).length)	 {
			$("ul",$(this)).slideUp();
			$("#systemMenuStatus").addClass("closed").removeClass("open");
			var sm = 1;
		} else {
			$("ul",$(this)).slideDown(300,function(){
				clearTimeout(pushDown);
			});

			pushDown = setInterval(pd,10);
			$("#systemMenuStatus").removeClass("closed").addClass("open");
			var sm = 0;
		}


		$.ajax({
			  type: "POST",
			  url: "adminUsersActions.php",
			  data: "adminUsersAction=systemMenu&systemMenu="+sm,
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			  }
		});

	});

	$(".showLeftPane").click(function(){
		if (!flag1) {
			flag1=true;
			setTimeout(function() {
				flag1=false;
			}, 500);
			$("body").addClass("slideoverLeftPane");
			$("#leftPaneMask").fadeIn(100);
			$("#fixedMenus").animate({left:"0px"},100,function(){


			});
		}

	});

	// Iconbars
	$(".dateFilterButton").click(function(){
		var $el = $(".dateFilterCalendar",$(this).parents(".rightPane"));
		if (!$el.is(":visible")) {
			$el.show();
		} else {
			$el.hide();
		}
		return false;
	});
	$("#popupDialogueMask").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		cancelDialogue();
		return false;
	});

	// Edit page

	$("#iconbarSettings").click(function(){
		if ($("#settingsIconbarMenu:visible").length) {
			$("#settingsIconbarMenu:visible").hide();
		} else {
			hide_iconbar_menus();
			logTrainingClick("clickSettingsEditPage");
			var smLeft = $("#iconbarSettings").offset().left;
			var ibLeft = $("#bottomIconbar").offset().left;
			smLeft = smLeft-ibLeft;
			smLeft=smLeft-7;
			$("#settingsIconbarMenu").css("left",smLeft+"px").show().removeClass("inNarrow");

		}
		return false;
	});
	$("#closeLivePreview").click(function(){
		$("#livepreview").hide();
		return false;
	});

	$("#showDragInsert").click(function(){
		dismissEditors();
		hidePaneTools();
		hideToolTips();
		hide_header_menus();
		$("#header").css("z-index","1");
		$("#dragInsertMask").show();
		$(".returnToLP").fadeOut();
		$(document).unbind("click");
		$("body").unbind("click");
		$("#dragInsertIndex .lpBoxSmall:even").addClass("smallLeft");
		$("#dragInsertIndex .lpBoxSmall:odd").addClass("smallRight");
		$("#dragInsertIndex .lpBoxSmall,#dragInsertIndex .dragInsertTab,#dragInsertIndex h1,#dragInsertIndex h3").css("opacity","0");
		var lpw = $("#contentWrapper").width();

		if ($("#livepreview:visible").length) {
			var tw = $(window).width();
			tw = tw-lpw;
			var r = tw+"px";
		} else {
			var r = "0%";
		}
		if ($(window).width()<480) {
			var di =  lpw-25;
		} else {
			var di =  lpw-80;
		}

		$("#dragInsert").css("width",di+"px");

		$("#dragInsert").stop(false,true).css("right","-90%").show().animate({right:r},300,function(){
			var time = 0;
			$("#dragInsertIndex .lpBoxSmall,#dragInsertIndex .dragInsertTab").each(function(){
				var $el = $(this);
				setTimeout(function() {
					$el.animate({opacity:1},200);
				}, time);
				time=time+50;
			});
			$("#dragInsertIndex h1,#dragInsertIndex h3").animate({opacity:1},200);
			dragInsertButtons();

			$("#dragInsert").addClass("showing");
			$(".dragInsertTabContentsMain").lovelyScroll();
			dragInsert=true;
		});
		if ($("body").attr("drag-pane")=="images") {
			$("#dragInsertIndex #tab2Images").trigger("click");
		}
		if ($("body").attr("drag-pane")=="videos") {
			$("#dragInsertIndex #tab2Videos").trigger("click");
		}
		if ($("body").attr("drag-pane")=="newsletter") {
			$("#dragInsertIndex #tab2Newsletter").trigger("click");
		}
		if ($("body").attr("drag-pane")=="galleries") {
			$("#dragInsertIndex #tab2Galleries").trigger("click");
		}
		if ($("body").attr("drag-pane")=="forms") {
			$("#dragInsertIndex #tab2Forms").trigger("click");
		}
		if ($("body").attr("drag-pane")=="products") {
			$("#dragInsertIndex #tab2Products").trigger("click");
		}
		if ($("body").attr("drag-pane")=="calendars") {
			$("#dragInsertIndex #tab2Calendars").trigger("click");
		}
		if ($("body").attr("drag-pane")=="snippets") {
			$("#dragInsertIndex #tab2Snippets").trigger("click");
		}
		if ($("body").attr("drag-pane")=="embedCodes") {
			$("#dragInsertIndex #tab2EmbedCodes").trigger("click");
		}
		if ($("body").attr("drag-pane")=="files") {
			$("#dragInsertIndex #tab2Files").trigger("click");
		}

		$("body").removeAttr("drag-pane");
		return false;
	});
	$("#dragInsertMask,.closeDragInsert").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		hide_menus();
		hideDragInsert();
		if ($(".assetPane:visible").length) {
			$("body").attr("drag-pane",$("body").attr("pane"));
		}
		setTimeout(function() {
			$("body").removeAttr("previous-pane");
			$("body").attr("pane","editContent");
			$("body").removeClass("storageDraggable");
		}, 300);
		hideAssetPanes();
		$.fn.bpeditor.assign_toggler();
		assignSaveListener();
		$(window).trigger("resize");
	});
	$("#previewPage,#previewPageTiny,#showSitePreview").click(function(){
		$("#livepreview").show();
		livepreview();
		return false;
		//logTrainingClick("clickPreview");
	});
	$("#iconbarVersions").click(function(){
		if ($("#versionsMenu:visible").length) {
			$("#versionsMenu:visible").hide();
		} else {
			hide_iconbar_menus();
			logTrainingClick("clickVersionsToolbarEditPage");
			$("#versionsMenu").show().removeClass("inNarrow");
		}
		return false;
	});
	$("#versionsTiny").html($("#versions").html());
	$("#versions,#versionsTiny").click(function(e){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}

		if ($(e.target)[0].tagName.toLowerCase()=="a") {
			window.location=$(e.target).attr("href");
		}
		if ($(e.target).parent()[0].tagName.toLowerCase()=="a") {
			window.location=$(e.target).parent().attr("href");
		}
		return false;
	});
	$("#iconbarStyles").click(function(){
		if ($("#stylesMenu:visible").length) {
			$("#stylesMenu:visible").hide();
		} else {
			if ($("#bpe_area #bpe_text_dropship").length){
				bpe_save();
			} else if ( $("#bpe_area .editingImage").length) {
				saveImage();
			}
				logTrainingClick("clickStyles");
				hide_iconbar_menus();
				if (!$(this).hasClass("greyedOut")) {
					$("#stylesMenuImage,#stylesMenuText,.stylesHeading").hide();
					$("#stylesMenu").removeClass("multipleGroups");
					if ($(".bpe_highlight.bpe_image").length && $("p.bpe_highlight,h1.bpe_highlight,h2.bpe_highlight,h3.bpe_highlight,h4.bpe_highlight,h5.bpe_highlight,pre.bpe_highlight,li.bpe_highlight,.bpe_table.bpe_highlight").length) {
						$(".stylesHeading").show();
						$("#stylesMenu").addClass("multipleGroups");
					}
					if ($(".bpe_highlight.bpe_image").length) {
						$("#stylesMenuImage").show();
					}
					if ($("p.bpe_highlight,h1.bpe_highlight,h2.bpe_highlight,h3.bpe_highlight,h4.bpe_highlight,h5.bpe_highlight,pre.bpe_highlight,li.bpe_highlight,.bpe_table.bpe_highlight").length) {
						$("#stylesMenuText").show();
					}
					$("#stylesMenu").show();

				}


		}
		return false;
	});
	$(".showPaneTwo").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		if ($(this).hasClass("greyedOut")) {
			return false;
		}
		$("#iconbarBlockClasses,#iconbarImageClasses,#chooseGalleriesList,#chooseFormsList,#blogAuthorsPane2,#blogCategoriesPane2").hide();
		if ($(this).hasClass("showBlockClasses")) {
			$("#iconbarBlockClasses").show();
		}
		if ($(this).hasClass("showImageClasses")) {
			$("#iconbarImageClasses").show();
		}
		if ($(this).hasClass("showChooseFormList")) {
			$("#chooseFormsList").show();
		}
		if ($(this).hasClass("showChooseGalleryList")) {
			$("#chooseGalleriesList").show();
		}
		if ($(this).hasClass("showBlogAuthors")) {
			logTrainingClick("iconbarBlogAuthor"+blogOrganiseAuthorsClick);
			$("#blogAuthorsPane2").show();
		}
		if ($(this).hasClass("showBlogCategories")) {
			$("#blogCategoriesPane2").show();
		}
		if ($(this).hasClass("themeOptionString")) {
			$(".iconbarPane2",$(this).parents(".iconbarMenu")).html($(this).next().html());
		}
		if ($(this).hasClass("changeSitewideContent")) {
			$(".iconbarPane2",$(this).parents(".iconbarMenu")).html($(this).next().html());
		}
		$(".iconbarPaneInner",$(this).parents(".iconbarMenu")).animate({left:"-220px"},200);
		$(".iconbarPaneOuter",$(this).parents(".iconbarMenu")).animate({height:$(".iconbarPane2",$(this).parents(".iconbarMenu")).height()+"px"},200);


		return false;
	});
	$("#changeTextAlign a").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}

		changeTextAlignment($(this).attr("rel"));
		return false;
	});
	$("#iconbarBlockClasses").click(function(e){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$target = $(e.target);
		if ($target[0].tagName.toLowerCase()=="a") {
			changeAdvancedStyle($target.attr("rel"),"block");
		}
		if ($target[0].tagName.toLowerCase()=="span") {
			changeAdvancedStyle($target.parents("a").attr("rel"),"block");
		}
		return false;
	});
	$("#iconbarImageClasses,#iconbarImagePrimary").click(function(e){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$target = $(e.target);

		if ($target[0].tagName.toLowerCase()=="a" ) {
			changeAdvancedStyle($target.attr("rel"),"image");
		}
		if ($target.parent()[0].tagName.toLowerCase()=="a" ) {
			changeAdvancedStyle($target.parent().attr("rel"),"image");
		}

		return false;
	});
	$("#changeImageSize").click(function(e){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$target = $(e.target);
		if ($target[0].tagName.toLowerCase()=="a") {
			$(".bpe_image.bpe_highlight").each(function(){

				var newStr = $target.attr("string");
				var rotate=false;
				var src = $("img",$(this)).attr("src");
				var current = src.split("?");
				var file = current[0];
				var str = false;
				if (current.length>1) {
					str = current[1].split("rotate=");
					if (str.length>1) {
						rotate = str[1].split("&");
					}
				}
				var newSrc = file;

				newSrc += "?"+newStr;
				if (newStr!="") {
					newSrc+="&";
				}
				if (rotate) {
					if (rotate[0]=="r90") {
						newSrc += "rotate=r90";
					}
					if (rotate[0]=="180") {
						newSrc += "rotate=180";
					}
					if (rotate[0]=="l90") {
						newSrc += "rotate=l90";
					}
				}
				$("img",$(this)).attr("src",newSrc);
//				$.fn.bpeditor.clean(true);
				selectionTools();
				autosave(true);

			});
		}
		return false;
	});

	$("#changeStyleP").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		changeStyleP();
		return false;
	});
	$("#changeStyleH1").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		logTrainingClick("clickMainHeadingStyle")
		changeStyleH("h1");
		return false;
	});
	$("#changeStyleH2").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeStyleH("h2");
		return false;
	});
	$("#changeStyleH3").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeStyleH("h3");
		return false;
	});
	$("#changeStyleH4").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeStyleH("h4");
		return false;
	});
	$("#changeStyleUL").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		changeStyleUL();
		return false;
	});
	$("#changeStyleOL").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		changeStyleOL();
		return false;
	});
	$("#indentListItem").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		if ($(this).hasClass("faded")) {
			return false;
		}
		if ($(".bpe_highlight").attr("data-level")=='') {
			var level = 1;
		} else {
			var level = $(".bpe_highlight").attr("data-level");
		}
		level = parseInt(level);
		var newLevel = level+1;
		$(".bpe_highlight").attr("data-level",newLevel).removeClass("level-1 level-2 level-3");
		$(".bpe_highlight").addClass("level-"+newLevel);
		setTimeout(function () {
			$("textarea",$(".bpe_highlight")).trigger('autosize.destroy').autosize();
		}, 200);
		autosave(true);
		selectionTools();

		return false;
	});
	$("#removeIndentListItem").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		if ($(this).hasClass("faded")) {
			return false;
		}
		var $cur = $(".bpe_highlight:first");

		removeIndent($cur);
		setTimeout(function () {
			$("textarea",$cur).trigger('autosize.destroy').autosize();
		}, 200);

		fixTooDeep();
		autosave(true);
		selectionTools();
		return false;
	});
	$("#changeStylePre").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeStylePre();
		return false;
	});
	$("#changeStyleTable").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		changeStyleTable();
		return false;
	});
	$("#changeTemplate,#changeTemplateTiny").click(function(e){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		working();
		if ($(e.target)[0].tagName.toLowerCase()=="a") {
			var id = $("#kbid").val();
			var me = $(e.target);
			$.ajax({
			  type: "POST",
			  url: "pageActions.php",
			  data: "pageAction=change&action=template&template="+$(e.target).attr("href")+"&id="+id,
			  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					$("#changeTemplateTiny a").removeClass("bpe_current");
					me.addClass("bpe_current");
					window.location.reload();
			  }
			});
		}

		return false;
	});
	$("#enablePreviewAsEmail").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($(this).hasClass("bpe_current")) {
			var enable_preview_as_email = 0;
		} else {
			var enable_preview_as_email = 1;
		}
		var id = $("#kbid").val();
		$me = $(this);
		$.ajax({
		  type: "POST",
		  url: "pageActions.php",
		  data: "pageAction=togglePreviewAsEmail&enable_preview_as_email="+enable_preview_as_email+"&id="+id,
		  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if (enable_preview_as_email==0) {
					$me.removeClass("bpe_current");
					$("#iframe1,#iframe2").each(function(){
						$(this).attr("src",$(this).attr("src").replace("&preview_as_email=1",""));
					});
					$("#previewPage").attr("href",$("#previewPage").attr("href").replace("&preview_as_email=1",""));
				} else {
					$me.addClass("bpe_current");
					$("#iframe1,#iframe2").each(function(){
						$(this).attr("src",$(this).attr("src")+"&preview_as_email=1");
					});
					$("#previewPage").attr("href",$("#previewPage").attr("href")+"&preview_as_email=1");
				}
				saved();
		  }
		});
		return false;
	});
	$("#enableCaching,#enableCachingTiny").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($(this).hasClass("bpe_current")) {
			var disable_caching = 1;
		} else {
			var disable_caching = 0;
		}
		var id = $("#kbid").val();
		$me = $(this);
		$.ajax({
		  type: "POST",
		  url: "pageActions.php",
		  data: "pageAction=toggleCaching&disable_caching="+disable_caching+"&id="+id,
		  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if (disable_caching==1) {
					$me.removeClass("bpe_current");
				} else {
					$me.addClass("bpe_current");
				}
				saved();
		  }
		});
		return false;
	});
	$("#editMetaTitle,#editMetaTitleTiny").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.Meta_Title+"</h2><p>"+LangVars.Meta_Title_Info+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Save,saveMetaTitle,false,true,true,"metaTitle");
		return false;
	});
	$("#editMetaDescription,#editMetaDescriptionTiny").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.Meta_Description+"</h2><p>"+LangVars.Meta_Description_Info+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Save,saveMetaDescription,false,true,true,"metaDescription");
		return false;
	});
	$("#editMetaKeywords,#editMetaKeywordsTiny").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.Meta_Keywords+"</h2><p>"+LangVars.Meta_Keywords_Info+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Save,saveMetaKeywords,false,true,true,"metaKeywords");
		return false;
	});
	$("#editMetaTitleBlog,#editMetaTitleBlogTiny").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.Meta_Title+"</h2><p>"+LangVars.Meta_Title_Info+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Save,saveMetaTitleBlog,false,true,true,"metaTitleBlog");
		return false;
	});
	$("#editMetaDescriptionBlog,#editMetaDescriptionBlogTiny").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.Meta_Description+"</h2><p>"+LangVars.Meta_Description_Info+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Save,saveMetaDescriptionBlog,false,true,true,"metaDescriptionBlog");
		return false;
	});
	$("#editMetaKeywordsBlog,#editMetaKeywordsBlogTiny").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.Meta_Keywords+"</h2><p>"+LangVars.Meta_Keywords_Info+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Save,saveMetaKeywordsBlog,false,true,true,"metaKeywordsBlog");
		return false;
	});

	$("#editBlogTags").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.Tags+"</h2><p>"+LangVars.Tags_Info+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Save,saveTagsBlog,false,true,true,"blogTags");
		return false;
	});
	$("#editBlogDate").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.Published_Date+"</h2><p>"+LangVars.Published_Date_Info+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Save,saveBlogDate,false,true,true,"blogDate");
		return false;
	});
	$("#editMoreButton").click(function(){
		if ($("#editMoreMenu:visible").length) {
			$("#editMoreMenu:visible").hide();
		} else {
			hide_iconbar_menus();
			$("#editMoreMenu").show();
		}
		return false;
	});
	$("#narrowVersionsButton").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		hide_iconbar_menus();
		$("#versionsMenu").show().addClass("inNarrow");
		return false;
	});
	$("#narrowSettingsButton").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		hide_iconbar_menus();
		$("#settingsIconbarMenu").show().addClass("inNarrow").css("left","auto");
		return false;
	});
	// Pages iconbar

	$("#iconbarLanguagePages").click(function(){
		if ($(this).hasClass("greyedOut")) {
			return false;
		}
		if ($("#languageMenuPages:visible").length) {
			$("#languageMenuPages:visible").hide();
		} else {
			hide_iconbar_menus();
			$("#languageMenuPages").show();

		}
		return false;
	});
	$("#iconbarStatusPages").click(function(){
		if ($(this).hasClass("greyedOut")) {
			return false;
		}
		if ($("#statusMenuPages:visible").length) {
			$("#statusMenuPages:visible").hide();
		} else {
			logTrainingClick("statusToolbar");
			hide_iconbar_menus();

			var smLeft = $("#iconbarStatusPages").offset().left;
			var ibLeft = $("#bottomIconbarPages").offset().left;
			smLeft = smLeft-ibLeft;
			smLeft=smLeft-7;
			$("#statusMenuPages").css("left",smLeft+"px").show();

		}
		return false;
	});


	$("#iconbarPageTrash").click(function(){
		$("#deletedPagesMenu").html($("#adminPages #deletedPages").html());
		if ($("#trashMenuPages:visible").length) {
			$("#trashMenuPages:visible").hide();
		} else {
			hide_iconbar_menus();

			var smLeft = $("#iconbarPageTrash").offset().left;
			var ibLeft = $("#bottomIconbarPages").offset().left;
			smLeft = smLeft-ibLeft;
			smLeft=smLeft+5;
			$("#trashMenuPages").css("left",smLeft+"px").show().removeClass("inNarrow");

		}
		return false;
	});



	$("#iconbarSecurityPages").click(function(){
		if ($(this).hasClass("greyedOut")) {
			return false;
		}
		if ($("#securityMenuPages:visible").length) {
			$("#securityMenuPages:visible").hide();
		} else {
			hide_iconbar_menus();
			$("#securityMenuPages").show();

		}
		return false;
	});


	$("#pagesMoreButton").click(function(){
		if ($("#pagesMoreMenu:visible").length) {
			$("#pagesMoreMenu:visible").hide();
		} else {
			hide_iconbar_menus();
			$("#pagesMoreMenu").show();
		}
		return false;
	});
	$("#pagesMoreTrash").click(function(){
		$("#deletedPagesMenu").html($("#adminPages #deletedPages").html());
		hide_iconbar_menus();
		$("#trashMenuPages").show().addClass("inNarrow").css("left","auto");


		return false;
	});
	$("#pagesMoreLangs").click(function(){
		if ($(this).hasClass("greyedOut")) {
			return false;
		}
		hide_iconbar_menus();
		$("#languageMenuPages").show().addClass("inNarrow").css("left","auto");


		return false;
	});
	// Images iconbar

	$("#iconbarSelectAllImages").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#rightPaneImages .contentImage").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllImages").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#rightPaneImages .contentImage").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeleteImages").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if (!$(this).hasClass("greyedOut"))	{
			prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Image_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteImages,false,true,false,"");

		}
		return false;
	});

	$("#iconbarAddImage").dropzone(imagePaneDZOptions(true));



	/*if (!window.bpe_upload_imagePaneDone) {

	}
	window.bpe_upload_imagePaneDone=true;*/
	if (!window.bpe_upload_imagePaneInnerDone) {
		$("#imagesPaneInner").dropzone(imagePaneDZOptions(false));
	}
	window.bpe_upload_imagePaneInnerDone=true;

	$("#iconbarRotateImages").click(function(){
		rotateImage();
		return false;
	});
	$("#createGalleryFromSelection").click(function(){

		prepDialogue("<h2>"+LangVars.Enter_Gallery_Name+"</h2><p>"+LangVars.Enter_Gallery_Name_Info+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Create_Gallery,createGalleryFromImages,false,true,true,"");
		return false;
	});
	// videos iconbar
	$("#changeVidThumb").dropzone(videoThumbPaneDZOptions(true));
	$("#changeVidThumb").click(function(){
		return false;
	});
	$("#iconbarAddVideo").dropzone(videoPaneDZOptions(true));
	if (!window.bpe_upload_videoPaneInnerDone) {
		$("#videosPaneInner").dropzone(videoPaneDZOptions(false));
	}
	window.bpe_upload_videoPaneInnerDone=true;

	$("#iconbarSelectAllVideos").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#rightPaneVideos .thumbItem").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllVideos").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#rightPaneVideos .imageItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeleteVideos").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($("#videosPane .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Video_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteVideos,false,true,false,"");
		}
		return false;
	});
	// galleries iconbar

	$("#iconbarDeleteGalleries").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($("#galleriesPaneInner .listItemHighlight").length) {
			var containsCatBased=false;
			var containsUploadBased=false;
			$("#galleriesPaneInner .listItemHighlight").each(function(){
				if ($(this).data("dynamic")==1) {
					containsCatBased=true;
				}
				if ($(this).data("dynamic")==0) {
					containsUploadBased=true;
				}
			});
			if (containsUploadBased) {
				prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Gallery_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteGalleries,false,true,false,"");				
				
			} else {
				prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Gallery_Text_Cats_Based+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteGalleries,false,true,false,"");				
				
			}

		}
		return false;
	});
	$("#iconbarSelectAllGalleries").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#rightPaneGalleries .responsiveListItem").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllGalleries").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#rightPaneGalleries .responsiveListItem").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarAddGallery").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		addGallery();
		return false;
	});
	// gallery image iconbar
	$("#imagesCategoriesListForGals").click(function(e){

		var $target=false;
		if ($(e.target).hasClass("overflowEllipsis")) {
			$target = $(e.target).parent();
		}
		if ($(e.target).hasClass("bpe_selection_tool")) {
			$target = $(e.target);
		}
		if (!$target) {
			return false;
		}

		if (!$target.hasClass("greyedOut")) {
			if ($target.hasClass("bpe_current")) {
				var action = "removeFromCat";
			} else {
				var action = "addToCat";
			}
			$clicked = $target;
			var catId = $target.attr("images-category-id");
			var Ids="[";
			$("#galleriesPaneInner .listItemHighlight").each(function(){
				if (Ids=="[") {
				Ids+='"'+$(this).attr("gallery-id")+'"';
				} else {
				Ids+=',"'+$(this).attr("gallery-id")+'"';
				}
			});
			Ids+="]";
		
			working();
			$.ajax({
			  type: "POST",
			  url: "galleriesActions.php",
			  data: "galleriesAction=changeTagsInGalleries&ids="+Ids+"&action="+action+"&cat="+catId,
			  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#galleriesPaneInner .listItemHighlight").each(function(){
					if (action=="addToCat") {
						if (!$("#tagingal"+catId,$(this)).length) {
							$(this).append("<input type='hidden' id='tagingal"+catId+"' value='"+catId+"' />")
						}
					} else {
						$("#tagingal"+catId,$(this)).remove();
					}
					var catsCSV = new Array();
					$("input[type=hidden]",$(this)).each(function(){
						catsCSV.push($(this).val());
					});
					catsCSV.sort(function(b,a){return a-b});
					var newCats="";
					for (var i = 0; i < catsCSV.length; i++) {
						if (i==0) {
							newCats=catsCSV[i];
						} else {
							newCats=newCats+","+catsCSV[i];
						}
					};
					$(this).attr("data-images-from-categories",newCats);
				});
				selectionTools();
				saved();
			  }
			});

		}
		return false;
	});
	$("#editGalleryImagesButton").click(function(){
		showGalleryImages($("#galleriesPaneInner .listItemHighlight"),false);
		return false;
	});
	$("#editGalleryName").click(function(e){
		if ($(e.target)[0].tagName.toLowerCase()=="span") {
			editMe($(this));
		}
		return false;
	});
	/*
	$("#iconbarAddGalleryImage").click(function(){
		addImagesToGallery();
		return false;
	});*/
	$("#iconbarAddGalleryImage").dropzone(galImagePaneDZOptions(true));



	/*
	if (!window.galImagePaneDone) {
		$("#iconbarAddGalleryImage .buttonLegend,#iconbarAddGalleryImage .toolbarButtonIcon").dropzone(galImagePaneDZOptions(true));
	}*/

	//window.galImagePaneDone=true;
	if (!window.galImagePaneInnerDone) {
		$("#galleryImagesPaneInner").dropzone(galImagePaneDZOptions(false));
	}
	window.galImagePaneInnerDone=true;

	$("#iconbarRotateGalleryImages").click(function(){
		rotateGalleryImage();
		return false;
	});

	$("#iconbarDeleteGalleryImages").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($("#rightPaneGalleryImages .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Image_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteGalleryImages,false,true,false,"");
		}
		hide_iconbar_menus();

		return false;
	});
	$("#iconbarSelectAllGalleryImages").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#galleryImagesPane .thumbItem").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllGalleryImages").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#galleryImagesPane .listItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#galleryStyles").click(function(){
		if ($("#stylesMenuGalleries:visible").length) {
			$("#stylesMenuGalleries:visible").hide();
		} else {
			hide_iconbar_menus();
			galleryStyleTicks();

			$("#stylesMenuGalleries").show();
		}
		return false;
	});
	$("#stylesMenuGalleriesJS").click(function(e){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$clicked = $(e.target);
		if ($clicked[0].tagName.toLowerCase()=="a") {
			changeGalleryStyle($clicked.attr("gal-style"));
		}
		if ($clicked.hasClass("overflowEllipsis")) {
			changeGalleryStyle($clicked.parent().attr("gal-style"));
		}
		return false;
	});
	// Forms iconbar
	$("#changeFormAutoresponderContent").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		logTrainingClick("clickMailingListContent");
		showLightPages(changeFormAutoresponderContent,"showTop",true,LangVars.Choose_page);
		return false;
	});

	$("#iconbarDuplicateForms").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		duplicateForms();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeleteForms").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($("#rightPaneForms .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Forms_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteForms,false,true,false,"");
		}
		hide_iconbar_menus();
		return false;
	});
	$("#exportFormSubmissions").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		exportFormData();
		return false;
	});
	$("#iconbarAddForm").click(function(){
		addForm();
		return false;
	});
	$("#iconbarSelectAllForms").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#formsPane .formItem").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllForms").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#formsPane .listItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});

	// form input iconbar
	$("#editFormName").click(function(e){
		if ($(e.target)[0].tagName.toLowerCase()=="span") {
			editMe($(this));
		}
		return false;
	});
	$("#iconbarAddFormInput").click(function(){
		addInput();
		return false;
	});
	$("#iconbarRequiredFormInputs").click(function(){
		if (!$(this).hasClass("greyedOut")) {
			if ($("#requiredMenuFormInputs:visible").length) {
				$("#requiredMenuFormInputs:visible").hide();
			} else {
				hide_iconbar_menus();
				$("#requiredMenuFormInputs").show();
			}
		}
		return false;
	});
	$("#changeInputRequired").click(function(){
		if ($(this).hasClass("bpe_current")) {
			changeRequired("no");
		} else {
			changeRequired("yes");
		}
		return false;
	});
	$("#inputRequiredYes").click(function(){
		changeRequired("yes");
		hide_iconbar_menus();

		return false;
	});
	$("#inputRequiredNo").click(function(){
		changeRequired("no");
		hide_iconbar_menus();

		return false;
	});
	$("#iconbarKindFormInputs").click(function(){
		if (!$(this).hasClass("greyedOut")) {
			if ($("#kindMenuFormInputs:visible").length) {
				$("#kindMenuFormInputs:visible").hide();
			} else {
				hide_iconbar_menus();
				$("#kindMenuFormInputs").show();
			}
		}
		return false;
	});
	$("#changeFieldTypeNewRow").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeInputType("clear");

		return false;
	});
	$("#changeFieldTypeHR").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeInputType("hr");

		return false;
	});
	$("#changeFieldTypeName").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeInputType("name");

		return false;
	});
	$("#changeFieldTypeEmail").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeInputType("email");

		return false;
	});
	$("#changeFieldTypePhone").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeInputType("phone");

		return false;
	});
	$("#changeFieldTypeShort").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeInputType("short");

		return false;
	});
	$("#changeFieldTypeDate").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeInputType("date");

		return false;
	});
	$("#changeFieldTypeLong").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeInputType("long");

		return false;
	});
	$("#changeFieldTypeCheckbox").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeInputType("checkbox");

		return false;
	});
	$("#changeFieldTypeSelect").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeInputType("select");

		return false;
	});
	$("#changeFieldTypeRadiogroup").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeInputType("radiogroup");

		return false;
	});
	$("#changeFieldTypeFile").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeInputType("file");

		return false;
	});
	$("#changeFieldTypeText").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeInputType("text");

		return false;
	});
	$("#changeFieldTypeHeading").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeInputType("heading");

		return false;
	});
	$("#changeInputWidth a").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		var w = $(this).data('item-value');
		
		changeInputWidth(w);

		return false;
	});
	$("#iconbarSelectAllFormInputs").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#formInputsPane .formInputItem").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllFormInputs").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#formInputsPane .listItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeleteFormInputs").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($("#rightPaneFormInputs .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Inputs_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteInput,false,true,false,"");
		}
		return false;
	});
	$("#iconbarDuplicateFormInputs").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($("#rightPaneFormInputs .listItemHighlight").length) {
			duplicateFormInputs();
			hide_iconbar_menus();
		}
		return false;
	});
	// Input Options
	$("#backToInputs").click(function(){
		var formId = $(this).attr("form-id");
		showFormInputs($("#formsPaneInner #form"+formId),false);
		return false;
	});
	$("#editInputName").click(function(e){
		if ($(e.target)[0].tagName.toLowerCase()=="span") {
			editMe($(this));
		}
		return false;
	});
	$("#iconbarAddFormInputOption").click(function(){
		addInputOption();
		return false;
	});

	$("#iconbarDeleteFormInputOptions").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($("#rightPaneFormInputOptions .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Input_Options_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteInputOption,false,true,false,"");
		}
		return false;
	});
	$("#iconbarSelectAllFormInputOptions").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#rightPaneFormInputOptions .responsiveListItem").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllFormInputOptions").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#rightPaneFormInputOptions .listItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarFormDestination").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($("#rightPaneForms .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Change_Destination_Heading+"</h2><p>"+LangVars.Change_Destination_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Done,changeRecipient,false,true,true,"formDestination");
		}
		return false;
	});
	$("#iconbarFormAutoresponder").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($("#rightPaneForms .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.AutoResponder+"</h2><p>"+LangVars.AutoResponder_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Done,changeAutoresponder,false,true,true,"formAutoresponder");
		}
		return false;
	});
	$("#iconbarFormRedirectOnSend").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($("#rightPaneForms .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Redirect_On_Send+"</h2><p>"+LangVars.Redirect_On_Send_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Done,changeRedirectOnSend,false,true,true,"formRedirectOnSend");
		}
		return false;
	});
	$("#changeFormNewsletterGroup").on('click',"a",function(){
		var value = $(this).data('id');

		var Ids="[";
		$("#rightPaneForms .listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("form-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("form-id")+'"';
			}
		});
		Ids+="]";
		working();
		$.ajax({
		  type: "POST",
		  url: "formsActions.php",
		  data: "formsAction=changeFormAddToNewsletterId&ids="+Ids+"&value="+value,
		  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

			$("#formsWrapper").load("formsActions.php?formsAction=show&to_prevent_cache="+(new Date).getTime(),function(){
				$("#formsPaneInner .insertTarget").html($("#formsWrapper").html());
				var toHighlight = jQuery.parseJSON( Ids );
				for (var i=0; i < toHighlight.length; i++) {
			 		$("#rightPaneForms #form"+toHighlight[i]).addClass("listItemHighlight");
				};
				selectionTools();
				cancelDialogue();
				saved();
			});
		  }
		});
	});
	// products

	$("#iconbarSelectAllProducts").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#rightPaneProducts .productItemMain").addClass("listItemHighlight");
		$("body").addClass("selectingAll");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllProducts").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("body").removeClass("selectingAll");
		$("#rightPaneProducts .listItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeleteProducts").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($("#productsPaneInner .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Product_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteProducts,false,true,"");
		}
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDuplicateProducts").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		duplicateProducts();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarAddProduct").click(function(){
		addProduct();
		return false;
	});
	$("#sortProductsByCreated").click(function(){
		$(".productSortOption").removeClass("bpe_current");
		$(this).addClass("bpe_current");
		productSortBy("productsid");
		return false;
	});
	$("#sortProductsByName").click(function(){
		$(".productSortOption").removeClass("bpe_current");
		$(this).addClass("bpe_current");
		productSortBy("name");
		return false;
	});
	$("#sortProductsByPrice").click(function(){
		$(".productSortOption").removeClass("bpe_current");
		$(this).addClass("bpe_current");
		productSortBy("price");
		return false;
	});
	$("#sortProductsByStock").click(function(){
		$(".productSortOption").removeClass("bpe_current");
		$(this).addClass("bpe_current");
		productSortBy("in_stock");
		return false;
	});
	$("#sortProductsReverse").click(function(){
		if ($(this).hasClass("bpe_current")) {
			$(this).removeClass("bpe_current");
			productSortReverse("0");
		} else {
			$(this).addClass("bpe_current");
			productSortReverse("1");
		}

		return false;
	});

	$("#iconbarDeleteProductCategories").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		if ($("#productCategoriesPaneInner .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Product_Category_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteProductCategories,false,true,"");
		}
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarProductType").click(function(){
		if (!$(this).hasClass("greyedOut")) {
			if ($("#productTypeMenu:visible").length) {
				$("#productTypeMenu:visible").hide();
			} else {
				hide_iconbar_menus();
				setTicksInTypeMenu();
				$("#productTypeMenu").show();

			}
		}
		return false;
	});
	$("#changeProductTypeSimple").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeProductType("simple","");
		return false;
	});
	$("#changeProductTypeDonation").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeProductType("donation","");
		return false;
	});
  $("#changeProductTypeDigital").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		changeProductType("digital","");
		return false;
	});
	$("#chooseGalleriesList").click(function(e){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$clicked = $(e.target);
		if ($clicked[0].tagName.toLowerCase()=="a") {
			changeProductType("gallery",$clicked.attr("gallery-id"));
		}
		if ($clicked.hasClass("overflowEllipsis")) {
			changeProductType("gallery",$clicked.parent().attr("gallery-id"));
		}
		return false;
	});
	$("#chooseFormsList").click(function(e){
		$clicked = $(e.target);
		if ($clicked[0].tagName.toLowerCase()=="a") {
			changeProductType("form",$clicked.attr("form-id"));
		}
		if ($clicked.hasClass("overflowEllipsis")) {
			changeProductType("form",$clicked.parent().attr("form-id"));
		}
		return false;
	});
	$("#changeProductTypeMulti").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($(this).hasClass("bpe_current")) {
			changeProductHasOptions("no");
		} else {
			changeProductHasOptions("yes");
		}
		return false;
	});
	$("#iconbarProductSettings").click(function(){
		if (!$(this).hasClass("greyedOut")) {
			if ($("#productSettingsMenu:visible").length) {
				$("#productSettingsMenu:visible").hide();
			} else {
				hide_iconbar_menus();
				setTicksInTypeMenu();
				$("#productSettingsMenu").show();


			}
		}
		return false;
	});
	$("#iconbarProductPrice").click(function(){
		if (!$(this).hasClass("greyedOut")) {
			prepDialogue("<h2>"+LangVars.Change_Product_Price_Heading+"</h2><p>"+LangVars.Change_Product_Price_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Save,changeProductPrice,false,true,true,"productPrice");

		}
		return false;
	});

  $("#iconbarProductSerialNumbers").click(function(){
		if (!$(this).hasClass("greyedOut")) {
			prepDialogue("<h2>"+LangVars.Serial_Numbers+"</h2><p>"+LangVars.Serial_Numbers_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Save,changeProductSerialNumber,false,true,true,"productSerialNumber");

		}
		return false;
	});
  function uploadDigitalProduct() {
  	var options  = {
  		url:"/admin/shopActions.php"
  		,clickable:true
  		,selectMultiple:false
  		,paramName: "file"
  		,params:{shopAction:"uploadDigitalFile"}
  		,previewsContainer:"#null"
  		,maxFilesize:m
  		,dictInvalidFileType:LangVars.Upload_Error_Bad_Format
  		,dictResponseError:LangVars.Misc_Error
  		,dictFileTooBig:LangVars.File_Too_Large
  		,init: function() {
  			this.on("addedfile", function() {
  				uploading("1");
  			}),
  			this.on("uploadprogress", function(file,progress) {
  				if (updatedPercent==false) {
  					uploading(progress);
  					updatedPercent=true;
  					setTimeout(function() {
  						updatedPercent=false;
  					}, 1000);
  				}

  			}),
  			this.on("sending", function(file, xhr, formData) {
          if ($("body").hasClass("selectingAll")) {
            var Ids="[";
            $("#rightPaneProducts .productItemMain:not(.responsiveListItem.listItemHighlight)").each(function(){
              if (Ids=="[") {
              Ids+='"'+$(this).attr("product-id")+'"';
              } else {
              Ids+=',"'+$(this).attr("product-id")+'"';
              }
            });
            Ids+="]";
            var selectingAll = "&selectingAll=true";
          } else {
            var selectingAll = "";
            var Ids="[";
            $("#rightPaneProducts .listItemHighlight").each(function(){
              if (Ids=="[") {
              Ids+='"'+$(this).attr("product-id")+'"';
              } else {
              Ids+=',"'+$(this).attr("product-id")+'"';
              }
            });
            Ids+="]";
          }
    			formData.append("ids", Ids);
  			}),
  			this.on("error", function(file,message) {
  				error(message);
  			}),
  			this.on("success", function(file,serverData,e,t) {
  				if (serverData=="limit") {
  					error(LangVars.Storage_Limit_Reached);
  				} else {
  					saved();

  				}
  			});
    		}
  	}
  	return options;
  }
  $("#iconbarProductUploadFile").dropzone(uploadDigitalProduct());
  $("#iconbarProductUploadFile").click(function(){
    return false;
  });

	$("#productChangeStock").click(function(){
		if (!$(this).hasClass("greyedOut")) {
prepDialogue("<h2>"+LangVars.Change_Product_Stock_Heading+"</h2><p>"+LangVars.Change_Product_Stock_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Save,changeProductStock,false,true,true,"productStock");
		}
		return false;
	});
	$("#productOptionChangeStock").click(function(){
		if (!$(this).hasClass("greyedOut")) {
			prepDialogue("<h2>"+LangVars.Change_Product_Stock_Heading+"</h2><p>"+LangVars.Change_Product_Stock_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Save,changeProductOptionStock,false,true,true,"productOptionStock");
		}

		return false;
	});
	$("#productChangeSellIfInStock").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		if ($(this).hasClass("bpe_current")) {
			var stock_limits_basket_quantity = "0";
		} else {
			var stock_limits_basket_quantity = "1";
		}
		if ($("body").hasClass("selectingAll")) {
				var Ids="[";
				$("#rightPaneProducts .productItemMain:not(.responsiveListItem.listItemHighlight)").each(function(){
					if (Ids=="[") {
					Ids+='"'+$(this).attr("product-id")+'"';
					} else {
					Ids+=',"'+$(this).attr("product-id")+'"';
					}
				});
				Ids+="]";
				var selectingAll = "&selectingAll=true";
			} else {
				var selectingAll = "";
				var Ids="[";
				$("#rightPaneProducts .listItemHighlight").each(function(){
					if (Ids=="[") {
					Ids+='"'+$(this).attr("product-id")+'"';
					} else {
					Ids+=',"'+$(this).attr("product-id")+'"';
					}
				});
				Ids+="]";
			}
	working();
		$me = $(this);
		working();
		$.ajax({
		  type: "POST",
		  url: "shopActions.php",
		  data: "shopAction=toggleStockLimitsBasketQuantity&ids="+Ids+"&stock_limits_basket_quantity="+stock_limits_basket_quantity+selectingAll+"&filterCat="+filterProductsByCategory,
		  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if (stock_limits_basket_quantity=="1") {
					$me.addClass("bpe_current");
				} else {
					$me.removeClass("bpe_current");
				}
				$("#rightPaneProducts .listItemHighlight").each(function(){
					$(this).attr("product-sell-only-if-stock",stock_limits_basket_quantity);
				});
				selectionTools();
				saved();
		  }
		});

		return false;
	});
	$("#productChangeWeight").click(function(){
prepDialogue("<h2>"+LangVars.Change_Product_Weight_Heading+"</h2><p>"+LangVars.Change_Product_Weight_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Save,changeProductWeight,false,true,true,"productWeight");
		return false;
	});
	$("#addVolumeDiscount,#productVolumeDiscount1").click(function(){
		if (!$(this).hasClass("greyedOut")) {
		prepDialogue("<h2>"+LangVars.Add_Quantity_Discount+"</h2><p>"+LangVars.Add_Quantity_Discount_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Save,addProductVolumeDiscount,false,true,true,"productVolume1Discount");
		}
		return false;
	});
	$("#addVolumeDiscount2,#productVolumeDiscount2").click(function(){
		if (!$(this).hasClass("greyedOut")) {
		prepDialogue("<h2>"+LangVars.Add_Quantity_Discount+"</h2><p>"+LangVars.Add_Quantity_Discount_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Save,addProductVolumeDiscount2,false,true,true,"productVolume2Discount");
		}
		return false;
	});
	$("#productChangeOnlyOne").click(function(){
		changeOnlyOne();
		return false;
	});
	$("#productChangeSeparateOptionsStock").click(function(){
		changeSeparateOptionsStock();
		return false;
	});
	// Bookings


	$("#bookingsInner").on('click','#bookingsRightInner ol li',function(){
		$("#bookingsTabs a").removeClass("currenttab");
		$("#addBooking,#createBooking").hide();
		$("#editBooking").show().addClass("currenttab");
		$("#saveBooking").show();
		$("#bookingsRightInner,#bookingsRightAddBooking").hide();
		$("#bookingsRightAddBooking").show();
		$("#addBookingFirstName").val($(this).data("first-name"));
		$("#addBookingLastName").val($(this).data("last-name"));
		$("#addBookingAddress1").val($(this).data("street"));
		$("#addBookingAddressCity").val($(this).data("city"));
		$("#addBookingAddressState").val($(this).data("state"));
		$("#addBookingAddressCountry").val($(this).data("country"));
		$("#addBookingAddressZip").val($(this).data("zip"));
		$("#addBookingAddressEmail").val($(this).data("email"));
		$("#addBookingAddressPhone").val($(this).data("phone"));
		$("#addBookingAddressPayment").val($(this).data("paid"));
		$("#editBookingID").val($(this).data("buyer-id"));
		$("#editOrderID").val($(this).data("order-id"));
		$("#bookingsInner td.current").removeClass("current");
		var d = $(this).data("days");
		$(".current_add").removeClass("current_add");
		for (var i = 0; i < d.length; i++) {
			$("#bookingsInner td[data-date=\""+d[i]+"\"]").trigger("click");
		}
	}).on("change",".cms-booking-product-qty input",function(){
		cmsUpdateBookingPrices();
	}).on("keyup",".cms-booking-product-qty input",function(){
		cmsUpdateBookingPrices();
	}).on("click",".cms-booking-qty-plus",function(){
		var val = parseInt($("input",$(this).parent()).val());
		val = val+1;
		$("input",$(this).parent()).val(val);
		cmsUpdateBookingPrices();
	}).on("click",".cms-booking-qty-minus",function(){
		var val = parseInt($("input",$(this).parent()).val());
		val = val-1;
		if (val<0) {
			val=0;
		}
		if ($(this).parents(".cms-booking-product").data("adult-required")===1 && $(this).parents(".cms-booking-product").data("product-type")!==0 && $(".cms-booking-product-children-qty",$(this).parents(".cms-booking-product")).length && $(this).parents(".cms-booking-product-qty").hasClass("cms-booking-product-normal-qty")) {
			if (val===0){
				val=1;
			}
		}
		$("input",$(this).parent()).val(val);
		cmsUpdateBookingPrices();
	}).on("click","td",function(){

		$("#bookingsInner .current").removeClass("current");

		if ($("#bookingsRightAddBooking:visible").length) {

			if ($(this).hasClass("cms-booking-product-available") && !$(this).hasClass("cms-booking-product-history")) {
				if ($(this).hasClass("current_add")) {
					var addOrRemove = false;
				}  else {
					var addOrRemove = true;
				}
				if ($(this).hasClass("block_start")) {
					$(this).nextUntil(".block-end").each(function(){
						$(this).toggleClass("current_add",addOrRemove);
					}).next().toggleClass("current_add",addOrRemove);
					if ($(this).next().hasClass("block-end")) {
						$(this).next().toggleClass("current_add",addOrRemove);
					}
				}
				if ($(this).hasClass("block_middle")) {
					$(this).nextUntil(".block_end").each(function(){
						$(this).toggleClass("current_add",addOrRemove);
					}).next().toggleClass("current_add",addOrRemove);
					if ($(this).next().hasClass("block_end")) {
						$(this).next().toggleClass("current_add",addOrRemove);
					}
					$(this).prevUntil(".block_start").each(function(){
						$(this).toggleClass("current_add",addOrRemove);
					}).prev().toggleClass("current_add",addOrRemove);
					if ($(this).prev().hasClass("block_start")) {
						$(this).prev().toggleClass("current_add",addOrRemove);
					}
				}
				if ($(this).hasClass("block_end")) {
					$(this).prevUntil(".block_start").each(function(){
						$(this).toggleClass("current_add",addOrRemove);
					}).prev().toggleClass("current_add",addOrRemove);
					if ($(this).prev().hasClass("block_start")) {
						$(this).prev().toggleClass("current_add",addOrRemove);
					}
				}

				$(this).toggleClass("current_add",addOrRemove);
			}

			cmsUpdateBookingPrices();
		}  else {
			$(this).addClass("current");
		}


		showBookingDay();
		if ($(this).attr("data-bookings")!="[]"&&$(this).attr("data-bookings")!="") {
			$("#bookingsRight").show();
		}

	}).on("click","#closeBookingsRight",function(){
		$("#bookingsRight").hide();
	}).on("click","#bookingsRight li",function(){
		$("#bookingsRight .details").slideUp();
		$(".details",$(this)).slideDown();
	}).on("click","#bookingsTabs a:not(.disabled,#editBooking)",function(){
		$("#addBooking").show();
		$("#editBooking").hide();
		$("#saveBooking").hide();
		$("#createBooking").show();
		
		$("#bookingsTabs a").removeClass("currenttab");
		$(this).addClass("currenttab");
		$("#bookingsRightInner,#bookingsRightAddBooking").hide();
		$($(this).attr("href")).show();
		if ($(this).attr("href")=="#bookingsRightAddBooking") {
			$("#bookingsInner td.current").removeClass("current").trigger("click");
			
			$("#addBookingFirstName").val("");
			$("#addBookingLastName").val("");
			$("#addBookingAddress1").val("");
			$("#addBookingAddressCity").val("");
			$("#addBookingAddressState").val("");
			$("#addBookingAddressCountry").val($(this).data("country"));
			$("#addBookingAddressZip").val("");
			$("#addBookingAddressEmail").val("");
			$("#addBookingAddressPhone").val("");
			$("#addBookingAddressPayment").val("");
			

			cmsUpdateBookingPrices();
		} else {

			
			$("#bookingsInner .cms-booking-product-toomany").removeClass("cms-booking-product-toomany");

			$("#bookingsInner td.current_add:last").addClass("current");
			$("#bookingsInner td.current_add").removeClass("current_add");
			showBookingDay();
		}
		return false;
	}).on("click","#bookingsClose",function(){

		$("#bookingsOuter").hide();
		setTimeout(function () {
			$("#bookings").removeClass("visible");
			returnToLP();
		}, 5);
	}).on("change","#productList select",function(){

		$("#bookingsInner").load("shopActions.php?shopAction=showBookings&productid="+$(this).val(),function(){
			showBookingDay();
		});
	}).on('click', '#bookingAvailabilityNext,#bookingAvailabilityPrev',  function(e){
		$("#bookingsInner").load("shopActions.php?shopAction=showBookings&year="+$(this).text()+"&productid="+$("#productList select").val(),function(){
			showBookingDay();
		});
	}).on('click', '#createBooking,#saveBooking',  function(e){
		if ($("#bookingsInner .cms-booking-product-total-price span").text()=="0.00") {
			alert(LangVars.Insufficient_Availability);
			return false;
		}
		var more = "";
		if ($("#bookingsInner #specialQty").length) {
			more = more+"&special="+$("#bookingsInner #specialQty").val();
		}
		if ($("#bookingsInner #childrenQty").length) {
			more = more+"&children="+$("#bookingsInner #childrenQty").val();
		}
		more = more+"&first_name="+encodeURIComponent($("#bookingsInner #addBookingFirstName").val());
		more = more+"&last_name="+encodeURIComponent($("#bookingsInner #addBookingLastName").val());
		more = more+"&address_street="+encodeURIComponent($("#bookingsInner #addBookingAddress1").val());
		more = more+"&address_city="+encodeURIComponent($("#bookingsInner #addBookingAddressCity").val());
		more = more+"&address_state="+encodeURIComponent($("#bookingsInner #addBookingAddressState").val());
		more = more+"&address_country="+encodeURIComponent($("#bookingsInner #addBookingAddressCountry").val());
		more = more+"&address_zip="+encodeURIComponent($("#bookingsInner #addBookingAddressZip").val());
		more = more+"&payer_email="+encodeURIComponent($("#bookingsInner #addBookingAddressEmail").val());
		more = more+"&phone="+encodeURIComponent($("#bookingsInner #addBookingAddressPhone").val());
		more = more+"&mc_gross="+encodeURIComponent($("#bookingsInner #addBookingAddressPayment").val());
		if ($(this).attr("id")=="saveBooking") {
			more = more+"&edit_booking_id="+encodeURIComponent($("#bookingsInner #editBookingID").val());
			more = more+"&edit_order_id="+encodeURIComponent($("#bookingsInner #editOrderID").val());
		}
		working();
		$.ajax({
		  type: "POST",
		  url: "shopActions.php",
		  data: "shopAction=addBooking&productid="+$("#productList select").val()+"&days="+encodeURIComponent($("#bookingsInner #daysInput").val())+"&number="+$("#bookingsInner #normalQty").val()+more,
		  success: function(msg){
	  		$("#bookingsInner").load("shopActions.php?shopAction=showBookings&year="+$("#bookingsInner #bookingAvailabilityCurrent").text()+"&productid="+$("#productList select").val(),function(){
	  			showBookingDay();
				saved();
	  		});
		  }
		});

		return false;
	});


	// Booking Products
	$("#chooseRates").on("change","select",function(){
		$("#availabilityRateName").val($("#chooseRates option:selected").data("name"));
		$("#availabilityRateNormal").val($("#chooseRates option:selected").data("price-normal"));
		$("#availabilityRateNormalChildren").val($("#chooseRates option:selected").data("price-children"));
		$("#availabilityRateNormalConcessions").val($("#chooseRates option:selected").data("price-special"));
		$("#availabilityRateNormalMinPerSpace").val($("#chooseRates option:selected").data("min-price"));
		if ($("#chooseRates option:selected").val()!=0 && $("#chooseRates option").length>2) {
			$("#deleteRate").show();
		} else {
			$("#deleteRate").hide();
		}
	});
	$("#deleteRate").click(function(){
		var answer = confirm(LangVars.Delete_Rate_Confirm);
		if (answer){
			var id = $("#bookingAvailability").data("editing-product-id");

			var s = "ratesid="+$("#chooseRates select").val()+"&booking_productsid="+id;
			$.ajax({
			  type: "POST",
			  url: "shopActions.php",
				dataType:"json",
			  data: "shopAction=deleteBookingProductRate&"+s,
			  success: function(msg){
				  $("#bookingprod"+id).data("rates",msg);

		  				$("#bookingAvailabilityInner").load("shopActions.php?shopAction=showBookingAvailability&year="+$("#bookingAvailabilityCurrent").text()+"&booking_productsId="+$("#bookingAvailability").data("editing-product-id"),function(){
		  			$("#bookingAvailabilityInner .availabilityMonth td").each(function(){
		  				if ($(this).data("rate")!=0) {
		  					$(this).addClass($("#rate"+$(this).data("rate")).data("value"));
		  				}
		  			});
		  		});


				  showBookingProdRates();
					$("#chooseRates select").trigger("change");
			  }
			});
		}
		return false;
	});
	$("#manageRates").click(function(){

		var id = $("#bookingAvailability").data("editing-product-id");
		var type = $("#bookingAvailability").data("editing-product-type");
		var childrenSeparate = $("#bookingAvailability").data("editing-product-children-separate");
		var specialSeparate = $("#bookingAvailability").data("editing-product-special-separate");
		var minCharge = $("#bookingAvailability").data("editing-product-min-charge-per-space");
		$("#editOnly").hide();
		$("#addOrEdit,#chooseRates").show();
		$("#chooseRates select").trigger("change");
		if ($("#chooseRates select option").length>6) {
			$("#chooseRates select option:first").remove();
			$("#chooseRates select option:first").attr("selected","selected");
			$("#editOnly").show();
			$("#addOrEdit").hide();
			$("#chooseRates select").trigger("change");
		}
		$("#addRate").hide();
		$("#chooseRates").show();
		$("#manageBookingAvailabilityRates,#editRate").show();
		$("#availabilityRateNormalConcessions,#availabilityRateNormalChildren,#availabilityRateNormalMinPerSpace").parent().hide();
		$("#bookingProdTypeSeatOrSpace,#bookingProdTypeObject").hide();
		if (type=="1"||type=="2") {
			$("#bookingProdTypeSeatOrSpace").show();
			if (childrenSeparate=="1") {
				$("#availabilityRateNormalChildren").parent().show();
			}
			if (specialSeparate=="1") {
				$("#availabilityRateNormalConcessions").parent().show();
			}
		} else {
			$("#bookingProdTypeObject").show();
		}
		if (type=="2") {
			if (minCharge=="1") {
				$("#availabilityRateNormalMinPerSpace").parent().show();
			}
		}
		$("#addEditRate .replace-with-space-name").each(function(){
			if (type=="2") {
				$(this).html($(this).data("original-string").replace("{*}",LangVars['Booking_Prod_Name_'+$("#pane-tools-booking-products div[data-test-data=place-name] li a.bpe_current").data("lang")].toLowerCase()));
			}
		});
	});
	$("#saveEditRate").click(function(){
		var title = encodeURIComponent($("#availabilityRateName").val());
		var id = $("#bookingAvailability").data("editing-product-id");
		var normal = encodeURIComponent($("#availabilityRateNormal").val());
		var more = "";
		var empty = false;
		if (title=="") {
			empty=true;
		}
		if ($("#availabilityRateNormalChildren").parent().is(":visible")) {
			var val = encodeURIComponent($("#availabilityRateNormalChildren").val());
			more = more+"&children="+val;
			if (val=="") {
				empty=true;
			}
		}
		if ($("#availabilityRateNormalConcessions").parent().is(":visible")) {
			var val = encodeURIComponent($("#availabilityRateNormalConcessions").val());
			more = more+"&concessions="+val;
			if (val=="") {
				empty=true;
			}
		}
		if ($("#availabilityRateNormalMinPerSpace").parent().is(":visible")) {
			var val = encodeURIComponent($("#availabilityRateNormalMinPerSpace").val());
			more = more+"&min_price="+val;
			if (val=="") {
				empty=true;
			}
		}
		if (empty) {
			error(LangVars.Rate_Cant_Be_Empty);
			return false;
		}
		if ($("#chooseRates:visible").length) {
			more = more+"&ratesid="+$("#chooseRates select").val();
		} else {
			more = more+"&ratesid=0";
		}

		$.ajax({
		  type: "POST",
		  url: "shopActions.php",
			dataType:"json",
		  data: "shopAction=addBookingProductRate&name="+title+"&booking_productsid="+id+"&normal="+normal+more,
		  success: function(msg){
			  $("#bookingprod"+id).data("rates",msg);
			  showBookingProdRates();
			$("#manageBookingAvailabilityRates").fadeOut();
		  }
		});
	});
	$("#cancelEditRate").click(function(){
		if ($("#addRate:visible").length) {
			$("#bookingAvailabilityClose").trigger("click");
		} else {
			$("#manageBookingAvailabilityRates").fadeOut();
		}
	});
	$("#iconbarDeleteBookingProducts").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($("#bookingProductsPaneInner .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Product_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteBookingProducts,false,true,"");
		}
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDuplicateBookingProducts").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		duplicateBookingProducts();
		hide_iconbar_menus();
		return false;
	});
	$("#bookingAvailabilityInner").on('click', '#bookingAvailabilityNext,#bookingAvailabilityPrev',  function(e){
		$("#bookingAvailabilityInner").load("shopActions.php?shopAction=showBookingAvailability&year="+$(this).text()+"&booking_productsId="+$("#bookingAvailability").data("editing-product-id"),function(){
			$("#bookingAvailabilityInner .availabilityMonth td").each(function(){
				if ($(this).data("rate")!=0) {
					$(this).addClass($("#rate"+$(this).data("rate")).data("value"));
				}
			});
		});
	});

	$("#bookingAvailabilityInner").on('click', '#bookingAvailabilityClose',  function(e){
		assignBookingProductsKeys();
		$("#bookingAvailability").removeClass("visible");
		setTimeout(function () {
			$("#bookingAvailabilityOuter").hide();
		}, 1000);
		livepreview();
	});
	var availabilityDragging;

	$(document).on("mouseup",function(){

		availabilityDragging=false;
		$(".dragThis",$("#bookingAvailabilityInner")).removeClass("dragThis");
		$(".availabilityDragA",$("#bookingAvailabilityInner")).addClass("availabilityDragASealed").removeClass("availabilityDragA");
		$(".availabilityDragB",$("#bookingAvailabilityInner")).addClass("availabilityDragBSealed").removeClass("availabilityDragB");
		var flip=false;
		var end=false;

		$("#bookingAvailabilityInner td:not(.greyDay)").each(function(){
			if (end) {
				if ($(this).hasClass(end)) {
					end = false;
					if (flip) {
						$(".availabilityFlip",$("#bookingAvailabilityInner")).removeClass("availabilityDragBSealed").addClass("availabilityDragASealed").removeClass("availabilityFlip");
						$(this).removeClass("availabilityDragASealed").addClass("availabilityDragBSealed");
						flip=false;
					}
				}
			} else {
				if ($(this).hasClass("availabilityDragASealed")) {
					end = "availabilityDragBSealed";
				}
				if ($(this).hasClass("availabilityDragBSealed") && !$(this).hasClass("availabilityDragASealed")) {
					end = "availabilityDragASealed";
					flip=true;
					$(this).addClass("availabilityFlip");
				}
				if ($(this).hasClass(end)) {
					end = false;
				}
			}
		});
		selectAvailabilityDays();

	});
	$("#bookingAvailabilityInner").on('mousedown', 'td:not(.greyDay)',  function(e){
		availabilityDragging=true;
		var toggle=false;
		if (!shiftDown) {
			if ($(this).hasClass("availabilityDragASealed")&&$(this).hasClass("availabilityDragBSealed")) {
				toggle=true;
			}
			$(".availabilityHighlight",$("#bookingAvailabilityInner")).removeClass("availabilityHighlight");
			$(".availabilityDragASealed",$("#bookingAvailabilityInner")).removeClass("availabilityDragASealed");
			$(".availabilityDragBSealed",$("#bookingAvailabilityInner")).removeClass("availabilityDragBSealed");
			if (toggle) {
				return false;
			}
		}

		if ($(this).hasClass("availabilityHighlight")) {
			$(this).addClass("availabilityMiddle");
			var endContender=false;
			var end=false;
			$("#bookingAvailabilityInner td:not(.greyDay)").each(function(){
				if (end) {
					if ($(this).hasClass(end)) {
						$(this).removeClass("sealed");
						return false;
					}
				} else {
					if ($(this).hasClass("availabilityDragA")) {
						$(".availabilityStartContender",$("#bookingAvailabilityInner")).removeClass("availabilityStartContender");
						$(this).addClass("availabilityStartContender");
						endContender = "availabilityDragB";
					}
					if ($(this).hasClass("availabilityDragB")) {
						$(".availabilityStartContender",$("#bookingAvailabilityInner")).removeClass("availabilityStartContender");
						$(this).addClass("availabilityStartContender");
						endContender = "availabilityDragA";
					}
					if ($(this).hasClass("availabilityMiddle")) {
						$(this).removeClass("availabilityMiddle");
						$(".availabilityStartContender",$("#bookingAvailabilityInner")).removeClass("sealed").removeClass("availabilityStartContender");
						end = endContender;
					}
				}

			});

		} else {
			$(this).addClass("availabilityDragA").addClass("availabilityDragB");
		}
		selectAvailabilityDays();

	});
	$("#bookingAvailabilityInner").on('mouseover', 'td:not(.greyDay)',  function(e){
		if (availabilityDragging) {
			var end=false;
			var collision = false;
			var collisionFound=false;

			$(".availabilityDragB:not(.sealed)",$("#bookingAvailabilityInner")).removeClass("availabilityDragB");
			$(this).addClass("availabilityDragB");

			selectAvailabilityDays();
		}
	});
	$("#bookAsCompleteBlock").click(function(e){
		if ($(this).hasClass("unavailable")) {
			return false;
		}
		if (!$(this).hasClass("selected")){
			var adding="true";
			$(this).addClass("selected");
		} else {
			var adding="false";
			$(this).removeClass("selected");
		}

		var days_start_dates = new Array();
		var days_middle_dates = new Array();
		var days_end_dates = new Array();
		$(".availabilityHighlight",$("#bookingAvailabilityInner")).each(function(){
			$(this).removeClass("block_start block_middle block_end");
			if ($(this).hasClass("availabilityDragASealed")&&!$(this).hasClass("availabilityDragBSealed")) {
				days_start_dates.push($(this).data("date"));
				if (adding=="true") {
					$(this).addClass("block_start");
				}

			}
			if (!$(this).hasClass("availabilityDragASealed")&&!$(this).hasClass("availabilityDragBSealed")) {
				days_middle_dates.push($(this).data("date"));
				if (adding=="true") {
					$(this).addClass("block_middle");
				}
			}
			if (!$(this).hasClass("availabilityDragASealed")&&$(this).hasClass("availabilityDragBSealed")) {
				days_end_dates.push($(this).data("date"));
				if (adding=="true") {
					$(this).addClass("block_end");
				}
			}

		});

		$.ajax({
		  type: "POST",
		  url: "shopActions.php",
		  data: "shopAction=toggleBookAsBlock&booking_productsid="+$("#bookingAvailability").data("editing-product-id")+"&block_start_dates="+JSON.stringify(days_start_dates)+"&block_middle_dates="+JSON.stringify(days_middle_dates)+"&block_end_dates="+JSON.stringify(days_end_dates)+"&adding="+adding,
		  success: function(msg){
			if (msg!="ok") {
				error(LangVars.Error_Will_Reload);
				setTimeout(function () {
					window.location.reload();
				}, 6000);
			}
		  }
		});
	});
	$("#bookingAvailabilityToolbar").on("click",".bookingAvailabilityPriceLabel",function(e){
		if ($(this).hasClass("bookingAvailabilityPriceLabel") && e.target.nodeName.toLowerCase()=="input") {
			return false;
		}
		if ($(this).hasClass("bookingAvailabilityPriceLabel")&&$(this).hasClass("priceCustom")&&($("input",$(this)).val()==""||$("input",$(this)).val()=="-")) {
			return false;
		}
		if (!$(this).hasClass("selected")){
			if ($(this).hasClass("bookingAvailabilityPriceLabel")) {
				$(".availabilityHighlight",$("#bookingAvailabilityInner")).removeClass("price-a price-b price-c price-d price-e price-f price-custom").removeAttr("data-custom-price").addClass($(this).attr("data-value"));
			} else {
				$(".availabilityHighlight",$("#bookingAvailabilityInner")).addClass($(this).attr("data-value"));
			}
			var adding="true";
		} else {
			var adding="false";
			if ($(this).hasClass("bookingAvailabilityPriceLabel")) {
				$(".availabilityHighlight",$("#bookingAvailabilityInner")).removeClass("price-a price-b price-c price-d price-e price-f price-custom").removeAttr("data-custom-price");
			} else {
				$(".availabilityHighlight",$("#bookingAvailabilityInner")).removeClass("notfirstday");
			}
		}
		var days = new Array();
		$(".availabilityHighlight",$("#bookingAvailabilityInner")).each(function(){
			days.push($(this).data("date"));
			$(this).data("rate",$(this).data("ratesid"));
		});
		$.ajax({
		  type: "POST",
		  url: "shopActions.php",
		  data: "shopAction=toggleRates&booking_productsid="+$("#bookingAvailability").data("editing-product-id")+"&ratesid="+$(this).data("ratesid")+"&dates="+JSON.stringify(days)+"&adding="+adding,
		  success: function(msg){
			if (msg!="ok") {
				error(LangVars.Error_Will_Reload);
				setTimeout(function () {
					window.location.reload();
				}, 6000);
			}
		  }
		});
		selectAvailabilityDays();
		return false;
	});
	$(".bookingAvailabilityPriceLabel input").keydown(function(e){
		if (e.keyCode=="13") {
			$(this).parent().trigger("click");
		}
	});
	$("#iconbarAddBookingProduct").click(function(){
		addBookingProduct();
		return false;
	});

	// Product categories
	$("#iconbarProductCategories").click(function(){
		if (!$(this).hasClass("greyedOut")) {
			if ($("#productCategoriesMenu:visible").length) {
				$("#productCategoriesMenu:visible").hide();
			} else {
				hide_iconbar_menus();
				setTicksInProdCatsMenu();
				$("#productCategoriesMenu").show();

			}
		}
		return false;
	});
	$("#iconbarSelectAllProductCategories").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#rightPaneProductCategories .responsiveListItem").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllProductCategories").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#rightPaneProductCategories .listItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});

	$("#manageProductCategories").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		//hidePanes();
		$("input").unbind();
		$("#loadingMask").show();
		$(".assetPane").hide();
		hide_iconbar_menus();
		$("#rightPaneProductCategories").attr("showing-parent-id","0");


		displayProdCats("0",true);

		assignListLasso($("#productCategoriesPaneInner"));
		assignListPane($("#productCategoriesPaneInner"),editProductCategory);
		//$("#rightPaneProductCategories").show();
		$("#rightPaneProductCategoriesInner").css("width","auto");
		showPane($("#rightPaneProductCategories"),false,true);
		setTimeout(function() {$("#productCategoriesPaneInner").lovelyScroll();}, 400);

		assignProductCategoriesKeys();
		$("#loadingMask").hide();
		return false;
	});
	$("#productFilterCategories,#showAllProducts").click(function(e){
		var $target=false;
		if ($(e.target).parent().hasClass("filterLink")) {
			$target = $(e.target).parent();
		}
		if ($(e.target).hasClass("filterLink")) {
			$target = $(e.target);
		}
		if (!$target) {
			return false;
		}

		$("#productFilterCategories a,#showAllProducts").removeClass("bpe_current");
		$target.addClass("bpe_current");
		$(".target",$("#productFilterCategories").parents(".subHeaderLeftMenuItem")).text($target.attr("data-lang"));
		filterProductsByCategory=$target.attr("category-id");
		working();
		$("#productsPaneInner .insertTarget").load("shopActions.php?shopAction=showProducts&ajax=yes&initPane=yes&filterCat="+filterProductsByCategory,function(){
			saved();
			//assignRightPanePaginate("shopActions.php","shopAction=showProducts&pagination=true&ajax=true&start=","#productsPaneInner");

			setTimeout(function() {$("#productsPaneInner").lovelyScroll(pagesScrollBottomProducts);}, 400);
			assignDragAssets($("#productsPaneInner .insertTarget"));
		});
		return false;
	});
	$("#productCategoriesList").click(function(e){
		var $target=false;
		if ($(e.target).hasClass("overflowEllipsis")) {
			$target = $(e.target).parent();
		}
		if ($(e.target).hasClass("bpe_selection_tool")) {
			$target = $(e.target);
		}
		if (!$target) {
			return false;
		}

		if (!$target.hasClass("greyedOut")) {
			if ($target.hasClass("bpe_current")) {
				var action = "removeFromCat";
			} else {
				var action = "addToCat";
			}
			$clicked = $target;
			var catId = $target.attr("product-cat-id");
			if ($("body").hasClass("selectingAll")) {
				var Ids="[";
				$("#rightPaneProducts .productItemMain:not(.responsiveListItem.listItemHighlight)").each(function(){
					if (Ids=="[") {
					Ids+='"'+$(this).attr("product-id")+'"';
					} else {
					Ids+=',"'+$(this).attr("product-id")+'"';
					}
				});
				Ids+="]";
				var selectingAll = "&selectingAll=true";
			} else {
				var selectingAll = "";
				var Ids="[";
				$("#rightPaneProducts .listItemHighlight").each(function(){
					if (Ids=="[") {
					Ids+='"'+$(this).attr("product-id")+'"';
					} else {
					Ids+=',"'+$(this).attr("product-id")+'"';
					}
				});
				Ids+="]";
			}
			working();
			$.ajax({
			  type: "POST",
			  url: "shopActions.php",
			  data: "shopAction=changeInCategories&ids="+Ids+"&action="+action+"&cat="+catId+selectingAll+"&filterCat="+filterProductsByCategory,
			  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#rightPaneProducts .listItemHighlight").each(function(){
					if (action=="addToCat") {
						if (!$("#cat"+catId,$(this)).length) {
							$(this).append("<input type='hidden' id='cat"+catId+"' value='"+catId+"' />")
						}
					} else {
						$("#cat"+catId,$(this)).remove();
					}
					var catsCSV = new Array();
					$("input[type=hidden]",$(this)).each(function(){
						catsCSV.push($(this).val());
					});
					catsCSV.sort(function(b,a){return a-b});
					var newCats="";
					for (var i = 0; i < catsCSV.length; i++) {
						if (i==0) {
							newCats=catsCSV[i];
						} else {
							newCats=newCats+","+catsCSV[i];
						}
					};
					$(this).attr("data-product-cats",newCats);
				});
				selectionTools();
				saved();
			  }
			});

		}
		return false;
	});
	$("#bottomIconbarProductCategories").click(function(){
		if ($("#actionMenuProductCategories:visible").length) {
			$("#actionMenuProductCategories:visible").hide();
		} else {
			hide_iconbar_menus();
			$("#actionMenuProductCategories").show();
		}
		return false;
	});
	$("#iconbarAddProductCategory").click(function(){
		addProductCategory();
		return false;
	});
	// Product options
	$("#editProductName").click(function(e){
		if ($(e.target)[0].tagName.toLowerCase()=="span") {
			editMe($(this));
		}
		return false;
	});
	$("#iconbarAddProductOption").click(function(){
		addProductOption();
		return false;
	});
	$("#addVolumeDiscountOptions,#productOptionsVolumeDiscount1").click(function(){
		prepDialogue("<h2>"+LangVars.Add_Quantity_Discount+"</h2><p>"+LangVars.Add_Quantity_Discount_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Save,addProductOptionsVolumeDiscount,false,true,true,"productVolume1Discount");
		return false;
	});
	$("#addVolumeDiscount2Options,#productOptionsVolumeDiscount2").click(function(){
		prepDialogue("<h2>"+LangVars.Add_Quantity_Discount+"</h2><p>"+LangVars.Add_Quantity_Discount_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Save,addProductOptionsVolumeDiscount2,false,true,true,"productVolume2Discount");
		return false;
	});
	$("#iconbarProductOptionPrice").click(function(){
		if (!$(this).hasClass("greyedOut")) {

				prepDialogue("<h2>"+LangVars.Change_Product_Price_Heading+"</h2><p>"+LangVars.Change_Product_Price_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Save,changeProductOptionPrice,false,true,true,"productOptionPrice");


		}
		return false;
	});

	$("#iconbarDeleteProductOptions").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($("#rightPaneProductOptions .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Product_Options_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteProductOption,false,true);
		}
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarSelectAllProductOptions").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#rightPaneProductOptions .productOption").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllProductOptions").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#rightPaneProductOptions .listItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	// Calendars
	$("#iconbarAddCalendar").click(function(){
		addCalendar();
		return false;
	});

	$("#iconbarDeleteCalendars").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($("#calendarsPaneInner .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Calendar_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteCalendars,false,true);
		}
		hide_iconbar_menus();

		return false;
	});
	$("#iconbarSelectAllCalendars").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#calendarsPaneInner .calendarItem").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllCalendars").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#calendarsPaneInner .listItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	// Events Groups
	$("#manageEventsGroups").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		//hidePanes();
		$("input").unbind();
		$("#loadingMask").show();
		$(".assetPane,#rightPaneCalendarEvents").hide();
		hide_iconbar_menus();
		displayEventGroups();
//		assignListLasso($("#eventsGroupsPaneInner"));
		assignListPane($("#eventsGroupsPaneInner"),editEventGroup);
		assignSortableListItems($("#eventsGroupsPaneInner"),"listItemHighlight","responsiveListItem");
		$("#eventsGroupsPaneInner").css("width","auto");
		showPane($("#rightPaneEventsGroups"),false,true);
		setTimeout(function() {$("#eventsGroupsPaneInner").lovelyScroll();}, 400);

		assignEventGroupKeys();
		$("#loadingMask").hide();
		return false
	});
	$("#iconbarDeleteEventsGroups").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		deleteEventGroupPrep();
		return false;
	});
	$("#iconbarAddEventsGroup").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		addEventGroup();
		return false;
	});
	$("#eventsGroupsList").click(function(e){
		var $target=false;
		if ($(e.target).hasClass("overflowEllipsis")) {
			$target = $(e.target).parent();
		}
		if ($(e.target).hasClass("bpe_selection_tool")) {
			$target = $(e.target);
		}
		if (!$target) {
			return false;
		}

		if (!$target.hasClass("greyedOut")) {
			if ($target.hasClass("bpe_current")) {
				var action = "removeFromCat";
			} else {
				var action = "addToCat";
			}
			$clicked = $target;
			var catId = $target.attr("event-group-id");
			if ($("body").hasClass("selectingAll")) {
				var Ids="[";
				$("#calendarEventsPaneInner .responsiveListItem:not(.responsiveListItem.listItemHighlight)").each(function(){
					if (Ids=="[") {
					Ids+='"'+$(this).attr("event-id")+'"';
					} else {
					Ids+=',"'+$(this).attr("event-id")+'"';
					}
				});
				Ids+="]";
				var selectingAll = "&selectingAll=true";
			} else {
				var selectingAll = "";
				var Ids="[";
				$("#calendarEventsPaneInner .listItemHighlight").each(function(){
					if (Ids=="[") {
					Ids+='"'+$(this).attr("event-id")+'"';
					} else {
					Ids+=',"'+$(this).attr("event-id")+'"';
					}
				});
				Ids+="]";
			}
			working();
			$.ajax({
			  type: "POST",
			  url: "calendarActions.php",
			  data: "calendarAction=changeInGroups&ids="+Ids+"&action="+action+"&cat="+catId+selectingAll+"&showingCat="+$("#calendarEventsDateFilter #showing_cat").val(),
			  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#calendarEventsPaneInner .listItemHighlight").each(function(){
					if (action=="addToCat") {
						if (!$("#eventgroup"+catId,$(this)).length) {
							$(this).append("<input type='hidden' id='eventgroup"+catId+"' value='"+catId+"' />")
						}
					} else {
						$("#eventgroup"+catId,$(this)).remove();
					}
					var catsCSV = new Array();
					$("input[type=hidden]",$(this)).each(function(){
						catsCSV.push($(this).val());
					});
					catsCSV.sort(function(b,a){return a-b});
					var newCats="";
					for (var i = 0; i < catsCSV.length; i++) {
						if (i==0) {
							newCats=catsCSV[i];
						} else {
							newCats=newCats+","+catsCSV[i];
						}
					};
					$(this).attr("data-events-groups",newCats);
				});
				selectionTools();
				saved();
			  }
			});

		}
		return false;
	});
	// Events
	$("#iconbarExportEvents").click(function(){
		var showCatId = $("#calendarEventsDateFilter #showing_cat").val();
		window.location.href = "calendarActions.php?calendarAction=exportCSV&categoryid="+showCatId;
		return false;
	});
	$("#iconbarImportEvents").click(function(){
		prepDialogue("<h2>"+LangVars.Import_Events+"</h2><p>"+LangVars.Import_Events_Text+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Import,importEventsCSV,false,true,true,"eventsImport");

		return false;
	});
	$("#addEventCustomField").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.Add_Custom_Field+"</h2><p>"+LangVars.Add_Custom_Field_Text+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Add,addEventCustomField,false,true,true,"addNewsletterCustomField");
		return false;
	});
	$("#eventsCopy").click(function () {
		var Ids="[";
		$("#calendarEventsPaneInner .eventItem.listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("event-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("event-id")+'"';
			}
		});
		Ids+="]";
		$("#eventsPaste").removeClass("greyedOut");
		eraseCookie("eventsCut");
		eraseCookie("eventsCopy");
		createCookie("eventsCopy",Ids,0);
		hide_menus();
		
		return false;
	});
	$("#eventsCut").click(function () {
		var Ids="[";
		$("#calendarEventsPaneInner .eventItem.listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("event-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("event-id")+'"';
			}
		});
		Ids+="]";
		$("#eventsPaste").removeClass("greyedOut");
		eraseCookie("eventsCut");
		eraseCookie("eventsCopy");
		createCookie("eventsCut",Ids,0);
		hideCutEvents();
		hide_menus();
		
		return false;
	});
	$("#eventsPaste").click(function () {
    	if (readCookie("eventsCut")) {
			var Ids = readCookie("eventsCut");
			var action= "pasteFromCutEvent";
			eraseCookie("eventsCut");
			$("#eventsPaste").addClass("greyedOut");
    	}
    	if (readCookie("eventsCopy")) {
			var action= "pasteFromCopyEvent";			
			var Ids = readCookie("eventsCopy");
    	}

		var date = $(".dateInput",$("#calendarEventsPaneInner .eventForm")).val();
		var splitd = date.split("/");
		
		var showCatId = $("#calendarEventsDateFilter #showing_cat").val();

		var showCatString = "&showCat="+showCatId;
		var addToCatString = "&addToCat="+showCatId;
		
		
		working();
		$.ajax({
		  type: "POST",
		  url: "calendarActions.php",
		  data: "calendarAction="+action+"&ids="+Ids+"&date="+date+addToCatString,
		  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

				month = splitd[1];
				year = splitd[2];
				day = splitd[0];
				$("#calendarEventsDateFilter").load("/actions/ShowCal/?month="+month+"&year="+year+"&day="+day+showCatString,function(){
	
					$("#calendarEventsPaneInner .eventForm .focus").val("");
					$("#calendarEventsPaneInner .eventForm .focus").unbind();
					$("#calendarEventsPaneInner .eventForm").hide();

					$target = $("#rightPaneCalendarEvents .selectedDay");
					$("#calendarEventsPaneInner .insertTarget").html($(".eventList",$target).html());
					setTimeout(function() {$("#calendarEventsPaneInner").lovelyScroll();}, 400);
	
					setTimeout(function() {
						$("#calendarEventsPaneInner .insertTarget .eventItem:first").addClass("listItemHighlight");
						$(".addEventFake").unbind().click(function(){
							addEvent();
							return false;
						});
						assignListLasso($("#rightPaneCalendarEvents"));
						assignListPane($("#rightPaneCalendarEvents .insertTarget"),editCalendarEvents);
						assignCalendarEventsKeys();
						hideCutEvents();
						hide_menus();
						
						selectionTools();
		
					}, 10);

					saved();
				});
		  }
		});
		
		return false;
	});
	$("#iconbarAddCalendarEvent").click(function(){
		addEvent();
		return false;
	});
	$("#editCalendarName").click(function(e){
		if ($(e.target)[0].tagName.toLowerCase()=="span") {
			editMe($(this));
		}
		return false;
	});
	$("#calendarEventsDateFilter").click(function(e){
		$target = $(e.target);
		if ($target.attr("id")=="prev_month") {
			month = $("#calendarEventsDateFilter #prev_month_val").val();
			year = $("#calendarEventsDateFilter #prev_month_year").val();
			var showCatId = $("#calendarEventsDateFilter #showing_cat").val();
			var showCatString = "&showCat="+showCatId;
			working();
			$("#calendarEventsDateFilter").load("/actions/ShowCal/?month="+month+"&year="+year+showCatString,function(){
				saved();
			});
		}
		if ($target.attr("id")=="next_month") {
			month = $("#calendarEventsDateFilter #next_month_val").val();
			year = $("#calendarEventsDateFilter #next_month_year").val();
			var showCatId = $("#calendarEventsDateFilter #showing_cat").val();
			var showCatString = "&showCat="+showCatId;
			working();
			$("#calendarEventsDateFilter").load("/actions/ShowCal/?month="+month+"&year="+year+showCatString,function(){
				saved();
			});
		}
		if ($target[0].tagName.toLowerCase()=="td" || $target.parents("td").length) {
			if ($target.parents("td").length) {
				$target = $target.parents("td");
			}
			$("#calendarEventsDateFilter .selectedDay").removeClass("selectedDay");
			$target.addClass("selectedDay");
			var month = $("#calendarEventsDateFilter #current_month_text").val();
			var year = parseInt($("#calendarEventsDateFilter #current_year").val());
			if ($target.hasClass("prevMonth")) {
				month = $("#calendarEventsDateFilter #prev_month_text").val();
				year = year-1;
			}
			if ($target.hasClass("nextMonth")) {
				month = $("#calendarEventsDateFilter #next_month_text").val();
				year = year+1;
			}
			$("#calendarEventsDateFilterButton").html($target.attr("day")+" "+month+" "+year);
			if ($(".eventList .eventItem",$target).length) {
				$("#calendarEventsPaneInner .insertTarget").html($(".eventList",$target).html());
			} else {
				$("#calendarEventsPaneInner .insertTarget").html($(".eventList",$target).html()+"<div class='noPages'>"+LangVars.There_Are_No_Events_For+" "+$target.attr("day")+" "+month+" "+year+"</div>");
			}
			hideCutEvents();
		hide_iconbar_menus();
			
			setTimeout(function() {$("#calendarEventsPaneInner").lovelyScroll();}, 400);

			setTimeout(function() {
				$(".addEventFake").unbind("click").click(function(){
					addEvent();
					return false;
				});
			}, 10);


		}
		return false;

	});


	$("#iconbarDeleteCalendarEvents").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($("#rightPaneCalendarEvents .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Calendar_Event_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteCalendarEvents,false,true);
		}
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarSelectAllCalendarEvents").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#calendarEventsPaneInner .eventItem").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllCalendarEvents").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#calendarEventsPaneInner .listItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	// Tables
	$("#iconbarDeleteTables").click(function(){
		if ($("#tablesPaneInner .listItemHighlight").length) {
			prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Tables_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteTables,false,true);
		}
	});
	$("#tableHeadersJS a").click(function(){
		var newValue = $(this).data("item-value");
		var Ids="[";
		$("#tablesPane .listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("table-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("table-id")+'"';
			}
		});
		Ids+="]";

		working();
		$.ajax({
		  type: "POST",
		  url: "tablesActions.php",
		  data: "tablesAction=changeHeaders&ids="+Ids+"&headers="+newValue,
		  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

				$("#tablesPane .insertTarget .listItemHighlight").each(function(){
					$(this).attr("data-table-header",newValue);
				});
				selectionTools();
				saved();
		
		  }
		});
	});
	$("#iconbarAddTable").click(function(){
		addTable();
		return false;
	});
	
	// Snippets
	$("#iconbarAddSnippet").click(function(){
		addSnippet();
		return false;
	});

	$("#iconbarDeleteSnippets").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($("#snippetsPaneInner .listItemHighlight").length) {
prepDialogue("<h2>"+LangVars.Are_You_Sure+"</h2><p>"+LangVars.Delete_Snippets_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Delete,deleteSnippets,false,true);
		}
		return false;
	});
	$("#iconbarDuplicateSnippets").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($("#snippetsPaneInner .listItemHighlight").length) {
			duplicateSnippets();
		}
		return false;
	});
	$("#iconbarSelectAllSnippets").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#snippetsPaneInner .snippetItem").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllSnippets").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		$("#snippetsPaneInner .listItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});

	// Snippet categories
	$("#manageSnippetCategories").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		//hidePanes();
		$("input").unbind();
		$("#loadingMask").show();
		$(".assetPane").hide();
		hide_iconbar_menus();
		displaySnippetCats();
		assignListLasso($("#snippetCategoriesPaneInner"));
		assignListPane($("#snippetCategoriesPaneInner"),editSnippetCategory);
		$("#rightPaneSnippetCategoriesInner").css("width","auto");
		showPane($("#rightPaneSnippetCategories"),false,true);
		setTimeout(function() {$("#snippetCategoriesPaneInner").lovelyScroll();}, 400);

		assignSnippetCategoriesKeys();
		$("#loadingMask").hide();
		return false
	});
	$("#iconbarDeleteSnippetCategories").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		deleteSnippetCategoriesPrep();
		return false;
	});
	$("#iconbarAddSnippetCategory").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		addSnippetCategory();
		return false;
	});
	$("#snippetFilterCategories,#showAllSnippets").click(function(e){
		var $target=false;
		if ($(e.target).parent().hasClass("filterLink")) {
			$target = $(e.target).parent();
		}
		if ($(e.target).hasClass("filterLink")) {
			$target = $(e.target);
		}
		if (!$target) {
			return false;
		}

		$("#snippetFilterCategories a,#showAllSnippets").removeClass("bpe_current");
		$target.addClass("bpe_current");
		$(".target",$("#snippetFilterCategories").parents(".subHeaderLeftMenuItem")).text($target.attr("data-lang"));
		filterSnippetsByCategory=$target.attr("category-id");
		working();
		$("#snippetsPaneInner .insertTarget").load("snippetsActions.php?snippetsAction=showSnippets&rightPane=&filterCat="+filterSnippetsByCategory,function(){
			saved();
			//assignRightPanePaginate("shopActions.php","shopAction=showProducts&pagination=true&ajax=true&start=","#productsPaneInner");

			setTimeout(function() {$("#snippetsPaneInner").lovelyScroll(pagesScrollBottomSnippets);}, 400);
			assignDragAssets($("#snippetsPaneInner .insertTarget"));
		});
		hide_menus();
		return false;
	});
	$("#snippetCategoriesList").click(function(e){
		var $target=false;
		if ($(e.target).hasClass("overflowEllipsis")) {
			$target = $(e.target).parent();
		}
		if ($(e.target).hasClass("bpe_selection_tool")) {
			$target = $(e.target);
		}
		if (!$target) {
			return false;
		}

		if (!$target.hasClass("greyedOut")) {
			if ($target.hasClass("bpe_current")) {
				var action = "removeFromCat";
			} else {
				var action = "addToCat";
			}
			$clicked = $target;
			var catId = $target.attr("snippet-cat-id");
			if ($("body").hasClass("selectingAll")) {
				var Ids="[";
				$("#rightPaneSnippets .snippetItem:not(.responsiveListItem.listItemHighlight)").each(function(){
					if (Ids=="[") {
					Ids+='"'+$(this).attr("snippet-id")+'"';
					} else {
					Ids+=',"'+$(this).attr("snippet-id")+'"';
					}
				});
				Ids+="]";
				var selectingAll = "&selectingAll=true";
			} else {
				var selectingAll = "";
				var Ids="[";
				$("#rightPaneSnippets .listItemHighlight").each(function(){
					if (Ids=="[") {
					Ids+='"'+$(this).attr("snippet-id")+'"';
					} else {
					Ids+=',"'+$(this).attr("snippet-id")+'"';
					}
				});
				Ids+="]";
			}
			working();
			$.ajax({
			  type: "POST",
			  url: "snippetsActions.php",
			  data: "snippetsAction=changeInCategories&ids="+Ids+"&action="+action+"&cat="+catId+selectingAll+"&filterCat="+filterSnippetsByCategory,
			  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#rightPaneSnippets .listItemHighlight").each(function(){
					if (action=="addToCat") {
						if (!$("#snipcat"+catId,$(this)).length) {
							$(this).append("<input type='hidden' id='snipcat"+catId+"' value='"+catId+"' />")
						}
					} else {
						$("#snipcat"+catId,$(this)).remove();
					}
					var catsCSV = new Array();
					$("input[type=hidden]",$(this)).each(function(){
						catsCSV.push($(this).val());
					});
					catsCSV.sort(function(b,a){return a-b});
					var newCats="";
					for (var i = 0; i < catsCSV.length; i++) {
						if (i==0) {
							newCats=catsCSV[i];
						} else {
							newCats=newCats+","+catsCSV[i];
						}
					};
					$(this).attr("data-snippet-categories",newCats);
				});
				selectionTools();
				saved();
			  }
			});

		}
		return false;
	});
	$("#pinSnippetCat").click(function(){
		hardRetrunToLP=true;
		working();
		if ($(this).hasClass("bpe_current")) {
			var action = "remove";
		} else {
			var action = "add";
		}
		var Ids="[";
		$("#rightPaneSnippetCategories .listItemHighlight").each(function(){
			if (Ids=="[") {
			Ids+='"'+$(this).attr("snippet-category-id")+'"';
			} else {
			Ids+=',"'+$(this).attr("snippet-category-id")+'"';
			}
		});
		Ids+="]";

		$.ajax({
		  type: "POST",
		  url: "snippetsActions.php",
		  data: "snippetsAction=togglePinned&ids="+Ids+"&action="+action,
		  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			$("#rightPaneSnippetCategories .listItemHighlight").each(function(){
				if (action=="add") {
				$(this).attr("data-pinned","1");
				} else {
				$(this).attr("data-pinned","0");
				}

			});
			$("#snippetCategoriesList").show().load("snippetsActions.php?snippetsAction=showCategories",function(){
				saved();
				selectionTools();
			});

		  }
		});
	});
	// Mailing List
	var displayingCampaigns;
	function showCampaigns() {
		$("#campaignsInner").load("/admin/newsletterActions.php?newsletterAction=showCampaigns");
	}
	var campaignToAbort;
	function abortCampaign() {
		working();
		$.ajax({
		  type: "POST",
		  url: "newsletterActions.php",
		  data: "newsletterAction=abort&abortid="+campaignToAbort,
		  success: function(msg){
			 if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				saved();
				hide_menus();
				cancelDialogue();
		  }
		});

	}
	$("#campaignsInner").on('click', '.abort',  function(e){
		campaignToAbort=$(this).attr("abortid");
		prepDialogue("<h2>"+LangVars.Abort_Remaining+"</h2><p>"+LangVars.Abort_Remaining_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Yes,abortCampaign,false,true,false,"");
	}).on('click', '.title a',  function(e){
		window.open($(this).attr("href"),'_blank');
		return false;
	});
	$("#showCampaigns").click(function(){
		$(window).trigger("resize");
		$("#campaigns").addClass("show");
		showCampaigns();
		displayingCampaigns = setInterval(showCampaigns,2000);
		return false;
	});
	$("#closeCampaigns").click(function(){
		clearTimeout(displayingCampaigns);
		$("#campaigns").removeClass("show");
		return false;
	});
	$("#iconbarMailingListAutoresponder").click(function(){
		if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
		if ($("#newsletterPaneInner .listItemHighlight").length) {
			if ($("#newsletterPaneInner .listItemHighlight[group-id=]").length) {
				error(LangVars.Not_On_Default_Mailing_List);
			} else {
					prepDialogue("<h2>"+LangVars.AutoResponder+"</h2><p>"+LangVars.MailingListAutoResponder_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Done,changeMailingListAutoresponder,false,true,true,"mailingListAutoresponder");
			}

		}
		return false;
	});

	$("#changeMailingListAutoresponderContent").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		logTrainingClick("clickMailingListContent");
		showLightPages(changeMailingListAutoresponderContent,"showTop",true,LangVars.Choose_page);
		return false;
	});

	$("#iconbarAddMailingList").click(function(){
		addMailingList();
		return false;
	});
	$("#iconbarDeleteNewsletter").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		deleteMailingListPrep();
		return false;
	});
	$("#iconbarSelectAllNewsletter").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#newsletterPaneInner .responsiveListItem").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllNewsletter").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#newsletterPaneInner .listItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#changeMailingListSubject").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		logTrainingClick("clickMailingListSubject");
		prepDialogue("<h2>"+LangVars.Change_Mailing_List_Subject_Heading+"</h2><p>"+LangVars.Change_Mailing_List_Subject_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Save,changeMailingListSubject,false,true,true,"newsletterSubject");

		return false
	});
	$("#changeMailingListPageContent").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		logTrainingClick("clickMailingListContent");
		showLightPages(changeMailingListPageContent,"showTop",true,LangVars.Choose_page);
		return false;
	});


	$("#notifyMeChange").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		if ($(this).hasClass("bpe_current")) {
			var notifyMe = "";
		} else {
			var notifyMe = "yes";
		}
		$me = $(this);
		working();
		$.ajax({
		  type: "POST",
		  url: "newsletterActions.php",
		  data: "newsletterAction=toggleNotifyMe",
		  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if (msg=="1") {
					$me.addClass("bpe_current");
				} else {
					$me.removeClass("bpe_current");
				}
				saved();
		  }
		});
		return false;
	});
	$("#newsletterFromSetting").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		logTrainingClick("clickMailingListFrom");
		prepDialogue("<h2>"+LangVars.From_Title+"</h2><p>"+LangVars.From_Info+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Save,changeMailingListFrom,false,true,true,"newsletterFrom");
		return false;
	});
	$("#newsletterSMTPSetting").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.SMTP_Title+"</h2><p>"+LangVars.Newsletter_SMTP_Info+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Save,changeMailingListSMTP,false,true,true,"newsletterSMTP");
		return false;
	});
// subscribers

	$("#iconbarAddSubscriber").click(function(){
		newSubscriber();
		return false;
	});
	$("#editNewsletterSubscribersTitle").click(function(e){
		if ($(e.target)[0].tagName.toLowerCase()=="span") {
			editMe($(this));
		}
	});
	$("#iconbarStatusSubscribers").click(function(){
		if (!$(this).hasClass("greyedOut")) {
			if ($("#statusMenuSubscribers:visible").length) {
				$("#statusMenuSubscribers:visible").hide();
			} else {
				hide_iconbar_menus();
				$("#statusMenuSubscribers").show();
			}
		}
		return false;
	});
	$("#iconbarImportSubscribers").click(function(){
		prepDialogue("<h2>"+LangVars.Import_Subscribers+"</h2><p>"+LangVars.Import_Subscribers_Text+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Import,importNewsletterCSV,false,true,true,"newsletterImport");

		return false;
	});
	$("#iconbarExportSubscribers").click(function(){
		window.location.href = "newsletterActions.php?newsletterAction=exportCSV&filterCat="+filterSubscribersByCategory+filterSubscribersByCategoryMatchAll+filterSubscribersByStatus;
		return false;
	});

	$("#subActive").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		toggleSubInactive("");
		return false;
	});
	$("#subInactive").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		toggleSubInactive("yes");
		return false;
	});
	$("#addNewsletterCustomField").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.Add_Custom_Field+"</h2><p>"+LangVars.Add_Custom_Field_Text+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Add,addNewsletterCustomField,false,true,true,"addNewsletterCustomField");
		return false;
	});
	$("#iconbarDeleteNewsletterSubscribers").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		deleteSubscribersPrep();
		return false;
	});
	$("#iconbarSelectAllNewsletterSubscribers").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#newsletterSubscribersPaneInner .responsiveListItem").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllNewsletterSubscribers").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#newsletterSubscribersPaneInner .listItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#subscriberCustomFields").click(function(e) {
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		if ($(e.target).hasClass("paneToolTextItem")) {
			$("#subscriberCustomFields .editingField").removeClass("editingField");
			$(e.target).addClass("editingField");
			prepDialogue("<h2>"+$(e.target).prev().html()+"</h2>",LangVars.Cancel,cancelDialogue,LangVars.Save,changeNewsletterCustomField,false,true,true,"changeNewsletterCustomField");
		}
		return false;
	});
	
	// Subscriber categories
	$("#manageSubscriberCategories").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		//hidePanes();
		$("input").unbind();
		$("#loadingMask").show();
		$(".assetPane,#rightPaneNewsletterSubscribers").hide();
		hide_iconbar_menus();
		displaySubscriberCats();
		assignListLasso($("#subscriberCategoriesPaneInner"));
		assignListPane($("#subscriberCategoriesPaneInner"),editSubscriberCategory);
		$("#rightPaneSubscriberCategoriesInner").css("width","auto");
		showPane($("#rightPaneSubscriberCategories"),false,true);
		setTimeout(function() {$("#subscriberCategoriesPaneInner").lovelyScroll();}, 400);

		assignSubscriberCategoriesKeys();
		$("#loadingMask").hide();
		return false
	});
	$("#iconbarDeleteSubscriberCategories").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		deleteSubscriberCategoriesPrep();
		return false;
	});
	$("#iconbarAddSubscriberCategory").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		addSubscriberCategory();
		return false;
	});
	function showEmails() {
		working();
		$("#newsletterSubscribersPaneInner .insertTarget").load("newsletterActions.php?newsletterAction=showEmails&filterCat="+filterSubscribersByCategory+filterSubscribersByCategoryMatchAll+filterSubscribersByStatus,function(){
			saved();
			setTimeout(function() {$("#newsletterSubscribersPaneInner").lovelyScroll(pagesScrollMailingListSubs);}, 400);
			assignDragAssets($("#newsletterSubscribersPaneInner .insertTarget"));
		});
		//hide_menus();
	}
	$("#subscriberFilterCategoriesMatchAll").click(function(){
		if ($(this).hasClass("bpe_current")) {
			$(this).removeClass("bpe_current");
			filterSubscribersByCategoryMatchAll="&matchAll=false";
		} else {
			$(this).addClass("bpe_current");
			filterSubscribersByCategoryMatchAll="&matchAll=true";
		}
		showEmails();
		return false;
	});
	$("#statusShowAnySubscribers").click(function(){
		$("#statusShowAnySubscribers,#statusShowActiveSubscribers,#statusShowInactiveSubscribers").removeClass("bpe_current");
		$(this).addClass("bpe_current");
		filterSubscribersByStatus="";
		showEmails();
		return false;
	});
	$("#statusShowActiveSubscribers").click(function(){
		$("#statusShowAnySubscribers,#statusShowActiveSubscribers,#statusShowInactiveSubscribers").removeClass("bpe_current");
		$(this).addClass("bpe_current");
		filterSubscribersByStatus="&filterStatus=";
		showEmails();
		return false;
	});
	$("#statusShowInactiveSubscribers").click(function(){
		$("#statusShowAnySubscribers,#statusShowActiveSubscribers,#statusShowInactiveSubscribers").removeClass("bpe_current");
		$(this).addClass("bpe_current");
		filterSubscribersByStatus="&filterStatus=yes";
		showEmails();
		return false;
	});
	$("#subscriberFilterCategories,#showAllSubscribers").click(function(e){
		var $target=false;
		if ($(e.target).parent().hasClass("filterLink")) {
			$target = $(e.target).parent();
		}
		if ($(e.target).hasClass("filterLink")) {
			$target = $(e.target);
		}
		if (!$target) {
			return false;
		}

		$("#showAllSubscribers").removeClass("bpe_current");
		if ($target.attr("category-id")=="") {
			$("#subscriberFilterCategories a").removeClass("bpe_current");
		}
		if ($target.hasClass("bpe_current") && !$target.attr("category-id")=="") {
			$target.removeClass("bpe_current")
		} else {
			$target.addClass("bpe_current");
		}
		filterSubscribersByCategory="";
		$("#subscriberFilterCategories a.bpe_current").each(function(){
			if (filterSubscribersByCategory!="") {
				var comma = ",";
			} else {
				var comma = "";
			}
			filterSubscribersByCategory=filterSubscribersByCategory+comma+$(this).attr("category-id");

		});
		if (filterSubscribersByCategory=="") {
			$("#showAllSubscribers").addClass("bpe_current");
		}
		var label  ="";
		$("#subscriberFilterCategories a.bpe_current,#showAllSubscribers.bpe_current").each(function(){
			if (label!="") {
				var comma = ",";
			} else {
				var comma = "";
			}
			label=label+comma+$(this).attr("data-lang");
		});
		$(".target",$("#subscriberFilterCategories").parents(".subHeaderLeftMenuItem")).text(label);

		showEmails();
		return false;
	});
	$("#subscriberCategoriesList").click(function(e){
		var $target=false;
		if ($(e.target).hasClass("overflowEllipsis")) {
			$target = $(e.target).parent();
		}
		if ($(e.target).hasClass("bpe_selection_tool")) {
			$target = $(e.target);
		}
		if (!$target) {
			return false;
		}

		if (!$target.hasClass("greyedOut")) {
			if ($target.hasClass("bpe_current")) {
				var action = "removeFromCat";
			} else {
				var action = "addToCat";
			}
			$clicked = $target;
			var catId = $target.attr("subscriber-cat-id");
			if ($("body").hasClass("selectingAll")) {
				var Ids="[";
				$("#rightPaneNewsletterSubscribers .responsiveListItem:not(.responsiveListItem.listItemHighlight)").each(function(){
					if (Ids=="[") {
					Ids+='"'+$(this).attr("subscriber-id")+'"';
					} else {
					Ids+=',"'+$(this).attr("subscriber-id")+'"';
					}
				});
				Ids+="]";
				var selectingAll = "&selectingAll=true";
			} else {
				var selectingAll = "";
				var Ids="[";
				$("#rightPaneNewsletterSubscribers .listItemHighlight").each(function(){
					if (Ids=="[") {
					Ids+='"'+$(this).attr("subscriber-id")+'"';
					} else {
					Ids+=',"'+$(this).attr("subscriber-id")+'"';
					}
				});
				Ids+="]";
			}
			working();
			$.ajax({
			  type: "POST",
			  url: "newsletterActions.php",
			  data: "newsletterAction=changeInCategories&ids="+Ids+"&action="+action+"&cat="+catId+selectingAll+"&filterCat="+filterSubscribersByCategory+filterSubscribersByCategoryMatchAll+filterSubscribersByStatus,
			  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#rightPaneNewsletterSubscribers .listItemHighlight").each(function(){
					if (action=="addToCat") {
						if (!$("#subcat"+catId,$(this)).length) {
							$(this).append("<input type='hidden' id='subcat"+catId+"' value='"+catId+"' />")
						}
					} else {
						$("#subcat"+catId,$(this)).remove();
					}
					var catsCSV = new Array();
					$("input[type=hidden]",$(this)).each(function(){
						catsCSV.push($(this).val());
					});
					catsCSV.sort(function(b,a){return a-b});
					var newCats="";
					for (var i = 0; i < catsCSV.length; i++) {
						if (i==0) {
							newCats=catsCSV[i];
						} else {
							newCats=newCats+","+catsCSV[i];
						}
					};
					$(this).attr("data-subscriber-categories",newCats);
				});
				selectionTools();
				saved();
			  }
			});

		}
		return false;
	});

	// Blog
	$("#iconbarBlogOrganise").click(function(){
		if (!$(this).hasClass("greyedOut")) {
			if ($("#organiseMenuBlog:visible").length) {
				$("#organiseMenuBlog:visible").hide();
			} else {
				hide_iconbar_menus();
				logTrainingClick("iconbarBlogOrganise"+blogOrganiseClick);
				$("#organiseMenuBlog").show();

			}
		}
		return false;
	});
	$("#manageAuthors").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("input").unbind();
		$("#loadingMask").show();
		$("#rightPaneBlog").hide();
		hide_iconbar_menus();
		logTrainingClick("iconbarBlogManageAuthors");
		$("#blogAuthorsPaneInner .insertTarget").html("");
		$("#blogAuthorsPaneInner .insertTarget").append($("#blogPaneInner #authorsMenuList .addBlogAuthor").clone());
		$("#blogAuthorsPaneInner .insertTarget").append("<div class='dropzone'><div></div></div>");
		if (!$("#blogAuthorsList a").length) {
			$("#blogAuthorsPaneInner .insertTarget").append("<div class='noPages'>"+LangVars.No_Blog_Authors+"</div>");
		}
		$("#blogAuthorsList a.authorItem").each(function(){
			$("#blogAuthorsPaneInner .insertTarget").append("<div class='responsiveListItem' blog-author-id='"+$(this).attr("blog-author-id")+"' blog-author-bio=\""+htmlentities($(this).attr("blog-author-bio"))+"\"><span class='overflowEllipsis'>"+$(this).attr("data-lang")+"</span></div><div class='responsiveListAddForm inline' style='display:none'><div class='imageContextEditFieldset'><div class='imageContextEditLabel'>"+LangVars.Blog_Author_Name+"</div><div class='imageContextEditInputWrap'><input type='text' name='' class='focus newBlogAuthorName' value=\""+$(this).attr("data-lang")+"\" original=\""+$(this).attr("data-lang")+"\"/></div></div><div class='imageContextEditFieldset'><div class='imageContextEditLabel'>"+LangVars.Blog_Author_Bio+"</div><div class='imageContextEditInputWrap'><input type='text' name='' class='newBlogAuthorBio' value=\""+htmlentities($(this).attr("blog-author-bio"))+"\" original=\""+htmlentities($(this).attr("blog-author-bio"))+"\" /></div></div></div><div class='dropzone'><div></div></div>");
		});
		assignListLasso($("#blogAuthorsPaneInner"));
		assignListPane($("#blogAuthorsPaneInner"),editBlogAuthor);
		assignBlogAuthorsKeys();

		$("#rightPaneBlogAuthors").show();
		$("#blogAuthorsPaneInner").lovelyScroll();
		$("#loadingMask").hide();
    $(window).trigger("resize");
		return false;
	});
	$("#manageCategories").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		hidePanes();
		$("input").unbind();
		$("#loadingMask").show();
		$("#rightPaneBlog").hide();
		hide_iconbar_menus();
		$("#blogCategoriesPaneInner .insertTarget").html("");
		$("#blogCategoriesPaneInner .insertTarget").append($("#blogPaneInner #catsMenuList .addBlogCategory").clone());
		$("#blogCategoriesPaneInner .insertTarget").append("<div class='dropzone'><div></div></div>");
		if (!$("#blogCategoriesList a").length) {
			$("#blogCategoriesPaneInner .insertTarget").append("<div class='noPages'>"+LangVars.No_Blog_Categories+"</div>");
		}
		$("#blogCategoriesList a").each(function(){
			$("#blogCategoriesPaneInner .insertTarget").append("<div class='responsiveListItem' blog-category-id='"+$(this).attr("blog-category-id")+"' data-reverse-order=\""+$(this).attr("data-reverse-order")+"\"><span class='overflowEllipsis'>"+$(this).attr("data-lang")+"</span></div><div class=\"responsiveListAddForm inline\" action=\"\" method=\"post\" style='display:none;' rel=\""+$(this).attr("blog-category-id")+"\"><input type=\"text\" name=\"\" value=\""+$(this).attr("data-lang")+"\" class=\"focus\"	/></div><div class='dropzone'><div></div></div>");
		});
		assignListLasso($("#blogCategoriesPaneInner"));
		assignListPane($("#blogCategoriesPaneInner .insertTarget"),editBlogCategory);

		assignBlogCategoriesKeys();
		$("#rightPaneBlogCategories").show();
		$("#blogCategoriesPaneInner").lovelyScroll();
		$("#loadingMask").hide();
    $(window).trigger("resize");
		return false;
	});
	$("#blogCategoriesList").click(function(e){

		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$this = $(e.target);
		var target=false;
		if ($this[0].tagName.toLowerCase()=="a") {
			$target = $this;
		}
		if ($this.parent()[0].tagName.toLowerCase()=="a") {
			$target = $this.parent();
		}
		if ($target) {
			var catId = $target.attr("blog-category-id");
			if ($target.hasClass("bpe_current")) {
				var action = "removeCat";
				$target.removeClass("bpe_current");
			} else {
				var action = "addCat";
				$target.addClass("bpe_current");
			}
			
			var selection = getSelectedBlogs();
			var selectingAll = selection[0];
			var Ids = selection[1];
			
			working();
			$.ajax({
			  type: "POST",
			  url: "blogActions.php",
			  data: "blogAction=change&ids="+Ids+"&action="+action+"&cat="+catId+selectingAll,
			  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#blogPaneInner .listItemHighlight").each(function(){
					var cats = $(this).attr("blog-categories").split(",");

					if (action=="addCat") {
						cats.push(catId);
					} else {
						var index=cats.indexOf(catId);
						cats.splice(index, 1);
					}
					cats.sort(function(a,b){return a-b});
					var newCats="";
					for (var i = 0; i < cats.length; i++) {
						if (i==0) {
							newCats=cats[i];
						} else {
							newCats=newCats+","+cats[i];
						}
					};
					$(this).attr("blog-categories",newCats).attr("data-blog-categories",newCats);
					
					
				});
				if ($("#blogFilterCategoriesToUpdate a.bpe_current[blog-category-id=\""+catId+"\"]").length && action=="removeCat") {
					switchToBlog(true,true);
				} else {
					saved();					
				}
				
				
				selectionTools();

			  }
			});
		}
		return false;
	});
	$("#blogAuthorsList").click(function(e){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$this = $(e.target);
		var target=false;
		if ($this[0].tagName.toLowerCase()=="a") {
			$target = $this;
		}
		if ($this.parent()[0].tagName.toLowerCase()=="a") {
			$target = $this.parent();
		}
		if ($target) {
			if ($target.hasClass("bpe_current")) {
				var authorId = "";
			} else {
				var authorId = $target.attr("blog-author-id");
			}

			var selection = getSelectedBlogs();
			var selectingAll = selection[0];
			var Ids = selection[1];
	
			working();
			$.ajax({
			  type: "POST",
			  url: "blogActions.php",
			  data: "blogAction=change&ids="+Ids+"&action=author&author="+authorId+selectingAll,
			  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#blogPaneInner .listItemHighlight").attr("blog-author",authorId).attr("data-blog-author",authorId);
				$("#blogAuthorsList a").removeClass("bpe_current");
				if (authorId!="") {
					$target.addClass("bpe_current");
				}
				selectionTools();
				saved();
			  }
			});
		}
		return false;
	});
	$("#iconbarLanguageBlog").click(function(){
		if ($(this).hasClass("greyedOut")) {
			return false;
		}
		if ($("#languageMenuBlog:visible").length) {
			$("#languageMenuBlog:visible").hide();
		} else {
			hide_iconbar_menus();
			$("#languageMenuBlog").show().removeClass("inNarrow");

		}
		return false;
	});

	$("#addLanguageBlogNew").unbind().click(function(e){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}

		if ($(e.target)[0].tagName.toLowerCase()=="a") {
			if ($(e.target).hasClass("bpe_current")) {
				return false;
			}
			if ($(e.target).hasClass("changeLanguage")) {
				changeLanguageBlog($(e.target).attr("fakehref"));
			} else {
				pagesAddLanguage($(e.target));
			}

		}


		return false;
	});

	$("#iconbarDeleteBlog").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		deleteBlogPrep();
		return false;
	});
	$("#iconbarSelectAllBlog").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#blogPaneInner .responsiveListItem").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllBlog").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#blogPaneInner .listItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarBlogSettings").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		logTrainingClick("blogSettings");
		if ($("#settingsMenuBlog:visible").length) {
			$("#settingsMenuBlog:visible").hide();
		} else {
			hide_iconbar_menus();
			$("#settingsMenuBlog").show().removeClass("inNarrow");
		}
		return false;
	});
	$("#newCommentApprovalToggle").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		if ($(this).hasClass("bpe_current")) {
			var action = "";
		} else {
			var action = "yes";
		}
		var el = $(this);
		$.ajax({
		  type: "POST",
		  url: "blogActions.php",
		  data: "blogAction=changeConfig&action=manual_approve&manual_approve="+action,
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if (action=="yes") {
					el.addClass("bpe_current");
				} else {
					el.removeClass("bpe_current");
				}

		  }
		});
		return false;
	});
	$("#changeCommentNotificationEmail").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
			prepDialogue("<h2>"+LangVars.Change_Comment_Notification_Heading+"</h2><p>"+LangVars.Change_Comment_Notification_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Save,changeCommentNotificationEmail,false,true,true,"commentNotification");
		return false;
	});
	$("#changeSecretPass").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.Change_Secret_Pass_Heading+"</h2><p>"+LangVars.Change_Secret_Pass_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Save,changeSecretPass,false,true,true,"secretPass");
		return false;
	});
	$("#changeArticlePerPage").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.Change_Number_On_Page_Heading+"</h2><p>"+LangVars.Change_Number_On_Page_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Save,changeArticlesOnPage,false,true,true,"articlesPerPage");
		return false;
	});
	$("#iconbarStatusBlog").click(function(){
		if (!$(this).hasClass("greyedOut")) {
			if ($("#statusMenuBlog:visible").length) {
				$("#statusMenuBlog:visible").hide();
			} else {
				hide_iconbar_menus();

				var smLeft = $("#iconbarStatusBlog").offset().left;
				var ibLeft = $("#bottomIconbarBlog").offset().left;
				smLeft = smLeft-ibLeft;
				smLeft=smLeft-7;
				$("#statusMenuBlog").css("left",smLeft+"px").show();

			}
		}

		return false;
	});
	$("#blogLive").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		toggleBlogLive("yes");
		return false;
	});
	$("#blogOffline").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		toggleBlogLive("");
		return false;
	});
	$("#iconbarAddBlog").click(function(){
		addBlog();
		return false;
	});
	$("#blogMoreButton").click(function(){
		if ($("#blogMoreMenu:visible").length) {
			$("#blogMoreMenu:visible").hide();
		} else {
			hide_iconbar_menus();
			$("#blogMoreMenu").show();
		}
		return false;
	});
	$("#blogMoreSettings").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		hide_iconbar_menus();
		$("#settingsMenuBlog").show().addClass("inNarrow");

		return false;
	});
	$("#blogMoreLangs").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		if ($(this).hasClass("greyedOut")) {
			return false;
		}
		hide_iconbar_menus();
		$("#languageMenuBlog").show().addClass("inNarrow");


		return false;
	});
	// Blog authors
	$("#iconbarAddBlogAuthor").click(function(){
		addBlogAuthor();
		return false;
	});

	$("#iconbarDeleteBlogAuthors").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		deleteBlogAuthorsPrep();
		return false;
	});
	$("#iconbarSelectAllBlogAuthors").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#blogAuthorsPaneInner .responsiveListItem").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllBlogAuthors").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#blogAuthorsPaneInner .listItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	// blog categories
	$("#iconbarAddBlogCategory").click(function(){
		addBlogCategory();
		return false;
	});

	$("#iconbarDeleteBlogCategories").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		deleteBlogCategoriesPrep();
		return false;
	});
	$("#reverseBlogsToggle").click(function(){
		toggleReverseBlogCats();
		return false;
	});
	$("#iconbarSelectAllBlogCategories").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#blogCategoriesPaneInner .responsiveListItem").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllBlogCategories").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#blogCategoriesPaneInner .listItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	// Blog comments
	$("#iconbarToggleApprovalBlogComments").click(function(){
		if (!$(this).hasClass("greyedOut")) {
			if ($("#approvalMenuBlogComments:visible").length) {
				$("#approvalMenuBlogComments:visible").hide();
			} else {
				hide_iconbar_menus();
				$("#approvalMenuBlogComments").show();
			}
		}
		return false;
	});
	$("#commentApprove").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		blogCommentApproval("approve");
		return false;
	});
	$("#commentUnapprove").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		blogCommentApproval("unapprove");
		return false;
	});
	$("#iconbarAddBlogComment").click(function(){
		addCommentReply();
		return false;
	});

	$("#iconbarDeleteBlogComments").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		deleteBlogCommentsPrep();
		return false;
	});
	$("#iconbarSelectAllBlogComments").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#blogCommentsPaneInner .responsiveListItem").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllBlogComments").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#blogCommentsPaneInner .listItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});

	// Checkout
	$("#checkoutFromSetting").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.From_Title+"</h2><p>"+LangVars.From_Info+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Done,changeCheckoutFrom,false,true,true,"checkoutFrom");

		return false;
	});
	$("#checkoutSMTPSetting").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
				prepDialogue("<h2>"+LangVars.SMTP_Title+"</h2><p>"+LangVars.Checkout_SMTP_Info+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Done,changeCheckoutSMTP,false,true,true,"checkoutSMTP");

		return false;
	});
	$("#iconbarCheckoutSettings").click(function(){
		if (!$(this).hasClass("greyedOut")) {
			if ($("#settingsMenuCheckout:visible").length) {
				$("#settingsMenuCheckout:visible").hide();
			} else {
				hide_iconbar_menus();

				var smLeft = $("#iconbarCheckoutSettings").offset().left;
				var ibLeft = $("#bottomIconbarCheckout").offset().left;
				smLeft = smLeft-ibLeft;
				smLeft=smLeft-7;
				$("#settingsMenuCheckout").css("left",smLeft+"px").show();

			}
		}
		return false;
	});
	$("#changePayPalEmail").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
			prepDialogue("<h2>"+LangVars.Change_PayPal_Email_Heading+"</h2><p>"+LangVars.Change_PayPal_Email_Text+"<p>",LangVars.Change_PayPal_Email_Button_No,cancelDialogue,LangVars.Change_PayPal_Email_Button_Yes,changePayPalEmail,false,true,true,"paypalEmail");
		return false;
	});
	$("#changeMerchantID").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
			prepDialogue("<h2>"+LangVars.Change_Merchant_ID_Heading+"</h2><p>"+LangVars.Change_Merchant_ID_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Save,changeMerchantID,false,true,true,"merchantID");
		return false;
	});
	$("#enableTaxCheckout").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		working();
		var el = $(this);
		if ($(this).hasClass("bpe_current")) { // turn it off
			var enable = '0';
		} else {
			var enable = '1';			
		}
		$.ajax({
		  type: "POST",
		  url: "shopActions.php",
		  data: "shopAction=saveSettings&enable_tax="+enable,
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			if (msg != "error") {
				if (enable=="1") {
					el.addClass("bpe_current");					
				} else {
					el.removeClass("bpe_current");					
				}

			}
			saved();
		  }
		});
		return false;
	});
	$("#taxIncludedOrExcluded").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		working();
		var el = $(this);
		if ($(this).hasClass("bpe_current")) { // turn it off
			var enable = '1';
		} else {
			var disable = '0';			
		}
		$.ajax({
		  type: "POST",
		  url: "shopActions.php",
		  data: "shopAction=saveSettings&add_tax="+enable,
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			if (msg != "error") {
				if (enable=="1") {
					el.removeClass("bpe_current");					
				} else {
					el.addClass("bpe_current");					
				}

			}
			saved();
		  }
		});
		return false;
	});
	$("#changeSalesTax").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.Change_Sales_Tax+"</h2><p>"+LangVars.Change_Sales_Tax_Info+"</p>" //text
			,LangVars.Cancel //primaryText
			,cancelDialogue //primaryFun
			,LangVars.Done //secondaryText
			,changeSalesTax //secondaryFun
			,false //primaryImportant
			,true //secondaryImportant
			,true //textField
			,"" //editingType
			,"" //linkBuilder
			,"" //url
			,"" //ids
			,"" //selectingAll
		 	,""//items
		 	,""//updateAttr
			,$(this).find(".value .overflowEllipsis").text()//prefill

		);
		return false;
	});
	$("#changeSalesTaxName").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.Change_Sales_Tax_Name+"</h2><p>"+LangVars.Change_Sales_Tax_Name_Info+"</p>" //text
			,LangVars.Cancel //primaryText
			,cancelDialogue //primaryFun
			,LangVars.Done //secondaryText
			,changeSalesTaxName //secondaryFun
			,false //primaryImportant
			,true //secondaryImportant
			,true //textField
			,"" //editingType
			,"" //linkBuilder
			,"" //url
			,"" //ids
			,"" //selectingAll
		 	,""//items
		 	,""//updateAttr
			,$(this).find(".value .overflowEllipsis").text()//prefill
		);
		return false;
	});
	$("#enableCheckoutMessage").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		working();
		var el = $(this);
		if ($(this).hasClass("bpe_current")) { // turn it off
			$.ajax({
			  type: "POST",
			  url: "shopActions.php",
			  data: "shopAction=saveSettings&no_note=0",
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if (msg != "error") {
					el.removeClass("bpe_current");
				}
				saved();
			  }
			});
		} else { // turn it on
			$.ajax({
			  type: "POST",
			  url: "shopActions.php",
			  data: "shopAction=saveSettings&no_note=1",
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if (msg != "error") {
				 	el.addClass("bpe_current");
				}
				saved();
			  }
			});
		}
		return false;
	});
	$("#changeCurrency").change(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		var id = $(this).val();
		//var el = $(this);
		$.ajax({
		  type: "POST",
		  url: "shopActions.php",
		  data: "shopAction=saveSettings&currency="+id,
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			if (msg != "error") {
				saved("Currency changed to "+id);
				$("#currentCurrency").html(id);

			}
		  }
		});
		return false;
	});
	$("#checkoutSuccessPage").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		showLightPages(changeSuccessPage,"showTop",true,LangVars.Choose_page);
		return false;
	});
	$("#checkoutFailPage").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		showLightPages(changeFailPage,"showTop",true,LangVars.Choose_page);
		return false;
	});
	$("#formsListSettings").change(function(){
		$(this).attr("data-current-form-checkout",$(this).val());
		$.ajax({
		  type: "POST",
		  url: "settingsActions.php",
		  data: "settingsAction=formOnCheckout&formId="+$(this).val(),
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

			if (msg != "ok") {
				error(LangVars.Misc_Error);
			}
		  }
		});
		return false;
	});
	$("#orderReceivedTemplate").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.Order_Received_Template+"</h2><p>"+LangVars.Order_Received_Template_Info.replace(/\|\|/g,"<br/>")+"<p><p class='popupExpand'>"+LangVars.Order_Received_Template_Info_Ex.replace(/\|\|/g,"<br/>")+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Done,changeOrderReceivedTemplate,false,true,true,"orderReceivedTemplate");
		return false;
	});
	$("#orderDispatchedTemplate").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.Order_Dispatched_Template+"</h2><p>"+LangVars.Order_Dispatched_Template_Info.replace(/\|\|/g,"<br/>")+"<p><p class='popupExpand'>"+LangVars.Order_Dispatched_Template_Info_Ex.replace(/\|\|/g,"<br/>")+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Done,changeOrderDispatchedTemplate,false,true,true,"orderDispatchedTemplate");
		return false;
	});

	$("#downloadCSV,#downloadCSVOpen").click(function(){
					window.open($(this).attr('href'),'null');
		return false;
	});
	$("#showInvoice").click(function(){
		if (!$(this).hasClass("unavailable")) {
			var href = $("#openOrders .listItemHighlight").data('invoice-address');
			window.open(href,'null');
		}
		return false;
	});
	$("#iconbarCheckoutDispatch").click(function(){
		if ($("#checkoutPaneInner .listItemHighlight").length) {
	prepDialogue("<h2>"+LangVars.Dispatch_Heading+"</h2><p>"+LangVars.Dispatch_Text+"<p>",LangVars.Dispatch_Button_No,cancelDialogue,LangVars.Dispatch_Button_Yes,dispatchOrders,false,true);
		}
		return false;
	});

	$("#iconbarSelectAllCheckout").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#checkoutPaneInner .responsiveListItem").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllCheckout").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#checkoutPaneInner .listItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeleteCheckout").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		deleteOrdersPrep();
		return false;
	});

	// Dashboard
	$("#iconbarDashboardTraining").click(function(){
		if ($("#dashboardTrainingMenu:visible").length) {
			$("#dashboardTrainingMenu:visible").hide();
		} else {
			hide_iconbar_menus();

			var smLeft = $("#iconbarDashboardTraining").offset().left;
			var ibLeft = $("#bottomIconbarDashboard").offset().left;
			smLeft = smLeft-ibLeft;
			smLeft=smLeft+3;
			$("#dashboardTrainingMenu").css("left",smLeft+"px").show();

		}
		return false;
	});
	$("#systemMenuHints").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		working();
		var el = $("a",$(this));
		if (el.hasClass("bpe_current")) {
			var ht = "1";
			$(".listTipUp").hide();
		} else {
			var ht = "0";
			$(".listTipUp").show();
		}
		$.ajax({
			  type: "POST",
			  url: "adminUsersActions.php",
			  data: "adminUsersAction=hideTips&hideTips="+ht,
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				saved();
				if (ht=="0") {
					el.addClass("bpe_current");
					el.html(LangVars.Hide_Hints);
					$("body").removeClass("hideTips");
				} else {
					el.removeClass("bpe_current");
					el.html(LangVars.Show_Hints);
					$("body").addClass("hideTips");
				}

			  }
			});
		return false;
	});
	$("#trainingList a").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		currentTrainingSet = $(this).attr("training-set");
		currentTrainingStep = $(this).attr("first-step");

		showTraining(false);
		hide_iconbar_menus();
		return false;
	});
	$("#settingsFlyinMask,#closeSettingsFlyin").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#settingsFlyinMask").fadeOut(200,function(){
			cancelDialogue();
		});
		$("#websiteSettings,#websiteSettingsPopin,#singleSetup").removeClass("selected");
		$("#settingsFlyin").animate({right:"-400px"},200,function(){
			$("#settingsFlyin").hide();
		});
		$("#themeOptions .settingsItem.editing").removeClass("editing");
		return false;
	});

	$("#lpSettings,#backToSettings,#lpDesign").click(function(){
		$("#settingsFlyinHeaderText,#designFlyinHeaderText").hide();
		if ($(this).attr("id")=="lpDesign") {
			$("#designFlyinHeaderText").show();
		} else {
			$("#settingsFlyinHeaderText").show();
		}
		dismissEditors();
		unassignKeys();
		$(this).addClass("selected");

		if (!$(".settingsGroupContent").length) {
			var settingsCell=1;
			$("#settingsFlyinInner .settingsGroupHeading").each(function(){
				$(this).hide();
				if (typeof $(this).attr("id") != "undefined") {
					var i = $(this).attr("id");
				} else {
					var i = "";
				}
				if ($(this).hasClass("design-mode")) {
					var dm = "design-mode";
				} else {
					var dm= "";
				}
				$("#settingsTwoPaneLeft").append("<div class='settingsCellButton "+dm+"' data-cell='settingsCell"+settingsCell+"' data-orig-id='"+i+"'>"+$(this).html()+"</div>");
				$(this).after("<div class='settingsGroupContent' id='settingsCell"+settingsCell+"'></div>");
				var $cell = $(this).next();
				$cell.nextAll().each(function(){
					if ($(this).hasClass("settingsGroupHeading") || $(this).hasClass("stopAtTheme")) {
						return false;
					}
					$(this).appendTo($cell);
				});
				settingsCell++;
			});
			$("#settingsFlyinInner .settingsCellButton:first").addClass("current");
			$("#settingsFlyinInner .settingsGroupContent").hide();
			$("#settingsFlyinInner .settingsGroupContent:first").show();
			$("#settingsFlyinInner .settingsCellButton").click(function(){
				var target = $(this).attr("data-cell");
				$("#settingsFlyinInner .settingsCellButton").removeClass("current");
				$(this).addClass("current");
				$("#settingsFlyinInner .settingsGroupContent").hide();
				$("#settingsFlyinInner #"+target).show();
				$("#settingsTwoPaneRight").lovelyScroll();

				if ($("#settingsTwoPaneLeft").css("right")=="auto") {
					$("#settingsTwoPaneLeft").animate({right:"100%"},300);
					$("#settingsTwoPaneRight").animate({left:"0%"},300);
					$("#backSettingsFlyinMain").fadeIn();
					$("#settingsFlyinHeaderText,#designFlyinHeaderText").html($(this).html());
				}


			});
			$("#backSettingsFlyinMain").click(function(){
				$("#settingsFlyinHeaderText").html($("#settingsFlyinHeaderText").attr("original"));
				$("#designFlyinHeaderText").html($("#designFlyinHeaderText").attr("original"));
				$("#backSettingsFlyinMain").fadeOut();
				$("#settingsTwoPaneLeft").animate({right:"0%"},300,function(){
				$("#settingsTwoPaneLeft").css("right","auto");
				});
				$("#settingsTwoPaneRight").animate({left:"100%"},300);
			});
			$(".settingsDropdown select").css("display","block");
		}
		if ($(this).attr("id")=="backToSettings") {

			$h = $("#settingsFlyinInner .settingsCellButton[data-orig-id=sitewideSettingsHeading]");
			if ($("#settingsTwoPaneLeft").css("right")=="auto") {
				$("#settingsTwoPaneLeft").animate({right:"100%"},300);
				$("#settingsTwoPaneRight").animate({left:"0%"},300);
				$("#backSettingsFlyinMain").fadeIn();
			}
			$("#settingsFlyinHeaderText,#designFlyinHeaderText").html($h.html());

			var target = $h.attr("data-cell");
			$("#settingsFlyinInner .settingsCellButton").removeClass("current");
			$h.addClass("current");
			$("#settingsFlyinInner .settingsGroupContent").hide();
			$("#settingsFlyinInner #"+target).show();
		}
		if ($(this).attr("id")=="lpDesign") {
			$(".settingsCellButton").hide();
			$(".settingsCellButton.design-mode").show();
			$("#settingsFlyinInner .settingsCellButton").removeClass("current");
			setTimeout(function () {
			$("#settingsFlyinInner .settingsCellButton.design-mode").first().addClass("current").trigger("click");				
			}, 20);

		}  else {
			$(".settingsCellButton").hide();
			$(".settingsCellButton:not(.design-mode)").show();
			setTimeout(function () {
			$(".settingsCellButton:not(.design-mode)").first().addClass("current").trigger("click");
			}, 20);
		}

		$("#settingsFlyin").show();

		$("#settingsTwoPaneLeft,#settingsTwoPaneRight").lovelyScroll();			


		//});
		//return false;
	});
	$("#settingsFlyinHeader").scroll(function(){

		justScrolled=true;
		if (scrollTimeout) {
			clearTimeout(scrollTimeout);
		}
		scrollTimeout = setTimeout(function() {
			justScrolled=false;
		},500);
	});
	$("#systemMenuStats").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}

		window.location="/admin/?stats";
		return false;
	});
	$("#systemMenuLogout,#systemMenuLogoutPopin").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}

		window.location="logout.php";
		return false;
	});


	$("#stats").append($("#statsNote"));
	$("#iconbarDashboardSettings").click(function(){
		if ($("#dashboardSettingsMenu:visible").length) {
			$("#dashboardSettingsMenu:visible").hide();
		} else {
			hide_iconbar_menus();

			var smLeft = $("#iconbarDashboardSettings").offset().left;
			var ibLeft = $("#bottomIconbarDashboard").offset().left;
			smLeft = smLeft-ibLeft;
			smLeft=smLeft-7;
			$("#dashboardSettingsMenu").css("left",smLeft+"px").show();

		}
		return false;
	});
	$("#settingsFlyinInner #themeOptions select").change(function(){

		buildThemeVars();
	});
	$("#backSettingsFlyin").click(function(){
		$("#settingsFlyinInner").animate({left:"0"});
		$("#settingsFlyinInner2").animate({left:"100%"});
		$("#backSettingsFlyin").fadeOut();
		$("#backSettingsFlyinMain.hidden").show();
		$("#settingsFlyinHeaderText").text($("#settingsFlyinHeaderText").attr("original-altered"));
		$("#designFlyinHeaderText").text($("#designFlyinHeaderText").attr("original-altered"));
		$("#themeOptions .settingsItem.editing").removeClass("editing");

	});
	$("#settingsFlyinInner .themeOptionImage:not(.video)").dropzone({
		url:"/admin/settingsActions.php"
		,clickable:true
		,paramName: "image"
		,params:{settingsAction:"addThemeImage"}
		,previewsContainer:"#null"
		,maxFilesize:m
		,acceptedMimeTypes:"image/*"
		,dictInvalidFileType:LangVars.Upload_Error_Bad_Format
		,dictResponseError:LangVars.Misc_Error
		,dictFileTooBig:LangVars.File_Too_Large
		,init: function() {
			this.on("addedfile", function() {
				working();
			}),
			this.on("sending", function(file, xhr, formData) {
				if ($(this.element).hasClass("overflowEllipsis")) {
					var $target=$(this.element).parent();
				} else {
					var $target=$(this.element);
				}
			  	formData.append("varName", $target.attr("rel"));
			});
			this.on("error", function(file,message) {
				error(message);
			}),
			this.on("success", function(file,serverData,e,t) {
				if ($(this.element).hasClass("overflowEllipsis")) {
					var $target=$(this.element).parent();
				} else {
					var $target=$(this.element);
				}
				$target.attr("value",serverData);
				buildThemeVars();
				setTimeout(function () {
					saved();
				}, 1000);
			});
  		}
	});
	$("#settingsFlyinInner .themeOptionImage.video").dropzone({
		url:"/admin/settingsActions.php"
		,clickable:true
		,paramName: "image"
		,params:{settingsAction:"addThemeImageVideo"}
		,previewsContainer:"#null"
		,maxFilesize:m
		,dictInvalidFileType:LangVars.Upload_Error_Bad_Format
		,dictResponseError:LangVars.Misc_Error
		,dictFileTooBig:LangVars.File_Too_Large
		,init: function() {
			this.on("addedfile", function() {
				working();
			}),
			this.on("sending", function(file, xhr, formData) {
				if ($(this.element).hasClass("overflowEllipsis")) {
					var $target=$(this.element).parent();
				} else {
					var $target=$(this.element);
				}
			  	formData.append("varName", $target.attr("rel"));
			});
			this.on("error", function(file,message) {
				error(message);
			}),
			this.on("success", function(file,serverData,e,t) {
				if ($(this.element).hasClass("overflowEllipsis")) {
					var $target=$(this.element).parent();
				} else {
					var $target=$(this.element);
				}
				$target.attr("value",serverData);
				buildThemeVars();
				setTimeout(function () {
					saved();
				}, 1000);
			});
  		}
	});
	$("#settingsFlyinInner2").click(function(e){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$this = $(e.target);
		if ($this.parent().hasClass("settingsImagePreview")) {
			$clicked = $this.parent();
		}
		if ($this.parent().parent().hasClass("settingsImagePreview")) {
			$clicked = $this.parent().parent();
		}
		$("#themeOptions .settingsItem.editing").attr("var-value",$clicked.attr("option-value"));
		$("#settingsFlyinInner").animate({left:"0"});
		$("#settingsFlyinInner2").animate({left:"100%"});
		$("#backSettingsFlyin").fadeOut();
		$("#backSettingsFlyinMain.hidden").show();
		$("#settingsFlyinHeaderText").text($("#settingsFlyinHeaderText").attr("original-altered"));
		$("#designFlyinHeaderText").text($("#designFlyinHeaderText").attr("original-altered"));
		$("#themeOptions .settingsItem.editing .settingsFlyinThumb").attr("src",$("img",$clicked).attr("src"));
		$("#themeOptions .settingsItem.editing .value .overflowEllipsis").html($clicked.attr("option-display-value")).attr("title",$clicked.attr("option-display-value"));
		$("#themeOptions .settingsItem.editing").removeClass("editing");
		buildThemeVars();

	});
	$("#settingsFlyinInner").click(function(e){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}

		$this = $(e.target);
		var $themeOption = false;
		var $themeText = false;
		var $themeToggle = false;
		var $themeImage = false;
		var $themeOptionImagePreview = false;

		if ($this.attr("id")=="changeHomepage") {
			showLightPages(changeHomepage,"showTop",false,LangVars.Choose_Homepage);

			return false;
		}

		if ($this.hasClass("changeThemeOption")) {
			$themeOption = $this;
		}
		if ($this.parent().hasClass("changeThemeOption")) {
			$themeOption = $this.parent();
		}
		if ($this.hasClass("themeOptionText")) {
			$themeText = $this;
		}
		if ($this.parent().hasClass("themeOptionText")) {
			$themeText = $this.parent();
		}
		if ($this.parent().parent().hasClass("themeOptionText")) {
			$themeText = $this.parent().parent();
		}
		if ($this.hasClass("settingsDropdownImagePreviews")) {
			$themeOptionImagePreview = $this;
		}
		if ($this.parent().hasClass("settingsDropdownImagePreviews")) {
			$themeOptionImagePreview = $this.parent();
		}
		if ($this.parent().parent().hasClass("settingsDropdownImagePreviews")) {
			$themeOptionImagePreview = $this.parent().parent();
		}
		if ($this.hasClass("themeOptionToggle")) {
			$themeToggle = $this;
		}
		if ($this.parent().hasClass("themeOptionToggle")) {
			$themeToggle = $this.parent();
		}
		if ($this.hasClass("themeOptionImage")) {
			$themeImage = $this;
		}
		if ($this.hasClass("removeThemeImage")) {
			$this.parents(".themeOptionImage").attr("value","");
			buildThemeVars();
			return false;
		}
		if ($this.parent().hasClass("themeOptionImage")) {
			$themeImage = $this.parent();
		}

		if ($this.hasClass("returnTrue")) {
			window.location=$this.attr("href");
			return false;
		}
		if ($this.parent().hasClass("returnTrue")) {
			window.location=$this.parent().attr("href");
			return false;
		}

		if ($themeOption) {
			$('.themeOptionsChoices[theme-var-name="'+$themeOption.attr("theme-var-name")+'"] .bpe_current').removeClass("bpe_current");
			$('.themeOptionsChoices[theme-var-name='+$themeOption.attr("theme-var-name")+'] .changeThemeOption[href="'+$themeOption.attr("href")+'"]').addClass("bpe_current");
			$(".changeThemeOption",$themeOption.parent()).removeClass("bpe_current");
			$themeOption.addClass("bpe_current");
			buildThemeVars();
			return false;
		}
		if ($themeText) {
			$themeText.addClass("editing");	prepDialogue("<h2>"+htmlentities($themeText.attr("theme-var-display-name"))+"</h2><p>"+htmlentities($themeText.attr("theme-var-info"))+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Save,changeThemeOption,false,true,true,"themeOption");
			return false;
		}
		if ($themeOptionImagePreview) {
			$("#settingsFlyinInner2 > div").html($(".imageOptions",$themeOptionImagePreview).html());

			$("#settingsFlyinInner").animate({left:"-100%"});
			$("#settingsFlyinInner2").animate({left:"0px"});
			$("#backSettingsFlyin").fadeIn();
			$("#settingsFlyinHeaderText").attr("original-altered",$("#settingsFlyinHeaderText").text());
			$("#designFlyinHeaderText").attr("original-altered",$("#designFlyinHeaderText").text());
			$("#backSettingsFlyinMain:visible").hide().addClass("hidden");
			$("#settingsFlyinHeaderText").text($themeOptionImagePreview.attr("display-name"));
			$("#designFlyinHeaderText").text($themeOptionImagePreview.attr("display-name"));
			$themeOptionImagePreview.addClass("editing");
		}
		if ($themeToggle) {
			if ($themeToggle.hasClass("bpe_current")) {
				$themeToggle.removeClass("bpe_current");
			} else {
				$themeToggle.addClass("bpe_current");
			}
			buildThemeVars();
			return false;
		}

	});

	$("#changeAdminEmail").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
			prepDialogue("<h2>"+LangVars.Change_Account_Email_Heading+"</h2><p>"+LangVars.Change_Account_Email_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Save,changeAccountEmail,false,true,true,"accountEmail");
		return false;
	});
	$("#changeAdminPassword").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
			prepDialogue("<h2>"+LangVars.Change_Account_Password_Heading+"</h2>",LangVars.Cancel,cancelDialogue,LangVars.Save,changeAccountPassword,false,true,true,"accountPassword");
		return false;
	});
	$("#systemMenuYou").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}

			prepDialogue("",LangVars.Cancel,cancelDialogue,LangVars.Save,changeYourAccount,false,true,true,"yourAccount");
		return false;
	});
	$('#systemMenuResetTips').click(function(){
		working();
		$.ajax({
		  type: "POST",
		  url: "adminUsersActions.php",
		  data: "adminUsersAction=updateViewedTips&hidenTips=",
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			window.location.href="/admin/";

		  }
		});
		return false;
	});
	// Livechat
	$("#iconbarLivechatSettings").click(function(){
		if (!$(this).hasClass("greyedOut")) {
			if ($("#settingsMenuLivechat:visible").length) {
				$("#settingsMenuLivechat:visible").hide();
			} else {
				hide_iconbar_menus();

				var smLeft = $("#iconbarLivechatSettings").offset().left;
				var ibLeft = $("#bottomIconbarLivechat").offset().left;
				smLeft = smLeft-ibLeft;
				smLeft=smLeft-7;
				$("#settingsMenuLivechat").css("left",smLeft+"px").show();

			}
		}
		return false;
	});
	$("#livechatStatus").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
			working();
			var el = $(this);
			if (!$(this).hasClass("bpe_current")) {
					$.ajax({
					  type: "POST",
					  url: "livechatActions.php",
					  data: "livechatAction=changeStatus&livechat_status=on",
					  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
						saved("Livechat status online");
						el.addClass("bpe_current");
						poller = setInterval(onlineFail, 30000);
						onlineFail();
					  }
					});
			} else {
					$.ajax({
					  type: "POST",
					  url: "livechatActions.php",
					  data: "livechatAction=changeStatus&livechat_status=off",
					  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
						saved("Livechat status offline");
						el.removeClass("bpe_current");
					  }
					});

			}
		return false;
	});
	$("#livechatMessage").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.Change_Livechat_Message_Heading+"</h2><p>"+LangVars.Change_Livechat_Message_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Save,changeLivechatMessage,false,true,true,"livechatMessage");

		return false;
	});

	$("#livechatName").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.Change_Livechat_Name_Heading+"</h2><p>"+LangVars.Change_Livechat_Name_Text+"<p>",LangVars.Cancel,cancelDialogue,LangVars.Save,changeLivechatName,false,true,true,"livechatName");

		return false;
	});

	$("#iconbarLivechatArchives").click(function(){
		if ($("#menuLivechatArchive:visible").length) {
			$("#menuLivechatArchive:visible").hide();
		} else {
			hide_iconbar_menus();
			$("#menuLivechatArchive").show();
		}
		return false;
	});
	$("#iconbarSelectAllLivechat").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#livechatPaneInner .responsiveListItem").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllLivechat").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#livechatPaneInner .listItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeleteLivechat").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		prepDeleteLivechats();
		return false;
	});
	$("#viewLivechatLog").click(function(e){

		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		if ($(e.target)[0].tagName.toLowerCase()=="a") {
			window.open($(e.target).attr("livechat-href"),'null','toolbar=0,scrollbars=0,location=0,statusbar=0,menubar=0,resizable=0,width=311,height=349');

		}
		return false;
	});

	// Staff
	$("#iconbarNewStaff").click(function(){
		addStaff();
		return false;
	});

	$("#iconbarDeleteStaff").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
    if (!$(this).hasClass("unavailable")) {
		  prepDeleteStaff();
    }

		return false;
	});

	$("#iconbarSelectAllStaff").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#rightPaneStaff .responsiveListItem").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllStaff").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#rightPaneStaff .listItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#resetStaffPassword").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		prepDialogue("<h2>"+LangVars.Reset_Password+"</h2>",LangVars.Cancel,cancelDialogue,LangVars.Save,resetStaffPassword,false,true,true,"resetStaffPass");
		return false;
	});
	$("#iconbarPrivsStaff").click(function(){
		if ($("#privsMenuStaff:visible").length) {
			$("#privsMenuStaff:visible").hide();
		} else {
			hide_iconbar_menus();
			var allTheSame=true;
			var firstPrivs = $("#rightPaneStaff .listItemHighlight:first").attr("privs");
			$("#rightPaneStaff .listItemHighlight").each(function(){
				if ($(this).attr("privs")!=firstPrivs) {
					allTheSame=false;
				}
			});
			$("#privsMenuStaff .privilegeItem,#allPrivs").removeClass("bpe_current");
			var fpArray = firstPrivs.split(",");
			if (allTheSame) {
				var privCounter = 0;
				var allEnabled=true;
				$("#privsMenuStaff .privilegeItem").each(function(){
					if (fpArray[privCounter]=="1") {
						$(this).addClass("bpe_current");
					} else {
						allEnabled=false;
					}
					privCounter++;
				});
				if (allEnabled) {
					$("#allPrivs").addClass("bpe_current");
				}
			}
			$("#privsMenuStaff").show();
		}
		return false;
	});
	
	$("#staffPane .privilegeItem").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}

		if ($(this).hasClass("bpe_current")) {
			$(this).removeClass("bpe_current");
			if ($(this).hasClass("allTickCandidate")) {
				$("#allPrivs").removeClass("bpe_current");
			}

		} else {
			$(this).addClass("bpe_current");
		}
		changePrivs();
		return false;
	});
	$("#allPrivs").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		if ($(this).hasClass("bpe_current")) {
			$(this).removeClass("bpe_current");
			$("#staffPane .privilegeItem.allTickCandidate").removeClass("bpe_current");
		} else {
			$(this).addClass("bpe_current");
			$("#staffPane .privilegeItem.allTickCandidate").addClass("bpe_current");
		}
		changePrivs();
		return false;
	});
	// embed codes

	$("#iconbarNewEmbedCodes").click(function(){
		addEmbedCodes();
		return false;
	});

	$("#iconbarDeleteEmbedCodes").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		prepDeleteEmbedCodes();
		return false;
	});
	$("#iconbarSelectAllEmbedCodes").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#rightPaneEmbedCodes .responsiveListItem").addClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});
	$("#iconbarDeselectAllEmbedCodes").click(function(){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		$("#rightPaneEmbedCodes .listItemHighlight").removeClass("listItemHighlight");
		selectionTools();
		hide_iconbar_menus();
		return false;
	});


	///

	///

	///

	var slmaskw= $("#slideMask .slide1").width();
	$("#slideMask").css("width",slmaskw+"px");
/*	$("#deleteSelectedSlide2").click(function(){
		var sl2w = $("#slideMask .slide2").width();
		var sl1w = $("#slideMask .slide1").width();
		var half = sl2w-sl1w;
		sl1w = sl1w+20;
		$("#slideMask .slideWrapper").animate({left:'-'+sl1w+"px"});
		$("#slideMask").animate({ width:sl2w+"px" });

		half = half / 2;
		var curleft = $("#popupControl").offset().left;
		half = curleft-half;
		$("#popupControl").animate({left:half+'px'});
		return false;
	});

	$("#cancelPopupControl").click(function(){
		cancelPopupControl();
		return false;
	});
	$("#dismissPopupControl").click(function(){
		dismissPopupController();
		return false;
	});
	$("#confirmPopupControl").click(function(){
		if ($("#adminPages").hasClass("ticking")) {
			var Ids="";
			$(".editPageBar.checked").each(function(){
				if (Ids=="") {
				Ids=$(this).attr("rel");
				} else {
				Ids+=","+$(this).attr("rel");
				}
			});
			working();
			$.ajax({
			  type: "POST",
			  url: "pageActions.php",
			  data: "pageAction=deleteMulti&ids="+Ids,
			  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

					if (msg!="ok") {
						error(msg);
					} else {
						$("#adminPages").load("pages.php",function(){
							$("#copyPage").html($("#adminPages").html());
							assign_page_filter($("#copyPage"));

							$("#copyPageWithSubs").html($("#adminPages").html());
							assign_page_filter($("#copyPageWithSubs"));

							$("#movePage").html($("#adminPages").html());
							assign_page_filter($("#movePage"));

							if ($("#cloneSource").length) {
								$("#cloneSource").html($("#adminPages").html());
								assign_page_filter($("#cloneSource"));
							}

							assignPages();
							assign_page_filter();
							dismissPopupController();
							saved();
						});
					}
			  }
			});
		}
	});
	*/
	$("#popupControl").hide();
	$("#cloneDelete").click(function(){
		working();
		$.ajax({
		  type: "POST",
		  url: "pageActions.php",
		  data: "pageAction=removeCloneSource&pageId="+$("#kbid").val(),
		  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

				if (msg!="ok") {
					error(msg);
				} else {
					document.location.reload();

				}

		  }
		});
		return false;
	});
	function setCloneSource ($target) {
		var sourceId = $target.attr("rel");
		var pageName = $target.attr("title");

		var id = $("#kbid").val();
		if (id==sourceId) {
			error(LangVars.Page_Cant_Clone);
		} else {
			working();
			$.ajax({
			  type: "POST",
			  url: "pageActions.php",
			  data: "pageAction=addCloneSource&cloneSource="+sourceId+"&pageId="+$("#kbid").val(),
			  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					if (msg=="") {
						error(LangVars.Misc_Error);
					} else {
						saved();
						hide_menus();
						$("#entryWrapper").hide();
						$("#bpe_add_menu").hide();
						$("#saveEditPage,#publishInPreview").hide();
						$("#cloning").show();
						$("#dragInsert").hide();
						$("#cloning p").attr("title",LangVars.Clone_Source_URL+": "+msg);
						$("#cloningPageName").html(pageName);
						$("#versionsToHide").hide();
						$(".textEditingArea .listTipEditor").hide();
					}
			  }
			});
		}
	}
	$("#cloneSource,#cloneSourceTiny").click(function(event){
		showLightPages(setCloneSource,"showTop",true,LangVars.Choose_page);
		return false;
	});
	$("#copyPage,#copyPageWithSubs,#movePage").click(function(event){
		if ($(this).attr("id")=="copyPage") {
			var action = "copy";
		} else if ($(this).attr("id")=="copyPageWithSubs") {
			var action = "copyWithSubs";
		} else {
			var action = "move";
		}
		var $target = $(event.target);
		var ok = false;
		if ( $target.hasClass("copyPageDestinaiton") || $target.hasClass("movePageDestinaiton")) {
			ok = true;
			var str = $target.attr("id").split("|");
			type = str[0];
			var parentId = str[1];
		}
		if ( $target.parents(".copyPageDestinaiton").length) {
			ok = true;
			var str = $target.parents(".copyPageDestinaiton").attr("id").split("|");
			type = str[0];
			var parentId = str[1];
		}
		if ( $target.parents(".movePageDestinaiton").length) {
			ok = true;
			var str = $target.parents(".movePageDestinaiton").attr("id").split("|");
			type = str[0];
			var parentId = str[1];
		}
		if (ok==true) {

			if (type=="") {
				type = "topLevel";
			}
			var id = $("#kbid").val();
			if (id==parentId) {
				error(LangVars.Page_Not_Inside_Itself);
			} else {
					working();
					$.ajax({
					  type: "POST",
					  url: "pageActions.php",
					  data: "pageAction="+action+"&parent="+parentId+"&type="+type+"&id="+id,
					  success: function(msg){
				if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

							if (msg!="ok") {
								error(msg);
							} else {
								$("#adminPages").load("pages.php",function(){
									$("#copyPage").html($("#adminPages").html());
									assign_page_filter($("#copyPage"));

									$("#copyPageWithSubs").html($("#adminPages").html());
									assign_page_filter($("#copyPageWithSubs"));

									$("#movePage").html($("#adminPages").html());
									assign_page_filter($("#movePage"));
									if ($("#cloneSource").length) {
										$("#cloneSource").html($("#adminPages").html());
										assign_page_filter($("#cloneSource"));
									}

									assignPages();
									assign_page_filter();

									saved();
									hide_menus();
								});

							}

					  }
					});
			}

		}

	});
/* EXAMPLE SYNTAX
	 $("a").click(function(){
	   alert("Example");
	 });
	$('#gallery a').lightBox(); // Lightbox script.
*/
	$("#popupControl").click(function(){
		return false;
	});
	$(document).click(function(e){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		hide_menus();
	});
	//assign_help();
if ($("#entryleftWrapper").css("display")=="block") {
	$("#entryleft").bpeditor();
}
if ($("#entryrightWrapper").css("display")=="block") {
	$("#entryright").bpeditor();
}
if ($("#entry2leftWrapper").css("display")=="block") {
	$("#entry2left").bpeditor();
}
if ($("#entry2rightWrapper").css("display")=="block") {
	$("#entry2right").bpeditor();
}


$("#entry").bpeditor();

if ($("#cloning").css("display")=="block") {
	$("#bpe_add_menu").hide();
}
//$("#entry2").bpeditor();
$("body").mousedown(function(){
	$("#saved").hide();
	$("#error").hide();
	$("#message").hide();
});
$("#overlay,#saved,#error,#message,#newConvo").click(function(){
	$("#overlay").fadeOut(200);
	$("#savedLog").fadeOut(200);
	$("#saved").fadeOut(200);
	$("#error").fadeOut(200);
	$("#message").fadeOut(200);
	$("#newConvo").fadeOut(200);
});




	function assignGalleries () {
		$(".showAddImageForm").click(function(){
			if ($("#"+$(this).attr("id")+"form").css("display")=="none") {
				$(".uploadForm").hide(500);
				$("#"+$(this).attr("id")+"form").fadeIn(500);
			} else {
				$("#"+$(this).attr("id")+"form").fadeOut(500);
			}
			return false;
		});
		$(".pagesTable tr:even").addClass("alt");
		$(".uploadForm").submit(function(){
			working();
			function showResponse (responseText, statusText) {
if (responseText =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if (responseText=="notjpg") {
					error(LangVars.Misc_Error);
				} else if (responseText=="ok") {
					$("#galleriesAdmin").load("galleriesActions.php?galleriesAction=show&to_prevent_cache="+(new Date).getTime(),function(){
						assignGalleries();
						saved("Image Added");
					});
				} else {
					error(LangVars.Misc_Error);
				}

			}
			var options = {
		        success:       showResponse  // post-submit callback
		    };
			if ($("input[name=image]",this).val()=="")  {
				cancel();
			} else {
				$(this).ajaxSubmit(options);
			}
			return false;
		});
		$(".submitAddImageForm").click(function(){
			$(this).parent().parent().submit();
			return false;
		});

		$(".addImagesToGallery").click(function(){
			$(".drag").remove();

			return false;
		});
		$("#showAddGalForm").click(function(){
			clickToAddNew($(this),$("#addGalleryForm")," Type a name and hit enter",false);
			return false;
		});


		$(".renameGalleryForm").submit(function(){
			var id = $("input[name=id]",$(this)).val();
			working();
			function showResponse (responseText, statusText) {
if (responseText =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#galleriesAdmin").load("galleriesActions.php?galleriesAction=show&to_prevent_cache="+(new Date).getTime(),function(){
					assignGalleries();
					saved("Gallery Renamed");
				});
				if ($(".ComponentGallery-"+id).length) {
					window.location.reload();
				}
			}
			var options = {
		        success:       showResponse  // post-submit callback
		    };
		if ($("input[name=name]",this).val()=="")  {
			cancel();
		} else {
			$(this).ajaxSubmit(options);
		}
				return false;
		});

		$(".toggleRenameGallery").click(function(){
			clickToEdit($(this),$("#"+$(this).attr('id')+"form")," Type a name and hit enter",true);
			return false;
		});

		$(".confirmDeleteGallery").click(function(){
			working();
			id  = $(this).attr('id');
				$.ajax({
				  type: "POST",
				  url: "galleriesActions.php",
				  data: "galleriesAction=deleteGallery&id="+id,
				  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					$("#galleriesAdmin").load("galleriesActions.php?galleriesAction=show&to_prevent_cache="+(new Date).getTime(),function(){
						assignGalleries();
						saved("Gallery Removed");
					});
					if ($(".ComponentGallery-"+id).length) {
						window.location.reload();
					}
					assignSaveListener();
				  }
				});
				return false;
		});
		$(".renameImageForm").hide();
		$(".renameImageLink").click(function(){
			clickToEdit($(this),$("#"+$(this).attr('id')+"form")," Type a caption and hit enter",true);
			return false;
		});
		$(".galleryThumb").unbind("mouseover");
		$(".galleryThumb").unbind("mouseout");
//		$(".galleryThumb").mouseover(function(){
//			$(this).append("<span class='bpe_big_image_top'><img src='"+$("img",$(this)).attr("src")+"'/></span>");
//		});
//		$(".galleryThumb").mouseout(function(){
//			$(".bpe_big_image_top",$(this)).remove();
//		});



		$(".deleteImageButton").click(function(){
			working();
			var galid  = $(this).attr('href');
				$.ajax({
				  type: "POST",
				  url: "galleriesActions.php",
				  data: "galleriesAction=deleteImage&imagesid="+$(this).attr('id'),
				  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					$("#galleriesAdmin").load("galleriesActions.php?galleriesAction=show&show="+galid+"&to_prevent_cache="+(new Date).getTime(),function(){
						assignGalleries();
						saved("Image Removed");
					});
				  }
				});

			return false;
		});
		//assign_menus($("#galleriesAdmin"));
		$(".insertComponentMenuGallery").html("");
		var galList;
		if ($(".toggleRenameGallery").length==0) {
			$(".insertComponentMenuGallery").html("<span class='bpe_menu_message'>No galleries available</span>");
		}
		$(".toggleRenameGallery").each(function(){
			var id = $(this).attr("id").replace("renameGallery-","");
			var title = $(this).attr("title");
			$(".insertComponentMenuGallery").append("<a href=\""+id+"\" class=\"insertGallery\">"+title+"</a>");
		});

		$(".sortable",$("#galleriesAdmin")).sortable({
//			connectWith: ".sortable",
			handle: ".galImageDrag",
			update: function(){
				working();
				var order = "";
				$(".sortable",$("#galleriesAdmin")).each(function(){
					var id = $(this).attr("id").replace("galleryImages-","");
					order=order+"!!"+id+"*";
					var orderNo = 10;
					$(".galleryThumb",$(this)).each(function(){
						picId = $(this).attr("id").replace("galleryThumb-","");
						order=order+orderNo+"|"+picId+",";
						orderNo=orderNo+10;
					});
				});
				$.ajax({
				  type: "POST",
				  url: "galleriesActions.php",
				  data: "galleriesAction=imageSort&data="+order,
				  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					if (msg=="ok") {
						saved("Order Changed");
					} else {
						error(LangVars.Misc_Error);
					}

				  }
				});
			}
		});
		$("#galleriesAdmin").parents(".menuScroll").removeClass("menuScrollDone");
		menuScroll($("#galleriesAdmin").parents(".menuScroll"));
		$(".menuScroll:visible",$("#galleriesAdmin")).each(function(){
			menuScroll($(this));
		});

	}
	/*
	assign_menus($("#mainMenu"));*/
	$("#galleriesAdmin").load("galleriesActions.php?galleriesAction=show&to_prevent_cache="+(new Date).getTime(),function(){
		if ($("#galleriesAdmin .responsiveListItem").length) {
			$("#dragInsertGallery").removeClass("greyedOut");
		}
//		assignGalleries();
//		$("#formsWrapper").load("formsActions.php?formsAction=show&to_prevent_cache="+(new Date).getTime(),function(){
//			assign_forms();
//			assignProducts();
		});
//	});

$("#formsWrapper").load("formsActions.php?formsAction=show&to_prevent_cache="+(new Date).getTime(),function(){
		addFormsToSettings();
		if ($("#formsWrapper .responsiveListItem").length) {

			$("#dragInsertForm").removeClass("greyedOut");
		}


//			assign_forms();
//			assignProducts();
		});



	/* languages module */
	function assignLanguages () {
		$(".confirmDeleteLanguage").click(function(){
				working();
				id = $(this).attr('id');

					$.ajax({
					  type: "POST",
					  url: "languagesActions.php",
					  data: "languagesAction=deleteLanguage&id="+id,
					  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
						if (msg=="ok") {
							$("#languagesWrapper").load("languagesActions.php?languagesAction=show&to_prevent_cache="+(new Date).getTime(),function(){
								assignLanguages();
									$("#adminPages").load("pages.php",function(){
										assignPages();
										assign_page_filter();
										$("#blogEntries").load("blogActions.php?blogAction=showEntries&to_prevent_cache="+(new Date).getTime(),function(){
											assignBlogEntries();
											saved("Language removed");
										});
									});


							});
						}
					  }
					});
					return false;


		});


		$("#addLanguage a:not(.filterBox a)").unbind("click");
		$("#addLanguage a:not(.filterBox a)").click(function(){
			working();
			var lang = $(this).attr("href");
			$.ajax({
			  type: "POST",
			  url: "languagesActions.php",
			  data: "languagesAction=addLanguage&lang="+lang,
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#languagesWrapper").load("languagesActions.php?languagesAction=show&to_prevent_cache="+(new Date).getTime(),function(){
					assignLanguages();
					$("#adminPages").load("pages.php",function(){
						assignPages();
						assign_page_filter();
						$("#blogEntries").load("blogActions.php?blogAction=showEntries&to_prevent_cache="+(new Date).getTime(),function(){
							assignBlogEntries();
							saved("Language added");
						});
					});
					$("#addLanguage").parents(".bpe_menu_sub_items2").hide();
					$(".bpe_sub_hilite2").removeClass("bpe_sub_hilite2");
				});
			  }
			});
			return false;
		});
		$("#submitLangugeForm").click(function(){
			$("#languageForm").submit();
			return false;
		});
		//assign_menus($("#languagesWrapper"));
	}
//	softPagination($("#addLanguage"));
	/*
	$("#languagesWrapperBlog").load("languagesActions.php?languagesAction=show&to_prevent_cache="+(new Date).getTime(),function(){
		//assignLanguages();
		$("#languagesWrapper").html($("#languagesWrapperBlog").html());

		if ($("#languagesWrapper a").length) {
			$("#languagesWrapper a:not(:eq(0))").each(function(){
				$("#otherLangsSitewide").append("<div class='otherLangSitewide' language='"+$(this).text()+"' language-code='"+$(this).attr("fakehref")+"'></div>");
			});
			$("#otherLangsSitewide > div").html($("#primaryLangSitewide").html());
			$("#otherLangsSitewide > div").each(function(){
				$div = $(this);
				$(".settingsItem a",$(this)).each(function(){
					$(this).append(" ("+$div.attr("language")+")").attr("href",$(this).attr("href")+"&language="+$div.attr("language-code"));
				});

			});
		}
	});

	*/
	updateSitewideLangs();
	$("#closeMessage").click(function(){
		$(this).parent().fadeOut(300);
		return false;
	});


	$("#toggleAddCalCat").click(function(){
		clickToAddNew($(this),$("#addCalCat")," Type a new category name and hit enter",false);
		return false;
	});
	$("#addCalCat").submit(function(){
		working();
		var name = encodeURIComponent($("input[name=name]",$(this)).val());
		$.ajax({
		  type: "POST",
		  url: "calendarActions.php",
		  data: "calendarAction=addCat&name="+name,
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			$("#calCatsList").html(msg);
			assignCalCats();
			$(".menuForm").hide();
			date = $("#eventDate").val();
			var splitd = date.split("/");
			day = splitd[0]
			month = splitd[1]
			year = splitd[2];
			$("#cal").load("/actions/ShowCal/?month="+month+"&year="+year+"&day="+day,function(){
				assignCal();
				saved("Calendar category added");
			});
		  }
		});
		return false;
	});
	function assignCalCats () {
		//assign_menus($("#calCatsList"));

		$(".renameCalCatLink").unbind();
		$(".renameCalCatLink").click(function(){
			clickToEdit($(this),$(this).parent().next(),"",true,true);
			return false;
		});
		$(".renamecalCatForm").submit(function(){
			var catId = $("input[name=id]",$(this)).val();
			working()
			function showResponse (responseText, statusText) {
if (responseText =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#calCatsList").html(responseText);
				assignCalCats();
				date = $("#eventDate").val();
				var splitd = date.split("/");
				day = splitd[0]
				month = splitd[1]
				year = splitd[2];
				$("#cal").load("/actions/ShowCal/?month="+month+"&year="+year+"&day="+day,function(){
					assignCal();
					saved("Calendar category renamed");
				});
				if ($(".ComponentCalendarCat-"+catId).length) {
					window.location.reload();
				}
			}
			var options = {
		        success:       showResponse  // post-submit callback
		    };
			$(this).ajaxSubmit(options);
			return false;
		});
		$(".choices3.confirmDelete a.deleteCalCat").click(function(){
			var catId = $(this).attr("id");
			working();
			$.ajax({
			  type: "POST",
			  url: "calendarActions.php",
			  data: "calendarAction=deleteCat&id="+catId,
			  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#calCatsList").html(msg);
				assignCalCats();
				$(".menuForm").hide();
				date = $("#eventDate").val();
				var splitd = date.split("/");
				day = splitd[0]
				month = splitd[1]
				year = splitd[2];
				$("#cal").load("/actions/ShowCal/?month="+month+"&year="+year+"&day="+day,function(){
					assignCal();
					saved("Calendar category deleted");
				});
				if ($(".ComponentCalendarCat-"+catId).length) {
					window.location.reload();
				}
			  }
			});
			return false;
		});
	}
	assignCalCats();


	windowH = $(window).height()-230;
	lines = windowH / 23;
	lines = Math.floor(lines-3);

	$("#renameSnippet").unbind("click").click(function(e){
		if ($(e.target)[0].tagName.toLowerCase()=="span") {
			dismissEditors();
			editMe($(this));
		}
		return false;
	});
	$("#renameSnippetForm").unbind("submit").submit(function(){
		sendForm($(this),$("#snippetsWrapper"));
		var newname = $("input[name=name]",$(this)).val();
		$("#renameSnippet").attr("title", newname );
		var trunc = newname.substring(0, 45);
		if (newname.length>45) {
		trunc = trunc+"&hellip;";
		}
		$("#renameSnippet span").html(trunc);
		$("#renameSnippet").css("width","auto");
		var width2 = $("#renameSnippet span").width()+10;
		$("#renameSnippet").css("width",width2+"px").addClass("centered");
		return false;
	});
	$("#renamePage").click(function(e){
		if ($(e.target)[0].tagName.toLowerCase()=="span") {
			dismissEditors();

			editMe($(this));
		}
	});
	$(".renamePageForm").submit(function(){
		function showResponse (responseText, statusText) {

if (responseText =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			if (responseText=="exists") {
				error(LangVars.Page_Name_Exists);
			} else if (responseText=="empty") {
				error(LangVars.Misc_Error);
			} else {
				var newTitles = responseText.split("|!|!******");
				$("#viewURL").attr("href","/"+newTitles[1]);
				$("#renamePage span").html(newTitles[0]);
				$("#renamePage").attr("title",newTitles[2]);
				$("#renamePage").css("width","auto");
				var width = $("#renamePage span").width()+10;
				width  = width;
				$("#renamePage").css("width",width+"px").addClass("centered");
				$(".menuForm").hide();
				$(".menuFormLink").show();
				$(".editPageMenu").hide();
				$("#adminPages").load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){
					assignPages();
					assign_page_filter();
					saved("Page Renamed");
				});
				$(document).click(function(){
					if (justScrolled) {return false;}
					if (ignoreClickCatchup) {return false;}
					hide_menus();
				});
			}
		}
		var options = {
	        success:       showResponse  // post-submit callback
	    };
		$(this).ajaxSubmit(options);
		return false;
	});
	/* end edit  page */
	$("#renameEntry").click(function(e){
//		clickToEdit($(this),$("#renameBlogPageForm")," Type page name then Enter",true);
		if ($(e.target)[0].tagName.toLowerCase()=="span") {
			dismissEditors();
			editMe($(this));
		}
		return false;
	});
	/*
	$("#renameBlogPageForm").submit(function(){
		working();
		function showResponse (responseText, statusText) {
if (responseText =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			if (responseText=="exists") {
				error(LangVars.Page_Name_Exists);
			} else {
				newTitles = responseText.split("|!|!******");
				$("#viewURL").attr("href","/"+newTitles[1]+"/");
				$("#renameEntry span").html(newTitles[0]);
				$("#renameEntry").attr("title",newTitles[2]);
				$("#renameEntry").css("width","auto");
				var width = $("#renameEntry span").width()+10;
				width  = width;
				$("#renameEntry").css("width",width+"px");
				$(".menuForm").hide();
				$(".menuFormLink").show();
				$(".editPageMenu").hide();
				$("#blogEntries").load("blogActions.php?blogAction=showEntries&to_prevent_cache="+(new Date).getTime(),function(){
					assignBlogEntries();
					saved("Page renamed");
				});
			}
		}
		var options = {
	        success:       showResponse  // post-submit callback
	    };
		$(this).ajaxSubmit(options);
		return false;
	});*/
	var width1 = $("span",$("#renameEntry")).width()+10;
//	$("#renameEntry").css("width",width1+"px");
	var width2 = $("span",$("#renamePage")).width()+10;
//	$("#renamePage").css("width",width2+"px");

	var width4 = $("span",$("#renameSnippet")).width()+10;
//	$("#renameSnippet").css("width",width4+"px");

	var width3 = $("span",$("#siteWideTitle")).width()+10;
//	$("#siteWideTitle").css("width",width3+"px");
//	$("#siteWideTitle").click(function(){return false;});
	/* forms module */

	function assign_forms () {



		$(".fieldRequired").unbind();
		$(".fieldRequired").click(function(){

			if ($(this).hasClass("choice_selected")) {
				required = "no";
			} else {
				required = "yes";
			}
			obj = $(this);
			options_start(obj);
			showId = $(this).attr("id");
			$.ajax({
			  type: "POST",
			  url: "formsActions.php",
			  data: "formsAction=editInput&inputsId="+$(this).attr('href')+"&required="+required,
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				option_end(obj);
				$("#formsWrapper").load("formsActions.php?formsAction=show&showForm="+showId+"&to_prevent_cache="+(new Date).getTime(),function(){
					assign_forms();
				});
			  }
			});
			return false;
		});


		//


		//

	}



	/** blog page **/




	checkStatus();


	$("#toggleChangeEmailMe").click(function(){
		clickToAddNew($(this).parents("#sendToMe"),$("#changeEmailMeForm")," Enter a subject, then hit enter",true);

		/*
		$(document).unbind("keypress");
		$("#changeEmailMeForm").show();
		$(this).parents("#sendToMe").hide();
		$(".focus","#changeEmailMeForm").val(" Enter your email address, then hit enter");
		$(".focus","#changeEmailMeForm").addClass("greyedOut");
		$(".focus","#changeEmailMeForm").each(function(){
			this.setSelectionRange(1,0);
		});
		$(".focus","#changeEmailMeForm").focus();
		$(".focus","#changeEmailMeForm").keypress(function(){
			$(this).val("");
			$(this).removeClass("greyedOut");
			$(this).unbind();
		});*/
	});
	$("#changeEmailMeForm").submit(function(){
		working();
		function showResponse (responseText, statusText) {
if (responseText =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			if (responseText=="error") {
				error(LangVars.Misc_Error);
			} else {
				saved("Changed my email address");
				assignSaveListener();
				$("#emailMe").html(responseText);
				$("#changeEmailMeForm").hide();
				$("#sendToMe").show();
			}
		}
		var options = {
			success:       showResponse  // post-submit callback
		};
		$('#changeEmailMeForm').ajaxSubmit(options);
		return false;
	});
	$("#editNewsletterSubject").unbind("click");
	$("#editNewsletterSubject").click(function(){
		clickToAddNew($(this),$("#changeSubjectForm")," Enter a subject, then hit enter",true);
	});
	$("#changeSubjectForm").unbind("submit");
	$("#changeSubjectForm").submit(function(){
		working();
		function showResponse (responseText, statusText) {
if (responseText =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			if (responseText=="error") {
				error(LangVars.Misc_Error);
			} else {
				saved("Subject changed");
				$("#changeSubjectForm").hide();
				$("#editNewsletterSubject").show();
				$("#newsletterSubject").load("newsletterActions.php?newsletterAction=showSubject",function(){});
				assignSaveListener();
				checkStatus();
			}
		}
		var options = {
			success:       showResponse  // post-submit callback
		};
		$('#changeSubjectForm').ajaxSubmit(options);
		return false;
	});
	$("#sendToMe").click(function(e){

		if ($(e.target).parent().attr("id")!="toggleChangeEmailMe") {
			if (!$(this).hasClass("greyedOut")) {
				working();
				var page = $("#newsletterContentPageVal").val();
						$.ajax({
						  type: "POST",
						  url: "newsletterActions.php?newsletterAction=send&test=yes&page="+page,
						  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
							msg = msg.split("||");
							if (msg[0]!="ok") {
								error(msg[1]);
							} else {
								saved(msg[1]);
							}
						  }
						});


			}
		}


		return false;
	});




	livechat_init();



	function onlineFail() {
		$.ajax({
			type: "GET",
			url: "../livechat/actions/stillonline.php?to_prevent_cache="+(new Date).getTime(),
			success: function(msg) {
			}
		});
	}
	if ($("#livechatStatus").length && $("#livechatStatus").hasClass("bpe_current")) {
		poller = setInterval(onlineFail, 30000);
		onlineFail();
	}

	// start security
	function assignAccessGroups () {
		$(".confirmDeleteAccessGroup").click(function(){
			var id = $(this).attr("id");
			working();
			$.ajax({
			  type: "POST",
			  url: "accessGroupActions.php",
			  data: "accessGroupActions=delete&id="+id,
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if (msg == "ok") {
					$("#groupList").load("accessGroupActions.php?accessGroupActions=showAccessGroups",function(){
						assignAccessGroups();
						$("#adminPages").load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){
							assignPages();
							assign_page_filter();
							saved("Access group removed");

						});
					});
				} else {
					error(LangVars.Misc_Error);
				}
			  }
			});
		});
		//assign_menus($("#groupList"));
		return false;
	};


	//end security
	//start admin users

	function keepalive () {
		if (keepaliveok==true) {
			$.ajax({
		  		type: "POST",
		  		url: "loginCheck.php",
		  		data: "keepalive=yes",
		  		success: function(msg){
					if (msg =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				}
		  	});
		}
		setTimeout(keepalive, 50000);
	}
	//setTimeout(keepalive, 25000);

	$.ajax({
  		type: "POST",
  		url: "showStats.php?d="+(new Date).getTime(),
  		success: function(msg){
			if (msg !="" && msg !=0) {
				$("#statsWrapper").html(msg);

			}
		}
  	});
	// automatic binding/rebinding of ajax forms and lists


//	rebindSearchList();


	$(".toggleForm").unbind("click").click(function(){ // sho add new item form
		clickToAddNew($(this),$("#"+$(this).attr("id")+"Form")," Type a new name then enter",false);
		return false;
	});
	$(".toggleFormHideSelf").unbind("click").click(function(){ // sho add new item form
		clickToAddNew($(this),$("#"+$(this).attr("id")+"Form")," Type a new name then enter",true);
		return false;
	});
	$(".ajaxSubmit").unbind("submit").submit(function(){ // submit add new item form
		sendForm($(this),$(this).next());
		return false;
	});
	$(".ajaxSubmitV2").unbind("submit").submit(function(){ // submit add new item form
		sendForm($(this),$("#"+$("input[name=target]",$(this)).val()));
		return false;
	});
	$(".ajaxHref").unbind("click").click(function(){
		working();
		var el = $(this);
		var string = $(this).attr("href").split("?");
		var target=$(this).attr("target");
		$.ajax({
	  		type: "POST",
	  		url: string[0],
	  		data: string[1],
	  		success: function(msg){
				if (msg =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					if (el.hasClass("toggleTick")) {
						if (msg=="ticked") {
							el.addClass("bpe_current");
						} else {
							el.removeClass("bpe_current");
						}
						saved();
					}
					if (target=="snippetsWrapper") {
						$("#snippetsWrapper,#insertComponentMenuSnippets").html(msg);
						rebindSearchList($("#insertComponentMenuSnippets"));
						assignSnippets();
						saved();
					}

			}
	  	});
		return false;
	});

	$(".toggleLink").unbind("click").click(function(){
		$t = $(this);
		$.ajax({
	  		type: "POST",
	  		url: $t.attr("href"),
	  		success: function(msg){
				if (msg =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if (msg==0) {
					$t.removeClass("bpe_current");
				}
				if (msg==1) {
					$t.addClass("bpe_current");
				}
			}
	  	});
		return false;
	});
	//rebind($("#emailGroupsList")); // set initial binds

	//
});
var keepaliveok=true;
	function sendForm (form,toUpdate) {
		working();
		function showResponse (responseText, statusText) {
if (responseText =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			if (responseText=="Exists") {
				error(LangVars.Misc_Error);
			} else {
				toUpdate.html(responseText);
				if (form.hasClass("refreshPage")) {
				window.location.reload();
				}
				rebind(toUpdate);

				if (toUpdate.attr("id")=="snippetsWrapper") {
					$("#insertComponentMenuSnippets").html(responseText);
					rebindSearchList($("#insertComponentMenuSnippets"));
					assignSnippets();
				}
				form.hide();
				saved();
			}

		}
		var options = {
	        success:       showResponse  // post-submit callback
	    };
		form.ajaxSubmit(options);
	}
function assignOptions() {
	$(".changeOptionOr").unbind("click").click(function(){
		working();
		var el = $(this);
		var string = $(this).attr("href").split("?");
		$.ajax({
	  		type: "POST",
	  		url: string[0],
	  		data: string[1],
	  		success: function(msg){
				if (msg =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if (msg=="ok") {
					$(".choice_selected",el.parent()).removeClass("choice_selected");
					el.addClass("choice_selected");
					saved();
				} else {
					error(LangVars.Misc_Error);
				}

			}
	  	});
		return false;
	});
}

function assignSnippets () {
	$("#snippetsWrapper .snippetItem").each(function(){
		if ($(".ComponentSnippet-"+$(this).attr("alt")).length)  {
			$(".removeItem",$(this)).addClass("refreshPage");
		}
	});
	rebind($("#snippetsWrapper"));
	$("#snippetsWrapper .menu_with_options.snippetItem").click(function(e){
		if ($(e.target).hasClass("snippetItem")||$(e.target).hasClass("titleHover")||$(e.target).hasClass("titleNotHover")) {
		window.location="/admin/editSnippet.php?id="+$(this).attr("id");
		}

	});

}
function rebindSearchList (obj,p1,p2,p3) {

	lightPagesHeight();

	//popdownPaginate(p1,p2,p3);
	/*$(".searchList",obj).unbind("focus");
	$(".searchList",obj).focus(function(){
		if ($(this).val()==LangVars.Search) {
			$(this).val("");
		}
		$(document).unbind("keyup");
		$(document).unbind("keydown");
	});
	$(".searchList",obj).unbind("blur");
	$(".searchList",obj).blur(function(){
		if ($(this).val()=="") {
			$(this).val(LangVars.Search);
		}
	});*/
	$(".clearSearch",obj).unbind("click").click(function(){
		working();
		var url = $(this).attr("href").split("?");
		var target=$("input.searchList",$(this).parents("form")).attr("target");
		$.ajax({
		  type: "POST",
		  url: url[0],
		  data: url[1],
		  success: function(msg){
			if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if (target=="snippetsWrapper") {
					$("#snippetsWrapper,#insertComponentMenuSnippets").html(msg);
					rebindSearchList($("#insertComponentMenuSnippets"),p1,p2,p3);
					assignSnippets();
					saved();
				}
				if (target=="downloads") {
					$("#downloads,#downloadsPopdownInner").html(msg);
					assignHeaderMenus();
					rebindSearchList($("#downloadsPopdownInner"),p1,p2,p3);
					window.dropzoneFilePopdown.disable();
					window.dropzoneFilePopdown = new Dropzone("#downloadsPopdownInner",uploadFilePaneDZOptions($("#downloadsPopdownInner .uploadFile")[0]));
					$("#downloadsPopdownInner .pagesScroll").lovelyScroll(pagesScrollBottomDownloads);
					saved();
				}

		  	}
		});
		return false;
	});
	$(".filterBox",obj).unbind("submit").submit(function(){
		working();
		var url = $("input.searchList",$(this)).attr("alt").split("?");
		var target=$("input.searchList",$(this)).attr("target");
		var string  = $("input.searchList",$(this)).val();
		$.ajax({
		  type: "POST",
		  url: url[0],
		  data: url[1]+string,
		  success: function(msg){
			if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if (target=="snippetsWrapper") {
					$("#snippetsWrapper,#insertComponentMenuSnippets").html(msg);
					rebindSearchList($("#insertComponentMenuSnippets"),p1,p2,p3);
					assignSnippets();
					saved();
				}
				if (target=="downloads") {
					$("#downloads,#downloadsPopdownInner").html(msg);
					assignHeaderMenus();
					rebindSearchList($("#downloadsPopdownInner"),p1,p2,p3);
					window.dropzoneFilePopdown.disable();
					window.dropzoneFilePopdown = new Dropzone("#downloadsPopdownInner",uploadFilePaneDZOptions($("#downloadsPopdownInner .uploadFile")[0]));
					$("#downloadsPopdownInner .pagesScroll").lovelyScroll(pagesScrollBottomDownloads);
					saved();
				}

		  	}
		});
		return false;
	});
/*
	$(".ajaxHref",obj).unbind("click").click(function(){
		working();
		var el = $(this);
		var string = $(this).attr("href").split("?");
		var target=$(this).attr("target");
		$.ajax({
	  		type: "POST",
	  		url: string[0],
	  		data: string[1],
	  		success: function(msg){
				if (msg =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					if (el.hasClass("toggleTick")) {
						if (msg=="ticked") {
							el.addClass("bpe_current");
						} else {
							el.removeClass("bpe_current");
						}
						saved();
					}
					if (target=="snippetsWrapper") {
						$("#snippetsWrapper,#insertComponentMenuSnippets").html(msg);
						rebindSearchList($("#insertComponentMenuSnippets"),p1,p2,p3);
						assignSnippets();
						saved();
					}
					if (target=="downloads") {

						$("#downloads,#downloadsPopdownInner").html(msg);
						assignHeaderMenus();
						rebindSearchList($("#downloadsPopdownInner"),p1,p2,p3);
						$("#downloadsPopdownInner .pagesScroll").lovelyScroll(pagesScrollBottomDownloadsFiles);
						saved();
					}

			}
	  	});
		return false;
	});*/

}
function rebind (obj) {
	$(".renameItem",obj).unbind("click").click(function(){ // show rename item form
		clickToEdit($(this),$(this).parent().next()," Type author name, then hit enter",true);
		return false;
	});
	$(".renameForm",obj).unbind("submit").submit(function(){ // submit rename item form
		sendForm($(this),$(this).parents(".listToUpdate"));
		return false;
	});
	rebindSearchList(obj);
	$(".removeItem",obj).unbind("click").click(function(){
		var string = $(this).attr("href").split("?");
		toUpdate = $(this).parents(".listToUpdate");
		var el = $(this);
		working();
		$.ajax({
	  		type: "POST",
	  		url: string[0],
	  		data: string[1],
	  		success: function(msg){
				if (msg =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				toUpdate.html(msg);
				rebind(toUpdate);

				if (toUpdate.attr("id")=="snippetsWrapper") {
					$("#insertComponentMenuSnippets").html(msg);
					rebindSearchList($("#insertComponentMenuSnippets"));
					assignSnippets();
				}
				if (el.hasClass("refreshPage")) {
				window.location.reload();
				}
				saved();
			}
	  	});
	});
	$(".duplicateItem",obj).unbind("click").click(function(){
		var string = $(this).attr("href").split("?");
		toUpdate = $(this).parents(".listToUpdate");
		working();
		$.ajax({
	  		type: "POST",
	  		url: string[0],
	  		data: string[1],
	  		success: function(msg){
				if (msg =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				toUpdate.html(msg);
				rebind(toUpdate);

				if (toUpdate.attr("id")=="snippetsWrapper") {
					$("#insertComponentMenuSnippets").html(msg);
					rebindSearchList($("#insertComponentMenuSnippets"));
					assignSnippets();
				}

				saved();
			}
	  	});
	});
	$(".ajaxHref",obj).unbind("click").click(function(){
		working();
		var el = $(this);
		var string = $(this).attr("href").split("?");
		var target=$(this).attr("target");
		$.ajax({
	  		type: "POST",
	  		url: string[0],
	  		data: string[1],
	  		success: function(msg){
				if (msg =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					if (el.hasClass("toggleTick")) {
						if (msg=="ticked") {
							el.addClass("bpe_current");
						} else {
							el.removeClass("bpe_current");
						}
						saved();
					}
					if (target=="snippetsWrapper") {
						$("#snippetsWrapper,#insertComponentMenuSnippets").html(msg);
						rebindSearchList($("#insertComponentMenuSnippets"));
						assignSnippets();
						saved();
					}

			}
	  	});
		return false;
	});
	//assign_menus(obj);

	if (obj.attr("id")=="emailGroupsList") {
		$("#newsletter").load("newsletterActions.php?newsletterAction=showEmails&to_prevent_cache="+(new Date).getTime(),function(){
			assignNewsletter();
		});
		var sendToListList = "";
		var componentList = "";
		$("#emailGroupsList .renameItem").each(function(){
			sendToListList += "<a href='' id='"+$(this).attr("id")+"' class='sendToGroupList'>Yes, send to everyone in "+$(this).html()+" group</a>";
			componentList += "<a href='"+$(this).attr("id")+"' class='insertNewsletter dropship_component_item'>"+$(this).html()+" group</a>";
		});
		$("#sentToGroupList").html(sendToListList);
		$(".addNewsletterGroupList").html(componentList);
	}
}
function assignNewsletter () {

	$(".pagesTable tr:even").addClass("alt");
	$(".pagesTable tr").each(function(){
		$("td:odd",this).addClass("alt");
		$("th:odd",this).addClass("alt");
	});
	$("input[type='checkbox']","#newsletter").each(function(){
		if ($(this).is(":checked")) {
			this.checked = true;
		} else {
			this.checked = false;
		}
	});
	$("#toggleAddRecipient").unbind("click");
	$("#toggleAddRecipient").click(function(){
		clickToAddNew($(this),$("#addRecipient")," Enter name, a space, then email address, then hit enter",false);
	});
	$("#addRecipient").unbind("submit");
	$("#addRecipient").submit(function(){
		working();
		function showResponse (responseText, statusText) {
if (responseText =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			if (responseText=="error") {
				error(LangVars.Misc_Error);
			} else {


				$("#newsletter").load("newsletterActions.php?newsletterAction=showEmails&to_prevent_cache="+(new Date).getTime(),function(){
					assignNewsletter();
					assignSaveListener();
					saved("Recipient Added");
					$("#addRecipient").hide();
				});
			}

		}
		var options = {
			success:       showResponse  // post-submit callback
		};
		$('#addRecipient').ajaxSubmit(options);
		return false;
	});
	$(".toggleRenameRecipient").unbind("click");
	$(".toggleRenameRecipient").click(function(){
		clickToEdit($(this),$("#"+$(this).attr("id")+"form")," Type new name, then hit enter",false);
	});
	$(".changeRecipientName").unbind("submit");
	$(".changeRecipientName").submit(function(){
		working();
		function showResponse (responseText, statusText) {
if (responseText =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

			if (responseText=="error") {
				error(LangVars.Misc_Error);
			} else {


				$("#newsletter").load("newsletterActions.php?newsletterAction=showEmails&to_prevent_cache="+(new Date).getTime(),function(){
					assignNewsletter();
					assignSaveListener();
					saved("Recipient Renamed");

				});
			}

		}
		var options = {
			success:       showResponse  // post-submit callback
		};
		$(this).ajaxSubmit(options);
		return false;
	});
	//
	$(".toggleRecipientEmail").unbind("click");
	$(".toggleRecipientEmail").click(function(){
		clickToEdit($(this),$("#"+$(this).attr("id")+"form")," Type new email, then hit enter",false);
	});
	$(".changeRecipientEmail").unbind("submit");
	$(".changeRecipientEmail").submit(function(){
		working();
		function showResponse (responseText, statusText) {
if (responseText =="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

			if (responseText=="error") {
				error(LangVars.Misc_Error);
			} else {


				$("#newsletter").load("newsletterActions.php?newsletterAction=showEmails&to_prevent_cache="+(new Date).getTime(),function(){
					assignNewsletter();
					assignSaveListener();
					saved("Recipient changed");

				});
			}

		}
		var options = {
			success:       showResponse  // post-submit callback
		};
		$(this).ajaxSubmit(options);
		return false;
	});//
	$(".confirmDeleteRecipient").click(function(){
		var id = $(this).attr("id");
		$.ajax({
		  type: "POST",
		  url: "newsletterActions.php",
		  data: "newsletterAction=removeEmail&id="+id,
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					$("#newsletter").load("newsletterActions.php?newsletterAction=showEmails&to_prevent_cache="+(new Date).getTime(),function(){
					assignNewsletter();

					saved("Recipient removed");

				});
		  }
		});
	});
	$(".deleteRecipient").click(function(){
		working();
		var answer = confirm("Are you sure you want to remove this email address?");
		if (answer){
			data = $(this).attr('id').split("||");
			$.ajax({
			  type: "POST",
			  url: "/newsletter_remove.php",
			  data: "id="+data[0]+"&email="+data[1],
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#newsletter").load("newsletterActions.php?newsletterAction=showEmails&to_prevent_cache="+(new Date).getTime(),function(){
					assignNewsletter();
				});
				saved("Recipient removed");
			  }
			});

		} else {
			error(LangVars.Misc_Error);
		}

		return false;
	});
	$(".toggleEmailActive a").click(function(){
		working();
		var bits = $(this).attr("href").split("|");
		var inactive = bits[0];
		var id = bits[1];
		if (inactive=="yes") {
			var verb = "Active";
		} else {
			var verb = "Inactive";
		}
		$.ajax({
		  type: "POST",
		  url: "newsletterActions.php",
		  data: "newsletterAction=changeActive&action=toggleActive&inactive="+inactive+"&id="+id,
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			$("#newsletter").load("newsletterActions.php?newsletterAction=showEmails&to_prevent_cache="+(new Date).getTime(),function(){
				assignNewsletter();
			});
			saved("Recipient is now "+verb);
		  }
		});
		return false;
	});
	$(".makeEmailInactive").click(function(){
		working();
		id = $(this).attr('id');

		if ($(this).is(':checked')) {
				$.ajax({
				  type: "POST",
				  url: "newsletterActions.php",
				  data: "newsletterAction=changeActive&action=makeActive&id="+id,
				  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					$("#newsletter").load("newsletterActions.php?newsletterAction=showEmails&to_prevent_cache="+(new Date).getTime(),function(){
						assignNewsletter();
					});
					saved("Recipient is now active");
				  }
				});
		} else {
				$.ajax({
				  type: "POST",
				  url: "newsletterActions.php",
				  data: "newsletterAction=changeActive&action=makeInactive&id="+id,
				  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					$("#newsletter").load("newsletterActions.php?newsletterAction=showEmails&to_prevent_cache="+(new Date).getTime(),function(){
						assignNewsletter();
					});
					saved("Recipient is now innactive");
				  }
				});

		}
	});
	$("#makeAllActive").click(function(){
		working();
			$.ajax({
			  type: "POST",
			  url: "newsletterActions.php",
			  data: "newsletterAction=changeActive&action=makeAllActive",
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#newsletter").load("newsletterActions.php?newsletterAction=showEmails&to_prevent_cache="+(new Date).getTime(),function(){
					assignNewsletter();
					saved("All users made active");
				});
			  }
			});


		return false;
	});
	$("#makeAllInactive").click(function(){
		working();
		$.ajax({
		  type: "POST",
		  url: "newsletterActions.php",
		  data: "newsletterAction=changeActive&action=makeAllInactive",
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#newsletter").load("newsletterActions.php?newsletterAction=showEmails&to_prevent_cache="+(new Date).getTime(),function(){
					assignNewsletter();
					saved("All users made inactive");
				});
		  }
		});
		return false;
	});
	$("#newsletterPage").change(function(){
		working();
		id = $(this).val();
		$.ajax({
		  type: "POST",
		  url: "pageActions.php",
		  data: "pageAction=change&action=newsletter&id="+id,
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			saved("Newsletter page changed");
		  }
		});
	});
	//assign_menus($("#newsletter"));
	$("#newsletter .pageFilterSearch").keyup(function(e){
		if (e.which==13) {
			working();
			var string = $(this).val();
			$.ajax({
			  type: "POST",
			  url: "newsletterActions.php",
			  data: "newsletterAction=filterSearch&string="+string,
			  success: function(msg){
				if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

				$("#newsletter").load("newsletterActions.php?newsletterAction=showEmails&to_prevent_cache="+(new Date).getTime(),function(){
					assignNewsletter();
					saved();
				});
			  }
			});
		}
	});
	$("#newsletter .clearSearch").click(function(){
		working();
		$.ajax({
		  type: "POST",
		  url: "newsletterActions.php",
		  data: "newsletterAction=filterSearch&string=",
		  success: function(msg){
			if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

				$("#newsletter").load("newsletterActions.php?newsletterAction=showEmails&to_prevent_cache="+(new Date).getTime(),function(){
					assignNewsletter();
					saved();
				});
		  }
		});
	});
	$("#newsletter .pageFilterSearch").focus(function(){
		miniSearchStart($(this).parents(".topBar"));
		if ($(this).val()=="Search") {
			$(this).val("");
		}
		return false;
	});
	$("#newsletter .pageFilterSearch").blur(function(){
		miniSearchStop($(this).parents(".topBar"));
		if ($(this).val()=="") {
			$(this).val("Search");
		}
	});
	$("#newsletter .filterPage").click(function(){
		working();
		var page = $(this).attr("href");
		$.ajax({
		  type: "POST",
		  url: "newsletterActions.php",
		  data: "newsletterAction=changeView&showPage="+page,
		  success: function(msg){
			if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			$("#newsletter").load("newsletterActions.php?newsletterAction=showEmails&to_prevent_cache="+(new Date).getTime(),function(){
				assignNewsletter();
				saved();
			});
		  }
		});
		return false;
	});
	$("#newsletter .filterGroup").click(function(){
		working();
		var string = $(this).attr("href").split("?");
		$.ajax({
		  type: "POST",
		  url: string[0],
		  data: string[1],
		  success: function(msg){
			if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			$("#newsletter").load("newsletterActions.php?newsletterAction=showEmails&to_prevent_cache="+(new Date).getTime(),function(){
				assignNewsletter();
				saved();
			});
		  }
		});
		return false;
	});
	$(".sendToGroupList").unbind().click(function(){
		if (!$(this).parents("#sendToList").hasClass("greyedOut")) {
			working();
			var page = $("#newsletterContentPageVal").val();
			var group = $(this).attr("id");
			$.ajax({
			  type: "POST",
			  url: "newsletterActions.php?newsletterAction=send&v=2&group="+group+"&page="+page,
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				msg = msg.split("||");
				if (msg[0]!="ok") {
					error(msg[1]);

				} else {
					saved(msg[1]);
					$("#sendListResult").html(msg[1]);
				}
				$(".bpe_menu_sub_items2").hide();
				$(".bpe_menu_sub_items2").prev().removeClass("bpe_sub_hilite2");
				$("#newsletter").load("newsletterActions.php?newsletterAction=showEmails&to_prevent_cache="+(new Date).getTime(),function(){
					assignNewsletter();
				});
			  }
			});
		}


		return false;
	});
	assignOptions();
}

function buildThemeVars () {
	var json_str = "{";
	$("#themeOptions .settingsDropdown").each(function(){
		if (json_str!="{") {
			json_str += ',';
		}
		json_str += '"'+$("select",$(this)).attr("name")+'": "'+$("select",$(this)).val()+'"';
	});
	$("#themeOptions .settingsDropdownImagePreviews").each(function(){
		if (json_str!="{") {
			json_str += ',';
		}
		json_str += '"'+$(this).attr("var-name")+'": "'+$(this).attr("var-value")+'"';
	});
	$("#themeOptions .themeOptionText").each(function(){
		if (json_str!="{") {
				json_str += ',';
			}
		if ($(this).attr("theme-var-value")!="") {
			var textarray = $(this).attr("theme-var-value").replace(/\\/g, "\\\\").replace(/(["])/g, "\\$1").replace(/\t/g, "\\t").split(/\n/);

			var textarraystring = "[";
			for (var i = 0; i < textarray.length; i++) {
				if (textarraystring!="[") {
					textarraystring +=",";
				}
				textarraystring += '"'+textarray[i]+'"';
			}
			textarraystring +="]";
			json_str += '"'+$(this).attr("theme-var-name")+'": '+textarraystring;
		} else {
			json_str += '"'+$(this).attr("theme-var-name")+'": ""';
		}
	});
	$("#themeOptions .themeOptionToggle").each(function(){
		if (json_str!="{") {
				json_str += ',';
			}
		if ($(this).hasClass("bpe_current")) {
			json_str += '"'+$(this).attr("rel")+'": "1"';
		} else {
			json_str += '"'+$(this).attr("rel")+'": "0"';
		}
	});
	$("#themeOptions .themeOptionImage").each(function(){
		if (json_str!="{") {
				json_str += ',';
			}
		if ($(this).attr("value")!="") {

			json_str += '"'+$(this).attr("rel")+'": "'+$(this).attr("value").replace(/\\/g, "\\\\").replace(/(["])/g, "\\$1")+'"';
			$(".removeThemeImage",$(this)).show();
		} else {
			json_str += '"'+$(this).attr("rel")+'": ""';
			$(".removeThemeImage",$(this)).hide();
		}
	});
	json_str += "}";
	$.ajax({
	  type: "POST",
	  url: "settingsActions.php",
	  data: "settingsAction=changeThemeVars&theme_vars="+encodeURIComponent(json_str),
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		if (msg=="ok") {
			saved();
		} else {
			error(LangVars.Misc_Error);
		}
	  }
	});
}

function randomString() {
	var chars = "ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";
	var string_length = 5;
	var randomstring = '';
	for (var i=0; i<string_length; i++) {
		var rnum = Math.floor(Math.random() * chars.length);
		randomstring += chars.substring(rnum,rnum+1);
	}
	document.randform.randomfield.value = randomstring;
}
/*
function insert_link (e,href,target) {
	e.each(function(){
		e = this;
	});
	var indexOfStartSpace = e.value.substr(0, e.selectionStart).lastIndexOf(" ");
	if(indexOfStartSpace==-1) {
		var selectedEnd=1;
		var firstspace="";
	} else {
		var firstspace=" ";
		var selectedEnd=0;
	}
	var firstPart = e.value.substr(indexOfStartSpace+1, e.selectionStart-indexOfStartSpace);
	
	var indexOfEndSpace = e.value.substr(e.selectionEnd, e.value.length-e.selectionEnd).indexOf(" ");
	if(indexOfEndSpace==-1) {
		var indexOfEndSpace=e.value.length;
	}
	var lastPart = e.value.substr(e.selectionEnd+1, indexOfEndSpace-1);
	
	var lengthOfLastPart = lastPart.length;
	if (lastPart.charAt(lengthOfLastPart-1) == "]") {
		var lastPart = lastPart.substr(0,lengthOfLastPart-1);
		var range = firstPart+lastPart;
		var replacement = "]";
	} else {
		var range = firstPart+lastPart;
		var replacement = "";
	}
	
	if (!range.match(/\[bold|\[italic|\[strikethrough|\[underline|\[superscript|\[subscript|\[link/)) {
		var escape = range.replace(/\]/,"\\]");					
	} else {
		var escape = range;
	}

	var added = firstspace+"[link"+target+": "+href+" text: "+escape+"]";
	var textLength = escape.length;
	var newLength = added.length;
	var preLength = firstspace+"[link"+target+": "+href+" text: ";
	var preLength = preLength.length;
	e.value = e.value.substr(0, indexOfStartSpace) + added + replacement + e.value.substr(e.selectionEnd+1+lengthOfLastPart);
	e.setSelectionRange(indexOfStartSpace+preLength+selectedEnd,indexOfStartSpace+preLength+textLength+selectedEnd);
	e.focus();
}*/

function htmlentities( string ){
    // http://kevin.vanzonneveld.net
    // +   original by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
    // +    revised by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
    // +   improved by: nobbler
    // +    tweaked by: Jack
    // %          note: table from http://www.the-art-of-web.com/html/character-codes/
    // *     example 1: htmlentities('Kevin & van Zonneveld');
    // *     returns 1: 'Kevin &amp; van Zonneveld'
    
    var histogram = {}, code = 0, tmp_arr = [], i = 0;
    var stringl = 0;
    
    histogram['34'] = 'quot';
    histogram['38'] = 'amp';
    histogram['60'] = 'lt';
    histogram['62'] = 'gt';
    histogram['160'] = 'nbsp';
    histogram['161'] = 'iexcl';
    histogram['162'] = 'cent';
    histogram['163'] = 'pound';
    histogram['164'] = 'curren';
    histogram['165'] = 'yen';
    histogram['166'] = 'brvbar';
    histogram['167'] = 'sect';
    histogram['168'] = 'uml';
    histogram['169'] = 'copy';
    histogram['170'] = 'ordf';
    histogram['171'] = 'laquo';
    histogram['172'] = 'not';
    histogram['173'] = 'shy';
    histogram['174'] = 'reg';
    histogram['175'] = 'macr';
    histogram['176'] = 'deg';
    histogram['177'] = 'plusmn';
    histogram['178'] = 'sup2';
    histogram['179'] = 'sup3';
    histogram['180'] = 'acute';
    histogram['181'] = 'micro';
    histogram['182'] = 'para';
    histogram['183'] = 'middot';
    histogram['184'] = 'cedil';
    histogram['185'] = 'sup1';
    histogram['186'] = 'ordm';
    histogram['187'] = 'raquo';
    histogram['188'] = 'frac14';
    histogram['189'] = 'frac12';
    histogram['190'] = 'frac34';
    histogram['191'] = 'iquest';
    histogram['192'] = 'Agrave';
    histogram['193'] = 'Aacute';
    histogram['194'] = 'Acirc';
    histogram['195'] = 'Atilde';
    histogram['196'] = 'Auml';
    histogram['197'] = 'Aring';
    histogram['198'] = 'AElig';
    histogram['199'] = 'Ccedil';
    histogram['200'] = 'Egrave';
    histogram['201'] = 'Eacute';
    histogram['202'] = 'Ecirc';
    histogram['203'] = 'Euml';
    histogram['204'] = 'Igrave';
    histogram['205'] = 'Iacute';
    histogram['206'] = 'Icirc';
    histogram['207'] = 'Iuml';
    histogram['208'] = 'ETH';
    histogram['209'] = 'Ntilde';
    histogram['210'] = 'Ograve';
    histogram['211'] = 'Oacute';
    histogram['212'] = 'Ocirc';
    histogram['213'] = 'Otilde';
    histogram['214'] = 'Ouml';
    histogram['215'] = 'times';
    histogram['216'] = 'Oslash';
    histogram['217'] = 'Ugrave';
    histogram['218'] = 'Uacute';
    histogram['219'] = 'Ucirc';
    histogram['220'] = 'Uuml';
    histogram['221'] = 'Yacute';
    histogram['222'] = 'THORN';
    histogram['223'] = 'szlig';
    histogram['224'] = 'agrave';
    histogram['225'] = 'aacute';
    histogram['226'] = 'acirc';
    histogram['227'] = 'atilde';
    histogram['228'] = 'auml';
    histogram['229'] = 'aring';
    histogram['230'] = 'aelig';
    histogram['231'] = 'ccedil';
    histogram['232'] = 'egrave';
    histogram['233'] = 'eacute';
    histogram['234'] = 'ecirc';
    histogram['235'] = 'euml';
    histogram['236'] = 'igrave';
    histogram['237'] = 'iacute';
    histogram['238'] = 'icirc';
    histogram['239'] = 'iuml';
    histogram['240'] = 'eth';
    histogram['241'] = 'ntilde';
    histogram['242'] = 'ograve';
    histogram['243'] = 'oacute';
    histogram['244'] = 'ocirc';
    histogram['245'] = 'otilde';
    histogram['246'] = 'ouml';
    histogram['247'] = 'divide';
    histogram['248'] = 'oslash';
    histogram['249'] = 'ugrave';
    histogram['250'] = 'uacute';
    histogram['251'] = 'ucirc';
    histogram['252'] = 'uuml';
    histogram['253'] = 'yacute';
    histogram['254'] = 'thorn';
    histogram['255'] = 'yuml';
    
    stringl = string.length
    for (i = 0; i < stringl; ++i) {
        code = string.charCodeAt(i);
        if (code in histogram) {
            tmp_arr[i] = '&'+histogram[code]+';';
        } else {
            tmp_arr[i] = string.charAt(i);
        }
    }
    
    return tmp_arr.join('');
}
function bpe_remove_formatting (type,string) {
	if (type=="bold") {
		return string.replace(/\*\*(.*?)\*\*/g,"$1");
	}
	if (type=="italic") {
		return string.replace(/\/\/(.*?)\/\//g,"$1");
	}
	if (type=="underline") {
		return string.replace(/__(.*?)__/g,"$1");
	}
	if (type=="strikethrough") {
		return string.replace(/\-\-(.*?)\-\-/g,"$1");
	}
	if (type=="superscript") {
		return string.replace(/\[superscript\: ([^\[]*?)([^\\])\]/g,"$1$2");
	}
	if (type=="subscript") {
		return string.replace(/\[subscript\: ([^\[]*?)([^\\])\]/g,"$1$2");
	}
}
function checkBPESelection (sel) {
	contains = new Array();
	i = 0;

	if ( sel.match( /\*\*(.*?)\*\*/g ) ) {
		contains[i] = "bold";
		i++;
	}

	if ( sel.match( /\/\/(.*?)\/\//g ) ) {
		contains[i] = "ital";
		i++;
	}

	if ( sel.match( /\__(.*?)__/g ) ) {
		contains[i] = "underline";
		i++;
	}

	if ( sel.match( /\-\-(.*?)\-\-/g ) ) {
		contains[i] = "strike";
		i++;
	}
	
	if ( sel.match( /\[superscript\: ([^\[]*?)([^\\])\]/g ) ) {
		contains[i] = "sup";
		i++;
	}
	
	if ( sel.match( /\[subscript\: ([^\[]*?)([^\\])\]/g ) ) {
		contains[i] = "sub";
		i++;
	}

	

	return contains;

}
function toBPE (string) {
	reg = /<br\/>/ig;
	string = string.replace(reg,"\n");

	reg = /<br\/>/ig;
	string = string.replace(reg,"\n");
	
	reg = /<br style=""\/>/ig;
	string = string.replace(reg,"\n");
	
	reg = /<br>/ig;
	string = string.replace(reg,"\n");
	
//	reg = /\]/g;
//	string = string.replace(reg,"\\]");
	
	reg = /<\/strong>/ig;
	string = string.replace(reg,"**");
	
	reg = /<\/em>/ig;
	string = string.replace(reg,"//");
	
	reg = /<\/span>/ig;
	string = string.replace(reg,"__");
	
	reg = /<\/strike>/ig;
	string = string.replace(reg,"--");
	
	reg = /<\/sup>/ig;
	string = string.replace(reg,"]");
	
	reg = /<\/sub>/ig;
	string = string.replace(reg,"]");
	
	reg = /<strong>/ig;
	string = string.replace(reg,"**");
	
	reg = /<em>/ig;
	string = string.replace(reg,"//");
	
	reg = /<span style="text-decoration:(| )underline(|;)">/ig;
	string = string.replace(reg,"__");
	
	reg = /<strike>/ig;
	string = string.replace(reg,"--");
	
	reg = /<sup>/ig;
	string = string.replace(reg,"[superscript: ");
	
	reg = /<sub>/ig;
	string = string.replace(reg,"[subscript: ");
	
	reg = /\s\[(?!bold: \b|italic: \b|underline: \b|strikethrough: \b|superscript: \b|subscript: \b|link: \b|link+: \b)([\s\S^\]]*?)\]/ig;
	string = string.replace(reg," [$1\\]");

	reg = /<a href="([^"]*?)">([\s\S]*?)<\/a>/ig;	
	string = string.replace(reg,function(all,href,text){
		return "["+text+"]("+href.replace(/ /g,"%20")+")";
	});
	
	reg = /<a href="([^"]*?)" target="_blank">([\s\S]*?)<\/a>/ig;
	string = string.replace(reg,function(all,href,text){
		return "["+text+"]("+href.replace(/ /g,"%20")+"+)";
	});
		
	
	return string;
}
function toHTML (string) {
	
	for (var i=0; i < 8; i++) {
		reg = /\[([^\]]*?)\](|[^\S\n])\(([^\s]*)\+\)/g;
		string = string.replace(reg,"<a href=\"$3\" target=\"_blank\">$1</a>");
		
		reg = /\[([^\]]*?)\](|[^\S\n])\(([^\s]*)\)/g;
		string = string.replace(reg,"<a href=\"$3\">$1</a>");
		
		reg = /(^|[^\*])\*\*(?!\*)(.*?)\*\*/g;
		string = string.replace(reg,"$1<strong>$2</strong>");

		reg = /(^|\s)\/\/(.*?)\/\//g;
		string = string.replace(reg,"$1<em>$2</em>");

		reg = /__(.*?)__/g;
		string = string.replace(reg,"<span style=\"text-decoration: underline;\">$1</span>");

		reg = /(^|\s)\-\-(.*?)\-\-/g;
		string = string.replace(reg,"$1<strike>$2</strike>");
		
		reg = /\[superscript\: (.*?)\]/g;
		string = string.replace(reg,"<sup>$1</sup>");
		
		reg = /\[subscript\: (.*?)\]/g;
		string = string.replace(reg,"<sub>$1</sub>");
				
		
		
	};

	reg = /\[([\s\S]*?)([^\\])\](|[^\S\n])\(([^\s]*)\+\)/g;
	string = string.replace(reg,"<a href=\"$4\" target=\"_blank\">$1$2</a>");
	
	reg = /\[([\s\S]*?)([^\\])\](|[^\S\n])\(([^\s)]*)\)/g;
	string = string.replace(reg,"<a href=\"$4\">$1$2</a>");
	
	reg = /(^|[^\*])\*\*(?!\*)([\s\S]*?)([^\\])\*\*/g;
	string = string.replace(reg,"$1<strong>$2$3</strong>");

	reg = /(^|\s)\/\/([\s\S]*?)([^\\])\/\//g;
	string = string.replace(reg,"$1<em>$2$3</em>");

	reg = /__([\s\S]*?)([^\\])__/g;
	string = string.replace(reg,"<span style=\"text-decoration:underline\">$1$2</span>");

	reg = /(^|\s)\-\-([\s\S]*?)([^\\])\-\-/g;
	string = string.replace(reg,"$1<strike>$2$3</strike>");
	
	reg = /\[superscript\: ([\s\S]*?)([^\\])\]/g;
	string = string.replace(reg,"<sup>$1$2</sup>");
	
	reg = /\[subscript\: ([\s\S]*?)([^\\])\]/g;
	string = string.replace(reg,"<sub>$1$2</sub>");
	
	
	
	string = string.replace(/\\/,"");

	
	return string;
}

function hideDragInsert() {
	if (dragInsert) {
		$(".returnToLP").fadeIn();
		$("#dragInsertMask").hide();
		if ($(window).width()>1260) {
			var r = "0px";
		} else {
			var r = "-90%";
		}
		$("#dragInsert").stop(false,true).animate({right:r},300,function(){
			
			$("#dragInsert").removeClass("showing").hide();
			dragInsert=false;

		});
		/*$(document).click(function(){
			if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
			hide_menus();
			$.fn.bpeditor.assign_toggler();
			assignSaveListener();
			
		});*/
	}
}
function hide_menus () {
	
	hideToolTips(true);

	$("iframe").blur();
	$("textarea:focus").blur();	
	if ($(".dateFilterCalendar:visible").length) {
		$(".dateFilterCalendar:visible").hide();
		return false;
	}
	if ($("#lightPagesList").length) {
		$("#lightPagesOuter").animate({opacity:"0"},550,function(){
			$("#lightPagesOuter").remove();
		});
		return false;
	}
	
	hide_iconbar_menus();
	dismissPopupController();
	$(".showMainMenu.selected").removeClass("selected");

	$(".dontHide").removeClass("dontHide");
		$(".bpe_sub_hilite").removeClass("bpe_sub_hilite");
		$(".bpe_sub_hilite2").removeClass("bpe_sub_hilite2");
		
	$(".hideForRename").removeClass("hideForRename");
	$(".menuForm").hide();
	$(".menuFormLink").show();
	
	if ($(".bpe_help_popup").length>0) {
		$(".bpe_help_popup").remove();
	} else {
		$(".bpe_textarea_mask").hide();
		$(".bpe_menu_contents").fadeOut(180);
		$(".choices,.choices3").hide();
		$(".bpe_menu_sub_items,.bpe_menu_sub_items2").hide();
		$(".bpe_sub_hilite").removeClass("bpe_sub_hilite");
		$(".bpe_toggler_controls").hide();
		
		$(".bpe_toggler").css("display","none");
		$(".bpe_highlight:not(.dont_remove_highlight)").removeClass("bpe_highlight");
	//	$(".bpe_image,form,p,h1,h2,h3,h4,h5,pre,li",$("#bpe_area")).fadeTo(0,1);

	}
	$(".listItemHighlight").removeClass("listItemHighlight");	
	$("body").removeClass("selectingAll");

	selectionTools();
	
}
function addComponent (cclass,text,el,prodCat) {
	if (typeof prodCat == 'undefined') {
		var prodCatText = "";
	} else {
		var prodCatText = " data-prod-cat=\""+prodCat+"\"";
	}
	if ($("#bpe_component_dropship").length) {
		$("#bpe_component_dropship").after("<div class=\"CMS_Component_Obs "+cclass+"\""+prodCatText+"><div><div><div><a class=\"componentDelete\"></a>"+text+"</div></div></div></div>");
		setTimeout(function() {
			$(".dont_remove_highlight").removeClass("dont_remove_highlight");			
		}, 1000);
	} else if ($("#bpe_invisible_dropship").length) {
		$("#bpe_invisible_dropship").after("<div class=\"CMS_Component_Obs "+cclass+"\""+prodCatText+"><div><div><div><a class=\"componentDelete\"></a>"+text+"</div></div></div></div>");
		setTimeout(function() {
			$(".dont_remove_highlight").removeClass("dont_remove_highlight");			
			$("#bpe_invisible_dropship").remove();
		}, 1000);
	} else {
		$("#bpe_area",$(".bpe_area_wrapper")).append("<div class=\"CMS_Component_Obs "+cclass+"\""+prodCatText+"><div><div><div><a class=\"componentDelete\"></a>"+text+"</div></div></div></div>");		
	}

//	$("body,html").animate({ scrollTop : $(document).height() }, 500);
}
function addComponentWithZones (cclass,text,el,zones) {

	zones = zones.split(",");
	zonesString = "<div class='zonesDividers clearfix'>";
	for (var i=0; i < zones.length; i++) {
		if (zones[i]!="") {
		if (typeof LangVars["Custom_"+zones[i]]!='undefined') {
			var friendlyname = LangVars["Custom_"+zones[i]];
		} else {
			var friendlyname = zones[i].replace(/_/g," ");
		}
		zonesString += "<div class='customZoneTitle' id='"+zones[i]+"'>"+friendlyname+"</div>";
		}
	};
	zonesString += "<div class='zonesEnd'></div></div>";
	if ($("#bpe_component_dropship").length) {
		$("#bpe_component_dropship").after("<div class=\"CMS_Component_Obs CMS_Component_ObsZones tooltipTarget "+cclass+"\"><div><div><div class='componentZonesTitle'><a class=\"componentDelete\"></a>"+text+"</div>"+zonesString+"</div></div></div>");
		
	} else if ($("#bpe_invisible_dropship").length) {
		$("#bpe_invisible_dropship").after("<div class=\"CMS_Component_Obs CMS_Component_ObsZones tooltipTarget "+cclass+"\"><div><div><div class='componentZonesTitle'><a class=\"componentDelete\"></a>"+text+"</div>"+zonesString+"</div></div></div>");
		setTimeout(function() {
			$(".dont_remove_highlight").removeClass("dont_remove_highlight");			
			$("#bpe_invisible_dropship").remove();
		}, 1000);
	} else {
		$("#bpe_area",$(".bpe_area_wrapper")).append("<div class=\"CMS_Component_Obs CMS_Component_ObsZones tooltipTarget "+cclass+"\"><div><div><div class='componentZonesTitle'><a class=\"componentDelete\"></a>"+text+"</div>"+zonesString+"</div></div></div>");
		
	}

	if (currentTooltip) {
		interuptedChains.push({currentTooltip:currentTooltip,currentTooltipItem:currentTooltipItem});
		clearTimeout(toolTipTimeout);
	}
	currentTooltipItem=0;
	currentTooltip="zones";
	toolTipTimeout = setTimeout(tooltip, 500);
}

function changeEl ($selected,tag1,el,deselect,parent) {
//	$("#bpe_area .dropzone").remove();
	if (deselect===false) {
		var newClass = " class='bpe_highlight bpe_highlight_done'";
	} else {
		var newClass = "";
	}
	if (el == "indent") {
		if ($selected.prev().children("ul,ol").length>0) {
			$selected.prev().children("ul,ol").append("<li"+newClass+">"+$selected.html()+"</li>");
		} else {
			$selected.prev().append("<"+parent+"><li"+newClass+">"+$selected.html()+"</li></"+parent+">");
		}
		$selected.remove();
	} else if (el == "outdent") {
		$selected.parent().parent().after("<li"+newClass+">"+$selected.html()+"</li>");
		if ($selected.next().length==0 && $selected.prev().length==0) {
			$selected.parent().remove();
		} else {
			$selected.remove();
		}
	} else {
		/*} else if (el == "ul" || el == "ol") {
		if (tag1=="li") {
			var moveup = false;
			var movedown = false;
			var loner = true;
			if ($selected.parent().prev().length>0) {
				var tag;
				$selected.parent().prev().each(function(){
					tag = this.tagName.toLowerCase();
				});
				if (tag==el) {
					moveup = true;
				}
			}
			if ($selected.parent().next().length>0) {
				var tag;
				$selected.parent().next().each(function(){
					tag = this.tagName.toLowerCase();
				});
				if (tag==el) {
					movedown = true;
				}
			}
			if ($selected.prev().length>0||$selected.next().length>0) {
				loner = false;
			}
			if (moveup == true && movedown == false) {
				var contents = $selected.html();
				$selected.parent().prev().append("<li"+newClass+">"+contents+"</li>");
				if (loner == true) {
					$selected.parent().remove();
				} else {
					$selected.remove();
				}
			} else if (moveup == false && movedown == true) {
				var contents = $selected.html();
				$selected.parent().next().prepend("<li"+newClass+">"+contents+"</li>");
				if (loner == true) {
					$selected.parent().remove();
				} else {
					$selected.remove();
				}
			} else if (moveup == true && movedown == true) {
				var contents = $selected.html();
				$selected.parent().prev().append("<li"+newClass+">"+contents+"</li>");
				$selected.parent().next().children().appendTo($selected.parent().prev());
				$selected.parent().next().remove();
				if (loner == true) {
					$selected.parent().remove();
				} else {
					$selected.remove();
				}
			} else { // change single
				var contents = $selected.html();
				var newEl = "";
				$selected.nextAll().each(function(){
					if ($(this).hasClass("bpe_highlight")) {
						newEl = newEl+"<li class=\"bpe_highlight\">"+$(this).html()+"</li>";						
					} else {
						newEl = newEl+"<li>"+$(this).html()+"</li>";						
					}
					$(this).remove();
				});
				if (newEl=="") {
					$selected.parent().after("<"+el+">\n\t<li"+newClass+">"+contents+"</li>\n</"+el+">");							
				} else {
					$selected.parent().after("<"+el+">\n\t<li"+newClass+">"+contents+"</li>\n</"+el+"><"+parent+">"+newEl+"</"+parent+">");							
				}
				$selected.remove();
			}
		} else {
			var moveup = false;
			var movedown = false;
			if ($selected.prev().length>0) {
				var tag;
				$selected.prev().each(function(){
					tag = this.tagName.toLowerCase();
				});
				if (tag==el) {
					moveup = true;
				}
			}
			if ($selected.next().length>0) {
				var tag;
				$selected.next().each(function(){
					tag = this.tagName.toLowerCase();
				});
				if (tag==el) {
					movedown = true;
				}
			}
			if (moveup == true && movedown == false) {
				var contents = $selected.html();
				$selected.prev().append("<li"+newClass+">"+contents+"</li>");
				$selected.remove();
			} else if (moveup == false && movedown == true) {
				var contents = $selected.html();
				$selected.next().prepend("<li"+newClass+">"+contents+"</li>");
				$selected.remove();
			} else if (moveup == true && movedown == true) {
				var contents = $selected.html();
				$selected.prev().append("<li"+newClass+">"+contents+"</li>");
				$selected.next().children().appendTo($selected.prev());
				$selected.next().remove();
				$selected.remove();
			} else {
				var contents = $selected.html();
				if (tag1=="li") {
					var newEl = "";
					$selected.nextAll().each(function(){
						if ($(this).hasClass("bpe_highlight")) {
							newEl = newEl+"<li class=\"bpe_highlight\">"+$(this).html()+"</li>";						
						} else {
							newEl = newEl+"<li>"+$(this).html()+"</li>";						
						}
						$(this).remove();
					});
					$selected.parent().after("<"+el+">\n\t<li"+newClass+">"+contents+"</li>\n</"+el+"><"+parent+">"+newEl+"</"+parent+">");							
					$selected.remove();
				} else {
					$selected.after("<"+el+">\n\t<li"+newClass+">"+contents+"</li>\n</"+el+">").remove();							
				}
			}
		}
	} else {
		if (tag1=="li") {
			var last = true;
			var first = true;
			if ($selected.prev().length>0) {
				first = false;
			}
			if ($selected.next().length>0) {
				last = false;
			}
			if (first == true && last == true) {
				var contents = $selected.html();
				$selected.parent().after("<"+el+""+newClass+">"+contents+"</"+el+">");
				$selected.remove();
			} else if (first == true && last == false) {
				var contents = $selected.html();
				$selected.parent().before("<"+el+""+newClass+">"+contents+"</"+el+">");
				$selected.remove();
			} else if (first == false && last == true) {
				var contents = $selected.html();
				$selected.parent().after("<"+el+""+newClass+">"+contents+"</"+el+">");
				$selected.remove();
			} else {
				var contents = $selected.html();
				var newEl = "";
				$selected.nextAll().each(function(){
					if ($(this).hasClass("bpe_highlight")) {
						newEl = newEl+"<li class=\"bpe_highlight\">"+$(this).html()+"</li>";						
					} else {
						newEl = newEl+"<li>"+$(this).html()+"</li>";						
					}
					$(this).remove();
				});
				$selected.parent().after("<"+el+""+newClass+">"+contents+"</"+el+"><"+parent+">"+newEl+"</"+parent+">");							
				$selected.remove();
			}

		} else {*/
			$("#bpe_area .bpe_highlight .itemTag").remove();
			/*if (el=="p") {
				//$selected.prepend("<span class='itemTag itemTagP'>"+LangVars.Paragraph+"</span>");
			}*/
			/*if (el=="h1") {
				$selected.prepend("<span class='itemTag itemTagH1'></span>");
			}
			if (el=="h2") {
				$selected.prepend("<span class='itemTag itemTagH2'></span>");
			}
			if (el=="h3") {
				$selected.prepend("<span class='itemTag itemTagH3'></span>");
			}
			if (el=="h4") {
				$selected.prepend("<span class='itemTag itemTagH4'></span>");
			}
			if (el=="pre") {
				//$selected.prepend("<span class='itemTag itemTagPre'>"+LangVars.Code+"</span>");
			}*/
//			var contents = $selected.html();
//			$selected.after("<"+el+""+newClass+">"+contents+"</"+el+">").remove();
			$selected.removeClass("el_p el_h1 el_h2 el_h3 el_h4 el_pre el_ul el_ol el_table level-1 level-2 level-3");
			if (el=='ul'||el=='ol') {
				if ($selected.attr("data-el")=='ul'||$selected.attr("data-el")=='ol') {
					var selLevel = parseInt($selected.attr("data-level"));
					$selected.addClass("level-"+selLevel).attr("data-level",selLevel);
				} else {
					$selected.addClass("level-1").attr("data-level",'1');
				}
			}
			$selected.attr("data-el",el).addClass("el_"+el);
			selectionTools();
			//}
	}

}

function removeIndent($cur) {
	var curLevel = parseInt($cur.attr("data-level"));
	var newLevel = curLevel-1;
	$cur.removeClass("level-1 level-2 level-3").addClass("level-"+newLevel).attr('data-level',newLevel);
}
function removeIndentAll($cur) {
	$cur.removeClass("level-2 level-3").addClass("level-1").attr('data-level','1');
}
function fixTooDeep() {
	$(".el_ul,.el_ol").each(function(){
		if ($(this).prev().prev().hasClass("el_ul")||$(this).prev().prev().hasClass("el_ol")) {
			var thisLevel = parseInt($(this).attr("data-level"));
			var prevLevel = parseInt($(this).prev().prev().attr("data-level"));
			if (prevLevel+1<thisLevel) {
				removeIndent($(this));
			}
		} else {
			if ($(this).attr("data-level")!='1') {
				removeIndentAll($(this));				
			}
		}			
	
	});
}
function assign_sort () {

	assignSaveListener();
	
	$("#bpe_area .itemTag").remove();
	$(".hwrap").contents().unwrap();
/*	$("h1,h2,h3,h4,h5",$("#bpe_area")).each(function(){
		$(this).wrapInner("<span class='hwrap'></span>");
	});*/

	$(".bpe_image",$("#bpe_area")).each(function(){

		var classes = options.img_classes.split(",");			
		
		for (var i=0; i < classes.length; i++) {
			if ($(this).hasClass(classes[i])) {
				if ($(this).hasClass("bpe_image")) {
					var friendlyname = $("#iconbarImageClasses a[rel="+classes[i]+"] .friendlyname").text();
				} else {
					var friendlyname = $("#iconbarBlockClasses a[rel="+classes[i]+"] .friendlyname").text();
				}
				$(this).append("<span class='itemTag itemTagClass' title='"+friendlyname+"'>"+friendlyname+"</span>");
			}
		};

	});
	$("#bpe_area").css("height",$("#bpe_area").height());
	$("#bpe_area .dropzone").remove();
	//$("#bpe_area .dropzone").droppable( "destroy" );
	// /$(".bpe_image,form,p,h1,h2,h3,h4,h5,pre,li,ul,ol,.bpe_table,div.CMS_Component_Obs,.bpe_split_divider",$("#bpe_area")).draggable( "destroy" );
	
	if ($("#bpeSectionTabs a[data-tpl=]").hasClass("currentSectionTab") || !$("#bpeSectionTabs").length) {
		$("#bpe_area").prepend("<div class='dropzone'><div></div></div>");		
	}

	$(".textareaWrapper,.bpe_image,form,p,h1,h2,h3,h4,h5,pre,li,div.CMS_Component_Obs,.customZoneTitle",$("#bpe_area")).filter(":visible").after("<div class='dropzone'><div></div></div>");
	
	$(".bpe_split_divider[alt="+$("#bpeSectionTabs a.currentSectionTab").attr("data-tpl")+"]",$("#bpe_area")).after("<div class='dropzone'><div></div></div>");
	$("#bpe_area").css("height","auto");
//	$("#bpe_area > ul,#bpe_area > ol,.zonesDropBox > ul,.zonesDropBox > ol").after("<div class='dropzone'><div></div></div>");

	$("#bpe_area .CMS_Component_ObsZones").each(function(){
		if (!$(".zonesDropBox",$(this)).length) {
			$("> .customZoneTitle",$(".zonesDividers",$(this))).before("<div class='zonesDropBox'></div>");
			$(".zonesDropBox",$(this)).each(function(){
				$box = $(this);
				$(this).nextAll().each(function(){
					if ($(this).hasClass("zonesDropBox")) {
						return false;
					}
					$(this).appendTo($box);
				});
			});
		}
	});
	
	$("#bpe_area .zonesDropBox").each(function(){
		$(this).removeClass("empty");
		if ($(".dropzone",$(this)).length==1) {
//			$(this).addClass("empty");
		}
	});
	fixTooDeep();
	function addTextWhereClicked(search,y,$t) {
		function complete() {
			$(".bpe_highlight").removeClass("bpe_highlight");
			$(".editing").removeClass("editing");
			$("#bpe_area .textarea:focus").blur();
			$(".listTipEditor").hide();
			$(".textEditingArea  > .listTipUp").hide();

			$($(search,$t).get().reverse()).each(function(){
				var t = $(this).offset().top;
				var h = $(this).outerHeight();
				var b = t+h;
				if (y>b || !$(this).prev().length) {
					addTextareaAfter($(this),'p','','left','',true,true,true);
					assign_sort();
					//bindTextareaWrappers();
					prepForInsert();					
					autosave();
					if (!iOS){
					selectionTools();
					assignAddTextKeysAndClick();
					}
					return false;
				}			
			});
		}
		if ($(".editingImage").length) {
			hidePopdownOrPassthroughSave(saveImage);
			setTimeout(function () {
				complete();
			}, 10);
		} else {
			complete();
		}

	}
	/*
	DEV REMOVED
	$("#bpe_area .zonesDropBox").unbind('click').click(function(e){
		e.stopPropagation();
		var y = e.clientY;
		addTextWhereClicked("> *:not(.zonesEnd)",y,$(this));
	});
	*/
	$("#dragBoundry").unbind('click').click(function(e){
		if ($(e.target).attr("id")=="dragBoundry") {
			e.stopPropagation();
			var y = e.clientY + $("body").scrollTop() + 15;
			addTextWhereClicked("#bpe_area > *:visible",y,$(this));
		}
		return false;
	});
	$(".textEditingArea").unbind('click').click(function(e){
		if ($(e.target)[0].nodeName.toLowerCase()!="textarea" && $(e.target)[0].nodeName.toLowerCase()!="CMS_Component_Obs" && !$(e.target).hasClass("dragTextArea")) {
			e.stopPropagation();
			var y = e.clientY + $("body").scrollTop() + 15;
			addTextWhereClicked("#bpe_area > *:visible",y,$(this));
		}
		return false;
	});
	$(".zonesDropBox").unbind('click').click(function(e){
		if ($(e.target)[0].nodeName.toLowerCase()!="textarea") {
			e.stopPropagation();
			var y = e.clientY + $("body").scrollTop() + 15;
			addTextWhereClicked("> *:visible",y,$(this));
		}
		return false;
	});

	$(".textEditingArea").selectable({ 
		filter: '.textareaWrapper,p,h1,h2,h3,h4,h5,pre,li,div.CMS_Component_Obs,.bpe_image,form' 
		//,cancel: 'p,h1,h2,h3,h4,h5,pre,li,ol,ul,div.CMS_Component_Obs,.bpe_table,.bpe_image,form'
		,selecting: function(event, ui) { 
			$(".bpe_highlight").removeClass("bpe_highlight");
			$(".multi_highlight").removeClass("multi_highlight");
			
			$(".ui-selecting").addClass("bpe_highlight");
			if ($(".ui-selecting").hasClass("textareaWrapper")) {
				$(".ui-selecting").addClass("multi_highlight");				
			}
			$(".ui-selected").addClass("bpe_highlight");			
			if (!iOS) {
				selectionTools();
			}

		}
		,unselecting: function(event, ui) { 
			$(".bpe_highlight").removeClass("bpe_highlight");
			$(".multi_highlight").removeClass("multi_highlight");
			if ($(".ui-selecting").hasClass("textareaWrapper")) {
				$(".ui-selecting").addClass("multi_highlight");				
			}
			$(".ui-selecting").addClass("bpe_highlight");
			$(".ui-selected").addClass("bpe_highlight");
//			if ($(".bpe_highlight").length) {
//				$(".bpe_selection_tool").removeClass("greyedOut");
//			} else {
//				$(".bpe_selection_tool").addClass("greyedOut");
//			}
			if (!iOS) {
				selectionTools();
			}
		},
		stop:function(){
			setTimeout(function () {
				selectionTools();				
			}, 10);

		}
		,delay: 20
	});
	$(".bpe_image,form,div.CMS_Component_Obs,.bpe_split_divider,.textareaWrapper",$("#bpe_area")).draggable({
		helper: function() {
			var l = parseFloat($(".textEditingArea").css("paddingLeft"));
			l =l -5;
			
			if ($(".bpe_highlight").length>1 && $(this).hasClass("bpe_highlight")) {
				$clones = $("<div class='draggingBox'></div>");
				$(".bpe_highlight").each(function(){
					$clones.append($(this).clone()).append("<div class='dropzone'><div></div></div>");					
				});
				l = l +10;
				return $clones.css('width', this.offsetWidth).css("height",this.offsetHeight-7).css("margin-left",l+"px").css("z-index","1000")[0];
			} else {
		 		return $(this).clone().css('width', this.offsetWidth).css("height",this.offsetHeight-7).css("margin-left",l+"px").css("z-index","1000")[0];				
			}
		},
		appendTo:"#addEntryForm",
		scroll:false,
		refreshPositions:true,
		start: function(){
			$(".bpe_highlight",$("#rightPane")).addClass("dont_remove_highlight");
			if (typeof myScroll[$(".textEditingArea").attr("id")] !='undefined') {
			myScroll[$(".textEditingArea").attr("id")].disable();				
			}
			
		},
		stop: function(){
			setTimeout(function () {
				$(".dont_remove_highlight",$("#rightPane")).removeClass("dont_remove_highlight");
			}, 250);
			if (typeof myScroll[$(".textEditingArea").attr("id")] !='undefined') {
				myScroll[$(".textEditingArea").attr("id")].enable();
			}
			clearTimeout(lovelyScrollDrag);
		},
		drag: function(event, ui){
			hidePaneTools();
			
			if ($(".textEditingArea").length) {
				
				
				var topZoneTop = 0;
				var topZoneBottom = topZoneTop+160;
				var topZoneLeft = 0;
				var topZoneRight = topZoneLeft + $("#dragBoundry").width();

				var bottomZoneTop = $(window).height()-50;
				var bottomZoneBottom = $(window).height();
				var bottomZoneLeft = 0;
				var bottomZoneRight = $("#dragBoundry").width();

				var posTop = event.pageY - $("body").scrollTop();
				var posLeft = event.pageX;
				clearTimeout(lovelyScrollDrag);
				if (posTop > topZoneTop && posTop < topZoneBottom && posLeft > topZoneLeft && posLeft < topZoneRight) {
//					$(".textEditingArea").lovelyScrollMove(7);


					$("body,html").scrollTop($("body").scrollTop()-7);
					lovelyScrollDrag = setInterval(function(){
					$("body,html").scrollTop($("body").scrollTop()-7);
//						$(".textEditingArea").lovelyScrollMove(7);
					},30);
				}

				if (posTop > bottomZoneTop && posTop < bottomZoneBottom && posLeft > bottomZoneLeft && posLeft < bottomZoneRight) {
//					$(".textEditingArea").lovelyScrollMove(-7);
					$("body,html").scrollTop($("body").scrollTop()+7);
					lovelyScrollDrag = setInterval(function(){
						$("body,html").scrollTop($("body").scrollTop()+7);
//						$(".textEditingArea").lovelyScrollMove(-7);
					},30);
				}
				
				
			}
			
		},
	    zIndex: 1000,
		opacity:0.7,
		distance: 4,
		axis:'y'
	});
	$("div.CMS_Component_Obs.CMS_Component_ObsZones",$("#bpe_area")).draggable('option','cancel','.zonesDropBox');
	
	$(".textEditingArea,#dragBoundry").droppable({
		accept: ".textareaWrapper,.bpe_image,form,li,.bpe_table,div.CMS_Component_Obs,.bpe_split_divider,.contentImage,.addVideoItem,.responsiveListItem:not(.productOption,.formInputItem,.optionItem,.galleryThumb,.editPageBar)",
		tolerance:"pointer",
		greedy:true,
		drop: function(e, ui) {
			clearTimeout(lovelyScrollDrag);
			drop(e,ui,$("#bpe_area .dropzone.dropping"));			
		},
		over: function(e,ui) {
			var ot = ui.helper.offset().top;

			$("#bpe_area .dropzone.dropping").removeClass("dropping");
			var found=false;
			$("#bpe_area .dropzone").each(function(){

				
					if ($(this).offset().top > ot) {

						if (
							($(this).parents(".CMS_Component_ObsZones").length && $(".zonesDropBox",ui.draggable).length)
							||
							($(this).parents(".CMS_Component_ObsZones").length && typeof $(ui.draggable).attr("zones") != 'undefined' && $(ui.draggable).attr("zones")!="")
						) {

						} else {
							$(this).addClass("dropping");
							found=true;
							return false;	
						}
					
					}
			
			});
			if (!found) {
				$("#bpe_area .dropzone:last").addClass("dropping");	
			}
			
	    },
	    out: function() {
			$("#bpe_area .dropzone.dropping").removeClass("dropping");
	    }
	});
	/*
	$("li",$("#bpe_area ul,#bpe_area ol")).droppable({
		accept: "li",
		tolerance:"pointer",
		greedy:true,
		drop: function(e, ui) {
			clearTimeout(lovelyScrollDrag);
			if (!ui.draggable.hasClass("dragInsertItem")) {
				if ($(this).parents("ul,ol").length<3) {
					if ($(this).children("ul,ol").length) {
						var $t = $(this);
						if ($("li.bpe_highlight:not(.draggingBox li.bpe_highlight)").length) {
							$("li.bpe_highlight:not(.draggingBox li.bpe_highlight)").each(function(){
								$t.children("ul,ol").append($(this));							
							});							
						} else {
							$t.children("ul,ol").append(ui.draggable);							
						}
						setTimeout(function() {
							$.fn.bpeditor.clean(true);
						}, 50);
					} else {
						if ($(ui.draggable).parent()[0].tagName.toLowerCase()=="ul") {
							var $toAdd = $("<ul></ul>");
						} else {
							var $toAdd = $("<ol></ol>");
						}
						$(this).append($toAdd);
						if ($("li.bpe_highlight:not(.draggingBox li.bpe_highlight)").length) {
						
							$(".bpe_highlight:not(.draggingBox .bpe_highlight)").each(function(){
								$toAdd.append($(this));							
							});
						} else {
							$toAdd.append(ui.draggable);							
						}
						setTimeout(function() {
							$.fn.bpeditor.clean(true);
						}, 50);

					}
				}
				
			}
			$(".nestedTarget").removeClass("nestedTarget");					//$(this).animate({borderTopColor:"#FFFFFF",borderRightColor:"#FFFFFF",borderBottomColor:"#FFFFFF",borderLeftColor:"#FFFFFF"},50);
			
//			
		},
		over: function(e,ui) {
			$(this).addClass("dropping");
			if (!ui.draggable.hasClass("dragInsertItem")) {
				if (!$(".dropping",$(this)).length) {
					if ($(this).parents("ul,ol").length<3) {
						$(this).addClass("nestedTarget");
					}	
				}
				
			}
	    },
	    out: function() {
			$(this).removeClass("dropping");
			$(this).removeClass("nestedTarget");					//$(this).animate({borderTopColor:"#FFFFFF",borderRightColor:"#FFFFFF",borderBottomColor:"#FFFFFF",borderLeftColor:"#FFFFFF"},50);
	    }
	});*/

		$("#bpe_area .dropzone:not(.CMS_Component_ObsZones .dropzone,ul .dropzone)").droppable({
		accept: ".textareaWrapper,.bpe_image,form,li,.bpe_table,div.CMS_Component_Obs,.bpe_split_divider,.contentImage,.addVideoItem,.responsiveListItem:not(.productOption,.formInputItem,.optionItem,.galleryThumb)",
		tolerance:"pointer",
		greedy:true,
		drop: function(e, ui) {
			clearTimeout(lovelyScrollDrag);
			drop(e,ui,$(this));
			
//			
		},
		over: function(e,ui) {
			$(".dropping").removeClass("dropping");
			$(this).addClass("dropping");
			if (!ui.draggable.next().hasClass("dropping") && !ui.draggable.prev().hasClass("dropping")) {
			//	$(this).animate({borderTopColor:"#777777",borderRightColor:"#777777",borderBottomColor:"#777777",borderLeftColor:"#777777"},50);					
			}
	    },
	    out: function() {
			$(this).removeClass("dropping");
			//$(this).animate({borderTopColor:"#FFFFFF",borderRightColor:"#FFFFFF",borderBottomColor:"#FFFFFF",borderLeftColor:"#FFFFFF"},50);
	    }
	});
	
	function dropFSImageOnPage(file,serverData,e,t) {
		$(".bpe_images,#bpe_images,#imagesPaneInner .insertTarget").html(serverData);
		$obj=$("#bpe_images .contentImage:first");
		var sizeStr = $(".changeImageSize.defaultImageSize:first").attr("string");
		$newPic = $('<div class="bpe_image bpe_highlight dont_remove_highlight"><img src="'+$obj.data("path")+'?'+sizeStr+'" /></div><div class="dropzone"><div></div></div>');
		$newPic.insertAfter(t);
		
		$('<img />').load( function(){
			//Removed 9 Jan
			//$(".textEditingArea").lovelyScroll();
		}).attr('src', $obj.attr("id")+'?'+sizeStr).remove();
		$("#null .dz-preview.dz-error").remove();
		if (!$("#null .dz-preview:not(.dz-success)").length) {
			$("body").unbind("click");
			$.fn.bpeditor.clean(true);
			$(document).unbind("keyup");
			setTimeout(function() {
				$(".dont_remove_highlight").removeClass("dont_remove_highlight");			
			}, 1000);	
		}
	};
	var m = parseFloat($("#maxUploadSize").val())/1024;
	m = m/1024;

	$("#bpe_area .dropzone:not(ul .dropzone)").dropzone({
		url:"/admin/pageActions.php"
		,clickable:false
		,paramName: "image"
		,params:{pageAction:"addImage"}
		,previewsContainer:"#null"
		,acceptedMimeTypes:"image/*"
		,maxFilesize:m
		,dictInvalidFileType:LangVars.Upload_Error_Bad_Format
		,dictResponseError:LangVars.Misc_Error
		,dictFileTooBig:LangVars.File_Too_Large
		,init: function() {
			this.on("addedfile", function(event) { 
				uploading("1");
			}),
			this.on("uploadprogress", function(file,progress) { 
				if (updatedPercent==false) {
					uploading(progress);
					updatedPercent=true;
					setTimeout(function() {
						updatedPercent=false;
					}, 1000);	
				}
				
			}),
			this.on("error", function(file,message) { 
				$("#bpe_area .dropzone.dropping").removeClass("dropping");
				error(message);
			}),
			this.on("success", function(file,serverData,e,t) {
				if (serverData=="limit") {
					error(LangVars.Storage_Limit_Reached);
				} else {
	    			dropFSImageOnPage(file,serverData,e,t);
				}
			});
  		}

	});
	
	$(".textEditingArea:not(.dz-done)").dropzone({
		url:"/admin/pageActions.php"
		,clickable:false
		,paramName: "image"
		,params:{pageAction:"addImage"}
		,previewsContainer:"#null"
		,maxFilesize:m
		,acceptedMimeTypes:"image/*"
		,dictInvalidFileType:LangVars.Upload_Error_Bad_Format
		,dictResponseError:LangVars.Misc_Error
		,dictFileTooBig:LangVars.File_Too_Large
		,init: function() {
			this.on("dragenter", function() { 
				$("#bpe_area .dropzone:last").addClass("dropping");
			}),
			this.on("dragleave", function() { 
				$("#bpe_area .dropzone:last").removeClass("dropping");
			}),
			this.on("addedfile", function() { 
				working();
			}),
			this.on("error", function(file,message) { 
				$("#bpe_area .dropzone.dropping").removeClass("dropping");
				error(message);
			}),
    		this.on("success", function(file,serverData,e,t) { 
    			if (serverData=="limit") {
    				error(LangVars.Storage_Limit_Reached);
    			} else {

	    			dropFSImageOnPage(file,serverData,e,$("#bpe_area .dropzone:last"));
				
    			}
    		});
  		}
	});
	$(".textEditingArea").addClass("dz-done");
	function drop (e,ui,$this) {
		var editText=false;
		var addImage=false;
		var addTable=false;
		var addVideo=false;
		var addingForm=false;
		var addingFile=false;
		var addingProduct=false;
		var addingBookingProduct=false;
		var addingCalendar=false;
		var addingSnippet=false;
		var addingEmbedCode=false;
		var addingComponent=false;
		var addingCheckout=false;
		var addingInvoice=false;
		var addingBlog=false;
		var addingSitemap=false;
		var addingNewsletter=false;
		var addingCustom=false;
		var addingColumns=false;
		var addingSection=false;
		var addingGallery=false;
		var addingTable=false;
		var addingMailingList=false;
		if (ui.draggable.hasClass("contentImage")) {
			$(".bpe_highlight").removeClass("bpe_highlight");

			$("body").attr("pane",$("body").attr("previousPane"));

			var dropper = $("<div id='bpe_invisible_dropship'></div>");
			
			addImage=true;
			//var dropper = $("<div class='bpe_image'><img src='"+ui.draggable.attr("id")+"' /></div>")
		} else if (ui.draggable.hasClass("galleryItem")) {
			$(".bpe_highlight").removeClass("bpe_highlight");

			$("body").attr("pane",$("body").attr("previousPane"));
			var dropper = $("<div id='bpe_invisible_dropship'></div>");
			addingGallery=true;

		} else if (ui.draggable.hasClass("addVideoItem")) {
			$(".bpe_highlight").removeClass("bpe_highlight");
			$("body").attr("pane",$("body").attr("previousPane"));

			var vidId = ui.draggable.attr("data-src");
			var picSrc = ui.draggable.attr("data-thumb");
			var dropper = $("<div class='bpe_video bpe_image'><a href=\""+vidId+"\"><img src='"+picSrc+"' /></a></div>");			
		}
		else if (ui.draggable.hasClass("formItem")) {
			$(".bpe_highlight").removeClass("bpe_highlight");
			$("body").attr("pane",$("body").attr("previousPane"));
			var dropper = $("<div id='bpe_invisible_dropship'></div>");
			addingForm=true;
		} 
		else if (ui.draggable.hasClass("downloadableFile")) {
			$(".bpe_highlight").removeClass("bpe_highlight");
			$("body").attr("pane",$("body").attr("previousPane"));
			var dropper = $("<div id='bpe_invisible_dropship'></div>");

			addingFile=true;
		} 
		else if (ui.draggable.hasClass("productItemMain")) {
			$(".bpe_highlight").removeClass("bpe_highlight");
			$("body").attr("pane",$("body").attr("previousPane"));
			var dropper = $("<div id='bpe_invisible_dropship'></div>");
			addingProduct=true;
		} 
		else if (ui.draggable.hasClass("bookingProductItemMain")) {
			$(".bpe_highlight").removeClass("bpe_highlight");
			$("body").attr("pane",$("body").attr("previousPane"));
			var dropper = $("<div id='bpe_invisible_dropship'></div>");
			addingBookingProduct=true;
		} 
		else if (ui.draggable.hasClass("mailingListItem")) {
			$(".bpe_highlight").removeClass("bpe_highlight");
			$("body").attr("pane",$("body").attr("previousPane"));
			var dropper = $("<div id='bpe_invisible_dropship'></div>");
			addingMailingList=true;
		} 
		else if (ui.draggable.hasClass("calendarItem")) {
			$(".bpe_highlight").removeClass("bpe_highlight");
			$("body").attr("pane",$("body").attr("previousPane"));
			var dropper = $("<div id='bpe_invisible_dropship'></div>");
			addingCalendar=true;
		} 
		else if (ui.draggable.hasClass("snippetItem")) {
			$(".bpe_highlight").removeClass("bpe_highlight");
			$("body").attr("pane",$("body").attr("previousPane"));
			var dropper = $("<div id='bpe_invisible_dropship'></div>");
			addingSnippet=true;
		} 
		else if (ui.draggable.hasClass("embedCodeItem")) {
			$(".bpe_highlight").removeClass("bpe_highlight");
			$("body").attr("pane",$("body").attr("previousPane"));
			var dropper = $("<div id='bpe_invisible_dropship'></div>");
			addingEmbedCode=true;
		} 
		else if (ui.draggable.hasClass("tableItem")) {
			$(".bpe_highlight").removeClass("bpe_highlight");
			$("body").attr("pane",$("body").attr("previousPane"));
			var dropper = $("<div id='bpe_invisible_dropship'></div>");
			addingTable=true;
		} 
		else if (ui.draggable.hasClass("dragInsertItem")) { 
			$(".bpe_highlight").removeClass("bpe_highlight");
			if (
				ui.draggable.attr("id")=="dragInsertP"
				||ui.draggable.attr("id")=="dragInsertH1"
				||ui.draggable.attr("id")=="dragInsertH2"
				||ui.draggable.attr("id")=="dragInsertH3"
				||ui.draggable.attr("id")=="dragInsertH4"
				||ui.draggable.attr("id")=="dragInsertUL"
				||ui.draggable.attr("id")=="dragInsertOL"
				||ui.draggable.attr("id")=="dragInsertPre"
				) {
				if ($this.parents("ul,ol").length) {
					var dropper = $("<li class='bpe_highlight addText'></li>");	
				} else {
					var elo = false;
					if (ui.draggable.attr("id")=="dragInsertP") {
						var el = "p";
					}
					if (ui.draggable.attr("id")=="dragInsertH1") {
						var el = "h1";
					}
					if (ui.draggable.attr("id")=="dragInsertH2") {
						var el = "h2";
					}
					if (ui.draggable.attr("id")=="dragInsertH3") {
						var el = "h3";
					}
					if (ui.draggable.attr("id")=="dragInsertH4") {
						var el = "h4";
					}
					if (ui.draggable.attr("id")=="dragInsertUL") {
						var el = "li";
						var elo = "ul";
					}
					if (ui.draggable.attr("id")=="dragInsertOL") {
						var el = "li";
						var elo = "ol";
					}
					if (ui.draggable.attr("id")=="dragInsertPre") {
						var el = "pre";
					}
					
					var dropper = $("<"+el+" class='bpe_highlight addText'></"+el+">");						
					
					
				}
				editText=true;
			}
			if (ui.draggable.hasClass("dragInsertImage")) {
				var dropper = newImage;	
				addImage=true;
			}
			if (ui.draggable.hasClass("dragInsertVideo")) {
				var dropper = newVideo;	
				addVideo=true;
			}
			if (ui.draggable.hasClass("dragInsertTable")) {
				addTable=true;
				
				var dropper = $("<div class='bpe_table bpe_highlight'></div><div class='dropzone'><div></div></div>");	
			}
			if (ui.draggable.hasClass("dragInsertComponent")) {
				addingComponent=true;
				
				var dropper = $(newComponentDropship);	
			}
			if (ui.draggable.hasClass("dragInsertCheckout")) {
				addingCheckout = true;
				var dropper = $("<div id='bpe_invisible_dropship'></div>");
			}
			if (ui.draggable.hasClass("dragInsertInvoice")) {
				addingInvoice = true;
				var dropper = $("<div id='bpe_invisible_dropship'></div>");
			}
			if (ui.draggable.hasClass("dragInsertBlog")) {
				addingBlog = true;
				var dropper = $("<div id='bpe_invisible_dropship'></div>");
			}
			if (ui.draggable.hasClass("dragInsertSitemap")) {
				addingSitemap = true;
				var dropper = $("<div id='bpe_invisible_dropship'></div>");
			}
			
			if (ui.draggable.hasClass("drag_insert_subscribe")) {
				addingNewsletter = true;
				var dropper = $("<div id='bpe_invisible_dropship'></div>");
			}
			if (ui.draggable.hasClass("dragInsertCustom")) {
				addingCustom = true;
				var dropper = $("<div id='bpe_invisible_dropship'></div>");
			}
			if (ui.draggable.hasClass("dragInsertColumns")) {
				addingColumns = true;
				var dropper = $("<div id='bpe_invisible_dropship'></div>");
			}
			if (ui.draggable.hasClass("dragInsertSection")) {
				addingSection = true;
				var dropper = $("<div id='bpe_invisible_dropship'></div>");
			}
		} else {
			var dropper = ui.draggable;
			logTrainingClick("dragContentItemInEditPage");
		}
		if (ui.draggable.hasClass("bpe_highlight") && $(".bpe_highlight").length>1) {
			var $target = $this;
			$($(".bpe_area_wrapper .bpe_highlight:not(.draggingBox .bpe_highlight)").get().reverse()).each(function(){
				$(this).insertAfter($target);
			});
		} else {
			dropper.insertAfter($this);
		}
		$this.removeClass("dropping");
		if (editText) {
			addText(dropper,elo);
		} else if (addVideo) {
			prepForInsert();
			dropper.insertAfter($this);
			hide_menus();
			$.fn.bpeditor.clean(true);
			//dragVideo();

		} else if (addImage) {
			prepForInsert();
			var sizeStr = $(".changeImageSize.defaultImageSize:first").attr("string");
			if ($(".draggingBox").length) {
				$($(".draggingBox .contentImage").get().reverse()).each(function(){
					var $item = $('<div class="bpe_image bpe_highlight"><img src="'+$(this).data("path")+'?'+sizeStr+'" alt="'+$(this).attr("title")+'"/></div><div class="dropzone"><div></div></div>');
					$item.insertAfter(dropper);
					$('<img />').load( function(){
			//Removed 9 Jan
			//$(".textEditingArea").lovelyScroll();
					}).attr('src', $(this).attr("id")+'?'+sizeStr).remove();
				});
			} else {
				var dropper = $('<div class="bpe_image bpe_highlight"><img src="'+ui.draggable.data("path")+'?'+sizeStr+'" alt="'+ui.draggable.attr("title")+'"/></div><div class="dropzone"><div></div></div>');
				dropper.insertAfter($this);
				$('<img />').load( function(){
			//Removed 9 Jan
			//$(".textEditingArea").lovelyScroll();
				}).attr('src', ui.draggable.attr("id")+'?'+sizeStr).remove();
			}
			hide_menus();
			$.fn.bpeditor.clean(true);
		} else if (addingForm) {
			prepForInsert();
			dropper.insertAfter($this);
			if ($(".draggingBox").length) {
				$($(".draggingBox .formItem").get().reverse()).each(function(){
					addComponent("ComponentForm-"+$(this).attr("id").replace("form",""),"<strong>"+LangVars.Contact_form+":</strong> "+$(this).attr("rel"),false);
				});
			} else {
				addComponent("ComponentForm-"+ui.draggable.attr("id").replace("form",""),"<strong>"+LangVars.Contact_form+":</strong> "+ui.draggable.attr("rel"),false);
			}
			hide_menus();
			$.fn.bpeditor.clean(true);

		}
		else if (addingMailingList) {
			prepForInsert();
			dropper.insertAfter($this);
			if ($(".draggingBox").length) {
				$($(".draggingBox .formItem").get().reverse()).each(function(){
					addComponent("ComponentNewsletter-"+(this).attr("group-id"),"<strong>"+LangVars.Mailing_List_Subscribe+":</strong> "+(this).attr("title"),false);

				});
			} else {
				addComponent("ComponentNewsletter-"+ui.draggable.attr("group-id"),"<strong>"+LangVars.Mailing_List_Subscribe+":</strong> "+ui.draggable.attr("title"),$(this));
			}
			hide_menus();
			$.fn.bpeditor.clean(true);

		} else if (addingProduct) {
			prepForInsert();
			dropper.insertAfter($this);
			if ($(".draggingBox").length) {
				$($(".draggingBox .productItem").get().reverse()).each(function(){
					addComponent("ComponentProduct-"+$(this).attr("id").replace("prod",""),"<strong>"+LangVars.Product+":</strong> "+$(this).attr("rel"),false);
				});
			} else {
				addComponent("ComponentProduct-"+ui.draggable.attr("id").replace("prod",""),"<strong>"+LangVars.Product+":</strong> "+ui.draggable.attr("rel"),$(this));
			}
			hide_menus();
			$.fn.bpeditor.clean(true);

		} else if (addingBookingProduct) {
			prepForInsert();
			dropper.insertAfter($this);
			if ($(".draggingBox").length) {
				$($(".draggingBox .bookingProductItemMain").get().reverse()).each(function(){
					addComponent("ComponentBookingProduct-"+$(this).data("id"),"<strong>"+LangVars.Booking_Product+":</strong> "+$(this).attr("name"),false);
				});
			} else {
				addComponent("ComponentBookingProduct-"+ui.draggable.data("id"),"<strong>"+LangVars.Booking_Product+":</strong> "+ui.draggable.attr("name"),$(this));
			}
			hide_menus();
			$.fn.bpeditor.clean(true);

		} else if (addingCalendar) {
			prepForInsert();
			dropper.insertAfter($this);
			if ($(".draggingBox").length) {
				$($(".draggingBox .calendarItem").get().reverse()).each(function(){
					
					if ($(this).attr("rel")=="all_categories") {
						addComponent("ComponentCalendar","Calendar",false);
					} else {
						addComponent("ComponentCalendarCat-"+$(this).attr("rel"),"<strong>"+LangVars.Calendar+":</strong> "+$(this).attr("title"),false);
					}
				});
			} else {

				if (ui.draggable.attr("rel")=="all_categories") {
					addComponent("ComponentCalendar","Calendar",false);
				} else {
					addComponent("ComponentCalendarCat-"+ui.draggable.attr("rel"),"<strong>"+LangVars.Calendar+":</strong> "+ui.draggable.attr("title"),false);
				}
			}
			hide_menus();
			$.fn.bpeditor.clean(true);

		} else if (addingSnippet) {
			prepForInsert();
			dropper.insertAfter($this);
			if ($("#editing").val()==ui.draggable.attr("alt")) {
				error(LangVars.Cant_Add_Snippet_To_Itself);
			} else {
				if ($(".draggingBox").length) {
					$($(".draggingBox .snippetItem").get().reverse()).each(function(){
						addComponent("ComponentSnippet-"+$(this).attr("alt"),"<strong>"+LangVars.Snippet+":</strong> "+$(this).attr("title"),$(this));
					});
				} else {
					addComponent("ComponentSnippet-"+ui.draggable.attr("alt"),"<strong>"+LangVars.Snippet+":</strong> "+ui.draggable.attr("title"),$(this));
				}
					
				hide_menus();
				$.fn.bpeditor.clean(true);
			}
		} else if (addingEmbedCode) {
			prepForInsert();
			dropper.insertAfter($this);
			if ($(".draggingBox").length) {
					$($(".draggingBox .embedCodeItem").get().reverse()).each(function(){
						addComponent("ComponentEmbed-"+$(this).attr("embed-code-id"),"<strong>"+LangVars.Embed_Code+":</strong> "+htmlentities($(this).attr("embed-code-name")),$(this));
					});
			} else {
				addComponent("ComponentEmbed-"+ui.draggable.attr("embed-code-id"),"<strong>"+LangVars.Embed_Code+":</strong> "+htmlentities(ui.draggable.attr("embed-code-name")),$(this));	
			}
			
			hide_menus();
			$.fn.bpeditor.clean(true);
			
		}
	    else if (addingTable) {
   			prepForInsert();
   			dropper.insertAfter($this);
   			if ($(".draggingBox").length) {
   					$($(".draggingBox .tableItem").get().reverse()).each(function(){
   						addComponent("ComponentTable-"+$(this).attr("table-id"),"<strong>"+LangVars.Table+":</strong> "+htmlentities($(this).attr("title")),$(this));
   					});
   			} else {
   				addComponent("ComponentTable-"+ui.draggable.attr("table-id"),"<strong>"+LangVars.Table+":</strong> "+htmlentities(ui.draggable.attr("title")),$(this));	
   			}
		
   			hide_menus();
   			$.fn.bpeditor.clean(true);
		
   		}
		 else if (addingFile) {
			prepForInsert();
			dropper.insertAfter($this);
			if ($(".draggingBox").length) {
					$($(".draggingBox .downloadableFile").get().reverse()).each(function(){
						$("#bpe_invisible_dropship").after($("<p><a href=\"/downloads/"+$(this).attr("data-url")+"\" target=\"_blank\">"+$(this).attr("id")+"</a></p>"));
					});
			} else  {
				$("#bpe_invisible_dropship").after($("<p><a href=\"/downloads/"+ui.draggable.attr("data-url")+"\" target=\"_blank\">"+ui.draggable.attr("id")+"</a></p>"));	
			}

			
			hide_menus();
			$.fn.bpeditor.clean(true);
			
		} else if (addTable) {
			prepForInsert();
			dropper.insertAfter($this);
			addTableF($this.next());
		} else if (addingNewsletter) {
			prepForInsert();
			dropper.insertAfter($this);
			addComponent("ComponentNewsletter-"+ui.draggable.attr("group-id"),"<strong>"+LangVars.Mailing_List_Subscribe+":</strong> "+ui.draggable.attr("title"),$(this));
			hide_menus();
			$.fn.bpeditor.clean(true);

		} else if (addingComponent) {
			prepForInsert();
			dropper.insertAfter($this);
			dragComponent(ui.draggable.attr("rel"));
		} else if (addingCheckout) {
			prepForInsert();
			dropper.insertAfter($this);
			addComponent("ComponentShoppingBasket","<strong>"+LangVars.Core+":</strong> "+LangVars.Widget_Checkout+"</strong>",$(this));
			hide_menus();
			$.fn.bpeditor.clean(true);
		} else if (addingInvoice) {
			prepForInsert();
			dropper.insertAfter($this);
			addComponent("ComponentInvoice","<strong>"+LangVars.Core+":</strong> "+LangVars.Invoice_Widget+"</strong>",$(this));
			hide_menus();
			$.fn.bpeditor.clean(true);
		}
		 else if (addingSection) {
			prepForInsert();
			
			$this.after("<div class=\"bpe_split_divider tooltipTarget "+ui.draggable.attr("data-tpl")+"\" alt=\""+ui.draggable.attr("data-tpl")+"\">"+ui.draggable.html()+"</div>");

			hide_menus();
			$.fn.bpeditor.clean(true);

			if (currentTooltip) {
				interuptedChains.push({currentTooltip:currentTooltip,currentTooltipItem:currentTooltipItem});
				clearTimeout(toolTipTimeout);
			}
			currentTooltipItem=0;
			currentTooltip="section";
			toolTipTimeout = setTimeout(tooltip, 500);
		}
		else if (addingGallery) {
			prepForInsert();
			dropper.insertAfter($this);
			if ($(".draggingBox").length) {
				$($(".draggingBox .galleryItem").get().reverse()).each(function(){
					addComponent("ComponentGallery-"+$(this).attr("id").replace("gal",""),"<strong>"+LangVars.Gallery+":</strong> "+$(this).attr("rel"),false);
				});
			} else {
				addComponent("ComponentGallery-"+ui.draggable.attr("id").replace("gal",""),"<strong>"+LangVars.Gallery+":</strong> "+ui.draggable.attr("rel"),false);
			}
			hide_menus();
			$.fn.bpeditor.clean(true);
		} else if (addingCustom) {

			prepForInsert();
			dropper.insertAfter($this);
			if (ui.draggable.attr("zones")=="") {
				if (ui.draggable.attr("data-prod-cat-id")!="") {
					addComponent("ComponentCustom-Core_Related_Products.tpl","<strong>"+LangVars.Extra+":</strong> "+ui.draggable.html(),false,ui.draggable.attr("data-prod-cat-id"));
				} else {
					addComponent("ComponentCustom-"+ui.draggable.attr("data-tpl"),"<strong>"+LangVars.Extra+":</strong> "+ui.draggable.html(),false);					
				}

			} else {
				if (ui.draggable.parents(".CMS_Component_ObsZones").length) {
					error(LangVars.Error_Cant_Nest_Editable_Zones);
					hide_menus();
					$.fn.bpeditor.clean(true);
				} else{
					addComponentWithZones("ComponentCustomZones-"+ui.draggable.attr("data-tpl"),ui.draggable.html(),ui.draggable.parent(),ui.draggable.attr("zones"));					
				}
				
			}
			hide_menus();
			$.fn.bpeditor.clean(true);
		} else if (addingColumns) {
			prepForInsert();
			dropper.insertAfter($this);
	
				if (ui.draggable.parents(".CMS_Component_ObsZones").length) {
					error(LangVars.Error_Cant_Nest_Editable_Zones);
					hide_menus();
					$.fn.bpeditor.clean(true);
				} else{
					addComponentWithZones("ComponentColumnsZones-"+ui.draggable.attr("data-tpl"),ui.draggable.html(),ui.draggable.parent(),ui.draggable.attr("zones"));					
				}
				
			
			hide_menus();
			$.fn.bpeditor.clean(true);
		} else if (addingBlog) {
			if ($("#bpe_area .ComponentBlog").length) {
				error(LangVars.Blog_Already_On_Page);
				return false;
			}
			prepForInsert();
			dropper.insertAfter($this);
			logTrainingClick("addBlogItem");
			addComponent("ComponentBlog","<strong>"+LangVars.Core+":</strong> "+LangVars.Widget_Blog+"",$(this));
			hide_menus();
			$.fn.bpeditor.clean(true);
		} else if (addingSitemap) {
			prepForInsert();
			dropper.insertAfter($this);
			addComponent("ComponentSitemap","<strong>"+LangVars.Core+":</strong> "+LangVars.Sitemap+"</strong>",$(this));
			hide_menus();
			$.fn.bpeditor.clean(true);
		} else {
			setTimeout(function() {	
				$.fn.bpeditor.clean(true);
			}, 5);			
		}
		
		
	}
	$("#editTextImage").unbind().click(function(){
		var textItems = "p.bpe_highlight,h1.bpe_highlight,h2.bpe_highlight,h3.bpe_highlight,h4.bpe_highlight,li.bpe_highlight,pre.bpe_highlight";
		if ($(textItems).length==1 && $(".bpe_highlight").length==1) {
			addText($(".bpe_highlight"));
		}
		if ($(".bpe_highlight.bpe_image").length==1 && $(".bpe_highlight").length==1) {
			editImage($(".bpe_highlight.bpe_image"));
		}
		return false;
	});
	
	$(".CMS_Component_ObsZones .dropzone").droppable({
		accept: ".textareaWrapper,.bpe_image,form,p,h1,h2,h3,h4,h5,pre,li:not(.dragInsertColumns,.dragInsertSection),ul,ol,.bpe_table,.contentImage,.addVideoItem,.responsiveListItem:not(.productOption,.formInputItem,.optionItem,.galleryThumb),div.CMS_Component_Obs:not(.CMS_Component_ObsZones)",
		tolerance:"pointer",
		greedy:true,
		drop: function(e, ui) {
			clearTimeout(lovelyScrollDrag);
			if (ui.draggable.attr("zones")=="" || typeof ui.draggable.attr("zones")=='undefined' ) {

				drop(e,ui,$(this));
			}			
//			
		},
		over: function(e,ui) {
			if (ui.draggable.attr("zones")=="" || typeof ui.draggable.attr("zones")=='undefined' ) {
				$(this).addClass("dropping");
			}
			
			if (!ui.draggable.next().hasClass("dropping") && !ui.draggable.prev().hasClass("dropping")) {
				//$(this).animate({borderTopColor:"#777777",borderRightColor:"#777777",borderBottomColor:"#777777",borderLeftColor:"#777777"},50);					
			}
	    },
	    out: function() {
			$(this).removeClass("dropping");
			//$(this).animate({borderTopColor:"#FFFFFF",borderRightColor:"#FFFFFF",borderBottomColor:"#FFFFFF",borderLeftColor:"#FFFFFF"},50);
	    }
	});
	
	/*
	$("ul .dropzone,ol .dropzone").droppable({
		accept: "#bpe_area li,.dragInsertUL,.dragInsertOL",
		tolerance:"pointer",
		greedy:true,
		
		drop: function(e, ui) {
			clearTimeout(lovelyScrollDrag);
			drop(e,ui,$(this));
			

//			
		},
		over: function(e,ui) {
			$(this).addClass("dropping");
			if (!ui.draggable.next().hasClass("dropping") && !ui.draggable.prev().hasClass("dropping")) {
			//	$(this).animate({borderTopColor:"#777777",borderRightColor:"#777777",borderBottomColor:"#777777",borderLeftColor:"#777777"},50);					
			}
	    },
	    out: function() {
			$(this).removeClass("dropping");
			//$(this).animate({borderTopColor:"#FFFFFF",borderRightColor:"#FFFFFF",borderBottomColor:"#FFFFFF",borderLeftColor:"#FFFFFF"},50);
	    }
	});*/
	$('#bpe_area img,.contentImage img,.addVideoItem img').mousedown(function(event){event.preventDefault();  }).bind('dragstart', function(event) { event.preventDefault(); });
	$("body").css({
	                   '-moz-user-select':'none',
	                   '-webkit-user-select':'none',
	                   'user-select':'none',
	                   '-ms-user-select':'none'
	               });
	
};

function insertOrEditTable (text) {
	var editingtarget;
	var el;
	var classes = "";
	editingtarget=false;
	el=false;
	if ($(".bpe_highlight").length) {
		editingtarget = $(".bpe_highlight");		
		$(".itemTag",editingtarget).remove();
		classes = editingtarget.attr("class");
		classes = classes.replace("bpe_highlight","");
		classes = classes.replace("bpe_table","");				
	}
	if (text!="") {
		var table;
		$.ajax({
		  type: "POST",
		  url: "pageActions.php",
		  data: "pageAction=csv2html&text="+encodeURIComponent(text),
		  success: function(msg){
			if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				table = msg;
				if (text!="") {
					if (editingtarget) {
						editingtarget.before("<div class=\"bpe_table "+classes+"\" id=\""+editingtarget.attr("id")+"\">"+table+"</div>");
						editingtarget.remove();
					} else {
						$("#bpe_area").append("<div class=\"bpe_table "+classes+"\">"+table+"</div>");							
						$("body,html").animate({ scrollTop : $(document).height() }, 500);
					}
				} else {
					editingtarget.remove();
				}
				$(".bpe_help_popup").remove();
				$(".bpe_mask").remove();
				$(".bpe_add_popup").remove();
				$(".bpe_toggler").css("display","none");
				$(document).unbind("keypress");
				assignSaveListener();
				cancelDialogue();
				$.fn.bpeditor.clean(true);

		  }
		});
	} else {
		editingtarget.remove();
		$(".bpe_help_popup").remove();
		$(".bpe_curently_editing").removeClass("bpe_curently_editing");
		$(".bpe_mask").remove();
		$(".bpe_add_popup").remove();
		$(".bpe_toggler").css("display","none");
		$(document).unbind("keypress");
		assignSaveListener();
		$.fn.bpeditor.clean(true);
		cancelDialogue();
	}

}
function html2csv (text) {
	$.ajax({
	  type: "POST",
	  url: "pageActions.php",
	  data: "pageAction=html2csv&text="+encodeURIComponent(text),
	  success: function(msg){
		$("#popupDialogueField textarea").val(msg);
		}
	});
}
function addTableF ($this) {
	
	if ($this.hasClass("dragInsertItem")) {
		var t = LangVars.Add_Table;
		var editTableType="addTable";
	} else {

		if ($(".bpe_highlight").html()=="") {
			var t = LangVars.Add_Table;
			var editTableType="addTable";
		} else {
			var t = LangVars.Edit_Table;
			var editTableType="editTable";	
		}
		
	}
	prepDialogue("<h2>"+t+"</h2><p>"+LangVars.Edit_Table_Text+" <a href='#' id='showTableExample'>"+LangVars.Show_Example+"</a><p>",LangVars.Cancel,cancelDialogue,LangVars.Done,insertOrEditTable,false,true,true,editTableType);

}
function prepForInsert () {
//	$("p,h1,h2,h3,h4,h5,pre,li,.bpe_table,div.CMS_Component_Obs,.bpe_image","#bpe_area").unbind("click").unbind("dblclick");
	//$(".bpe_image,form,p,h1,h2,h3,h4,h5,pre,li,ul,ol,.bpe_table,div.CMS_Component_Obs,.bpe_split_divider",$("#bpe_area")).draggable( "destroy" );
	//$("#bpe_area").selectable("destroy");
	//$("#bpe_area .dropzone,.textEditingArea").droppable( "destroy" );
	hideDragInsert();
	$(document).unbind("keypress");
	$(document).unbind("keydown");
	$(document).unbind("keyup");
//	$(document).unbind("click");
//	$("body").unbind("click");
	$(".bpe_menu_contents").hide();
}
function updateImageLinkVal ($clicked) {
	var linkVal = $clicked.attr("alt");
	$("#newImageLink").val(linkVal);
	$("#newImageLink").parents(".imageContextEditFieldset").removeClass("showingLabel");
	$("#insertInteralLinksInline").hide();
	hidePopdownOrPassthroughSave(false);
}
function lightPagesHeight () {
	if ($("#mainWrapperObs .lightPagesList .pagesScroll").length) {
		var contentLength = $("#mainWrapperObs .lightPagesList .pagesScroll").height() + 50 + 43;
		var availHeight = $("body").height()-80;
		var availHeightMinusPadding = availHeight-50-43-43;
		if (contentLength > availHeight) {
			$("#mainWrapperObs .lightPagesList .pagesScroll").css("height",availHeightMinusPadding+"px");
		}		
	} else {
		var contentLength = $("#mainWrapperObs #downloadsPopdownInner .pagesScroll").height() + 50 + 43;
		var availHeight = $("body").height()-80;
		var availHeightMinusPadding = availHeight-50-43-43;
		if (contentLength > availHeight) {

			$("#mainWrapperObs #downloadsPopdownInner .pagesScroll").css("height",availHeightMinusPadding+"px");
			
		}
	}

	
}
function showHideMenusOnScroll ($this) {
	var st = $this.scrollTop();

	
	if ($(window).height()<400) {
		
		if (st > scrollDirectionTest){
			if ($this.scrollTop()>35) {
				$(".cleverFilterBar,.topBar").stop(true,true).fadeOut();
				$("#header").addClass("withBottomBorder");
			}
		} else {
			$(".cleverFilterBar,.topBar").stop(true,true).fadeIn();
			$("#header").removeClass("withBottomBorder");
		}
		scrollDirectionTest = st;	
	}
}
var scrollDirectionTest = 0;
function pagesScrollMailingListSubs() {
	assignRightPanePaginateEvent("newsletterActions.php","newsletterAction=showEmails&ajax=true&filterCat="+filterSubscribersByCategory+filterSubscribersByCategoryMatchAll+filterSubscribersByStatus+"&start=","#newsletterSubscribersPaneInner");
}
function pagesScrollBottomPane() {
	pagesScrollEvent("pages.php","ajax=true","#adminPages");
}
function pagesScrollBottomLightPages() {
	pagesScrollEvent("pages.php","ajax=true","#lightPagesListInner");
}
function pagesScrollBottomDownloads() {
	pagesScrollEvent("pageActions.php","pageAction=showMoreFiles&ajax=true","#downloadsPopdownInner");
}
function pagesScrollBottomDownloadsFiles() {
	pagesScrollEvent("pageActions.php","pageAction=showMoreFiles&ajax=true","#filesPaneInner");
}
function pagesScrollBottomSnippets() {
	pagesScrollEvent("snippetsActions.php","snippetsAction=page&rightPane=true","#snippetsPane");
}
function pagesScrollBottomBlog() {
	pagesScrollEvent("blogActions.php","blogAction=showEntries&rightPane=true&ajax=true","#blogPane");
}
function pagesScrollBottomProducts() {
	pagesScrollEvent("shopActions.php","shopAction=showProducts&ajax=true&pagination=true","#productsPane");
}
function pagesScrollBottomBookingProducts() {
	pagesScrollEvent("shopActions.php","shopAction=showBookingProducts&ajax=true&pagination=true","#bookingProductsPane");
}
function pagesScrollEvent (url,data,target) {

	var elem = $(target+' .pagesScroll');
	var inner = $(target+' .pagesScroll .insertTarget');

	var cutoff = inner.height()-100;

	
	var el = $(target+" .pagesScroll .showMoreItems");

	if (!el.length) {
		setTimeout(function() {
			scrollWaiting=false;
		}, 500);
		return false;
	}
	working();
	var start = parseInt(el.attr("href"));
	var startNo = start;
	if ($(target+" .pageFilterSearch").length && $(target+" .pageFilterSearch").val()!="" && $(target+" .pageFilterSearch").val()!=LangVars.Search) {
		start = "&search="+$(target+" .pageFilterSearch").val()+"&start="+start;
	} else {
		start = "&start="+start;
	}
	var $insertBefore = el.prev();
	var extra="";
	if (data.match("shopAction=showProducts")) {
		extra = "&filterCat="+filterProductsByCategory;
	}
	if (data.match("snippetsAction=showSnippets")) {
		extra = "&filterCat="+filterSnippetsByCategory;
	}
	$.ajax({
	  type: "POST",
	  url: url,
	  data: data+start+extra,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		setTimeout(function() {
			scrollWaiting=false;
		}, 500);
		if (msg=="") {
			el.remove();
		} else {
			$insertBefore.before("<div class='loaded'>"+msg+"</div>");


			if ($("#adminPages:visible").length) {
				assignSortableListItems($insertBefore.prev(),"listItemHighlight","responsiveListItem");						
				if ($("body").hasClass("selectingAll")) {
					$(target+" .responsiveListItem:not(.breadcrumbPage)").addClass("listItemHighlight");
				}
				selectionTools();
				$(".pagesScroll",$("#adminPages:visible")).lovelyScroll(pagesScrollBottomPane);
			} else {
				setTimeout(function () {
					if (typeof myScroll[elem.attr("id")] !='undefined') {
						myScroll[elem.attr("id")].refresh();						
					}

				}, 10);
			}

			if (data.match("snippetsAction=page")) {
				assignDragAssets($("#snippetsPaneInner .insertTarget .loaded"));
			}


			el.attr("href",startNo+50);

		}
		saved(true);

	  }
	});
		
}
function popdownPaginate (url,data,target) {
	var justFired = false;
	$(target+" .pagesScroll").scroll(function(){
		showHideMenusOnScroll($(this));
		
		justScrolled=true;
		if (scrollTimeout) {
			clearTimeout(scrollTimeout);
		}
		scrollTimeout = setTimeout(function() {
			justScrolled=false;
		},500);
		if (justFired) {
			return false;
		}
		setTimeout(function() {
			justFired=false;
		}, 1500);
		justFired=true;
		var elem = $(target+' .pagesScroll');
		var inner = $(target+' .pagesScroll .insertTarget');

		var cutoff = inner.height()-100;
		if ( elem.scrollTop() + elem.height() >= cutoff) {
			working();
			var el = $(target+" .pagesScroll .showMoreItems");
			var start = parseInt(el.attr("href"));
			var startNo = start;
			if ($(target+" .searchList").val()!="" && $(target+" .searchList").val()!=LangVars.Search) {
				start = "&search="+$(target+" .searchList").val()+"&start="+start;
			} else {
				start = "&start="+start;
			}
			var $insertBefore = el.prev();
			$.ajax({
			  type: "POST",
			  url: url,
			  data: data+start,
			  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

				if (msg=="") {
				} else {
					$insertBefore.before("<div>"+msg+"</div>");
					if ($("#adminPages:visible").length) {
						assignSortableListItems($insertBefore.prev(),"listItemHighlight","responsiveListItem");						
					}


					el.attr("href",startNo+50);

				}
				saved("Items Loaded");

			  }
			});
  		}
	});
}
function showDownloadPopdown (onClickFunction,title) {
	$("body").append(downloadsPopdown);
	$("#downloadsPopdownInner").html($("#downloads").html());

	if (!window.dropzoneFilePopdown) {
		window.dropzoneFilePopdown = new Dropzone("#downloadsPopdownInner",uploadFilePaneDZOptions($("#downloadsPopdownInner .uploadFile")[0]));
	} else {
		window.dropzoneFilePopdown.disable();
		window.dropzoneFilePopdown = new Dropzone("#downloadsPopdownInner",uploadFilePaneDZOptions($("#downloadsPopdownInner .uploadFile")[0]));
	}
	assignHeaderMenus();
	$("#downloadsPopdownTitle").html(title);
	$("#cancelPopdownDownloads").html(LangVars.Cancel);
	prepFancyLabelForms($(".filterBox",$("#downloadsPopdownInner")));
	rebindSearchList($("#downloadsPopdownInner"),"pageActions.php","pageAction=showMoreFiles&ajax=true","#downloadsPopdownInner");
	var minus = $("#downloadsPopdown").height();
	$("#downloadsPopdownOuter").css("opacity","1").css("visibility","visible");
	$("#downloadsPopdownInner .pagesScroll").lovelyScroll(pagesScrollBottomDownloads);
	$(document).unbind("keyup");
	$(window).trigger('resize');

	//$("#downloadsPopdown").animate({top:0},500);
	$("#downloadsPopdown").click(function(e){
		if ($(e.target)[0].nodeName.toLowerCase()=="input") {
			return false;
		}
		hide_header_menus();
		if ($(e.target).parents(".responsiveListItem").length) {
			onClickFunction($(e.target).parents(".responsiveListItem"));
			return false;
		}
		if ($(e.target).hasClass("responsiveListItem")) {
			onClickFunction($(e.target));
			return false;
		}


		return false;
	});
	
	$("#cancelPopdownDownloads").click(function(e){
		$(document).keyup(function(e){
			if (e.keyCode==27) {
				cancelDialogue();
				e.preventDefault();
			}
		});
		e.stopPropagation();
		if ($("#downloadsPopdown").length) {
			var minus = $("#downloadsPopdown").height();
			$("#downloadsPopdownOuter").animate({opacity:"0"},550,function(){
				$("#downloadsPopdownOuter").remove();
			});
			return false;
		}

	});
	
}
function hidePopdownOrPassthroughSave (passthroughFunction) {

	if ($(".bpe_mask_small").length) {
		return false;
	}
	if ($("#lightPagesList").length) {
		$("#lightPagesOuter").animate({opacity:"0"},550,function(){
			$("#lightPagesOuter").remove();
		});
		return false;
	}
	if ($("#downloadsPopdown").length) {
		var minus = $("#downloadsPopdown").height();
		$("#downloadsPopdownOuter").animate({opacity:"0"},550,function(){
			$("#downloadsPopdownOuter").remove();
		});
		return false;
	}
	passthroughFunction();
}
function showLightPages (onClickFunction,action,allowSubs,title) {
	$(document).unbind("keyup");
	$("body").append(lightPages);
	$("#lightPagesOuter").css("opacity","1");
	if ($(window).width()>1260) { 
		$("#lightPagesOuter").css("width",$("#launchPad").css("width"));
	}
	$("#lightPagesTitle").html(title);
	$("#cancelPopdown").html(LangVars.Cancel);
	$.ajax({
	  type: "POST",
	  url: "pageActions.php",
	  data: "pageAction="+action,
	  success: function(msg){
		if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			$("#lightPagesListInner").load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){

				if (action=="showTop") {
					$("#lightPagesListInner #nonLinkingPagesMain").hide();
				} else {
					$("#lightPagesListInner #mainMenuPagesMain").hide();					
				}
//				popdownPaginate("pages.php","ajax=true","#lightPagesListInner");
				assign_page_filter($("#lightPagesListInner"));		

			});
		}
	});
	$("#cancelPopdown").click(function(e){
		if ($("#lightPagesList:visible").length) {
			$(document).keyup(function(e){
				if (e.keyCode==27) {
					cancelDialogue();
					e.preventDefault();
				}
			});
		}
		e.stopPropagation();
		if ($("#lightPagesList").length) {
			$("#lightPagesOuter").animate({opacity:"0"},550,function(){
				$("#lightPagesOuter").remove();
			});
			return false;
		}
	});
	//var minus = $("#lightPagesList").height();
	$("#lightPagesList").css("visibility","visible");
	$("#lightPagesList").removeClass("dontAllowSubs");
	if (!allowSubs) {
		$("#lightPagesList").addClass("dontAllowSubs");
	}
	//$("#lightPagesList").animate({top:0},500);
	$("#lightPagesList").click(function(e){
		hide_header_menus();
		if ($(e.target).parents(".editPageBar").length || $(e.target).hasClass("editPageBar")) {
			if ($(e.target).parents(".editPageBar").length) {
				$this = $(e.target).parents(".editPageBar");
			} else {
				$this = $(e.target);
			}
			if ($(e.target).hasClass("backToMainPages")||$(e.target).parents().hasClass("backToMainPages")) {
			$.ajax({
			  type: "POST",
			  url: "pageActions.php",
			  data: "pageAction=showTop",
			  success: function(msg){
				if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

				$("#lightPagesListInner").load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){
					//popdownPaginate("pages.php","ajax=true","#lightPagesListInner");
					assign_page_filter($("#lightPagesListInner"));		
					saved();
				});
			  }
			});
			
			return false;
			}
			if (($(e.target).hasClass("showSubPages")||$(e.target).parents(".showSubPages").length)&&!$(e.target).hasClass("backToMainPages")) {
				working();
				if ($(e.target).parents(".showSubPages").length) {
					bits = $(e.target).parents(".showSubPages").attr("id").split("|");
				} else {
					bits = $(e.target).attr("id").split("|");	
				}
				
				var id = bits[0];
				var type = bits[1];
				$.ajax({
				  type: "POST",
				  url: "pageActions.php",
				  data: "pageAction=viewSubs&id="+id+"&type="+type,
				  success: function(msg){
					if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }

					$("#lightPagesListInner").load("pages.php?to_prevent_cache="+(new Date).getTime(),function(){
						//popdownPaginate("pages.php","ajax=true","#lightPagesListInner");
						assign_page_filter($("#lightPagesListInner"));		
						saved();
					});
				  }
				});
				return false;
			}
			logTrainingClick("choosePageOrDoneForWebsiteLink");
			onClickFunction($this);
			return false;

		}
		return false;
	});
}
function showOrderPopdown (content) {
	$("#dragBoundry").append(orderPopdown);
	if ($("#orderPopdownListInner .pagesScroll .lovelyScrollContents").length) {
		$("#orderPopdownListInner .pagesScroll .lovelyScrollContents").html(content.html());
	} else {
		$("#orderPopdownListInner .pagesScroll").html(content.html());		
	}

	$("#mainWrapperObs .orderPopdownList .customerAddress").autosize();

	var minus = $("#orderPopdownList").height();
	$("#orderPopdownTitle").text(LangVars.Order_Details);
	$("#cancelOrderPopdown").text(LangVars.Close)
	$("#orderPopdownList").css("top","-"+minus+"px").css("visibility","visible");
	$("#orderPopdownList").css("top","0");
//	$("#orderPopdownList").animate({top:0},500,function(){
//	$("#orderPopdownListInner .pagesScroll").lovelyScroll();
//	});

	$(window).trigger("resize");
	setTimeout(function () {
	$("#orderPopdownListInner .pagesScroll").lovelyScroll();		
	}, 400);


	
	$("#cancelOrderPopdown").click(function(e){
		
		if ($(e.target).hasClass("orderEmail")) {
			window.location=$(e.target).attr("href");
		} else {
			if ($("#orderPopdownOuter:visible").length) {
				var minus = $("#orderPopdownList").height();
				$("#orderPopdownList").animate({top:"-"+minus+"px"},550,function(){
					$("#orderPopdownOuter").remove();
				});
				return false;
			}
		}
		
		return false;
	});
}
var downloadsPopdown = $("<div id='downloadsPopdownOuter'><div id='downloadsPopdown'><div id='downloadsPopdownTitleBar'><span id='downloadsPopdownTitle'></span><span id='cancelPopdownDownloads'></span></div><div id='downloadsPopdownInset'><div id='downloadsPopdownInner'></div></div></div></div>");
var lightPages = $("<div id='lightPagesOuter'><div id='lightPagesList'><div id='lightPagesTitleBar'><span id='lightPagesTitle'></span><span id='cancelPopdown'></span></div><div id='lightPagesListInset'><div id='lightPagesListInner' class='lightPagesList'></div></div></div></div>");
var orderPopdown = $("<div id='orderPopdownOuter'><div id='orderPopdownList'><div id='orderPopdownTitleBar'><span id='orderPopdownTitle'></span><span id='cancelOrderPopdown'></span></div><div id='orderPopdownListInset'><div id='orderPopdownListInner' class='orderPopdownList'><div class='pagesScroll'></div></div></div></div></div>");
var newComponentDropship = "<div id='bpe_component_dropship'><div id='componentsList' class='clearfix'><div class='clearfix'></div></div></div>";
var newImage;
var newVideo;

function assign_click () {

	$("#mainWrapperObs #dragInsert li.dragInsertItem").draggable({
		appendTo: '#dragBoundry'
		,helper: 'clone'
		,zIndex: 1000
		,scroll: false
		,containment: "#dragBoundry"
		,refreshPositions:true
		,revert: 'invalid'
		,start: function () {
			if ($(this).hasClass("greyedOut"))  {
				return false;
			}
			if ($("body").hasClass("slideoverRightPane")) {
				$("#rightPaneMask").fadeOut();
				$("#dragInsert").fadeOut();
				$(".slideoverRightPane").removeClass("slideoverRightPane");				
			}
			if (!$("#bpe_area #bpe_text_dropship").length && !$("#bpe_area #bpe_image_dropship").length && !$("#bpe_area #bpe_component_dropship").length) {
			if ($(".assetPane:visible").length) {
				$("body").attr("drag-pane",$("body").attr("pane"));	
			}
			$("body").removeAttr("previous-pane");
			$("body").attr("pane","editContent");
			hideDragInsert();
			hideToolTips(false);
			}

		}
		,refreshPositions:true
		,drag: function(event, ui){
			// make .textEditingArea scroll when near top or bottom
				var topZoneTop = 0;
				var topZoneBottom = topZoneTop+160;
				var topZoneLeft = 0;
				var topZoneRight = topZoneLeft + $("#dragBoundry").width();

				var bottomZoneTop = $(window).height()-50;
				var bottomZoneBottom = $(window).height();
				var bottomZoneLeft = 0;
				var bottomZoneRight = $("#dragBoundry").width();

				var posTop = event.pageY - $("body").scrollTop();
				var posLeft = event.pageX;
				clearTimeout(lovelyScrollDrag);
				if (posTop > topZoneTop && posTop < topZoneBottom && posLeft > topZoneLeft && posLeft < topZoneRight) {
//					$(".textEditingArea").lovelyScrollMove(7);


					$("body,html").scrollTop($("body").scrollTop()-7);
					lovelyScrollDrag = setInterval(function(){
					$("body,html").scrollTop($("body").scrollTop()-7);
//						$(".textEditingArea").lovelyScrollMove(7);
					},30);
				}

				if (posTop > bottomZoneTop && posTop < bottomZoneBottom && posLeft > bottomZoneLeft && posLeft < bottomZoneRight) {
//					$(".textEditingArea").lovelyScrollMove(-7);
					$("body,html").scrollTop($("body").scrollTop()+7);
					lovelyScrollDrag = setInterval(function(){
						$("body,html").scrollTop($("body").scrollTop()+7);
//						$(".textEditingArea").lovelyScrollMove(-7);
					},30);
				}
		}
	});
	$("#bpe_selection_menu .showMenu").unbind().click(function(){
		$(document).unbind("keydown");
		/*$("#bpe_area").selectable("destroy");
		$(".ui-selectee").removeClass("ui-selectee");
		$(".ui-selected").removeClass("ui-selected");
		$(".ui-selectable").removeClass("ui-selectable");*/
		assign_sort();
		$("#renamePallet").remove();
		$(this).next().show();
		$("p,h1,h2,h3,h4,h5,pre,li,ul,ol,.bpe_image img","#bpe_area").unbind();
		return false;
	});
	$("#bpe_menu_init").unbind().click(function(){
		$(document).unbind("keydown");
		/*$("#bpe_area").selectable("destroy");
		$(".ui-selectee").removeClass("ui-selectee");
		$(".ui-selected").removeClass("ui-selected");
		$(".ui-selectable").removeClass("ui-selectable");*/
		assign_sort();
		$("#renamePallet").remove();
		$(this).next().show();
		$("p,h1,h2,h3,h4,h5,pre,li,ul,ol,.bpe_image img","#bpe_area").unbind();
		return false;
	});
	
	
	
	// add video 
	
	
	
	
	$(".bpe_upload_video").unbind("click");
	$(".bpe_upload_video").click(function(){
		//$(".bpe_menu_contents").hide();
		
		return false;
	});
	
	$(".bpe_add_youtube").unbind("click");
	$(".bpe_add_youtube").click(function(){
//			$(".bpe_menu_contents").hide();
		$(".drag").remove();
		$(".bpe_area_wrapper").addClass("bpe_curently_editing");
		images = $("#bpe_vids").html();
		$("body").append("<div class='bpe_mask_small'></div><div class='bpe_popup_small'><div class='bpe_popup_inner_small'><div class='bpe_popup_handle'></div><img src='graphics/bpeditor/help.png' alt='To upload a file to use on your website click the Choose file(s) to upload button. You will then see a window contianing the contents of your computer. Select more than one file by holding down the Command/Apple key on a mac or Control key in Windows.' class='bpe_help'/><h2>Upload New Video</h2><label class='bpe_label'>Enter YouTube video address:</label><input type='text' class='bpe_input' id='youtubeURL'/><div class='clear'></div><div id='add_video_thumb' style='display:block'><p>Choose a Click to play image: (Optional)</p><div class='upload_button_wrapper thumb'><span id='bpe_upload_button_thumb'></span></div><div class='files_selected thumb'></div><div class='uploader_wrapper thumb'><span class='upload_info thumb'><span class='upload_status thumb'>Uploading</span> file <span class='current_file thumb'></span> of <span class='total_files thumb'></span></span><div class='uploader thumb'><div class='uploaderInner thumb'></div></div></div><div class='clear'></div></div><div class='bpe_savecancel bpe_add_image_button' style='clear:both;'><a href='#' class='bpe_save'><span>Done</span></a><a href='#' class='bpe_cancel'><span>Cancel</span></a></div></div></div>");
		$(".bpe_mask_small,.bpe_popup_small").click(function(){return false;});
		//assign_help();
		init_youtube_thumb_uploader();

		$('.start_upload').fadeTo(0,0.5);
		$(".start_upload").addClass("disabled");
//			$('.bpe_save').fadeTo(0,0.5);
//			$(".bpe_save").addClass("disabled");

		$(".bpe_mask_small").css("height",$(document).height()+"px");
		$(".bpe_mask_small").fadeTo(0,0.4);
		height = $(".bpe_popup_small").height()+40
		otop = $(window).height()-height;
		otop = otop/2;
		otop = otop-30;
		var width = $(".bpe_popup_small").width()+40
		var left = $(window).width()-width;
		left = left/2;
		$(".bpe_popup_small").draggable({handle: ".bpe_popup_handle"});
		$(".bpe_popup_small").css("top",$(document).scrollTop()+otop+"px");
		$(".bpe_popup_small").css("left",left+"px");
		$(document).unbind("keypress");
		$(document).keypress(function (e) {
	      if (e.keyCode == 27) {
			if ($(".bpe_help_popup").length>0) {
				$(".bpe_help_popup").remove();
			} else {
				swfu.destroy();
				$(".bpe_popup_small").remove();
				$('.bpe_mask_small').remove();					
			}
			e.preventDefault();
	      }
	    });
		$(".bpe_save").click(function(){
			if (!$(this).hasClass("disabled")){
			/*	swfu.destroy();
				$(".bpe_help_popup").remove();
				$(".bpe_mask_small").remove();
				$(".bpe_popup_small").remove();
				$(".bpe_toggler").css("display","none");
				$(document).unbind("keypress");
				assignSaveListener();*/
			}
			return false;
		});
		$(".bpe_cancel").click(function(){
			swfu.destroy();
			$(".bpe_help_popup").remove();
			$(".bpe_mask_small").remove();
			$(".bpe_popup_small").remove();
			$(".bpe_toggler").css("display","none");
			$(document).unbind("keypress");
			assignSaveListener();
			return false;
		});
		return false;
	});

	//
	$(".bpe_add_table, .bpe_edit_table").unbind("click");
	$(".bpe_add_table, .bpe_edit_table").click(function(){
		addTableF($(this));
		
		return false;
	});
	//
	$(".bpe_add_text, .bpe_edit_menu").unbind("click");
	var dontClickIfVisible = "#bpe_text_dropship,#bpe_video_dropship,#bpe_image_dropship,#bpe_component_dropship,#bpe_invisible_dropship,.editingImage";
	$("#dragInsertP,#dragInsertH1,#dragInsertH2,#dragInsertH3,#dragInsertH4,#dragInsertUL,#dragInsertOL,#dragInsertPre").unbind("click").click(function(event){		
		if ($(dontClickIfVisible).length) {
			return false;
		}
		if ($(this).attr("id")=="dragInsertP") {
			var el = "p";
		}
		if ($(this).attr("id")=="dragInsertH1") {
			var el = "h1";
		}
		if ($(this).attr("id")=="dragInsertH2") {
			var el = "h2";
		}
		if ($(this).attr("id")=="dragInsertH3") {
			var el = "h3";
		}
		if ($(this).attr("id")=="dragInsertH4") {
			var el = "h4";
		}
		if ($(this).attr("id")=="dragInsertPre") {
			var el = "pre";
		}
		var oel = false;
		if ($(this).attr("id")=="dragInsertOL") {
			var el = "li";
			var oel = "ol";
		}
		if ($(this).attr("id")=="dragInsertUL") {
			var el = "li";
			var oel = "ul";
		}
		if (!ignoreClickCatchup) {
			hidePanes();
			$(".bpe_highlight").removeClass("bpe_highlight");
			$(".bpe_toggler").hide();
			
			var newText=$("<"+el+" class='bpe_highlight addText'></"+el+">");
			
			$("#bpe_area").append(newText);
			addText(newText,oel);				
		}
		return false;
	});
	
	$("#dragInsertImage").unbind("click").click(function(){
		if ($(this).hasClass("greyedOut")) {
			return false;
		}
		if ($(dontClickIfVisible).length) {
			return false;
		}
		if (!ignoreClickCatchup) {
			hidePanes();
			
			prepForInsert();
			$("#bpe_area").append(newImage);
			dragImage();
			$(".textEditingArea").animate({ scrollTop : $("#bpe_area").height() }, 500);
		}
	
		return false;
	});
	$("#dragInsertTable").unbind("click").click(function(){
		if ($(dontClickIfVisible).length) {
			return false;
		}
		if (!ignoreClickCatchup) {
			hidePanes();
			
			addTableF($(this));
		}
		return false;
	});
	
	$(".drag_insert_subscribe").unbind("click").click(function(){
			addComponent("ComponentNewsletter-"+$(this).attr("group-id"),"<strong>"+LangVars.Mailing_List_Subscribe+":</strong> "+$(this).attr("title"),$(this));
			$.fn.bpeditor.clean(true);
			$(".textEditingArea").animate({ scrollTop : $("#bpe_area").height() }, 500);
			setTimeout(function() {
				$("#bpe_area .CMS_Component_Obs:last").addClass("bpe_highlight");
			}, 10);
	});
	/*
	$(".dragInsertComponent").unbind("click").click(function(){
		if ($(this).hasClass("greyedOut")) {
			return false;
		}
		if ($(dontClickIfVisible).length) {
			return false;
		}
		if (!ignoreClickCatchup) {
			hidePanes();
			
			prepForInsert();
			$("#bpe_area").append(newComponentDropship);
			dragComponent($(this).attr("rel"));
			setTimeout(function() {
				$(".textEditingArea").animate({ scrollTop : $("#bpe_area").height() }, 500);
			}, 10);

		}
	
		return false;
	});
	$(".dragInsertCustom").unbind("click").click(function(){
		if ($(this).hasClass("greyedOut")) {
			return false;
		}
		if ($(dontClickIfVisible).length) {
			return false;
		}
		if (!ignoreClickCatchup) {
			hidePanes();
			prepForInsert();
			
			if ($(this).attr("zones")=="") {
				addComponent("ComponentCustom-"+$(this).attr("data-tpl"),"<strong>"+LangVars.Extra+":</strong> "+$(this).html(),false);				
			} else {
				if ($(this).parents(".CMS_Component_ObsZones").length) {
					error(LangVars.Error_Cant_Nest_Editable_Zones);
					hide_menus();
					$.fn.bpeditor.clean(true);
				} else{
					addComponentWithZones("ComponentCustomZones-"+$(this).attr("data-tpl"),$(this).html(),$(this).parent(),$(this).attr("zones"));					
				}
				
			}
			$.fn.bpeditor.clean(true);
			$(".textEditingArea").animate({ scrollTop : $("#bpe_area").height() }, 500);
			setTimeout(function() {
				$("#bpe_area .CMS_Component_Obs:last").addClass("bpe_highlight");
			}, 10);
			

		}
	
		return false;
	});
	$(".dragInsertColumns").unbind("click").click(function(){
		if ($(this).hasClass("greyedOut")) {
			return false;
		}
		if ($(dontClickIfVisible).length) {
			return false;
		}
		if (!ignoreClickCatchup) {
			hidePanes();
			hideDragInsert();
			prepForInsert();

			if ($(this).parents(".CMS_Component_ObsZones").length) {
				error(LangVars.Error_Cant_Nest_Editable_Zones);
				hide_menus();
				$.fn.bpeditor.clean(true);
			} else{
				addComponentWithZones("ComponentColumnsZones-"+$(this).attr("data-tpl"),$(this).html(),$(this).parent(),$(this).attr("zones"));					
			}
			
			$.fn.bpeditor.clean(true);
			$(".textEditingArea").animate({ scrollTop : $("#bpe_area").height() }, 500);
			setTimeout(function() {
				$("#bpe_area .CMS_Component_Obs:last").addClass("bpe_highlight");
			}, 10);
			

		}
	
		return false;
	});*/
	/*
	$(".dragInsertSection").unbind("click").click(function(){
		if ($(this).hasClass("greyedOut")) {
			return false;
		}
		if ($(dontClickIfVisible).length) {
			return false;
		}
		if (!ignoreClickCatchup) {
			hidePanes();
			prepForInsert();
			hideDragInsert();
			$("#bpe_area").append("<div class=\"bpe_split_divider tooltipTarget "+$(this).attr("data-tpl")+"\" alt=\""+$(this).attr("data-tpl")+"\">"+$(this).html()+"</div>");

			$.fn.bpeditor.clean(true);
			$(".textEditingArea").animate({ scrollTop : $("#bpe_area").height() }, 500);
			$("#dragSectionItems .bpe_menu_sub").each(function(){
				if ($("#bpe_area ."+$(this).attr("data-tpl")).length) {
					$(this).addClass("greyedOut");
				}
			});
			if (currentTooltip) {
				interuptedChains.push({currentTooltip:currentTooltip,currentTooltipItem:currentTooltipItem});
				clearTimeout(toolTipTimeout);
			}
			currentTooltipItem=0;
			currentTooltip="section";
			toolTipTimeout = setTimeout(tooltip, 500);
		}
	
		return false;
	});*/
	$("#dragInsertCheckout").unbind("click").click(function(){
		if ($(dontClickIfVisible).length) {
			return false;
		}
		hidePanes();
		
		addComponent("ComponentShoppingBasket","<strong>"+LangVars.Core+":</strong> "+LangVars.Checkout+"</strong>",$(this));
		hide_menus();
		$.fn.bpeditor.clean(true);
		$(".textEditingArea").animate({ scrollTop : $("#bpe_area").height() }, 500);
		setTimeout(function() {
			$("#bpe_area .CMS_Component_Obs:last").addClass("bpe_highlight");
		}, 10);
	});
	$("#dragInsertBlog").unbind("click").click(function(){
		if ($(dontClickIfVisible).length) {
			return false;
		}
		if ($("#bpe_area .ComponentBlog").length) {
			error(LangVars.Blog_Already_On_Page);
			return false;
		}
		
		hidePanes();
		logTrainingClick("addBlogItem");
		addComponent("ComponentBlog","<strong>"+LangVars.Core+":</strong> "+LangVars.Blog+"",$(this));
		hide_menus();
		$.fn.bpeditor.clean(true);
		$(".textEditingArea").animate({ scrollTop : $("#bpe_area").height() }, 500);
		setTimeout(function() {
			$("#bpe_area .CMS_Component_Obs:last").addClass("bpe_highlight");
		}, 10);
	});
	$("#dragInsertSitemap").unbind("click").click(function(){
		if ($(dontClickIfVisible).length) {
			return false;
		}
		hidePanes();
		
		addComponent("ComponentSitemap","<strong>"+LangVars.Core+":</strong> "+LangVars.Sitemap+"</strong>",$(this));
		hide_menus();
		$.fn.bpeditor.clean(true);
		$(".textEditingArea").animate({ scrollTop : $("#bpe_area").height() }, 500);
		setTimeout(function() {
			$("#bpe_area .CMS_Component_Obs:last").addClass("bpe_highlight");
		}, 10);
	});
};
function init_vid_uploader () {
	
	$(".start_upload:not(.disabled,.thumb)").click(function(){
		var width = $('.width_input').val();
		keepaliveok=false;
		swfu_vid.startUpload();
		return false;
	});
	
	function uploadProgress(file, bytesLoaded) {
		try {
			var percent = Math.ceil((bytesLoaded / file.size) * 100);
			$(".uploader:not(.thumb)").css("backgroundPosition","-"+percent+"% 2px");
		} catch (ex) {
			this.debug(ex);
		}
	}
	
	function fileDialogComplete (numFilesSelected, numFilesQueued) {
		if (numFilesQueued == 1) {
			$(".files_selected:not(.thumb)").html(LangVars.Selected+": 1");
			$(".start_upload:not(.thumb)").removeClass("disabled");
			$('.start_upload:not(.thumb)').fadeTo(0,1);
			$(".total_files:not(.thumb)").html(numFilesQueued);
		} else if (numFilesQueued > 1) {
			$(".files_selected:not(.thumb)").html(LangVars.Selected+": "+numFilesQueued);				
			$(".start_upload:not(.thumb)").removeClass("disabled");
			$('.start_upload:not(.thumb)').fadeTo(0,1);
			$(".total_files:not(.thumb)").html(numFilesQueued);
		}
	}
	var aborted = false;
	function uploadStart (file) {
		var total = $(".total_files:not(.thumb)").html();
		var queued = this.getStats().files_queued;
		var current = total-queued+1;
		if (parseFloat(file.size) > parseFloat($("#maxUploadSize").val())){
			//var m = parseFloat($("#maxUploadSize").val())/1024;
			//m = m/1024;
			error(LangVars.File_Too_Large);
			swfu_vid.cancelQueue();
			aborted=true;
			return false;
		}
		aborted=false;
		$(".uploader_wrapper:not(.thumb)").slideDown(500);
		$(".uploader:not(.thumb)").css("backgroundPosition","-0% 2px");
		$(".bpe_save:not(.thumb)").addClass("disabled");
		$('.bpe_save:not(.thumb)').fadeTo(0,0.5);
		$(".current_file:not(.thumb)").html(current);
		swfu_vid.refreshCookies();
	}
	function uploadComplete () {
		$(".uploader:not(.thumb)").css("backgroundPosition","-100% 2px");
		if (this.getStats().files_queued === 0) {
			if (aborted==false) {
				$(".bpe_save:not(.thumb)").removeClass("disabled");
				$('.bpe_save:not(.thumb)').fadeTo(0,1);	
				$(".upload_status:not(.thumb)").html(LangVars.Completed);
				swfu_vid.destroy();
				$("#upload_video_buttons").hide();
				init_vid_thumb_uploader();					
			}
			
		} else {
			swfu_vid.startUpload();
		}
	}
	function uploadSuccess (file, serverData, receivedResponse) {
		keepaliveok=true;
		if (serverData=="limit") {
			error(LangVars.Storage_Limit_Reached);
			swfu_vid.cancelQueue();
			aborted=true;
		} else {
			if (this.getStats().files_queued === 0) {
			
			$("#videoList").load("mediaActions.php?mediaAction=show&to_prevent_cache="+(new Date).getTime(),function(){
				$("#bpe_dropship_videos").html($("#videoList").html());
				$("#addedVideo").val(serverData);
				$("#videosPaneInner .insertTarget").html($("#videoList").html());
				$("#videosPaneInner").lovelyScroll();
				
			});
			$("#add_video_thumb").show();
//			$("#upload_video_buttons").hide();
			}
		}
	}
	swfu_vid = new SWFUpload({
		upload_url : "/admin/mediaActions.php",
		flash_url : "javascripts/swfupload.swf",
		post_params: {"mediaAction" : "addItem"},
		file_size_limit : "0",
		file_types : "*.mp4;*.flv;*.mov;*.m4v",
		file_types_description : "Video Files",
		file_upload_limit : 100,
		file_queue_limit : 0,
		custom_settings : {
			progressTarget : "fsUploadProgress",
			cancelButtonId : "btnCancel"
		},
		debug: false,
		file_post_name: "file",
		// Button settings
		button_image_url: "graphics/uploadButton.png",
		button_width: "193",
		button_height: "21",
		button_placeholder_id: "bpe_upload_button",
		button_text: '<span class="theFont">Choose file to upload</span>',
		button_text_style: ".theFont { font-size: 12; text-align: center; color:#FFFFFF; font-family:Arial; } .theFont:hover { background:none; }",
		button_text_left_padding: 0,
		button_text_top_padding: 1,
		button_window_mode: "transparent",
		button_cursor: SWFUpload.CURSOR.HAND,
		button_action : SWFUpload.BUTTON_ACTION.SELECT_FILE,
		// The event handler functions are defined in handlers.js
		//file_queued_handler : fileQueued,
		//file_queue_error_handler : fileQueueError,
		file_dialog_complete_handler : fileDialogComplete,
		upload_start_handler : uploadStart,
		upload_progress_handler : uploadProgress,
//			upload_error_handler : uploadError,
		upload_success_handler : uploadSuccess,
		upload_complete_handler : uploadComplete,
		//queue_complete_handler : queueComplete	// Queue plugin event
	});
}
function init_vid_thumb_uploader () {

	$(".start_upload.thumb").click(function(){
		if (!$(this).hasClass("disabled")) {
			swfu.addPostParam("mediaId",$("#addedVideo").val());
			swfu.startUpload();
		}
		
		return false;
	});
	
	function uploadProgress_thumb(file, bytesLoaded) {
		try {
			var percent = Math.ceil((bytesLoaded / file.size) * 100);
			$(".uploader.thumb").css("backgroundPosition","-"+percent+"% 2px");
		} catch (ex) {
			this.debug(ex);
		}
	}
	
	function fileDialogComplete_thumb (numFilesSelected, numFilesQueued) {
		if (numFilesQueued == 1) {
			$(".files_selected.thumb").html(LangVars.Selected+": 1");
			$(".start_upload.thumb").removeClass("disabled");
			$('.start_upload.thumb').fadeTo(0,1);
			$(".total_files.thumb").html(numFilesQueued);
		} else if (numFilesQueued > 1) {
			$(".files_selected.thumb").html(LangVars.Selected+": "+numFilesQueued);				
			$(".start_upload.thumb").removeClass("disabled");
			$('.start_upload.thumb').fadeTo(0,1);
			$(".total_files.thumb").html(numFilesQueued);
		}
	}
	aborted=false;
	function uploadStart_thumb (file) {
		var total = $(".total_files.thumb").html();
		var queued = this.getStats().files_queued;
		var current = total-queued+1;
		if (parseFloat(file.size) > parseFloat($("#maxUploadSize").val())){
			//var m = parseFloat($("#maxUploadSize").val())/1024;
			//m = m/1024;
			error(LangVars.File_Too_Large);
			swfu.cancelQueue();
			aborted=true;
			return false;
		}
		aborted=false;
		$(".uploader_wrapper.thumb").slideDown(500);
		
		$(".uploader.thumb").css("backgroundPosition","-0% 2px");
		
		$(".bpe_save").addClass("disabled");
		$('.bpe_save').fadeTo(0,0.5);
		
		$(".current_file.thumb").html(current);
		swfu.refreshCookies();
	}
	function uploadComplete_thumb () {
		$(".uploader.thumb").css("backgroundPosition","-100% 2px");
		if (this.getStats().files_queued === 0) {
			if (aborted==false) {
			$(".bpe_save").removeClass("disabled");
			$('.bpe_save').fadeTo(0,1);	
			$(".upload_status.thumb").html(LangVars.Completed);
			}
		} else {
			swfu.startUpload();
		}
	}
	function uploadSuccess_thumb (file, serverData, receivedResponse) {
		if (serverData=="limit") {
			error(LangVars.Storage_Limit_Reached);
			swfu.cancelQueue();
			aborted=true;
		} else {
			if (this.getStats().files_queued === 0) {
				$("#videoList").load("mediaActions.php?mediaAction=show&to_prevent_cache="+(new Date).getTime(),function(){
					$("#bpe_dropship_videos").html($("#videoList").html());
					$("#addedVideo").val(serverData);
					$("#videosPaneInner .insertTarget").html($("#videoList").html());
					$("#videosPaneInner").lovelyScroll();
				});
			}
		}
	}
	swfu = new SWFUpload({
		upload_url : "/admin/mediaActions.php",
		flash_url : "javascripts/swfupload.swf",
		post_params: {"mediaAction" : "addThumb"},
		file_size_limit : "0",
		button_window_mode: "transparent",
		file_types : "*.jpg;*.gif;*.jpeg;*.png",
		file_types_description : "Image Files",
		file_upload_limit : 100,
		file_queue_limit : 0,
		debug: false,
		file_post_name: "image",
		// Button settings
		button_image_url: "graphics/uploadButton.png",
		button_width: "193",
		button_height: "21",
		button_placeholder_id: "bpe_upload_button_thumb",
		button_text: '<span class="theFont">Choose file to upload</span>',
		button_text_style: ".theFont { font-size: 12; text-align: center; color:#FFFFFF; font-family:Arial; } .theFont:hover { background:none; }",
		button_text_left_padding: 0,
		button_text_top_padding: 1,
		button_cursor: SWFUpload.CURSOR.HAND,
		button_action : SWFUpload.BUTTON_ACTION.SELECT_FILE, 
		// The event handler functions are defined in handlers.js
		//file_queued_handler : fileQueued,
		//file_queue_error_handler : fileQueueError,
		file_dialog_complete_handler : fileDialogComplete_thumb,
		upload_start_handler : uploadStart_thumb,
		
		upload_progress_handler : uploadProgress_thumb,
		//upload_error_handler : uploadError,
		upload_success_handler : uploadSuccess_thumb,
		upload_complete_handler : uploadComplete_thumb,
		//queue_complete_handler : queueComplete	// Queue plugin event
	});
}
function init_youtube_thumb_uploader () {
	$(".bpe_save").click(function(){
		if (!$(this).hasClass("disabled")) {
			if (swfu.getStats().files_queued == 0) {
				$.ajax({
				  type: "POST",
				  url: "mediaActions.php",
				  data: "mediaAction=addItem&filenameText="+$("#youtubeURL").val(),
				  success: function(msg){
					swfu.destroy();
					$(".bpe_help_popup").remove();
					$(".bpe_mask_small").remove();
					$(".bpe_popup_small").remove();
					$(".bpe_toggler").css("display","none");
					$(document).unbind("keypress");
					assignSaveListener();
					$(".bpe_videos").load("mediaActions.php?mediaAction=show&to_prevent_cache="+(new Date).getTime(),function(){
						//assignVideos();
						assign_click();
						//assign_menus($(".bpe_videos"));
					});
				  }
				});
			} else {
				swfu.addPostParam("filenameText",$("#youtubeURL").val());
				swfu.startUpload();
				
			}
		}
		
		return false;
	});
	
	function uploadProgress_thumb(file, bytesLoaded) {
		try {
			var percent = Math.ceil((bytesLoaded / file.size) * 100);
			$(".uploader.thumb").css("backgroundPosition","-"+percent+"% 2px");
		} catch (ex) {
			this.debug(ex);
		}
	}
	
	function fileDialogComplete_thumb (numFilesSelected, numFilesQueued) {
		if (numFilesQueued == 1) {
			$(".files_selected.thumb").html(LangVars.Selected+": 1");
			$(".start_upload.thumb").removeClass("disabled");
			$('.start_upload.thumb').fadeTo(0,1);
			$(".total_files.thumb").html(numFilesQueued);
		} else if (numFilesQueued > 1) {
			$(".files_selected.thumb").html(LangVars.Selected+": "+numFilesQueued);				
			$(".start_upload.thumb").removeClass("disabled");
			$('.start_upload.thumb').fadeTo(0,1);
			$(".total_files.thumb").html(numFilesQueued);
		}
	}
	var aborted=false;
	function uploadStart_thumb (file) {
		total = $(".total_files.thumb").html();
		queued = this.getStats().files_queued;
		current = total-queued+1;
		if (parseFloat(file.size) > parseFloat($("#maxUploadSize").val())){
			//var m = parseFloat($("#maxUploadSize").val())/1024;
			//m = m/1024;
			error(LangVars.File_Too_Large);
			swfu.cancelQueue();
			aborted=true;
			return false;
		}
		aborted=false;
		$(".uploader_wrapper.thumb").slideDown(500);

		$(".uploader.thumb").css("backgroundPosition","-0% 2px");

		$(".bpe_save").addClass("disabled");
		$('.bpe_save').fadeTo(0,0.5);
		
		$(".current_file.thumb").html(current);
		swfu.refreshCookies();
	}
	function uploadComplete_thumb () {
		$(".uploader.thumb").css("backgroundPosition","-100% 2px");
		if (this.getStats().files_queued === 0) {
			if (aborted==false) {
			$(".bpe_save").removeClass("disabled");
			$('.bpe_save').fadeTo(0,1);	
			$(".upload_status.thumb").html(LangVars.Completed);
			}
		} else {
			swfu.startUpload();
		}
	}
	function uploadSuccess_thumb (file, serverData, receivedResponse) {
		if (serverData=="limit") {
			error(LangVars.Storage_Limit_Reached);
			swfu.cancelQueue();
			aborted=true;
		} else {
			if (this.getStats().files_queued === 0) {
				swfu.destroy();
				$(".bpe_help_popup").remove();
				$(".bpe_mask_small").remove();
				$(".bpe_popup_small").remove();
				$(".bpe_toggler").css("display","none");
				$(document).unbind("keypress");
				assignSaveListener();
				$(".bpe_videos").load("mediaActions.php?mediaAction=show&to_prevent_cache="+(new Date).getTime(),function(){
					//assignVideos();
					assign_click();
					//assign_menus($(".bpe_videos"));
				});
				$(".bpe_videos").load("mediaActions.php?mediaAction=show&to_prevent_cache="+(new Date).getTime(),function(){
					//assignVideos();
					assign_click();
					//assign_menus($(".bpe_videos"));
				});
			}
		}
	}
	swfu = new SWFUpload({
		upload_url : "/admin/mediaActions.php",
		flash_url : "javascripts/swfupload.swf",
		post_params: {"mediaAction" : "addItem"},
		file_size_limit : "0",
		file_types : "*.jpg;*.gif;*.jpeg;*.png",
		file_types_description : "Image Files",
		file_upload_limit : 100,
		file_queue_limit : 0,
		debug: false,
		file_post_name: "image",
		button_window_mode: "transparent",
		// Button settings
		button_image_url: "graphics/uploadButton.png",
		button_width: "193",
		button_height: "21",
		button_placeholder_id: "bpe_upload_button_thumb",
		button_text: '<span class="theFont">Choose file to upload</span>',
		button_text_style: ".theFont { font-size: 12; text-align: center; color:#FFFFFF; font-family:Arial; } .theFont:hover { background:none; }",
		button_text_left_padding: 0,
		button_text_top_padding: 1,
		button_cursor: SWFUpload.CURSOR.HAND,
		button_action : SWFUpload.BUTTON_ACTION.SELECT_FILE, 
		// The event handler functions are defined in handlers.js
		//file_queued_handler : fileQueued,
		//file_queue_error_handler : fileQueueError,
		file_dialog_complete_handler : fileDialogComplete_thumb,
		upload_start_handler : uploadStart_thumb,
		
		upload_progress_handler : uploadProgress_thumb,
		//upload_error_handler : uploadError,
		upload_success_handler : uploadSuccess_thumb,
		upload_complete_handler : uploadComplete_thumb,
		//queue_complete_handler : queueComplete	// Queue plugin event
	});
}

function miniSearchStart (obj) {
	if ($(window).width()<0) {
		$(".showLeftPane:visible,.topBarTitle:visible,.topBarButtonBack:visible,.topBarButtonSwap:visible",obj).fadeOut().addClass("fadeBack");
		obj.css("padding-left","7px");
		var w = obj.width();
		w = w-10;
		$(".filterBox").animate({width:w+"px"});
		
		obj.addClass("showingMini");
	}
}
function miniSearchStop (obj) {
	if (obj.hasClass("showingMini")) {
		$(".fadeBack",obj).fadeIn().removeClass("fadeBack");

		if (!obj.hasClass("showingMini")) {
			obj.css("padding-left","40px");			
		}

		obj.removeClass("showingMini");
		$(".filterBox").animate({width:"100px"});
	}
}
function assignPaneSearch ($input,url,data,type) {
	/*
	$input.unbind("focus").focus(function(){
		miniSearchStart($input.parents(".topBar"));
		$(document).unbind("keyup");
		$(document).unbind("keydown");
		$(document).unbind("keypress");
		if ($(this).val()==LangVars.Search) {
			$(this).val("");
		}
	});
	*/
		$input.blur(function(){
		/*miniSearchStop($input.parents(".topBar"));
		if ($(this).val()=="") {
			$(this).val(LangVars.Search);
		}*/
		if (type=="image") {
			assignImagesKeys();
		}
		if (type=="product") {
			assignProductsKeys();
		}
		if (type=="snippet") {
			assignSnippetsKeys();
		}
		if (type=="file") {
			assignFilesKeys();
		}
		if (type=="newsletterSubscribers") {
			assignNewsletterSubscribersKeys();
		}
		if (type=="blog") {
			assignBlogKeys();
		}
	});

	function submitSearch (clicked) {
		working();
		var string = clicked.val();
		var extra="";
		if (data.match("shopAction=showProducts")) {
			extra = "&filterCat="+filterProductsByCategory;
		}
		$.ajax({
		  type: "POST",
		  url: url,
		  data: data+string+extra,
		  success: function(msg){
			
			if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				if (type=="image") {
						hide_header_menus();
					$("#imagesPaneInner .insertTarget").html(msg);
					assignDragAssets($("#imagesPaneInner .insertTarget"));
					if (!($("body").hasClass("storageDraggable"))) {
						assignSortableListItems($("#imagesPaneInner"),"listItemHighlight","contentImage");		
					}
					if (string!="") {
						$("#imagesPane .sendMe").hide();
						$("#imagesPane .clearSearch").show();
						$("#imagesPane .searchSVG").parent().addClass("searching");
					} else {
						$("#imagesPane .searchSVG").parent().removeClass("searching");
					}
					$("#imagesPaneInner").lovelyScroll(scrollImagesBottom);
					prepFancyLabelForms($("#imagesPane .filterBox"));

					

				}
				if (type=="product") {
					$("#productsPaneInner .insertTarget").html(msg);
					assignDragAssets($("#productsPaneInner .insertTarget"));
					hide_header_menus();
					if (string!="") {
						$("#productsPane .sendMe").hide();
						$("#productsPane .clearSearch").show();
						$("#productsPane .searchSVG").parent().addClass("searching");
					} else {
						$("#productsPane .searchSVG").parent().removeClass("searching");
					}
					prepFancyLabelForms($("#productsPane .filterBox"));
					$("#productsPaneInner").lovelyScroll();
				}
				if (type=="snippet") {
					$("#snippetsPaneInner .insertTarget").html(msg);
					assignDragAssets($("#snippetsPaneInner .insertTarget"));
					hide_header_menus();
					if (string!="") {
						$("#snippetsPane .sendMe").hide();
						$("#snippetsPane .clearSearch").show();
						$("#snippetsPane .searchSVG").parent().addClass("searching");
					} else {
						$("#snippetsPane .searchSVG").parent().removeClass("searching");
					}
					prepFancyLabelForms($("#snippetsPane .filterBox"));
				}
				if (type=="file") {
					$("#filesPaneInner .insertTarget").html(msg);
					assignDragAssets($("#filesPaneInner .insertTarget"));
					hide_header_menus();
					if (string!="") {
						$("#filesPaneInner .sendMe").hide();
						$("#filesPaneInner .clearSearch").show();
						$("#filesPaneInner .searchSVG").parent().addClass("searching");
					} else {
						$("#filesPaneInner .searchSVG").parent().removeClass("searching");
					}
					prepFancyLabelForms($("#filesPaneInner .filterBox"));
				}
				if (type=="newsletterSubscribers") {
					hide_header_menus();
					if (string!="") {
						$("#newsletterSubscribersPane .sendMe").hide();
						$("#newsletterSubscribersPane .clearSearch").show();
						$("#newsletterSubscribersPane .searchSVG").parent().addClass("searching");
					} else {
						$("#newsletterSubscribersPane .searchSVG").parent().removeClass("searching");
					}
					prepFancyLabelForms($("#rightPaneNewsletterSubscribers .filterBox"));

					$("#newsletterSubscribersPaneInner .insertTarget").load("newsletterActions.php?newsletterAction=showEmails&showPane=&to_prevent_cache="+(new Date).getTime(),function(){
						$("#newsletterSubscribersPaneInner").lovelyScroll();
					});
				}
				if (type=="blog") {
					$("#blogPaneInner .insertTarget").load("blogActions.php?blogAction=showEntries&showPane=&to_prevent_cache="+(new Date).getTime(),function(){
						$("#blogPane > .paneContents > .cleverFilterBar .langFilterMenu").remove();
						$("#blogPane > .paneContents > .cleverFilterBar .blogSearchMenu").remove();
						$("#blogPaneInner .blogSearchMenu").insertBefore("#blogPane > .paneContents > .cleverFilterBar .primaryItem");
						$("#blogPaneInner .langFilterMenu").insertAfter("#blogPane > .paneContents > .cleverFilterBar .primaryItem");
						assignBlogFilterBar();
						$("#blogPaneInner").lovelyScroll(pagesScrollBottomBlog);
					});
				}
				
				saved();
		  }
		});
	}
	$input.parents("form").submit(function(){
		submitSearch($(".focus",$(this)));
		return false;
	});
	/*
	$input.keyup(function(e){
		
		if (e.which==13) {
			submitSearch($(this));
			if (!$(this).prev().hasClass("clearSearch") && $(this).val()!="") {
				$(this).before("<img src=\"/admin/graphics/bpeditor/remove_menu_item_off.png\" class=\"clearSearch\" id='clearSearch'/>");	
			}
			if ($(this).val()=="") {
				$input.val(LangVars.Search);
			}
				
			
		}
	});*/
	$input.parents(".filterBox").click(function(e){

		if ($(e.target).hasClass("clearSearch")) {
			$input.val("");
			submitSearch($input);
			$(e.target).hide();
			if (type=="image") {
				assignImagesKeys();
			}
		}
		return false;
	});
	
}


function rotateGalleryImage () {
	var imagesJson = "[";
	$(".listItemHighlight").each(function(){
		if (imagesJson=="[") {
			imagesJson+='"'+$(this).attr("title")+'"';
		} else {
			imagesJson+=',"'+$(this).attr("title")+'"';
		}		
	});
	imagesJson += "]";
	working();
	$.ajax({
	  type: "POST",
	  url: "galleriesActions.php",
	  data: "galleriesAction=rotateImages&images="+imagesJson,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		
		$(".listItemHighlight").each(function(){
			var srcImg = "/images/galleries/thumbs/"+$(this).attr("title");	
			$(".responsiveListItemImage",$(this)).attr("style","background: url('"+srcImg+"&d="+(new Date).getTime()+"') 50% 50% no-repeat;background-size:50px 50px;");
			selectionTools();
		});
		saved("Images rotated");

	  }
	});
}
function rotateImage () {
	var imagesJson = "[";
	$(".listItemHighlight").each(function(){
		if (imagesJson=="[") {
			imagesJson+='"'+$(this).attr("id")+'"';
		} else {
			imagesJson+=',"'+$(this).attr("id")+'"';
		}		
	});
	imagesJson += "]";
	working();
	$.ajax({
	  type: "POST",
	  url: "pageActions.php",
	  data: "pageAction=rotateImages&ids="+imagesJson,
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		
		$(".listItemHighlight").each(function(){
			var srcImg = $(this).attr("data-filename");	
			$(".responsiveListItemImage",$(this)).attr("style","background: url('/images/"+srcImg+"&d="+(new Date).getTime()+"') 50% 50% no-repeat;background-size:50px 50px;");
			selectionTools();
		});

		saved("Images rotated");

	  }
	});
}
function scrollImagesBottom() {
	var el = $("#imagesPaneInner .showMoreImages").last();
	if (!el.length) {
		return false;
	}
	var start = parseInt(el.attr("href"));
	if ($("#imagePalletFilter").length) {
		var search = $("#imagePalletFilter").val();				
	} else {
		var search = $("#rightPaneImages .searchList").val();
	}
	working();
	$.ajax({
		  type: "POST",
		  url: "pageActions.php",
		  data: "pageAction=showMoreImages&start="+start+"&search="+search,
		  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			
			if (msg=="") {
				el.remove();
			} else {
				el.prev().before(msg);
				
				assignDragAssets($("#imagesPaneInner .insertTarget"));
				$("#imagesPaneInner").lovelyScroll(scrollImagesBottom);

				setTimeout(function() {
					scrollWaiting=false;
				}, 500);
				
				el.attr("href",start+50);
			}
			saved("Images Loaded");

		  }
		});
}
var justFired = false;

function saveImage () {

	$("img",$(".editingImage")).removeAttr("style");
	if ($("#newImageDescription").val()!="") {
		$("img",$(".editingImage")).attr("alt",$("#newImageDescription").val());
	} else {
		$("img",$(".editingImage")).removeAttr("alt");
	}

	if ($("#newImageLink").val()!="") {
		if ($("a",$(".editingImage")).length) {
			$("a",$(".editingImage")).attr("href",$("#newImageLink").val());
			if ($("#openNewWindow").is(":checked")) {
				$("a",$(".editingImage")).attr("target","_blank");
			} else {
				$("a",$(".editingImage")).removeAttr("target");
			}
		} else {
			$("img",$(".editingImage")).wrap("<a href='"+$("#newImageLink").val()+"'></a>");
			if ($("#openNewWindow").is(":checked")) {
				$("a",$(".editingImage")).attr("target","_blank");
			}
		}
	} else {
		$("a img",$(".editingImage")).unwrap();	
	}
	$(".editingImage .imageContextualEdit").remove();

	$(".editingImage").addClass("bpe_highlight dont_remove_highlight");
	$(".editingImage").removeClass("editingImage");	
	$.fn.bpeditor.clean(true);
	assign_sort();
	selectionTools();
	
}
function editImage ($this) {
	hidePaneTools();
	prepForInsert();
	if ($("img",$this).attr("alt")) {
		var alt = $("img",$this).attr("alt");
		var showingLabel = "";						
	} else {
		var alt = "";
		var showingLabel = "showingLabel";
	}
	var checked = "";
	if ($("a",$this).length) {
		if ($("a",$this).attr("target")=="_blank") {
			checked = "checked='checked'";
		}
		var link = $("a",$this).attr("href");
		var showingLabelLink = "";
	} else {
		var link = "";
		var showingLabelLink = "showingLabel";
	}

	$this.append("<div class='imageContextualEdit'><div class='imageContextEditFieldset "+showingLabel+"'><div class='imageContextEditLabel'>"+LangVars.Description+"</div><div class='imageContextEditInputWrap'><input type='text' class='toggleLabelValue imageContextInput' value='"+alt+"' id='newImageDescription' title='"+LangVars.Description+"'/></div></div><div class='imageContextEditFieldset "+showingLabelLink+"'><div class='imageContextEditLabel'>"+LangVars.Link+"</div><div class='imageContextEditInputWrap'><input type='text' title='"+LangVars.Link+"' class='toggleLabelValue imageContextInput' value='"+link+"' id='newImageLink' /></div></div><span id='insertInteralLinksInline' class='clearfix'><span id='insertLinkToPage'>"+LangVars.Insert_Link_To_Page+"</span><span id='insertLinkToDownload'>"+LangVars.Insert_Link_To_File+"</span><span id='imageEditCheckbox'><input "+checked+" type='checkbox' id='openNewWindow' /> <span id='openNewWindowLabel'>"+LangVars.Link_Opens_In_New_Window+"</span></span></span></div>");

	$("#insertInteralLinksInline").hide();
	$("#insertLinkToPage").click(function(){
		$("#newImageLink").blur();
		showLightPages(updateImageLinkVal,"showTop",true,LangVars.Insert_Link_To_Page);
	});
	$("#insertLinkToDownload").click(function(){
		$("#newImageLink").blur();
		showDownloadPopdown(updateImageLinkVal,LangVars.Insert_Link_To_File);
	});
	$(".toggleLabelValue",$this).focus(function(){
		if ($(this).attr("id")=="newImageLink") {
			$("#insertInteralLinksInline").show();
		} else {
			$("#insertInteralLinksInline").hide();
		}
		$(this).parents(".imageContextEditFieldset").addClass("focus");
	});
	$(".toggleLabelValue",$this).blur(function(){

		$(this).parents(".imageContextEditFieldset").removeClass("focus");
	});
		$("input:first",$this).focus();
	$(".toggleLabelValue",$this).keyup(function(e){
		if ($(this).val()!="") {
			$(this).parents(".imageContextEditFieldset").removeClass("showingLabel");
		} else {
			$(this).parents(".imageContextEditFieldset").addClass("showingLabel");
		}
	});
	$(".toggleLabelValue",$this).keypress(function(e){
		if (e.keyCode==13) {
			e.preventDefault();
		}
	});
	$this.addClass("editingImage");

	$("#rightPane").unbind("click").click(function(e){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		if ($(e.target).attr("id")!="openNewWindow" && $(e.target).attr("id")!="openNewWindowLabel") {
			hidePopdownOrPassthroughSave(saveImage);	
			$("#rightPane").unbind("click");		
		}
	});
	$(document).keydown(function(e){
		if (e.keyCode==27) { // esc
			hidePopdownOrPassthroughSave(saveImage);
			e.preventDefault();
			return false;
		}
		if (e.keyCode==13) {
			saveImage();
			return false;
		}
	});
	$("#openNewWindowLabel",$this).click(function(){
		if ($("#openNewWindow:checked",$this).length) {
			$("#openNewWindow",$this).prop('checked', false);
		} else {
			$("#openNewWindow",$this).prop('checked', true);
		}
		return false;
	});
	$(".editingImage").unbind("click").click(function(e){
		if (!$(e.target).hasClass("imageContextualEdit") && !$(e.target).parents(".imageContextualEdit").length) {
			$("#insertInteralLinksInline").hide();						
		}
		if ($(e.target).attr("id")!="openNewWindow" && $(e.target).attr("id")!="openNewWindowLabel") {
			return false;	
		}
	});
}
/*
function addLinkToText (clicked) {
		if ($("#linkOpensInNewWindow").hasClass("checked")) {
			var target = "+";
		} else {
			var target = "";
		}
		if (clicked.attr("alt")!="") {
			var range = $("textarea",$("#bpe_text_dropship")).getSelection();
			if (!range.text.match(/\[bold|\[italic|\[strikethrough|\[underline|\[superscript|\[subscript/)) {
				var escape = range.text.replace(/\]/,"\\]");					
			} else {
				var escape = range.text;
			}
			
			var added = "[link"+target+": "+clicked.attr("alt")+" text: "+escape+"]";
			if (range.text=="") {
				insert_link($("textarea",$("#bpe_text_dropship")),clicked.attr("alt"),"");
				//$("textarea",$(this).parents(".bpe_add_popup")).replaceSelection(" [link"+target+": "+$(this).attr("href")+" text: example link text] ",true);
			} else{
				$("textarea",$("#bpe_text_dropship")).replaceSelection(added,true);
			}
		}
		hidePopdownOrPassthroughSave(false);
}*/
function bpe_save () {
	hideToolTips(true);
	logTrainingClick("typeAndSubmitInTextDropship"+typeAndSubmitCounter);
	$(".bpe_help_popup").remove();
	$(".textEditingTip").remove();
	//$(".listTipUp:not(.hideTips .listTipUp)").show();
	clearTimeout(bpe_hide_drag);
	$('.drag').remove();
	if ($("#bpe_text_dropship").length) {
	var text = $("textarea",$("#bpe_text_dropship")).val();			
	} else {
		var text="";
	}

	if (el) {
		el = el.toLowerCase();
	}
	if (text!="") {
		/*
		if (el!="pre") {
			text = text.split("\n\n");						
		} else {
			var t2 = text;
			text = new Array();
			text[0] = t2;
		}

		align = $("textarea",$("#bpe_text_dropship")).css("text-align");
		if (align=="left") {
			textAlign = " style='text-align:left'";
		} else if (align=="center") {
			textAlign = " style='text-align:center'";
		} else if (align=="right") {
			textAlign = " style='text-align:right'";
		} else if (align=="justify") {
			textAlign = " style='text-align:justify'";
		} else {
			textAlign = "";
		}
		var scrollDown=false;
		for (var i=0; i < text.length; i++) {
			if (el!="pre") {
			str_text = $.trim(text[i]);
			str_text = toHTML(htmlentities(str_text).replace(/\n/,"<br/>"));
			} else {
			str_text = toHTML(htmlentities(text[i]).replace(/\n/,"<br/>"));							
			}


			if (editingtarget) {
				if (editingtarget.children("ul,ol").length>0) {
					editingtarget.before("<"+el+""+textAlign+" class='bpe_add_children "+classes+"' id=\""+editingtarget.attr("id")+"\">"+str_text+"</"+el+">");
					if (i==0) {
						$(".bpe_add_children").append(editingtarget.children("ul,ol"));
						$(".bpe_add_children").removeClass("bpe_add_children");
					}

				} else {
					editingtarget.before("<"+el+""+textAlign+" class=\""+classes+" bpe_highlight\" id=\""+editingtarget.attr("id")+"\">"+str_text+"</"+el+">");

				} 
			} else {
				$(".bpe_curently_editing #bpe_area").append("<p"+textAlign+" class=\""+classes+" bpe_highlight\">"+str_text+"</p>");		
				scrollDown = true;
			}
		};*/
	} else {
		if (editingtarget) {
			if (editingtarget.children("ul,ol").length>0) {
				editingtarget.parent().before(editingtarget.children("ul,ol"));
			}
		}
	}
	if (editingtarget) {
		editingtarget.remove();
	}
	$(".bpe_mask").remove();		
	$("#bpe_text_dropship").remove();
	$(".bpe_curently_editing").removeClass("bpe_curently_editing");
	$.fn.bpeditor.clean(true);
	if (scrollDown) {
		$("body").animate({ scrollTop : $(document).height() }, 500);
	}
	assignSaveListener();
	assign_sort();
}
var editingtarget;
var el;
var classes;
function insertLinkToWebsite (website) {
	logTrainingClick("choosePageOrDoneForWebsiteLink");
	var link = website;
	var range = $("textarea",$(".textareaWrapper.bpe_highlight")).getSelection();
	if (!range.text.match(/\[bold|\[italic|\[strikethrough|\[underline|\[superscript|\[subscript/)) {
		var escape = range.text.replace(/\]/,"\\]");					
	} else {
		var escape = range.text;
	}
	if ($('#linkOpensInNewWindow').hasClass("checked")) {
		var target = "+";
	} else {
		var target = "";
	}
	var added = "["+escape+"]("+link.replace(/ /g,"%20")+target+")";
	/*if (range.text=="") {
		insert_link($("textarea",$(".textareaWrapper.bpe_highlight")),link,target);

		//$("textarea",$(".bpe_add_popup")).replaceSelection(" [link"+target+": "+link+" text: example link text] ",true);
	} else{*/
		$("textarea",$(".textareaWrapper.bpe_highlight")).replaceSelection(added,true);
	//}
	cancelDialogue();
	
//	$("textarea",$(".textareaWrapper.bpe_highlight")).trigger('autosize.resize');
	$(".bpe_mask_small").remove(); 
	$(".bpe_popup_small").remove();
	$("textarea",$(".textareaWrapper.bpe_highlight")).focus();	
	setFakeHighlight(false);
	setTimeout(function () {
		$("textarea",$(".textareaWrapper.bpe_highlight")).text($("textarea",$(".textareaWrapper.bpe_highlight")).val());
		autosave(true);
		
	}, 10);

}
function bpe_button (type,ele,abr) {


		var range = $("textarea",ele.parents(".textareaWrapper")).getSelection();

		var result = checkBPESelection(range.text);
		var exists = false;
		for (var i=0; i < result.length; i++) {
			if (result[i] == abr) {
				exists = true;
			}
		};
		if (exists) {
			var removed = bpe_remove_formatting(type,range.text);
			$("textarea",ele.parents(".textareaWrapper")).replaceSelection(removed,true);
			$(".bpe_selected").removeClass("bpe_selected");
			$("textarea",ele.parents(".textareaWrapper")).focus();
		} else {
			/*if (!range.text.match(/\[bold|\[italic|\[strikethrough|\[underline|\[superscript|\[subscript|\[link/)) {
				var escape = range.text.replace(/\]/,"\\]");					
			} else {*/
				var escape = range.text;
			//}
			if (type=='bold') {
				var added = "**"+escape+"**";		
				var firstPart = "**";		
			}
			if (type=='italic') {
				var added = "//"+escape+"//";				
				var firstPart = "//";
			}
			if (type=='underline') {
				var added = "__"+escape+"__";				
				var firstPart = "__";
			}
			if (type=='strikethrough') {
				var added = "--"+escape+"--";				
				var firstPart = "--";
			}
			if (type=='superscript') {
				var added = "[superscript: "+escape+"]";				
				var firstPart = "[superscript: ";
			}
			if (type=='subscript') {
				var added = "[subscript: "+escape+"]";				
				var firstPart = "[subscript: ";
			}
			/*
			if (range.text=="") {
				$("textarea",ele.parents(".textareaWrapper")).each(function(){
					e = this;
				});
				var start = e.value.substr(0, e.selectionStart).lastIndexOf(firstPart);
				var typeLength = firstPart.length;
				var begining = e.value.substr(start+typeLength, e.selectionStart-start-typeLength);
				var beginingWithTag = e.value.substr(start, e.selectionStart-start);
				
				if (!begining.match(/\[/) && begining.search(/([^\\])\]/)==-1 && start!=-1) {
					var beginingWithoutTag = beginingWithTag.replace("["+type+": ","");
					var beginingWithoutTagLength = beginingWithoutTag.length;
					var endTagLength = e.value.substr(e.selectionEnd, e.value.length - e.selectionStart).search(/([^\\])\]/)+1;
					var endWithoutTag = e.value.substr(e.selectionEnd, e.value.length - e.selectionStart).replace(/([^\\])\]/,"$1");
					if (e.value.substr(e.selectionEnd, endTagLength).search(/\[/)==-1) {
						var begining = e.value.substr(0, start);
						e.value = begining + beginingWithoutTag + endWithoutTag;
						e.setSelectionRange(start,beginingWithoutTagLength+endTagLength+start);
					}

					e.focus();
				} else {
					var indexOfStartSpace = e.value.substr(0, e.selectionStart).lastIndexOf(" ");
					if(indexOfStartSpace==-1) {
						var selectedEnd=1;
						var firstspace="";
					} else {
						var firstspace=" ";
						var selectedEnd=0;
					}
					var firstPart = e.value.substr(indexOfStartSpace+1, e.selectionStart-indexOfStartSpace);

					var indexOfEndSpace = e.value.substr(e.selectionEnd, e.value.length-e.selectionEnd).indexOf(" ");
					if(indexOfEndSpace==-1) {
						indexOfEndSpace = e.value.length;
					}
					var lastPart = e.value.substr(e.selectionEnd+1, indexOfEndSpace-1);

					var lengthOfLastPart = lastPart.length;
					if (lastPart.charAt(lengthOfLastPart-1) == "]") {
						var lastPart = lastPart.substr(0,lengthOfLastPart-1);
						var range = firstPart+lastPart;
						var replacement = "]";
					} else {
						range = firstPart+lastPart;
						replacement = "";
					}

					if (!range.match(/\[bold|\[italic|\[strikethrough|\[underline|\[superscript|\[subscript|\[link/)) {
						escape = range.replace(/\]/,"\\]");					
					} else {
						escape = range;
					}

					added = firstspace+added;

					newLength = added.length;
					e.value = e.value.substr(0, indexOfStartSpace) + added + replacement + e.value.substr(e.selectionEnd+1+lengthOfLastPart);
					e.setSelectionRange(indexOfStartSpace+1,indexOfStartSpace+newLength+selectedEnd);
					e.focus();
				}

//						$("textarea",$(ele).parent().parent()).replaceSelection(" ["+type+": example text] "," ["+type+": ");
			} else {
			*/
				if (range.text.indexOf(firstPart)!=0) {
					$("textarea",ele.parents(".textareaWrapper")).replaceSelection(added,firstPart,1);							
				} else {
					result = checkBPESelection(range.text);
					for (var i=0; i < result.length; i++) {
						//$(".bpe_"+result[i]).css("border","1px solid #f00");
					};
					$("textarea",ele.parents(".textareaWrapper")).focus();
				}
			//}
		}
		$(".bpe_selected").removeClass("bpe_selected");
		result = checkBPESelection( $("textarea",ele.parents(".textareaWrapper")).getSelection().text );
		for (var i=0; i < result.length; i++) {
			$(".bpe_"+result[i]).addClass("bpe_selected");
		};

		//$("textarea",ele.parents(".textareaWrapper")).text($("textarea",ele.parents(".textareaWrapper")).val()).trigger('autosize.resize');
		$("textarea",ele.parents(".textareaWrapper")).text($("textarea",ele.parents(".textareaWrapper")).val());
		autosave(true);
		setFakeHighlight(false);
	}
function setFakeHighlight (blur,blured) {
	if (typeof blured =='undefined') {
		var $textarea = $("textarea:focus",$(".textareaWrapper"));
	} else {
		var $textarea = blured;
	}
	$(".dropshipToolbarBottom,.format_mttri").hide();
	if ($textarea.length) {
		var $wrap = $textarea.parents('.textareaWrapper');
		if ($wrap.attr("data-el")=='pre') {
			return false;
		}
//		var tw = $textarea.outerWidth();
//		var th = $textarea.height(); 
//		var tpt = $textarea.css("padding-top"); 
//		var tpr = $textarea.css("padding-right"); 
//		var tpb = $textarea.css("padding-bottom"); 
//		var tpl = $textarea.css("padding-left"); 
		var tta = $textarea.css("text-align"); 
//		var tt = $textarea.position().top-$textarea.scrollTop();
//		var tl = $textarea.position().left;
//		if (iOS) {
//			tl=tl+3;
//		}
		$textarea.removeClass("draggingSel");
		var text = $textarea.val().replace(/</g,"-").replace(/>/g,"-");
		var start = $textarea[0].selectionStart;
		var end = $textarea[0].selectionEnd;
		if (start!=end) {
			text = text.insert(start,"<span>");
			text =  text.insert(end+6,"</span>");
		} else {
			text = text.insert(start,"<span></span>");
			
			if (blur) {
				autosave(true);
				//bpe_save();
//				return false;	
			}
		}
		var reg = /\n/ig;
		text = text.replace(reg,"<br />");

		$(".visibleHighlight",$wrap).html(text+" ").css({
			textAlign:tta
		});

		if ($textarea[0].selectionStart!=$textarea[0].selectionEnd) {
			$(".dropshipToolbarBottom,.format_mttri",$wrap).removeAttr("style").show();
//			$(".dropshipToolbarBottom",$wrap).css("width","auto");
//			$(".dropshipToolbarBottom",$wrap).css("width",$(".dropshipToolbarBottom",$wrap).width());
			var posLeft = $(".visibleHighlight span",$wrap).position().left;
			var posTop = $(".visibleHighlight span",$wrap).position().top+parseInt($(".dropshipToolbarBottom",$wrap).css("top"))+2-$textarea.scrollTop() + $(".visibleHighlight span",$wrap).height() - 20;
			posLeft = posLeft+($(".visibleHighlight span",$wrap).width()/2);
			
			var mainLeft = posLeft - ($(".dropshipToolbarBottom",$wrap).width()/2);

			if (mainLeft<34) {
				mainLeft=0;
			}
			if (mainLeft+$(".dropshipToolbarBottom",$wrap).width() > $textarea.width()) {
				var overshoot = (mainLeft+$(".dropshipToolbarBottom",$wrap).width()) - $textarea.width();
				mainLeft = mainLeft - overshoot ;
				
			}
			$(".dropshipToolbarBottom",$wrap).css({
				left:mainLeft
				,top:posTop+65
			});
			
			$(".format_mttri",$wrap).css({
				left:posLeft+5
				,top:posTop+33+25
			});

			
		} else {
			$(".dropshipToolbarBottom,.format_mttri").hide();
/*			if (!iOS) {
				var cursorY = $(".visibleHighlight span",$wrap).position().top + $wrap.position().top;
				if ($(".visibleHighlight span",$wrap).parents(".zonesDropBox").length) {
					cursorY=cursorY+$(".visibleHighlight span",$wrap).parents(".zonesDropBox").position().top + $(".visibleHighlight span",$wrap).parents(".zonesDropBox").parents('.CMS_Component_ObsZones').position().top;
				}
				if (typeof myScroll[$(".textEditingArea").attr("id")]!='undefined') {
				var scrolledY = Math.abs(myScroll[$(".textEditingArea").attr("id")].y);					
				} else {
					scrolled=0;
				}

				if (cursorY<scrolledY) {
					var diff = scrolledY-cursorY;
					myScroll[$(".textEditingArea").attr("id")].scrollBy(0,diff);
				}
				var scrollBottomLimit = scrolledY+$(".textEditingArea").height()-30;
				if (iOS) {
					scrollBottomLimit = scrollBottomLimit-250;

				}
				if (cursorY>scrollBottomLimit) {
					var d = cursorY - scrollBottomLimit;
					myScroll[$(".textEditingArea").attr("id")].scrollBy(0,-d);
				}
			} */

		}
	}
		
}
function assignAddTextKeysAndClick () {
	
	$(document).keydown(function(e) {

   		if (metaDown) {
			if (e.keyCode==66) { // b
				bpe_button('bold',$('.textareaWrapper textarea:focus'),"bold");
				e.preventDefault();
			}
			if (e.keyCode==73) { // i
				bpe_button('italic',$('.textareaWrapper textarea:focus'),"ital");
				e.preventDefault();
			}
			if (e.keyCode==85) { // u
				bpe_button('underline',$('.textareaWrapper textarea:focus'),"underline");
				e.preventDefault();
			}
		}
	    if (e.metaKey || e.ctrlKey) {
			metaDown = true;
		}
		if (!modDown && !shiftDown) {
			/*if (e.keyCode==13) { // Return
				bpe_save();
				var node = $(".bpe_highlight:last")[0].nodeName.toLowerCase();
				$(".bpe_highlight:last").next().after("<"+node+" class=\"addText bpe_highlight\"></"+node+">");
				$(".bpe_highlight:not(:last)").removeClass("bpe_highlight");
				addText($(".bpe_highlight:last"),false);
				e.preventDefault();
				return false;
			}*/
		} 

	    if (/*e.metaKey || e.ctrlKey ||*/ e.altKey) {
			modDown = true;
		}
		if (e.shiftKey) {
			shiftDown = true;
		}
   	}).keyup(function(e) {
   		
   		
	    if (/*!e.metaKey && !e.ctrlKey && */!e.altKey) {
			modDown = false;
		}
	    if (!e.metaKey && !e.ctrlKey) {
			metaDown = false;
		}
		if (!e.shiftKey) {
			shiftDown = false;
		}
		

    });
    $(document).mouseup(function(){
		$("textarea.draggingSel").removeClass("draggingSel");
		setTimeout(function() {
			if (!touchdown) {
				setFakeHighlight();
			}
		}, 10);
	});
	$(document).keydown(function(e){
		if (e.keyCode==8) { // backspace
			if ($("textarea:focus").val()=="") {
				if ($("textarea:focus").parents(".textareaWrapper").prev().prev(".textareaWrapper").length) {
					var el = $("textarea:focus").parents(".textareaWrapper").prev().prev(".textareaWrapper").find("textarea");

					el.trigger("click").focus();
					var len = el.val().length * 2;
		        	el[0].setSelectionRange(len, len);
					return false;
				}
			}
		}
		
		if (e.keyCode==27) { // esc
			$(".dropshipToolbarBottom,.format_mttri").hide();
			$("textarea:focus").blur();
			selectionTools();
			autosave(true);
			assignSaveListener();
//			hidePopdownOrPassthroughSave(bpe_save);
			e.preventDefault();
		}
	});
}
function addText ($this,elo) {
	hidePaneTools();
	hideDragInsert();
	$(".listTipEditor").hide();
	$(".textEditingArea  > .listTipUp").hide();
//	$("#bpe_area").css("height",$("#bpe_area").height());
	prepForInsert();
	$(".bpe_highlight:first").parents("#bpe_area").addClass("bpe_curently_editing");


	editingtarget=false;
	el=false;
	if ($this.parent().hasClass("bpe_menu_bottom")) {
		var verb = "Add";
		var content = "";
		var align = "normal";
		$(".bpe_area_wrapper").addClass("bpe_curently_editing");
		$("#bpe_area").append("<p></p>");
		$("#bpe_area p").hide();
		var target = $("#bpe_area p").last();
	} else {
		if ($this.hasClass("bpe_edit_menu")) {
			var target = $(".bpe_highlight:first");
		} else {
			var target = $this;
		}
		if (target.parents(".zonesDropBox").length) {
			target.parents(".zonesDropBox").removeClass("empty");	
		}

		target.hide(); 
		$(".drag,.itemTag",target).remove();
		$(".hwrap",target).contents().unwrap();
		var verb = "Edit";
		if ($this.hasClass("addText")) {
			logTrainingClick("clickAddText");
			
			verb="Add";
			
			target.after("<div class='dropzone'><div></div></div>")
			if (typeof elo !== 'undefined' && elo!==false) {

				target.wrap("<"+elo+"></"+elo+">");	
				target.after("<div class='dropzone'><div></div></div>");
				target.before("<div class='dropzone'><div></div></div>")
			}
			
			$this.removeClass("addText");
		} else {
			logTrainingClick("editTextItemInEditPage");
		}
		$(".bpe_toggler").css("display","none");
		if ($(".bpe_highlight:first").children("ul,ol").length>0) {
			$(".bpe_highlight:first").after("<div class='bpe_highlight_temp' style='display:none'></div>");
			$(".bpe_highlight_temp").append($('.bpe_highlight').children("ul,ol"));
			$('.bpe_highlight').children("ul,ol,.dropzone").remove();
			var content = toBPE($('.bpe_highlight').html());
			content = content.replace(/\n/,"");
			content = content.replace(/\r/,"");
			$(".bpe_highlight").append($(".bpe_highlight_temp").html());
			$(".bpe_highlight_temp").remove();
			editingtarget = $(".bpe_highlight");
		} else {
			editingtarget = $(".bpe_highlight");		
			var content = toBPE(editingtarget.html());
		}
		classes = editingtarget.attr("class");
		classes = classes.replace("bpe_highlight","");

		$(".bpe_highlight").each(function(){
			el = this.tagName;					
		});
		$(".bpe_highlight").parent().each(function(){
			var parent = this.tagName;					
		});
		var align = editingtarget.css("text-align");
	}
	if ($("#existingPages").length>0) {
		var existingPages = $("#existingPages").html();
		var showExistingPages = "block";
	} else {
		var existingPages = "";
		var showExistingPages = "none";
	}

	if ($("#downloads").length>0) {
		var downloads = $("#downloads").html();
		if ($("#downloads").children().length==0) {
			downloads = "<span class='bpe_menu_message'>Uploaded files will appear here</span>";
		}
		var showDownloads = "block";
	} else {
		var downloads = "";
		var showDownloads = "none";
	}
//	$('body').append("<div class='bpe_mask'></div><div class='bpe_add_popup' id='bpe_add_popup' style='height:420px'><div class='bpe_add_popup_inner' style='height:360px'><img src='graphics/bpeditor/help.png' alt='This text editor uses simple, human-readable notation to define areas of text that have formatting. Bold, italic, a link, or other formatting for example. The formatting buttons above the text area provide convenient shortcuts to enter this notation. || As youll see when using the shortcut buttons, the notation shows in this format: || [format: your text] || You can continue to edit text inbetween the colon and closing square-bracket after the formatting has been applied. When you click Done the notation will be converted and displayed properly, as it will on your website itself.' class='bpe_help' /><h2>"+verb+" text content</h2><div class='bpe_popup_menu'><a href='' class='bpe_popup_link'><span>Link</span></a><div class='bpe_menu_contents'><div class='bpe_menu_top'><div class='bpe_menu_bottom'><a href='' class='bpe_link_to_website'>Link to website&hellip;</a><div class='bpe_menu_sub'><a href='' class='bpe_menu_sub_item'>Link to a page</a><div class='bpe_menu_sub_items bpe_wide' style='top:-56px;'><div class='bpe_menu_top'><div class='bpe_menu_bottom bpe_add_page_links lightPagesList'></div></div></div></div><div class='bpe_menu_sub'><a href='' class='bpe_menu_sub_item'>Link to a file</a><div class='bpe_menu_sub_items bpe_wide'><div class='bpe_menu_top'><div class='bpe_menu_bottom bpe_add_file_links'><a href='' class='bpe_upload_new_file'>Upload new file&hellip;</a><div class='bpe_rule'></div><div class='bpe_downloads'>"+downloads+"</div></div></div></div></div></div></div></div></div><div class='bpe_buttons'><a href='#' class='bpe_bold' title='Bold'></a><a href='#' class='bpe_ital' title='Italic'></a><a href='#' class='bpe_underline' title='Underline'></a><a href='#' class='bpe_strike' title='Strikethough'></a><a href='#' class='bpe_sup' title='Superscript'></a><a href='#' class='bpe_sub' title='Subscript'></a> <a href='#' class='bpe_left' title='Align Left'></a><a href='#' class='bpe_centre' title='Align Centre'></a><a href='#' class='bpe_right' title='Align right'></a><a href='#' class='bpe_justify' title='Align Justify'></a></div><textarea style=\"text-align:"+align+"\">"+content+"</textarea><div class='bpe_textarea_mask'></div><div class='bpe_savecancel'><a href='#' class='bpe_save'><span>Done</span></a><a href='#' class='bpe_cancel'><span>Cancel</span></a></div></div></div>");
	
	if ($("body").hasClass("hideTips")) {
		var tip = "";
	} else {
		var tip = "<div class='listTipUp textEditingTip'>"+LangVars.Tip_Editing_Text+"</div>";
	}
	tip="";
	//target.after("<div id='bpe_text_dropship' class='clearfix'><div id='visibleHighlight'></div><textarea style=\"text-align:"+align+"\" class='bpe_textarea'>"+content+"</textarea><div class='bpe_textarea_mask'></div><div id='dropshipToolbarBottom' class='clearfix'><div class='bpe_buttons'><a href='#' class='bpe_bold' title='Bold'>B</a><a href='#' class='bpe_ital' title='Italic'>I</a><a href='#' class='bpe_underline' title='Underline'>U</a><a href='#' class='bpe_strike' title='Strikethough'>Az</a><a href='#' class='bpe_sub' title='Subscript'>X<sub>1</sub></a><a href='#' class='bpe_sup' title='Superscript'>X<sup>1</sup></a><a href='#' class='bpe_left' title='Align Left'><img src='/admin/graphics/bpeditor/left-align.png' /></a><a href='#' class='bpe_centre' title='Align Centre'><img src='/admin/graphics/bpeditor/center-align.png' /></a><a href='#' class='bpe_right' title='Align right'><img src='/admin/graphics/bpeditor/right-align.png' /></a><a href='#' class='bpe_justify' title='Align Justify'><img src='/admin/graphics/bpeditor/justify.png' /></a><span id='insertLinkToPage'>"+LangVars.Insert_Link_To_Page+"</span><span id='insertLinkToDownload'>"+LangVars.Insert_Link_To_File+"</span><span id='insertLinkToWebsite'>"+LangVars.Insert_Link_To_Website+"</span></div></div></div>"+tip);
	target.after("<div id='bpe_text_dropship' class='clearfix'><div id='visibleHighlight'></div><textarea style=\"text-align:"+align+"\" class='bpe_textarea'>"+content+"</textarea><div class='bpe_textarea_mask'></div><div id='format_mttri'></div><div id='dropshipToolbarBottom' class='clearfix'><div class='format_first_block'><div class='bpe_buttons'><a href='#' class='bpe_bold' title='Bold'>"+LangVars.Bold+"</a><a href='#' class='bpe_ital' title='Italic'>"+LangVars.Italics+"</a><a href='#' class='bpe_underline' title='Underline'>"+LangVars.Underline+"</a></div><div class='format_separator'></div><span id='insertLinkToWebsite'>"+LangVars.Link+"</span><div class='format_separator'></div><div id='format_more'></div></div><div class='format_second_block'><div id='format_less'></div><div class='format_separator'></div><div class='bpe_buttons'><a href='#' class='bpe_strike' title='Strikethough'>"+LangVars.Strikethrough+"</a><a href='#' class='bpe_sub' title='Subscript'>"+LangVars.SubSupX+"<sub>"+LangVars.SubSupY+"</sub></a><a href='#' class='bpe_sup' title='Superscript'>"+LangVars.SubSupX+"<sup>"+LangVars.SubSupY+"</sup></a></div></div></div>");
	$("#dropshipToolbarBottom,#format_mttri,#format_triShadow,.format_second_block").hide();
	if (currentTooltip) {
		interuptedChains.push({currentTooltip:currentTooltip,currentTooltipItem:currentTooltipItem});
		clearTimeout(toolTipTimeout);
	}
	currentTooltipItem=0;
	currentTooltip="addtext";
	toolTipTimeout = setTimeout(tooltip, 10);

	$("#format_more").click(function(){	
		$(".format_first_block").fadeOut(200,function(){
			$(".format_second_block").fadeIn();
			$("#dropshipToolbarBottom").css("width","auto");
			$("#dropshipToolbarBottom").css("width",$("#dropshipToolbarBottom").width()+1);
		});
	});
	$("#format_less").click(function(){
		$(".format_second_block").fadeOut(200,function(){
			$(".format_first_block").fadeIn();
			$("#dropshipToolbarBottom").css("width","auto");
			$("#dropshipToolbarBottom").css("width",$("#dropshipToolbarBottom").width()+1);
		});
	});
	//$("#bpe_area").css("height","auto");
	
	rebindSearchList($(".bpe_downloads"));
	$(".bpe_mask,#bpe_text_dropship").click(function(){ $(".bpe_help_popup").hide(); return false;});
	
	$(".bpe_mask").css("height",$(document).height()+"px");
	$(".bpe_mask").fadeTo(0,0.4);

	var otop = 100;


	$("#insertLinkToPage").click(function(){
		logTrainingClick("addLinkTextEditor");
		showLightPages(addLinkToText,"showTop",true);
		return false;
	});
	$("#insertLinkToDownload").click(function(){
		logTrainingClick("addLinkTextEditor");
		showDownloadPopdown(addLinkToText,LangVars.Insert_Link_To_File);
	});
	$(".bpe_close_popup").click(function(){
		$(".bpe_mask").remove();
		$("#bpe_text_dropship").remove();
		$(".bpe_editing_image").removeClass("bpe_editing_image");
	});
	
	$("body").css({
	                   '-moz-user-select':'',
	                   '-webkit-user-select':'',
	                   'user-select':'',
	                   '-ms-user-select':''
	  });
	             
	var align = $("textarea",$("#bpe_text_dropship")).css("text-align");
	if (align=="left") {
		$(".bpe_left").addClass("bpe_selected_align");
	} else if (align=="center") {
		$(".bpe_centre").addClass("bpe_selected_align");
	} else if (align=="right") {
		$(".bpe_right").addClass("bpe_selected_align");
	} else if (align=="justify") {
		$(".bpe_justify").addClass("bpe_selected_align");
	} else {
		$(".bpe_left").addClass("bpe_selected_align");
	}
	
	$("#bpe_text_dropship .cancel_confirm,#bpe_text_dropship .show_choices4").unbind();
	/*
	$(".bpe_add_file_links").click(function(e){
		var clicked = $(e.target);

		if (!clicked.hasClass("showMore") && !clicked.hasClass("filterBox") && !clicked.hasClass("filterSearchLabel") && !clicked.hasClass("searchList") && !clicked.hasClass("clearSearch") && !clicked.hasClass("bpe_upload_new_file") && !clicked.hasClass("removeFileFromList") && !clicked.hasClass("show_choices4") && !clicked.hasClass("cancel_confirm")) {
			if (clicked.attr("href")!="") {
			var range = $("textarea",clicked.parents("#bpe_text_dropship")).getSelection();
			if (!range.text.match(/\[bold|\[italic|\[strikethrough|\[underline|\[superscript|\[subscript/)) {
				var escape = range.text.replace(/\]/,"\\]");					
			} else {
				var escape = range.text;
			}
			if ($('.bpe_blank_tick:checked').length>0) {
				var target = "+";
			} else {
				var target = "+";
			}
			var added = "[link"+target+": "+clicked.attr("id")+" text: "+escape+"]";
			if (range.text=="") {
				insert_link($("textarea",clicked.parents("#bpe_text_dropship")),clicked.attr("id"),"+");

				//$("textarea",$(this).parents(".bpe_add_popup")).replaceSelection(" [link"+target+": "+$(this).attr("href")+" text: example link text] ",true);
			} else{
				$("textarea",clicked.parents("#bpe_text_dropship")).replaceSelection(added,true);
			}
			}
			$(".bpe_menu_sub_items").hide();
			$(".bpe_textarea_mask").hide();
			$(".bpe_sub_hilite").removeClass("bpe_sub_hilite");
			$(".bpe_menu_contents").hide();
		} else if (clicked.hasClass("removeFileFromList")) {
			working();
			var id = clicked.attr("id");
			$.ajax({
			  type: "POST",
			  url: "removeFileFromList.php",
			  data: "file="+id,
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
					$(".bpe_downloads,#downloads").html(msg);
					saved("File remvoved");
			  }
			});
		} else if (clicked.hasClass("show_choices4")) {
			$(".choices4:first",clicked).show();
			clicked.parents(".menu_hidden_extras").addClass("dontHide");
		} else if (clicked.hasClass("cancel_confirm")) {
			clicked.parents(".choices4").hide();
			clicked.parent().parent().parent().parent().parent().removeClass("dontHide");
		} else {

		}
		return false;
	});*/
	/*
	$("#insertLinkToWebsite").click(function(){
		logTrainingClick("addLinkTextEditor");
		
		prepDialogue ("<h2>"+LangVars.Insert_Link+"</h2><p>"+LangVars.Insert_Link_Text+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Done,insertLinkToWebsite,false,true,true,"",true);
		return false;
	});
	assignAddTextKeysAndClick();
	
    $("textarea",$("#bpe_text_dropship")).keyup(function(){
    	setFakeHighlight(); 		
    });
    
   
	$("textarea",$("#bpe_text_dropship")).mouseup(function(){

		$(".bpe_selected").removeClass("bpe_selected");
		var result = checkBPESelection($(this).getSelection().text);
		for (var i=0; i < result.length; i++) {
			$(".bpe_"+result[i]).addClass("bpe_selected");
		};
	});
	$("#bpe_text_dropship").click(function(){
		$(".bpe_menu_contents").hide();
		$(".bpe_textarea_mask").hide();
	});
	$("textarea",$("#bpe_text_dropship")).mousedown(function(){
		$("textarea",$("#bpe_text_dropship")).addClass("draggingSel");
	});
	
	$("textarea",$("#bpe_text_dropship")).click(function(){
		$(".bpe_selected").removeClass("bpe_selected");
		var e;
		$("textarea",$("#bpe_text_dropship")).each(function(){
			e = this;
		});
		setTimeout(function() {
			if (!touchdown) {
				setFakeHighlight();
				
			}
		}, 10);
		
		var start = e.value.substr(0, e.selectionStart).lastIndexOf("[");	
		if (start!=-1) {

			if (e.value.substr(start, e.selectionStart-start).search(/[^\\]\]/)!=-1) {
				return false;
			}
			var end = e.value.substr(e.selectionEnd, e.value.length-e.selectionEnd).search(/[^\\]\]/);
			if (end!=-1) {
				var end2 = e.value.substr(e.selectionEnd, end).indexOf(":"); 
				if (end2!=-1) {
					var end = end + e.value.substr(0, e.selectionStart).length +2;
					if (e.value.substr(start,e.selectionStart - start).indexOf(":")==-1 && e.value.substr(start,e.selectionStart - start).indexOf(" ")==-1) {
						if (e.value.substr(e.selectionEnd, end - e.value.substr(0, e.selectionStart).length).indexOf("[")==-1) {
							e.setSelectionRange(start,end);	
							$(".bpe_selected").removeClass("bpe_selected");
							var result = checkBPESelection($(this).getSelection().text);
							for (var i=0; i < result.length; i++) {
								$(".bpe_"+result[i]).addClass("bpe_selected");
							};
						} else {

							var numberOfOpeners = e.value.substr(e.selectionEnd, end - e.value.substr(0, e.selectionStart).length).match(/\[bold|\[italic|\[strikethrough|\[underline|\[superscript|\[subscript/g).length;
								var end = e.value.substr(e.selectionEnd+end2, e.value.length-e.selectionEnd).split(/[^\\]\]/g);
								var stringLength = 0;

								for (var i=0; i <= numberOfOpeners; i++) {
									stringLength = stringLength + end[i].length + 2;
								};
								var h = e.selectionStart-start;
								e.setSelectionRange(start,stringLength+start+h+end2);	
								e.focus();
								$(".bpe_selected").removeClass("bpe_selected");
								var result = checkBPESelection($(this).getSelection().text);
								for (var i=0; i < result.length; i++) {
									$(".bpe_"+result[i]).addClass("bpe_selected");
								};
						}

					}

				} else {

					if ( e.value.substr(start+1,e.value.substr(start,e.selectionStart - start).indexOf(":")).search(/[^\\]\]/) == -1) {
						var type = (e.value.substr(start+1,e.value.substr(start,e.selectionStart - start).indexOf(":")-1));
						if (type=="strikethrough") {
							$(".bpe_strike").addClass("bpe_selected");
						} else if (type=="italic") {
							$(".bpe_ital").addClass("bpe_selected");
						} else if (type=="superscript") {
							$(".bpe_sup").addClass("bpe_selected");
						} else if (type=="subscript") {
							$(".bpe_sub").addClass("bpe_selected");
						} else {
							$(".bpe_"+type).addClass("bpe_selected");
						}
					}


				}

			}
			setTimeout(function() {
				if (!touchdown) {
					setFakeHighlight();
					
				}
			}, 10);
			

		}

	});
	
	$(".bpe_bold").click(function(){
		alert("test");
		logTrainingClick("formattingIconInEditPage");
		bpe_button('bold',$(this),"bold");
		return false;
	});
	$(".bpe_ital").click(function(){
				logTrainingClick("formattingIconInEditPage");
		bpe_button('italic',$(this),"ital");
		return false;
	});
	$(".bpe_underline").click(function(){
				logTrainingClick("formattingIconInEditPage");
		bpe_button('underline',$(this),"underline");
		return false;
	});
	$(".bpe_strike").click(function(){
				logTrainingClick("formattingIconInEditPage");
		bpe_button('strikethrough',$(this),"strike");
		return false;
	});
	$(".bpe_left").click(function(){
				logTrainingClick("formattingIconInEditPage");
		$("textarea",$(this).parents("#bpe_text_dropship")).css("text-align","left");
		$(".bpe_left,.bpe_centre,.bpe_right,.bpe_justify").removeClass("bpe_selected_align");
		$(this).addClass("bpe_selected_align");
		return false;
	});
	$(".bpe_centre").click(function(){
		$("textarea",$(this).parents("#bpe_text_dropship")).css("text-align","center");
		$(".bpe_left,.bpe_centre,.bpe_right,.bpe_justify").removeClass("bpe_selected_align");
		$(this).addClass("bpe_selected_align");
		return false;
	});
	$(".bpe_right").click(function(){
		$("textarea",$(this).parents("#bpe_text_dropship")).css("text-align","right")
		$(".bpe_left,.bpe_centre,.bpe_right,.bpe_justify").removeClass("bpe_selected_align");
		$(this).addClass("bpe_selected_align");
		return false;
	});
	$(".bpe_justify").click(function(){
		$("textarea",$(this).parents("#bpe_text_dropship")).css("text-align","justify");
		$(".bpe_left,.bpe_centre,.bpe_right,.bpe_justify").removeClass("bpe_selected_align");
		$(this).addClass("bpe_selected_align");
		return false;
	});
	$(".bpe_sup").click(function(){
				logTrainingClick("formattingIconInEditPage");
		bpe_button('superscript',$(this),"sup");
		return false;
	});
	$(".bpe_sub").click(function(){
				logTrainingClick("formattingIconInEditPage");
		bpe_button('subscript',$(this),"sub");
		return false;
	});
	

	
	
	$("#dragBoundry").click(function(e){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		hidePopdownOrPassthroughSave(bpe_save);
		$("#dragBoundry").unbind("click");
	});
	
	$(".bpe_save").click(function(){				
		bpe_save();
		return false;
	});
	$(".bpe_cancel").click(function(){
		target.show()
		$(".bpe_help_popup").remove();
		$(".bpe_curently_editing").removeClass("bpe_curently_editing");
		$(".bpe_mask").remove();
		$("#bpe_text_dropship").remove();
		$(".bpe_toggler").css("display","none");
		$(document).unbind("keypress");
		assignSaveListener();
		$.fn.bpeditor.clean(true);

		return false;
	});
	var mh = $(".textEditingArea").height()-$("textarea",$("#bpe_text_dropship")).offset().top-20;
	if (mh<50) {
		$(".textEditingArea").lovelyScrollMove(-50);
		setTimeout(function() {
			mh=80;
			$("textarea",$("#bpe_text_dropship")).focus().css("max-height",mh+"px").autosize();
		}, 10);
		
	} else {
		$("textarea",$("#bpe_text_dropship")).focus().css("max-height",mh+"px").autosize();
	}
	
	$("textarea",$("#bpe_text_dropship")).scroll(function(){
		setFakeHighlight(false);
	});
	if (iOS) {
		$("#dropshipToolbarBottom").hide();
		$("textarea",$("#bpe_text_dropship")).css("left","-3px");
	}
	
	String.prototype.insert = function (index, string) {
	  if (index > 0)
	    return this.substring(0, index) + string + this.substring(index, this.length);
	  else
	    return string + this;
	};
	
	if (iOS) {
		$("textarea",$("#bpe_text_dropship")).blur(function(){
			setFakeHighlight(true);
			
		});	
	}
	*/

}
var clipboard = false;
function cut () {
	setTimeout(function() {

		copy();
		
		if ($(".bpe_highlight").length) {
			$(".bpe_highlight").remove();
			selectionTools();
			$(".bpe_toggler").css("display","none");
			$.fn.bpeditor.clean(true);
		
		}
	},10);
	
}
function softCopy () {
	$copy = $("<div></div>");
	$(".bpe_highlight",$("#bpe_area")).each(function(){
		if (!$(this).hasClass("bpe_highlight_done")) {
			if ($("li.bpe_highlight,p.bpe_highlight,h1.bpe_highlight,h2.bpe_highlight,h3.bpe_highlight,h4.bpe_highlight,.bpe_image.bpe_highlight,.bpe_table.bpe_highlight,pre.bpe_highlight,.CMS_Component_Obs.bpe_highlight").length) {
				if ($(this).hasClass('CMS_Component_Obs')) {
					var elegible = ".textareaWrapper:not(.bpe_highlight),.bpe_image:not(.bpe_highlight),.CMS_Component_Obs:not(.bpe_highlight)";
					$list = $(this).clone();
					$(elegible,$list).remove();
					$("ul,ol",$list).each(function(){
						$(this).children().children("ul,ol").each(function(){
							if ( $("li",$(this)).length==0 )  {
								$(this).remove();
							}
						});
						if ( $("li",$(this)).length==0 )  {
							$(this).remove();
						}
					});
					$(".bpe_highlight",$(this)).addClass("bpe_highlight_done");
					$copy.append($list);
					
				} else {
					if ($(this).parent("ul").length || $(this).parent("ol").length) {	
						$list = $(this).parent().clone();
						$list.children("li:not(.bpe_highlight)").remove();
						$list.children().children().children("li:not(.bpe_highlight)").remove();
						$list.children().children().children().children().children("li:not(.bpe_highlight)").remove();
						$list.children().children("ul,ol").each(function(){
							$(this).children().children("ul,ol").each(function(){
								if ( $("li",$(this)).length==0 )  {
									$(this).remove();
								}
							});
							if ( $("li",$(this)).length==0 )  {
								$(this).remove();
							}
						});
						$(".bpe_highlight",$(this).parent()).addClass("bpe_highlight_done");
						$copy.append($list);
					} else {
						$copy.append($(this).clone());			
					}
				}
				
			} else {
				$copy.append($(this).clone());		
			}

		}

	});
	return $copy;
}
function findTarget ($copy) {
	$dest = $(".bpe_highlight:last");
	if ($dest.parents(".CMS_Component_ObsZones").length) {
		if ($(".CMS_Component_ObsZones",$copy).length) {
			$dest = $dest.parents(".CMS_Component_ObsZones");
		} else {
			if ($dest.parent("ul").length || $dest.parent("ol").length) {
				if ($("p,h1,h2,h3,h4,.bpe_image,.bpe_table,pre,.CMS_Component_Obs",$copy).length) {
					if (!$dest.parent().parent("li").length) {
						$dest = $dest.parent();
					} else {
						if (!$dest.parent().parent().parent().parent("li").length) {
							$dest = $dest.parent().parent().parent();
						} else {
							if (!$dest.parent().parent().parent().parent().parent().parent("li").length) {
								$dest = $dest.parent().parent().parent().parent().parent();
							}
						}
					}			
				} else {
					if ($dest.parents("li.bpe_highlight").length) {
						$dest = $dest.parents("li.bpe_highlight:first");					
					}
				}
			}
		}
	} else {
		if ($dest.parent("ul").length || $dest.parent("ol").length) {
			if ($("p,h1,h2,h3,h4,.bpe_image,.bpe_table,pre,.CMS_Component_Obs",$copy).length) {
				if (!$dest.parent().parent("li").length) {
					$dest = $dest.parent();
				} else {
					if (!$dest.parent().parent().parent().parent("li").length) {
						$dest = $dest.parent().parent().parent();
					} else {
						if (!$dest.parent().parent().parent().parent().parent().parent("li").length) {
							$dest = $dest.parent().parent().parent().parent().parent();
						}
					}
				}			
			} else {
				if ($dest.parents("li.bpe_highlight").length) {
					$dest = $dest.parents("li.bpe_highlight:first");					
				}
			}
		}
	}
	return $dest;
}
function duplicate () {
	$copy = softCopy();
	$copy.find(".textareaWrapper,.bpe_image,.CMS_Component_Obs").addClass("bpe_highlight dont_remove_highlight");
	$dest = findTarget($copy);
	$(".bpe_highlight",$("#bpe_area")).removeClass("bpe_highlight");
	$(".bpe_toggler").hide();
	$dest.after($copy.html());
	$.fn.bpeditor.clean(true);
	selectionTools();
}
function copy () {
	$copy = softCopy();
	$.ajax({
	  type: "POST",
	  url: "pageActions.php",
	  data: "pageAction=copy&content="+encodeURIComponent($copy.html()),
	  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
		$.ajax({
		  type: "POST",
		  url: "pageActions.php",
		  data: "pageAction=paste",
		  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			clipboard= msg;
			$("#bpe_paste").removeClass("greyedOut");
		  }
		});
	  }
	});
}
function paste () {
	
	if (clipboard) {
		$temp = $("<div></div>").html(clipboard);
		if ($(".bpe_highlight:visible").length) {
			$dest = findTarget($temp);
			$(".bpe_highlight").removeClass("bpe_highlight");
			$(".bpe_toggler").hide();
			$temp.find(".textareaWrapper,.bpe_image,.CMS_Component_Obs").addClass("bpe_highlight dont_remove_highlight");
			var topaste = $temp.html();
			$dest.after(topaste);
		} else {
			$temp.find(".textareaWrapper,.bpe_image,.CMS_Component_Obs").addClass("bpe_highlight dont_remove_highlight");
			var topaste = $temp.html();
			$("#bpe_area > *:visible:last").after(topaste);
		}
		$.fn.bpeditor.clean(true);
		
		scrollToEl($(".bpe_highlight:first"),$(".textEditingArea"));
	}
}
function undo () {
	if (!$("#bpe_undo").hasClass("greyedOut")) {
//		$("#bpe_area").css("height",$("#bpe_area").height());
		if ($("#undoStack .viewing").length) {
			$("#bpe_area").empty().append($("#undoStack .viewing").prev().data("content"));
			$("#undoStack .viewing").prev().addClass("viewing");
			$("#undoStack .viewing:last").removeClass("viewing");
		} else {
			$("#finalRedo").data("content",$("#entryTextAreaVal").val());
			$("#bpe_area").empty().append($("#undoStack input:last").data("content"));
			$("#undoStack input:last").addClass("viewing");
		}
		if (!$("#undoStack .viewing").prev().length) {
			$("#bpe_undo").addClass("greyedOut");
		}
		$.fn.bpeditor.clean(false);
		$("#bpe_redo").removeClass("greyedOut");
		//$("#bpe_area").css("height","auto");
	}
}
function removeEls () {
	if ($(".bpe_highlight").length) {
		$(".bpe_highlight").each(function(){
			$el = $(this);
			$(".textareaWrapper:not(.bpe_highlight),li:not(.bpe_highlight),p:not(.bpe_highlight),h1:not(.bpe_highlight),h2:not(.bpe_highlight),h3:not(.bpe_highlight),h3:not(.bpe_highlight),h4:not(.bpe_highlight),pre:not(.bpe_highlight),.bpe_image:not(.bpe_highlight),.CMS_Component_Obs:not(.bpe_highlight)",$(this)).each(function(){
				if (!$(this).parents("li").length) {
					$(this).insertBefore($el);					
				}
			});
		
		});
		$(".bpe_highlight").remove();
		selectionTools();
		$(".bpe_toggler").css("display","none");
		setTimeout(function() {
			$.fn.bpeditor.clean(true);
		}, 10);
		
	}	
}
function redo () {
	if (!$("#bpe_redo").hasClass("greyedOut")) {
		//$("#bpe_area").css("height",$("#bpe_area").height());
		
		if ($("#undoStack .viewing").length) {
			if ($("#undoStack input.viewing").next().length) {
				$("#bpe_area").empty().append($("#undoStack .viewing").next().data("content"));
				$("#undoStack .viewing").next().addClass("viewing");
				$("#undoStack .viewing:first").removeClass("viewing");						
			} else {
				$("#bpe_area").empty().append($("#finalRedo").data("content"));
				$("#undoStack .viewing").removeClass("viewing");
			}
		}
		if (!$("#undoStack .viewing").length) {
			$("#bpe_redo").addClass("greyedOut");
		}
		$.fn.bpeditor.clean(false);
		$("#bpe_undo").removeClass("greyedOut");
		//$("#bpe_area").css("height","auto");
		
	}
}
function showEditingToooltips () {
	if (!$("#rightPane").hasClass("editingSnippet") && !$("#rightPane").hasClass("editingSitewideContent") && !$("#rightPane").hasClass("editingBlog")) {
			if (currentTooltip) {
				interuptedChains.push({currentTooltip:currentTooltip,currentTooltipItem:currentTooltipItem});
				clearTimeout(toolTipTimeout);
			}
			currentTooltipItem=0;
			currentTooltip="editor";
			toolTipTimeout=setTimeout(tooltip, 1000);	
		}
		if ($("#rightPane").hasClass("editingSnippet")) {
			if (currentTooltip) {
				interuptedChains.push({currentTooltip:currentTooltip,currentTooltipItem:currentTooltipItem});
				clearTimeout(toolTipTimeout);
			}
			currentTooltipItem=0;
			currentTooltip="editor";
			toolTipTimeout=setTimeout(tooltip, 1000);		
		}
		if ($("#rightPane").hasClass("editingSitewideContent")) {
			if (currentTooltip) {
				interuptedChains.push({currentTooltip:currentTooltip,currentTooltipItem:currentTooltipItem});
				clearTimeout(toolTipTimeout);
			}
			currentTooltipItem=0;
			currentTooltip="editor";
			toolTipTimeout=setTimeout(tooltip, 1000);		
		}
}
var justScrolled=false;
var scrollTimeout;
var options;
var editingTextScroll;
var fakehighlighttimeout;
function focusTextArea($this) {
	if (!shiftDown&&!metaDown) {
		prepForInsert();
		assignAddTextKeysAndClick();
		
	}
	// Fires before Click
	if (iOS) {
		$(".visibleHighlight span").css("visibility","hidden");
		$(".dropshipToolbarBottom,.format_mttri").hide();
/*		if (typeof myScroll[$(".textEditingArea").attr("id")] != 'undefined') {
			myScroll[$(".textEditingArea").attr("id")].destroy();
		}
		$(".textEditingArea").removeClass("scrollWrapper");
		$(".textEditingArea .lovelyScrollContents").removeClass("lovelyScrollContents").addClass("removeBeforeLovelyScroll").removeAttr("style");
		$(".textEditingArea").removeAttr("style");
		*/
//		$("body").addClass("noscroll");
/*		$(window).scrollTop($this.offset().top);
		editingTextScroll=$(window).scrollTop();
		$("body").unbind("scroll").scroll(function(){
			editingTextScroll=$(window).scrollTop();
		});*/
	}
	if ($(".bpe_highlight.bpe_image").length && !metaDown) {
		saveImage();
		$(".bpe_highlight").removeClass("bpe_highlight dont_remove_highlight");
	}
	if ($this.val()!="") {
		$this.parents(".textareaWrapper").addClass("notEmpty");
	} else {
		$this.parents(".textareaWrapper").removeClass("notEmpty");
	}
	
	if (!metaDown) {
		
		if (!shiftDown) {
			$(".bpe_highlight").removeClass('bpe_highlight');			
		} else {
			$this.blur();
			endToEndHighlight($this.parents(".textareaWrapper"));
//			$this.parents(".textareaWrapper").addClass("bpe_highlight");
	
			
			setTimeout(function () {
				if (!iOS) {
					selectionTools();			
					assignSaveListener();	
				}
			}, 10);
			return false;
		}
		$this.parents(".textareaWrapper").addClass("editing stayhighlighted bpe_highlight");
	} else {
		if ($this.parents(".textareaWrapper").hasClass("bpe_highlight")) {
			$this.parents(".textareaWrapper").removeClass("multi_highlight stayhighlighted bpe_highlight");
		} else {
			$this.parents(".textareaWrapper").addClass("bpe_highlight");
			
		}
		$this.blur();
		setTimeout(function () {
			if (!iOS) {
				selectionTools();				
				assignSaveListener();
			}
		}, 10);
		return false;
	}
	
//	$this.autosize();
	//console.log("h123");
	//
	
	setTimeout(function () {
		autosave(false);
		if (!iOS) {
			selectionTools();				
		}

	}, 100);
}
function clickTextArea($this) {
	
	if (iOS) {
		hidePaneTools();
	}

	if (metaDown) {
		if ($this.parents(".textareaWrapper").hasClass("editing")) {
			$this.parents(".textareaWrapper").removeClass("editing stayhighlighted");
			$this.blur();
			selectionTools();
			assignSaveListener();
		} else {
		//	$this.parents(".textareaWrapper").addClass("bpe_highlight");
		//	$(".textareaWrapper.bpe_highlight").addClass("multi_highlight");
		}
//		$this.blur();
//		selectionTools();
//		assignSaveListener();
		return false;
	} else {
		if (shiftDown) {
//			endToEndHighlight($this);
//			$this.blur();

			return false;
		} else {
//			$(".multi_highlight").removeClass("multi_highlight");
			
		}
	}

	// 
	
//	$(".bpe_highlight").removeClass("bpe_highlight");
//	$t = $this;
//	$t.parents(".textareaWrapper").addClass("bpe_highlight");
	setTimeout(function () {
		// Safety fire in case it's bluring another textarea at the same time
//		$t.parents(".textareaWrapper").addClass("bpe_highlight stayhighlighted");			
	}, 20);
	if (!iOS) {
//		selectionTools();
	}
	

	

	
	var e = $this[0];
	
	setTimeout(function() {
		if (!touchdown) {
			setFakeHighlight();
		
		}
	}, 10);

	var start = e.value.substr(0, e.selectionStart).lastIndexOf("[");	
	if (start!=-1) {

		if (e.value.substr(start, e.selectionStart-start).search(/[^\\]\]/)!=-1) {
			return false;
		}
		var end = e.value.substr(e.selectionEnd, e.value.length-e.selectionEnd).search(/[^\\]\]/);
		if (end!=-1) {
			var end2 = e.value.substr(e.selectionEnd, end).indexOf(":"); 
			if (end2!=-1) {
				var end = end + e.value.substr(0, e.selectionStart).length +2;
				if (e.value.substr(start,e.selectionStart - start).indexOf(":")==-1 && e.value.substr(start,e.selectionStart - start).indexOf(" ")==-1) {
					if (e.value.substr(e.selectionEnd, end - e.value.substr(0, e.selectionStart).length).indexOf("[")==-1) {
						e.setSelectionRange(start,end);	
						$(".bpe_selected").removeClass("bpe_selected");
						var result = checkBPESelection($this.getSelection().text);
						for (var i=0; i < result.length; i++) {
							$(".bpe_"+result[i]).addClass("bpe_selected");
						};
					} else {

						var numberOfOpeners = e.value.substr(e.selectionEnd, end - e.value.substr(0, e.selectionStart).length).match(/\[bold|\[italic|\[strikethrough|\[underline|\[superscript|\[subscript/g).length;
							var end = e.value.substr(e.selectionEnd+end2, e.value.length-e.selectionEnd).split(/[^\\]\]/g);
							var stringLength = 0;

							for (var i=0; i <= numberOfOpeners; i++) {
								stringLength = stringLength + end[i].length + 2;
							};
							var h = e.selectionStart-start;
							e.setSelectionRange(start,stringLength+start+h+end2);	
							e.focus();
							$(".bpe_selected").removeClass("bpe_selected");
							var result = checkBPESelection($this.getSelection().text);
							for (var i=0; i < result.length; i++) {
								$(".bpe_"+result[i]).addClass("bpe_selected");
							};
					}

				}

			} else {

				if ( e.value.substr(start+1,e.value.substr(start,e.selectionStart - start).indexOf(":")).search(/[^\\]\]/) == -1) {
					var type = (e.value.substr(start+1,e.value.substr(start,e.selectionStart - start).indexOf(":")-1));
					if (type=="strikethrough") {
						$(".bpe_strike").addClass("bpe_selected");
					} else if (type=="italic") {
						$(".bpe_ital").addClass("bpe_selected");
					} else if (type=="superscript") {
						$(".bpe_sup").addClass("bpe_selected");
					} else if (type=="subscript") {
						$(".bpe_sub").addClass("bpe_selected");
					} else {
						$(".bpe_"+type).addClass("bpe_selected");
					}
				}


			}

		}
		setTimeout(function() {
			if (!touchdown) {
				setFakeHighlight();
			
			}
		}, 10);
	

	}
}
$(document).ready(function(){
	
	if ($("#dragInsert").length) {
		$("body").addClass("noscroll");		
	}


	$(document).on('blur', '.textareaWrapper textarea',  function(e){
		var $t = $(this);
		$t.parents(".textareaWrapper").removeClass("editing");
		if ($t.val().replace(/\s/g,"").replace(/\r/g,"").replace(/\n/g,"")=="") {
			$t.parents(".textareaWrapper").next('.dropzone').remove();
			$t.parents(".textareaWrapper").remove();
		}
		$(".visibleHighlight span",$t.parents(".textareaWrapper")).css("visibility","hidden");
		if ($t.val().match(/\n\n/) && $t.parents(".textareaWrapper").attr("data-el")!='pre') {
			var $wrap = $t.parents(".textareaWrapper");
			var el = $wrap.attr("data-el");
			if ($wrap.hasClass("stayhighlighted")) {
				$wrap.removeClass("stayhighlighted editing level-1 level-2 level-3 el_p el_h1 el_h2 el_h3 el_h4 el_ul el_ol el_table");
			} else {
				$wrap.removeClass("editing bpe_highlight level-1 level-2 level-3 el_p el_h1 el_h2 el_h3 el_h4 el_ul el_ol el_table");
			}

			var classes = $wrap.attr("class");
			var align = $wrap.css("text-align");
		
			var texts = $t.val().split(/\n\n/);
			var newHTML = "";
			for (var i = 0; i < texts.length; i++) {
				if (texts[i]!='') {
					if ($wrap.attr("data-level")!='') {
						var l = parseInt($wrap.attr("data-level"));
					} else {
						var l = '1';
					}
					var newel = addTextareaAfter($wrap,el,classes,align,texts[i],false,l,true,true);
					newHTML = newHTML+newel;
				}
			}

			$wrap.after(newHTML);
			//$(".textareaWrapper textarea").autosize();
			$wrap.remove();
			//Removed 9 Jan
			//$(".textEditingArea").lovelyScroll();

			assign_sort();
//			bindTextareaWrappers();

		} else {
			//assign_sort();
		}
		setTimeout(function () {
			$t.parents(".textareaWrapper").removeClass("stayhighlighted");
		}, 50);
		if (iOS) {
			//$t.css("max-height","1000px").trigger('autosize.refresh');

			setTimeout(function () {
				if (!$('.textareaWrapper textarea:focus').length) {
			//		$(".textEditingArea .removeBeforeLovelyScroll > *:first").unwrap();
			//		$("body").removeClass("noscroll");

					setTimeout(function () {

			//Removed 9 Jan
			//$(".textEditingArea").lovelyScroll();

			//			var c = editingTextScroll-160;
			//			setTimeout(function () {
			//				if (typeof myScroll[$(".textEditingArea").attr("id")] != 'undefined') {
			//					myScroll[$(".textEditingArea").attr("id")].scrollBy(0,-c);							
			//				}
							
			//			}, 10);

						setFakeHighlight(true,$t);
						selectionTools();	

					}, 100);

				}	
			}, 20);
		}
	});
	
	$(document).on('click', '#rightPane',  function(e){
		if (justScrolled) {return false;}
		if (ignoreClickCatchup) {return false;}
		hide_menus();
		$(".dropshipToolbarBottom,.format_mttri").hide();
		$.fn.bpeditor.assign_toggler();
		assignSaveListener();				
	
	});
	$("#entryWrapper").on('click', '.dragTextArea',  function(e){
		e.stopPropagation();
		if (!metaDown) {
			//$("textarea",$(this).parents(".textareaWrapper")).trigger('click').focus();
		} else {
			$(this).parents(".textareaWrapper").removeClass("bpe_highlight multi_highlight");
		}
		return false;
	});
	
	$(document).on('focus', '.textareaWrapper textarea',  function(e){
		bindTextareaWrappers($(this));
		focusTextArea($(this));			

		//clickTextArea($(this));
		
	});
	
	$("#entryWrapper").on('click', '.textareaWrapper textarea',  function(e){
		clickTextArea($(this));
/*		if (metaDown) {
			e.stopPropagation();
			return false;
		} else {
			if (shiftDown) {
				e.stopPropagation();
			}
		}
		e.preventDefault();
		e.stopPropagation();*/
	});
	
	$(document).on('mouseup', '.textareaWrapper textarea',  function(e){
		$(".bpe_selected").removeClass("bpe_selected");
		var result = checkBPESelection($(this).getSelection().text);
		for (var i=0; i < result.length; i++) {
			$(".bpe_"+result[i]).addClass("bpe_selected");
		};
	});
	$(document).on('mousedown', '.textareaWrapper textarea',  function(e){
		$(this).addClass("draggingSel");
	});
			
	
	LangVars = jQuery.parseJSON( $("#LangVarsJson").val() );

	tooltips["mainmenupages"] = new Array();
	tooltips["mainmenupages"][0] = {
		itarget:".editPageBar:first:visible"
		,pos:"top_center"
		,texts:""
		,texts_touch:LangVars.Tip_Pages_Touch
		,touchOnly:true
	};
	tooltips["returntowelcome"] = new Array();
	tooltips["returntowelcome"][0] = {
		itarget:".returnToLP:visible"
		,pos:"top_right"
		,texts:LangVars.Tip_Welcome
		,texts_touch:LangVars.Tip_Welcome_Touch
	};

	tooltips["zones"] = new Array();
	tooltips["zones"][0] = {
		itarget:".tooltipTarget .dropzone"
		,pos:"top_center"
		,texts:LangVars.Tip_Zones
	};

	tooltips["section"] = new Array();
	tooltips["section"][0] = {
		itarget:".tooltipTarget.bpe_split_divider"
		,pos:"bottom_center"
		,texts:LangVars.Tip_Section
	};


	tooltips["newvideo"] = new Array();
	tooltips["newvideo"][0] = {
		itarget:"#changeVidThumb"
		,pos:"bottom_center"
		,texts:LangVars.Tip_Video
	};

	tooltips["newform"] = new Array();
	tooltips["newform"][0] = {
		itarget:"#recipientTooltip"
		,pos:"bottom_center"
		,texts:LangVars.Tip_Form
	};


	tooltips["contextmenu"] = new Array();
	tooltips["contextmenu"][0] = {
		itarget:"#dragBoundry"
		,pos:"center_center"
		,texts:LangVars.Tip_Context_Menu
		,texts_touch:LangVars.Tip_Context_Menu_Touch
	};

	tooltips["contextmenuwithcutcopypaste"] = new Array();
	tooltips["contextmenuwithcutcopypaste"][0] = {
		itarget:"#dragBoundry"
		,pos:"center_center"
		,texts:LangVars.Tip_Context_Menu_CCP
		,texts_touch:LangVars.Tip_Context_Menu_CCP_Touch
	};

	tooltips["addednewpage"] = new Array();
	tooltips["addednewpage"][0] = {
		itarget:".editPageBar.offline:first:visible"
		,pos:"top_center"
		,texts:LangVars.Tip_New_Page
	};
	tooltips["editor"] = new Array();

	tooltips["editor"][0] = {
		itarget:".textEditingArea"
		,pos:"center_center"
		,reveal:".textEditingArea:visible"
		,texts:LangVars.Tip_Editor_1
	};
	tooltips["editor"][1] = {
		itarget:"#livepreview:visible"
		,pos:"right_center"
		,texts:LangVars.Tip_Editor_2
	};
	tooltips["editor"][2] = {
		itarget:"#previewPage:visible"
		,pos:"top_center"
		,texts:LangVars.Tip_Editor_3
		,texts_touch:LangVars.Tip_Editor_3_Touch
	};

	tooltips["editorsnippets"] = new Array();

	tooltips["editorsnippets"][0] = {
		itarget:"#livepreview:visible"
		,pos:"right_center"
		,texts:LangVars.Tip_Snippets_1
	};
	tooltips["editorsnippets"][2] = {
		itarget:"#previewPage:visible"
		,pos:"top_center"
		,texts:LangVars.Tip_Snippets_2
		,texts_touch:LangVars.Tip_Snippets_2_Touch
	};

	tooltips["makeScreenBigger"] = new Array();
	tooltips["makeScreenBigger"][0] = {
		itarget:"body"
		,pos:"body_center"
		,withEnlarge:true
		,texts:LangVars.Tip_Enlarge
	};

	tooltips["publish"] = new Array();
	tooltips["publish"][0] = {
		itarget:"#saveEditPage:visible,#publishInPreview:visible"
		,pos:"top_left"
		,texts:LangVars.Tip_Publish
		,texts_touch:LangVars.Tip_Publish_Touch
	};
	tooltips["addtext"] = new Array();
	tooltips["addtext"][0] = {
		itarget:"#bpe_text_dropship:visible"
		,pos:"bottom_center"
		,mouseOnly:true
		,texts:LangVars.Tip_Text
	};
	tooltips["dragItemsToPage"] = new Array();
	tooltips["dragItemsToPage"][0] = {
		itarget:".dragInsertItem:visible:first,.thumbItem:visible:first,.thumbItem:visible:first,.assetPane .responsiveListItem:visible:first"
		,pos:"bottom_center"
		,texts:LangVars.Tip_Drag
	};
	
	newVideo = $("<div id='bpe_video_dropship'><div id='dropshipToolbar' class='clearfix'><a href='#' class='dropshipButton' id='bpe_upload_video'>"+LangVars.Upload_New_Video+"</a></div><div id='bpe_dropship_videos' class='clearfix'></div></div>");	
	newImage = $("<div id='bpe_image_dropship'><div id='dropshipToolbar' class='dropshipToolbar clearfix'><a href='#' class='dropshipButton bpe_upload_image' id='bpe_upload_image'>"+LangVars.Upload_New_Image+"</a><div id='toolbarFilter' class=\"clearfix\"><input type='text' id='imagePalletFilter' value='Search' /></div></div><div id='bpe_dropship_images' class='clearfix'><div class='clearfix'></div></div></div>");	
	options = {
	    img_classes: $("#imageClasses").html(), 
		block_classes: $("#blockClasses").html(),
		split_classes: $("#splitClasses").html()
	  };

});
function addTextareaAfter(target,el,classes,align,content,focusme,level,vis,returnHTML) {
	if (typeof returnHTML === 'undefined') {
		var returnHTML = false;
	} else {
		var returnHTML = true;
	}
	if (typeof level === 'undefined') {
		var level = '';
	}
	if (focusme) {
		var focusClass = 'editing bpe_highlight stayhighlighted';
	} else {
		var focusClass = '';
	}
	if (el=='ul'||el=='ol') {
		var levelClass='level-'+level;
	} else {
		var levelClass='';
	}
	if (el=="table") {
		var tableextra = "<div class=\"bpe_table\">"+target.html()+"</div>";
	} else {
		var tableextra="";
	}
	if (vis) {
		var vis = "";
	} else {
		var vis = "display:none;";
	}
	var newc = classes.replace(/editing/g,"").replace(/textareaWrapper/g,"").replace(/notEmpty/g,"").replace(/level-1/g,"").replace(/level-2/g,"").replace(/level-3/g,"").replace("stayhighlighted","").replace("ui-draggable","").replace("ui-selectee","").replace("ui-selected","").replace("ui-selectable","").replace("dont_remove_highlight","").replace("bpe_highlight","").replace("bpe_highlight_done","").replace(/ /g,"").replace(/_/g," ");		

	if (newc!="") {		
		var classLabel ='<div class="textAreaClassLabel" title="'+newc.trim()+'">'+newc.trim()+'</div>';		
	} else {
		var classLabel="";
	}
//	var newHTML = '<div class="el_'+el+' textareaWrapper '+classes+' '+focusClass+' '+levelClass+'" data-level="'+level+'" data-el="'+el+'" style="text-align:'+align+';'+vis+'">'+classLabel+'<div class="dragTextArea"><!-- --></div><div class="visibleHighlight"></div><textarea style="text-align:inherit" class="bpe_textarea">'+content+'</textarea><div class="bpe_textarea_mask"></div><div class="format_mttri"></div>'+tableextra+'</div>';
	var newHTML = '<div class="el_'+el+' textareaWrapper '+classes+' '+focusClass+' '+levelClass+'" data-level="'+level+'" data-el="'+el+'" style="text-align:'+align+';'+vis+'">'+classLabel+'<div class="dragTextArea"><!-- --></div><div class="visibleHighlight">'+content.replace("\r","<br/>")+'</div><textarea style="text-align:inherit" class="bpe_textarea">'+content+'</textarea><div class="bpe_textarea_mask"></div><div class="format_mttri"></div><div class="dropshipToolbarBottom clearfix" style="display:none;"><div class="format_first_block"><div class="bpe_buttons"><a href="#" class="bpe_bold" title="Bold">'+LangVars.Bold+'</a><a href="#" class="bpe_ital" title="Italic">'+LangVars.Italics+'</a><a href="#" class="bpe_underline" title="Underline">'+LangVars.Underline+'</a></div><div class="format_separator"></div><span class="insertLinkToWebsite">'+LangVars.Link+'</span><div class="format_separator"></div><div class="format_more"><!-- --></div></div><div class="format_second_block"><div class="format_less"><!-- --></div><div class="format_separator"></div><div class="bpe_buttons"><a href="#" class="bpe_strike" title="Strikethough">'+LangVars.Strikethrough+'</a><a href="#" class="bpe_sub" title="Subscript">'+LangVars.SubSupX+'<sub>'+LangVars.SubSupY+'</sub></a><a href="#" class="bpe_sup" title="Superscript">'+LangVars.SubSupX+'<sup>'+LangVars.SubSupY+'</sup></a></div></div>'+tableextra+'</div></div>';
	if (returnHTML===false) {
		target.after(newHTML);
		var $wrap = target.next();
		var align = $("textarea",$wrap).css("text-align");
		if (align=="left") {
			$(".bpe_left",$wrap).addClass("bpe_selected_align");
		} else if (align=="center") {
			$(".bpe_centre",$wrap).addClass("bpe_selected_align");
		} else if (align=="right") {
			$(".bpe_right",$wrap).addClass("bpe_selected_align");
		} else if (align=="justify") {
			$(".bpe_justify",$wrap).addClass("bpe_selected_align");
		} else {
			$(".bpe_left",$wrap).addClass("bpe_selected_align");
		}
		if (focusme) {
			$("textarea",$wrap).focus();
		}
//		$("textarea",$wrap).autosize({callback:refreshScrollHeights});
		return $wrap;
	} else {
		return newHTML;
	}
	
}
function bindTextareaWrappers($textarea) {

	var $wrap = $textarea.parent();
	$(".dropshipToolbarBottom,.format_mttri,.format_triShadow,.format_second_block",$wrap).hide();
	
    $textarea.unbind('keydown').keydown(function(e){

		if ($(this).parents(".textareaWrapper").attr('data-el')=='pre') {
			var keyCode = e.keyCode || e.which;

			if (keyCode == 9) {
				e.preventDefault();
				var start = $(this).get(0).selectionStart;
				var end = $(this).get(0).selectionEnd;

				$(this).val($(this).val().substring(0, start)
				+ "\t"
			    + $(this).val().substring(end));

				$(this).get(0).selectionEnd = start + 1;
			}
		}
		

	});	
   $textarea.unbind('keyup').keyup(function(e){

		if ($(this).val()!="") {
			$(this).parents(".textareaWrapper").addClass("notEmpty stayhighlighted");
		} else {
			$(this).parents(".textareaWrapper").removeClass("notEmpty stayhighlighted");
		}
		if ($(this).parents(".textareaWrapper").hasClass("el_table")) {
			$(this).parents(".textareaWrapper").addClass("changed");
			var timeout = 500;
		} else {
			var timeout = 1500;
		}
    	setFakeHighlight();
		clearTimeout(autosaveontype);
		autosaveontype = false;
		var $this = $(this);
		var $wrap = $this.parents(".textareaWrapper");
		if (typeof $("#iframe"+livepreviewToggle)[0].contentWindow.updateCMSText !='undefined') {

			if ($wrap.attr("data-el")=='pre') {
				$("#iframe"+livepreviewToggle)[0].contentWindow.updateCMSText(htmlentities($this.val()).replace(/(?:\r\n|\r|\n)/g, '<br />'));
			} else {
				$("#iframe"+livepreviewToggle)[0].contentWindow.updateCMSText(toHTML(htmlentities($this.val()).replace(/(?:\r\n|\r|\n)/g, '<br />')));				
			}
		}
		var el = $wrap.attr("data-el");		
		if ($this.val().match(/\n\n/) && el!='pre' && !iOS) {

			$wrap.removeClass("stayhighlighted editing bpe_highlight level-1 level-2 level-3 el_p el_h1 el_h2 el_h3 el_h4 el_ul el_ol el_table");
			var classes = $wrap.attr("class");
			var align = $wrap.css("text-align");
		
			var texts = $this.val().split(/\n\n/);
			if (texts[1]=="") {
				for (var i = texts.length - 1; i >= 0; i--) {
					if (i == texts.length-1) {
						var focusme = true;
					} else {
						var focusme = false;
					}
					if ($wrap.attr("data-level")!='') {
						var l = parseInt($wrap.attr("data-level"));
					} else {
						var l = '1';
					}
					if (texts[i]!=""||focusme) {
						addTextareaAfter($wrap,el,classes,align,texts[i],focusme,l,true);						
					}

				}
				$wrap.remove();
				assign_sort();
				//bindTextareaWrappers();
				prepForInsert();
				if (!iOS){
				selectionTools();
				assignAddTextKeysAndClick();
				}
			} else {
				$wrap.addClass("editing bpe_highlight");
				setTimeout(function() {
					if (!touchdown) {
						setFakeHighlight();
					}
				}, 10);
			}
		} else {
		
			autosaveontype = setTimeout(function () {
				if (!$this.is(":focus")) {
					var blurit = true;
				} else {
					var blurit = false;
				}
				var s = $this[0].selectionStart;
				var e = $this[0].selectionEnd;
				$this.text($this.val());
				$this[0].selectionStart = s;
				$this[0].selectionEnd = e;
				if (blurit) {
					$this.blur();
				}
				autosave(true);
			}, timeout);
			if (e.keyCode==37||e.keyCode==39||e.keyCode==38||e.keyCode==40) {
				if (!touchdown) {
					setFakeHighlight();
				}				
			}
			/*
			setTimeout(function() {
				if (!touchdown) {
					setFakeHighlight();
				}
			}, 10);
			*/
		}
	
		
		
    });

	/*$("textarea",$wrap).unbind('mouseup').mouseup(function(){
		$(".bpe_selected").removeClass("bpe_selected");
		var result = checkBPESelection($(this).getSelection().text);
		for (var i=0; i < result.length; i++) {
			$(".bpe_"+result[i]).addClass("bpe_selected");
		};
	});
	*/
//	$("textarea",$wrap).unbind('mousedown').mousedown(function(){
//		$(this).addClass("draggingSel");
//	});
	/*$(".dragTextArea").unbind("click").click(function(e){
		e.stopPropagation();
		if (!metaDown) {
			$("textarea",$(this).parents(".textareaWrapper")).trigger('click').focus();
		} else {
			$(this).parents(".textareaWrapper").removeClass("bpe_highlight multi_highlight");
		}
	});*/
	/*
	$("textarea",$wrap).unbind('click').click(function(e){
		clickTextArea($(this));
		if (metaDown) {
			e.stopPropagation();
			return false;
		} else {
			if (shiftDown) {
				e.stopPropagation();
			}
		}
		e.preventDefault();
		return false;
	});
	*/
	setTimeout(function () {
		$(".format_more",$wrap).unbind().click(function(e){	
			var $scope = $(this).parents('.dropshipToolbarBottom');
			$(".format_first_block",$scope).fadeOut(200,function(){
				$(".format_second_block",$scope).fadeIn();
//				$(".dropshipToolbarBottom",$scope).css("width","auto");
//				$(".dropshipToolbarBottom",$scope).css("width",$(".dropshipToolbarBottom",$scope).width()+1);
			});
			return false;
		});
		$(".format_less",$wrap).unbind().click(function(e){
			var $scope = $(this).parents('.dropshipToolbarBottom');
		
			$(".format_second_block",$scope).fadeOut(200,function(){
				$(".format_first_block",$scope).fadeIn();
//				$(".dropshipToolbarBottom",$scope).css("width","auto");
//				$(".dropshipToolbarBottom",$scope).css("width",$(".dropshipToolbarBottom",$scope).width()+1);
			});
			return false;
		});
		$(".bpe_bold",$wrap).unbind().click(function(e){
			logTrainingClick("formattingIconInEditPage");
			bpe_button('bold',$(this),"bold");
			return false;
		});
		$(".bpe_ital",$wrap).unbind().click(function(e){
					logTrainingClick("formattingIconInEditPage");
			bpe_button('italic',$(this),"ital");
			return false;
		});
		$(".bpe_underline",$wrap).unbind().click(function(e){
					logTrainingClick("formattingIconInEditPage");
			bpe_button('underline',$(this),"underline");
			return false;
		});
		$(".insertLinkToWebsite",$wrap).unbind().click(function(){
			logTrainingClick("addLinkTextEditor");
	
			prepDialogue ("<h2>"+LangVars.Insert_Link+"</h2><p>"+LangVars.Insert_Link_Text+"</p>",LangVars.Cancel,cancelDialogue,LangVars.Done,insertLinkToWebsite,false,true,true,"",true);
			return false;
		});
		$(".bpe_strike",$wrap).unbind().click(function(e){
					logTrainingClick("formattingIconInEditPage");
			bpe_button('strikethrough',$(this),"strike");
			return false;
		});
		$(".bpe_sup",$wrap).unbind().click(function(e){
					logTrainingClick("formattingIconInEditPage");
			bpe_button('superscript',$(this),"sup");
			return false;
		});
		$(".bpe_sub",$wrap).unbind().click(function(e){
			logTrainingClick("formattingIconInEditPage");
			bpe_button('subscript',$(this),"sub");
			return false;
		});
	}, 10);
	


//	$("textarea",$wrap).unbind().focus(function(){
//		focusTextArea($(this));
//	});
	

	$textarea.unbind('scroll').scroll(function(){
		setFakeHighlight(false);
	});
	if (iOS) {
		$("#dropshipToolbarBottom").hide();
//		$textarea.css("left","-3px");
	}	
	

	String.prototype.insert = function (index, string) {
	  if (index > 0)
	    return this.substring(0, index) + string + this.substring(index, this.length);
	  else
	    return string + this;
	};
	/*
	$("textarea",$wrap).unbind('blur').blur(function(){	
		var $t = $(this);

		$t.parents(".textareaWrapper").removeClass("editing");
		if ($t.val().replace(/\s/g,"").replace(/\r/g,"").replace(/\n/g,"")=="") {
			$t.parents(".textareaWrapper").next('.dropzone').remove();
			$t.parents(".textareaWrapper").remove();
		}
		
		if ($t.val().match(/\n\n/) && $t.parents(".textareaWrapper").attr("data-el")!='pre') {
			var $wrap = $t.parents(".textareaWrapper");
			var el = $wrap.attr("data-el");
			if ($wrap.hasClass("stayhighlighted")) {
				$wrap.removeClass("stayhighlighted editing level-1 level-2 level-3 el_p el_h1 el_h2 el_h3 el_h4 el_ul el_ol el_table");
			} else {
				$wrap.removeClass("editing bpe_highlight level-1 level-2 level-3 el_p el_h1 el_h2 el_h3 el_h4 el_ul el_ol el_table");			
			}

			var classes = $wrap.attr("class");
			var align = $wrap.css("text-align");
		
			var texts = $t.val().split(/\n\n/);
			for (var i = texts.length - 1; i >= 0; i--) {
				if (texts[i]!='') {
					if ($wrap.attr("data-level")!='') {
						var l = parseInt($wrap.attr("data-level"));
					} else {
						var l = '1';
					}
					addTextareaAfter($wrap,el,classes,align,texts[i],false,l,true);
				}
			}
			$wrap.remove();
			assign_sort();
//			bindTextareaWrappers();

		} else {
			
			//assign_sort();
		}
		setTimeout(function () {
			$t.parents(".textareaWrapper").removeClass("stayhighlighted");
		}, 50);
		if (iOS) {
			//$t.css("max-height","1000px").trigger('autosize.refresh');

			setTimeout(function () {
				if (!$('.textareaWrapper textarea:focus').length) {
					$(".textEditingArea .removeBeforeLovelyScroll > *:first").unwrap();
					$("body").removeClass("noscroll");

					setTimeout(function () {

						$(".textEditingArea").lovelyScroll();

						var c = editingTextScroll-160;
						setTimeout(function () {
							if (typeof myScroll[$(".textEditingArea").attr("id")] != 'undefined') {
								myScroll[$(".textEditingArea").attr("id")].scrollBy(0,-c);							
							}
							
						}, 10);

						setFakeHighlight(true,$t);
						selectionTools();	

					}, 100);

				}	
			}, 20);
		}

		
	});*/
	
	
}
var bpe_hide_drag;
var singleClick;
var doubleClickTimer = false;
var autosaveontype = false;
function isMac () {
	return navigator.userAgent.indexOf("Mac OS X") != -1;
}
function endToEndHighlight ($clicked) {
	if ($(".bpe_highlight").length) {
		$(".bpe_toggler").css("display","none");
		$(".bpe_stop").removeClass("bpe_stop");
		$clicked.addClass("bpe_stop");
		var highlightAll = true;
		var toplevel = false;
		if ($(".bpe_highlight:first").nextAll(".bpe_stop").length) {
			var toplevel = true;
			$(".bpe_highlight:first").nextAll(".textareaWrapper,div.CMS_Component_Obs,.bpe_image").each(function(){
				if (this.tagName.toLowerCase()=="ol"||this.tagName.toLowerCase()=="ul") {
					if (highlightAll) {
						$(this).addClass("bpe_highlight");
						$("li",$(this)).addClass("bpe_highlight");
					}
				} else {
					if ($(this).hasClass("bpe_stop")) {
						$(this).addClass("bpe_highlight");										
						$("li",$(this)).addClass("bpe_highlight");
						highlightAll = false;
					} else {
						if (highlightAll) {
							$(this).addClass("bpe_highlight");
							$("li",$(this)).addClass("bpe_highlight");
						}
					}									
				}
			});
		} 
		if ($(".bpe_highlight:last").prevAll(".bpe_stop").length) {
			var toplevel = true;
			$(".bpe_highlight:last").prevAll(".textareaWrapper,div.CMS_Component_Obs,.bpe_image").each(function(){
				if (this.tagName.toLowerCase()=="ol"||this.tagName.toLowerCase()=="ul") {
					if (highlightAll) {
						$(this).addClass("bpe_highlight");
						$("li",$(this)).addClass("bpe_highlight");
					}
				} else {
					if ($(this).hasClass("bpe_stop")) {
						$(this).addClass("bpe_highlight");										
						$("li",$(this)).addClass("bpe_highlight");
						highlightAll = false;
					} else {
						if (highlightAll) {
							$(this).addClass("bpe_highlight");
							$("li",$(this)).addClass("bpe_highlight");
						}
					}									
				}
			});
		
		}
		if (!toplevel) {
			// Could be in a zone.
			$(".bpe_stop").removeClass("bpe_stop");
			var isprev = false;
			var firstFound = false;

			$clicked.parents(".CMS_Component_ObsZones").prevAll().each(function(){

				if ($(this).hasClass("bpe_highlight")){
					isprev=true;
					if (!firstFound) {
						firstFound = true;
					}
				}
				if ($(this).find(".bpe_highlight").length) {
					isprev=true;
					if (!firstFound) {
						firstFound = true;
					}
				}
			});
			if ($clicked.parents(".CMS_Component_ObsZones").hasClass("bpe_highlight")&&!isprev) {
				isprev=true;				
			}
			if (isprev) {
				$clicked.addClass("stopSelectDownUntilHere");

				var limit = 0;
				function checkuntil() {
					if ($("#bpe_area .stopSelectDownUntilHere").length) {
						var selectedIsZones = false;
						var zonesHasChildren = false;
						var $elementAfterSelected = false
						var selectedIsListWithChildren = false
						var $current = false;
						var isListItem = false;
						var nextIsList = false;

						if ($(".bpe_highlight:last").length) {
							$current = $(".bpe_highlight:last");
							if ($(".bpe_highlight:last").hasClass("CMS_Component_ObsZones")) {
								selectedIsZones = true;
								if ($(".bpe_highlight:last").find("div.CMS_Component_Obs,.bpe_image,.textareaWrapper").filter(":visible").length ) {
									zonesHasChildren = true;
								}
							} else {
								if ($("ul",$(".bpe_highlight:last")).length) {
									selectedIsListWithChildren = true;
								}
							}
							if ($current.parent("ul").length || $current.parent("ol").length) {
								isListItem = true;
							}
							if ($(".bpe_highlight:last").nextAll("div.CMS_Component_Obs,.bpe_image,.textareaWrapper").filter(":visible").length ) {
								$elementAfterSelected = $(".bpe_highlight:last").nextAll("div.CMS_Component_Obs,.bpe_image,.textareaWrapper").filter(":visible").first();

							} else {
								// no next item, check if there are zones after this one.
								if ($(".bpe_highlight:last").parents(".zonesDropBox").next(".zonesDropBox").length) {
									$elementAfterSelected = $(".bpe_highlight:last").parents(".zonesDropBox").next(".zonesDropBox").find("div.CMS_Component_Obs,.bpe_image,.textareaWrapper").first();
								}
							}


						}


						if ($current) {

							if (!$elementAfterSelected && !isListItem) {

								if ($current.parents(".CMS_Component_Obs").nextAll("div.CMS_Component_Obs,.bpe_image,.textareaWrapper").filter(":visible").first().length) {
									$next = $current.parents(".CMS_Component_Obs").nextAll("div.CMS_Component_Obs,.bpe_image,.textareaWrapper").filter(":visible").first();
									$next.addClass("bpe_highlight").removeClass("stopSelectDownUntilHere");
								}
							}

							if (selectedIsZones) {
								if (zonesHasChildren) {
									$next = $current.find("div.CMS_Component_Obs,.bpe_image,.textareaWrapper").filter(":visible").first();
									$next.addClass("bpe_highlight").removeClass("stopSelectDownUntilHere");
								}
							}

							if ($elementAfterSelected && !zonesHasChildren && !selectedIsListWithChildren && !nextIsList) {
								$elementAfterSelected.addClass("bpe_highlight").removeClass("stopSelectDownUntilHere");
							}
							
							


						} else {
							$next = $("#bpe_area").find("div.CMS_Component_Obs,.bpe_image,.textareaWrapper").filter(":visible").first();
							$next.addClass("bpe_highlight").removeClass("stopSelectDownUntilHere");

						}
					
				
						checkuntil();
					
					}
				}
				checkuntil();

				scrollToEl($(".bpe_highlight:last"),$(".textEditingArea"));
				
			}
		
			
		}
	} else {
		if (!$(this).hasClass("CMS_Component_Obs")) {
			//showToggler($(this));								
		} else {
			$(".bpe_highlight").removeClass("bpe_highlight");
			$(this).addClass("bpe_highlight");
			$(".bpe_toggler").css("display","none");
		}
	}
}

(function($) {
jQuery.fn.remove_bpeditor = function() {
	return this.each(function(){
		$(this).next(".bpe_area_wrapper").remove();
		$(this).css("display","block");
	});
};

jQuery.fn.bpeditor = function(options) {
	// default settings
	  var options = jQuery.extend( {
	    img_classes: $("#imageClasses").html(), 
		block_classes: $("#blockClasses").html(),
		split_classes: $("#splitClasses").html()
	  },options);
		$.fn.bpeditor.assign_toggler = function () {
//			assign_sort();

			$(".componentDelete").unbind("click");
			$(".componentDelete").click(function(){
				$(this).parents(".CMS_Component_Obs").remove();
				$.fn.bpeditor.clean(true);
			});
			//$(".bpe_image,form,p,h1,h2,h3,h4,h5,pre,li,.bpe_table,div.CMS_Component_Obs",$("#bpe_area")).fadeTo(0,1);
			

			$(".bpe_image, .addToBasketForm","#bpe_area").unbind("click");
			$(".bpe_image, .addToBasketForm","#bpe_area").click(function(){

				$("input,textarea").blur();
				if ($(".bpe_highlight.bpe_image").length && !$(this).hasClass("bpe_highlight") && !metaDown) {
					saveImage();
					$(".bpe_highlight").removeClass("bpe_highlight dont_remove_highlight");
				}
				if (doubletap) {
					editImage($(this));
					return false;
				}

				if (!ignoreClickCatchup && !doubletap && !justScrolled) {
					doubletap=true;
					setTimeout(function() {
						doubletap=false;
					}, 300);
					hide_iconbar_menus();
					$(".bpe_stop").removeClass("bpe_stop");
					if (metaDown) {
						$(".bpe_toggler").css("display","none");
						if ($(this).hasClass("bpe_highlight")) {
							$(this).removeClass("bpe_highlight");
						} else {
							$(this).addClass("bpe_highlight");						
						}
						$(".textareaWrapper.bpe_highlight").addClass("multi_highlight");
						assignSaveListener();
					} else {
						if (shiftDown) {
							endToEndHighlight($(this));
						} else {
							//showImageToggler($(this));
							$(".bpe_highlight").removeClass("bpe_highlight");
							$(this).addClass("bpe_highlight");
						}				
					}
					//console.timeEnd("rest");
				//	scrollToEl($(this));	
					selectionTools();
				}
				
				
				return false;
			});
			$("div.CMS_Component_Obs","#bpe_area").unbind("click");


			 
			$(".textEditingArea").unbind("click").click(function(event){


				if (doubletap && touchdown!=1) {
				
					return false;
				}
				if (!ignoreClickCatchup && !doubletap && !justScrolled) {
					doubletap=true;
					setTimeout(function() {
						doubletap=false;
					}, 300);
				}
				$("input").blur();
			});
			$("div.CMS_Component_Obs","#bpe_area").click(function(event){
				if ($(event.target)[0].nodeName.toLowerCase()=="textarea") {
					return false;
				}
				$("input:focus").blur();
				$("textarea:focus").blur();

				if (doubletap && touchdown!=1) {
					touchdown=0;
					clearTimeout(singleClick);
					if (!$(this).hasClass("CMS_Component_Obs") && !$(this).hasClass("bpe_table")) {
					
						event.stopPropagation();
						hide_iconbar_menus();
						$(".bpe_highlight").removeClass("bpe_highlight");
						$(this).addClass("bpe_highlight");													
						addText($(this));
					}
					if ($(this).hasClass("bpe_table")) {
						event.stopPropagation();
						hide_iconbar_menus();
						$(".bpe_highlight").removeClass("bpe_highlight");
						$(this).addClass("bpe_highlight");													
						addTableF($(this));
					}
					return false;
				}
				if (!ignoreClickCatchup && !doubletap && !justScrolled) {
					hide_iconbar_menus();
					doubletap=true;
					setTimeout(function() {
						doubletap=false;
					}, 300);
					$(".bpe_stop").removeClass("bpe_stop");
					if (!$(this).hasClass("CMS_Component_ObsZones")) {
						//scrollToEl($(this));					
					}
					var $this = $(this);
					singleClick = setTimeout(function() {
						if (metaDown) {
							$(".bpe_toggler").css("display","none");
							if ($this.hasClass("bpe_highlight")) {
								$this.removeClass("bpe_highlight");
							} else {

								$this.addClass("bpe_highlight");													

							}
							$(".textareaWrapper.bpe_highlight").addClass("multi_highlight");
							assignSaveListener();
						} else {
							if (shiftDown) {
								endToEndHighlight($this);
							} else {
								if (!$this.hasClass("CMS_Component_Obs")) {
									if ($this.hasClass("bpe_highlight") && $this.prevAll(".bpe_highlight").length===0) {
										logTrainingClick("highlightFirstNewTextItem");
									}

									$(".bpe_highlight").removeClass("bpe_highlight");
									$this.addClass("bpe_highlight");													
									
								//	showToggler($this);								
								} else {									
									$(".bpe_highlight").removeClass("bpe_highlight");
									$this.addClass("bpe_highlight");
									$(".bpe_toggler").css("display","none");
								}
							}
						}
						
						selectionTools();
					}, 300);


				}

				return false;
			});
			assign_sort();
			
		};
	
	$.fn.bpeditor.clean = function(addToUndo) {

		$("#bpe_area").css("height",$("#bpe_area").height()+"px");
		var st= $("body").scrollTop();

		selectionTools();
		$("#rightPane .paneTools").lovelyScroll();
//		$(".textareaWrapper textarea").autosize();
		if ($("#bpeSectionTabs").length) {
			var tpl = $("#bpeSectionTabs a.currentSectionTab").attr("data-tpl");	
		} else {
			var tpl = "";
		}

		$(".bpe_split_divider").hide();
		$(".bpe_split_divider").each(function(){
			$(this).html($(this).attr("alt").replace(/_/g," "));
		});

		$(".bpe_highlight_done").removeClass("bpe_highlight_done");
		$(".bpe_stop").removeClass("bpe_stop");

		$(".drag,#bpe_area .dropzone,#bpe_area .itemTag").remove();
		$("body").scrollTop(st);
		/* Start Live Editors */
		
		$("p,h1,h2,h3,h4,pre,ul,ol,.bpe_table:not(.textareaWrapper .bpe_table)",$("#bpe_area")).each(function(){
			var target=$(this);
			
			$(".drag,.itemTag",$(this)).remove();
			$(".hwrap",$(this)).contents().unwrap();
			$(".drag,.itemTag",target).remove();
			$(".hwrap",target).contents().unwrap();
			
			var el = target[0].tagName.toLowerCase();
			function toBlueprintEl($t,target,level,el,ignoreClasses) {
				var align = $t.css("text-align");
				var content = toBPE($t.html());
				if (content=="") {
					return false;
				}
				if (ignoreClasses==true) {
					var classes='';
				} else {
					if (typeof $t.attr("class")!='undefined') {
						var classes  = $t.attr("class");
					} else {
						var classes  = '';
					}
				}

				if ($t.css("display")=="none") {
					var vis =false;
				} else {
					var vis =true;
				}
				
				return addTextareaAfter(target,el,classes,align,content,false,level,vis);
			}
			if (el=='ul'||el=='ol')  {
				$($('> li',target).get().reverse()).each(function(){
					var $children = $("> ul,> ol",$(this)).clone();
					$("> ul,> ol",$(this)).remove();

					var el2 = $(this).parent()[0].tagName.toLowerCase();
					var $l2Target = toBlueprintEl($(this),target,'1',el2,false);
					if ($children.length) {
						$($children.get().reverse()).each(function(){
							var el3 = $(this)[0].tagName.toLowerCase();
							$($('> li',$(this)).get().reverse()).each(function(){
								var $children2 = $("> ul,> ol",$(this)).clone();
								
								$("> ul,> ol",$(this)).remove();
								var $l3Target = toBlueprintEl($(this),$l2Target,'2',el3,true);
								
								if ($children2.length) {
									$($children2.get().reverse()).each(function(){
										var el4 = $(this)[0].tagName.toLowerCase();
										$($('> li',$(this)).get().reverse()).each(function(){
											toBlueprintEl($(this),$l3Target,'3',el4,true);
											$(this).remove();	
										});
									});
								}
								$(this).remove();	
							});
						});
					}
					$(this).remove();	
				});
			} else {
				if (target.hasClass("bpe_table")) {
					$.ajax({
					  type: "POST",
					  url: "pageActions.php",
					  data: "pageAction=html2csv&text="+encodeURIComponent(target.html()),
					  success: function(msg){
		  					addTextareaAfter(target,'table',target.attr("class").replace("bpe_table",""),'left',toBPE(msg),false,'',true)
		  					target.remove();
							//bindTextareaWrappers();
							assign_sort();
						}
					});	
				} else {
					toBlueprintEl(target,target,'',el,false);
					$(this).remove();
				}
			}

		});
		
		//bindTextareaWrappers();
		
		// END LIVE EDITORS
		// ========
		$.fn.bpeditor.showSection(tpl);
		
		var saveNow = true;
		$("#bpe_area ul,#bpe_area ol").remove();
		
		$("#bpe_area").children().each(function(){
			$(this).find("ul,ol").each(function(){
				if ($("li",$(this)).length===0) {
					$(this).remove();
				}
			});
			$(this).find(".zonesDropBox").children().each(function(){

				$(this).children().children().children().each(function(){
					if ($(this).html()=="" && tag!="img") {
						$(this).remove();
					}
				});
				$(this).children().children().each(function(){
					var tag = this.tagName.toLowerCase();
					if (tag=="ul"||tag=="ol") {
						if ($(this).next().length>0) {
							var tagNext;
							$(this).next().each(function(){
								tagNext = this.tagName.toLowerCase();
							});
							if (tag==tagNext) {
								var contents = $(this).next().html();
								$(this).append(contents);
								$(this).next().remove();
							}
						}
						if ($(this).children("li").length==0) {
							$(this).remove();
						}
					}
				});
				
				
				var tag = this.tagName.toLowerCase();
				
				if ($(this).html()=="" && tag!="img" && !$(this).hasClass("bpe_split_divider") && !$(this).hasClass("zonesEnd")) {
					$(this).remove();
				}
				tag = this.tagName.toLowerCase();
				if (tag=="ul"||tag=="ol") {
					$(this).children().each(function(){
						if ($(this).html()=="") {
							$(this).remove();
						}
					});
					if ($(this).next().length>0) {
						var tagNext;
						$(this).next().each(function(){
							tagNext = this.tagName.toLowerCase();
						});
						if (tag==tagNext) {
							contents = $(this).next().html();
							$(this).append(contents);
							$(this).next().remove();
						}
					}
					if ($(this).children("li").length==0) {
						$(this).remove();
					}
				} else if (tag=="img") {
					if ($(this).parents(".bpe_image").length==0) {
						$(this).wrap("<div class='bpe_image'></div>");
					}
				} else if (tag=="li") {
					if ($(this).parents("ul").length==0) {
						$(this).wrap("<ul></ul>");
						saveNow=false;
						$.fn.bpeditor.clean(addToUndo);					
					}
				} else if (tag=="a") {
					if ($(this).children("img").length>0) {
						$(this).wrap("<div class='bpe_image'></div>");
					} else {
						$(this).wrap("<p></p>");
					}
				}
				$("ul,ol",$(this)).each(function(){
					if ($(this).children("ul,ol").length) {
						$(this).children("ul,ol").each(function(){
							$(this).after($(this).html()).remove();
						});
					}
				});
				if (saveNow) {
					if ($(this).children("ul,ol").length) {
						$(this).children("ul,ol").each(function(){
							$(this).after($(this).html()).remove();
						});
					}				
				}
				$(this).children().removeAttr("hoverintent_t");
				$(this).removeAttr("hoverintent_t").removeAttr("sizset").removeAttr("sizcache");
			});
			$(this).children().children().children().each(function(){
				if ($(this).html()=="" && tag!="img") {
					$(this).remove();
				}
			});
			$(this).children().children().each(function(){
				var tag = this.tagName.toLowerCase();
				if (tag=="ul"||tag=="ol") {
					if ($(this).next().length>0) {
						var tagNext;
						$(this).next().each(function(){
							tagNext = this.tagName.toLowerCase();
						});
						if (tag==tagNext) {
							var contents = $(this).next().html();
							$(this).append(contents);
							$(this).next().remove();
						}
					}
					if ($(this).children("li").length==0) {
						$(this).remove();
					}
				}
			});
			
			
			var tag = this.tagName.toLowerCase();
			
			if ($(this).html()=="" && tag!="img" && !$(this).hasClass("bpe_split_divider")) {
				$(this).remove();
			}
			tag = this.tagName.toLowerCase();
			if (tag=="ul"||tag=="ol") {
				$(this).children().each(function(){
					if ($(this).html()=="") {
						$(this).remove();
					}
				});
				if ($(this).next().length>0) {
					var tagNext;
					$(this).next().each(function(){
						tagNext = this.tagName.toLowerCase();
					});
					if (tag==tagNext) {
						contents = $(this).next().html();
						$(this).append(contents);
						$(this).next().remove();
					}
				}
				if ($(this).children("li").length==0) {
					$(this).remove();
				}
			} else if (tag=="img") {
				if ($(this).parents(".bpe_image").length==0) {
					$(this).wrap("<div class='bpe_image'></div>");
				}
			} else if (tag=="li") {
				if ($(this).parents("ul").length==0) {
					$(this).wrap("<ul></ul>");
					saveNow=false;
					$.fn.bpeditor.clean(addToUndo);					
				}
			} else if (tag=="a") {
				if ($(this).children("img").length>0) {
					$(this).wrap("<div class='bpe_image'></div>");
				} else {
					$(this).wrap("<p></p>");
				}
			}
			$("ul,ol",$(this)).each(function(){
				if ($(this).children("ul,ol").length) {
					$(this).children("ul,ol").each(function(){
						$(this).after($(this).html()).remove();
					});
				}
			});
			if (saveNow) {
				if ($(this).children("ul,ol").length) {
					$(this).children("ul,ol").each(function(){
						$(this).after($(this).html()).remove();
					});
				}				
			}
			$(this).children().removeAttr("hoverintent_t");
			$(this).removeAttr("hoverintent_t").removeAttr("sizset").removeAttr("sizcache");
		});
		

		if ($("#bpe_area").children().length) {
			//$(".textEditingArea .listTipUp:not(.hideTips .listTipUp)").show();
			$(".listTipEditor").hide();			
		} else {
			$(".textEditingArea .listTipUp").hide();
			$(".listTipEditor").show();
		}
		if ($("#cloning:visible").length) {
			$(".listTipEditor").hide();			
		}
		$(".bpe_toggler").css("display","none");
		
		
//		$(".bpe_highlight").removeClass("bpe_highlight");
					
		$("#bpe_area a").unbind().click(function(event){
			event.preventDefault();
		});

		assignSaveListener();
//		$(document).unbind("click");
// 		DEV REMOVED up and down
/*
		$(document).click(function(e){
			if ($(e.target)[0].nodeName.toLowerCase()!="textarea") {
				if (justScrolled) {return false;}
				if (ignoreClickCatchup) {return false;}
				hide_menus();
				$(".dropshipToolbarBottom,.format_mttri,.visibleHighlight").hide();
				$.fn.bpeditor.assign_toggler();
				assignSaveListener();				
			}
		});
		*/
		$("#editModeDelete").removeClass("bpe_current");
		$("#editModeEdit").addClass("bpe_current");

		if (saveNow) {
			
			if ($("#addEntryForm").length) {

				autosave(addToUndo);			
			} else {
				autosaveBlog();
			}
			
		}
			//Removed 9 Jan
			//$(".textEditingArea").lovelyScroll();



		$.fn.bpeditor.assign_toggler();
		
		$(".iconbarMenu").hide();
		//selectionTools();
		//assign_click();
		$("#dragSectionItems li").each(function(){
			if ($("#bpe_area ."+$(this).attr("title")).length) {
				$(this).addClass("greyedOut");
			} else {
				$(this).removeClass("greyedOut");
			}
		});
		if ($("#bpe_area .ComponentBlog").length) {
			$("#dragInsertBlog").addClass("greyedOut");
		}
		if ($("#bpe_area .ComponentShoppingBasket").length) {
			$("#dragInsertCheckout").addClass("greyedOut");
		} else {
			$("#dragInsertCheckout").removeClass("greyedOut");
		}
		$(window).trigger("resize");
		$("#rightPane").css("opacity","1");
		$("#bpe_area").css("height","auto");

		$("body").scrollTop(st);
		setTimeout(function () {
			$("body").scrollTop(st);
		}, 40);

//		var h = $(window).height() - $("#bpe_area").position().top - 30;
//		$("#bpe_area").css("height","auto");
//		if ($("#bpe_area").height()<h) {
//			$("#bpe_area").css("height",h+"px");
//		}
	};
	var tabscroll;
	$.fn.bpeditor.makeTabsOneLine = function(){
		if ($("#bpeSectionTabs:visible").length) {
			var w = 0;
			$("#bpeSectionTabs > ul").css("width","auto");
		
			$("#bpeSectionTabs > ul li").each(function(){
				w=w+$(this).outerWidth();
			});
			w=w+10;
			$("#bpeSectionTabs > ul").css("width",w+"px");
			$("#rightPane").removeClass("withSectionTabs");
			$("#sectionNav").remove();
			if ($("#bpeSectionTabs").width()<w && !iOS) {
				$("#rightPane").addClass("withSectionTabs");
				$("#bpeSectionTabs").append('<div id="sectionNav"><div id="scrollSectionRight"></div><div id="scrollSectionLeft"></div></div>');
			}
			$("#scrollSectionRight").click(function(){
				var l = $("#bpeSectionTabs > ul").outerWidth();
				var avail = $("#bpeSectionTabs").innerWidth();
				var offset = Math.abs(tabscroll.x);
				var diff = avail+offset;
				diff = l-diff;
				if (diff<100) {
					var x = parseInt("-"+diff);
				}else {
					var x = -100;
				}
				tabscroll.scrollBy(x, 0,500,IScroll.utils.ease.quadratic);	
				return false;
			});
			$("#scrollSectionLeft").click(function(){
				if (tabscroll.x>-100) {
					//console.log(tabscroll.x);
					var x = Math.abs(tabscroll.x);
				}else {
					var x = 100;
				}
				tabscroll.scrollBy(x, 0,500,IScroll.utils.ease.quadratic);	
				return false;
			})
			if ($("#bpeSectionTabs").hasClass("scrollWrapper")) {
				tabscroll.refresh();
			} else {
			 	tabscroll = new IScroll($("#bpeSectionTabs")[0], {
			 		scrollbars: true,
			 		mouseWheel: true,
			 		interactiveScrollbars: true,
			 		shrinkScrollbars: 'scale',
					disableMouse:true,
					fadeScrollbars:true,
					scrollX:true,
					scrollY:false,
					probeType:2,
					scrollbars: 'custom'
			 	});
			}			
		}

	 	
	}
	$.fn.bpeditor.showSection = function(tpl) {
		$("#bpe_area .dropzone").remove();
		$(".bpe_highlight:not(.dont_remove_highlight)").removeClass("bpe_highlight");
		$(".multi_highlight").removeClass("multi_highlight");
		selectionTools();
		$("#bpe_area").children().hide();
		if (tpl=="") {
			var $start = $("#bpe_area").children().first();
			if ($start.hasClass("bpe_split_divider")) {
				return false;
			} else {
				$start.show();
			}
		} else {
			var $start = $("#bpe_area .bpe_split_divider[alt="+tpl+"]");
		}
		$start.nextAll().each(function(){
			if ($(this).hasClass("bpe_split_divider")) {
				return false;
			} else {
				$(this).show();
			}
		});
		setTimeout(function () {
			assign_sort();
//			$("textarea",$(".textareaWrapper")).trigger('autosize.resize');
			//Removed 9 Jan
			//$(".textEditingArea").lovelyScroll();
		}, 100);
		
	};
	return this.each(function(){
		var images = $("#bpe_images").html();
		if ($("#bpe_images").children().length==0) {
			images = "<span class='bpe_menu_message'>Uploaded images will appear here</span>";
		}
		

		var videos = "<span class='bpe_menu_message'>Uploaded videos will appear here</span>";
	
		
		var left = $(this).offset().left;
		if (left+50 < $(window).width() / 2 ) {
			var menus = "bpe_subs_left";
		} else {
			var menus = "";
		}
	   $(this).css("display","none");
		var rand = randomString();
		var menu =  "<div class='bpe_area_wrapper' style='width:auto;' id='"+rand+"'>";
		menu += "<div class='bpe_area' id='bpe_area'>"+$(this).prev().html()+"</div>";
		menu += "</div>";
		
		if (isMac) {
			var modifier = "";
			var shift = "";			
		} else {
			var modifier = "Ctrl+";			
			var shift = "+";
		}
		$(this).after(menu);

		$.ajax({
		  type: "POST",
		  url: "pageActions.php",
		  data: "pageAction=paste",
		  success: function(msg){
	if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
			if (msg!="") {
				clipboard= msg;			
				$("#bpe_paste").removeClass("greyedOut");
			}
		  }
		});
		/*
		$(".textEditingArea").scroll(function(){
			justScrolled=true;
			if (scrollTimeout) {
				clearTimeout(scrollTimeout);
			}
		
			showHideMenusOnScroll($(this));
	
			scrollTimeout = setTimeout(function() {
			justScrolled=false;				
			if ($(".bpe_highlight").length==1) {
				if ($(".bpe_highlight").hasClass("bpe_image")) {
				//	showImageToggler($(".bpe_highlight"));
				} else {
				//	showToggler($(".bpe_highlight"));					
				}

			}
			}, 500);
			$(".bpe_toggler:visible").hide();
		});*/
		
		//assign_menus($("#bpe_add_menu"));
		//assign_menus($("#bpe_selection_menu"));		
		/*
		8 Dec removed
		$(".contentImage").draggable({ 
			appendTo: 'body'
			,helper: 'clone'
			,zIndex: 1000
			,revert: 'invalid'
			,start: function () { 
				//hide_menus();
			}
	 	});
		*/
	
		

	

		
		$("#bpe_vids"+rand).html($("#videoList").html());


		if ($("#dragSectionItems li").length) {
			$("body").addClass("hasSections");
			$("#entryWrapper").prepend('<div id="bpeSectionTabs" class="clearfix"><ul></ul></div>');
			$("#dragSectionItems li").each(function(){
				if ($(this).attr("data-default")!="1") {
					if (!$("#bpe_area .bpe_split_divider[alt="+$(this).attr("data-tpl")+"]").length && $(this).attr("data-tpl")!="") {
						$("#bpe_area").append("<div class=\"bpe_split_divider tooltipTarget "+$(this).attr("data-tpl")+"\" alt=\""+$(this).attr("data-tpl")+"\">"+$(this).html()+"</div>");
					}
					$("#bpeSectionTabs > ul").append('<li><a href="#" data-tpl="'+$(this).attr("data-tpl")+'"><span>'+$(this).html()+'</span></a></li>');					
				}
			});
			$("#dragSectionItems li").each(function(){
				if ($(this).attr("data-default")=="1") {
				
					if (!$("#bpe_area .bpe_split_divider[alt="+$(this).attr("data-tpl")+"]").length && $(this).attr("data-tpl")!="") {
						$("#bpe_area").append("<div class=\"bpe_split_divider tooltipTarget "+$(this).attr("data-tpl")+"\" alt=\""+$(this).attr("data-tpl")+"\">"+$(this).html()+"</div>");
					}
					$("#bpeSectionTabs > ul").prepend('<li><a href="#" data-tpl="'+$(this).attr("data-tpl")+'"><span>'+$(this).html()+'</span></a></li>');
				}
			});

			if (!$("#bpeSectionTabs > ul li a[data-tpl=]").length) {
				$("#bpeSectionTabs > ul").prepend('<li><a href="#" data-tpl=""><span>'+LangVars.Main_Content+'</span></a></li>');
			}
			
			$("#bpeSectionTabs a").click(function(){
				$("#bpeSectionTabs .currentSectionTab").removeClass("currentSectionTab");
				$(this).addClass("currentSectionTab");
				var tpl = $(this).attr("data-tpl");
				$.fn.bpeditor.showSection(tpl);
				tabscroll.scrollToElement($(this).parent()[0],500,-50);
				assign_sort();
				return false;
			});
			
			$("#bpeSectionTabs > ul li:first-child a").addClass('currentSectionTab');
			$.fn.bpeditor.makeTabsOneLine();
			
//			$.fn.bpeditor.showSection('');
		}
		



/*		$(".bpe_split_divider").each(function(){
			if ($(this).nextAll(":not(.bpe_split_divider,.dropzone)").length==0) {
				$(this).remove();
			}
		});*/
		//assign_menus($("#bpe_vids"+rand));
		setTimeout(function () {
			assign_sort();
			$.fn.bpeditor.clean(true);
			assign_click();
			
		}, 10);
		if ($("#splitClasses .bpe_menu_sub").length) {
			$("#splitClasses .bpe_menu_sub").each(function(){
				if ($("#bpe_area ."+$(this).attr("title")).length) {
					$(this).remove();
				}
			});
			
		}
		$("#template a").unbind();
		$("#template a").click(function(){
					
			working();
			var id = $("#kbid").val();
			var clicked = $(this);
			$.ajax({
			  type: "POST",
			  url: "pageActions.php",
			  data: "pageAction=change&action=template&id="+id+"&template="+$(this).attr("href"),
			  success: function(msg){
if (msg=="<script>window.location='/admin/';</script>") { window.location='/admin/login.php?m=3'; return false; }
				$("#template .bpe_current").removeClass("bpe_current");
				clicked.addClass("bpe_current");
				saved("Template changed for page");
			  }
			});

			return false;
			
		});
		showEditingToooltips();
		

		
	  	
	  	if ($("#rightPane").hasClass("editingBlog")) {
			if (currentTooltip) {
				interuptedChains.push({currentTooltip:currentTooltip,currentTooltipItem:currentTooltipItem});
				clearTimeout(toolTipTimeout);
			}
			currentTooltipItem=0;
			currentTooltip="editorblog";
			toolTipTimeout=setTimeout(tooltip, 1000);		
		}

		
		  	
	});


	
	/*
	function assign_selectable () {

		$(".bpe_image, .addToBasketForm","#bpe_area").unbind();
		$("p,h1,h2,h3,h4,h5,pre,li,ol,ul,div.CMS_Component_Obs,.bpe_table","#bpe_area").unbind();

		$("#bpe_area").selectable({ filter: 'p,h1,h2,h3,h4,h5,pre,li,ol,ul,div.CMS_Component_Obs,.bpe_table,.bpe_image,form' });
	
		$("body").click(function(){

			if (justScrolled) {return false;}
			if (ignoreClickCatchup) {return false;}
			hide_menus();
			$(".ui-selectee").removeClass("ui-selectee");
			$(".ui-selected").removeClass("ui-selected");
			$(".ui-selectable").removeClass("ui-selectable");
		});
		
	}*/
	
	

};
	})(jQuery);